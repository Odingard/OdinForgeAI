version: '3.8'

services:
  odinforge-agent:
    build:
      context: ../..
      dockerfile: Dockerfile
    image: odinforge-agent:latest
    container_name: odinforge-agent
    restart: unless-stopped
    
    environment:
      - ODINFORGE_SERVER_URL=${ODINFORGE_SERVER_URL:-https://your-odinforge-server.com}
      - ODINFORGE_API_KEY=${ODINFORGE_API_KEY}
      - ODINFORGE_TENANT_ID=${ODINFORGE_TENANT_ID:-default}
      - ODINFORGE_AUTH_MODE=${ODINFORGE_AUTH_MODE:-api_key}
      - ODINFORGE_TELEMETRY_INTERVAL=${ODINFORGE_TELEMETRY_INTERVAL:-5m}
      - ODINFORGE_HEARTBEAT_INTERVAL=${ODINFORGE_HEARTBEAT_INTERVAL:-1m}
      - ODINFORGE_BATCH_SIZE=${ODINFORGE_BATCH_SIZE:-50}
      - ODINFORGE_COMPRESS=${ODINFORGE_COMPRESS:-true}
      - ODINFORGE_REQUIRE_HTTPS=${ODINFORGE_REQUIRE_HTTPS:-true}
      - ODINFORGE_VERIFY_TLS=${ODINFORGE_VERIFY_TLS:-true}
      - ODINFORGE_QUEUE_PATH=/data/agent.queue.db
    
    volumes:
      - agent-data:/data
      - ./config.yaml:/etc/odinforge/config.yaml:ro
      # For mTLS authentication (optional):
      # - ./certs:/etc/odinforge/certs:ro
    
    # Optional: Read-only root filesystem for security
    # read_only: true
    # tmpfs:
    #   - /tmp:size=64M
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    
    # Health check
    healthcheck:
      test: ["CMD", "/app/odinforge-agent", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  agent-data:
    driver: local

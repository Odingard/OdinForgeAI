{"file_contents":{"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"server/services/agents/orchestrator.ts":{"content":"import type {\n  AgentContext,\n  AgentMemory,\n  OrchestratorResult,\n  ProgressCallback,\n} from \"./types\";\nimport type { AdversaryProfile } from \"@shared/schema\";\nimport { runReconAgent } from \"./recon\";\nimport { runExploitAgent } from \"./exploit\";\nimport { runLateralAgent } from \"./lateral\";\nimport { runBusinessLogicAgent, runEnhancedBusinessLogicEngine, shouldRunEnhancedEngine } from \"./business-logic\";\nimport { runMultiVectorAnalysisAgent, shouldRunMultiVectorAnalysis } from \"./multi-vector\";\nimport { runImpactAgent } from \"./impact\";\nimport { synthesizeResults } from \"./synthesizer\";\nimport { synthesizeAttackGraph } from \"./graph-synthesizer\";\nimport { generateEvidenceFromAnalysis } from \"./evidence-collector\";\nimport { generateIntelligentScore } from \"./scoring-engine\";\nimport { generateRemediationGuidance } from \"./remediation-engine\";\n\nexport interface OrchestratorOptions {\n  adversaryProfile?: AdversaryProfile;\n}\n\nexport async function runAgentOrchestrator(\n  assetId: string,\n  exposureType: string,\n  priority: string,\n  description: string,\n  evaluationId: string,\n  onProgress?: ProgressCallback,\n  options?: OrchestratorOptions\n): Promise<OrchestratorResult> {\n  const startTime = Date.now();\n\n  const context: AgentContext = {\n    assetId,\n    exposureType,\n    priority,\n    description,\n    evaluationId,\n    adversaryProfile: options?.adversaryProfile,\n  };\n\n  const memory: AgentMemory = { context };\n\n  onProgress?.(\"Recon Agent\", \"recon\", 5, \"Initializing reconnaissance...\");\n  const reconResult = await runReconAgent(memory, (stage: string, progress: number, message: string) => {\n    onProgress?.(\"Recon Agent\", stage, progress, message);\n  });\n  memory.recon = reconResult.findings;\n\n  onProgress?.(\"Exploit Agent\", \"exploit\", 25, \"Analyzing exploit chains...\");\n  const exploitResult = await runExploitAgent(memory, (stage: string, progress: number, message: string) => {\n    onProgress?.(\"Exploit Agent\", stage, progress, message);\n  });\n  memory.exploit = exploitResult.findings;\n\n  onProgress?.(\"Lateral Movement Agent\", \"lateral\", 45, \"Mapping lateral paths...\");\n  const lateralResult = await runLateralAgent(memory, (stage: string, progress: number, message: string) => {\n    onProgress?.(\"Lateral Movement Agent\", stage, progress, message);\n  });\n  memory.lateral = lateralResult.findings;\n\n  onProgress?.(\"Business Logic Agent\", \"business_logic\", 55, \"Analyzing business logic flaws...\");\n  const businessLogicResult = await runBusinessLogicAgent(memory, (stage: string, progress: number, message: string) => {\n    onProgress?.(\"Business Logic Agent\", stage, progress, message);\n  });\n  memory.businessLogic = businessLogicResult.findings;\n\n  if (shouldRunEnhancedEngine(exposureType)) {\n    onProgress?.(\"Business Logic Engine\", \"enhanced_business_logic\", 60, \"Running enhanced business logic analysis...\");\n    const enhancedResult = await runEnhancedBusinessLogicEngine(memory, (stage: string, progress: number, message: string) => {\n      onProgress?.(\"Business Logic Engine\", stage, progress, message);\n    });\n    memory.enhancedBusinessLogic = enhancedResult.findings;\n  }\n\n  if (shouldRunMultiVectorAnalysis(exposureType)) {\n    onProgress?.(\"Multi-Vector Agent\", \"multi_vector\", 70, \"Analyzing multi-vector attack paths...\");\n    const multiVectorResult = await runMultiVectorAnalysisAgent(memory, (stage: string, progress: number, message: string) => {\n      onProgress?.(\"Multi-Vector Agent\", stage, progress, message);\n    });\n    memory.multiVector = multiVectorResult.findings;\n  }\n\n  onProgress?.(\"Impact Agent\", \"impact\", 80, \"Assessing business impact...\");\n  const impactResult = await runImpactAgent(memory, (stage: string, progress: number, message: string) => {\n    onProgress?.(\"Impact Agent\", stage, progress, message);\n  });\n  memory.impact = impactResult.findings;\n\n  onProgress?.(\"Synthesizer\", \"synthesis\", 90, \"Generating final report...\");\n  const result = await synthesizeResults(memory);\n\n  onProgress?.(\"Graph Synthesizer\", \"graph_synthesis\", 92, \"Building attack graph...\");\n  const graphResult = await synthesizeAttackGraph(memory);\n\n  onProgress?.(\"Evidence Collector\", \"evidence\", 95, \"Capturing evidence artifacts...\");\n  const evidenceArtifacts = generateEvidenceFromAnalysis({\n    evaluationId,\n    assetId,\n    exposureType,\n    attackPath: result.attackPath,\n    businessLogicFindings: memory.enhancedBusinessLogic?.detailedFindings,\n    multiVectorFindings: memory.multiVector?.findings,\n  });\n\n  onProgress?.(\"Scoring Engine\", \"scoring\", 93, \"Calculating intelligent risk scores...\");\n  const intelligentScore = await generateIntelligentScore({\n    assetId,\n    exposureType,\n    priority,\n    description,\n    exploitable: result.exploitable,\n    attackPath: result.attackPath,\n    attackGraph: graphResult.attackGraph,\n    businessLogicFindings: memory.enhancedBusinessLogic?.detailedFindings,\n    multiVectorFindings: memory.multiVector?.findings,\n  });\n\n  onProgress?.(\"Remediation Engine\", \"remediation\", 96, \"Generating remediation guidance...\");\n  const remediationGuidance = await generateRemediationGuidance({\n    assetId,\n    exposureType,\n    priority,\n    description,\n    exploitable: result.exploitable,\n    attackPath: result.attackPath,\n    attackGraph: graphResult.attackGraph,\n    businessLogicFindings: memory.enhancedBusinessLogic?.detailedFindings,\n    multiVectorFindings: memory.multiVector?.findings,\n    intelligentScore,\n  }, evaluationId, (stage, progress, message) => {\n    onProgress?.(\"Remediation Engine\", stage, 96 + Math.floor(progress / 25), message);\n  });\n\n  const totalProcessingTime = Date.now() - startTime;\n\n  onProgress?.(\"Complete\", \"complete\", 100, \"Analysis complete\");\n\n  return {\n    ...result,\n    attackGraph: graphResult.attackGraph,\n    businessLogicFindings: memory.enhancedBusinessLogic?.detailedFindings,\n    multiVectorFindings: memory.multiVector?.findings,\n    workflowAnalysis: memory.enhancedBusinessLogic?.workflowAnalysis || undefined,\n    evidenceArtifacts,\n    intelligentScore,\n    remediationGuidance,\n    agentFindings: {\n      recon: memory.recon!,\n      exploit: memory.exploit!,\n      lateral: memory.lateral!,\n      businessLogic: memory.businessLogic!,\n      enhancedBusinessLogic: memory.enhancedBusinessLogic,\n      multiVector: memory.multiVector,\n      impact: memory.impact!,\n    },\n    totalProcessingTime,\n  };\n}\n","path":null,"size_bytes":6378,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/examples/ProgressModal.tsx":{"content":"import { useState } from \"react\";\nimport { ProgressModal } from \"../ProgressModal\";\nimport { Button } from \"@/components/ui/button\";\n\nexport default function ProgressModalExample() {\n  const [isOpen, setIsOpen] = useState(true);\n\n  return (\n    <div className=\"p-6\">\n      <Button onClick={() => setIsOpen(true)}>Open Progress Modal</Button>\n      <ProgressModal\n        isOpen={isOpen}\n        onClose={() => setIsOpen(false)}\n        assetId=\"web-api-gateway\"\n        evaluationId=\"aev-001\"\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":520,"size_tokens":null},"client/src/components/StatCard.tsx":{"content":"import { LucideIcon } from \"lucide-react\";\n\ninterface StatCardProps {\n  label: string;\n  value: string | number;\n  icon: LucideIcon;\n  trend?: { value: number; isPositive: boolean };\n  colorClass?: string;\n}\n\nexport function StatCard({ label, value, icon: Icon, trend, colorClass = \"text-foreground\" }: StatCardProps) {\n  return (\n    <div className=\"bg-card border border-border rounded-lg p-4 hover-elevate\" data-testid={`stat-${label.toLowerCase().replace(/\\s+/g, '-')}`}>\n      <div className=\"flex items-start justify-between gap-2\">\n        <div className=\"flex-1 min-w-0\">\n          <p className=\"text-xs uppercase tracking-wider text-muted-foreground truncate\">{label}</p>\n          <p className={`text-2xl font-bold mt-1 tabular-nums ${colorClass}`}>{value}</p>\n          {trend && (\n            <p className={`text-xs mt-1 ${trend.isPositive ? \"text-emerald-400\" : \"text-red-400\"}`}>\n              {trend.isPositive ? \"+\" : \"\"}{trend.value}% from last week\n            </p>\n          )}\n        </div>\n        <div className={`p-2 rounded-lg bg-gradient-to-br ${\n          colorClass.includes(\"cyan\") ? \"from-cyan-500/20 to-blue-500/20\" :\n          colorClass.includes(\"emerald\") ? \"from-emerald-500/20 to-green-500/20\" :\n          colorClass.includes(\"red\") ? \"from-red-500/20 to-orange-500/20\" :\n          colorClass.includes(\"amber\") ? \"from-amber-500/20 to-yellow-500/20\" :\n          \"from-primary/20 to-blue-500/20\"\n        }`}>\n          <Icon className={`h-5 w-5 ${colorClass}`} />\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":1545,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"server/services/agents/exploit.ts":{"content":"import OpenAI from \"openai\";\nimport type { AgentMemory, AgentResult, ExploitFindings } from \"./types\";\nimport { generateAdversaryPromptContext, adjustFindingsForProfile } from \"./adversary-profile\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\ntype ProgressCallback = (stage: string, progress: number, message: string) => void;\n\nexport async function runExploitAgent(\n  memory: AgentMemory,\n  onProgress?: ProgressCallback\n): Promise<AgentResult<ExploitFindings>> {\n  const startTime = Date.now();\n  \n  onProgress?.(\"exploit\", 30, \"Constructing exploit chains...\");\n\n  const reconContext = memory.recon\n    ? `\nPrevious Recon Findings:\n- Attack Surface: ${memory.recon.attackSurface.join(\", \")}\n- Entry Points: ${memory.recon.entryPoints.join(\", \")}\n- API Endpoints: ${memory.recon.apiEndpoints.join(\", \")}\n- Auth Mechanisms: ${memory.recon.authMechanisms.join(\", \")}\n- Technologies: ${memory.recon.technologies.join(\", \")}\n- Potential Vulnerabilities: ${memory.recon.potentialVulnerabilities.join(\", \")}\n`\n    : \"\";\n\n  const adversaryContext = memory.context.adversaryProfile \n    ? generateAdversaryPromptContext(memory.context.adversaryProfile)\n    : \"\";\n\n  const systemPrompt = `You are the EXPLOIT AGENT, a specialized AI exploitation analysis system for OdinForge AI.\n\nYour mission is to analyze the reconnaissance findings and determine:\n1. Whether the target is exploitable in real-world conditions\n2. Specific exploit chains that could be used (with MITRE ATT&CK techniques)\n3. Relevant CVE references if applicable\n4. Misconfigurations that could be abused\n\nThink like an offensive security expert crafting exploitation strategies. Be realistic about success likelihood.\n${adversaryContext}`;\n\n  const userPrompt = `Analyze exploitability for this security exposure:\n\nAsset ID: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nPriority: ${memory.context.priority}\nDescription: ${memory.context.description}\n${reconContext}\n\nProvide your exploitation analysis as a JSON object with this structure:\n{\n  \"exploitable\": boolean (true if realistically exploitable),\n  \"exploitChains\": [\n    {\n      \"name\": \"Name of the exploit chain\",\n      \"technique\": \"MITRE ATT&CK technique ID (e.g., T1190)\",\n      \"description\": \"Detailed description of how this exploit works\",\n      \"success_likelihood\": \"high\" | \"medium\" | \"low\"\n    }\n  ],\n  \"cveReferences\": [\"CVE-XXXX-XXXX if applicable\"],\n  \"misconfigurations\": [\"list of exploitable misconfigurations\"]\n}`;\n\n  try {\n    onProgress?.(\"exploit\", 35, \"Analyzing CVE databases...\");\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 2048,\n    });\n\n    onProgress?.(\"exploit\", 40, \"Validating exploit feasibility...\");\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response from Exploit Agent\");\n    }\n\n    const findings = JSON.parse(content) as ExploitFindings;\n    \n    const validatedFindings: ExploitFindings = {\n      exploitable: Boolean(findings.exploitable),\n      exploitChains: Array.isArray(findings.exploitChains)\n        ? findings.exploitChains.map((chain) => ({\n            name: String(chain.name || \"Unknown\"),\n            technique: String(chain.technique || \"T0000\"),\n            description: String(chain.description || \"\"),\n            success_likelihood: validateLikelihood(chain.success_likelihood),\n          }))\n        : [],\n      cveReferences: Array.isArray(findings.cveReferences) ? findings.cveReferences : [],\n      misconfigurations: Array.isArray(findings.misconfigurations) ? findings.misconfigurations : [],\n    };\n\n    return {\n      success: true,\n      findings: validatedFindings,\n      agentName: \"Exploit Agent\",\n      processingTime: Date.now() - startTime,\n    };\n  } catch (error) {\n    console.error(\"Exploit Agent error:\", error);\n    throw error;\n  }\n}\n\nfunction validateLikelihood(likelihood: unknown): \"high\" | \"medium\" | \"low\" {\n  const valid = [\"high\", \"medium\", \"low\"];\n  return valid.includes(String(likelihood)) ? (likelihood as \"high\" | \"medium\" | \"low\") : \"medium\";\n}\n","path":null,"size_bytes":4391,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2359,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"server/services/websocket.ts":{"content":"import { WebSocketServer, WebSocket } from \"ws\";\nimport type { Server } from \"http\";\nimport type { IncomingMessage } from \"http\";\nimport { jwtAuthService, type TokenValidationResult } from \"./jwt-auth\";\n\ninterface AEVProgressEvent {\n  type: \"aev_progress\";\n  evaluationId: string;\n  agentName: string;\n  stage: string;\n  progress: number;\n  message: string;\n}\n\ninterface AEVCompleteEvent {\n  type: \"aev_complete\";\n  evaluationId: string;\n  success: boolean;\n  error?: string;\n}\n\ninterface SimulationProgressEvent {\n  type: \"simulation_progress\";\n  simulationId: string;\n  round: number;\n  phase: \"attack\" | \"defense\" | \"analysis\";\n  message: string;\n}\n\ninterface HeartbeatEvent {\n  type: \"heartbeat\";\n  timestamp: number;\n}\n\ntype WebSocketEvent = AEVProgressEvent | AEVCompleteEvent | SimulationProgressEvent | HeartbeatEvent;\n\ninterface ClientInfo {\n  ws: WebSocket;\n  lastPing: number;\n  lastPong: number;\n  messageQueue: string[];\n  subscriptions: Set<string>;\n  ip: string;\n  authenticated: boolean;\n  userId?: string;\n  organizationId?: string;\n}\n\ninterface WebSocketConfig {\n  maxConnections: number;\n  maxConnectionsPerIp: number;\n  heartbeatIntervalMs: number;\n  clientTimeoutMs: number;\n  maxMessageQueueSize: number;\n  maxMessageSize: number;\n  requireAuth: boolean;\n}\n\nconst DEFAULT_CONFIG: WebSocketConfig = {\n  maxConnections: 1000,\n  maxConnectionsPerIp: 50,\n  heartbeatIntervalMs: 30000,\n  clientTimeoutMs: 60000,\n  maxMessageQueueSize: 100,\n  maxMessageSize: 64 * 1024,\n  // Enable auth by default in production; disable only if explicitly set to \"false\" for demo/testing\n  requireAuth: process.env.NODE_ENV === \"production\" && process.env.WS_REQUIRE_AUTH !== \"false\",\n};\n\nclass WebSocketService {\n  private wss: WebSocketServer | null = null;\n  private clients: Map<WebSocket, ClientInfo> = new Map();\n  private ipConnectionCount: Map<string, number> = new Map();\n  private heartbeatInterval: NodeJS.Timeout | null = null;\n  private cleanupInterval: NodeJS.Timeout | null = null;\n  private config: WebSocketConfig = DEFAULT_CONFIG;\n  private stats = {\n    totalConnections: 0,\n    totalMessages: 0,\n    totalDisconnections: 0,\n    rejectedConnections: 0,\n  };\n\n  initialize(server: Server, config?: Partial<WebSocketConfig>): void {\n    this.config = { ...DEFAULT_CONFIG, ...config };\n    \n    this.wss = new WebSocketServer({ \n      server, \n      path: \"/ws\",\n      maxPayload: this.config.maxMessageSize,\n    });\n\n    this.wss.on(\"connection\", (ws: WebSocket, req: IncomingMessage) => {\n      this.handleConnection(ws, req);\n    });\n\n    this.startHeartbeat();\n    this.startCleanup();\n\n    console.log(`WebSocket server initialized on /ws (max: ${this.config.maxConnections} connections)`);\n  }\n\n  private getClientIp(req: IncomingMessage): string {\n    const forwarded = req.headers[\"x-forwarded-for\"];\n    if (forwarded) {\n      const ips = Array.isArray(forwarded) ? forwarded[0] : forwarded.split(\",\")[0];\n      return ips.trim();\n    }\n    return req.socket.remoteAddress || \"unknown\";\n  }\n\n  private async handleConnection(ws: WebSocket, req: IncomingMessage): Promise<void> {\n    const ip = this.getClientIp(req);\n    \n    if (this.clients.size >= this.config.maxConnections) {\n      console.warn(`[WS] Connection rejected: max connections reached (${this.config.maxConnections})`);\n      ws.close(1013, \"Max connections reached\");\n      this.stats.rejectedConnections++;\n      return;\n    }\n    \n    const ipCount = this.ipConnectionCount.get(ip) || 0;\n    if (ipCount >= this.config.maxConnectionsPerIp) {\n      console.warn(`[WS] Connection rejected: max connections per IP reached for ${ip}`);\n      ws.close(1013, \"Max connections per IP reached\");\n      this.stats.rejectedConnections++;\n      return;\n    }\n    \n    // Extract token from URL query string for authentication\n    const url = new URL(req.url || \"/\", `http://${req.headers.host}`);\n    const token = url.searchParams.get(\"token\");\n    \n    // In production with requireAuth=true, reject unauthenticated connections\n    let authenticated = !this.config.requireAuth;\n    let userId: string | undefined;\n    let organizationId: string | undefined;\n    \n    if (this.config.requireAuth && !token) {\n      console.warn(`[WS] Connection rejected: authentication required from ${ip}`);\n      ws.close(1008, \"Authentication required\");\n      this.stats.rejectedConnections++;\n      return;\n    }\n    \n    // Validate JWT token if provided\n    if (token) {\n      try {\n        const validation: TokenValidationResult = await jwtAuthService.validateToken(token);\n        if (validation.valid && validation.payload) {\n          authenticated = true;\n          userId = validation.payload.sub;\n          organizationId = validation.payload.organizationId;\n          console.log(`[WS] Token validated for user ${userId}, org ${organizationId}`);\n        } else if (this.config.requireAuth) {\n          console.warn(`[WS] Connection rejected: invalid token from ${ip} - ${validation.error}`);\n          ws.close(1008, \"Invalid token\");\n          this.stats.rejectedConnections++;\n          return;\n        }\n      } catch (error) {\n        console.error(`[WS] Token validation error from ${ip}:`, error);\n        if (this.config.requireAuth) {\n          ws.close(1008, \"Token validation failed\");\n          this.stats.rejectedConnections++;\n          return;\n        }\n      }\n    }\n    \n    const clientInfo: ClientInfo = {\n      ws,\n      lastPing: Date.now(),\n      lastPong: Date.now(),\n      messageQueue: [],\n      subscriptions: new Set(),\n      ip,\n      authenticated,\n      userId: userId || undefined,\n      organizationId: organizationId || undefined,\n    };\n    \n    this.clients.set(ws, clientInfo);\n    this.ipConnectionCount.set(ip, ipCount + 1);\n    this.stats.totalConnections++;\n    \n    console.log(`[WS] Client connected from ${ip} (auth: ${authenticated}, total: ${this.clients.size})`);\n    \n    ws.on(\"pong\", () => {\n      const client = this.clients.get(ws);\n      if (client) {\n        client.lastPong = Date.now();\n      }\n    });\n    \n    ws.on(\"message\", (data: Buffer) => {\n      this.handleMessage(ws, data);\n    });\n\n    ws.on(\"close\", (code: number, reason: Buffer) => {\n      this.handleDisconnection(ws, code, reason.toString());\n    });\n\n    ws.on(\"error\", (error: Error) => {\n      console.error(`[WS] Client error from ${ip}:`, error.message);\n      this.handleDisconnection(ws, 1011, \"Internal error\");\n    });\n    \n    this.sendToClient(ws, { type: \"heartbeat\", timestamp: Date.now() });\n  }\n\n  private handleMessage(ws: WebSocket, data: Buffer): void {\n    const client = this.clients.get(ws);\n    if (!client) return;\n    \n    try {\n      const message = JSON.parse(data.toString());\n      \n      if (message.type === \"subscribe\" && typeof message.channel === \"string\") {\n        client.subscriptions.add(message.channel);\n        console.log(`[WS] Client subscribed to: ${message.channel}`);\n      }\n      \n      if (message.type === \"unsubscribe\" && typeof message.channel === \"string\") {\n        client.subscriptions.delete(message.channel);\n      }\n      \n      if (message.type === \"ping\") {\n        this.sendToClient(ws, { type: \"heartbeat\", timestamp: Date.now() });\n      }\n    } catch (error) {\n      console.warn(`[WS] Invalid message from client`);\n    }\n  }\n\n  private handleDisconnection(ws: WebSocket, code: number, reason: string): void {\n    const client = this.clients.get(ws);\n    if (!client) return;\n    \n    const ipCount = this.ipConnectionCount.get(client.ip) || 0;\n    if (ipCount > 1) {\n      this.ipConnectionCount.set(client.ip, ipCount - 1);\n    } else {\n      this.ipConnectionCount.delete(client.ip);\n    }\n    \n    this.clients.delete(ws);\n    this.stats.totalDisconnections++;\n    \n    console.log(`[WS] Client disconnected from ${client.ip} (code: ${code}, total: ${this.clients.size})`);\n  }\n\n  private startHeartbeat(): void {\n    this.heartbeatInterval = setInterval(() => {\n      const now = Date.now();\n      \n      this.clients.forEach((client, ws) => {\n        if (now - client.lastPong > this.config.clientTimeoutMs) {\n          console.log(`[WS] Client timeout, terminating connection from ${client.ip}`);\n          ws.terminate();\n          return;\n        }\n        \n        if (ws.readyState === WebSocket.OPEN) {\n          client.lastPing = now;\n          ws.ping();\n        }\n      });\n    }, this.config.heartbeatIntervalMs);\n    \n    if (this.heartbeatInterval.unref) {\n      this.heartbeatInterval.unref();\n    }\n  }\n\n  private startCleanup(): void {\n    this.cleanupInterval = setInterval(() => {\n      this.clients.forEach((client, ws) => {\n        if (ws.readyState !== WebSocket.OPEN) {\n          this.handleDisconnection(ws, 1006, \"Connection lost\");\n        }\n        \n        if (client.messageQueue.length > 0 && ws.readyState === WebSocket.OPEN) {\n          const messages = client.messageQueue.splice(0, 10);\n          messages.forEach(msg => ws.send(msg));\n        }\n      });\n    }, 5000);\n    \n    if (this.cleanupInterval.unref) {\n      this.cleanupInterval.unref();\n    }\n  }\n\n  private sendToClient(ws: WebSocket, event: WebSocketEvent): boolean {\n    const client = this.clients.get(ws);\n    if (!client) return false;\n    \n    const message = JSON.stringify(event);\n    \n    if (ws.readyState === WebSocket.OPEN) {\n      try {\n        ws.send(message);\n        this.stats.totalMessages++;\n        return true;\n      } catch (error) {\n        if (client.messageQueue.length < this.config.maxMessageQueueSize) {\n          client.messageQueue.push(message);\n        }\n        return false;\n      }\n    } else if (client.messageQueue.length < this.config.maxMessageQueueSize) {\n      client.messageQueue.push(message);\n    }\n    \n    return false;\n  }\n\n  broadcast(event: WebSocketEvent): void {\n    this.clients.forEach((client, ws) => {\n      this.sendToClient(ws, event);\n    });\n  }\n\n  broadcastToChannel(channel: string, event: WebSocketEvent): void {\n    this.clients.forEach((client, ws) => {\n      if (client.subscriptions.has(channel)) {\n        this.sendToClient(ws, event);\n      }\n    });\n  }\n\n  sendProgress(evaluationId: string, agentName: string, stage: string, progress: number, message: string): void {\n    const event: AEVProgressEvent = {\n      type: \"aev_progress\",\n      evaluationId,\n      agentName,\n      stage,\n      progress,\n      message,\n    };\n    \n    this.broadcast(event);\n    this.broadcastToChannel(`evaluation:${evaluationId}`, event);\n  }\n\n  sendComplete(evaluationId: string, success: boolean, error?: string): void {\n    const event: AEVCompleteEvent = {\n      type: \"aev_complete\",\n      evaluationId,\n      success,\n      error,\n    };\n    \n    this.broadcast(event);\n    this.broadcastToChannel(`evaluation:${evaluationId}`, event);\n  }\n\n  sendSimulationProgress(simulationId: string, round: number, phase: \"attack\" | \"defense\" | \"analysis\", message: string): void {\n    const event: SimulationProgressEvent = {\n      type: \"simulation_progress\",\n      simulationId,\n      round,\n      phase,\n      message,\n    };\n    \n    this.broadcast(event);\n    this.broadcastToChannel(`simulation:${simulationId}`, event);\n  }\n\n  getStats(): {\n    activeConnections: number;\n    totalConnections: number;\n    totalMessages: number;\n    totalDisconnections: number;\n    rejectedConnections: number;\n    uniqueIps: number;\n  } {\n    return {\n      activeConnections: this.clients.size,\n      totalConnections: this.stats.totalConnections,\n      totalMessages: this.stats.totalMessages,\n      totalDisconnections: this.stats.totalDisconnections,\n      rejectedConnections: this.stats.rejectedConnections,\n      uniqueIps: this.ipConnectionCount.size,\n    };\n  }\n\n  shutdown(): void {\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n    }\n    if (this.cleanupInterval) {\n      clearInterval(this.cleanupInterval);\n    }\n    \n    this.clients.forEach((client, ws) => {\n      ws.close(1001, \"Server shutting down\");\n    });\n    \n    this.clients.clear();\n    this.ipConnectionCount.clear();\n    \n    if (this.wss) {\n      this.wss.close();\n    }\n    \n    console.log(\"[WS] WebSocket server shutdown complete\");\n  }\n}\n\nexport const wsService = new WebSocketService();\n","path":null,"size_bytes":12214,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"server/services/agents/graph-synthesizer.ts":{"content":"import OpenAI from \"openai\";\nimport type { AgentMemory } from \"./types\";\nimport type { AttackGraph, AttackNode, AttackEdge, KillChainTactic, killChainTactics } from \"@shared/schema\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\ninterface GraphSynthesisResult {\n  attackGraph: AttackGraph;\n}\n\nexport async function synthesizeAttackGraph(memory: AgentMemory): Promise<GraphSynthesisResult> {\n  const allFindings = formatAgentFindings(memory);\n\n  const systemPrompt = `You are the ATTACK GRAPH SYNTHESIZER for OdinForge AI, a multi-agent security validation platform.\n\nYour mission is to synthesize findings from 5 specialized AI agents into a comprehensive ATTACK GRAPH that shows all possible attack paths, their relationships, and conditional branches.\n\nYou must create a directed graph where:\n- NODES represent states/positions in the attack (entry points, pivot points, objectives, dead-ends)\n- EDGES represent techniques/transitions between states with success probabilities\n\nKey responsibilities:\n1. Identify the ENTRY NODE (initial access point)\n2. Map all discovered attack paths as connected nodes and edges\n3. Identify OBJECTIVE NODES (final targets/goals)\n4. Calculate the CRITICAL PATH (most likely successful attack chain)\n5. Identify ALTERNATIVE PATHS (backup attack routes)\n6. Map each step to MITRE ATT&CK tactics (kill chain coverage)\n7. Score overall complexity and estimate time-to-compromise\n\nThe graph should be realistic and based on the actual findings from the agents.`;\n\n  const userPrompt = `Synthesize these multi-agent findings into an attack graph:\n\nTarget: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nPriority: ${memory.context.priority}\nDescription: ${memory.context.description}\n\n${allFindings}\n\nGenerate a JSON attack graph with this exact structure:\n{\n  \"nodes\": [\n    {\n      \"id\": \"node-1\",\n      \"label\": \"Initial Access via API\",\n      \"description\": \"Detailed description of this attack state\",\n      \"nodeType\": \"entry\" | \"pivot\" | \"objective\" | \"dead-end\",\n      \"tactic\": \"initial-access\" (one of: reconnaissance, resource-development, initial-access, execution, persistence, privilege-escalation, defense-evasion, credential-access, discovery, lateral-movement, collection, command-and-control, exfiltration, impact),\n      \"compromiseLevel\": \"none\" | \"limited\" | \"user\" | \"admin\" | \"system\",\n      \"assets\": [\"asset1\", \"asset2\"],\n      \"discoveredBy\": \"recon\" | \"exploit\" | \"lateral\" | \"business-logic\" | \"impact\"\n    }\n  ],\n  \"edges\": [\n    {\n      \"id\": \"edge-1\",\n      \"source\": \"node-1\",\n      \"target\": \"node-2\",\n      \"technique\": \"SQL Injection\",\n      \"techniqueId\": \"T1190\",\n      \"description\": \"Exploit SQL injection to gain database access\",\n      \"successProbability\": 85,\n      \"complexity\": \"trivial\" | \"low\" | \"medium\" | \"high\" | \"expert\",\n      \"timeEstimate\": 30,\n      \"prerequisites\": [\"Database access\", \"Valid input field\"],\n      \"alternatives\": [\"edge-3\"],\n      \"edgeType\": \"primary\" | \"alternative\" | \"fallback\",\n      \"discoveredBy\": \"recon\" | \"exploit\" | \"lateral\" | \"business-logic\" | \"impact\"\n    }\n  ],\n  \"entryNodeId\": \"node-1\",\n  \"objectiveNodeIds\": [\"node-5\", \"node-6\"],\n  \"criticalPath\": [\"node-1\", \"node-2\", \"node-4\", \"node-5\"],\n  \"alternativePaths\": [[\"node-1\", \"node-3\", \"node-5\"]],\n  \"killChainCoverage\": [\"initial-access\", \"execution\", \"privilege-escalation\", \"impact\"],\n  \"complexityScore\": 65,\n  \"timeToCompromise\": {\n    \"minimum\": 2,\n    \"expected\": 6,\n    \"maximum\": 24,\n    \"unit\": \"hours\"\n  },\n  \"chainedExploits\": [\n    {\n      \"name\": \"SQL-to-Admin Chain\",\n      \"techniques\": [\"T1190\", \"T1078\", \"T1068\"],\n      \"combinedImpact\": \"Full system compromise via chained vulnerabilities\"\n    }\n  ]\n}\n\nRequirements:\n- Create at least 3 nodes minimum (entry, pivot(s), objective)\n- Every node except entry must be reachable via edges\n- Critical path must be a valid path from entry to an objective\n- timeEstimate in edges is in minutes\n- complexityScore is 0-100 (higher = more complex)\n- Ensure all node IDs in edges exist in nodes array`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 4096,\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response from Graph Synthesizer\");\n    }\n\n    const rawGraph = JSON.parse(content);\n    const attackGraph = validateAndNormalizeGraph(rawGraph);\n\n    return { attackGraph };\n  } catch (error) {\n    console.error(\"Graph Synthesizer error:\", error);\n    return { attackGraph: createFallbackGraph(memory) };\n  }\n}\n\nfunction formatAgentFindings(memory: AgentMemory): string {\n  return `\n=== RECON AGENT FINDINGS ===\nAttack Surface: ${memory.recon?.attackSurface.join(\", \") || \"None\"}\nEntry Points: ${memory.recon?.entryPoints.join(\", \") || \"None\"}\nAPI Endpoints: ${memory.recon?.apiEndpoints.join(\", \") || \"None\"}\nAuth Mechanisms: ${memory.recon?.authMechanisms.join(\", \") || \"None\"}\nTechnologies: ${memory.recon?.technologies.join(\", \") || \"None\"}\nPotential Vulnerabilities: ${memory.recon?.potentialVulnerabilities.join(\", \") || \"None\"}\n\n=== EXPLOIT AGENT FINDINGS ===\nExploitable: ${memory.exploit?.exploitable || false}\nExploit Chains: ${memory.exploit?.exploitChains.map((c) => `${c.name} (${c.technique}, ${c.success_likelihood})`).join(\"; \") || \"None\"}\nCVE References: ${memory.exploit?.cveReferences.join(\", \") || \"None\"}\nMisconfigurations: ${memory.exploit?.misconfigurations.join(\", \") || \"None\"}\n\n=== LATERAL MOVEMENT AGENT FINDINGS ===\nPivot Paths: ${memory.lateral?.pivotPaths.map((p) => `${p.from} -> ${p.to} via ${p.method}`).join(\"; \") || \"None\"}\nPrivilege Escalation: ${memory.lateral?.privilegeEscalation.map((e) => `${e.target} (${e.likelihood})`).join(\"; \") || \"None\"}\nToken Reuse: ${memory.lateral?.tokenReuse.join(\", \") || \"None\"}\n\n=== BUSINESS LOGIC AGENT FINDINGS ===\nWorkflow Abuse: ${memory.businessLogic?.workflowAbuse.join(\", \") || \"None\"}\nState Manipulation: ${memory.businessLogic?.stateManipulation.join(\", \") || \"None\"}\nRace Conditions: ${memory.businessLogic?.raceConditions.join(\", \") || \"None\"}\nAuthorization Bypass: ${memory.businessLogic?.authorizationBypass.join(\", \") || \"None\"}\nCritical Flows: ${memory.businessLogic?.criticalFlows.join(\", \") || \"None\"}\n\n=== IMPACT AGENT FINDINGS ===\nData Exposure: ${memory.impact?.dataExposure.types.join(\", \") || \"None\"} (Severity: ${memory.impact?.dataExposure.severity || \"Unknown\"}, Records: ${memory.impact?.dataExposure.estimatedRecords || \"Unknown\"})\nFinancial Impact: ${memory.impact?.financialImpact.estimate || \"Unknown\"} - Factors: ${memory.impact?.financialImpact.factors.join(\", \") || \"None\"}\nCompliance Impact: ${memory.impact?.complianceImpact.join(\", \") || \"None\"}\nReputational Risk: ${memory.impact?.reputationalRisk || \"Unknown\"}\n`;\n}\n\nfunction validateAndNormalizeGraph(raw: unknown): AttackGraph {\n  const graph = raw as Record<string, unknown>;\n  \n  const validTactics: KillChainTactic[] = [\n    \"reconnaissance\", \"resource-development\", \"initial-access\", \"execution\",\n    \"persistence\", \"privilege-escalation\", \"defense-evasion\", \"credential-access\",\n    \"discovery\", \"lateral-movement\", \"collection\", \"command-and-control\",\n    \"exfiltration\", \"impact\"\n  ];\n\n  const nodes: AttackNode[] = Array.isArray(graph.nodes)\n    ? graph.nodes.map((n: Record<string, unknown>, i: number) => ({\n        id: String(n.id || `node-${i + 1}`),\n        label: String(n.label || \"Attack Node\"),\n        description: String(n.description || \"\"),\n        nodeType: validateNodeType(n.nodeType),\n        tactic: validateTactic(n.tactic, validTactics),\n        compromiseLevel: validateCompromiseLevel(n.compromiseLevel),\n        assets: Array.isArray(n.assets) ? n.assets.map(String) : undefined,\n        discoveredBy: validateAgentName(n.discoveredBy),\n      }))\n    : [];\n\n  const edges: AttackEdge[] = Array.isArray(graph.edges)\n    ? graph.edges.map((e: Record<string, unknown>, i: number) => ({\n        id: String(e.id || `edge-${i + 1}`),\n        source: String(e.source || \"\"),\n        target: String(e.target || \"\"),\n        technique: String(e.technique || \"Unknown Technique\"),\n        techniqueId: e.techniqueId ? String(e.techniqueId) : undefined,\n        description: String(e.description || \"\"),\n        successProbability: Math.min(100, Math.max(0, Number(e.successProbability) || 50)),\n        complexity: validateComplexity(e.complexity),\n        timeEstimate: Math.max(1, Number(e.timeEstimate) || 30),\n        prerequisites: Array.isArray(e.prerequisites) ? e.prerequisites.map(String) : undefined,\n        alternatives: Array.isArray(e.alternatives) ? e.alternatives.map(String) : undefined,\n        edgeType: validateEdgeType(e.edgeType),\n        discoveredBy: validateAgentName(e.discoveredBy),\n      }))\n    : [];\n\n  const entryNodeId = String(graph.entryNodeId || nodes[0]?.id || \"node-1\");\n  const objectiveNodeIds = Array.isArray(graph.objectiveNodeIds)\n    ? graph.objectiveNodeIds.map(String)\n    : nodes.filter(n => n.nodeType === \"objective\").map(n => n.id);\n\n  const criticalPath = Array.isArray(graph.criticalPath)\n    ? graph.criticalPath.map(String)\n    : [entryNodeId, ...(objectiveNodeIds.length > 0 ? [objectiveNodeIds[0]] : [])];\n\n  const alternativePaths = Array.isArray(graph.alternativePaths)\n    ? graph.alternativePaths.map((path: unknown[]) => \n        Array.isArray(path) ? path.map(String) : []\n      )\n    : undefined;\n\n  const killChainCoverage = Array.isArray(graph.killChainCoverage)\n    ? graph.killChainCoverage\n        .map((t: unknown) => validateTactic(t, validTactics))\n        .filter((t, i, arr) => arr.indexOf(t) === i)\n    : extractKillChainFromNodes(nodes, validTactics);\n\n  const complexityScore = Math.min(100, Math.max(0, Number(graph.complexityScore) || calculateComplexity(edges)));\n\n  const timeToCompromise = graph.timeToCompromise && typeof graph.timeToCompromise === 'object'\n    ? {\n        minimum: Math.max(1, Number((graph.timeToCompromise as Record<string, unknown>).minimum) || 1),\n        expected: Math.max(1, Number((graph.timeToCompromise as Record<string, unknown>).expected) || 4),\n        maximum: Math.max(1, Number((graph.timeToCompromise as Record<string, unknown>).maximum) || 24),\n        unit: validateTimeUnit((graph.timeToCompromise as Record<string, unknown>).unit),\n      }\n    : calculateTimeToCompromise(edges);\n\n  const chainedExploits = Array.isArray(graph.chainedExploits)\n    ? graph.chainedExploits.map((c: Record<string, unknown>) => ({\n        name: String(c.name || \"Exploit Chain\"),\n        techniques: Array.isArray(c.techniques) ? c.techniques.map(String) : [],\n        combinedImpact: String(c.combinedImpact || \"Combined exploitation impact\"),\n      }))\n    : undefined;\n\n  return {\n    nodes,\n    edges,\n    entryNodeId,\n    objectiveNodeIds,\n    criticalPath,\n    alternativePaths,\n    killChainCoverage,\n    complexityScore,\n    timeToCompromise,\n    chainedExploits,\n  };\n}\n\nfunction validateNodeType(type: unknown): \"entry\" | \"pivot\" | \"objective\" | \"dead-end\" {\n  const valid = [\"entry\", \"pivot\", \"objective\", \"dead-end\"];\n  return valid.includes(String(type)) ? (type as \"entry\" | \"pivot\" | \"objective\" | \"dead-end\") : \"pivot\";\n}\n\nfunction validateTactic(tactic: unknown, validTactics: KillChainTactic[]): KillChainTactic {\n  return validTactics.includes(String(tactic) as KillChainTactic)\n    ? (tactic as KillChainTactic)\n    : \"initial-access\";\n}\n\nfunction validateCompromiseLevel(level: unknown): \"none\" | \"limited\" | \"user\" | \"admin\" | \"system\" {\n  const valid = [\"none\", \"limited\", \"user\", \"admin\", \"system\"];\n  return valid.includes(String(level)) ? (level as \"none\" | \"limited\" | \"user\" | \"admin\" | \"system\") : \"limited\";\n}\n\nfunction validateComplexity(complexity: unknown): \"trivial\" | \"low\" | \"medium\" | \"high\" | \"expert\" {\n  const valid = [\"trivial\", \"low\", \"medium\", \"high\", \"expert\"];\n  return valid.includes(String(complexity)) ? (complexity as \"trivial\" | \"low\" | \"medium\" | \"high\" | \"expert\") : \"medium\";\n}\n\nfunction validateEdgeType(type: unknown): \"primary\" | \"alternative\" | \"fallback\" {\n  const valid = [\"primary\", \"alternative\", \"fallback\"];\n  return valid.includes(String(type)) ? (type as \"primary\" | \"alternative\" | \"fallback\") : \"primary\";\n}\n\nfunction validateTimeUnit(unit: unknown): \"minutes\" | \"hours\" | \"days\" {\n  const valid = [\"minutes\", \"hours\", \"days\"];\n  return valid.includes(String(unit)) ? (unit as \"minutes\" | \"hours\" | \"days\") : \"hours\";\n}\n\nfunction validateAgentName(name: unknown): \"recon\" | \"exploit\" | \"lateral\" | \"business-logic\" | \"impact\" | undefined {\n  const valid = [\"recon\", \"exploit\", \"lateral\", \"business-logic\", \"impact\"];\n  return valid.includes(String(name)) ? (name as \"recon\" | \"exploit\" | \"lateral\" | \"business-logic\" | \"impact\") : undefined;\n}\n\nfunction extractKillChainFromNodes(nodes: AttackNode[], validTactics: KillChainTactic[]): KillChainTactic[] {\n  const tactics = nodes.map(n => n.tactic).filter(t => validTactics.includes(t));\n  return Array.from(new Set(tactics));\n}\n\nfunction calculateComplexity(edges: AttackEdge[]): number {\n  if (edges.length === 0) return 50;\n  \n  const complexityWeights = { trivial: 10, low: 25, medium: 50, high: 75, expert: 95 };\n  const avgComplexity = edges.reduce((sum, e) => sum + complexityWeights[e.complexity], 0) / edges.length;\n  const pathLengthFactor = Math.min(edges.length * 5, 30);\n  \n  return Math.min(100, Math.round(avgComplexity + pathLengthFactor));\n}\n\nfunction calculateTimeToCompromise(edges: AttackEdge[]): { minimum: number; expected: number; maximum: number; unit: \"minutes\" | \"hours\" | \"days\" } {\n  if (edges.length === 0) {\n    return { minimum: 1, expected: 4, maximum: 24, unit: \"hours\" };\n  }\n\n  const totalMinutes = edges.reduce((sum, e) => sum + e.timeEstimate, 0);\n  \n  if (totalMinutes < 60) {\n    return {\n      minimum: Math.max(5, Math.round(totalMinutes * 0.5)),\n      expected: totalMinutes,\n      maximum: Math.round(totalMinutes * 2),\n      unit: \"minutes\",\n    };\n  } else if (totalMinutes < 1440) {\n    const hours = totalMinutes / 60;\n    return {\n      minimum: Math.max(1, Math.round(hours * 0.5)),\n      expected: Math.round(hours),\n      maximum: Math.round(hours * 2),\n      unit: \"hours\",\n    };\n  } else {\n    const days = totalMinutes / 1440;\n    return {\n      minimum: Math.max(1, Math.round(days * 0.5)),\n      expected: Math.round(days),\n      maximum: Math.round(days * 2),\n      unit: \"days\",\n    };\n  }\n}\n\nfunction createFallbackGraph(memory: AgentMemory): AttackGraph {\n  const entryNode: AttackNode = {\n    id: \"node-entry\",\n    label: \"Initial Access Point\",\n    description: `Entry point for ${memory.context.exposureType} targeting ${memory.context.assetId}`,\n    nodeType: \"entry\",\n    tactic: \"initial-access\",\n    compromiseLevel: \"none\",\n    discoveredBy: \"recon\",\n  };\n\n  const pivotNode: AttackNode = {\n    id: \"node-pivot\",\n    label: \"Exploitation Phase\",\n    description: \"Exploitation of identified vulnerability\",\n    nodeType: \"pivot\",\n    tactic: \"execution\",\n    compromiseLevel: \"user\",\n    discoveredBy: \"exploit\",\n  };\n\n  const objectiveNode: AttackNode = {\n    id: \"node-objective\",\n    label: \"Attack Objective\",\n    description: \"Target objective based on impact assessment\",\n    nodeType: \"objective\",\n    tactic: \"impact\",\n    compromiseLevel: \"admin\",\n    discoveredBy: \"impact\",\n  };\n\n  const edge1: AttackEdge = {\n    id: \"edge-1\",\n    source: \"node-entry\",\n    target: \"node-pivot\",\n    technique: \"Exploit Public-Facing Application\",\n    techniqueId: \"T1190\",\n    description: \"Initial exploitation of entry point\",\n    successProbability: 70,\n    complexity: \"medium\",\n    timeEstimate: 30,\n    edgeType: \"primary\",\n    discoveredBy: \"exploit\",\n  };\n\n  const edge2: AttackEdge = {\n    id: \"edge-2\",\n    source: \"node-pivot\",\n    target: \"node-objective\",\n    technique: \"Privilege Escalation\",\n    techniqueId: \"T1068\",\n    description: \"Escalate privileges to achieve objective\",\n    successProbability: 60,\n    complexity: \"high\",\n    timeEstimate: 60,\n    edgeType: \"primary\",\n    discoveredBy: \"lateral\",\n  };\n\n  return {\n    nodes: [entryNode, pivotNode, objectiveNode],\n    edges: [edge1, edge2],\n    entryNodeId: \"node-entry\",\n    objectiveNodeIds: [\"node-objective\"],\n    criticalPath: [\"node-entry\", \"node-pivot\", \"node-objective\"],\n    killChainCoverage: [\"initial-access\", \"execution\", \"impact\"],\n    complexityScore: 55,\n    timeToCompromise: {\n      minimum: 1,\n      expected: 2,\n      maximum: 6,\n      unit: \"hours\",\n    },\n  };\n}\n","path":null,"size_bytes":16790,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"replit.md":{"content":"# OdinForge AI Platform\n\n## Overview\n\nOdinForge AI (Adversarial Exposure Validation) is a next-generation AI-powered security platform that performs autonomous exploit validation and attack simulation. The platform analyzes security exposures (CVEs, misconfigurations, behavioral anomalies, network vulnerabilities) and uses AI to determine exploitability, construct attack paths using MITRE ATT&CK techniques, assess business impact, and generate remediation recommendations.\n\nThe application follows a full-stack TypeScript architecture with a React frontend, Express backend, PostgreSQL database, and real-time WebSocket communication for live evaluation progress updates.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend Architecture\n- **Framework**: React 18 with TypeScript\n- **Routing**: Wouter (lightweight React router)\n- **State Management**: TanStack React Query for server state, local React state for UI\n- **Styling**: Tailwind CSS with shadcn/ui component library (New York style)\n- **Theme**: Dark/light mode support with cyber-security aesthetics\n- **Real-time Updates**: WebSocket connection for live evaluation progress\n\nThe frontend is organized around a dashboard-centric design with:\n- Main dashboard showing evaluation statistics and active assessments\n- **Guided Evaluation Wizard** for non-technical users with 8 infrastructure categories (Web Servers, Databases, Cloud Storage, Containers, Network, Identity, Email, Applications)\n- Evaluation table with filtering and sorting capabilities\n- Detail views for individual evaluation results including attack path visualization\n- Modal-based workflows for creating new evaluations and viewing progress\n- Risk Dashboard with interactive visualizations (attack graphs, heatmaps, gauges)\n- Reports page for generating executive, technical, and compliance reports\n- Batch Jobs page for parallel security assessments\n\n### Evaluation Wizard System\nThe platform includes a guided wizard (`client/src/components/EvaluationWizard.tsx`) for non-technical administrators:\n- **Templates** (`client/src/lib/evaluation-templates.ts`): 8 infrastructure categories with specific types, versions, and configuration questions\n- **Smart Priority Calculation**: Layered risk scoring considers internet exposure, data sensitivity, patch status, authentication methods, and risk factor combinations\n- **Auto-generated Descriptions**: Converts wizard answers into structured technical descriptions for AI analysis\n- **Dual Paths**: Dashboard offers both \"Guided Wizard\" (template-based) and \"Quick Evaluation\" (manual entry) options\n\n### Backend Architecture\n- **Framework**: Express.js with TypeScript\n- **Build Tool**: Vite for frontend, esbuild for server bundling\n- **API Design**: RESTful endpoints under `/api/` prefix\n- **Real-time**: WebSocket server on `/ws` path for progress events\n\nKey backend services:\n- **AEV Service** (`server/services/aev.ts`): Core AI analysis using OpenAI API to evaluate security exposures\n- **WebSocket Service** (`server/services/websocket.ts`): Broadcasts evaluation progress and completion events\n- **Storage Layer** (`server/storage.ts`): Database abstraction using Drizzle ORM\n- **Report Generator** (`server/services/report-generator.ts`): Generates executive, technical, and compliance reports\n- **Agent Orchestrator** (`server/services/agents/orchestrator.ts`): Coordinates AI agent workflow for evaluations with adversary profile support\n- **Defender Agent** (`server/services/agents/defender.ts`): AI agent for detecting attacks, recommending responses, and assessing control effectiveness\n- **AI Simulation Orchestrator** (`server/services/agents/ai-simulation.ts`): Runs AI vs AI simulations with iterative attack/defense cycles and purple team feedback\n- **mTLS Auth Service** (`server/services/mtls-auth.ts`): Certificate generation, validation, rotation, and revocation for agent authentication\n- **JWT Auth Service** (`server/services/jwt-auth.ts`): JWT token management with multi-tenant support and scope-based authorization\n- **Unified Auth Service** (`server/services/unified-auth.ts`): Unified authentication middleware supporting API keys, mTLS certificates, and JWT tokens\n\n### AI vs AI Simulation System\nThe platform includes an AI vs AI simulation capability for purple team exercises:\n- **Attacker AI**: Uses the orchestrator's multi-agent system (recon, exploit, lateral, business logic, multi-vector agents)\n- **Defender AI**: Detects attacks, recommends responses, assesses defensive control effectiveness\n- **Iterative Rounds**: Configurable number of attack/defense cycles\n- **Purple Team Feedback**: Generates actionable recommendations based on simulation results\n- **Frontend Page**: `/simulations` route with simulation creation, progress tracking, and result visualization\n\n### Data Storage\n- **Database**: PostgreSQL with Drizzle ORM\n- **Schema Location**: `shared/schema.ts` (shared between frontend and backend)\n- **Key Tables**:\n  - `users`: Basic user authentication\n  - `aev_evaluations`: Stores evaluation requests with asset info, exposure type, priority\n  - `aev_results`: Stores AI analysis results including exploitability scores, attack paths, recommendations\n  - `reports`: Stores generated reports (executive, technical, compliance)\n  - `batch_jobs`: Tracks batch evaluation jobs with progress and results\n  - `scheduled_scans`: Stores scheduled scan configurations\n  - `evaluation_history`: Tracks historical evaluation snapshots for drift detection\n  - `endpoint_agents`: Tracks deployed endpoint agents with hashed API keys and metadata\n  - `agent_telemetry`: Stores system info, metrics, and security findings from agents\n  - `agent_findings`: Individual security findings detected by agents with auto-evaluation triggers\n  - `ai_simulations`: Tracks AI vs AI simulation sessions with attacker/defender results\n  - `purple_team_findings`: Stores purple team findings and recommendations from simulations\n\n### Endpoint Agent System\nThe platform includes a live agent deployment system for real-time security monitoring:\n- **Agent Registration**: Agents register via `/api/agents/register` and receive a one-time API key (bcrypt hashed for storage)\n- **Telemetry Ingestion**: Agents send system data and security findings via `/api/agents/telemetry`\n- **Auto-evaluation Triggers**: Critical/high severity findings automatically create AEV evaluations\n- **Deduplication**: Findings are deduplicated using composite keys (findingType|title|affectedComponent)\n\n**Security Features**:\n- API keys hashed with bcrypt before storage (plaintext only shown once at registration)\n- Zod validation on all agent API endpoints\n- HTTPS enforcement with optional mTLS and SPKI pinning\n\n### Go Agent Deployment\nThe platform includes a production-ready Go agent (`odinforge-agent/`) with comprehensive deployment options:\n\n**Agent Features**:\n- Collects system telemetry (CPU, memory, disk, network)\n- Offline resilience using BoltDB queue for buffering\n- Batched HTTPS transmission with optional mTLS and SPKI pinning\n- Stable agent ID based on hostname+OS+arch hash\n\n**Self-Install CLI**:\n```bash\n# Auto-detect environment and install\nsudo ./odinforge-agent install --server-url https://server.com --api-key KEY\n\n# Check installation status\n./odinforge-agent status\n\n# Uninstall\nsudo ./odinforge-agent uninstall\n```\n\n**Deployment Options** (`odinforge-agent/deploy/`):\n- **Docker**: `docker-compose.yml` with volume mounts and environment configuration\n- **Kubernetes**: DaemonSet/Deployment manifests with ConfigMap, Secret, and PVC\n- **Linux systemd**: Service unit with security hardening (ProtectSystem, NoNewPrivileges, etc.)\n- **macOS launchd**: Plist template for daemon installation\n\n**Environment Detection**:\nThe installer auto-detects: Docker containers, Kubernetes pods, systemd (Linux), launchd (macOS), Windows services\n\n### AI Integration\n- **Provider**: OpenAI API (configurable via environment variables)\n- **Purpose**: Analyzes security exposures to determine exploitability, construct attack paths, assess impact, and generate remediation steps\n- **Configuration**: `AI_INTEGRATIONS_OPENAI_API_KEY` and `AI_INTEGRATIONS_OPENAI_BASE_URL` environment variables\n\n### Enhanced Reporting System\nThe platform includes a comprehensive reporting system with logic-based computations (not AI-templated):\n\n**Key Components**:\n- **Vulnerability Catalog** (`shared/vulnerability-catalog.ts`): Maps all 15 exposure types to detailed metadata including:\n  - Human-readable names and descriptions\n  - Business impact explanations\n  - MITRE ATT&CK technique mappings\n  - CWE IDs for standardized vulnerability classification\n  - Step-by-step remediation guidance with effort estimates, tools, and verification steps\n\n- **Kill Chain Visualization** (`server/services/kill-chain-graph.ts`):\n  - Maps attack paths to MITRE ATT&CK phases (Initial Access through Impact)\n  - Generates textual ASCII diagrams for text-based reports\n  - Produces PDF-exportable visual content using pdfmake\n  - Provides phase-by-phase analysis with techniques and recommendations\n\n- **Report Logic Engine** (`server/services/report-logic.ts`):\n  - Computes executive summaries from actual evaluation data (not AI-generated templates)\n  - Generates technical reports with vulnerability breakdowns by type and severity\n  - Creates remediation plans with prioritized actions, effort estimates, and verification steps\n  - Calculates compliance assessments with control gap analysis\n\n**API Endpoints**:\n- `GET /api/reports/enhanced/:evaluationId` - Enhanced report for single evaluation\n- `POST /api/reports/enhanced/date-range` - Enhanced report for date range with aggregated analysis\n\n**Report Features**:\n- Vulnerability breakdown with human-readable names and CWE references\n- Kill chain diagrams showing attack progression through MITRE phases\n- Prioritized remediation guidance with step-by-step instructions\n- Effort estimates (low/medium/high) and required tools/skills\n- Compensating controls for when immediate remediation isn't possible\n\n### Design System\nThe platform follows custom design guidelines (`design_guidelines.md`) combining Material Design component structure with cyber-security aesthetics:\n- Typography: Inter for UI, JetBrains Mono for technical data\n- Color scheme: Dark-first with cyan/blue accent gradients for security branding\n- Data-dense layouts optimized for security professionals\n\n## External Dependencies\n\n### Database\n- **PostgreSQL**: Primary data store (requires `DATABASE_URL` environment variable)\n- **Drizzle ORM**: Type-safe database queries and migrations\n- **connect-pg-simple**: PostgreSQL session store\n\n### AI Services\n- **OpenAI API**: Powers the AEV analysis engine for exploit validation\n  - Requires `AI_INTEGRATIONS_OPENAI_API_KEY`\n  - Optional `AI_INTEGRATIONS_OPENAI_BASE_URL` for custom endpoints\n\n### Frontend Libraries\n- **shadcn/ui**: Pre-built accessible React components (Radix UI primitives)\n- **TanStack React Query**: Data fetching and caching\n- **Lucide React**: Icon library\n- **date-fns**: Date formatting utilities\n\n### Development Tools\n- **Vite**: Frontend development server and build tool\n- **tsx**: TypeScript execution for development\n- **Drizzle Kit**: Database migration tooling\n\n### Real-time Communication\n- **ws**: WebSocket library for server-side real-time communication\n- Native WebSocket API on client for receiving evaluation progress updates\n\n## Production Hardening\n\n### Rate Limiting\n- Sliding window algorithm with per-endpoint configurations\n- Default limits: Auth (10 req/15min), API (100 req/min), Agent telemetry (1000 req/min)\n- Strict limits for heavy operations: Simulations (3 req/5min), Reports (5 req/min)\n- Response headers: X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset, Retry-After\n\n### Database Optimization\n- 37 performance indexes created at startup (server/db-indexes.ts)\n- Covers: evaluations, results, agents, findings, telemetry, reports, simulations, authorization logs\n- Indexes created via pg client during application startup\n\n### WebSocket Scaling\n- Connection limits: 1000 global, 50 per IP\n- Heartbeat monitoring: 30s ping interval, 60s timeout\n- Automatic cleanup of stale connections\n- Message queuing: 100 messages max per client\n\n### Production Environment Variables\n- `NODE_ENV=production` - Enables production mode\n- `WS_REQUIRE_AUTH=true` - Enables JWT authentication for WebSocket connections (enabled by default in production; set to \"false\" only for demo/testing)\n- `SESSION_SECRET` - Required for JWT signing (minimum 32 characters recommended)\n\n### Load Testing\n- Load test script at `scripts/load-test.ts`\n- Usage: `npx tsx scripts/load-test.ts [concurrency] [requestsPerEndpoint]`\n- Example: `npx tsx scripts/load-test.ts 10 100` (10 concurrent, 100 requests each)\n- Metrics: latency percentiles (P50/P95/P99), throughput, rate limit detection","path":null,"size_bytes":12955,"size_tokens":null},"attached_assets/aev_(1)_1765772491189.ts":{"content":"import { Hono } from \"hono\";\nimport { z } from \"zod\";\nimport { aevService, ExposureInput } from \"../services/aev\";\nimport { logger } from \"../logger\";\nimport { AuthContext } from \"../middleware/auth\";\nimport { createAuditLog, getClientInfo } from \"../services/audit\";\n\nconst aevRouter = new Hono<{ Variables: { auth: AuthContext } }>();\n\nconst EvaluateSchema = z.object({\n  assetId: z.string().min(1, \"Asset ID is required\"),\n  exposureType: z.enum([\"cve\", \"misconfiguration\", \"behavior\", \"network\", \"custom\"]),\n  description: z.string().min(1, \"Description is required\"),\n  data: z.record(z.string(), z.any()).default({}),\n  module: z.enum([\"posture\", \"spear\", \"sentinel\", \"vulnmgmt\"]).optional(),\n  priority: z.enum([\"low\", \"medium\", \"high\", \"critical\"]).optional().default(\"medium\"),\n  evaluationId: z.string().optional(),\n});\n\naevRouter.post(\"/evaluate\", async (c) => {\n  const auth = c.get(\"auth\") as AuthContext;\n  const clientInfo = getClientInfo(c);\n\n  try {\n    const body = await c.req.json();\n    const parsed = EvaluateSchema.safeParse(body);\n\n    if (!parsed.success) {\n      return c.json(\n        { error: \"Validation failed\", details: parsed.error.flatten() },\n        400\n      );\n    }\n\n    const input: ExposureInput = {\n      ...parsed.data,\n      organizationId: auth.organizationId,\n    };\n\n    logger.info({\n      assetId: input.assetId,\n      exposureType: input.exposureType,\n      module: input.module,\n      organizationId: auth.organizationId,\n      userId: auth.userId,\n    }, \"Starting AEV evaluation\");\n\n    const evaluationId = aevService.startEvaluation(input, parsed.data.evaluationId);\n\n    aevService.evaluate(input, evaluationId).then(async (result) => {\n      await createAuditLog({\n        organizationId: auth.organizationId,\n        eventType: \"security.aev\",\n        action: \"evaluate\",\n        actor: auth.userId || \"system\",\n        resource: \"aev_evaluation\",\n        resourceId: result.evaluationId,\n        details: { \n          assetId: input.assetId, \n          exposureType: input.exposureType,\n          module: input.module,\n          priority: input.priority,\n        },\n        status: \"success\",\n        ...clientInfo,\n      });\n    }).catch(async (error) => {\n      await createAuditLog({\n        organizationId: auth.organizationId,\n        eventType: \"security.aev\",\n        action: \"evaluate\",\n        actor: auth.userId || \"system\",\n        resource: \"aev_evaluation\",\n        resourceId: evaluationId,\n        status: \"failure\",\n        errorMessage: error instanceof Error ? error.message : \"Unknown error\",\n        ...clientInfo,\n      });\n      logger.error({ error: error instanceof Error ? error.message : \"Unknown error\" }, \"AEV evaluation failed\");\n    });\n\n    return c.json({ \n      evaluationId,\n      status: \"started\",\n      message: \"Evaluation started. Subscribe to WebSocket for real-time progress.\",\n    });\n  } catch (error) {\n    await createAuditLog({\n      organizationId: auth.organizationId,\n      eventType: \"security.aev\",\n      action: \"evaluate\",\n      actor: auth.userId || \"system\",\n      resource: \"aev_evaluation\",\n      status: \"failure\",\n      errorMessage: error instanceof Error ? error.message : \"Unknown error\",\n      ...clientInfo,\n    });\n    \n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n    logger.error({ error: errorMessage }, \"AEV evaluation request failed\");\n    return c.json({ error: \"Evaluation failed\", details: errorMessage }, 500);\n  }\n});\n\naevRouter.get(\"/evaluations\", async (c) => {\n  const auth = c.get(\"auth\") as AuthContext;\n\n  try {\n    const evaluations = aevService.getEvaluationsByOrganization(auth.organizationId);\n\n    return c.json({\n      evaluations: evaluations.map((e) => ({\n        id: e.id,\n        assetId: e.input.assetId,\n        exposureType: e.input.exposureType,\n        module: e.input.module,\n        priority: e.input.priority,\n        status: e.status,\n        result: e.result\n          ? {\n              exploitable: e.result.exploitable,\n              confidence: e.result.confidence,\n              score: e.result.score,\n              status: e.result.status,\n            }\n          : null,\n        createdAt: e.createdAt.toISOString(),\n        updatedAt: e.updatedAt.toISOString(),\n      })),\n      total: evaluations.length,\n    });\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n    logger.error({ error: errorMessage }, \"Failed to fetch evaluations\");\n    return c.json({ error: \"Failed to fetch evaluations\" }, 500);\n  }\n});\n\naevRouter.get(\"/evaluations/:id\", async (c) => {\n  const auth = c.get(\"auth\") as AuthContext;\n  const evaluationId = c.req.param(\"id\");\n\n  try {\n    const evaluation = aevService.getEvaluation(evaluationId);\n\n    if (!evaluation) {\n      return c.json({ error: \"Evaluation not found\" }, 404);\n    }\n\n    if (evaluation.input.organizationId !== auth.organizationId) {\n      return c.json({ error: \"Access denied\" }, 403);\n    }\n\n    return c.json({\n      id: evaluation.id,\n      input: {\n        assetId: evaluation.input.assetId,\n        exposureType: evaluation.input.exposureType,\n        description: evaluation.input.description,\n        module: evaluation.input.module,\n        priority: evaluation.input.priority,\n      },\n      status: evaluation.status,\n      result: evaluation.result,\n      createdAt: evaluation.createdAt.toISOString(),\n      updatedAt: evaluation.updatedAt.toISOString(),\n    });\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n    logger.error({ error: errorMessage, evaluationId }, \"Failed to fetch evaluation\");\n    return c.json({ error: \"Failed to fetch evaluation\" }, 500);\n  }\n});\n\naevRouter.get(\"/stats\", async (c) => {\n  const stats = aevService.getStats();\n  return c.json(stats);\n});\n\naevRouter.get(\"/results\", async (c) => {\n  const auth = c.get(\"auth\") as AuthContext;\n\n  try {\n    const { \n      exploitable, \n      status, \n      taskId,\n      limit = \"50\",\n      offset = \"0\",\n    } = c.req.query();\n\n    const filters: { taskId?: string; exploitable?: boolean; status?: string } = {};\n    if (taskId) filters.taskId = taskId;\n    if (exploitable !== undefined) filters.exploitable = exploitable === \"true\";\n    if (status) filters.status = status;\n\n    const result = await aevService.getPersistedResults(\n      auth.organizationId,\n      filters,\n      { limit: parseInt(limit), offset: parseInt(offset) }\n    );\n\n    return c.json(result);\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n    logger.error({ error: errorMessage }, \"Failed to fetch persisted AEV results\");\n    return c.json({ error: \"Failed to fetch AEV results\" }, 500);\n  }\n});\n\naevRouter.get(\"/results/:evaluationId\", async (c) => {\n  const auth = c.get(\"auth\") as AuthContext;\n  const evaluationId = c.req.param(\"evaluationId\");\n\n  try {\n    const result = await aevService.getPersistedResultByEvaluationId(auth.organizationId, evaluationId);\n\n    if (!result) {\n      return c.json({ error: \"AEV result not found\" }, 404);\n    }\n\n    return c.json(result);\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n    logger.error({ error: errorMessage, evaluationId }, \"Failed to fetch persisted AEV result\");\n    return c.json({ error: \"Failed to fetch AEV result\" }, 500);\n  }\n});\n\naevRouter.post(\"/batch-evaluate\", async (c) => {\n  const auth = c.get(\"auth\") as AuthContext;\n  const clientInfo = getClientInfo(c);\n\n  try {\n    const body = await c.req.json();\n\n    if (!Array.isArray(body.exposures)) {\n      return c.json({ error: \"exposures must be an array\" }, 400);\n    }\n\n    if (body.exposures.length > 10) {\n      return c.json({ error: \"Maximum 10 exposures per batch\" }, 400);\n    }\n\n    const evaluationIds: string[] = [];\n    const errors: { index: number; error: string }[] = [];\n\n    for (let i = 0; i < body.exposures.length; i++) {\n      const exposure = body.exposures[i];\n      const parsed = EvaluateSchema.safeParse(exposure);\n\n      if (!parsed.success) {\n        errors.push({ index: i, error: parsed.error.message });\n        continue;\n      }\n\n      const input: ExposureInput = {\n        ...parsed.data,\n        organizationId: auth.organizationId,\n      };\n\n      const evaluationId = aevService.startEvaluation(input, parsed.data.evaluationId);\n      \n      aevService.evaluate(input, evaluationId).then((result) => {\n        logger.info({ evaluationId: result.evaluationId }, \"Batch evaluation completed\");\n      });\n\n      evaluationIds.push(evaluationId);\n    }\n\n    await createAuditLog({\n      organizationId: auth.organizationId,\n      eventType: \"security.aev\",\n      action: \"evaluate\",\n      actor: auth.userId || \"system\",\n      resource: \"aev_batch_evaluation\",\n      details: { \n        batchSize: body.exposures.length,\n        successCount: evaluationIds.length,\n        errorCount: errors.length,\n      },\n      status: \"success\",\n      ...clientInfo,\n    });\n\n    return c.json({\n      message: \"Batch evaluation started\",\n      evaluations: evaluationIds.length,\n      errors: errors.length > 0 ? errors : undefined,\n    });\n  } catch (error) {\n    await createAuditLog({\n      organizationId: auth.organizationId,\n      eventType: \"security.aev\",\n      action: \"evaluate\",\n      actor: auth.userId || \"system\",\n      resource: \"aev_batch_evaluation\",\n      status: \"failure\",\n      errorMessage: error instanceof Error ? error.message : \"Unknown error\",\n      ...clientInfo,\n    });\n    \n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n    logger.error({ error: errorMessage }, \"Batch evaluation request failed\");\n    return c.json({ error: \"Batch evaluation failed\" }, 500);\n  }\n});\n\nexport { aevRouter };\n","path":null,"size_bytes":9836,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n  --opaque-button-border-intensity: -8;\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n  --background: 210 5% 98%;\n  --foreground: 210 6% 12%;\n  --border: 210 5% 92%;\n  --card: 210 5% 96%;\n  --card-foreground: 210 6% 12%;\n  --card-border: 210 5% 94%;\n  --sidebar: 210 5% 94%;\n  --sidebar-foreground: 210 6% 14%;\n  --sidebar-border: 210 5% 90%;\n  --sidebar-primary: 217 91% 50%;\n  --sidebar-primary-foreground: 0 0% 98%;\n  --sidebar-accent: 210 5% 88%;\n  --sidebar-accent-foreground: 210 6% 14%;\n  --sidebar-ring: 217 91% 50%;\n  --popover: 210 5% 90%;\n  --popover-foreground: 210 6% 12%;\n  --popover-border: 210 5% 86%;\n  --primary: 217 91% 32%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 210 5% 84%;\n  --secondary-foreground: 210 6% 14%;\n  --muted: 210 5% 86%;\n  --muted-foreground: 210 6% 28%;\n  --accent: 210 8% 88%;\n  --accent-foreground: 210 6% 14%;\n  --destructive: 0 84% 38%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 210 6% 32%;\n  --ring: 217 91% 50%;\n  --chart-1: 217 91% 32%;\n  --chart-2: 24 95% 42%;\n  --chart-3: 142 76% 32%;\n  --chart-4: 280 65% 38%;\n  --chart-5: 340 82% 42%;\n  --font-sans: Inter, system-ui, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: JetBrains Mono, monospace;\n  --radius: .5rem;\n  --shadow-2xs: 0px 2px 0px 0px hsl(210 6% 12% / 0.02);\n  --shadow-xs: 0px 2px 0px 0px hsl(210 6% 12% / 0.03);\n  --shadow-sm: 0px 2px 0px 0px hsl(210 6% 12% / 0.03), 0px 1px 2px -1px hsl(210 6% 12% / 0.05);\n  --shadow: 0px 2px 0px 0px hsl(210 6% 12% / 0.04), 0px 1px 2px -1px hsl(210 6% 12% / 0.06);\n  --shadow-md: 0px 2px 0px 0px hsl(210 6% 12% / 0.04), 0px 2px 4px -1px hsl(210 6% 12% / 0.08);\n  --shadow-lg: 0px 2px 0px 0px hsl(210 6% 12% / 0.05), 0px 4px 6px -1px hsl(210 6% 12% / 0.10);\n  --shadow-xl: 0px 2px 0px 0px hsl(210 6% 12% / 0.06), 0px 8px 10px -1px hsl(210 6% 12% / 0.12);\n  --shadow-2xl: 0px 2px 0px 0px hsl(210 6% 12% / 0.08);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 210 6% 8%;\n  --foreground: 210 5% 94%;\n  --border: 210 6% 18%;\n  --card: 210 6% 10%;\n  --card-foreground: 210 5% 94%;\n  --card-border: 210 6% 14%;\n  --sidebar: 210 6% 12%;\n  --sidebar-foreground: 210 5% 88%;\n  --sidebar-border: 210 6% 16%;\n  --sidebar-primary: 217 91% 60%;\n  --sidebar-primary-foreground: 210 6% 8%;\n  --sidebar-accent: 210 6% 18%;\n  --sidebar-accent-foreground: 210 5% 94%;\n  --sidebar-ring: 217 91% 60%;\n  --popover: 210 6% 14%;\n  --popover-foreground: 210 5% 94%;\n  --popover-border: 210 6% 20%;\n  --primary: 217 91% 32%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 210 6% 20%;\n  --secondary-foreground: 210 5% 94%;\n  --muted: 210 6% 16%;\n  --muted-foreground: 210 5% 68%;\n  --accent: 210 8% 18%;\n  --accent-foreground: 210 5% 94%;\n  --destructive: 0 84% 38%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 210 5% 72%;\n  --ring: 217 91% 60%;\n  --chart-1: 217 91% 65%;\n  --chart-2: 24 95% 62%;\n  --chart-3: 142 76% 58%;\n  --chart-4: 280 65% 65%;\n  --chart-5: 340 82% 62%;\n  --shadow-2xs: 0px 2px 0px 0px hsl(210 5% 94% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(210 5% 94% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(210 5% 94% / 0.00), 0px 1px 2px -1px hsl(210 5% 94% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(210 5% 94% / 0.00), 0px 1px 2px -1px hsl(210 5% 94% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(210 5% 94% / 0.00), 0px 2px 4px -1px hsl(210 5% 94% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(210 5% 94% / 0.00), 0px 4px 6px -1px hsl(210 5% 94% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(210 5% 94% / 0.00), 0px 8px 10px -1px hsl(210 5% 94% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(210 5% 94% / 0.00);\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}\n","path":null,"size_bytes":10711,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"server/services/agents/synthesizer.ts":{"content":"import OpenAI from \"openai\";\nimport type { AgentMemory } from \"./types\";\nimport type { AttackPathStep, Recommendation } from \"@shared/schema\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\ninterface SynthesisResult {\n  exploitable: boolean;\n  confidence: number;\n  score: number;\n  attackPath: AttackPathStep[];\n  impact: string;\n  recommendations: Recommendation[];\n}\n\nexport async function synthesizeResults(memory: AgentMemory): Promise<SynthesisResult> {\n  const allFindings = `\n=== RECON AGENT FINDINGS ===\nAttack Surface: ${memory.recon?.attackSurface.join(\", \") || \"None\"}\nEntry Points: ${memory.recon?.entryPoints.join(\", \") || \"None\"}\nAPI Endpoints: ${memory.recon?.apiEndpoints.join(\", \") || \"None\"}\nAuth Mechanisms: ${memory.recon?.authMechanisms.join(\", \") || \"None\"}\nTechnologies: ${memory.recon?.technologies.join(\", \") || \"None\"}\nPotential Vulnerabilities: ${memory.recon?.potentialVulnerabilities.join(\", \") || \"None\"}\n\n=== EXPLOIT AGENT FINDINGS ===\nExploitable: ${memory.exploit?.exploitable || false}\nExploit Chains: ${memory.exploit?.exploitChains.map((c) => `${c.name} (${c.technique}, ${c.success_likelihood})`).join(\"; \") || \"None\"}\nCVE References: ${memory.exploit?.cveReferences.join(\", \") || \"None\"}\nMisconfigurations: ${memory.exploit?.misconfigurations.join(\", \") || \"None\"}\n\n=== LATERAL MOVEMENT AGENT FINDINGS ===\nPivot Paths: ${memory.lateral?.pivotPaths.map((p) => `${p.from} -> ${p.to} via ${p.method}`).join(\"; \") || \"None\"}\nPrivilege Escalation: ${memory.lateral?.privilegeEscalation.map((e) => `${e.target} (${e.likelihood})`).join(\"; \") || \"None\"}\nToken Reuse: ${memory.lateral?.tokenReuse.join(\", \") || \"None\"}\n\n=== BUSINESS LOGIC AGENT FINDINGS ===\nWorkflow Abuse: ${memory.businessLogic?.workflowAbuse.join(\", \") || \"None\"}\nState Manipulation: ${memory.businessLogic?.stateManipulation.join(\", \") || \"None\"}\nRace Conditions: ${memory.businessLogic?.raceConditions.join(\", \") || \"None\"}\nAuthorization Bypass: ${memory.businessLogic?.authorizationBypass.join(\", \") || \"None\"}\nCritical Flows: ${memory.businessLogic?.criticalFlows.join(\", \") || \"None\"}\n\n=== IMPACT AGENT FINDINGS ===\nData Exposure: ${memory.impact?.dataExposure.types.join(\", \") || \"None\"} (Severity: ${memory.impact?.dataExposure.severity || \"Unknown\"}, Records: ${memory.impact?.dataExposure.estimatedRecords || \"Unknown\"})\nFinancial Impact: ${memory.impact?.financialImpact.estimate || \"Unknown\"} - Factors: ${memory.impact?.financialImpact.factors.join(\", \") || \"None\"}\nCompliance Impact: ${memory.impact?.complianceImpact.join(\", \") || \"None\"}\nReputational Risk: ${memory.impact?.reputationalRisk || \"Unknown\"}\n`;\n\n  const systemPrompt = `You are the SYNTHESIS ENGINE for OdinForge AI, a multi-agent security validation platform.\n\nYour mission is to synthesize findings from 5 specialized AI agents into a cohesive security assessment:\n1. Combine all agent findings into a unified attack path\n2. Calculate overall exploitability confidence and score\n3. Generate prioritized remediation recommendations\n4. Provide executive-level impact summary\n\nCreate a comprehensive, actionable report that security teams can use immediately.`;\n\n  const userPrompt = `Synthesize these multi-agent findings into a final assessment:\n\nTarget: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nPriority: ${memory.context.priority}\nDescription: ${memory.context.description}\n\n${allFindings}\n\nProvide your synthesis as a JSON object with this structure:\n{\n  \"exploitable\": boolean (true if the target is exploitable based on all agent findings),\n  \"confidence\": number (0-100, confidence in the overall assessment),\n  \"score\": number (0-100, overall exploitability severity score),\n  \"attackPath\": [\n    {\n      \"id\": number (sequential step number),\n      \"title\": string (brief title for this attack step),\n      \"description\": string (detailed description of this attack step),\n      \"technique\": string (MITRE ATT&CK technique ID, e.g., \"T1190\"),\n      \"severity\": \"critical\" | \"high\" | \"medium\" | \"low\",\n      \"discoveredBy\": \"recon\" | \"exploit\" | \"lateral\" | \"business-logic\" | \"impact\" (which agent discovered this step)\n    }\n  ],\n  \"impact\": string (comprehensive impact summary based on Impact Agent findings),\n  \"recommendations\": [\n    {\n      \"id\": string (unique ID like \"rec-1\"),\n      \"title\": string (brief title),\n      \"description\": string (detailed remediation steps),\n      \"priority\": \"critical\" | \"high\" | \"medium\" | \"low\",\n      \"type\": \"remediation\" | \"compensating\" | \"preventive\"\n    }\n  ]\n}`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 4096,\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response from Synthesizer\");\n    }\n\n    const result = JSON.parse(content) as SynthesisResult;\n\n    return {\n      exploitable: Boolean(result.exploitable),\n      confidence: Math.min(100, Math.max(0, Number(result.confidence) || 50)),\n      score: Math.min(100, Math.max(0, Number(result.score) || 50)),\n      attackPath: Array.isArray(result.attackPath)\n        ? result.attackPath.map((step, index) => ({\n            id: step.id || index + 1,\n            title: String(step.title || \"Attack Step\"),\n            description: String(step.description || \"\"),\n            technique: step.technique ? String(step.technique) : undefined,\n            severity: validateSeverity(step.severity),\n            discoveredBy: validateAgentName(step.discoveredBy),\n          }))\n        : [],\n      impact: String(result.impact || \"Impact assessment pending\"),\n      recommendations: Array.isArray(result.recommendations)\n        ? result.recommendations.map((rec, index) => ({\n            id: String(rec.id || `rec-${index + 1}`),\n            title: String(rec.title || \"Recommendation\"),\n            description: String(rec.description || \"\"),\n            priority: validateSeverity(rec.priority),\n            type: validateRecType(rec.type),\n          }))\n        : [],\n    };\n  } catch (error) {\n    console.error(\"Synthesizer error:\", error);\n    throw error;\n  }\n}\n\nfunction validateSeverity(severity: unknown): \"critical\" | \"high\" | \"medium\" | \"low\" {\n  const valid = [\"critical\", \"high\", \"medium\", \"low\"];\n  return valid.includes(String(severity)) ? (severity as \"critical\" | \"high\" | \"medium\" | \"low\") : \"medium\";\n}\n\nfunction validateRecType(type: unknown): \"remediation\" | \"compensating\" | \"preventive\" {\n  const valid = [\"remediation\", \"compensating\", \"preventive\"];\n  return valid.includes(String(type)) ? (type as \"remediation\" | \"compensating\" | \"preventive\") : \"remediation\";\n}\n\nfunction validateAgentName(name: unknown): \"recon\" | \"exploit\" | \"lateral\" | \"business-logic\" | \"impact\" | undefined {\n  const valid = [\"recon\", \"exploit\", \"lateral\", \"business-logic\", \"impact\"];\n  return valid.includes(String(name)) ? (name as \"recon\" | \"exploit\" | \"lateral\" | \"business-logic\" | \"impact\") : undefined;\n}\n","path":null,"size_bytes":7250,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"server/services/agents/recon.ts":{"content":"import OpenAI from \"openai\";\nimport type { AgentMemory, AgentResult, ReconFindings } from \"./types\";\nimport { generateAdversaryPromptContext } from \"./adversary-profile\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\ntype ProgressCallback = (stage: string, progress: number, message: string) => void;\n\nexport async function runReconAgent(\n  memory: AgentMemory,\n  onProgress?: ProgressCallback\n): Promise<AgentResult<ReconFindings>> {\n  const startTime = Date.now();\n  \n  onProgress?.(\"recon\", 10, \"Mapping attack surface...\");\n\n  const adversaryContext = memory.context.adversaryProfile \n    ? generateAdversaryPromptContext(memory.context.adversaryProfile)\n    : \"\";\n\n  const systemPrompt = `You are the RECON AGENT, a specialized AI security reconnaissance system for OdinForge AI.\n\nYour mission is to perform comprehensive reconnaissance on the target asset to identify:\n1. Attack surface - all potential entry points and exposed interfaces\n2. Entry points - specific URLs, endpoints, ports that could be exploited\n3. API endpoints - REST, GraphQL, WebSocket, and other API interfaces\n4. Authentication mechanisms - OAuth, JWT, session-based, API keys\n5. Technologies - frameworks, libraries, infrastructure components\n6. Potential vulnerabilities - based on reconnaissance findings\n\nThink like a penetration tester performing initial reconnaissance. Be thorough but realistic.\n${adversaryContext}`;\n\n  const userPrompt = `Perform reconnaissance analysis on this security exposure:\n\nAsset ID: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nPriority: ${memory.context.priority}\nDescription: ${memory.context.description}\n\nProvide your reconnaissance findings as a JSON object with this structure:\n{\n  \"attackSurface\": [\"list of attack surface elements discovered\"],\n  \"entryPoints\": [\"list of potential entry points\"],\n  \"apiEndpoints\": [\"list of API endpoints or interfaces found\"],\n  \"authMechanisms\": [\"list of authentication mechanisms identified\"],\n  \"technologies\": [\"list of technologies/frameworks detected\"],\n  \"potentialVulnerabilities\": [\"list of potential vulnerabilities based on recon\"]\n}`;\n\n  try {\n    onProgress?.(\"recon\", 15, \"Analyzing attack vectors...\");\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 2048,\n    });\n\n    onProgress?.(\"recon\", 20, \"Processing reconnaissance data...\");\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response from Recon Agent\");\n    }\n\n    const findings = JSON.parse(content) as ReconFindings;\n    \n    const validatedFindings: ReconFindings = {\n      attackSurface: Array.isArray(findings.attackSurface) ? findings.attackSurface : [],\n      entryPoints: Array.isArray(findings.entryPoints) ? findings.entryPoints : [],\n      apiEndpoints: Array.isArray(findings.apiEndpoints) ? findings.apiEndpoints : [],\n      authMechanisms: Array.isArray(findings.authMechanisms) ? findings.authMechanisms : [],\n      technologies: Array.isArray(findings.technologies) ? findings.technologies : [],\n      potentialVulnerabilities: Array.isArray(findings.potentialVulnerabilities) ? findings.potentialVulnerabilities : [],\n    };\n\n    return {\n      success: true,\n      findings: validatedFindings,\n      agentName: \"Recon Agent\",\n      processingTime: Date.now() - startTime,\n    };\n  } catch (error) {\n    console.error(\"Recon Agent error:\", error);\n    throw error;\n  }\n}\n","path":null,"size_bytes":3741,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"attached_assets/use-websocket_1765772491190.ts":{"content":"import { useEffect, useRef, useState, useCallback } from \"react\";\n\nexport interface WSMessage {\n  type: \n    | \"alert\" \n    | \"threat\" \n    | \"aev_progress\" \n    | \"aev_complete\"\n    | \"endpoint_status\"\n    | \"audit_event\"\n    | \"system_status\"\n    | \"user_event\"\n    | \"apikey_event\"\n    | \"error\"\n    | \"ping\"\n    | \"pong\"\n    | \"subscribed\"\n    | \"unsubscribed\";\n  data: any;\n  organizationId?: string;\n  timestamp: number;\n}\n\nexport type ConnectionState = \"connecting\" | \"connected\" | \"disconnected\" | \"error\";\n\ninterface UseWebSocketOptions {\n  token: string | null;\n  onMessage?: (message: WSMessage) => void;\n  onConnect?: () => void;\n  onDisconnect?: () => void;\n  onError?: (error: Event) => void;\n  autoReconnect?: boolean;\n  reconnectInterval?: number;\n  maxReconnectAttempts?: number;\n}\n\ninterface UseWebSocketReturn {\n  connectionState: ConnectionState;\n  lastMessage: WSMessage | null;\n  subscribe: (channel: string) => void;\n  unsubscribe: (channel: string) => void;\n  sendPing: () => void;\n}\n\nexport function useWebSocket({\n  token,\n  onMessage,\n  onConnect,\n  onDisconnect,\n  onError,\n  autoReconnect = true,\n  reconnectInterval = 3000,\n  maxReconnectAttempts = 5,\n}: UseWebSocketOptions): UseWebSocketReturn {\n  const [connectionState, setConnectionState] = useState<ConnectionState>(\"disconnected\");\n  const [lastMessage, setLastMessage] = useState<WSMessage | null>(null);\n  \n  const wsRef = useRef<WebSocket | null>(null);\n  const reconnectAttempts = useRef(0);\n  const reconnectTimeout = useRef<NodeJS.Timeout | null>(null);\n  const subscribedChannels = useRef<Set<string>>(new Set());\n\n  const connect = useCallback(() => {\n    if (!token) {\n      setConnectionState(\"disconnected\");\n      return;\n    }\n\n    // Don't connect if already connecting or connected\n    if (wsRef.current && wsRef.current.readyState === WebSocket.CONNECTING) {\n      return;\n    }\n    if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {\n      return;\n    }\n\n    // Build WebSocket URL\n    const protocol = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n    const wsUrl = `${protocol}//${window.location.host}/ws?token=${encodeURIComponent(token)}`;\n\n    setConnectionState(\"connecting\");\n\n    try {\n      const ws = new WebSocket(wsUrl);\n      wsRef.current = ws;\n\n      const handleOpen = () => {\n        setConnectionState(\"connected\");\n        reconnectAttempts.current = 0;\n        onConnect?.();\n\n        // Resubscribe to previously subscribed channels\n        subscribedChannels.current.forEach((channel) => {\n          ws.send(JSON.stringify({ type: \"subscribe\", channel }));\n        });\n      };\n\n      const handleMessage = (event: MessageEvent) => {\n        try {\n          const message: WSMessage = JSON.parse(event.data);\n          setLastMessage(message);\n          onMessage?.(message);\n        } catch (error) {\n          console.error(\"Failed to parse WebSocket message:\", error);\n        }\n      };\n\n      const handleClose = () => {\n        // Remove event listeners to prevent memory leaks\n        ws.removeEventListener(\"open\", handleOpen);\n        ws.removeEventListener(\"message\", handleMessage);\n        ws.removeEventListener(\"close\", handleClose);\n        ws.removeEventListener(\"error\", handleError);\n        \n        setConnectionState(\"disconnected\");\n        wsRef.current = null;\n        onDisconnect?.();\n\n        // Auto-reconnect logic with exponential backoff\n        if (autoReconnect && reconnectAttempts.current < maxReconnectAttempts) {\n          reconnectAttempts.current++;\n          const delay = reconnectInterval * Math.pow(2, reconnectAttempts.current - 1);\n          reconnectTimeout.current = setTimeout(() => {\n            connect();\n          }, Math.min(delay, 30000)); // Cap at 30 seconds\n        }\n      };\n\n      const handleError = (error: Event) => {\n        setConnectionState(\"error\");\n        onError?.(error);\n      };\n\n      ws.addEventListener(\"open\", handleOpen);\n      ws.addEventListener(\"message\", handleMessage);\n      ws.addEventListener(\"close\", handleClose);\n      ws.addEventListener(\"error\", handleError);\n    } catch (error) {\n      setConnectionState(\"error\");\n      console.error(\"Failed to create WebSocket connection:\", error);\n    }\n  }, [token, onMessage, onConnect, onDisconnect, onError, autoReconnect, reconnectInterval, maxReconnectAttempts]);\n\n  const disconnect = useCallback(() => {\n    if (reconnectTimeout.current) {\n      clearTimeout(reconnectTimeout.current);\n      reconnectTimeout.current = null;\n    }\n    if (wsRef.current) {\n      wsRef.current.close();\n      wsRef.current = null;\n    }\n  }, []);\n\n  const subscribe = useCallback((channel: string) => {\n    subscribedChannels.current.add(channel);\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\n      wsRef.current.send(JSON.stringify({ type: \"subscribe\", channel }));\n    }\n  }, []);\n\n  const unsubscribe = useCallback((channel: string) => {\n    subscribedChannels.current.delete(channel);\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\n      wsRef.current.send(JSON.stringify({ type: \"unsubscribe\", channel }));\n    }\n  }, []);\n\n  const sendPing = useCallback(() => {\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\n      wsRef.current.send(JSON.stringify({ type: \"ping\" }));\n    }\n  }, []);\n\n  // Connect when token changes\n  useEffect(() => {\n    if (token) {\n      connect();\n    } else {\n      disconnect();\n    }\n\n    return () => {\n      disconnect();\n    };\n  }, [token, connect, disconnect]);\n\n  return {\n    connectionState,\n    lastMessage,\n    subscribe,\n    unsubscribe,\n    sendPing,\n  };\n}\n\n// Specialized hooks for specific event types\n\nexport function useAlerts(token: string | null) {\n  const [alerts, setAlerts] = useState<WSMessage[]>([]);\n  \n  const handleMessage = useCallback((message: WSMessage) => {\n    if (message.type === \"alert\") {\n      setAlerts((prev) => [message, ...prev].slice(0, 100)); // Keep last 100 alerts\n    }\n  }, []);\n\n  const { connectionState, subscribe, unsubscribe } = useWebSocket({\n    token,\n    onMessage: handleMessage,\n    onConnect: () => subscribe(\"alerts\"),\n  });\n\n  return { alerts, connectionState, clearAlerts: () => setAlerts([]) };\n}\n\nexport function useThreats(token: string | null) {\n  const [threats, setThreats] = useState<WSMessage[]>([]);\n  \n  const handleMessage = useCallback((message: WSMessage) => {\n    if (message.type === \"threat\") {\n      setThreats((prev) => [message, ...prev].slice(0, 100));\n    }\n  }, []);\n\n  const { connectionState, subscribe, unsubscribe } = useWebSocket({\n    token,\n    onMessage: handleMessage,\n    onConnect: () => subscribe(\"threats\"),\n  });\n\n  return { threats, connectionState, clearThreats: () => setThreats([]), unsubscribe };\n}\n\nexport function useAEVProgress(token: string | null) {\n  const [evaluations, setEvaluations] = useState<Map<string, WSMessage>>(new Map());\n  \n  const handleMessage = useCallback((message: WSMessage) => {\n    if (message.type === \"aev_progress\" || message.type === \"aev_complete\") {\n      setEvaluations((prev) => {\n        const next = new Map(prev);\n        next.set(message.data.evaluationId, message);\n        return next;\n      });\n    }\n  }, []);\n\n  const { connectionState, subscribe } = useWebSocket({\n    token,\n    onMessage: handleMessage,\n    onConnect: () => subscribe(\"aev\"),\n  });\n\n  return { \n    evaluations: Array.from(evaluations.values()), \n    connectionState,\n    clearEvaluations: () => setEvaluations(new Map()),\n  };\n}\n\nexport function useSystemStatus(token: string | null) {\n  const [status, setStatus] = useState<WSMessage | null>(null);\n  \n  const handleMessage = useCallback((message: WSMessage) => {\n    if (message.type === \"system_status\") {\n      setStatus(message);\n    }\n  }, []);\n\n  const { connectionState } = useWebSocket({\n    token,\n    onMessage: handleMessage,\n  });\n\n  return { status, connectionState };\n}\n","path":null,"size_bytes":7890,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"server/services/agents/types.ts":{"content":"import type { AttackPathStep, Recommendation, AttackGraph, BusinessLogicFinding, MultiVectorFinding, WorkflowStateMachine, BusinessLogicCategory, CloudVectorType, EvidenceArtifact, IntelligentScore, RemediationGuidance, AdversaryProfile } from \"@shared/schema\";\n\nexport interface AgentContext {\n  assetId: string;\n  exposureType: string;\n  priority: string;\n  description: string;\n  evaluationId: string;\n  adversaryProfile?: AdversaryProfile;\n}\n\nexport interface ReconFindings {\n  attackSurface: string[];\n  entryPoints: string[];\n  apiEndpoints: string[];\n  authMechanisms: string[];\n  technologies: string[];\n  potentialVulnerabilities: string[];\n}\n\nexport interface ExploitFindings {\n  exploitable: boolean;\n  exploitChains: Array<{\n    name: string;\n    technique: string;\n    description: string;\n    success_likelihood: \"high\" | \"medium\" | \"low\";\n  }>;\n  cveReferences: string[];\n  misconfigurations: string[];\n}\n\nexport interface LateralShadowAdminIndicator {\n  principal: string;\n  platform: string;\n  indicatorType: \"excessive_permissions\" | \"dormant_admin\" | \"service_account_abuse\" | \"delegated_admin\" | \"hidden_role\";\n  evidence: string[];\n  riskLevel: \"critical\" | \"high\" | \"medium\" | \"low\";\n}\n\nexport interface LateralFindings {\n  pivotPaths: Array<{\n    from: string;\n    to: string;\n    method: string;\n    technique: string;\n  }>;\n  privilegeEscalation: Array<{\n    target: string;\n    method: string;\n    likelihood: \"high\" | \"medium\" | \"low\";\n  }>;\n  tokenReuse: string[];\n  shadowAdminIndicators?: LateralShadowAdminIndicator[];\n}\n\nexport interface BusinessLogicFindings {\n  workflowAbuse: string[];\n  stateManipulation: string[];\n  raceConditions: string[];\n  authorizationBypass: string[];\n  criticalFlows: string[];\n}\n\nexport interface EnhancedBusinessLogicFindings {\n  basicFindings: BusinessLogicFindings;\n  detailedFindings: BusinessLogicFinding[];\n  workflowAnalysis: WorkflowStateMachine | null;\n  paymentFlowVulnerabilities: PaymentFlowVulnerability[];\n  stateTransitionViolations: StateTransitionViolation[];\n  inferredWorkflows: InferredWorkflow[];\n}\n\nexport interface PaymentFlowVulnerability {\n  id: string;\n  category: \"payment_bypass\" | \"subscription_abuse\" | \"order_manipulation\" | \"price_tampering\" | \"coupon_abuse\";\n  title: string;\n  description: string;\n  severity: \"critical\" | \"high\" | \"medium\" | \"low\";\n  affectedFlow: string[];\n  exploitSteps: string[];\n  financialImpact: string;\n  validatedExploit: boolean;\n}\n\nexport interface StateTransitionViolation {\n  id: string;\n  fromState: string;\n  toState: string;\n  expectedTransitions: string[];\n  actualTransition: string;\n  violationType: \"skip\" | \"reverse\" | \"unauthorized\" | \"race_condition\";\n  severity: \"critical\" | \"high\" | \"medium\" | \"low\";\n  exploitability: string;\n}\n\nexport interface InferredWorkflow {\n  name: string;\n  description: string;\n  steps: string[];\n  securityCheckpoints: string[];\n  potentialBypasses: string[];\n}\n\nexport interface MultiVectorFindings {\n  findings: MultiVectorFinding[];\n  cloudFindings: CloudFinding[];\n  iamFindings: IAMFinding[];\n  saasFindings: SaaSFinding[];\n  shadowAdminIndicators: ShadowAdminIndicator[];\n  chainedAttackPaths: ChainedAttackPath[];\n}\n\nexport interface CloudFinding {\n  id: string;\n  vectorType: CloudVectorType;\n  provider: \"aws\" | \"gcp\" | \"azure\" | \"multi-cloud\";\n  service: string;\n  resource: string;\n  title: string;\n  description: string;\n  severity: \"critical\" | \"high\" | \"medium\" | \"low\";\n  exploitPath: string[];\n  remediationSteps: string[];\n}\n\nexport interface IAMFinding {\n  id: string;\n  principal: string;\n  assumableRoles: string[];\n  effectivePermissions: string[];\n  privilegeEscalationPath: string | null;\n  severity: \"critical\" | \"high\" | \"medium\" | \"low\";\n  title: string;\n  description: string;\n}\n\nexport interface SaaSFinding {\n  id: string;\n  platform: string;\n  permissionLevel: string;\n  title: string;\n  description: string;\n  severity: \"critical\" | \"high\" | \"medium\" | \"low\";\n  shadowAdminIndicators: string[];\n  exploitPath: string[];\n}\n\nexport interface ShadowAdminIndicator {\n  id: string;\n  principal: string;\n  platform: string;\n  indicatorType: \"excessive_permissions\" | \"dormant_admin\" | \"service_account_abuse\" | \"delegated_admin\" | \"hidden_role\";\n  evidence: string[];\n  riskLevel: \"critical\" | \"high\" | \"medium\" | \"low\";\n}\n\nexport interface ChainedAttackPath {\n  id: string;\n  name: string;\n  vectors: string[];\n  steps: Array<{\n    step: number;\n    action: string;\n    target: string;\n    technique: string;\n  }>;\n  combinedImpact: string;\n  difficulty: \"trivial\" | \"low\" | \"medium\" | \"high\" | \"expert\";\n}\n\nexport interface ImpactFindings {\n  dataExposure: {\n    types: string[];\n    severity: \"critical\" | \"high\" | \"medium\" | \"low\";\n    estimatedRecords: string;\n  };\n  financialImpact: {\n    estimate: string;\n    factors: string[];\n  };\n  complianceImpact: string[];\n  reputationalRisk: \"critical\" | \"high\" | \"medium\" | \"low\";\n}\n\nexport interface AgentMemory {\n  context: AgentContext;\n  recon?: ReconFindings;\n  exploit?: ExploitFindings;\n  lateral?: LateralFindings;\n  businessLogic?: BusinessLogicFindings;\n  enhancedBusinessLogic?: EnhancedBusinessLogicFindings;\n  multiVector?: MultiVectorFindings;\n  impact?: ImpactFindings;\n}\n\nexport interface AgentResult<T> {\n  success: boolean;\n  findings: T;\n  agentName: string;\n  processingTime: number;\n}\n\nexport interface OrchestratorResult {\n  exploitable: boolean;\n  confidence: number;\n  score: number;\n  attackPath: AttackPathStep[];\n  attackGraph?: AttackGraph;\n  businessLogicFindings?: BusinessLogicFinding[];\n  multiVectorFindings?: MultiVectorFinding[];\n  workflowAnalysis?: WorkflowStateMachine;\n  evidenceArtifacts?: EvidenceArtifact[];\n  intelligentScore?: IntelligentScore;\n  remediationGuidance?: RemediationGuidance;\n  impact: string;\n  recommendations: Recommendation[];\n  agentFindings: {\n    recon: ReconFindings;\n    exploit: ExploitFindings;\n    lateral: LateralFindings;\n    businessLogic: BusinessLogicFindings;\n    enhancedBusinessLogic?: EnhancedBusinessLogicFindings;\n    multiVector?: MultiVectorFindings;\n    impact: ImpactFindings;\n  };\n  totalProcessingTime: number;\n}\n\nexport type ProgressCallback = (\n  agentName: string,\n  stage: string,\n  progress: number,\n  message: string\n) => void;\n","path":null,"size_bytes":6266,"size_tokens":null},"client/src/components/ExploitabilityGauge.tsx":{"content":"interface ExploitabilityGaugeProps {\n  score: number;\n  confidence: number;\n  size?: \"sm\" | \"md\" | \"lg\";\n}\n\nexport function ExploitabilityGauge({ score, confidence, size = \"md\" }: ExploitabilityGaugeProps) {\n  const getRiskLevel = (score: number) => {\n    if (score >= 80) return { level: \"Critical\", color: \"text-red-400\", bgColor: \"stroke-red-500\" };\n    if (score >= 60) return { level: \"High\", color: \"text-orange-400\", bgColor: \"stroke-orange-500\" };\n    if (score >= 40) return { level: \"Medium\", color: \"text-amber-400\", bgColor: \"stroke-amber-500\" };\n    if (score >= 20) return { level: \"Low\", color: \"text-emerald-400\", bgColor: \"stroke-emerald-500\" };\n    return { level: \"Minimal\", color: \"text-cyan-400\", bgColor: \"stroke-cyan-500\" };\n  };\n\n  const risk = getRiskLevel(score);\n  const dimensions = {\n    sm: { width: 120, strokeWidth: 8, fontSize: \"text-2xl\" },\n    md: { width: 160, strokeWidth: 10, fontSize: \"text-3xl\" },\n    lg: { width: 200, strokeWidth: 12, fontSize: \"text-4xl\" },\n  };\n  \n  const { width, strokeWidth, fontSize } = dimensions[size];\n  const radius = (width - strokeWidth) / 2;\n  const circumference = Math.PI * radius;\n  const strokeDashoffset = circumference - (score / 100) * circumference;\n\n  return (\n    <div className=\"flex flex-col items-center\" data-testid=\"exploitability-gauge\">\n      <div className=\"relative\" style={{ width, height: width / 2 + 20 }}>\n        <svg\n          width={width}\n          height={width / 2 + 10}\n          viewBox={`0 0 ${width} ${width / 2 + 10}`}\n          className=\"transform rotate-0\"\n        >\n          <path\n            d={`M ${strokeWidth / 2} ${width / 2} A ${radius} ${radius} 0 0 1 ${width - strokeWidth / 2} ${width / 2}`}\n            fill=\"none\"\n            stroke=\"currentColor\"\n            strokeWidth={strokeWidth}\n            className=\"text-muted/30\"\n          />\n          <path\n            d={`M ${strokeWidth / 2} ${width / 2} A ${radius} ${radius} 0 0 1 ${width - strokeWidth / 2} ${width / 2}`}\n            fill=\"none\"\n            strokeWidth={strokeWidth}\n            strokeLinecap=\"round\"\n            className={risk.bgColor}\n            style={{\n              strokeDasharray: circumference,\n              strokeDashoffset: strokeDashoffset,\n              transition: \"stroke-dashoffset 1s ease-out\",\n            }}\n          />\n        </svg>\n        <div className=\"absolute inset-0 flex flex-col items-center justify-end pb-0\">\n          <span className={`${fontSize} font-bold tabular-nums ${risk.color}`}>{score}</span>\n        </div>\n      </div>\n      \n      <div className=\"text-center mt-2\">\n        <span className={`text-sm font-semibold ${risk.color}`}>{risk.level} Risk</span>\n      </div>\n\n      <div className=\"w-full mt-4\">\n        <div className=\"flex justify-between text-xs text-muted-foreground mb-1\">\n          <span>AI Confidence</span>\n          <span className=\"font-mono\">{Math.round(confidence * 100)}%</span>\n        </div>\n        <div className=\"h-2 bg-muted rounded-full overflow-hidden\">\n          <div \n            className=\"h-full bg-gradient-to-r from-cyan-500 to-blue-500 transition-all duration-500\"\n            style={{ width: `${confidence * 100}%` }}\n          />\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":3253,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, boolean, integer, timestamp, jsonb } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// ============================================================================\n// OdinForge Role-Based Access Control (RBAC)\n// Comprehensive 9-role model with granular permissions\n// ============================================================================\n\n// Platform Roles (System-Level) - Not customer assignable\nexport const platformRoles = [\"platform_super_admin\"] as const;\nexport type PlatformRole = typeof platformRoles[number];\n\n// Organization Roles (Customer-Facing)\nexport const organizationRoles = [\n  \"organization_owner\",      // Business & security ownership\n  \"security_administrator\",  // Operational control\n  \"security_engineer\",       // Hands-on technical work\n  \"security_analyst\",        // Investigation & triage (read-only)\n  \"executive_viewer\",        // Business risk visibility only\n] as const;\nexport type OrganizationRole = typeof organizationRoles[number];\n\n// Specialized Roles (Optional per tenant)\nexport const specializedRoles = [\n  \"compliance_officer\",      // GRC, audit teams\n  \"automation_account\",      // CI/CD pipelines, SOAR tools (API-only)\n] as const;\nexport type SpecializedRole = typeof specializedRoles[number];\n\n// Non-User Roles (System identities)\nexport const systemRoles = [\"endpoint_agent\"] as const;\nexport type SystemRole = typeof systemRoles[number];\n\n// Combined user roles (all assignable roles)\nexport const userRoles = [\n  ...platformRoles,\n  ...organizationRoles,\n  ...specializedRoles,\n] as const;\nexport type UserRole = typeof userRoles[number];\n\n// All roles including system\nexport const allRoles = [...userRoles, ...systemRoles] as const;\nexport type AllRole = typeof allRoles[number];\n\n// Execution modes for evaluations\nexport const executionModes = [\"safe\", \"simulation\", \"live\"] as const;\nexport type ExecutionMode = typeof executionModes[number];\n\n// Granular permissions for each module\nexport const permissions = [\n  // Evaluations\n  \"evaluations:read\",\n  \"evaluations:create\",\n  \"evaluations:execute_safe\",       // Run in safe mode\n  \"evaluations:execute_simulation\", // Run in simulation mode\n  \"evaluations:execute_live\",       // Run in live mode (requires approval)\n  \"evaluations:approve_live\",       // Approve live execution\n  \"evaluations:delete\",\n  \"evaluations:archive\",\n  \n  // Assets\n  \"assets:read\",\n  \"assets:create\",\n  \"assets:update\",\n  \"assets:delete\",\n  \n  // Reports\n  \"reports:read\",\n  \"reports:read_executive\",         // Executive summaries only\n  \"reports:generate\",\n  \"reports:export\",\n  \"reports:delete\",\n  \n  // Agents\n  \"agents:read\",\n  \"agents:register\",\n  \"agents:manage\",\n  \"agents:revoke\",\n  \"agents:delete\",\n  \n  // Evidence & Findings\n  \"evidence:read\",\n  \"evidence:read_sanitized\",        // No raw exploit details\n  \"findings:read\",\n  \"findings:triage\",\n  \n  // Simulations\n  \"simulations:read\",\n  \"simulations:run\",\n  \"simulations:delete\",\n  \n  // Governance & Audit\n  \"governance:read\",\n  \"governance:manage\",\n  \"audit:read\",\n  \"audit:read_global\",              // Cross-tenant audit (platform admin only)\n  \n  // Organization Management\n  \"org:read\",\n  \"org:manage_settings\",\n  \"org:manage_users\",\n  \"org:assign_roles\",\n  \n  // Platform Administration (Super Admin only)\n  \"platform:emergency_access\",\n  \"platform:feature_flags\",\n  \"platform:rate_limits\",\n  \"platform:cross_tenant_access\",\n  \n  // API Access\n  \"api:read\",\n  \"api:write\",\n] as const;\nexport type Permission = typeof permissions[number];\n\n// Role metadata for UI display and restrictions\nexport interface RoleMetadata {\n  displayName: string;\n  description: string;\n  category: \"platform\" | \"organization\" | \"specialized\" | \"system\";\n  requiresMFA: boolean;\n  uiAccess: boolean;           // Can access web UI\n  apiOnly: boolean;            // API-only access\n  customerAssignable: boolean; // Can customers assign this role?\n}\n\nexport const roleMetadata: Record<AllRole, RoleMetadata> = {\n  platform_super_admin: {\n    displayName: \"Platform Super Admin\",\n    description: \"Full platform operations & emergency control\",\n    category: \"platform\",\n    requiresMFA: true,\n    uiAccess: true,\n    apiOnly: false,\n    customerAssignable: false,\n  },\n  organization_owner: {\n    displayName: \"Organization Owner\",\n    description: \"Business & security ownership of organization\",\n    category: \"organization\",\n    requiresMFA: true,\n    uiAccess: true,\n    apiOnly: false,\n    customerAssignable: true,\n  },\n  security_administrator: {\n    displayName: \"Security Administrator\",\n    description: \"Operational control over security assessments\",\n    category: \"organization\",\n    requiresMFA: false,\n    uiAccess: true,\n    apiOnly: false,\n    customerAssignable: true,\n  },\n  security_engineer: {\n    displayName: \"Security Engineer\",\n    description: \"Hands-on technical security work\",\n    category: \"organization\",\n    requiresMFA: false,\n    uiAccess: true,\n    apiOnly: false,\n    customerAssignable: true,\n  },\n  security_analyst: {\n    displayName: \"Security Analyst\",\n    description: \"Investigation & triage of findings\",\n    category: \"organization\",\n    requiresMFA: false,\n    uiAccess: true,\n    apiOnly: false,\n    customerAssignable: true,\n  },\n  executive_viewer: {\n    displayName: \"Executive Viewer\",\n    description: \"Business risk visibility for leadership\",\n    category: \"organization\",\n    requiresMFA: false,\n    uiAccess: true,\n    apiOnly: false,\n    customerAssignable: true,\n  },\n  compliance_officer: {\n    displayName: \"Compliance Officer\",\n    description: \"GRC and audit oversight\",\n    category: \"specialized\",\n    requiresMFA: false,\n    uiAccess: true,\n    apiOnly: false,\n    customerAssignable: true,\n  },\n  automation_account: {\n    displayName: \"Automation Account\",\n    description: \"CI/CD and SOAR integration\",\n    category: \"specialized\",\n    requiresMFA: false,\n    uiAccess: false,\n    apiOnly: true,\n    customerAssignable: true,\n  },\n  endpoint_agent: {\n    displayName: \"Endpoint Agent\",\n    description: \"System identity for deployed agents\",\n    category: \"system\",\n    requiresMFA: false,\n    uiAccess: false,\n    apiOnly: true,\n    customerAssignable: false,\n  },\n};\n\n// Role-permission mapping\nexport const rolePermissions: Record<UserRole, Permission[]> = {\n  // Platform Super Admin - Full access\n  platform_super_admin: [...permissions],\n  \n  // Organization Owner - Business & security ownership\n  organization_owner: [\n    \"evaluations:read\",\n    \"evaluations:create\",\n    \"evaluations:execute_safe\",\n    \"evaluations:execute_simulation\",\n    \"evaluations:approve_live\",\n    \"evaluations:delete\",\n    \"evaluations:archive\",\n    \"assets:read\",\n    \"assets:create\",\n    \"assets:update\",\n    \"assets:delete\",\n    \"reports:read\",\n    \"reports:read_executive\",\n    \"reports:generate\",\n    \"reports:export\",\n    \"reports:delete\",\n    \"agents:read\",\n    \"agents:register\",\n    \"agents:manage\",\n    \"agents:delete\",\n    \"evidence:read\",\n    \"findings:read\",\n    \"findings:triage\",\n    \"simulations:read\",\n    \"simulations:run\",\n    \"simulations:delete\",\n    \"governance:read\",\n    \"audit:read\",\n    \"org:read\",\n    \"org:manage_settings\",\n    \"org:manage_users\",\n    \"org:assign_roles\",\n    \"api:read\",\n    \"api:write\",\n  ],\n  \n  // Security Administrator - Operational control\n  security_administrator: [\n    \"evaluations:read\",\n    \"evaluations:create\",\n    \"evaluations:execute_safe\",\n    \"evaluations:execute_simulation\",\n    \"evaluations:execute_live\",\n    \"evaluations:archive\",\n    \"evaluations:delete\",\n    \"assets:read\",\n    \"assets:create\",\n    \"assets:update\",\n    \"assets:delete\",\n    \"reports:read\",\n    \"reports:generate\",\n    \"reports:export\",\n    \"reports:delete\",\n    \"agents:read\",\n    \"agents:register\",\n    \"agents:manage\",\n    \"agents:delete\",\n    \"evidence:read\",\n    \"findings:read\",\n    \"findings:triage\",\n    \"simulations:read\",\n    \"simulations:run\",\n    \"simulations:delete\",\n    \"governance:read\",\n    \"governance:manage\",\n    \"audit:read\",\n    \"org:read\",\n    \"api:read\",\n    \"api:write\",\n  ],\n  \n  // Security Engineer - Technical work\n  security_engineer: [\n    \"evaluations:read\",\n    \"evaluations:create\",\n    \"evaluations:execute_safe\",\n    \"evaluations:execute_simulation\",\n    \"assets:read\",\n    \"assets:create\",\n    \"reports:read\",\n    \"reports:generate\",\n    \"reports:export\",\n    \"agents:read\",\n    \"agents:register\",\n    \"evidence:read\",\n    \"findings:read\",\n    \"simulations:read\",\n    \"simulations:run\",\n    \"governance:read\",\n    \"api:read\",\n  ],\n  \n  // Security Analyst - Investigation & triage (read-heavy)\n  security_analyst: [\n    \"evaluations:read\",\n    \"assets:read\",\n    \"reports:read\",\n    \"reports:export\",\n    \"agents:read\",\n    \"evidence:read\",\n    \"findings:read\",\n    \"simulations:read\",\n    \"governance:read\",\n    \"api:read\",\n  ],\n  \n  // Executive Viewer - Business risk visibility (sanitized view)\n  executive_viewer: [\n    \"evaluations:read\",\n    \"assets:read\",\n    \"reports:read\",\n    \"reports:read_executive\",\n    \"evidence:read_sanitized\",\n    \"findings:read\",\n    \"governance:read\",\n  ],\n  \n  // Compliance Officer - GRC oversight\n  compliance_officer: [\n    \"evaluations:read\",\n    \"assets:read\",\n    \"reports:read\",\n    \"reports:export\",\n    \"evidence:read\",\n    \"findings:read\",\n    \"governance:read\",\n    \"audit:read\",\n    \"api:read\",\n  ],\n  \n  // Automation Account - API-only, scoped\n  automation_account: [\n    \"evaluations:read\",\n    \"evaluations:create\",\n    \"evaluations:execute_safe\",\n    \"evaluations:execute_simulation\",\n    \"assets:read\",\n    \"reports:read\",\n    \"findings:read\",\n    \"api:read\",\n    \"api:write\",\n  ],\n};\n\n// Helper to check if role can execute in a specific mode\nexport function canExecuteMode(role: UserRole, mode: ExecutionMode): boolean {\n  const perms = rolePermissions[role] || [];\n  switch (mode) {\n    case \"safe\":\n      return perms.includes(\"evaluations:execute_safe\");\n    case \"simulation\":\n      return perms.includes(\"evaluations:execute_simulation\");\n    case \"live\":\n      return perms.includes(\"evaluations:execute_live\");\n    default:\n      return false;\n  }\n}\n\n// Helper to check if role needs sanitized evidence view\nexport function needsSanitizedView(role: UserRole): boolean {\n  const perms = rolePermissions[role] || [];\n  return perms.includes(\"evidence:read_sanitized\") && !perms.includes(\"evidence:read\");\n}\n\n// Helper to check if role is API-only\nexport function isApiOnlyRole(role: AllRole): boolean {\n  return roleMetadata[role]?.apiOnly ?? false;\n}\n\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  username: text(\"username\").notNull().unique(),\n  password: text(\"password\").notNull(),\n  role: varchar(\"role\").notNull().default(\"viewer\"), // admin, analyst, viewer\n  displayName: text(\"display_name\"),\n  email: text(\"email\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  lastLoginAt: timestamp(\"last_login_at\"),\n});\n\nexport const insertUserSchema = createInsertSchema(users).pick({\n  username: true,\n  password: true,\n  role: true,\n  displayName: true,\n  email: true,\n});\n\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type User = typeof users.$inferSelect;\n\n// Exposure Types - Multi-Vector Coverage\nexport const exposureTypes = [\n  \"cve\",                    // CVE exploitation (safe mode)\n  \"misconfiguration\",       // General misconfigurations\n  \"behavioral_anomaly\",     // Behavioral anomalies\n  \"network_vulnerability\",  // Network pivoting\n  \"cloud_misconfiguration\", // Cloud misconfiguration chaining (AWS/GCP/Azure)\n  \"iam_abuse\",              // IAM abuse paths\n  \"saas_permission\",        // SaaS permission abuse\n  \"shadow_admin\",           // Shadow admin discovery\n  \"api_sequence_abuse\",     // API sequence/workflow abuse\n  \"payment_flow\",           // Payment flow vulnerabilities\n  \"subscription_bypass\",    // Subscription & billing bypass\n  \"state_machine\",          // State machine violations\n  \"privilege_boundary\",     // Privilege boundary violations\n  \"workflow_desync\",        // Workflow desynchronization\n  \"order_lifecycle\",        // Order lifecycle abuse\n] as const;\n\nexport type ExposureType = typeof exposureTypes[number];\n\n// Business Logic Vulnerability Categories\nexport const businessLogicCategories = [\n  \"payment_bypass\",         // Skipping payment steps\n  \"subscription_abuse\",     // Free tier abuse, trial extension\n  \"order_manipulation\",     // Price manipulation, quantity abuse\n  \"state_transition\",       // Invalid state jumps\n  \"privilege_escalation\",   // Horizontal/vertical escalation\n  \"workflow_bypass\",        // Skipping required steps\n  \"race_condition\",         // TOCTOU, double-spend\n  \"parameter_tampering\",    // Hidden field manipulation\n  \"session_abuse\",          // Session fixation, replay\n  \"logic_flaw\",             // General logic flaws\n] as const;\n\nexport type BusinessLogicCategory = typeof businessLogicCategories[number];\n\n// Cloud/IAM Vector Types\nexport const cloudVectorTypes = [\n  \"s3_public_bucket\",\n  \"iam_role_chaining\",\n  \"cross_account_access\",\n  \"metadata_service_abuse\",\n  \"lambda_privilege_escalation\",\n  \"storage_account_exposure\",\n  \"service_account_abuse\",\n  \"federation_bypass\",\n  \"permission_boundary_bypass\",\n  \"resource_policy_abuse\",\n] as const;\n\nexport type CloudVectorType = typeof cloudVectorTypes[number];\n\n// AEV Evaluations table\nexport const aevEvaluations = pgTable(\"aev_evaluations\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull().default(\"default\"),\n  assetId: varchar(\"asset_id\").notNull(),\n  exposureType: varchar(\"exposure_type\").notNull(), // One of exposureTypes\n  priority: varchar(\"priority\").notNull().default(\"medium\"), // critical, high, medium, low\n  description: text(\"description\").notNull(),\n  adversaryProfile: varchar(\"adversary_profile\"), // One of adversaryProfiles (optional)\n  executionMode: varchar(\"execution_mode\").default(\"safe\"), // safe, live, simulation - tracks which governance mode was used\n  status: varchar(\"status\").notNull().default(\"pending\"), // pending, in_progress, completed, failed\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Attack path step type\nexport const attackPathStepSchema = z.object({\n  id: z.number(),\n  title: z.string(),\n  description: z.string(),\n  technique: z.string().optional(),\n  severity: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n  discoveredBy: z.enum([\"recon\", \"exploit\", \"lateral\", \"business-logic\", \"impact\"]).optional(),\n});\n\n// Recommendation type\nexport const recommendationSchema = z.object({\n  id: z.string(),\n  title: z.string(),\n  description: z.string(),\n  priority: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n  type: z.enum([\"remediation\", \"compensating\", \"preventive\"]),\n});\n\nexport type AttackPathStep = z.infer<typeof attackPathStepSchema>;\nexport type Recommendation = z.infer<typeof recommendationSchema>;\n\n// MITRE ATT&CK Kill Chain Tactics\nexport const killChainTactics = [\n  \"reconnaissance\",\n  \"resource-development\", \n  \"initial-access\",\n  \"execution\",\n  \"persistence\",\n  \"privilege-escalation\",\n  \"defense-evasion\",\n  \"credential-access\",\n  \"discovery\",\n  \"lateral-movement\",\n  \"collection\",\n  \"command-and-control\",\n  \"exfiltration\",\n  \"impact\"\n] as const;\n\nexport type KillChainTactic = typeof killChainTactics[number];\n\n// Attack Graph Node - represents a state/position in the attack\nexport const attackNodeSchema = z.object({\n  id: z.string(),\n  label: z.string(),\n  description: z.string(),\n  nodeType: z.enum([\"entry\", \"pivot\", \"objective\", \"dead-end\"]),\n  tactic: z.enum(killChainTactics),\n  compromiseLevel: z.enum([\"none\", \"limited\", \"user\", \"admin\", \"system\"]),\n  assets: z.array(z.string()).optional(),\n  discoveredBy: z.enum([\"recon\", \"exploit\", \"lateral\", \"business-logic\", \"impact\"]).optional(),\n});\n\n// Attack Graph Edge - represents a technique/transition between nodes\nexport const attackEdgeSchema = z.object({\n  id: z.string(),\n  source: z.string(),\n  target: z.string(),\n  technique: z.string(),\n  techniqueId: z.string().optional(),\n  description: z.string(),\n  successProbability: z.number().min(0).max(100),\n  complexity: z.enum([\"trivial\", \"low\", \"medium\", \"high\", \"expert\"]),\n  timeEstimate: z.number(),\n  prerequisites: z.array(z.string()).optional(),\n  alternatives: z.array(z.string()).optional(),\n  edgeType: z.enum([\"primary\", \"alternative\", \"fallback\"]),\n  discoveredBy: z.enum([\"recon\", \"exploit\", \"lateral\", \"business-logic\", \"impact\"]).optional(),\n});\n\n// Complete Attack Graph structure\nexport const attackGraphSchema = z.object({\n  nodes: z.array(attackNodeSchema),\n  edges: z.array(attackEdgeSchema),\n  entryNodeId: z.string(),\n  objectiveNodeIds: z.array(z.string()),\n  criticalPath: z.array(z.string()),\n  alternativePaths: z.array(z.array(z.string())).optional(),\n  killChainCoverage: z.array(z.enum(killChainTactics)),\n  complexityScore: z.number().min(0).max(100),\n  timeToCompromise: z.object({\n    minimum: z.number(),\n    expected: z.number(),\n    maximum: z.number(),\n    unit: z.enum([\"minutes\", \"hours\", \"days\"]),\n  }),\n  chainedExploits: z.array(z.object({\n    name: z.string(),\n    techniques: z.array(z.string()),\n    combinedImpact: z.string(),\n  })).optional(),\n});\n\nexport type AttackNode = z.infer<typeof attackNodeSchema>;\nexport type AttackEdge = z.infer<typeof attackEdgeSchema>;\nexport type AttackGraph = z.infer<typeof attackGraphSchema>;\n\n// Business Logic Vulnerability Finding\nexport const businessLogicFindingSchema = z.object({\n  id: z.string(),\n  category: z.enum(businessLogicCategories),\n  title: z.string(),\n  description: z.string(),\n  severity: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n  intendedWorkflow: z.array(z.string()),\n  actualWorkflow: z.array(z.string()),\n  stateViolations: z.array(z.object({\n    fromState: z.string(),\n    toState: z.string(),\n    expectedTransitions: z.array(z.string()),\n    actualTransition: z.string(),\n    isViolation: z.boolean(),\n  })).optional(),\n  exploitSteps: z.array(z.string()),\n  impact: z.string(),\n  businessImpact: z.object({\n    financialLoss: z.string().optional(),\n    dataExposure: z.string().optional(),\n    reputationalDamage: z.string().optional(),\n    complianceViolation: z.string().optional(),\n  }).optional(),\n  validatedExploit: z.boolean(),\n  proofOfConcept: z.string().optional(),\n});\n\nexport type BusinessLogicFinding = z.infer<typeof businessLogicFindingSchema>;\n\n// Workflow State Machine representation\nexport const workflowStateMachineSchema = z.object({\n  name: z.string(),\n  states: z.array(z.object({\n    id: z.string(),\n    name: z.string(),\n    type: z.enum([\"initial\", \"intermediate\", \"terminal\", \"error\"]),\n    requiredAuth: z.enum([\"none\", \"user\", \"admin\", \"system\"]).optional(),\n  })),\n  transitions: z.array(z.object({\n    id: z.string(),\n    from: z.string(),\n    to: z.string(),\n    trigger: z.string(),\n    guard: z.string().optional(),\n    isSecurityCritical: z.boolean().optional(),\n  })),\n  securityBoundaries: z.array(z.object({\n    name: z.string(),\n    statesWithin: z.array(z.string()),\n    requiredPrivilege: z.string(),\n  })).optional(),\n});\n\nexport type WorkflowStateMachine = z.infer<typeof workflowStateMachineSchema>;\n\n// Multi-Vector Analysis Finding\nexport const multiVectorFindingSchema = z.object({\n  id: z.string(),\n  vectorType: z.enum([...exposureTypes]),\n  cloudVector: z.enum([...cloudVectorTypes]).optional(),\n  title: z.string(),\n  description: z.string(),\n  severity: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n  affectedResources: z.array(z.string()),\n  chainableWith: z.array(z.string()).optional(),\n  exploitPath: z.array(z.object({\n    step: z.number(),\n    action: z.string(),\n    target: z.string(),\n    technique: z.string().optional(),\n  })),\n  iamContext: z.object({\n    principal: z.string().optional(),\n    assumableRoles: z.array(z.string()).optional(),\n    effectivePermissions: z.array(z.string()).optional(),\n    privilegeEscalationPath: z.string().optional(),\n  }).optional(),\n  cloudContext: z.object({\n    provider: z.enum([\"aws\", \"gcp\", \"azure\", \"multi-cloud\"]).optional(),\n    region: z.string().optional(),\n    service: z.string().optional(),\n    resourceArn: z.string().optional(),\n  }).optional(),\n  saasContext: z.object({\n    platform: z.string().optional(),\n    permissionLevel: z.string().optional(),\n    shadowAdminIndicators: z.array(z.string()).optional(),\n  }).optional(),\n});\n\nexport type MultiVectorFinding = z.infer<typeof multiVectorFindingSchema>;\n\n// Evidence Artifact Types\nexport const evidenceArtifactTypes = [\n  \"request_response\",     // HTTP request/response pair\n  \"execution_trace\",      // Step-by-step execution log\n  \"log_capture\",          // System/application logs\n  \"screenshot\",           // Safe screenshot capture\n  \"configuration_dump\",   // Config state at time of exploit\n  \"data_sample\",          // Sanitized data samples\n  \"network_capture\",      // Network traffic summary\n  \"timeline_event\",       // Timestamped event\n] as const;\n\nexport type EvidenceArtifactType = typeof evidenceArtifactTypes[number];\n\n// Evidence Artifact Schema - proof of exploit\nexport const evidenceArtifactSchema = z.object({\n  id: z.string(),\n  type: z.enum(evidenceArtifactTypes),\n  timestamp: z.string(),\n  title: z.string(),\n  description: z.string(),\n  data: z.object({\n    request: z.object({\n      method: z.string(),\n      url: z.string(),\n      headers: z.record(z.string()).optional(),\n      body: z.string().optional(),\n    }).optional(),\n    response: z.object({\n      statusCode: z.number(),\n      headers: z.record(z.string()).optional(),\n      body: z.string().optional(),\n      timing: z.number().optional(),\n    }).optional(),\n    logs: z.array(z.object({\n      timestamp: z.string(),\n      level: z.enum([\"debug\", \"info\", \"warn\", \"error\"]),\n      message: z.string(),\n      source: z.string().optional(),\n    })).optional(),\n    screenshot: z.object({\n      base64: z.string().optional(),\n      url: z.string().optional(),\n      caption: z.string(),\n    }).optional(),\n    trace: z.array(z.object({\n      step: z.number(),\n      action: z.string(),\n      result: z.string(),\n      duration: z.number().optional(),\n    })).optional(),\n  }),\n  tags: z.array(z.string()).optional(),\n  attackStepId: z.number().optional(),\n  findingId: z.string().optional(),\n  isSanitized: z.boolean().default(true),\n});\n\nexport type EvidenceArtifact = z.infer<typeof evidenceArtifactSchema>;\n\n// Evidence Packet - collection of artifacts for sharing\nexport const evidencePacketSchema = z.object({\n  id: z.string(),\n  evaluationId: z.string(),\n  createdAt: z.string(),\n  title: z.string(),\n  summary: z.string(),\n  artifacts: z.array(evidenceArtifactSchema),\n  timeline: z.array(z.object({\n    timestamp: z.string(),\n    event: z.string(),\n    artifactId: z.string().optional(),\n  })),\n  executiveSummary: z.string().optional(),\n  replayInstructions: z.string().optional(),\n  metadata: z.object({\n    evaluationType: z.string(),\n    assetId: z.string(),\n    totalArtifacts: z.number(),\n    criticalFindings: z.number(),\n  }),\n});\n\nexport type EvidencePacket = z.infer<typeof evidencePacketSchema>;\n\n// Compliance Frameworks\nexport const complianceFrameworks = [\n  \"pci_dss\",    // Payment Card Industry\n  \"hipaa\",      // Healthcare\n  \"sox\",        // Financial reporting\n  \"gdpr\",       // EU data protection\n  \"ccpa\",       // California privacy\n  \"iso27001\",   // Information security\n  \"nist\",       // NIST Cybersecurity Framework\n  \"soc2\",       // Service Organization Control\n] as const;\n\nexport type ComplianceFramework = typeof complianceFrameworks[number];\n\n// Exploitability Score Schema - contextual risk assessment\nexport const exploitabilityScoreSchema = z.object({\n  score: z.number().min(0).max(100),\n  confidence: z.number().min(0).max(100),\n  factors: z.object({\n    attackComplexity: z.object({\n      level: z.enum([\"trivial\", \"low\", \"medium\", \"high\", \"expert\"]),\n      score: z.number().min(0).max(100),\n      rationale: z.string(),\n    }),\n    authenticationRequired: z.object({\n      level: z.enum([\"none\", \"single\", \"multi-factor\", \"privileged\"]),\n      score: z.number().min(0).max(100),\n      rationale: z.string(),\n    }),\n    environmentalContext: z.object({\n      networkExposure: z.enum([\"internet\", \"dmz\", \"internal\", \"isolated\"]),\n      patchLevel: z.enum([\"current\", \"behind\", \"significantly_behind\", \"eol\"]),\n      compensatingControls: z.array(z.string()),\n      score: z.number().min(0).max(100),\n    }),\n    detectionLikelihood: z.object({\n      level: z.enum([\"unlikely\", \"possible\", \"likely\", \"certain\"]),\n      monitoringCoverage: z.number().min(0).max(100),\n      evasionDifficulty: z.enum([\"trivial\", \"moderate\", \"difficult\", \"near_impossible\"]),\n      score: z.number().min(0).max(100),\n    }),\n    exploitMaturity: z.object({\n      availability: z.enum([\"theoretical\", \"poc\", \"weaponized\", \"in_the_wild\"]),\n      skillRequired: z.enum([\"script_kiddie\", \"intermediate\", \"advanced\", \"nation_state\"]),\n      score: z.number().min(0).max(100),\n    }),\n  }),\n});\n\nexport type ExploitabilityScore = z.infer<typeof exploitabilityScoreSchema>;\n\n// Business Impact Score Schema\nexport const businessImpactScoreSchema = z.object({\n  score: z.number().min(0).max(100),\n  riskLabel: z.enum([\"minimal\", \"low\", \"moderate\", \"significant\", \"severe\", \"catastrophic\"]),\n  factors: z.object({\n    dataSensitivity: z.object({\n      classification: z.enum([\"public\", \"internal\", \"confidential\", \"restricted\", \"top_secret\"]),\n      dataTypes: z.array(z.enum([\"pii\", \"phi\", \"pci\", \"credentials\", \"trade_secrets\", \"financial\", \"customer_data\"])),\n      recordsAtRisk: z.string(),\n      score: z.number().min(0).max(100),\n    }),\n    financialExposure: z.object({\n      directLoss: z.object({\n        min: z.number(),\n        max: z.number(),\n        currency: z.string().default(\"USD\"),\n      }),\n      regulatoryFines: z.object({\n        potential: z.number(),\n        frameworks: z.array(z.string()),\n      }),\n      remediationCost: z.number(),\n      businessDisruptionCost: z.number(),\n      score: z.number().min(0).max(100),\n    }),\n    complianceImpact: z.object({\n      affectedFrameworks: z.array(z.enum(complianceFrameworks)),\n      violations: z.array(z.object({\n        framework: z.string(),\n        requirement: z.string(),\n        severity: z.enum([\"minor\", \"major\", \"critical\"]),\n      })),\n      auditImplications: z.string().optional(),\n      score: z.number().min(0).max(100),\n    }),\n    blastRadius: z.object({\n      affectedSystems: z.number(),\n      affectedUsers: z.string(),\n      downstreamDependencies: z.array(z.string()),\n      propagationRisk: z.enum([\"contained\", \"limited\", \"spreading\", \"uncontained\"]),\n      score: z.number().min(0).max(100),\n    }),\n    reputationalRisk: z.object({\n      customerTrust: z.enum([\"minimal\", \"moderate\", \"significant\", \"severe\"]),\n      mediaExposure: z.enum([\"unlikely\", \"possible\", \"likely\", \"certain\"]),\n      competitiveAdvantage: z.enum([\"none\", \"minor\", \"moderate\", \"major\"]),\n      score: z.number().min(0).max(100),\n    }),\n  }),\n});\n\nexport type BusinessImpactScore = z.infer<typeof businessImpactScoreSchema>;\n\n// Combined Risk Rank Schema\nexport const riskRankSchema = z.object({\n  overallScore: z.number().min(0).max(100),\n  riskLevel: z.enum([\"info\", \"low\", \"medium\", \"high\", \"critical\", \"emergency\"]),\n  executiveLabel: z.string(),\n  fixPriority: z.number().min(1).max(100),\n  recommendation: z.object({\n    action: z.string(),\n    timeframe: z.enum([\"immediate\", \"24_hours\", \"7_days\", \"30_days\", \"90_days\", \"acceptable_risk\"]),\n    justification: z.string(),\n  }),\n  comparison: z.object({\n    cvssEquivalent: z.number().optional(),\n    industryPercentile: z.number().optional(),\n    organizationPercentile: z.number().optional(),\n  }).optional(),\n  trendIndicator: z.enum([\"improving\", \"stable\", \"degrading\", \"new\"]).optional(),\n});\n\nexport type RiskRank = z.infer<typeof riskRankSchema>;\n\n// Complete Intelligent Score combining all factors\nexport const intelligentScoreSchema = z.object({\n  exploitability: exploitabilityScoreSchema,\n  businessImpact: businessImpactScoreSchema,\n  riskRank: riskRankSchema,\n  calculatedAt: z.string(),\n  methodology: z.string().optional(),\n  overrides: z.array(z.object({\n    field: z.string(),\n    originalValue: z.any(),\n    overrideValue: z.any(),\n    reason: z.string(),\n    overriddenBy: z.string(),\n    timestamp: z.string(),\n  })).optional(),\n});\n\nexport type IntelligentScore = z.infer<typeof intelligentScoreSchema>;\n\n// Remediation Types\nexport const remediationTypes = [\n  \"code_fix\",           // Code-level patches\n  \"config_change\",      // Configuration updates\n  \"waf_rule\",           // WAF/firewall rules\n  \"iam_policy\",         // IAM policy changes\n  \"network_control\",    // Network segmentation/controls\n  \"detection_rule\",     // SIEM/detection signatures\n  \"compensating\",       // Compensating controls\n] as const;\n\nexport type RemediationType = typeof remediationTypes[number];\n\n// Code Fix Schema\nexport const codeFixSchema = z.object({\n  id: z.string(),\n  title: z.string(),\n  language: z.string(),\n  filePath: z.string().optional(),\n  vulnerability: z.string(),\n  beforeCode: z.string(),\n  afterCode: z.string(),\n  explanation: z.string(),\n  complexity: z.enum([\"trivial\", \"low\", \"medium\", \"high\"]),\n  testingNotes: z.string().optional(),\n});\n\nexport type CodeFix = z.infer<typeof codeFixSchema>;\n\n// WAF Rule Schema\nexport const wafRuleSchema = z.object({\n  id: z.string(),\n  title: z.string(),\n  platform: z.enum([\"cloudflare\", \"aws_waf\", \"azure_waf\", \"modsecurity\", \"nginx\", \"generic\"]),\n  ruleType: z.enum([\"block\", \"rate_limit\", \"challenge\", \"log\"]),\n  condition: z.string(),\n  action: z.string(),\n  priority: z.number(),\n  description: z.string(),\n  falsePositiveRisk: z.enum([\"low\", \"medium\", \"high\"]),\n  rawConfig: z.string(),\n});\n\nexport type WafRule = z.infer<typeof wafRuleSchema>;\n\n// IAM Policy Schema\nexport const iamPolicySchema = z.object({\n  id: z.string(),\n  title: z.string(),\n  platform: z.enum([\"aws\", \"gcp\", \"azure\", \"okta\", \"generic\"]),\n  policyType: z.enum([\"deny\", \"allow\", \"boundary\", \"scp\"]),\n  currentState: z.string(),\n  recommendedState: z.string(),\n  affectedPrincipals: z.array(z.string()),\n  riskReduction: z.number().min(0).max(100),\n  implementationSteps: z.array(z.string()),\n  rollbackPlan: z.string().optional(),\n  rawPolicy: z.string(),\n});\n\nexport type IamPolicy = z.infer<typeof iamPolicySchema>;\n\n// Network Control Schema\nexport const networkControlSchema = z.object({\n  id: z.string(),\n  title: z.string(),\n  controlType: z.enum([\"firewall\", \"segmentation\", \"acl\", \"vpn\", \"proxy\"]),\n  sourceZone: z.string(),\n  destinationZone: z.string(),\n  protocol: z.string(),\n  ports: z.array(z.string()),\n  action: z.enum([\"allow\", \"deny\", \"log\", \"quarantine\"]),\n  description: z.string(),\n  implementationGuide: z.string(),\n});\n\nexport type NetworkControl = z.infer<typeof networkControlSchema>;\n\n// Detection Rule Schema\nexport const detectionRuleSchema = z.object({\n  id: z.string(),\n  title: z.string(),\n  platform: z.enum([\"splunk\", \"elastic\", \"sentinel\", \"sigma\", \"yara\", \"snort\", \"generic\"]),\n  ruleType: z.enum([\"correlation\", \"threshold\", \"anomaly\", \"signature\"]),\n  severity: z.enum([\"info\", \"low\", \"medium\", \"high\", \"critical\"]),\n  description: z.string(),\n  logic: z.string(),\n  rawRule: z.string(),\n  dataSource: z.array(z.string()),\n  mitreTechniques: z.array(z.string()).optional(),\n  falsePositiveGuidance: z.string().optional(),\n  responsePlaybook: z.string().optional(),\n});\n\nexport type DetectionRule = z.infer<typeof detectionRuleSchema>;\n\n// Compensating Control Schema\nexport const compensatingControlSchema = z.object({\n  id: z.string(),\n  title: z.string(),\n  controlType: z.enum([\"monitoring\", \"alerting\", \"access_review\", \"encryption\", \"backup\", \"training\"]),\n  description: z.string(),\n  rationale: z.string(),\n  implementationGuide: z.string(),\n  effectiveness: z.number().min(0).max(100),\n  duration: z.enum([\"temporary\", \"permanent\"]),\n  reviewDate: z.string().optional(),\n  dependencies: z.array(z.string()).optional(),\n});\n\nexport type CompensatingControl = z.infer<typeof compensatingControlSchema>;\n\n// Complete Remediation Guidance\nexport const remediationGuidanceSchema = z.object({\n  id: z.string(),\n  evaluationId: z.string(),\n  generatedAt: z.string(),\n  summary: z.string(),\n  executiveSummary: z.string(),\n  codeFixes: z.array(codeFixSchema).optional(),\n  wafRules: z.array(wafRuleSchema).optional(),\n  iamPolicies: z.array(iamPolicySchema).optional(),\n  networkControls: z.array(networkControlSchema).optional(),\n  detectionRules: z.array(detectionRuleSchema).optional(),\n  compensatingControls: z.array(compensatingControlSchema).optional(),\n  prioritizedActions: z.array(z.object({\n    order: z.number(),\n    action: z.string(),\n    type: z.enum(remediationTypes),\n    timeEstimate: z.string(),\n    riskReduction: z.number().min(0).max(100),\n    effort: z.enum([\"low\", \"medium\", \"high\"]),\n  })),\n  totalRiskReduction: z.number().min(0).max(100),\n  estimatedImplementationTime: z.string(),\n});\n\nexport type RemediationGuidance = z.infer<typeof remediationGuidanceSchema>;\n\n// AEV Results table\nexport const aevResults = pgTable(\"aev_results\", {\n  id: varchar(\"id\").primaryKey(),\n  evaluationId: varchar(\"evaluation_id\").notNull(),\n  exploitable: boolean(\"exploitable\").notNull(),\n  confidence: integer(\"confidence\").notNull(), // 0-100\n  score: integer(\"score\").notNull(), // 0-100\n  attackPath: jsonb(\"attack_path\").$type<AttackPathStep[]>(),\n  attackGraph: jsonb(\"attack_graph\").$type<AttackGraph>(),\n  businessLogicFindings: jsonb(\"business_logic_findings\").$type<BusinessLogicFinding[]>(),\n  multiVectorFindings: jsonb(\"multi_vector_findings\").$type<MultiVectorFinding[]>(),\n  workflowAnalysis: jsonb(\"workflow_analysis\").$type<WorkflowStateMachine>(),\n  impact: text(\"impact\"),\n  recommendations: jsonb(\"recommendations\").$type<Recommendation[]>(),\n  evidenceArtifacts: jsonb(\"evidence_artifacts\").$type<EvidenceArtifact[]>(),\n  intelligentScore: jsonb(\"intelligent_score\").$type<IntelligentScore>(),\n  remediationGuidance: jsonb(\"remediation_guidance\").$type<RemediationGuidance>(),\n  duration: integer(\"duration\"), // milliseconds\n  completedAt: timestamp(\"completed_at\"),\n});\n\nexport const insertEvaluationSchema = createInsertSchema(aevEvaluations).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertResultSchema = createInsertSchema(aevResults).omit({\n  id: true,\n  completedAt: true,\n});\n\nexport type InsertEvaluation = z.infer<typeof insertEvaluationSchema>;\nexport type Evaluation = typeof aevEvaluations.$inferSelect;\nexport type InsertResult = z.infer<typeof insertResultSchema>;\nexport type Result = typeof aevResults.$inferSelect;\n\n// ============================================================================\n// REPORTING & BATCH VALIDATION SCHEMAS\n// ============================================================================\n\n// Report Types\nexport const reportTypes = [\n  \"executive_summary\",      // High-level for C-suite and board\n  \"technical_deepdive\",     // Detailed for security engineers\n  \"compliance_mapping\",     // Mapped to compliance frameworks\n  \"evidence_bundle\",        // Full evidence package for auditors\n] as const;\n\nexport type ReportType = typeof reportTypes[number];\n\n// Report Version - V1 (template-based) vs V2 (AI narrative)\nexport const reportVersions = [\n  \"v1_template\",    // Logic-based template reports with structured data\n  \"v2_narrative\",   // AI-generated narrative pentest reports (ENO-based)\n] as const;\n\nexport type ReportVersion = typeof reportVersions[number];\n\n// Export Formats\nexport const exportFormats = [\n  \"pdf\",\n  \"csv\",\n  \"json\",\n  \"html\",\n] as const;\n\nexport type ExportFormat = typeof exportFormats[number];\n\n// Report Finding Schema\nexport const reportFindingSchema = z.object({\n  id: z.string(),\n  evaluationId: z.string(),\n  assetId: z.string(),\n  title: z.string(),\n  severity: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n  exploitable: z.boolean(),\n  score: z.number().min(0).max(100),\n  description: z.string(),\n  impact: z.string().optional(),\n  recommendation: z.string().optional(),\n  complianceViolations: z.array(z.object({\n    framework: z.enum(complianceFrameworks),\n    control: z.string(),\n    description: z.string(),\n  })).optional(),\n  evidence: z.array(z.string()).optional(),\n});\n\nexport type ReportFinding = z.infer<typeof reportFindingSchema>;\n\n// Executive Summary Schema\nexport const executiveSummarySchema = z.object({\n  reportDate: z.string(),\n  reportPeriod: z.object({\n    from: z.string(),\n    to: z.string(),\n  }),\n  organizationId: z.string(),\n  overallRiskLevel: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n  keyMetrics: z.object({\n    totalEvaluations: z.number(),\n    exploitableFindings: z.number(),\n    criticalFindings: z.number(),\n    highFindings: z.number(),\n    mediumFindings: z.number(),\n    lowFindings: z.number(),\n    averageScore: z.number(),\n    averageConfidence: z.number(),\n  }),\n  riskTrend: z.enum([\"improving\", \"stable\", \"degrading\"]),\n  topRisks: z.array(z.object({\n    assetId: z.string(),\n    riskDescription: z.string(),\n    severity: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n    financialImpact: z.string().optional(),\n  })),\n  recommendations: z.array(z.object({\n    priority: z.number(),\n    action: z.string(),\n    impact: z.string(),\n    effort: z.enum([\"low\", \"medium\", \"high\"]),\n  })),\n  executiveNarrative: z.string(),\n  executiveSummary: z.string().optional(),\n  findings: z.array(z.object({\n    title: z.string(),\n    description: z.string(),\n    recommendation: z.string(),\n    severity: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n  })).optional(),\n});\n\nexport type ExecutiveSummary = z.infer<typeof executiveSummarySchema>;\n\n// Technical Report Schema\nexport const technicalReportSchema = z.object({\n  reportDate: z.string(),\n  reportPeriod: z.object({\n    from: z.string(),\n    to: z.string(),\n  }),\n  organizationId: z.string(),\n  findings: z.array(reportFindingSchema),\n  attackPaths: z.array(z.object({\n    evaluationId: z.string(),\n    assetId: z.string(),\n    steps: z.array(attackPathStepSchema),\n    complexity: z.number(),\n    timeToCompromise: z.string().optional(),\n  })),\n  vulnerabilityBreakdown: z.object({\n    byType: z.record(z.string(), z.number()),\n    bySeverity: z.record(z.string(), z.number()),\n    byAsset: z.record(z.string(), z.number()),\n  }),\n  technicalDetails: z.array(z.object({\n    evaluationId: z.string(),\n    assetId: z.string(),\n    exposureType: z.string(),\n    technicalAnalysis: z.string(),\n    exploitCode: z.string().optional(),\n    mitigations: z.array(z.string()),\n  })),\n  executiveSummary: z.string().optional(),\n  recommendations: z.array(z.string()).optional(),\n});\n\nexport type TechnicalReport = z.infer<typeof technicalReportSchema>;\n\n// Compliance Report Schema\nexport const complianceReportSchema = z.object({\n  reportDate: z.string(),\n  framework: z.enum(complianceFrameworks),\n  organizationId: z.string(),\n  overallCompliance: z.number().min(0).max(100),\n  controlStatus: z.array(z.object({\n    controlId: z.string(),\n    controlName: z.string(),\n    status: z.enum([\"compliant\", \"non_compliant\", \"partial\", \"not_applicable\"]),\n    findings: z.array(z.string()),\n    remediationRequired: z.boolean(),\n    remediationDeadline: z.string().optional(),\n  })),\n  gaps: z.array(z.object({\n    controlId: z.string(),\n    gapDescription: z.string(),\n    severity: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n    remediationGuidance: z.string(),\n  })),\n  auditReadiness: z.object({\n    score: z.number().min(0).max(100),\n    readyControls: z.number(),\n    totalControls: z.number(),\n    priorityActions: z.array(z.string()),\n  }),\n  executiveSummary: z.string().optional(),\n  findings: z.array(z.object({\n    title: z.string(),\n    description: z.string(),\n    recommendation: z.string(),\n    severity: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n    status: z.enum([\"open\", \"closed\", \"in_progress\"]).optional(),\n  })).optional(),\n  recommendations: z.array(z.string()).optional(),\n  complianceStatus: z.record(z.string(), z.object({\n    status: z.string(),\n    coverage: z.number(),\n  })).optional(),\n});\n\nexport type ComplianceReport = z.infer<typeof complianceReportSchema>;\n\n// Reports Database Table\nexport const reports = pgTable(\"reports\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull().default(\"default\"),\n  reportType: varchar(\"report_type\").notNull(), // executive_summary, technical_deepdive, compliance_mapping, evidence_bundle\n  reportVersion: varchar(\"report_version\").notNull().default(\"v1_template\"), // v1_template or v2_narrative\n  title: text(\"title\").notNull(),\n  dateRangeFrom: timestamp(\"date_range_from\").notNull(),\n  dateRangeTo: timestamp(\"date_range_to\").notNull(),\n  framework: varchar(\"framework\"), // For compliance reports\n  status: varchar(\"status\").notNull().default(\"generating\"), // generating, completed, failed, draft, final\n  content: jsonb(\"content\"), // The actual report content\n  evaluationIds: jsonb(\"evaluation_ids\").$type<string[]>(), // Evaluations included\n  generatedBy: varchar(\"generated_by\"), // user/system identifier\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  completedAt: timestamp(\"completed_at\"),\n});\n\nexport const insertReportSchema = createInsertSchema(reports).omit({\n  id: true,\n  createdAt: true,\n  completedAt: true,\n});\n\nexport type InsertReport = z.infer<typeof insertReportSchema>;\nexport type Report = typeof reports.$inferSelect;\n\n// Report Narratives Table (V2 - ENO persistence)\nexport const reportNarratives = pgTable(\"report_narratives\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull().default(\"default\"),\n  evaluationId: varchar(\"evaluation_id\"), // Single evaluation reference\n  reportScopeId: varchar(\"report_scope_id\"), // For multi-evaluation reports\n  reportVersion: varchar(\"report_version\").notNull().default(\"v2_narrative\"),\n  enoJson: jsonb(\"eno_json\"), // The full ENO object\n  modelMeta: jsonb(\"model_meta\").$type<{\n    modelName: string;\n    promptHash: string;\n    temperature: number;\n    generationTimeMs: number;\n  }>(),\n  createdBy: varchar(\"created_by\"), // user/system identifier\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertReportNarrativeSchema = createInsertSchema(reportNarratives).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertReportNarrative = z.infer<typeof insertReportNarrativeSchema>;\nexport type ReportNarrative = typeof reportNarratives.$inferSelect;\n\n// ============================================================================\n// BATCH EVALUATION & SCHEDULING SCHEMAS\n// ============================================================================\n\n// Batch Job Status\nexport const batchJobStatuses = [\n  \"pending\",\n  \"running\",\n  \"completed\",\n  \"failed\",\n  \"cancelled\",\n] as const;\n\nexport type BatchJobStatus = typeof batchJobStatuses[number];\n\n// Schedule Frequency\nexport const scheduleFrequencies = [\n  \"once\",\n  \"daily\",\n  \"weekly\",\n  \"monthly\",\n  \"quarterly\",\n] as const;\n\nexport type ScheduleFrequency = typeof scheduleFrequencies[number];\n\n// Batch Evaluation Job\nexport const batchJobs = pgTable(\"batch_jobs\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull().default(\"default\"),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  assets: jsonb(\"assets\").$type<Array<{\n    assetId: string;\n    exposureType: string;\n    priority: string;\n    description: string;\n  }>>().notNull(),\n  status: varchar(\"status\").notNull().default(\"pending\"),\n  progress: integer(\"progress\").default(0), // 0-100\n  totalEvaluations: integer(\"total_evaluations\").notNull(),\n  completedEvaluations: integer(\"completed_evaluations\").default(0),\n  failedEvaluations: integer(\"failed_evaluations\").default(0),\n  evaluationIds: jsonb(\"evaluation_ids\").$type<string[]>(), // Created evaluation IDs\n  scheduledAt: timestamp(\"scheduled_at\"),\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertBatchJobSchema = createInsertSchema(batchJobs).omit({\n  id: true,\n  createdAt: true,\n  startedAt: true,\n  completedAt: true,\n  totalEvaluations: true,\n  completedEvaluations: true,\n  failedEvaluations: true,\n  evaluationIds: true,\n  progress: true,\n});\n\nexport type InsertBatchJob = z.infer<typeof insertBatchJobSchema>;\nexport type BatchJob = typeof batchJobs.$inferSelect;\n\n// Scheduled Scans\nexport const scheduledScans = pgTable(\"scheduled_scans\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull().default(\"default\"),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  assets: jsonb(\"assets\").$type<Array<{\n    assetId: string;\n    exposureType: string;\n    priority: string;\n    description: string;\n  }>>().notNull(),\n  frequency: varchar(\"frequency\").notNull(), // once, daily, weekly, monthly, quarterly\n  dayOfWeek: integer(\"day_of_week\"), // 0-6 for weekly\n  dayOfMonth: integer(\"day_of_month\"), // 1-31 for monthly\n  timeOfDay: varchar(\"time_of_day\"), // HH:MM format\n  enabled: boolean(\"enabled\").default(true),\n  lastRunAt: timestamp(\"last_run_at\"),\n  nextRunAt: timestamp(\"next_run_at\"),\n  lastBatchJobId: varchar(\"last_batch_job_id\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertScheduledScanSchema = createInsertSchema(scheduledScans).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  lastRunAt: true,\n  lastBatchJobId: true,\n});\n\nexport type InsertScheduledScan = z.infer<typeof insertScheduledScanSchema>;\nexport type ScheduledScan = typeof scheduledScans.$inferSelect;\n\n// Drift Detection / Comparison Result\nexport const driftResultSchema = z.object({\n  comparisonId: z.string(),\n  baselineEvaluationId: z.string(),\n  currentEvaluationId: z.string(),\n  assetId: z.string(),\n  comparedAt: z.string(),\n  changes: z.object({\n    scoreChange: z.number(), // Positive = worse, negative = better\n    exploitabilityChange: z.enum([\"became_exploitable\", \"became_safe\", \"unchanged\"]),\n    newFindings: z.array(z.string()),\n    resolvedFindings: z.array(z.string()),\n    severityChanges: z.array(z.object({\n      findingId: z.string(),\n      from: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n      to: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n    })),\n  }),\n  summary: z.string(),\n  riskTrend: z.enum([\"improving\", \"stable\", \"degrading\"]),\n});\n\nexport type DriftResult = z.infer<typeof driftResultSchema>;\n\n// Evaluation History for Drift Detection\nexport const evaluationHistory = pgTable(\"evaluation_history\", {\n  id: varchar(\"id\").primaryKey(),\n  assetId: varchar(\"asset_id\").notNull(),\n  evaluationId: varchar(\"evaluation_id\").notNull(),\n  batchJobId: varchar(\"batch_job_id\"),\n  scheduledScanId: varchar(\"scheduled_scan_id\"),\n  snapshot: jsonb(\"snapshot\").$type<{\n    exploitable: boolean;\n    score: number;\n    confidence: number;\n    findingSummary: string[];\n  }>(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertEvaluationHistorySchema = createInsertSchema(evaluationHistory).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertEvaluationHistory = z.infer<typeof insertEvaluationHistorySchema>;\nexport type EvaluationHistory = typeof evaluationHistory.$inferSelect;\n\n// ========== GOVERNANCE, SAFETY & TRUST CONTROLS ==========\n\n// Organization Governance Settings\nexport const organizationGovernance = pgTable(\"organization_governance\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull().unique(),\n  executionMode: varchar(\"execution_mode\").notNull().default(\"safe\"), // safe, live, simulation\n  killSwitchActive: boolean(\"kill_switch_active\").default(false),\n  killSwitchActivatedAt: timestamp(\"kill_switch_activated_at\"),\n  killSwitchActivatedBy: varchar(\"kill_switch_activated_by\"),\n  rateLimitPerHour: integer(\"rate_limit_per_hour\").default(100),\n  rateLimitPerDay: integer(\"rate_limit_per_day\").default(1000),\n  concurrentEvaluationsLimit: integer(\"concurrent_evaluations_limit\").default(5),\n  currentConcurrentEvaluations: integer(\"current_concurrent_evaluations\").default(0),\n  allowedTargetPatterns: jsonb(\"allowed_target_patterns\").$type<string[]>().default([]),\n  blockedTargetPatterns: jsonb(\"blocked_target_patterns\").$type<string[]>().default([]),\n  allowedNetworkRanges: jsonb(\"allowed_network_ranges\").$type<string[]>().default([]),\n  requireAuthorizationForLive: boolean(\"require_authorization_for_live\").default(true),\n  autoKillOnCritical: boolean(\"auto_kill_on_critical\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertOrganizationGovernanceSchema = createInsertSchema(organizationGovernance).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertOrganizationGovernance = z.infer<typeof insertOrganizationGovernanceSchema>;\nexport type OrganizationGovernance = typeof organizationGovernance.$inferSelect;\n\n// Authorization Log (Red-Team Activity Audit Trail)\nexport const authorizationLogActions = [\n  \"evaluation_started\",\n  \"evaluation_completed\",\n  \"kill_switch_activated\",\n  \"kill_switch_deactivated\",\n  \"execution_mode_changed\",\n  \"scope_rule_modified\",\n  \"rate_limit_exceeded\",\n  \"unauthorized_target_blocked\",\n  \"live_execution_authorized\",\n  \"batch_job_started\",\n  \"simulation_run\",\n] as const;\n\nexport type AuthorizationLogAction = typeof authorizationLogActions[number];\n\nexport const authorizationLogs = pgTable(\"authorization_logs\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull(),\n  userId: varchar(\"user_id\"),\n  userName: varchar(\"user_name\"),\n  action: varchar(\"action\").notNull(),\n  targetAsset: varchar(\"target_asset\"),\n  evaluationId: varchar(\"evaluation_id\"),\n  executionMode: varchar(\"execution_mode\"),\n  details: jsonb(\"details\").$type<Record<string, any>>(),\n  ipAddress: varchar(\"ip_address\"),\n  userAgent: varchar(\"user_agent\"),\n  authorized: boolean(\"authorized\").default(true),\n  authorizationReason: text(\"authorization_reason\"),\n  riskLevel: varchar(\"risk_level\"), // low, medium, high, critical\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertAuthorizationLogSchema = createInsertSchema(authorizationLogs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAuthorizationLog = z.infer<typeof insertAuthorizationLogSchema>;\nexport type AuthorizationLog = typeof authorizationLogs.$inferSelect;\n\n// Scope Rules (Target Whitelist/Blacklist)\nexport const scopeRules = pgTable(\"scope_rules\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  ruleType: varchar(\"rule_type\").notNull(), // allow, block\n  targetType: varchar(\"target_type\").notNull(), // ip, cidr, hostname, pattern\n  targetValue: text(\"target_value\").notNull(),\n  priority: integer(\"priority\").default(0), // Higher priority rules evaluated first\n  enabled: boolean(\"enabled\").default(true),\n  expiresAt: timestamp(\"expires_at\"),\n  createdBy: varchar(\"created_by\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertScopeRuleSchema = createInsertSchema(scopeRules).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertScopeRule = z.infer<typeof insertScopeRuleSchema>;\nexport type ScopeRule = typeof scopeRules.$inferSelect;\n\n// Rate Limit Tracking\nexport const rateLimitTracking = pgTable(\"rate_limit_tracking\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull(),\n  windowStart: timestamp(\"window_start\").notNull(),\n  windowType: varchar(\"window_type\").notNull(), // hour, day\n  requestCount: integer(\"request_count\").default(0),\n  evaluationCount: integer(\"evaluation_count\").default(0),\n  blockedCount: integer(\"blocked_count\").default(0),\n});\n\n// ========== ADVANCED / FUTURE DIFFERENTIATORS ==========\n\n// AI Adversary Profiles\nexport const adversaryProfiles = [\n  \"script_kiddie\",\n  \"opportunistic_criminal\", \n  \"organized_crime\",\n  \"insider_threat\",\n  \"nation_state\",\n  \"apt_group\",\n  \"hacktivist\",\n  \"competitor\",\n] as const;\n\nexport type AdversaryProfile = typeof adversaryProfiles[number];\n\nexport const aiAdversaryProfiles = pgTable(\"ai_adversary_profiles\", {\n  id: varchar(\"id\").primaryKey(),\n  name: varchar(\"name\").notNull(),\n  profileType: varchar(\"profile_type\").notNull(), // script_kiddie, nation_state, etc.\n  description: text(\"description\"),\n  capabilities: jsonb(\"capabilities\").$type<{\n    technicalSophistication: number; // 1-10\n    resources: number; // 1-10\n    persistence: number; // 1-10\n    stealth: number; // 1-10\n    targetedAttacks: boolean;\n    zerodays: boolean;\n    socialEngineering: boolean;\n    physicalAccess: boolean;\n  }>(),\n  typicalTTPs: jsonb(\"typical_ttps\").$type<string[]>(), // MITRE ATT&CK technique IDs\n  motivations: jsonb(\"motivations\").$type<string[]>(), // financial, espionage, disruption, etc.\n  targetPreferences: jsonb(\"target_preferences\").$type<string[]>(), // industries, asset types\n  avgDwellTime: integer(\"avg_dwell_time\"), // Days\n  detectionDifficulty: varchar(\"detection_difficulty\"), // low, medium, high, very_high\n  isBuiltIn: boolean(\"is_built_in\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertAiAdversaryProfileSchema = createInsertSchema(aiAdversaryProfiles).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAiAdversaryProfile = z.infer<typeof insertAiAdversaryProfileSchema>;\nexport type AiAdversaryProfile = typeof aiAdversaryProfiles.$inferSelect;\n\n// Attack Predictions\nexport const attackPredictions = pgTable(\"attack_predictions\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull(),\n  assetId: varchar(\"asset_id\"),\n  predictionDate: timestamp(\"prediction_date\").defaultNow(),\n  timeHorizon: varchar(\"time_horizon\").notNull(), // 7d, 30d, 90d\n  predictedAttackVectors: jsonb(\"predicted_attack_vectors\").$type<Array<{\n    vector: string;\n    likelihood: number; // 0-100\n    confidence: number; // 0-100\n    adversaryProfile: string;\n    estimatedImpact: string;\n    mitreAttackId: string;\n  }>>(),\n  overallBreachLikelihood: integer(\"overall_breach_likelihood\"), // 0-100\n  riskFactors: jsonb(\"risk_factors\").$type<Array<{\n    factor: string;\n    contribution: number; // percentage\n    trend: string; // increasing, stable, decreasing\n  }>>(),\n  recommendedActions: jsonb(\"recommended_actions\").$type<string[]>(),\n  modelVersion: varchar(\"model_version\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertAttackPredictionSchema = createInsertSchema(attackPredictions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAttackPrediction = z.infer<typeof insertAttackPredictionSchema>;\nexport type AttackPrediction = typeof attackPredictions.$inferSelect;\n\n// Defensive Posture Score\nexport const defensivePostureScores = pgTable(\"defensive_posture_scores\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull(),\n  calculatedAt: timestamp(\"calculated_at\").defaultNow(),\n  overallScore: integer(\"overall_score\").notNull(), // 0-100\n  categoryScores: jsonb(\"category_scores\").$type<{\n    networkSecurity: number;\n    applicationSecurity: number;\n    identityManagement: number;\n    dataProtection: number;\n    incidentResponse: number;\n    securityAwareness: number;\n    compliancePosture: number;\n  }>(),\n  breachLikelihood: integer(\"breach_likelihood\"), // 0-100\n  meanTimeToDetect: integer(\"mean_time_to_detect\"), // Hours\n  meanTimeToRespond: integer(\"mean_time_to_respond\"), // Hours\n  vulnerabilityExposure: jsonb(\"vulnerability_exposure\").$type<{\n    critical: number;\n    high: number;\n    medium: number;\n    low: number;\n  }>(),\n  trendDirection: varchar(\"trend_direction\"), // improving, stable, degrading\n  benchmarkPercentile: integer(\"benchmark_percentile\"), // vs industry\n  recommendations: jsonb(\"recommendations\").$type<string[]>(),\n});\n\nexport const insertDefensivePostureScoreSchema = createInsertSchema(defensivePostureScores).omit({\n  id: true,\n  calculatedAt: true,\n});\n\nexport type InsertDefensivePostureScore = z.infer<typeof insertDefensivePostureScoreSchema>;\nexport type DefensivePostureScore = typeof defensivePostureScores.$inferSelect;\n\n// Purple Team Feedback Loop\nexport const purpleTeamFindings = pgTable(\"purple_team_findings\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull(),\n  evaluationId: varchar(\"evaluation_id\"),\n  findingType: varchar(\"finding_type\").notNull(), // offensive_success, detection_gap, control_bypass\n  offensiveTechnique: varchar(\"offensive_technique\"), // MITRE ATT&CK ID\n  offensiveDescription: text(\"offensive_description\"),\n  detectionStatus: varchar(\"detection_status\"), // detected, partially_detected, missed\n  existingControl: text(\"existing_control\"),\n  controlEffectiveness: integer(\"control_effectiveness\"), // 0-100\n  defensiveRecommendation: text(\"defensive_recommendation\"),\n  implementationPriority: varchar(\"implementation_priority\"), // critical, high, medium, low\n  estimatedEffort: varchar(\"estimated_effort\"), // hours, days, weeks\n  feedbackStatus: varchar(\"feedback_status\").default(\"pending\"), // pending, in_progress, implemented, wont_fix\n  assignedTo: varchar(\"assigned_to\"),\n  resolvedAt: timestamp(\"resolved_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertPurpleTeamFindingSchema = createInsertSchema(purpleTeamFindings).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertPurpleTeamFinding = z.infer<typeof insertPurpleTeamFindingSchema>;\nexport type PurpleTeamFinding = typeof purpleTeamFindings.$inferSelect;\n\n// AI vs AI Simulation\nexport const aiSimulations = pgTable(\"ai_simulations\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  attackerProfileId: varchar(\"attacker_profile_id\"),\n  defenderConfig: jsonb(\"defender_config\").$type<{\n    detectionCapabilities: string[];\n    responseAutomation: boolean;\n    honeypots: boolean;\n    deception: boolean;\n  }>(),\n  targetEnvironment: jsonb(\"target_environment\").$type<{\n    assets: string[];\n    networkTopology: string;\n    securityControls: string[];\n  }>(),\n  simulationStatus: varchar(\"simulation_status\").default(\"pending\"), // pending, running, completed, failed\n  simulationResults: jsonb(\"simulation_results\").$type<{\n    attackerSuccesses: number;\n    defenderBlocks: number;\n    timeToDetection: number; // minutes\n    timeToContainment: number; // minutes\n    attackPath: string[];\n    detectionPoints: string[];\n    missedAttacks: string[];\n    recommendations: string[];\n  }>(),\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertAiSimulationSchema = createInsertSchema(aiSimulations).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAiSimulation = z.infer<typeof insertAiSimulationSchema>;\nexport type AiSimulation = typeof aiSimulations.$inferSelect;\n\n// ============================================\n// INFRASTRUCTURE DATA INGESTION TABLES\n// ============================================\n\n// Asset Status Types\nexport const assetStatuses = [\"active\", \"inactive\", \"decommissioned\", \"unknown\"] as const;\nexport type AssetStatus = typeof assetStatuses[number];\n\n// Asset Types\nexport const assetTypes = [\n  \"server\",\n  \"workstation\", \n  \"network_device\",\n  \"container\",\n  \"database\",\n  \"web_application\",\n  \"api_endpoint\",\n  \"cloud_instance\",\n  \"storage_bucket\",\n  \"lambda_function\",\n  \"kubernetes_cluster\",\n  \"load_balancer\",\n  \"firewall\",\n  \"iot_device\",\n  \"mobile_device\",\n  \"virtual_machine\",\n  \"other\"\n] as const;\nexport type AssetType = typeof assetTypes[number];\n\n// Cloud Providers\nexport const cloudProviders = [\"aws\", \"azure\", \"gcp\", \"oracle\", \"ibm\", \"other\"] as const;\nexport type CloudProvider = typeof cloudProviders[number];\n\n// Scanner Types\nexport const scannerTypes = [\n  \"nessus\",\n  \"qualys\", \n  \"tenable\",\n  \"rapid7\",\n  \"openvas\",\n  \"nmap\",\n  \"custom_csv\",\n  \"custom_json\",\n  \"api_import\"\n] as const;\nexport type ScannerType = typeof scannerTypes[number];\n\n// Import Job Status\nexport const importJobStatuses = [\"pending\", \"processing\", \"completed\", \"failed\", \"cancelled\"] as const;\nexport type ImportJobStatus = typeof importJobStatuses[number];\n\n// Discovered Assets - Normalized asset inventory\nexport const discoveredAssets = pgTable(\"discovered_assets\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull().default(\"default\"),\n  assetIdentifier: varchar(\"asset_identifier\").notNull(), // IP, hostname, ARN, etc.\n  displayName: text(\"display_name\"),\n  assetType: varchar(\"asset_type\").notNull(), // One of assetTypes\n  status: varchar(\"status\").default(\"active\"), // One of assetStatuses\n  \n  // Network info\n  ipAddresses: jsonb(\"ip_addresses\").$type<string[]>(),\n  hostname: varchar(\"hostname\"),\n  fqdn: varchar(\"fqdn\"),\n  macAddress: varchar(\"mac_address\"),\n  \n  // Cloud info\n  cloudProvider: varchar(\"cloud_provider\"), // One of cloudProviders\n  cloudRegion: varchar(\"cloud_region\"),\n  cloudAccountId: varchar(\"cloud_account_id\"),\n  cloudResourceId: varchar(\"cloud_resource_id\"), // ARN, resource ID, etc.\n  cloudTags: jsonb(\"cloud_tags\").$type<Record<string, string>>(),\n  \n  // OS/Software info\n  operatingSystem: varchar(\"operating_system\"),\n  osVersion: varchar(\"os_version\"),\n  installedSoftware: jsonb(\"installed_software\").$type<Array<{\n    name: string;\n    version: string;\n    vendor?: string;\n  }>>(),\n  \n  // Services/Ports\n  openPorts: jsonb(\"open_ports\").$type<Array<{\n    port: number;\n    protocol: string;\n    service?: string;\n    version?: string;\n  }>>(),\n  \n  // Business context\n  businessUnit: varchar(\"business_unit\"),\n  owner: varchar(\"owner\"),\n  criticality: varchar(\"criticality\").default(\"medium\"), // critical, high, medium, low\n  environment: varchar(\"environment\"), // production, staging, development\n  \n  // Metadata\n  lastSeen: timestamp(\"last_seen\"),\n  firstDiscovered: timestamp(\"first_discovered\").defaultNow(),\n  discoverySource: varchar(\"discovery_source\"), // Which import/scan found it\n  importJobId: varchar(\"import_job_id\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertDiscoveredAssetSchema = createInsertSchema(discoveredAssets).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertDiscoveredAsset = z.infer<typeof insertDiscoveredAssetSchema>;\nexport type DiscoveredAsset = typeof discoveredAssets.$inferSelect;\n\n// Vulnerability Severity\nexport const vulnSeverities = [\"critical\", \"high\", \"medium\", \"low\", \"informational\"] as const;\nexport type VulnSeverity = typeof vulnSeverities[number];\n\n// Vulnerability Imports - Imported scanner findings\nexport const vulnerabilityImports = pgTable(\"vulnerability_imports\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull().default(\"default\"),\n  importJobId: varchar(\"import_job_id\").notNull(),\n  assetId: varchar(\"asset_id\"), // Reference to discoveredAssets\n  \n  // Core vulnerability data\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  severity: varchar(\"severity\").notNull(), // One of vulnSeverities\n  cveId: varchar(\"cve_id\"), // CVE-XXXX-XXXXX\n  cvssScore: integer(\"cvss_score\"), // 0-100 (stored as x10 for precision)\n  cvssVector: varchar(\"cvss_vector\"),\n  \n  // Scanner-specific data\n  scannerPluginId: varchar(\"scanner_plugin_id\"),\n  scannerName: varchar(\"scanner_name\"),\n  scannerSeverity: varchar(\"scanner_severity\"), // Original severity from scanner\n  \n  // Affected resource\n  affectedHost: varchar(\"affected_host\"),\n  affectedPort: integer(\"affected_port\"),\n  affectedService: varchar(\"affected_service\"),\n  affectedSoftware: varchar(\"affected_software\"),\n  affectedVersion: varchar(\"affected_version\"),\n  \n  // Remediation info\n  solution: text(\"solution\"),\n  solutionType: varchar(\"solution_type\"), // patch, workaround, upgrade, configuration\n  patchAvailable: boolean(\"patch_available\"),\n  exploitAvailable: boolean(\"exploit_available\"),\n  \n  // References\n  references: jsonb(\"references\").$type<Array<{\n    type: string; // cve, cwe, url, vendor\n    value: string;\n  }>>(),\n  \n  // Status tracking\n  status: varchar(\"status\").default(\"open\"), // open, remediated, accepted, false_positive\n  assignedTo: varchar(\"assigned_to\"),\n  dueDate: timestamp(\"due_date\"),\n  \n  // Link to AEV evaluation if analyzed\n  aevEvaluationId: varchar(\"aev_evaluation_id\"),\n  \n  // Raw data preservation\n  rawData: jsonb(\"raw_data\"), // Original scanner output\n  \n  detectedAt: timestamp(\"detected_at\"), // When scanner found it\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertVulnerabilityImportSchema = createInsertSchema(vulnerabilityImports).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertVulnerabilityImport = z.infer<typeof insertVulnerabilityImportSchema>;\nexport type VulnerabilityImport = typeof vulnerabilityImports.$inferSelect;\n\n// Import Jobs - Track bulk import status\nexport const importJobs = pgTable(\"import_jobs\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull().default(\"default\"),\n  \n  // Job info\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  sourceType: varchar(\"source_type\").notNull(), // One of scannerTypes\n  \n  // File info (for file uploads)\n  fileName: varchar(\"file_name\"),\n  fileSize: integer(\"file_size\"),\n  fileMimeType: varchar(\"file_mime_type\"),\n  \n  // Status tracking\n  status: varchar(\"status\").default(\"pending\"), // One of importJobStatuses\n  progress: integer(\"progress\").default(0), // 0-100\n  \n  // Results\n  totalRecords: integer(\"total_records\").default(0),\n  processedRecords: integer(\"processed_records\").default(0),\n  successfulRecords: integer(\"successful_records\").default(0),\n  failedRecords: integer(\"failed_records\").default(0),\n  skippedRecords: integer(\"skipped_records\").default(0),\n  \n  // Asset/Vuln counts\n  assetsDiscovered: integer(\"assets_discovered\").default(0),\n  vulnerabilitiesFound: integer(\"vulnerabilities_found\").default(0),\n  \n  // Error tracking\n  errors: jsonb(\"errors\").$type<Array<{\n    line?: number;\n    record?: string;\n    error: string;\n  }>>(),\n  \n  // Processing info\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  \n  // User who initiated\n  initiatedBy: varchar(\"initiated_by\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertImportJobSchema = createInsertSchema(importJobs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertImportJob = z.infer<typeof insertImportJobSchema>;\nexport type ImportJob = typeof importJobs.$inferSelect;\n\n// Cloud Connection Status\nexport const cloudConnectionStatuses = [\"connected\", \"disconnected\", \"error\", \"pending\"] as const;\nexport type CloudConnectionStatus = typeof cloudConnectionStatuses[number];\n\n// Cloud Connections - Store cloud API credentials\nexport const cloudConnections = pgTable(\"cloud_connections\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull().default(\"default\"),\n  \n  // Connection info\n  name: text(\"name\").notNull(),\n  provider: varchar(\"provider\").notNull(), // One of cloudProviders\n  \n  // AWS-specific\n  awsAccessKeyId: varchar(\"aws_access_key_id\"),\n  awsRegions: jsonb(\"aws_regions\").$type<string[]>(),\n  awsAssumeRoleArn: varchar(\"aws_assume_role_arn\"),\n  \n  // Azure-specific\n  azureTenantId: varchar(\"azure_tenant_id\"),\n  azureClientId: varchar(\"azure_client_id\"),\n  azureSubscriptionIds: jsonb(\"azure_subscription_ids\").$type<string[]>(),\n  \n  // GCP-specific\n  gcpProjectIds: jsonb(\"gcp_project_ids\").$type<string[]>(),\n  gcpServiceAccountEmail: varchar(\"gcp_service_account_email\"),\n  \n  // Status\n  status: varchar(\"status\").default(\"pending\"), // One of cloudConnectionStatuses\n  lastSyncAt: timestamp(\"last_sync_at\"),\n  lastSyncStatus: varchar(\"last_sync_status\"),\n  lastError: text(\"last_error\"),\n  \n  // Sync configuration\n  syncEnabled: boolean(\"sync_enabled\").default(true),\n  syncInterval: integer(\"sync_interval\").default(3600), // Seconds\n  \n  // Stats\n  assetsDiscovered: integer(\"assets_discovered\").default(0),\n  lastAssetCount: integer(\"last_asset_count\").default(0),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertCloudConnectionSchema = createInsertSchema(cloudConnections).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertCloudConnection = z.infer<typeof insertCloudConnectionSchema>;\nexport type CloudConnection = typeof cloudConnections.$inferSelect;\n\n// ============================================\n// ENDPOINT AGENT SYSTEM\n// ============================================\n\n// Agent Status\nexport const agentStatuses = [\"online\", \"offline\", \"stale\", \"error\"] as const;\nexport type AgentStatus = typeof agentStatuses[number];\n\n// Agent Platform Types\nexport const agentPlatforms = [\"linux\", \"windows\", \"macos\", \"container\", \"kubernetes\", \"other\"] as const;\nexport type AgentPlatform = typeof agentPlatforms[number];\n\n// Endpoint Agents - Registered agents\nexport const endpointAgents = pgTable(\"endpoint_agents\", {\n  id: varchar(\"id\").primaryKey(),\n  organizationId: varchar(\"organization_id\").notNull().default(\"default\"),\n  \n  // Agent identity\n  agentName: text(\"agent_name\").notNull(),\n  apiKey: varchar(\"api_key\").notNull().unique(), // For authentication\n  apiKeyHash: varchar(\"api_key_hash\"), // Hashed version for verification\n  \n  // Host information\n  hostname: varchar(\"hostname\"),\n  platform: varchar(\"platform\"), // One of agentPlatforms\n  platformVersion: varchar(\"platform_version\"),\n  architecture: varchar(\"architecture\"), // x86_64, arm64, etc.\n  \n  // Network info\n  ipAddresses: jsonb(\"ip_addresses\").$type<string[]>(),\n  macAddresses: jsonb(\"mac_addresses\").$type<string[]>(),\n  \n  // Agent metadata\n  agentVersion: varchar(\"agent_version\"),\n  capabilities: jsonb(\"capabilities\").$type<string[]>(), // service_scan, vuln_detect, config_audit, etc.\n  \n  // Status tracking\n  status: varchar(\"status\").default(\"offline\"), // One of agentStatuses\n  lastHeartbeat: timestamp(\"last_heartbeat\"),\n  lastTelemetry: timestamp(\"last_telemetry\"),\n  \n  // Configuration\n  telemetryInterval: integer(\"telemetry_interval\").default(300), // seconds\n  scanEnabled: boolean(\"scan_enabled\").default(true),\n  configAuditEnabled: boolean(\"config_audit_enabled\").default(true),\n  \n  // Tags for organization\n  tags: jsonb(\"tags\").$type<string[]>(),\n  environment: varchar(\"environment\"), // production, staging, development\n  \n  registeredAt: timestamp(\"registered_at\").defaultNow(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertEndpointAgentSchema = createInsertSchema(endpointAgents).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  registeredAt: true,\n});\n\nexport type InsertEndpointAgent = z.infer<typeof insertEndpointAgentSchema>;\nexport type EndpointAgent = typeof endpointAgents.$inferSelect;\n\n// Agent Telemetry - Live data from agents\nexport const agentTelemetry = pgTable(\"agent_telemetry\", {\n  id: varchar(\"id\").primaryKey(),\n  agentId: varchar(\"agent_id\").notNull(),\n  organizationId: varchar(\"organization_id\").notNull().default(\"default\"),\n  \n  // System info\n  systemInfo: jsonb(\"system_info\").$type<{\n    hostname: string;\n    platform: string;\n    platformVersion: string;\n    kernel: string;\n    architecture: string;\n    uptime: number;\n    bootTime: string;\n  }>(),\n  \n  // Resource metrics\n  resourceMetrics: jsonb(\"resource_metrics\").$type<{\n    cpuUsage: number;\n    memoryTotal: number;\n    memoryUsed: number;\n    memoryPercent: number;\n    diskTotal: number;\n    diskUsed: number;\n    diskPercent: number;\n  }>(),\n  \n  // Running services\n  services: jsonb(\"services\").$type<Array<{\n    name: string;\n    version?: string;\n    port?: number;\n    protocol?: string;\n    status: string;\n    pid?: number;\n  }>>(),\n  \n  // Open ports\n  openPorts: jsonb(\"open_ports\").$type<Array<{\n    port: number;\n    protocol: string;\n    service?: string;\n    state: string;\n    localAddress: string;\n    remoteAddress?: string;\n  }>>(),\n  \n  // Network connections\n  networkConnections: jsonb(\"network_connections\").$type<Array<{\n    localAddress: string;\n    localPort: number;\n    remoteAddress: string;\n    remotePort: number;\n    protocol: string;\n    state: string;\n    process?: string;\n  }>>(),\n  \n  // Installed software\n  installedSoftware: jsonb(\"installed_software\").$type<Array<{\n    name: string;\n    version: string;\n    vendor?: string;\n    installDate?: string;\n  }>>(),\n  \n  // Configuration data\n  configData: jsonb(\"config_data\").$type<Record<string, any>>(),\n  \n  // Security findings from agent\n  securityFindings: jsonb(\"security_findings\").$type<Array<{\n    type: string; // outdated_software, weak_config, open_port, etc.\n    severity: string;\n    title: string;\n    description: string;\n    affectedComponent: string;\n    recommendation?: string;\n  }>>(),\n  \n  // Raw data for debugging\n  rawData: jsonb(\"raw_data\"),\n  \n  collectedAt: timestamp(\"collected_at\").notNull(),\n  receivedAt: timestamp(\"received_at\").defaultNow(),\n});\n\nexport const insertAgentTelemetrySchema = createInsertSchema(agentTelemetry).omit({\n  id: true,\n  receivedAt: true,\n});\n\nexport type InsertAgentTelemetry = z.infer<typeof insertAgentTelemetrySchema>;\nexport type AgentTelemetry = typeof agentTelemetry.$inferSelect;\n\n// Agent Findings - Security issues detected by agents\nexport const agentFindingStatuses = [\"new\", \"acknowledged\", \"in_progress\", \"resolved\", \"false_positive\"] as const;\nexport type AgentFindingStatus = typeof agentFindingStatuses[number];\n\nexport const agentFindings = pgTable(\"agent_findings\", {\n  id: varchar(\"id\").primaryKey(),\n  agentId: varchar(\"agent_id\").notNull(),\n  organizationId: varchar(\"organization_id\").notNull().default(\"default\"),\n  telemetryId: varchar(\"telemetry_id\"), // Reference to source telemetry\n  \n  // Finding details\n  findingType: varchar(\"finding_type\").notNull(), // outdated_software, weak_config, open_port, cve_detected, etc.\n  severity: varchar(\"severity\").notNull(), // critical, high, medium, low, informational\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  \n  // Affected component\n  affectedComponent: varchar(\"affected_component\"),\n  affectedVersion: varchar(\"affected_version\"),\n  affectedPort: integer(\"affected_port\"),\n  affectedService: varchar(\"affected_service\"),\n  \n  // CVE info if applicable\n  cveId: varchar(\"cve_id\"),\n  cvssScore: integer(\"cvss_score\"),\n  \n  // Remediation\n  recommendation: text(\"recommendation\"),\n  \n  // Status tracking\n  status: varchar(\"status\").default(\"new\"), // One of agentFindingStatuses\n  assignedTo: varchar(\"assigned_to\"),\n  \n  // Link to AEV evaluation if auto-triggered\n  aevEvaluationId: varchar(\"aev_evaluation_id\"),\n  autoEvaluationTriggered: boolean(\"auto_evaluation_triggered\").default(false),\n  \n  // Timestamps\n  detectedAt: timestamp(\"detected_at\").notNull(),\n  acknowledgedAt: timestamp(\"acknowledged_at\"),\n  resolvedAt: timestamp(\"resolved_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertAgentFindingSchema = createInsertSchema(agentFindings).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertAgentFinding = z.infer<typeof insertAgentFindingSchema>;\nexport type AgentFinding = typeof agentFindings.$inferSelect;\n","path":null,"size_bytes":76305,"size_tokens":null},"client/src/components/EvaluationTable.tsx":{"content":"import { useState } from \"react\";\nimport { \n  ChevronDown, \n  ChevronUp, \n  Eye, \n  Play, \n  AlertTriangle, \n  Shield, \n  Activity, \n  Target, \n  Zap,\n  CheckCircle,\n  Clock,\n  XCircle,\n  Loader2\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\n\nexport interface Evaluation {\n  id: string;\n  assetId: string;\n  exposureType: \"cve\" | \"misconfiguration\" | \"behavior\" | \"network\" | \"business_logic\" | \"api_abuse\";\n  priority: \"critical\" | \"high\" | \"medium\" | \"low\";\n  status: \"pending\" | \"in_progress\" | \"completed\" | \"failed\";\n  exploitable?: boolean;\n  score?: number;\n  confidence?: number;\n  createdAt: string;\n}\n\ninterface EvaluationTableProps {\n  evaluations: Evaluation[];\n  onViewDetails: (evaluation: Evaluation) => void;\n  onRunEvaluation: (evaluation: Evaluation) => void;\n}\n\ntype SortField = \"createdAt\" | \"priority\" | \"status\" | \"score\";\n\nexport function EvaluationTable({ evaluations, onViewDetails, onRunEvaluation }: EvaluationTableProps) {\n  const [sortField, setSortField] = useState<SortField>(\"createdAt\");\n  const [sortOrder, setSortOrder] = useState<\"asc\" | \"desc\">(\"desc\");\n\n  const toggleSort = (field: SortField) => {\n    if (sortField === field) {\n      setSortOrder(sortOrder === \"asc\" ? \"desc\" : \"asc\");\n    } else {\n      setSortField(field);\n      setSortOrder(\"desc\");\n    }\n  };\n\n  const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };\n  const statusOrder = { in_progress: 0, pending: 1, completed: 2, failed: 3 };\n\n  const sortedEvaluations = [...evaluations].sort((a, b) => {\n    let comparison = 0;\n    if (sortField === \"createdAt\") {\n      comparison = new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime();\n    } else if (sortField === \"priority\") {\n      comparison = priorityOrder[a.priority] - priorityOrder[b.priority];\n    } else if (sortField === \"status\") {\n      comparison = statusOrder[a.status] - statusOrder[b.status];\n    } else if (sortField === \"score\") {\n      comparison = (a.score || 0) - (b.score || 0);\n    }\n    return sortOrder === \"asc\" ? comparison : -comparison;\n  });\n\n  const getExposureIcon = (type: string) => {\n    switch (type) {\n      case \"cve\": return <AlertTriangle className=\"h-4 w-4 text-orange-400\" />;\n      case \"misconfiguration\": return <Shield className=\"h-4 w-4 text-blue-400\" />;\n      case \"behavior\": return <Activity className=\"h-4 w-4 text-purple-400\" />;\n      case \"network\": return <Target className=\"h-4 w-4 text-cyan-400\" />;\n      case \"business_logic\": return <Zap className=\"h-4 w-4 text-amber-400\" />;\n      case \"api_abuse\": return <Zap className=\"h-4 w-4 text-pink-400\" />;\n      default: return <Zap className=\"h-4 w-4 text-gray-400\" />;\n    }\n  };\n\n  const getStatusBadge = (status: string, exploitable?: boolean) => {\n    if (status === \"completed\" && exploitable === true) {\n      return <Badge variant=\"destructive\" className=\"bg-red-500/10 text-red-400 border-red-500/30\">EXPLOITABLE</Badge>;\n    }\n    if (status === \"completed\" && exploitable === false) {\n      return <Badge className=\"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\">SAFE</Badge>;\n    }\n    switch (status) {\n      case \"in_progress\":\n        return <Badge className=\"bg-amber-500/10 text-amber-400 border-amber-500/30\"><Loader2 className=\"h-3 w-3 mr-1 animate-spin\" />Running</Badge>;\n      case \"pending\":\n        return <Badge className=\"bg-blue-500/10 text-blue-400 border-blue-500/30\"><Clock className=\"h-3 w-3 mr-1\" />Pending</Badge>;\n      case \"failed\":\n        return <Badge variant=\"destructive\" className=\"bg-red-500/10 text-red-400 border-red-500/30\"><XCircle className=\"h-3 w-3 mr-1\" />Failed</Badge>;\n      default:\n        return <Badge variant=\"secondary\">{status}</Badge>;\n    }\n  };\n\n  const getPriorityBadge = (priority: string) => {\n    const classes: Record<string, string> = {\n      critical: \"bg-red-500/10 text-red-400 border-red-500/30\",\n      high: \"bg-orange-500/10 text-orange-400 border-orange-500/30\",\n      medium: \"bg-amber-500/10 text-amber-400 border-amber-500/30\",\n      low: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\",\n    };\n    return <Badge className={classes[priority] || \"\"}>{priority.toUpperCase()}</Badge>;\n  };\n\n  const SortIcon = ({ field }: { field: SortField }) => {\n    if (sortField !== field) return <ChevronDown className=\"h-3 w-3 opacity-30\" />;\n    return sortOrder === \"asc\" ? <ChevronUp className=\"h-3 w-3\" /> : <ChevronDown className=\"h-3 w-3\" />;\n  };\n\n  return (\n    <div className=\"bg-card border border-border rounded-lg overflow-hidden\">\n      <div className=\"overflow-x-auto\">\n        <table className=\"w-full\">\n          <thead>\n            <tr className=\"border-b border-border bg-muted/30\">\n              <th className=\"px-4 py-3 text-left text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                Asset\n              </th>\n              <th className=\"px-4 py-3 text-left text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                Type\n              </th>\n              <th \n                className=\"px-4 py-3 text-left text-xs uppercase tracking-wider text-muted-foreground font-medium cursor-pointer hover:text-foreground\"\n                onClick={() => toggleSort(\"priority\")}\n              >\n                <div className=\"flex items-center gap-1\">\n                  Priority <SortIcon field=\"priority\" />\n                </div>\n              </th>\n              <th \n                className=\"px-4 py-3 text-left text-xs uppercase tracking-wider text-muted-foreground font-medium cursor-pointer hover:text-foreground\"\n                onClick={() => toggleSort(\"status\")}\n              >\n                <div className=\"flex items-center gap-1\">\n                  Status <SortIcon field=\"status\" />\n                </div>\n              </th>\n              <th \n                className=\"px-4 py-3 text-left text-xs uppercase tracking-wider text-muted-foreground font-medium cursor-pointer hover:text-foreground\"\n                onClick={() => toggleSort(\"score\")}\n              >\n                <div className=\"flex items-center gap-1\">\n                  Risk Score <SortIcon field=\"score\" />\n                </div>\n              </th>\n              <th \n                className=\"px-4 py-3 text-left text-xs uppercase tracking-wider text-muted-foreground font-medium cursor-pointer hover:text-foreground\"\n                onClick={() => toggleSort(\"createdAt\")}\n              >\n                <div className=\"flex items-center gap-1\">\n                  Created <SortIcon field=\"createdAt\" />\n                </div>\n              </th>\n              <th className=\"px-4 py-3 text-right text-xs uppercase tracking-wider text-muted-foreground font-medium\">\n                Actions\n              </th>\n            </tr>\n          </thead>\n          <tbody className=\"divide-y divide-border\">\n            {sortedEvaluations.map((evaluation) => (\n              <tr \n                key={evaluation.id} \n                className=\"hover:bg-muted/20 transition-colors group\"\n                data-testid={`row-evaluation-${evaluation.id}`}\n              >\n                <td className=\"px-4 py-3\">\n                  <div className=\"flex items-center gap-2\">\n                    <code className=\"text-sm font-mono text-foreground\">{evaluation.assetId}</code>\n                  </div>\n                </td>\n                <td className=\"px-4 py-3\">\n                  <div className=\"flex items-center gap-2\">\n                    {getExposureIcon(evaluation.exposureType)}\n                    <span className=\"text-sm text-muted-foreground capitalize\">\n                      {evaluation.exposureType.replace(\"_\", \" \")}\n                    </span>\n                  </div>\n                </td>\n                <td className=\"px-4 py-3\">{getPriorityBadge(evaluation.priority)}</td>\n                <td className=\"px-4 py-3\">{getStatusBadge(evaluation.status, evaluation.exploitable)}</td>\n                <td className=\"px-4 py-3\">\n                  {evaluation.score !== undefined ? (\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-16 h-1.5 bg-muted rounded-full overflow-hidden\">\n                        <div \n                          className={`h-full rounded-full ${\n                            evaluation.score >= 80 ? \"bg-red-500\" :\n                            evaluation.score >= 60 ? \"bg-orange-500\" :\n                            evaluation.score >= 40 ? \"bg-amber-500\" :\n                            \"bg-emerald-500\"\n                          }`}\n                          style={{ width: `${evaluation.score}%` }}\n                        />\n                      </div>\n                      <span className={`text-sm font-mono ${\n                        evaluation.score >= 80 ? \"text-red-400\" :\n                        evaluation.score >= 60 ? \"text-orange-400\" :\n                        evaluation.score >= 40 ? \"text-amber-400\" :\n                        \"text-emerald-400\"\n                      }`}>\n                        {evaluation.score}\n                      </span>\n                    </div>\n                  ) : (\n                    <span className=\"text-muted-foreground\"></span>\n                  )}\n                </td>\n                <td className=\"px-4 py-3\">\n                  <span className=\"text-sm text-muted-foreground\">\n                    {new Date(evaluation.createdAt).toLocaleDateString()}\n                  </span>\n                </td>\n                <td className=\"px-4 py-3\">\n                  <div className=\"flex items-center justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\"\n                      onClick={() => onViewDetails(evaluation)}\n                      data-testid={`button-view-${evaluation.id}`}\n                    >\n                      <Eye className=\"h-4 w-4\" />\n                    </Button>\n                    {evaluation.status !== \"in_progress\" && (\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\"\n                        onClick={() => onRunEvaluation(evaluation)}\n                        data-testid={`button-run-${evaluation.id}`}\n                      >\n                        <Play className=\"h-4 w-4\" />\n                      </Button>\n                    )}\n                  </div>\n                </td>\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10643,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1383,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"client/src/components/examples/AttackPathVisualizer.tsx":{"content":"import { AttackPathVisualizer } from \"../AttackPathVisualizer\";\n\nconst mockSteps = [\n  {\n    id: 1,\n    title: \"Initial Access via Malformed Header\",\n    description: \"Exploit CVE-2024-1234 by sending crafted X-Forwarded-For header\",\n    technique: \"T1190\",\n    severity: \"critical\" as const,\n  },\n  {\n    id: 2,\n    title: \"Privilege Escalation\",\n    description: \"Leverage misconfigured IAM role to gain elevated permissions\",\n    technique: \"T1068\",\n    severity: \"high\" as const,\n  },\n  {\n    id: 3,\n    title: \"Lateral Movement to Database\",\n    description: \"Use compromised credentials to access internal database\",\n    technique: \"T1021\",\n    severity: \"high\" as const,\n  },\n  {\n    id: 4,\n    title: \"Data Exfiltration\",\n    description: \"Extract sensitive customer PII via DNS tunneling\",\n    technique: \"T1048\",\n    severity: \"critical\" as const,\n  },\n];\n\nexport default function AttackPathVisualizerExample() {\n  return (\n    <div className=\"p-6 bg-card rounded-lg border border-border max-w-2xl mx-auto\">\n      <AttackPathVisualizer steps={mockSteps} isExploitable={true} />\n    </div>\n  );\n}\n","path":null,"size_bytes":1106,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":4050,"size_tokens":null},"client/src/components/examples/Dashboard.tsx":{"content":"import { Dashboard } from \"../Dashboard\";\nimport { ThemeProvider } from \"../ThemeProvider\";\n\nexport default function DashboardExample() {\n  return (\n    <ThemeProvider>\n      <div className=\"p-6\">\n        <Dashboard />\n      </div>\n    </ThemeProvider>\n  );\n}\n","path":null,"size_bytes":260,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/components/ThemeProvider.tsx":{"content":"import { createContext, useContext, useEffect, useState } from \"react\";\n\ntype Theme = \"dark\" | \"light\";\n\ntype ThemeContextType = {\n  theme: Theme;\n  setTheme: (theme: Theme) => void;\n  toggleTheme: () => void;\n};\n\nconst ThemeContext = createContext<ThemeContextType | undefined>(undefined);\n\nexport function ThemeProvider({ children }: { children: React.ReactNode }) {\n  const [theme, setTheme] = useState<Theme>(() => {\n    if (typeof window !== \"undefined\") {\n      const stored = localStorage.getItem(\"nexus-theme\") as Theme;\n      return stored || \"dark\";\n    }\n    return \"dark\";\n  });\n\n  useEffect(() => {\n    const root = window.document.documentElement;\n    root.classList.remove(\"light\", \"dark\");\n    root.classList.add(theme);\n    localStorage.setItem(\"nexus-theme\", theme);\n  }, [theme]);\n\n  const toggleTheme = () => {\n    setTheme(theme === \"dark\" ? \"light\" : \"dark\");\n  };\n\n  return (\n    <ThemeContext.Provider value={{ theme, setTheme, toggleTheme }}>\n      {children}\n    </ThemeContext.Provider>\n  );\n}\n\nexport function useTheme() {\n  const context = useContext(ThemeContext);\n  if (!context) {\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":1206,"size_tokens":null},"attached_assets/AEVProgressModal_1765772491190.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport {\n  Zap,\n  Search,\n  Link,\n  Shield,\n  Lightbulb,\n  CheckCircle,\n  Loader2,\n  AlertTriangle,\n  X,\n  Target,\n} from \"lucide-react\";\n\nexport interface AEVProgressData {\n  evaluationId: string;\n  progress: number;\n  stage: string;\n  currentStage?: number;\n  stageName?: string;\n  stageDetails?: string;\n}\n\nexport interface AEVCompleteData {\n  evaluationId: string;\n  exploitable: boolean;\n  confidence: number;\n  score: number;\n  status: string;\n  error?: string;\n}\n\ninterface AEVProgressModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  evaluationId: string | null;\n  progress: AEVProgressData | null;\n  result: AEVCompleteData | null;\n  assetId?: string;\n}\n\ninterface Stage {\n  id: number;\n  name: string;\n  description: string;\n  icon: typeof Search;\n  progressRange: [number, number];\n}\n\nconst stages: Stage[] = [\n  {\n    id: 1,\n    name: \"Analyzing Exposure\",\n    description: \"Examining vulnerability characteristics and attack surface\",\n    icon: Search,\n    progressRange: [0, 25],\n  },\n  {\n    id: 2,\n    name: \"Simulating Exploit Chain\",\n    description: \"Testing potential attack vectors and exploit paths\",\n    icon: Link,\n    progressRange: [25, 50],\n  },\n  {\n    id: 3,\n    name: \"Impact Assessment\",\n    description: \"Evaluating potential damage and blast radius\",\n    icon: Shield,\n    progressRange: [50, 75],\n  },\n  {\n    id: 4,\n    name: \"Recommendations\",\n    description: \"Generating remediation strategies and mitigations\",\n    icon: Lightbulb,\n    progressRange: [75, 100],\n  },\n];\n\nfunction getCurrentStage(progress: number): number {\n  for (let i = stages.length - 1; i >= 0; i--) {\n    if (progress >= stages[i].progressRange[0]) {\n      return i + 1;\n    }\n  }\n  return 1;\n}\n\nfunction getStageProgress(stageId: number, overallProgress: number): \"pending\" | \"active\" | \"complete\" {\n  const stage = stages[stageId - 1];\n  if (!stage) return \"pending\";\n  \n  if (overallProgress >= stage.progressRange[1]) {\n    return \"complete\";\n  } else if (overallProgress >= stage.progressRange[0]) {\n    return \"active\";\n  }\n  return \"pending\";\n}\n\nexport function AEVProgressModal({\n  isOpen,\n  onClose,\n  evaluationId,\n  progress,\n  result,\n  assetId,\n}: AEVProgressModalProps) {\n  const [currentProgress, setCurrentProgress] = useState(0);\n  const [showResult, setShowResult] = useState(false);\n\n  useEffect(() => {\n    if (progress) {\n      setCurrentProgress(progress.progress);\n    }\n  }, [progress]);\n\n  useEffect(() => {\n    if (result) {\n      setCurrentProgress(100);\n      setTimeout(() => setShowResult(true), 500);\n    } else {\n      setShowResult(false);\n    }\n  }, [result]);\n\n  useEffect(() => {\n    if (!isOpen) {\n      setCurrentProgress(0);\n      setShowResult(false);\n    }\n  }, [isOpen]);\n\n  if (!isOpen) return null;\n\n  const isComplete = result?.status === \"completed\";\n  const isFailed = result?.status === \"failed\";\n  const currentStage = getCurrentStage(currentProgress);\n\n  return (\n    <div className=\"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4\">\n      <div \n        className=\"bg-card border border-border rounded-xl w-full max-w-lg shadow-2xl overflow-hidden\"\n        data-testid=\"aev-progress-modal\"\n      >\n        <div className=\"bg-gradient-to-r from-primary/20 to-orange-500/20 border-b border-border p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 bg-primary/20 rounded-lg\">\n                <Zap className=\"h-5 w-5 text-primary\" />\n              </div>\n              <div>\n                <h3 className=\"font-semibold text-foreground\">AEV Evaluation</h3>\n                <p className=\"text-xs text-muted-foreground\">\n                  {assetId ? `Target: ${assetId}` : evaluationId || \"Processing...\"}\n                </p>\n              </div>\n            </div>\n            {(isComplete || isFailed) && (\n              <button\n                onClick={onClose}\n                className=\"p-1.5 hover:bg-muted rounded-lg transition-colors\"\n                data-testid=\"button-close-progress\"\n              >\n                <X className=\"h-4 w-4\" />\n              </button>\n            )}\n          </div>\n        </div>\n\n        <div className=\"p-6\">\n          {!showResult ? (\n            <>\n              <div className=\"mb-6\">\n                <div className=\"flex justify-between text-sm mb-2\">\n                  <span className=\"text-muted-foreground\">Progress</span>\n                  <span className=\"font-mono text-foreground\">{Math.round(currentProgress)}%</span>\n                </div>\n                <div className=\"h-2 bg-muted rounded-full overflow-hidden\">\n                  <div\n                    className=\"h-full bg-gradient-to-r from-primary to-orange-500 transition-all duration-500 ease-out\"\n                    style={{ width: `${currentProgress}%` }}\n                  />\n                </div>\n              </div>\n\n              <div className=\"space-y-3\">\n                {stages.map((stage) => {\n                  const stageStatus = getStageProgress(stage.id, currentProgress);\n                  const Icon = stage.icon;\n                  \n                  return (\n                    <div\n                      key={stage.id}\n                      className={`flex items-start gap-3 p-3 rounded-lg border transition-all duration-300 ${\n                        stageStatus === \"active\"\n                          ? \"bg-primary/10 border-primary/30 shadow-sm\"\n                          : stageStatus === \"complete\"\n                          ? \"bg-emerald-500/10 border-emerald-500/30\"\n                          : \"bg-muted/30 border-border opacity-50\"\n                      }`}\n                      data-testid={`stage-${stage.id}`}\n                    >\n                      <div\n                        className={`p-2 rounded-lg flex-shrink-0 ${\n                          stageStatus === \"active\"\n                            ? \"bg-primary/20\"\n                            : stageStatus === \"complete\"\n                            ? \"bg-emerald-500/20\"\n                            : \"bg-muted\"\n                        }`}\n                      >\n                        {stageStatus === \"active\" ? (\n                          <Loader2 className=\"h-4 w-4 text-primary animate-spin\" />\n                        ) : stageStatus === \"complete\" ? (\n                          <CheckCircle className=\"h-4 w-4 text-emerald-400\" />\n                        ) : (\n                          <Icon className=\"h-4 w-4 text-muted-foreground\" />\n                        )}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2\">\n                          <span\n                            className={`text-sm font-medium ${\n                              stageStatus === \"pending\"\n                                ? \"text-muted-foreground\"\n                                : \"text-foreground\"\n                            }`}\n                          >\n                            {stage.name}\n                          </span>\n                          {stageStatus === \"active\" && (\n                            <span className=\"text-[10px] font-medium text-primary bg-primary/20 px-1.5 py-0.5 rounded\">\n                              IN PROGRESS\n                            </span>\n                          )}\n                        </div>\n                        <p className=\"text-xs text-muted-foreground mt-0.5\">\n                          {stageStatus === \"active\" && progress?.stage\n                            ? progress.stage\n                            : stage.description}\n                        </p>\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n\n              <div className=\"mt-6 p-3 bg-muted/30 rounded-lg border border-border\">\n                <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                  <Target className=\"h-3.5 w-3.5 text-primary\" />\n                  <span>\n                    {progress?.stage || \"Initializing autonomous exploit validation...\"}\n                  </span>\n                </div>\n              </div>\n            </>\n          ) : (\n            <div className=\"space-y-4\">\n              <div\n                className={`p-4 rounded-lg border ${\n                  isFailed\n                    ? \"bg-red-500/10 border-red-500/30\"\n                    : result?.exploitable\n                    ? \"bg-red-500/10 border-red-500/30\"\n                    : \"bg-emerald-500/10 border-emerald-500/30\"\n                }`}\n              >\n                <div className=\"flex items-center gap-3\">\n                  {isFailed ? (\n                    <AlertTriangle className=\"h-8 w-8 text-red-400\" />\n                  ) : result?.exploitable ? (\n                    <AlertTriangle className=\"h-8 w-8 text-red-400\" />\n                  ) : (\n                    <CheckCircle className=\"h-8 w-8 text-emerald-400\" />\n                  )}\n                  <div>\n                    <h4 className=\"font-semibold text-lg\">\n                      {isFailed\n                        ? \"Evaluation Failed\"\n                        : result?.exploitable\n                        ? \"Exploitable\"\n                        : \"Not Exploitable\"}\n                    </h4>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {isFailed\n                        ? result?.error || \"An error occurred during evaluation\"\n                        : result?.exploitable\n                        ? \"This exposure can be actively exploited\"\n                        : \"No viable exploit path found\"}\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              {!isFailed && (\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div className=\"p-3 bg-muted/30 rounded-lg border border-border\">\n                    <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider mb-1\">\n                      Confidence\n                    </div>\n                    <div className=\"text-xl font-bold text-foreground\">\n                      {Math.round((result?.confidence || 0) * 100)}%\n                    </div>\n                  </div>\n                  <div className=\"p-3 bg-muted/30 rounded-lg border border-border\">\n                    <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider mb-1\">\n                      Risk Score\n                    </div>\n                    <div\n                      className={`text-xl font-bold ${\n                        (result?.score || 0) > 70\n                          ? \"text-red-400\"\n                          : (result?.score || 0) > 40\n                          ? \"text-orange-400\"\n                          : \"text-emerald-400\"\n                      }`}\n                    >\n                      {result?.score?.toFixed(1) || \"0\"}\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              <button\n                onClick={onClose}\n                className=\"w-full px-4 py-2.5 bg-primary text-primary-foreground rounded-lg font-medium hover:bg-primary/90 transition-colors\"\n                data-testid=\"button-view-details\"\n              >\n                View Full Details\n              </button>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":11591,"size_tokens":null},"server/vite.ts":{"content":"import { type Express } from \"express\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport async function setupVite(server: Server, app: Express) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server, path: \"/vite-hmr\" },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n","path":null,"size_bytes":1534,"size_tokens":null},"client/src/components/EvaluationDetail.tsx":{"content":"import { useState } from \"react\";\nimport { ArrowLeft, Clock, Activity, FileText, Shield, Target, Lightbulb, Network, Workflow, Cloud, FileSearch, Brain, Wrench, Play, Trash2, Archive, ArchiveRestore, MoreVertical, FileOutput } from \"lucide-react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { AttackPathVisualizer } from \"./AttackPathVisualizer\";\nimport { AttackGraphVisualizer } from \"./AttackGraphVisualizer\";\nimport { AnimatedAttackGraph } from \"./AnimatedAttackGraph\";\nimport { ExploitabilityGauge } from \"./ExploitabilityGauge\";\nimport { RecommendationsPanel } from \"./RecommendationsPanel\";\nimport { BusinessLogicFindingsPanel } from \"./BusinessLogicFindingsPanel\";\nimport { MultiVectorFindingsPanel } from \"./MultiVectorFindingsPanel\";\nimport { WorkflowStateMachineVisualizer } from \"./WorkflowStateMachineVisualizer\";\nimport { EvidencePanel } from \"./EvidencePanel\";\nimport { IntelligentScorePanel } from \"./IntelligentScorePanel\";\nimport { TimeToCompromiseMeter } from \"./TimeToCompromiseMeter\";\nimport { ConfidenceGauge } from \"./ConfidenceGauge\";\nimport { RiskHeatmap } from \"./RiskHeatmap\";\nimport { RemediationPanel } from \"./RemediationPanel\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useViewMode } from \"@/contexts/ViewModeContext\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Lock } from \"lucide-react\";\nimport type { BusinessLogicFinding, MultiVectorFinding, WorkflowStateMachine, EvidenceArtifact, IntelligentScore, RemediationGuidance } from \"@shared/schema\";\n\ninterface EvaluationDetailProps {\n  evaluation: {\n    id: string;\n    assetId: string;\n    exposureType: string;\n    priority: string;\n    description: string;\n    status: string;\n    executionMode?: string;\n    exploitable?: boolean;\n    score?: number;\n    confidence?: number;\n    createdAt: string;\n    duration?: number;\n    attackPath?: Array<{\n      id: number;\n      title: string;\n      description: string;\n      technique?: string;\n      severity: \"critical\" | \"high\" | \"medium\" | \"low\";\n      discoveredBy?: \"recon\" | \"exploit\" | \"lateral\" | \"business-logic\" | \"impact\";\n    }>;\n    attackGraph?: {\n      nodes: Array<{\n        id: string;\n        label: string;\n        description: string;\n        nodeType: \"entry\" | \"pivot\" | \"objective\" | \"dead-end\";\n        tactic: string;\n        compromiseLevel: \"none\" | \"limited\" | \"user\" | \"admin\" | \"system\";\n        assets?: string[];\n        discoveredBy?: \"recon\" | \"exploit\" | \"lateral\" | \"business-logic\" | \"impact\";\n      }>;\n      edges: Array<{\n        id: string;\n        source: string;\n        target: string;\n        technique: string;\n        techniqueId?: string;\n        description: string;\n        successProbability: number;\n        complexity: \"trivial\" | \"low\" | \"medium\" | \"high\" | \"expert\";\n        timeEstimate: number;\n        prerequisites?: string[];\n        alternatives?: string[];\n        edgeType: \"primary\" | \"alternative\" | \"fallback\";\n        discoveredBy?: \"recon\" | \"exploit\" | \"lateral\" | \"business-logic\" | \"impact\";\n      }>;\n      entryNodeId: string;\n      objectiveNodeIds: string[];\n      criticalPath: string[];\n      alternativePaths?: string[][];\n      killChainCoverage: string[];\n      complexityScore: number;\n      timeToCompromise: {\n        minimum: number;\n        expected: number;\n        maximum: number;\n        unit: \"minutes\" | \"hours\" | \"days\";\n      };\n      chainedExploits?: Array<{\n        name: string;\n        techniques: string[];\n        combinedImpact: string;\n      }>;\n    };\n    recommendations?: Array<{\n      id: string;\n      title: string;\n      description: string;\n      priority: \"critical\" | \"high\" | \"medium\" | \"low\";\n      type: \"remediation\" | \"compensating\" | \"preventive\";\n    }>;\n    businessLogicFindings?: BusinessLogicFinding[];\n    multiVectorFindings?: MultiVectorFinding[];\n    workflowAnalysis?: WorkflowStateMachine;\n    evidenceArtifacts?: EvidenceArtifact[];\n    intelligentScore?: IntelligentScore;\n    remediationGuidance?: RemediationGuidance;\n  };\n  onBack: () => void;\n}\n\nexport function EvaluationDetail({ evaluation, onBack }: EvaluationDetailProps) {\n  const { viewMode } = useViewMode();\n  const { needsSanitizedView, hasPermission } = useAuth();\n  const [showAnimatedGraph, setShowAnimatedGraph] = useState(false);\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const [showArchiveDialog, setShowArchiveDialog] = useState(false);\n  const { toast } = useToast();\n  \n  const isSanitized = needsSanitizedView();\n  const canViewFullEvidence = hasPermission(\"evidence:read\");\n\n  const isArchived = evaluation.status === \"archived\";\n\n  const deleteMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"DELETE\", `/api/aev/evaluations/${evaluation.id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/aev/evaluations\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/aev/stats\"] });\n      toast({\n        title: \"Evaluation deleted\",\n        description: \"The evaluation has been permanently removed.\",\n      });\n      onBack();\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete evaluation. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const archiveMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"PATCH\", `/api/aev/evaluations/${evaluation.id}/archive`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/aev/evaluations\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/aev/stats\"] });\n      toast({\n        title: \"Evaluation archived\",\n        description: \"The evaluation has been moved to the archive.\",\n      });\n      onBack();\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to archive evaluation. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const unarchiveMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"PATCH\", `/api/aev/evaluations/${evaluation.id}/unarchive`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/aev/evaluations\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/aev/stats\"] });\n      toast({\n        title: \"Evaluation restored\",\n        description: \"The evaluation has been restored from archive.\",\n      });\n      onBack();\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to restore evaluation. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const generateReportMutation = useMutation({\n    mutationFn: async (reportType: \"executive_summary\" | \"technical_deep_dive\") => {\n      const response = await apiRequest(\"POST\", \"/api/reports/generate\", {\n        type: reportType,\n        format: \"json\",\n        evaluationId: evaluation.id,\n      });\n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/reports\"] });\n      toast({\n        title: \"Report Generated\",\n        description: `${data.title} has been created. View it in the Reports page.`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to generate report. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const getSeverityBadge = (priority: string) => {\n    const classes: Record<string, string> = {\n      critical: \"bg-red-500/10 text-red-400 border-red-500/30\",\n      high: \"bg-orange-500/10 text-orange-400 border-orange-500/30\",\n      medium: \"bg-amber-500/10 text-amber-400 border-amber-500/30\",\n      low: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\",\n    };\n    return classes[priority] || \"\";\n  };\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"evaluation-detail\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"ghost\" size=\"icon\" onClick={onBack} data-testid=\"button-back\">\n            <ArrowLeft className=\"h-4 w-4\" />\n          </Button>\n          <div>\n            <div className=\"flex items-center gap-3 flex-wrap\">\n              <h1 className=\"text-2xl font-bold text-foreground\">AEV Evaluation</h1>\n              <Badge className={evaluation.exploitable \n                ? \"bg-red-500/10 text-red-400 border-red-500/30\" \n                : \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\"\n              }>\n                {evaluation.exploitable ? \"EXPLOITABLE\" : \"NOT EXPLOITABLE\"}\n              </Badge>\n              {isArchived && (\n                <Badge className=\"bg-slate-500/10 text-slate-400 border-slate-500/30\">\n                  ARCHIVED\n                </Badge>\n              )}\n              {evaluation.executionMode && evaluation.executionMode !== \"safe\" && (\n                <Badge className={\n                  evaluation.executionMode === \"simulation\" \n                    ? \"bg-amber-500/10 text-amber-400 border-amber-500/30\"\n                    : evaluation.executionMode === \"live\"\n                    ? \"bg-red-500/10 text-red-400 border-red-500/30\"\n                    : \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\"\n                } data-testid=\"badge-execution-mode\">\n                  {evaluation.executionMode === \"simulation\" ? \"AI SIMULATION\" : evaluation.executionMode.toUpperCase()}\n                </Badge>\n              )}\n            </div>\n            <p className=\"text-sm text-muted-foreground font-mono mt-1\">{evaluation.id}</p>\n          </div>\n        </div>\n        <div className=\"flex items-center gap-4 flex-wrap\">\n          <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n            <div className=\"flex items-center gap-2\">\n              <Clock className=\"h-4 w-4\" />\n              <span>{new Date(evaluation.createdAt).toLocaleString()}</span>\n            </div>\n            {evaluation.duration && (\n              <div className=\"flex items-center gap-2\">\n                <Activity className=\"h-4 w-4\" />\n                <span>{(evaluation.duration / 1000).toFixed(1)}s</span>\n              </div>\n            )}\n          </div>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"outline\" size=\"icon\" data-testid=\"btn-actions-menu\">\n                <MoreVertical className=\"h-4 w-4\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\">\n              <DropdownMenuItem \n                onClick={() => generateReportMutation.mutate(\"executive_summary\")}\n                disabled={generateReportMutation.isPending}\n                data-testid=\"btn-generate-executive-report\"\n              >\n                <FileOutput className=\"h-4 w-4 mr-2\" />\n                {generateReportMutation.isPending ? \"Generating...\" : \"Executive Report\"}\n              </DropdownMenuItem>\n              <DropdownMenuItem \n                onClick={() => generateReportMutation.mutate(\"technical_deep_dive\")}\n                disabled={generateReportMutation.isPending}\n                data-testid=\"btn-generate-technical-report\"\n              >\n                <FileOutput className=\"h-4 w-4 mr-2\" />\n                {generateReportMutation.isPending ? \"Generating...\" : \"Technical Report\"}\n              </DropdownMenuItem>\n              <DropdownMenuSeparator />\n              {isArchived ? (\n                <DropdownMenuItem \n                  onClick={() => unarchiveMutation.mutate()}\n                  data-testid=\"btn-restore\"\n                >\n                  <ArchiveRestore className=\"h-4 w-4 mr-2\" />\n                  Restore from Archive\n                </DropdownMenuItem>\n              ) : (\n                <DropdownMenuItem \n                  onClick={() => setShowArchiveDialog(true)}\n                  data-testid=\"btn-archive\"\n                >\n                  <Archive className=\"h-4 w-4 mr-2\" />\n                  Archive Evaluation\n                </DropdownMenuItem>\n              )}\n              <DropdownMenuSeparator />\n              <DropdownMenuItem \n                onClick={() => setShowDeleteDialog(true)}\n                className=\"text-destructive focus:text-destructive\"\n                data-testid=\"btn-delete\"\n              >\n                <Trash2 className=\"h-4 w-4 mr-2\" />\n                Delete Permanently\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        <div className=\"lg:col-span-2 space-y-6\">\n          <div className=\"bg-card border border-border rounded-lg overflow-hidden\">\n            <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 rounded-lg bg-cyan-500/10\">\n                  <FileText className=\"h-5 w-5 text-cyan-400\" />\n                </div>\n                <h2 className=\"text-lg font-semibold text-foreground\">Exposure Summary</h2>\n              </div>\n            </div>\n            <div className=\"p-6 space-y-6\">\n              <div className=\"grid grid-cols-2 gap-6\">\n                <div>\n                  <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-1 block\">\n                    Asset ID\n                  </label>\n                  <p className=\"text-foreground font-mono text-sm\">{evaluation.assetId}</p>\n                </div>\n                <div>\n                  <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-1 block\">\n                    Exposure Type\n                  </label>\n                  <Badge className=\"bg-blue-500/10 text-blue-400 border-blue-500/30\">\n                    {evaluation.exposureType.replace(\"_\", \" \").toUpperCase()}\n                  </Badge>\n                </div>\n                <div>\n                  <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-1 block\">\n                    Severity\n                  </label>\n                  <Badge className={getSeverityBadge(evaluation.priority)}>\n                    {evaluation.priority.toUpperCase()}\n                  </Badge>\n                </div>\n                <div>\n                  <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-1 block\">\n                    Status\n                  </label>\n                  <Badge className=\"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\">\n                    {evaluation.status.toUpperCase()}\n                  </Badge>\n                </div>\n              </div>\n              <div>\n                <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-2 block\">\n                  Description\n                </label>\n                <p className=\"text-muted-foreground leading-relaxed\">{evaluation.description}</p>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"bg-card border border-border rounded-lg overflow-hidden\">\n            <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n              <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-orange-500/10\">\n                    <Target className=\"h-5 w-5 text-orange-400\" />\n                  </div>\n                  <h2 className=\"text-lg font-semibold text-foreground\">Attack Path Analysis</h2>\n                </div>\n                {evaluation.attackGraph && (\n                  <Button \n                    variant=\"outline\" \n                    size=\"sm\" \n                    onClick={() => setShowAnimatedGraph(!showAnimatedGraph)}\n                    className=\"gap-2\"\n                    data-testid=\"btn-toggle-animation-header\"\n                  >\n                    <Play className=\"h-3.5 w-3.5\" />\n                    {showAnimatedGraph ? \"Stop Animation\" : \"Play Attack\"}\n                  </Button>\n                )}\n              </div>\n            </div>\n            <div className=\"p-6\">\n              {showAnimatedGraph && evaluation.attackGraph ? (\n                <AnimatedAttackGraph \n                  attackGraph={evaluation.attackGraph}\n                  isExploitable={evaluation.exploitable ?? false}\n                />\n              ) : (\n                <Tabs defaultValue={evaluation.attackGraph ? \"graph\" : \"linear\"} className=\"w-full\">\n                  <TabsList className=\"mb-4\">\n                    {evaluation.attackGraph && (\n                      <TabsTrigger value=\"graph\" className=\"gap-2\" data-testid=\"tab-graph-view\">\n                        <Network className=\"h-4 w-4\" />\n                        Graph View\n                      </TabsTrigger>\n                    )}\n                    <TabsTrigger value=\"linear\" className=\"gap-2\" data-testid=\"tab-linear-view\">\n                      <Target className=\"h-4 w-4\" />\n                      Linear View\n                    </TabsTrigger>\n                  </TabsList>\n                  {evaluation.attackGraph && (\n                    <TabsContent value=\"graph\">\n                      <AttackGraphVisualizer \n                        attackGraph={evaluation.attackGraph} \n                        isExploitable={evaluation.exploitable ?? false} \n                      />\n                    </TabsContent>\n                  )}\n                  <TabsContent value=\"linear\">\n                    <AttackPathVisualizer \n                      steps={evaluation.attackPath || []} \n                      isExploitable={evaluation.exploitable ?? false} \n                    />\n                  </TabsContent>\n                </Tabs>\n              )}\n            </div>\n          </div>\n\n          {evaluation.businessLogicFindings && evaluation.businessLogicFindings.length > 0 && (\n            <div className=\"bg-card border border-border rounded-lg overflow-hidden\">\n              <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-amber-500/10\">\n                    <Workflow className=\"h-5 w-5 text-amber-400\" />\n                  </div>\n                  <div>\n                    <h2 className=\"text-lg font-semibold text-foreground\">Business Logic Findings</h2>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {evaluation.businessLogicFindings.length} finding{evaluation.businessLogicFindings.length !== 1 ? 's' : ''} detected\n                    </p>\n                  </div>\n                </div>\n              </div>\n              <div className=\"p-6\">\n                <BusinessLogicFindingsPanel findings={evaluation.businessLogicFindings} />\n              </div>\n            </div>\n          )}\n\n          {evaluation.multiVectorFindings && evaluation.multiVectorFindings.length > 0 && (\n            <div className=\"bg-card border border-border rounded-lg overflow-hidden\">\n              <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-cyan-500/10\">\n                    <Cloud className=\"h-5 w-5 text-cyan-400\" />\n                  </div>\n                  <div>\n                    <h2 className=\"text-lg font-semibold text-foreground\">Multi-Vector Findings</h2>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {evaluation.multiVectorFindings.length} cloud/IAM/SaaS finding{evaluation.multiVectorFindings.length !== 1 ? 's' : ''}\n                    </p>\n                  </div>\n                </div>\n              </div>\n              <div className=\"p-6\">\n                <MultiVectorFindingsPanel findings={evaluation.multiVectorFindings} />\n              </div>\n            </div>\n          )}\n\n          {evaluation.workflowAnalysis && (\n            <div className=\"bg-card border border-border rounded-lg overflow-hidden\">\n              <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-blue-500/10\">\n                    <Workflow className=\"h-5 w-5 text-blue-400\" />\n                  </div>\n                  <h2 className=\"text-lg font-semibold text-foreground\">Workflow State Machine</h2>\n                </div>\n              </div>\n              <div className=\"p-6\">\n                <WorkflowStateMachineVisualizer workflow={evaluation.workflowAnalysis} />\n              </div>\n            </div>\n          )}\n\n          {evaluation.evidenceArtifacts && evaluation.evidenceArtifacts.length > 0 && (\n            <div className=\"bg-card border border-border rounded-lg overflow-hidden\">\n              <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-indigo-500/10\">\n                    <FileSearch className=\"h-5 w-5 text-indigo-400\" />\n                  </div>\n                  <div>\n                    <h2 className=\"text-lg font-semibold text-foreground\">Evidence Artifacts</h2>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {isSanitized ? \"Summary of evidence (details restricted)\" : \"Proof of exploit with sanitized data\"}\n                    </p>\n                  </div>\n                </div>\n              </div>\n              <div className=\"p-6\">\n                {isSanitized ? (\n                  <Alert>\n                    <Lock className=\"h-4 w-4\" />\n                    <AlertTitle>Evidence Details Restricted</AlertTitle>\n                    <AlertDescription>\n                      <p className=\"mb-2\">\n                        Raw exploit evidence and technical artifacts are not available for your role. \n                        This includes code snippets, payloads, and detailed attack traces.\n                      </p>\n                      <p className=\"text-sm text-muted-foreground\">\n                        <strong>{evaluation.evidenceArtifacts.length}</strong> evidence artifact(s) collected. \n                        Contact a Security Administrator for full access.\n                      </p>\n                    </AlertDescription>\n                  </Alert>\n                ) : (\n                  <EvidencePanel artifacts={evaluation.evidenceArtifacts} evaluationId={evaluation.id} />\n                )}\n              </div>\n            </div>\n          )}\n        </div>\n\n        <div className=\"space-y-6 lg:col-span-1\">\n          {evaluation.attackGraph?.timeToCompromise && (\n            <div className=\"bg-card border border-border rounded-lg overflow-hidden\">\n              <div className=\"p-6\">\n                <TimeToCompromiseMeter \n                  expected={evaluation.attackGraph.timeToCompromise.expected}\n                  minimum={evaluation.attackGraph.timeToCompromise.minimum}\n                  maximum={evaluation.attackGraph.timeToCompromise.maximum}\n                  unit={evaluation.attackGraph.timeToCompromise.unit}\n                />\n              </div>\n            </div>\n          )}\n\n          {viewMode === \"executive\" && evaluation.intelligentScore && (\n            <div className=\"bg-card border border-border rounded-lg overflow-hidden\">\n              <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-red-500/10\">\n                    <Shield className=\"h-5 w-5 text-red-400\" />\n                  </div>\n                  <h2 className=\"text-lg font-semibold text-foreground\">Risk Assessment</h2>\n                </div>\n              </div>\n              <div className=\"p-6\">\n                <RiskHeatmap intelligentScore={evaluation.intelligentScore} />\n              </div>\n            </div>\n          )}\n\n          {viewMode === \"engineer\" && evaluation.intelligentScore && (\n            <div className=\"bg-card border border-border rounded-lg overflow-hidden\">\n              <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-purple-500/10\">\n                    <Brain className=\"h-5 w-5 text-purple-400\" />\n                  </div>\n                  <h2 className=\"text-lg font-semibold text-foreground\">Intelligent Risk Score</h2>\n                </div>\n              </div>\n              <div className=\"p-6\">\n                <IntelligentScorePanel score={evaluation.intelligentScore} />\n              </div>\n            </div>\n          )}\n\n          {!evaluation.intelligentScore && (\n            <div className=\"bg-card border border-border rounded-lg overflow-hidden\">\n              <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-purple-500/10\">\n                    <Shield className=\"h-5 w-5 text-purple-400\" />\n                  </div>\n                  <h2 className=\"text-lg font-semibold text-foreground\">Exploitability Score</h2>\n                </div>\n              </div>\n              <div className=\"p-6\">\n                <div className=\"flex items-center justify-center gap-6\">\n                  <ExploitabilityGauge \n                    score={evaluation.score ?? 0} \n                    confidence={evaluation.confidence ?? 0}\n                    size=\"md\"\n                  />\n                  <ConfidenceGauge \n                    confidence={evaluation.confidence ?? 0}\n                    size=\"md\"\n                  />\n                </div>\n              </div>\n            </div>\n          )}\n\n          {evaluation.remediationGuidance && (\n            <div className=\"bg-card border border-border rounded-lg overflow-hidden\">\n              <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-cyan-500/10\">\n                    <Wrench className=\"h-5 w-5 text-cyan-400\" />\n                  </div>\n                  <div>\n                    <h2 className=\"text-lg font-semibold text-foreground\">Remediation Guidance</h2>\n                    <p className=\"text-xs text-muted-foreground\">\n                      AI-generated fixes and mitigations\n                    </p>\n                  </div>\n                </div>\n              </div>\n              <div className=\"p-6\">\n                <RemediationPanel guidance={evaluation.remediationGuidance} viewMode={viewMode} />\n              </div>\n            </div>\n          )}\n\n          <div className=\"bg-card border border-border rounded-lg overflow-hidden\">\n            <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 rounded-lg bg-emerald-500/10\">\n                  <Lightbulb className=\"h-5 w-5 text-emerald-400\" />\n                </div>\n                <h2 className=\"text-lg font-semibold text-foreground\">Recommendations</h2>\n              </div>\n            </div>\n            <div className=\"p-6\">\n              <RecommendationsPanel recommendations={evaluation.recommendations || []} />\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Evaluation</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to permanently delete this evaluation? This action cannot be undone and all associated data will be lost.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel \n              disabled={deleteMutation.isPending}\n              data-testid=\"btn-cancel-delete\"\n            >\n              Cancel\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => deleteMutation.mutate()}\n              disabled={deleteMutation.isPending}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"btn-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      <AlertDialog open={showArchiveDialog} onOpenChange={setShowArchiveDialog}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Archive Evaluation</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to archive this evaluation? Archived evaluations can be restored later from the actions menu.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel \n              disabled={archiveMutation.isPending}\n              data-testid=\"btn-cancel-archive\"\n            >\n              Cancel\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => archiveMutation.mutate()}\n              disabled={archiveMutation.isPending}\n              data-testid=\"btn-confirm-archive\"\n            >\n              {archiveMutation.isPending ? \"Archiving...\" : \"Archive\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":30641,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"design_guidelines.md":{"content":"# AEV Platform Design Guidelines\n\n## Design Approach\n\n**Selected Framework**: Hybrid approach combining Material Design's component structure with custom cyber-security aesthetics inspired by cutting-edge security platforms like Wiz, Snyk, and modern SOC dashboards.\n\n**Core Principles**:\n- Data density with clarity - maximize information without overwhelming\n- Real-time dynamism - everything feels live and responsive\n- Technical credibility - designs that security professionals trust\n- Visual boldness - stand out from traditional enterprise security tools\n\n## Typography System\n\n**Font Stack**: \n- Primary: \"Inter\" for UI text (clean, modern, excellent at small sizes)\n- Monospace: \"JetBrains Mono\" for code, IDs, technical data\n- Display: \"Inter\" at bold weights for headings\n\n**Hierarchy**:\n- Page Titles: 2xl (24px), bold, tight line-height (1.1)\n- Section Headers: lg (18px), semibold \n- Card Titles: base (16px), semibold\n- Body Text: sm (14px), regular\n- Metadata/Labels: xs (12px), medium, uppercase tracking-wide\n- Technical Data: sm (14px), mono font\n\n## Layout System\n\n**Spacing Scale**: Use Tailwind units of **4, 6, 8, 12, 16, 20, 24** for consistency\n- Component padding: p-6 (cards), p-8 (major sections)\n- Between sections: mb-8, gap-6\n- Dense data areas: p-4, gap-4\n- Page margins: p-6 to p-8\n\n**Grid Patterns**:\n- Dashboard stats: 5-column grid for metrics (grid-cols-5 gap-4)\n- Evaluation cards: 3-column on desktop (grid-cols-1 md:grid-cols-2 lg:grid-cols-3)\n- Detail pages: 2-column layout (main content 2/3, sidebar 1/3)\n- Responsive: Always stack to single column on mobile\n\n## Component Library\n\n### Navigation\n**Top Navigation Bar**:\n- Full-width with logo left, navigation center, user menu right\n- Height: h-16\n- Sticky positioning with subtle backdrop blur\n- Navigation items with icon + label pairs\n- Active state indicators beneath items\n\n### Dashboard Cards\n**Stat Cards**:\n- Compact, fixed height (h-24)\n- Large numerical value (2xl font) with label beneath\n- Icon in corner or integrated with layout\n- Subtle border treatment\n\n**Evaluation Table**:\n- Sortable column headers with sort indicators\n- Row height: py-3 for comfortable scanning\n- Alternate row treatment for visual rhythm\n- Status badges inline with clear visual hierarchy\n- Hover state reveals action buttons\n\n**Quick View Drawer**:\n- Slides from right, 1/3 viewport width on desktop\n- Shows summary info with \"View Full Details\" CTA\n- Smooth slide-in animation (transition-transform duration-300)\n\n### Attack Path Visualization\n**Node Graph Layout**:\n- Numbered circles (w-10 h-10) connected by lines\n- Progressive reveal as stages complete\n- Each node shows stage name + brief description\n- Vertical flow for mobile, can be horizontal for desktop\n- Visual distinction between completed/active/pending states\n\n**Exploitability Gauge**:\n- Semicircular gauge showing 0-100 score\n- Segmented into risk zones (0-20, 20-40, 40-60, 60-80, 80-100)\n- Large score number centered below arc\n- Legend showing current risk level (Critical/High/Medium/Low/Minimal)\n\n### Progress Modal\n**Real-time Evaluation Modal**:\n- Centered overlay with backdrop blur\n- Compact width (max-w-lg)\n- Top section: gradient header with asset info\n- Progress bar: 2-pixel height, smooth animation\n- Stage cards: 4 stages in vertical stack\n- Each stage shows icon, name, description, status indicator\n- Animated loader icon for active stage\n- Completion view with summary stats (confidence %, risk score)\n\n### Form Components\n**New Evaluation Modal**:\n- Centered, max-w-md\n- Form sections with clear labels (text-xs uppercase)\n- Select dropdowns for exposure type, module, priority\n- Textarea for description (rows-4)\n- Two-column layout for related fields\n- Primary action button full-width at bottom\n\n### Data Visualization\n**Attack Path Diagram**:\n- Step-by-step numbered flow (1  2  3)\n- Connecting lines between steps\n- Each step in a bordered card\n- Conditional rendering based on exploitability\n\n**Evidence Sections**:\n- Collapsible accordions for detailed findings\n- Code blocks with syntax highlighting\n- Tabbed interface for multiple evidence types\n\n**Impact Assessment Cards**:\n- Grid of impact metrics (Confidentiality, Integrity, Availability)\n- Icon + label + severity indicator\n- Visual hierarchy emphasizing critical impacts\n\n### Filtering & Sorting\n**Filter Bar**:\n- Horizontal button group for quick filters (All, Pending, Completed, Exploitable, Safe)\n- Compact button sizing (px-3 py-1.5, text-xs)\n- Clear active state treatment\n\n**Sort Controls**:\n- Inline with table headers\n- Chevron indicators for sort direction\n- Click to toggle ascending/descending\n\n## Page Layouts\n\n### Dashboard (AEVPage)\n**Structure**:\n1. Header row: Title + description left, action buttons right\n2. Stats grid: 5 equal-width cards\n3. Filter bar: Horizontal button array\n4. Main content: Responsive table with infinite scroll\n5. Modals: Progress overlay, new evaluation form\n\n### Detail Page (AEVDetailPage)\n**Structure**:\n1. Breadcrumb/back link\n2. Header: Title, status badge, metadata (created, duration)\n3. Two-column grid:\n   - Left (2/3 width): Exposure Summary, Attack Path\n   - Right (1/3 width): Exploitability Scores, Recommendations\n4. Each section in bordered card with icon header\n\n### Evaluation Detail Sections\n**Section 1 - Exposure Summary**:\n- 2x2 grid of metadata fields\n- Full-width description area beneath grid\n- Each field: small label + larger value\n\n**Section 2 - Exploitability Scores**:\n- Large gauge visualization at top\n- Confidence bar beneath\n- Status indicators\n- Risk classification label\n\n**Section 3 - Attack Path**:\n- Vertical step visualization\n- Numbered nodes with connecting lines\n- Text description for each step\n- Empty state for non-exploitable findings\n\n**Section 4 - Recommendations**:\n- Two subsections: Remediation + Compensating Controls\n- Each as numbered or bulleted list\n- Priority indicators for recommendations\n\n## Responsive Behavior\n- **Desktop (lg+)**: Multi-column grids, side-by-side layouts\n- **Tablet (md)**: 2-column max, reduced gutters\n- **Mobile (base)**: Single column stack, full-width components, compact spacing (p-4)\n\n## Animation Guidelines\n**Minimal, Purposeful Animations**:\n- Progress bars: Smooth width transitions (duration-500)\n- Modal entry/exit: Slide and fade (duration-300)\n- Loading states: Subtle spin on icons\n- Hover states: Simple opacity/shadow changes\n- **Avoid**: Excessive parallax, complex transitions, auto-playing animations\n\n## Images\n**Hero Section**: Not applicable - this is a utility dashboard application\n**Icons**: Use Lucide React icon library exclusively via npm\n**Logos/Branding**: Placeholder for company logo in navigation\n**Visualization Graphics**: SVG-based gauges, charts, and diagrams (custom components)\n\n## Accessibility\n- All interactive elements have visible focus states\n- Form inputs with associated labels\n- Sufficient contrast ratios throughout\n- Keyboard navigation support for all actions\n- Screen reader friendly status announcements\n- ARIA labels for icon-only buttons","path":null,"size_bytes":7062,"size_tokens":null},"server/services/agents/impact.ts":{"content":"import OpenAI from \"openai\";\nimport type { AgentMemory, AgentResult, ImpactFindings } from \"./types\";\nimport { generateAdversaryPromptContext } from \"./adversary-profile\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\ntype ProgressCallback = (stage: string, progress: number, message: string) => void;\n\nexport async function runImpactAgent(\n  memory: AgentMemory,\n  onProgress?: ProgressCallback\n): Promise<AgentResult<ImpactFindings>> {\n  const startTime = Date.now();\n  \n  onProgress?.(\"impact\", 85, \"Assessing data exposure risk...\");\n\n  const adversaryContext = memory.context.adversaryProfile \n    ? generateAdversaryPromptContext(memory.context.adversaryProfile)\n    : \"\";\n\n  const previousContext = `\nRecon Findings:\n${memory.recon ? `- Attack Surface: ${memory.recon.attackSurface.join(\", \")}\n- Potential Vulnerabilities: ${memory.recon.potentialVulnerabilities.join(\", \")}` : \"None\"}\n\nExploit Findings:\n${memory.exploit ? `- Exploitable: ${memory.exploit.exploitable}\n- Exploit Chains: ${memory.exploit.exploitChains.map((c) => `${c.name} (${c.success_likelihood})`).join(\", \")}\n- CVEs: ${memory.exploit.cveReferences.join(\", \")}` : \"None\"}\n\nLateral Movement:\n${memory.lateral ? `- Pivot Paths: ${memory.lateral.pivotPaths.length}\n- Privilege Escalation: ${memory.lateral.privilegeEscalation.map((p) => p.target).join(\", \")}` : \"None\"}\n\nBusiness Logic:\n${memory.businessLogic ? `- Workflow Abuse: ${memory.businessLogic.workflowAbuse.join(\", \")}\n- Authorization Bypass: ${memory.businessLogic.authorizationBypass.join(\", \")}` : \"None\"}\n`;\n\n  const systemPrompt = `You are the IMPACT AGENT, a specialized AI system for assessing business impact of security vulnerabilities for OdinForge AI.\n\nYour mission is to assess the potential impact if the vulnerability is exploited:\n1. Data exposure - what data could be accessed and how severe\n2. Financial impact - estimated monetary impact and contributing factors\n3. Compliance impact - which regulations could be violated\n4. Reputational risk - brand and customer trust impact\n\nThink like a risk analyst providing executive-level impact assessment. Be realistic and data-driven.\n${adversaryContext}`;\n\n  const userPrompt = `Assess the business impact for this exposure:\n\nAsset ID: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nPriority: ${memory.context.priority}\nDescription: ${memory.context.description}\n${previousContext}\n\nProvide your impact assessment as a JSON object with this structure:\n{\n  \"dataExposure\": {\n    \"types\": [\"list of data types that could be exposed\"],\n    \"severity\": \"critical\" | \"high\" | \"medium\" | \"low\",\n    \"estimatedRecords\": \"estimated number or range of records affected\"\n  },\n  \"financialImpact\": {\n    \"estimate\": \"estimated financial impact range\",\n    \"factors\": [\"list of factors contributing to financial impact\"]\n  },\n  \"complianceImpact\": [\"list of compliance frameworks/regulations affected\"],\n  \"reputationalRisk\": \"critical\" | \"high\" | \"medium\" | \"low\"\n}`;\n\n  try {\n    onProgress?.(\"impact\", 90, \"Calculating financial exposure...\");\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 2048,\n    });\n\n    onProgress?.(\"impact\", 92, \"Mapping compliance requirements...\");\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response from Impact Agent\");\n    }\n\n    const findings = JSON.parse(content) as ImpactFindings;\n    \n    const validatedFindings: ImpactFindings = {\n      dataExposure: {\n        types: Array.isArray(findings.dataExposure?.types) ? findings.dataExposure.types : [],\n        severity: validateSeverity(findings.dataExposure?.severity),\n        estimatedRecords: String(findings.dataExposure?.estimatedRecords || \"Unknown\"),\n      },\n      financialImpact: {\n        estimate: String(findings.financialImpact?.estimate || \"Unknown\"),\n        factors: Array.isArray(findings.financialImpact?.factors) ? findings.financialImpact.factors : [],\n      },\n      complianceImpact: Array.isArray(findings.complianceImpact) ? findings.complianceImpact : [],\n      reputationalRisk: validateSeverity(findings.reputationalRisk),\n    };\n\n    return {\n      success: true,\n      findings: validatedFindings,\n      agentName: \"Impact Agent\",\n      processingTime: Date.now() - startTime,\n    };\n  } catch (error) {\n    console.error(\"Impact Agent error:\", error);\n    throw error;\n  }\n}\n\nfunction validateSeverity(severity: unknown): \"critical\" | \"high\" | \"medium\" | \"low\" {\n  const valid = [\"critical\", \"high\", \"medium\", \"low\"];\n  return valid.includes(String(severity)) ? (severity as \"critical\" | \"high\" | \"medium\" | \"low\") : \"medium\";\n}\n","path":null,"size_bytes":4960,"size_tokens":null},"server/static.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(__dirname, \"public\");\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":547,"size_tokens":null},"server/storage.ts":{"content":"import { \n  type User, \n  type InsertUser, \n  type Evaluation, \n  type InsertEvaluation,\n  type Result,\n  type InsertResult,\n  type Report,\n  type InsertReport,\n  type ReportNarrative,\n  type InsertReportNarrative,\n  type BatchJob,\n  type InsertBatchJob,\n  type ScheduledScan,\n  type InsertScheduledScan,\n  type OrganizationGovernance,\n  type InsertOrganizationGovernance,\n  type AuthorizationLog,\n  type InsertAuthorizationLog,\n  type ScopeRule,\n  type InsertScopeRule,\n  type AiAdversaryProfile,\n  type InsertAiAdversaryProfile,\n  type AttackPrediction,\n  type InsertAttackPrediction,\n  type DefensivePostureScore,\n  type InsertDefensivePostureScore,\n  type PurpleTeamFinding,\n  type InsertPurpleTeamFinding,\n  type AiSimulation,\n  type InsertAiSimulation,\n  type DiscoveredAsset,\n  type InsertDiscoveredAsset,\n  type VulnerabilityImport,\n  type InsertVulnerabilityImport,\n  type ImportJob,\n  type InsertImportJob,\n  type CloudConnection,\n  type InsertCloudConnection,\n  type EndpointAgent,\n  type InsertEndpointAgent,\n  type AgentTelemetry,\n  type InsertAgentTelemetry,\n  type AgentFinding,\n  type InsertAgentFinding,\n  users,\n  aevEvaluations,\n  aevResults,\n  reports,\n  reportNarratives,\n  batchJobs,\n  scheduledScans,\n  evaluationHistory,\n  organizationGovernance,\n  authorizationLogs,\n  scopeRules,\n  aiAdversaryProfiles,\n  attackPredictions,\n  defensivePostureScores,\n  purpleTeamFindings,\n  aiSimulations,\n  discoveredAssets,\n  vulnerabilityImports,\n  importJobs,\n  cloudConnections,\n  endpointAgents,\n  agentTelemetry,\n  agentFindings,\n} from \"@shared/schema\";\nimport { randomUUID } from \"crypto\";\nimport { db } from \"./db\";\nimport { eq, desc, and, gte, lte, sql } from \"drizzle-orm\";\n\nexport interface IStorage {\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n  getAllUsers(organizationId?: string): Promise<User[]>;\n  updateUser(id: string, updates: Partial<User>): Promise<void>;\n  deleteUser(id: string): Promise<void>;\n  \n  // AEV Evaluation operations\n  createEvaluation(data: InsertEvaluation): Promise<Evaluation>;\n  getEvaluation(id: string): Promise<Evaluation | undefined>;\n  getEvaluations(organizationId?: string): Promise<Evaluation[]>;\n  getEvaluationsByDateRange(from: Date, to: Date, organizationId?: string): Promise<Evaluation[]>;\n  updateEvaluationStatus(id: string, status: string, executionMode?: string): Promise<void>;\n  \n  // AEV Result operations\n  createResult(data: InsertResult & { id: string }): Promise<Result>;\n  getResultByEvaluationId(evaluationId: string): Promise<Result | undefined>;\n  getResultsByEvaluationIds(evaluationIds: string[]): Promise<Result[]>;\n  \n  // Delete operations\n  deleteEvaluation(id: string): Promise<void>;\n  deleteResult(evaluationId: string): Promise<void>;\n  \n  // Report operations\n  createReport(data: InsertReport): Promise<Report>;\n  getReport(id: string): Promise<Report | undefined>;\n  getReports(organizationId?: string): Promise<Report[]>;\n  updateReport(id: string, updates: Partial<Report>): Promise<void>;\n  deleteReport(id: string): Promise<void>;\n  \n  // Report Narrative operations (V2)\n  createReportNarrative(data: InsertReportNarrative & { id: string }): Promise<ReportNarrative>;\n  getReportNarrative(id: string): Promise<ReportNarrative | undefined>;\n  getReportNarrativeByEvaluationId(evaluationId: string): Promise<ReportNarrative | undefined>;\n  getReportNarratives(organizationId?: string): Promise<ReportNarrative[]>;\n  \n  // Batch Job operations\n  createBatchJob(data: InsertBatchJob): Promise<BatchJob>;\n  getBatchJob(id: string): Promise<BatchJob | undefined>;\n  getBatchJobs(organizationId?: string): Promise<BatchJob[]>;\n  updateBatchJob(id: string, updates: Partial<BatchJob>): Promise<void>;\n  deleteBatchJob(id: string): Promise<void>;\n  \n  // Scheduled Scan operations\n  createScheduledScan(data: InsertScheduledScan): Promise<ScheduledScan>;\n  getScheduledScan(id: string): Promise<ScheduledScan | undefined>;\n  getScheduledScans(organizationId?: string): Promise<ScheduledScan[]>;\n  updateScheduledScan(id: string, updates: Partial<ScheduledScan>): Promise<void>;\n  deleteScheduledScan(id: string): Promise<void>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.username, username));\n    return user;\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    const id = randomUUID();\n    const [user] = await db.insert(users).values({ ...insertUser, id }).returning();\n    return user;\n  }\n\n  async getAllUsers(organizationId?: string): Promise<User[]> {\n    return db.select().from(users).orderBy(desc(users.createdAt));\n  }\n\n  async updateUser(id: string, updates: Partial<User>): Promise<void> {\n    await db.update(users).set(updates).where(eq(users.id, id));\n  }\n\n  async deleteUser(id: string): Promise<void> {\n    await db.delete(users).where(eq(users.id, id));\n  }\n\n  // AEV Evaluation operations\n  async createEvaluation(data: InsertEvaluation): Promise<Evaluation> {\n    const id = `aev-${randomUUID().slice(0, 8)}`;\n    const [evaluation] = await db\n      .insert(aevEvaluations)\n      .values({ ...data, id })\n      .returning();\n    return evaluation;\n  }\n\n  async getEvaluation(id: string): Promise<Evaluation | undefined> {\n    const [evaluation] = await db\n      .select()\n      .from(aevEvaluations)\n      .where(eq(aevEvaluations.id, id));\n    return evaluation;\n  }\n\n  async getEvaluations(organizationId?: string): Promise<Evaluation[]> {\n    if (organizationId) {\n      return db\n        .select()\n        .from(aevEvaluations)\n        .where(eq(aevEvaluations.organizationId, organizationId))\n        .orderBy(desc(aevEvaluations.createdAt));\n    }\n    return db.select().from(aevEvaluations).orderBy(desc(aevEvaluations.createdAt));\n  }\n\n  async updateEvaluationStatus(id: string, status: string, executionMode?: string): Promise<void> {\n    const updates: Record<string, any> = { status, updatedAt: new Date() };\n    if (executionMode) {\n      updates.executionMode = executionMode;\n    }\n    await db\n      .update(aevEvaluations)\n      .set(updates)\n      .where(eq(aevEvaluations.id, id));\n  }\n\n  // AEV Result operations\n  async createResult(data: InsertResult & { id: string }): Promise<Result> {\n    const [result] = await db\n      .insert(aevResults)\n      .values({ \n        ...data, \n        completedAt: new Date() \n      } as typeof aevResults.$inferInsert)\n      .returning();\n    return result;\n  }\n\n  async getResultByEvaluationId(evaluationId: string): Promise<Result | undefined> {\n    const [result] = await db\n      .select()\n      .from(aevResults)\n      .where(eq(aevResults.evaluationId, evaluationId));\n    return result;\n  }\n\n  async deleteEvaluation(id: string): Promise<void> {\n    await db.delete(aevEvaluations).where(eq(aevEvaluations.id, id));\n  }\n\n  async deleteResult(evaluationId: string): Promise<void> {\n    await db.delete(aevResults).where(eq(aevResults.evaluationId, evaluationId));\n  }\n\n  async getEvaluationsByDateRange(from: Date, to: Date, organizationId?: string): Promise<Evaluation[]> {\n    if (organizationId) {\n      return db\n        .select()\n        .from(aevEvaluations)\n        .where(and(\n          eq(aevEvaluations.organizationId, organizationId),\n          gte(aevEvaluations.createdAt, from),\n          lte(aevEvaluations.createdAt, to)\n        ))\n        .orderBy(desc(aevEvaluations.createdAt));\n    }\n    return db\n      .select()\n      .from(aevEvaluations)\n      .where(and(\n        gte(aevEvaluations.createdAt, from),\n        lte(aevEvaluations.createdAt, to)\n      ))\n      .orderBy(desc(aevEvaluations.createdAt));\n  }\n\n  async getResultsByEvaluationIds(evaluationIds: string[]): Promise<Result[]> {\n    if (evaluationIds.length === 0) return [];\n    const results = await Promise.all(\n      evaluationIds.map(id => this.getResultByEvaluationId(id))\n    );\n    return results.filter((r): r is Result => r !== undefined);\n  }\n\n  // Report operations\n  async createReport(data: InsertReport): Promise<Report> {\n    const id = `rpt-${randomUUID().slice(0, 8)}`;\n    const [report] = await db\n      .insert(reports)\n      .values({ ...data, id } as typeof reports.$inferInsert)\n      .returning();\n    return report;\n  }\n\n  async getReport(id: string): Promise<Report | undefined> {\n    const [report] = await db\n      .select()\n      .from(reports)\n      .where(eq(reports.id, id));\n    return report;\n  }\n\n  async getReports(organizationId?: string): Promise<Report[]> {\n    if (organizationId) {\n      return db\n        .select()\n        .from(reports)\n        .where(eq(reports.organizationId, organizationId))\n        .orderBy(desc(reports.createdAt));\n    }\n    return db.select().from(reports).orderBy(desc(reports.createdAt));\n  }\n\n  async updateReport(id: string, updates: Partial<Report>): Promise<void> {\n    await db\n      .update(reports)\n      .set(updates)\n      .where(eq(reports.id, id));\n  }\n\n  async deleteReport(id: string): Promise<void> {\n    await db.delete(reports).where(eq(reports.id, id));\n  }\n\n  // Report Narrative operations (V2)\n  async createReportNarrative(data: InsertReportNarrative & { id: string }): Promise<ReportNarrative> {\n    const [narrative] = await db\n      .insert(reportNarratives)\n      .values(data as typeof reportNarratives.$inferInsert)\n      .returning();\n    return narrative;\n  }\n\n  async getReportNarrative(id: string): Promise<ReportNarrative | undefined> {\n    const [narrative] = await db\n      .select()\n      .from(reportNarratives)\n      .where(eq(reportNarratives.id, id));\n    return narrative;\n  }\n\n  async getReportNarrativeByEvaluationId(evaluationId: string): Promise<ReportNarrative | undefined> {\n    const [narrative] = await db\n      .select()\n      .from(reportNarratives)\n      .where(eq(reportNarratives.evaluationId, evaluationId))\n      .orderBy(desc(reportNarratives.createdAt))\n      .limit(1);\n    return narrative;\n  }\n\n  async getReportNarratives(organizationId?: string): Promise<ReportNarrative[]> {\n    if (organizationId) {\n      return db\n        .select()\n        .from(reportNarratives)\n        .where(eq(reportNarratives.organizationId, organizationId))\n        .orderBy(desc(reportNarratives.createdAt));\n    }\n    return db.select().from(reportNarratives).orderBy(desc(reportNarratives.createdAt));\n  }\n\n  // Batch Job operations\n  async createBatchJob(data: InsertBatchJob & { totalEvaluations: number }): Promise<BatchJob> {\n    const id = `batch-${randomUUID().slice(0, 8)}`;\n    const [job] = await db\n      .insert(batchJobs)\n      .values({ ...data, id } as typeof batchJobs.$inferInsert)\n      .returning();\n    return job;\n  }\n\n  async getBatchJob(id: string): Promise<BatchJob | undefined> {\n    const [job] = await db\n      .select()\n      .from(batchJobs)\n      .where(eq(batchJobs.id, id));\n    return job;\n  }\n\n  async getBatchJobs(organizationId?: string): Promise<BatchJob[]> {\n    if (organizationId) {\n      return db\n        .select()\n        .from(batchJobs)\n        .where(eq(batchJobs.organizationId, organizationId))\n        .orderBy(desc(batchJobs.createdAt));\n    }\n    return db.select().from(batchJobs).orderBy(desc(batchJobs.createdAt));\n  }\n\n  async updateBatchJob(id: string, updates: Partial<BatchJob>): Promise<void> {\n    await db\n      .update(batchJobs)\n      .set(updates)\n      .where(eq(batchJobs.id, id));\n  }\n\n  async deleteBatchJob(id: string): Promise<void> {\n    await db.delete(batchJobs).where(eq(batchJobs.id, id));\n  }\n\n  // Scheduled Scan operations\n  async createScheduledScan(data: InsertScheduledScan): Promise<ScheduledScan> {\n    const id = `sched-${randomUUID().slice(0, 8)}`;\n    const [scan] = await db\n      .insert(scheduledScans)\n      .values({ ...data, id } as typeof scheduledScans.$inferInsert)\n      .returning();\n    return scan;\n  }\n\n  async getScheduledScan(id: string): Promise<ScheduledScan | undefined> {\n    const [scan] = await db\n      .select()\n      .from(scheduledScans)\n      .where(eq(scheduledScans.id, id));\n    return scan;\n  }\n\n  async getScheduledScans(organizationId?: string): Promise<ScheduledScan[]> {\n    if (organizationId) {\n      return db\n        .select()\n        .from(scheduledScans)\n        .where(eq(scheduledScans.organizationId, organizationId))\n        .orderBy(desc(scheduledScans.createdAt));\n    }\n    return db.select().from(scheduledScans).orderBy(desc(scheduledScans.createdAt));\n  }\n\n  async updateScheduledScan(id: string, updates: Partial<ScheduledScan>): Promise<void> {\n    await db\n      .update(scheduledScans)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(scheduledScans.id, id));\n  }\n\n  async deleteScheduledScan(id: string): Promise<void> {\n    await db.delete(scheduledScans).where(eq(scheduledScans.id, id));\n  }\n\n  // ========== GOVERNANCE OPERATIONS ==========\n  \n  async getOrganizationGovernance(organizationId: string): Promise<OrganizationGovernance | undefined> {\n    const [governance] = await db\n      .select()\n      .from(organizationGovernance)\n      .where(eq(organizationGovernance.organizationId, organizationId));\n    return governance;\n  }\n\n  async createOrganizationGovernance(data: InsertOrganizationGovernance): Promise<OrganizationGovernance> {\n    const id = `gov-${randomUUID().slice(0, 8)}`;\n    const [governance] = await db\n      .insert(organizationGovernance)\n      .values({ ...data, id } as typeof organizationGovernance.$inferInsert)\n      .returning();\n    return governance;\n  }\n\n  async updateOrganizationGovernance(organizationId: string, updates: Partial<OrganizationGovernance>): Promise<void> {\n    await db\n      .update(organizationGovernance)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(organizationGovernance.organizationId, organizationId));\n  }\n\n  async activateKillSwitch(organizationId: string, activatedBy: string): Promise<void> {\n    await db\n      .update(organizationGovernance)\n      .set({ \n        killSwitchActive: true, \n        killSwitchActivatedAt: new Date(),\n        killSwitchActivatedBy: activatedBy,\n        updatedAt: new Date()\n      })\n      .where(eq(organizationGovernance.organizationId, organizationId));\n  }\n\n  async deactivateKillSwitch(organizationId: string): Promise<void> {\n    await db\n      .update(organizationGovernance)\n      .set({ \n        killSwitchActive: false,\n        killSwitchActivatedAt: null,\n        killSwitchActivatedBy: null,\n        updatedAt: new Date()\n      })\n      .where(eq(organizationGovernance.organizationId, organizationId));\n  }\n\n  // Authorization Log operations\n  async createAuthorizationLog(data: InsertAuthorizationLog): Promise<AuthorizationLog> {\n    const id = `log-${randomUUID().slice(0, 8)}`;\n    const [log] = await db\n      .insert(authorizationLogs)\n      .values({ ...data, id } as typeof authorizationLogs.$inferInsert)\n      .returning();\n    return log;\n  }\n\n  async getAuthorizationLogs(organizationId: string, limit = 100): Promise<AuthorizationLog[]> {\n    return db\n      .select()\n      .from(authorizationLogs)\n      .where(eq(authorizationLogs.organizationId, organizationId))\n      .orderBy(desc(authorizationLogs.createdAt))\n      .limit(limit);\n  }\n\n  // Scope Rule operations\n  async createScopeRule(data: InsertScopeRule): Promise<ScopeRule> {\n    const id = `rule-${randomUUID().slice(0, 8)}`;\n    const [rule] = await db\n      .insert(scopeRules)\n      .values({ ...data, id } as typeof scopeRules.$inferInsert)\n      .returning();\n    return rule;\n  }\n\n  async getScopeRules(organizationId: string): Promise<ScopeRule[]> {\n    return db\n      .select()\n      .from(scopeRules)\n      .where(eq(scopeRules.organizationId, organizationId))\n      .orderBy(desc(scopeRules.priority));\n  }\n\n  async updateScopeRule(id: string, updates: Partial<ScopeRule>): Promise<void> {\n    await db.update(scopeRules).set(updates).where(eq(scopeRules.id, id));\n  }\n\n  async deleteScopeRule(id: string): Promise<void> {\n    await db.delete(scopeRules).where(eq(scopeRules.id, id));\n  }\n\n  // ========== ADVANCED AI OPERATIONS ==========\n\n  // Adversary Profile operations\n  async getAdversaryProfiles(): Promise<AiAdversaryProfile[]> {\n    return db.select().from(aiAdversaryProfiles).orderBy(aiAdversaryProfiles.name);\n  }\n\n  async getAdversaryProfile(id: string): Promise<AiAdversaryProfile | undefined> {\n    const [profile] = await db\n      .select()\n      .from(aiAdversaryProfiles)\n      .where(eq(aiAdversaryProfiles.id, id));\n    return profile;\n  }\n\n  async createAdversaryProfile(data: InsertAiAdversaryProfile): Promise<AiAdversaryProfile> {\n    const id = `adv-${randomUUID().slice(0, 8)}`;\n    const [profile] = await db\n      .insert(aiAdversaryProfiles)\n      .values({ ...data, id } as typeof aiAdversaryProfiles.$inferInsert)\n      .returning();\n    return profile;\n  }\n\n  // Attack Prediction operations\n  async createAttackPrediction(data: InsertAttackPrediction): Promise<AttackPrediction> {\n    const id = `pred-${randomUUID().slice(0, 8)}`;\n    const [prediction] = await db\n      .insert(attackPredictions)\n      .values({ ...data, id } as typeof attackPredictions.$inferInsert)\n      .returning();\n    return prediction;\n  }\n\n  async getAttackPredictions(organizationId: string): Promise<AttackPrediction[]> {\n    return db\n      .select()\n      .from(attackPredictions)\n      .where(eq(attackPredictions.organizationId, organizationId))\n      .orderBy(desc(attackPredictions.createdAt));\n  }\n\n  // Defensive Posture operations\n  async createDefensivePostureScore(data: InsertDefensivePostureScore): Promise<DefensivePostureScore> {\n    const id = `posture-${randomUUID().slice(0, 8)}`;\n    const [score] = await db\n      .insert(defensivePostureScores)\n      .values({ ...data, id } as typeof defensivePostureScores.$inferInsert)\n      .returning();\n    return score;\n  }\n\n  async getLatestDefensivePosture(organizationId: string): Promise<DefensivePostureScore | undefined> {\n    const [score] = await db\n      .select()\n      .from(defensivePostureScores)\n      .where(eq(defensivePostureScores.organizationId, organizationId))\n      .orderBy(desc(defensivePostureScores.calculatedAt))\n      .limit(1);\n    return score;\n  }\n\n  async getDefensivePostureHistory(organizationId: string, limit = 30): Promise<DefensivePostureScore[]> {\n    return db\n      .select()\n      .from(defensivePostureScores)\n      .where(eq(defensivePostureScores.organizationId, organizationId))\n      .orderBy(desc(defensivePostureScores.calculatedAt))\n      .limit(limit);\n  }\n\n  // Purple Team Finding operations\n  async createPurpleTeamFinding(data: InsertPurpleTeamFinding): Promise<PurpleTeamFinding> {\n    const id = `purple-${randomUUID().slice(0, 8)}`;\n    const [finding] = await db\n      .insert(purpleTeamFindings)\n      .values({ ...data, id } as typeof purpleTeamFindings.$inferInsert)\n      .returning();\n    return finding;\n  }\n\n  async getPurpleTeamFindings(organizationId: string): Promise<PurpleTeamFinding[]> {\n    return db\n      .select()\n      .from(purpleTeamFindings)\n      .where(eq(purpleTeamFindings.organizationId, organizationId))\n      .orderBy(desc(purpleTeamFindings.createdAt));\n  }\n\n  async updatePurpleTeamFinding(id: string, updates: Partial<PurpleTeamFinding>): Promise<void> {\n    await db.update(purpleTeamFindings).set(updates).where(eq(purpleTeamFindings.id, id));\n  }\n\n  // AI Simulation operations\n  async createAiSimulation(data: InsertAiSimulation): Promise<AiSimulation> {\n    const id = `sim-${randomUUID().slice(0, 8)}`;\n    const [simulation] = await db\n      .insert(aiSimulations)\n      .values({ ...data, id } as typeof aiSimulations.$inferInsert)\n      .returning();\n    return simulation;\n  }\n\n  async getAiSimulation(id: string): Promise<AiSimulation | undefined> {\n    const [simulation] = await db\n      .select()\n      .from(aiSimulations)\n      .where(eq(aiSimulations.id, id));\n    return simulation;\n  }\n\n  async getAiSimulations(organizationId: string): Promise<AiSimulation[]> {\n    return db\n      .select()\n      .from(aiSimulations)\n      .where(eq(aiSimulations.organizationId, organizationId))\n      .orderBy(desc(aiSimulations.createdAt));\n  }\n\n  async updateAiSimulation(id: string, updates: Partial<AiSimulation>): Promise<void> {\n    await db.update(aiSimulations).set(updates).where(eq(aiSimulations.id, id));\n  }\n\n  async deleteAiSimulation(id: string): Promise<void> {\n    await db.delete(aiSimulations).where(eq(aiSimulations.id, id));\n  }\n\n  async getAllAiSimulations(): Promise<AiSimulation[]> {\n    return db\n      .select()\n      .from(aiSimulations)\n      .orderBy(desc(aiSimulations.createdAt));\n  }\n\n  // ============================================\n  // INFRASTRUCTURE DATA INGESTION OPERATIONS\n  // ============================================\n\n  // Discovered Asset operations\n  async createDiscoveredAsset(data: InsertDiscoveredAsset): Promise<DiscoveredAsset> {\n    const id = `asset-${randomUUID().slice(0, 8)}`;\n    const [asset] = await db\n      .insert(discoveredAssets)\n      .values({ ...data, id } as typeof discoveredAssets.$inferInsert)\n      .returning();\n    return asset;\n  }\n\n  async createDiscoveredAssets(assets: InsertDiscoveredAsset[]): Promise<DiscoveredAsset[]> {\n    if (assets.length === 0) return [];\n    const assetsWithIds = assets.map(a => ({\n      ...a,\n      id: `asset-${randomUUID().slice(0, 8)}`,\n    }));\n    return db\n      .insert(discoveredAssets)\n      .values(assetsWithIds as Array<typeof discoveredAssets.$inferInsert>)\n      .returning();\n  }\n\n  async getDiscoveredAsset(id: string): Promise<DiscoveredAsset | undefined> {\n    const [asset] = await db\n      .select()\n      .from(discoveredAssets)\n      .where(eq(discoveredAssets.id, id));\n    return asset;\n  }\n\n  async getDiscoveredAssets(organizationId?: string): Promise<DiscoveredAsset[]> {\n    if (organizationId) {\n      return db\n        .select()\n        .from(discoveredAssets)\n        .where(eq(discoveredAssets.organizationId, organizationId))\n        .orderBy(desc(discoveredAssets.createdAt));\n    }\n    return db.select().from(discoveredAssets).orderBy(desc(discoveredAssets.createdAt));\n  }\n\n  async getDiscoveredAssetByIdentifier(assetIdentifier: string, organizationId?: string): Promise<DiscoveredAsset | undefined> {\n    const conditions = organizationId \n      ? and(eq(discoveredAssets.assetIdentifier, assetIdentifier), eq(discoveredAssets.organizationId, organizationId))\n      : eq(discoveredAssets.assetIdentifier, assetIdentifier);\n    const [asset] = await db.select().from(discoveredAssets).where(conditions);\n    return asset;\n  }\n\n  async updateDiscoveredAsset(id: string, updates: Partial<DiscoveredAsset>): Promise<void> {\n    await db.update(discoveredAssets).set({ ...updates, updatedAt: new Date() }).where(eq(discoveredAssets.id, id));\n  }\n\n  async deleteDiscoveredAsset(id: string): Promise<void> {\n    await db.delete(discoveredAssets).where(eq(discoveredAssets.id, id));\n  }\n\n  // Vulnerability Import operations\n  async createVulnerabilityImport(data: InsertVulnerabilityImport): Promise<VulnerabilityImport> {\n    const id = `vuln-${randomUUID().slice(0, 8)}`;\n    const [vuln] = await db\n      .insert(vulnerabilityImports)\n      .values({ ...data, id } as typeof vulnerabilityImports.$inferInsert)\n      .returning();\n    return vuln;\n  }\n\n  async createVulnerabilityImports(vulns: InsertVulnerabilityImport[]): Promise<VulnerabilityImport[]> {\n    if (vulns.length === 0) return [];\n    const vulnsWithIds = vulns.map(v => ({\n      ...v,\n      id: `vuln-${randomUUID().slice(0, 8)}`,\n    }));\n    return db\n      .insert(vulnerabilityImports)\n      .values(vulnsWithIds as Array<typeof vulnerabilityImports.$inferInsert>)\n      .returning();\n  }\n\n  async getVulnerabilityImport(id: string): Promise<VulnerabilityImport | undefined> {\n    const [vuln] = await db\n      .select()\n      .from(vulnerabilityImports)\n      .where(eq(vulnerabilityImports.id, id));\n    return vuln;\n  }\n\n  async getVulnerabilityImports(organizationId?: string): Promise<VulnerabilityImport[]> {\n    if (organizationId) {\n      return db\n        .select()\n        .from(vulnerabilityImports)\n        .where(eq(vulnerabilityImports.organizationId, organizationId))\n        .orderBy(desc(vulnerabilityImports.createdAt));\n    }\n    return db.select().from(vulnerabilityImports).orderBy(desc(vulnerabilityImports.createdAt));\n  }\n\n  async getVulnerabilityImportsByJobId(importJobId: string): Promise<VulnerabilityImport[]> {\n    return db\n      .select()\n      .from(vulnerabilityImports)\n      .where(eq(vulnerabilityImports.importJobId, importJobId))\n      .orderBy(desc(vulnerabilityImports.createdAt));\n  }\n\n  async getVulnerabilityImportsByAssetId(assetId: string): Promise<VulnerabilityImport[]> {\n    return db\n      .select()\n      .from(vulnerabilityImports)\n      .where(eq(vulnerabilityImports.assetId, assetId))\n      .orderBy(desc(vulnerabilityImports.createdAt));\n  }\n\n  async updateVulnerabilityImport(id: string, updates: Partial<VulnerabilityImport>): Promise<void> {\n    await db.update(vulnerabilityImports).set({ ...updates, updatedAt: new Date() }).where(eq(vulnerabilityImports.id, id));\n  }\n\n  async deleteVulnerabilityImport(id: string): Promise<void> {\n    await db.delete(vulnerabilityImports).where(eq(vulnerabilityImports.id, id));\n  }\n\n  // Import Job operations\n  async createImportJob(data: InsertImportJob): Promise<ImportJob> {\n    const id = `import-${randomUUID().slice(0, 8)}`;\n    const [job] = await db\n      .insert(importJobs)\n      .values({ ...data, id } as typeof importJobs.$inferInsert)\n      .returning();\n    return job;\n  }\n\n  async getImportJob(id: string): Promise<ImportJob | undefined> {\n    const [job] = await db\n      .select()\n      .from(importJobs)\n      .where(eq(importJobs.id, id));\n    return job;\n  }\n\n  async getImportJobs(organizationId?: string): Promise<ImportJob[]> {\n    if (organizationId) {\n      return db\n        .select()\n        .from(importJobs)\n        .where(eq(importJobs.organizationId, organizationId))\n        .orderBy(desc(importJobs.createdAt));\n    }\n    return db.select().from(importJobs).orderBy(desc(importJobs.createdAt));\n  }\n\n  async updateImportJob(id: string, updates: Partial<ImportJob>): Promise<void> {\n    await db.update(importJobs).set(updates).where(eq(importJobs.id, id));\n  }\n\n  async deleteImportJob(id: string): Promise<void> {\n    await db.delete(vulnerabilityImports).where(eq(vulnerabilityImports.importJobId, id));\n    await db.delete(importJobs).where(eq(importJobs.id, id));\n  }\n\n  // Cloud Connection operations\n  async createCloudConnection(data: InsertCloudConnection): Promise<CloudConnection> {\n    const id = `cloud-${randomUUID().slice(0, 8)}`;\n    const [connection] = await db\n      .insert(cloudConnections)\n      .values({ ...data, id } as typeof cloudConnections.$inferInsert)\n      .returning();\n    return connection;\n  }\n\n  async getCloudConnection(id: string): Promise<CloudConnection | undefined> {\n    const [connection] = await db\n      .select()\n      .from(cloudConnections)\n      .where(eq(cloudConnections.id, id));\n    return connection;\n  }\n\n  async getCloudConnections(organizationId?: string): Promise<CloudConnection[]> {\n    if (organizationId) {\n      return db\n        .select()\n        .from(cloudConnections)\n        .where(eq(cloudConnections.organizationId, organizationId))\n        .orderBy(desc(cloudConnections.createdAt));\n    }\n    return db.select().from(cloudConnections).orderBy(desc(cloudConnections.createdAt));\n  }\n\n  async updateCloudConnection(id: string, updates: Partial<CloudConnection>): Promise<void> {\n    await db.update(cloudConnections).set({ ...updates, updatedAt: new Date() }).where(eq(cloudConnections.id, id));\n  }\n\n  async deleteCloudConnection(id: string): Promise<void> {\n    await db.delete(cloudConnections).where(eq(cloudConnections.id, id));\n  }\n\n  // Get asset and vulnerability counts for dashboard\n  async getInfrastructureStats(organizationId?: string): Promise<{\n    totalAssets: number;\n    totalVulnerabilities: number;\n    criticalVulns: number;\n    highVulns: number;\n    pendingImports: number;\n    cloudConnections: number;\n  }> {\n    const orgFilter = organizationId ? eq(discoveredAssets.organizationId, organizationId) : sql`1=1`;\n    const vulnOrgFilter = organizationId ? eq(vulnerabilityImports.organizationId, organizationId) : sql`1=1`;\n    \n    const [assetCount] = await db.select({ count: sql<number>`count(*)::int` }).from(discoveredAssets).where(orgFilter);\n    const [vulnCount] = await db.select({ count: sql<number>`count(*)::int` }).from(vulnerabilityImports).where(vulnOrgFilter);\n    const [criticalCount] = await db.select({ count: sql<number>`count(*)::int` }).from(vulnerabilityImports).where(and(vulnOrgFilter, eq(vulnerabilityImports.severity, \"critical\")));\n    const [highCount] = await db.select({ count: sql<number>`count(*)::int` }).from(vulnerabilityImports).where(and(vulnOrgFilter, eq(vulnerabilityImports.severity, \"high\")));\n    const [pendingCount] = await db.select({ count: sql<number>`count(*)::int` }).from(importJobs).where(eq(importJobs.status, \"pending\"));\n    const [cloudCount] = await db.select({ count: sql<number>`count(*)::int` }).from(cloudConnections).where(eq(cloudConnections.status, \"connected\"));\n\n    return {\n      totalAssets: assetCount?.count || 0,\n      totalVulnerabilities: vulnCount?.count || 0,\n      criticalVulns: criticalCount?.count || 0,\n      highVulns: highCount?.count || 0,\n      pendingImports: pendingCount?.count || 0,\n      cloudConnections: cloudCount?.count || 0,\n    };\n  }\n\n  // ========== ENDPOINT AGENT OPERATIONS ==========\n  \n  // Endpoint Agent operations\n  async createEndpointAgent(data: InsertEndpointAgent): Promise<EndpointAgent> {\n    const id = `agent-${randomUUID().slice(0, 8)}`;\n    const [agent] = await db\n      .insert(endpointAgents)\n      .values({ ...data, id } as typeof endpointAgents.$inferInsert)\n      .returning();\n    return agent;\n  }\n\n  async getEndpointAgent(id: string): Promise<EndpointAgent | undefined> {\n    const [agent] = await db\n      .select()\n      .from(endpointAgents)\n      .where(eq(endpointAgents.id, id));\n    return agent;\n  }\n\n  async getEndpointAgentByApiKey(apiKey: string): Promise<EndpointAgent | undefined> {\n    const [agent] = await db\n      .select()\n      .from(endpointAgents)\n      .where(eq(endpointAgents.apiKey, apiKey));\n    return agent;\n  }\n\n  async getEndpointAgents(organizationId?: string): Promise<EndpointAgent[]> {\n    if (organizationId) {\n      return db\n        .select()\n        .from(endpointAgents)\n        .where(eq(endpointAgents.organizationId, organizationId))\n        .orderBy(desc(endpointAgents.registeredAt));\n    }\n    return db.select().from(endpointAgents).orderBy(desc(endpointAgents.registeredAt));\n  }\n\n  async updateEndpointAgent(id: string, updates: Partial<EndpointAgent>): Promise<void> {\n    await db.update(endpointAgents).set({ ...updates, updatedAt: new Date() }).where(eq(endpointAgents.id, id));\n  }\n\n  async deleteEndpointAgent(id: string): Promise<void> {\n    await db.delete(agentFindings).where(eq(agentFindings.agentId, id));\n    await db.delete(agentTelemetry).where(eq(agentTelemetry.agentId, id));\n    await db.delete(endpointAgents).where(eq(endpointAgents.id, id));\n  }\n\n  async updateAgentHeartbeat(id: string): Promise<void> {\n    await db.update(endpointAgents).set({ \n      lastHeartbeat: new Date(),\n      status: \"online\",\n      updatedAt: new Date()\n    }).where(eq(endpointAgents.id, id));\n  }\n\n  // Agent Telemetry operations\n  async createAgentTelemetry(data: InsertAgentTelemetry): Promise<AgentTelemetry> {\n    const id = `tel-${randomUUID().slice(0, 8)}`;\n    const [telemetry] = await db\n      .insert(agentTelemetry)\n      .values({ ...data, id } as typeof agentTelemetry.$inferInsert)\n      .returning();\n    \n    await db.update(endpointAgents).set({ \n      lastTelemetry: new Date(),\n      status: \"online\",\n      updatedAt: new Date()\n    }).where(eq(endpointAgents.id, data.agentId));\n    \n    return telemetry;\n  }\n\n  async getAgentTelemetry(agentId: string, limit: number = 100): Promise<AgentTelemetry[]> {\n    return db\n      .select()\n      .from(agentTelemetry)\n      .where(eq(agentTelemetry.agentId, agentId))\n      .orderBy(desc(agentTelemetry.collectedAt))\n      .limit(limit);\n  }\n\n  async getLatestAgentTelemetry(agentId: string): Promise<AgentTelemetry | undefined> {\n    const [telemetry] = await db\n      .select()\n      .from(agentTelemetry)\n      .where(eq(agentTelemetry.agentId, agentId))\n      .orderBy(desc(agentTelemetry.collectedAt))\n      .limit(1);\n    return telemetry;\n  }\n\n  // Agent Finding operations\n  async createAgentFinding(data: InsertAgentFinding): Promise<AgentFinding> {\n    const id = `finding-${randomUUID().slice(0, 8)}`;\n    const [finding] = await db\n      .insert(agentFindings)\n      .values({ ...data, id } as typeof agentFindings.$inferInsert)\n      .returning();\n    return finding;\n  }\n\n  async getAgentFinding(id: string): Promise<AgentFinding | undefined> {\n    const [finding] = await db\n      .select()\n      .from(agentFindings)\n      .where(eq(agentFindings.id, id));\n    return finding;\n  }\n\n  async getAgentFindings(agentId?: string, organizationId?: string): Promise<AgentFinding[]> {\n    if (agentId) {\n      return db\n        .select()\n        .from(agentFindings)\n        .where(eq(agentFindings.agentId, agentId))\n        .orderBy(desc(agentFindings.detectedAt));\n    }\n    if (organizationId) {\n      return db\n        .select()\n        .from(agentFindings)\n        .where(eq(agentFindings.organizationId, organizationId))\n        .orderBy(desc(agentFindings.detectedAt));\n    }\n    return db.select().from(agentFindings).orderBy(desc(agentFindings.detectedAt));\n  }\n\n  async getUnprocessedFindings(organizationId?: string): Promise<AgentFinding[]> {\n    const baseQuery = db\n      .select()\n      .from(agentFindings)\n      .where(and(\n        eq(agentFindings.autoEvaluationTriggered, false),\n        eq(agentFindings.status, \"new\")\n      ))\n      .orderBy(desc(agentFindings.detectedAt));\n    return baseQuery;\n  }\n\n  async updateAgentFinding(id: string, updates: Partial<AgentFinding>): Promise<void> {\n    await db.update(agentFindings).set({ ...updates, updatedAt: new Date() }).where(eq(agentFindings.id, id));\n  }\n\n  async deleteAgentFinding(id: string): Promise<void> {\n    await db.delete(agentFindings).where(eq(agentFindings.id, id));\n  }\n\n  // Agent stats for dashboard\n  async getAgentStats(organizationId?: string): Promise<{\n    totalAgents: number;\n    onlineAgents: number;\n    offlineAgents: number;\n    totalFindings: number;\n    criticalFindings: number;\n    highFindings: number;\n    newFindings: number;\n  }> {\n    const orgFilter = organizationId ? eq(endpointAgents.organizationId, organizationId) : sql`1=1`;\n    const findingOrgFilter = organizationId ? eq(agentFindings.organizationId, organizationId) : sql`1=1`;\n    \n    const [totalAgents] = await db.select({ count: sql<number>`count(*)::int` }).from(endpointAgents).where(orgFilter);\n    const [onlineAgents] = await db.select({ count: sql<number>`count(*)::int` }).from(endpointAgents).where(and(orgFilter, eq(endpointAgents.status, \"online\")));\n    const [offlineAgents] = await db.select({ count: sql<number>`count(*)::int` }).from(endpointAgents).where(and(orgFilter, eq(endpointAgents.status, \"offline\")));\n    const [totalFindings] = await db.select({ count: sql<number>`count(*)::int` }).from(agentFindings).where(findingOrgFilter);\n    const [criticalFindings] = await db.select({ count: sql<number>`count(*)::int` }).from(agentFindings).where(and(findingOrgFilter, eq(agentFindings.severity, \"critical\")));\n    const [highFindings] = await db.select({ count: sql<number>`count(*)::int` }).from(agentFindings).where(and(findingOrgFilter, eq(agentFindings.severity, \"high\")));\n    const [newFindings] = await db.select({ count: sql<number>`count(*)::int` }).from(agentFindings).where(and(findingOrgFilter, eq(agentFindings.status, \"new\")));\n\n    return {\n      totalAgents: totalAgents?.count || 0,\n      onlineAgents: onlineAgents?.count || 0,\n      offlineAgents: offlineAgents?.count || 0,\n      totalFindings: totalFindings?.count || 0,\n      criticalFindings: criticalFindings?.count || 0,\n      highFindings: highFindings?.count || 0,\n      newFindings: newFindings?.count || 0,\n    };\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":36692,"size_tokens":null},"client/src/components/AttackPathVisualizer.tsx":{"content":"import { Shield, AlertTriangle, ChevronRight, Lock, Database, Server, Globe, Key, Radar, Bug, Move, Workflow, TrendingUp } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface AttackStep {\n  id: number;\n  title: string;\n  description: string;\n  technique?: string;\n  severity: \"critical\" | \"high\" | \"medium\" | \"low\";\n  discoveredBy?: \"recon\" | \"exploit\" | \"lateral\" | \"business-logic\" | \"impact\";\n}\n\ninterface AttackPathVisualizerProps {\n  steps: AttackStep[];\n  isExploitable: boolean;\n}\n\nexport function AttackPathVisualizer({ steps, isExploitable }: AttackPathVisualizerProps) {\n  const getStepIcon = (index: number) => {\n    const icons = [Globe, Key, Lock, Server, Database];\n    const Icon = icons[index % icons.length];\n    return Icon;\n  };\n\n  const getSeverityColor = (severity: string) => {\n    switch (severity) {\n      case \"critical\": return \"border-red-500/50 bg-red-500/10 text-red-400\";\n      case \"high\": return \"border-orange-500/50 bg-orange-500/10 text-orange-400\";\n      case \"medium\": return \"border-amber-500/50 bg-amber-500/10 text-amber-400\";\n      case \"low\": return \"border-emerald-500/50 bg-emerald-500/10 text-emerald-400\";\n      default: return \"border-border bg-muted/30 text-muted-foreground\";\n    }\n  };\n\n  const getAgentInfo = (agent?: string) => {\n    const agentMap: Record<string, { label: string; icon: typeof Radar; color: string }> = {\n      \"recon\": { label: \"Recon\", icon: Radar, color: \"bg-cyan-500/10 text-cyan-400 border-cyan-500/30\" },\n      \"exploit\": { label: \"Exploit\", icon: Bug, color: \"bg-red-500/10 text-red-400 border-red-500/30\" },\n      \"lateral\": { label: \"Lateral\", icon: Move, color: \"bg-purple-500/10 text-purple-400 border-purple-500/30\" },\n      \"business-logic\": { label: \"Logic\", icon: Workflow, color: \"bg-amber-500/10 text-amber-400 border-amber-500/30\" },\n      \"impact\": { label: \"Impact\", icon: TrendingUp, color: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\" },\n    };\n    return agent ? agentMap[agent] : undefined;\n  };\n\n  if (steps.length === 0) {\n    return (\n      <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n        <div className=\"p-4 rounded-full bg-emerald-500/10 mb-4\">\n          <Shield className=\"h-10 w-10 text-emerald-400\" />\n        </div>\n        <h4 className=\"font-semibold text-emerald-400\">No Attack Path Identified</h4>\n        <p className=\"text-sm text-muted-foreground mt-1 max-w-xs\">\n          The AI agents could not find a viable exploit chain for this exposure.\n        </p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\" data-testid=\"attack-path-visualizer\">\n      <div className=\"flex items-center gap-2 mb-4\">\n        <AlertTriangle className={`h-5 w-5 ${isExploitable ? \"text-red-400\" : \"text-emerald-400\"}`} />\n        <span className={`text-sm font-medium ${isExploitable ? \"text-red-400\" : \"text-emerald-400\"}`}>\n          {steps.length} Step Attack Chain {isExploitable ? \"Discovered\" : \"Analyzed\"}\n        </span>\n      </div>\n\n      <div className=\"relative\">\n        {steps.map((step, index) => {\n          const StepIcon = getStepIcon(index);\n          return (\n            <div key={step.id} className=\"flex gap-4\" data-testid={`attack-step-${step.id}`}>\n              <div className=\"flex flex-col items-center\">\n                <div className={`w-10 h-10 rounded-full flex items-center justify-center border-2 ${\n                  isExploitable \n                    ? \"border-red-500/50 bg-red-500/10\" \n                    : \"border-cyan-500/50 bg-cyan-500/10\"\n                }`}>\n                  <span className={`text-sm font-bold ${isExploitable ? \"text-red-400\" : \"text-cyan-400\"}`}>\n                    {index + 1}\n                  </span>\n                </div>\n                {index < steps.length - 1 && (\n                  <div className={`w-0.5 h-16 ${isExploitable ? \"bg-red-500/30\" : \"bg-cyan-500/30\"}`} />\n                )}\n              </div>\n              <div className={`flex-1 pb-6 ${index === steps.length - 1 ? \"\" : \"\"}`}>\n                <div className={`p-4 rounded-lg border ${getSeverityColor(step.severity)}`}>\n                  <div className=\"flex items-start gap-3\">\n                    <StepIcon className=\"h-5 w-5 flex-shrink-0 mt-0.5\" />\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 flex-wrap\">\n                        <h5 className=\"font-medium text-foreground\">{step.title}</h5>\n                        {step.technique && (\n                          <code className=\"text-[10px] px-1.5 py-0.5 rounded bg-background/50 text-muted-foreground\">\n                            {step.technique}\n                          </code>\n                        )}\n                        {step.discoveredBy && (() => {\n                          const agentInfo = getAgentInfo(step.discoveredBy);\n                          if (!agentInfo) return null;\n                          const AgentIcon = agentInfo.icon;\n                          return (\n                            <Badge \n                              className={`${agentInfo.color} text-[10px] gap-1`}\n                              data-testid={`agent-badge-${step.id}`}\n                            >\n                              <AgentIcon className=\"h-3 w-3\" />\n                              {agentInfo.label}\n                            </Badge>\n                          );\n                        })()}\n                      </div>\n                      <p className=\"text-sm text-muted-foreground mt-1\">{step.description}</p>\n                    </div>\n                    {index < steps.length - 1 && (\n                      <ChevronRight className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                    )}\n                  </div>\n                </div>\n              </div>\n            </div>\n          );\n        })}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":5934,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1080,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { serveStatic } from \"./static\";\nimport { createServer } from \"http\";\nimport { createDatabaseIndexes } from \"./db-indexes\";\n\nconst app = express();\nconst httpServer = createServer(app);\n\ndeclare module \"http\" {\n  interface IncomingMessage {\n    rawBody: unknown;\n  }\n}\n\n// JSON body parser with gzip/deflate support for Go agent telemetry\napp.use(\n  express.json({\n    inflate: true,\n    limit: \"10mb\",\n    verify: (req, _res, buf) => {\n      req.rawBody = buf;\n    },\n  }),\n);\n\napp.use(express.urlencoded({ extended: false }));\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  try {\n    await createDatabaseIndexes();\n  } catch (error) {\n    console.warn(\"Database indexing skipped:\", error instanceof Error ? error.message : error);\n  }\n  \n  await registerRoutes(httpServer, app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (process.env.NODE_ENV === \"production\") {\n    serveStatic(app);\n  } else {\n    const { setupVite } = await import(\"./vite\");\n    await setupVite(httpServer, app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || \"5000\", 10);\n  httpServer.listen(\n    {\n      port,\n      host: \"0.0.0.0\",\n      reusePort: true,\n    },\n    () => {\n      log(`serving on port ${port}`);\n    },\n  );\n})();\n","path":null,"size_bytes":2887,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { ThemeProvider, useTheme } from \"./components/ThemeProvider\";\nimport { AuthProvider } from \"./contexts/AuthContext\";\nimport { ViewModeProvider, useViewMode } from \"./contexts/ViewModeContext\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { AppSidebar } from \"./components/AppSidebar\";\nimport { ViewModeToggle } from \"./components/ViewModeToggle\";\nimport { Dashboard } from \"./components/Dashboard\";\nimport RiskDashboard from \"@/pages/RiskDashboard\";\nimport Assets from \"@/pages/Assets\";\nimport Infrastructure from \"@/pages/Infrastructure\";\nimport Reports from \"@/pages/Reports\";\nimport BatchJobs from \"@/pages/BatchJobs\";\nimport Governance from \"@/pages/Governance\";\nimport Advanced from \"@/pages/Advanced\";\nimport Agents from \"@/pages/Agents\";\nimport Simulations from \"@/pages/Simulations\";\nimport UserManagement from \"@/pages/UserManagement\";\nimport Settings from \"@/pages/Settings\";\nimport NotFound from \"@/pages/not-found\";\nimport { Button } from \"@/components/ui/button\";\nimport { Moon, Sun, Bell, User, ChevronDown } from \"lucide-react\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n  DropdownMenuSeparator,\n} from \"@/components/ui/dropdown-menu\";\nimport { useAuth } from \"./contexts/AuthContext\";\nimport { roleMetadata } from \"@shared/schema\";\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/\" component={Dashboard} />\n      <Route path=\"/risk\" component={RiskDashboard} />\n      <Route path=\"/assets\" component={Assets} />\n      <Route path=\"/infrastructure\" component={Infrastructure} />\n      <Route path=\"/reports\" component={Reports} />\n      <Route path=\"/batch\" component={BatchJobs} />\n      <Route path=\"/governance\" component={Governance} />\n      <Route path=\"/agents\" component={Agents} />\n      <Route path=\"/simulations\" component={Simulations} />\n      <Route path=\"/advanced\" component={Advanced} />\n      <Route path=\"/admin/users\" component={UserManagement} />\n      <Route path=\"/admin/settings\" component={Settings} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction AppHeader() {\n  const { theme, toggleTheme } = useTheme();\n  const { viewMode, setViewMode } = useViewMode();\n  const { user, setUserRole, availableRoles } = useAuth();\n\n  return (\n    <header className=\"h-14 border-b border-border bg-card/80 backdrop-blur-sm sticky top-0 z-40\">\n      <div className=\"h-full px-4 flex items-center justify-between gap-4\">\n        <div className=\"flex items-center gap-2\">\n          <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n        </div>\n\n        <div className=\"flex items-center gap-3\">\n          <ViewModeToggle mode={viewMode} onChange={setViewMode} />\n          \n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={toggleTheme}\n            data-testid=\"button-theme-toggle\"\n          >\n            {theme === \"dark\" ? (\n              <Sun className=\"h-4 w-4\" />\n            ) : (\n              <Moon className=\"h-4 w-4\" />\n            )}\n          </Button>\n          \n          <Button variant=\"ghost\" size=\"icon\" className=\"relative\" data-testid=\"button-notifications\">\n            <Bell className=\"h-4 w-4\" />\n            <span className=\"absolute top-1.5 right-1.5 h-2 w-2 bg-red-500 rounded-full\" />\n          </Button>\n          \n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"ghost\" size=\"sm\" className=\"gap-2\" data-testid=\"button-user-menu\">\n                <div className=\"h-7 w-7 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center\">\n                  <User className=\"h-4 w-4 text-white\" />\n                </div>\n                <span className=\"hidden sm:inline text-sm\">{user?.displayName || user?.username || \"User\"}</span>\n                <ChevronDown className=\"h-3 w-3\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\" className=\"w-56\">\n              <DropdownMenuItem data-testid=\"menu-profile\">Profile</DropdownMenuItem>\n              <DropdownMenuItem data-testid=\"menu-settings\">Settings</DropdownMenuItem>\n              <DropdownMenuSeparator />\n              <div className=\"px-2 py-1.5 text-xs text-muted-foreground\">Switch Role (Demo)</div>\n              {availableRoles.map(role => (\n                <DropdownMenuItem \n                  key={role}\n                  onClick={() => setUserRole(role)}\n                  className={user?.role === role ? \"bg-accent\" : \"\"}\n                  data-testid={`menu-role-${role}`}\n                >\n                  {roleMetadata[role]?.displayName || role}\n                  {user?.role === role && <span className=\"ml-auto text-xs text-muted-foreground\">Current</span>}\n                </DropdownMenuItem>\n              ))}\n              <DropdownMenuSeparator />\n              <DropdownMenuItem data-testid=\"menu-logout\">Log out</DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      </div>\n    </header>\n  );\n}\n\nfunction AppLayout() {\n  const sidebarStyle = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  };\n\n  return (\n    <SidebarProvider style={sidebarStyle as React.CSSProperties}>\n      <div className=\"flex h-screen w-full\">\n        <AppSidebar />\n        <div className=\"flex flex-col flex-1 overflow-hidden\">\n          <AppHeader />\n          <main className=\"flex-1 overflow-auto p-6\">\n            <Router />\n          </main>\n        </div>\n      </div>\n    </SidebarProvider>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider>\n        <AuthProvider>\n          <ViewModeProvider>\n            <TooltipProvider>\n              <AppLayout />\n              <Toaster />\n            </TooltipProvider>\n          </ViewModeProvider>\n        </AuthProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":6255,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"server/services/agents/multi-vector.ts":{"content":"import OpenAI from \"openai\";\nimport type { \n  AgentMemory, \n  AgentResult, \n  MultiVectorFindings,\n  CloudFinding,\n  IAMFinding,\n  SaaSFinding,\n  ShadowAdminIndicator,\n  ChainedAttackPath\n} from \"./types\";\nimport type { MultiVectorFinding, CloudVectorType } from \"@shared/schema\";\nimport { cloudVectorTypes } from \"@shared/schema\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\ntype ProgressCallback = (stage: string, progress: number, message: string) => void;\n\nconst MULTI_VECTOR_EXPOSURE_TYPES = [\n  \"cloud_misconfiguration\",\n  \"iam_abuse\",\n  \"saas_permission\",\n  \"shadow_admin\"\n];\n\nexport function shouldRunMultiVectorAnalysis(exposureType: string): boolean {\n  return MULTI_VECTOR_EXPOSURE_TYPES.includes(exposureType);\n}\n\nexport async function runMultiVectorAnalysisAgent(\n  memory: AgentMemory,\n  onProgress?: ProgressCallback\n): Promise<AgentResult<MultiVectorFindings>> {\n  const startTime = Date.now();\n  \n  onProgress?.(\"multi_vector\", 60, \"Initializing multi-vector analysis...\");\n\n  onProgress?.(\"multi_vector\", 63, \"Analyzing cloud misconfigurations...\");\n  const cloudFindings = await analyzeCloudVectors(memory);\n  \n  onProgress?.(\"multi_vector\", 68, \"Analyzing IAM abuse paths...\");\n  const iamFindings = await analyzeIAMAbuse(memory);\n  \n  onProgress?.(\"multi_vector\", 73, \"Analyzing SaaS permissions...\");\n  const saasFindings = await analyzeSaaSPermissions(memory);\n  \n  onProgress?.(\"multi_vector\", 78, \"Discovering shadow admins...\");\n  const shadowAdminIndicators = await discoverShadowAdmins(memory, iamFindings, saasFindings);\n  \n  onProgress?.(\"multi_vector\", 83, \"Building chained attack paths...\");\n  const chainedAttackPaths = await buildChainedAttackPaths(\n    memory, \n    cloudFindings, \n    iamFindings, \n    saasFindings\n  );\n  \n  onProgress?.(\"multi_vector\", 88, \"Generating multi-vector findings...\");\n  const findings = generateMultiVectorFindings(\n    cloudFindings,\n    iamFindings,\n    saasFindings,\n    shadowAdminIndicators\n  );\n\n  const multiVectorFindings: MultiVectorFindings = {\n    findings,\n    cloudFindings,\n    iamFindings,\n    saasFindings,\n    shadowAdminIndicators,\n    chainedAttackPaths,\n  };\n\n  return {\n    success: true,\n    findings: multiVectorFindings,\n    agentName: \"Multi-Vector Analysis Agent\",\n    processingTime: Date.now() - startTime,\n  };\n}\n\nasync function analyzeCloudVectors(memory: AgentMemory): Promise<CloudFinding[]> {\n  const isCloudRelated = [\n    \"cloud_misconfiguration\",\n    \"iam_abuse\"\n  ].includes(memory.context.exposureType);\n\n  if (!isCloudRelated) {\n    return [];\n  }\n\n  const systemPrompt = `You are a CLOUD SECURITY ANALYZER for OdinForge AI.\n\nYour task is to identify cloud misconfigurations and abuse paths across AWS, GCP, and Azure:\n1. S3/Storage bucket exposures\n2. IAM role chaining opportunities\n3. Cross-account access vectors\n4. Metadata service abuse (IMDS)\n5. Lambda/Function privilege escalation\n6. Service account abuse\n7. Permission boundary bypasses\n8. Resource policy misconfigurations\n\nFor each finding, provide exploitation path and remediation steps.`;\n\n  const userPrompt = `Analyze cloud security vectors for:\n\nAsset ID: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nDescription: ${memory.context.description}\n\n${memory.recon ? `Technologies: ${memory.recon.technologies.join(\", \")}\nEntry Points: ${memory.recon.entryPoints.join(\", \")}` : \"\"}\n\nReturn a JSON object with this structure:\n{\n  \"findings\": [\n    {\n      \"id\": \"cloud_finding_id\",\n      \"vectorType\": \"${cloudVectorTypes.join(\"|\")}\",\n      \"provider\": \"aws|gcp|azure|multi-cloud\",\n      \"service\": \"service name (e.g., S3, IAM, Lambda)\",\n      \"resource\": \"affected resource identifier\",\n      \"title\": \"Finding title\",\n      \"description\": \"Detailed description\",\n      \"severity\": \"critical|high|medium|low\",\n      \"exploitPath\": [\"step1\", \"step2\", \"step3\"],\n      \"remediationSteps\": [\"fix1\", \"fix2\"]\n    }\n  ]\n}`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 2048,\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) return [];\n\n    const result = JSON.parse(content);\n    return Array.isArray(result.findings) ? result.findings : [];\n  } catch (error) {\n    console.error(\"Cloud vector analysis error:\", error);\n    return [];\n  }\n}\n\nasync function analyzeIAMAbuse(memory: AgentMemory): Promise<IAMFinding[]> {\n  const isIAMRelated = [\n    \"iam_abuse\",\n    \"cloud_misconfiguration\",\n    \"privilege_boundary\"\n  ].includes(memory.context.exposureType);\n\n  if (!isIAMRelated) {\n    return [];\n  }\n\n  const systemPrompt = `You are an IAM ABUSE PATH ANALYZER for OdinForge AI.\n\nYour task is to identify IAM misconfigurations and privilege escalation paths:\n1. Overly permissive IAM policies\n2. Role assumption chains\n3. Cross-account trust relationships\n4. Service-linked role abuse\n5. Permission boundary bypasses\n6. Policy wildcard abuse\n7. Condition key bypasses\n\nFor each finding, map the privilege escalation path from initial access to objective.`;\n\n  const userPrompt = `Analyze IAM abuse paths for:\n\nAsset ID: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nDescription: ${memory.context.description}\n\n${memory.lateral ? `Privilege Escalation Paths: ${memory.lateral.privilegeEscalation.map(p => \n  `${p.target} via ${p.method}`\n).join(\", \")}` : \"\"}\n\nReturn a JSON object with this structure:\n{\n  \"findings\": [\n    {\n      \"id\": \"iam_finding_id\",\n      \"principal\": \"arn:aws:iam::...\",\n      \"assumableRoles\": [\"role1\", \"role2\"],\n      \"effectivePermissions\": [\"permission1\", \"permission2\"],\n      \"privilegeEscalationPath\": \"description of escalation path or null\",\n      \"severity\": \"critical|high|medium|low\",\n      \"title\": \"Finding title\",\n      \"description\": \"Detailed description\"\n    }\n  ]\n}`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 2048,\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) return [];\n\n    const result = JSON.parse(content);\n    return Array.isArray(result.findings) ? result.findings : [];\n  } catch (error) {\n    console.error(\"IAM abuse analysis error:\", error);\n    return [];\n  }\n}\n\nasync function analyzeSaaSPermissions(memory: AgentMemory): Promise<SaaSFinding[]> {\n  const isSaaSRelated = [\n    \"saas_permission\",\n    \"shadow_admin\"\n  ].includes(memory.context.exposureType);\n\n  if (!isSaaSRelated) {\n    return [];\n  }\n\n  const systemPrompt = `You are a SAAS PERMISSION ANALYZER for OdinForge AI.\n\nYour task is to identify SaaS permission misconfigurations and abuse paths:\n1. Overly permissive OAuth scopes\n2. Delegated admin abuse\n3. API key scope creep\n4. Cross-tenant access\n5. Third-party app permissions\n6. SSO/SAML misconfiguration\n7. Service account over-provisioning\n\nFocus on identifying shadow admin indicators - users with admin-equivalent permissions who shouldn't have them.`;\n\n  const userPrompt = `Analyze SaaS permissions for:\n\nAsset ID: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nDescription: ${memory.context.description}\n\n${memory.recon ? `Auth Mechanisms: ${memory.recon.authMechanisms.join(\", \")}\nTechnologies: ${memory.recon.technologies.join(\", \")}` : \"\"}\n\nReturn a JSON object with this structure:\n{\n  \"findings\": [\n    {\n      \"id\": \"saas_finding_id\",\n      \"platform\": \"Google Workspace|Microsoft 365|Salesforce|etc\",\n      \"permissionLevel\": \"admin|elevated|standard\",\n      \"title\": \"Finding title\",\n      \"description\": \"Detailed description\",\n      \"severity\": \"critical|high|medium|low\",\n      \"shadowAdminIndicators\": [\"indicator1\", \"indicator2\"],\n      \"exploitPath\": [\"step1\", \"step2\"]\n    }\n  ]\n}`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 2048,\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) return [];\n\n    const result = JSON.parse(content);\n    return Array.isArray(result.findings) ? result.findings : [];\n  } catch (error) {\n    console.error(\"SaaS permission analysis error:\", error);\n    return [];\n  }\n}\n\nasync function discoverShadowAdmins(\n  memory: AgentMemory,\n  iamFindings: IAMFinding[],\n  saasFindings: SaaSFinding[]\n): Promise<ShadowAdminIndicator[]> {\n  if (memory.context.exposureType !== \"shadow_admin\" && \n      !iamFindings.some(f => f.privilegeEscalationPath) &&\n      !saasFindings.some(f => f.shadowAdminIndicators.length > 0)) {\n    return [];\n  }\n\n  const systemPrompt = `You are a SHADOW ADMIN DISCOVERY ENGINE for OdinForge AI.\n\nShadow admins are users or service accounts with admin-equivalent permissions who:\n1. Don't appear in official admin groups\n2. Have accumulated permissions over time\n3. Use delegated or inherited permissions\n4. Control critical resources without proper oversight\n5. Can perform admin actions through indirect paths\n\nIdentify shadow admin indicators from the provided IAM and SaaS findings.`;\n\n  const iamContext = iamFindings.length > 0 \n    ? `IAM Findings:\\n${iamFindings.map(f => \n        `- ${f.principal}: ${f.effectivePermissions.slice(0, 5).join(\", \")}`\n      ).join(\"\\n\")}`\n    : \"\";\n\n  const saasContext = saasFindings.length > 0\n    ? `SaaS Findings:\\n${saasFindings.map(f => \n        `- ${f.platform} (${f.permissionLevel}): ${f.shadowAdminIndicators.join(\", \")}`\n      ).join(\"\\n\")}`\n    : \"\";\n\n  const userPrompt = `Discover shadow admins for:\n\nAsset ID: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nDescription: ${memory.context.description}\n\n${iamContext}\n${saasContext}\n\nReturn a JSON object with this structure:\n{\n  \"indicators\": [\n    {\n      \"id\": \"shadow_admin_id\",\n      \"principal\": \"user/service account identifier\",\n      \"platform\": \"AWS|GCP|Azure|Google Workspace|etc\",\n      \"indicatorType\": \"excessive_permissions|dormant_admin|service_account_abuse|delegated_admin|hidden_role\",\n      \"evidence\": [\"evidence1\", \"evidence2\"],\n      \"riskLevel\": \"critical|high|medium|low\"\n    }\n  ]\n}`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 2048,\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) return [];\n\n    const result = JSON.parse(content);\n    return Array.isArray(result.indicators) ? result.indicators : [];\n  } catch (error) {\n    console.error(\"Shadow admin discovery error:\", error);\n    return [];\n  }\n}\n\nasync function buildChainedAttackPaths(\n  memory: AgentMemory,\n  cloudFindings: CloudFinding[],\n  iamFindings: IAMFinding[],\n  saasFindings: SaaSFinding[]\n): Promise<ChainedAttackPath[]> {\n  const totalFindings = cloudFindings.length + iamFindings.length + saasFindings.length;\n  if (totalFindings < 2) {\n    return [];\n  }\n\n  const systemPrompt = `You are a CHAINED ATTACK PATH BUILDER for OdinForge AI.\n\nYour task is to identify how multiple vectors can be chained together for greater impact:\n1. Cloud misconfiguration -> IAM escalation -> data exfiltration\n2. SaaS compromise -> lateral movement -> admin access\n3. Initial access -> privilege escalation -> persistence\n\nChain findings together to show realistic attack scenarios.`;\n\n  const findingsContext = `\nCloud Findings: ${cloudFindings.map(f => f.title).join(\", \") || \"none\"}\nIAM Findings: ${iamFindings.map(f => f.title).join(\", \") || \"none\"}\nSaaS Findings: ${saasFindings.map(f => f.title).join(\", \") || \"none\"}\n`;\n\n  const userPrompt = `Build chained attack paths for:\n\nAsset ID: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nDescription: ${memory.context.description}\n\nAvailable Vectors:\n${findingsContext}\n\nReturn a JSON object with this structure:\n{\n  \"chainedPaths\": [\n    {\n      \"id\": \"chain_id\",\n      \"name\": \"Attack chain name\",\n      \"vectors\": [\"vector_type1\", \"vector_type2\"],\n      \"steps\": [\n        {\n          \"step\": 1,\n          \"action\": \"action description\",\n          \"target\": \"target resource\",\n          \"technique\": \"MITRE technique if applicable\"\n        }\n      ],\n      \"combinedImpact\": \"description of combined impact\",\n      \"difficulty\": \"trivial|low|medium|high|expert\"\n    }\n  ]\n}`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 2048,\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) return [];\n\n    const result = JSON.parse(content);\n    return Array.isArray(result.chainedPaths) ? result.chainedPaths : [];\n  } catch (error) {\n    console.error(\"Chained attack path building error:\", error);\n    return [];\n  }\n}\n\nfunction generateMultiVectorFindings(\n  cloudFindings: CloudFinding[],\n  iamFindings: IAMFinding[],\n  saasFindings: SaaSFinding[],\n  shadowAdmins: ShadowAdminIndicator[]\n): MultiVectorFinding[] {\n  const findings: MultiVectorFinding[] = [];\n  let findingId = 1;\n\n  for (const cloud of cloudFindings) {\n    findings.push({\n      id: `mv-${findingId++}`,\n      vectorType: \"cloud_misconfiguration\",\n      cloudVector: cloud.vectorType as CloudVectorType,\n      title: cloud.title,\n      description: cloud.description,\n      severity: cloud.severity,\n      affectedResources: [cloud.resource],\n      exploitPath: cloud.exploitPath.map((step, i) => ({\n        step: i + 1,\n        action: step,\n        target: cloud.resource,\n        technique: cloud.vectorType,\n      })),\n      cloudContext: {\n        provider: cloud.provider,\n        service: cloud.service,\n        resourceArn: cloud.resource,\n      },\n    });\n  }\n\n  for (const iam of iamFindings) {\n    findings.push({\n      id: `mv-${findingId++}`,\n      vectorType: \"iam_abuse\",\n      title: iam.title,\n      description: iam.description,\n      severity: iam.severity,\n      affectedResources: [iam.principal, ...iam.assumableRoles],\n      exploitPath: [{\n        step: 1,\n        action: \"Assume initial role\",\n        target: iam.principal,\n        technique: \"AssumeRole\",\n      }],\n      iamContext: {\n        principal: iam.principal,\n        assumableRoles: iam.assumableRoles,\n        effectivePermissions: iam.effectivePermissions,\n        privilegeEscalationPath: iam.privilegeEscalationPath || undefined,\n      },\n    });\n  }\n\n  for (const saas of saasFindings) {\n    findings.push({\n      id: `mv-${findingId++}`,\n      vectorType: \"saas_permission\",\n      title: saas.title,\n      description: saas.description,\n      severity: saas.severity,\n      affectedResources: [saas.platform],\n      exploitPath: saas.exploitPath.map((step, i) => ({\n        step: i + 1,\n        action: step,\n        target: saas.platform,\n      })),\n      saasContext: {\n        platform: saas.platform,\n        permissionLevel: saas.permissionLevel,\n        shadowAdminIndicators: saas.shadowAdminIndicators,\n      },\n    });\n  }\n\n  for (const shadow of shadowAdmins) {\n    findings.push({\n      id: `mv-${findingId++}`,\n      vectorType: \"shadow_admin\",\n      title: `Shadow Admin: ${shadow.principal}`,\n      description: `Discovered shadow admin via ${shadow.indicatorType}`,\n      severity: shadow.riskLevel,\n      affectedResources: [shadow.principal],\n      exploitPath: [{\n        step: 1,\n        action: `Identify shadow admin: ${shadow.indicatorType}`,\n        target: shadow.principal,\n        technique: \"Shadow Admin Discovery\",\n      }],\n      saasContext: {\n        platform: shadow.platform,\n        shadowAdminIndicators: shadow.evidence,\n      },\n    });\n  }\n\n  return findings;\n}\n","path":null,"size_bytes":16473,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"client/src/components/NewEvaluationModal.tsx":{"content":"import { useState } from \"react\";\nimport { X, Zap, Target, Info, UserRound } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Select,\n  SelectContent,\n  SelectGroup,\n  SelectItem,\n  SelectLabel,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport type { ExposureType, AdversaryProfile } from \"@shared/schema\";\n\nconst adversaryProfileLabels: Record<AdversaryProfile, { label: string; description: string }> = {\n  script_kiddie: { label: \"Script Kiddie\", description: \"Low sophistication, uses public tools\" },\n  opportunistic_criminal: { label: \"Opportunistic Criminal\", description: \"Moderate skill, seeks easy financial gains\" },\n  organized_crime: { label: \"Organized Crime\", description: \"Well-funded criminal organization\" },\n  insider_threat: { label: \"Insider Threat\", description: \"Trusted insider with legitimate access\" },\n  nation_state: { label: \"Nation State\", description: \"State-sponsored with unlimited resources\" },\n  apt_group: { label: \"APT Group\", description: \"Advanced Persistent Threat group\" },\n  hacktivist: { label: \"Hacktivist\", description: \"Ideologically motivated attacker\" },\n  competitor: { label: \"Competitor\", description: \"Corporate espionage actor\" },\n};\n\nconst exposureTypeLabels: Record<ExposureType, string> = {\n  cve: \"CVE Exploitation\",\n  misconfiguration: \"Misconfiguration\",\n  behavioral_anomaly: \"Behavioral Anomaly\",\n  network_vulnerability: \"Network Vulnerability\",\n  cloud_misconfiguration: \"Cloud Misconfiguration\",\n  iam_abuse: \"IAM Abuse\",\n  saas_permission: \"SaaS Permission Abuse\",\n  shadow_admin: \"Shadow Admin Discovery\",\n  api_sequence_abuse: \"API Sequence Abuse\",\n  payment_flow: \"Payment Flow\",\n  subscription_bypass: \"Subscription Bypass\",\n  state_machine: \"State Machine Violation\",\n  privilege_boundary: \"Privilege Boundary\",\n  workflow_desync: \"Workflow Desync\",\n  order_lifecycle: \"Order Lifecycle Abuse\",\n};\n\nconst exposureTypeGroups = {\n  \"Traditional Vectors\": [\"cve\", \"misconfiguration\", \"behavioral_anomaly\", \"network_vulnerability\"] as ExposureType[],\n  \"Cloud & IAM\": [\"cloud_misconfiguration\", \"iam_abuse\", \"saas_permission\", \"shadow_admin\"] as ExposureType[],\n  \"Business Logic\": [\"api_sequence_abuse\", \"payment_flow\", \"subscription_bypass\", \"state_machine\", \"privilege_boundary\", \"workflow_desync\", \"order_lifecycle\"] as ExposureType[],\n};\n\ninterface NewEvaluationModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onSubmit: (data: EvaluationFormData) => void;\n}\n\nexport interface EvaluationFormData {\n  assetId: string;\n  exposureType: string;\n  priority: string;\n  description: string;\n  adversaryProfile?: string;\n}\n\nexport function NewEvaluationModal({ isOpen, onClose, onSubmit }: NewEvaluationModalProps) {\n  const [formData, setFormData] = useState<EvaluationFormData>({\n    assetId: \"\",\n    exposureType: \"cve\",\n    priority: \"medium\",\n    description: \"\",\n    adversaryProfile: undefined,\n  });\n\n  if (!isOpen) return null;\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    onSubmit(formData);\n    setFormData({ assetId: \"\", exposureType: \"cve\", priority: \"medium\", description: \"\", adversaryProfile: undefined });\n  };\n\n  return (\n    <div className=\"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4\">\n      <div \n        className=\"bg-card border border-border rounded-xl w-full max-w-md shadow-2xl\"\n        data-testid=\"new-evaluation-modal\"\n      >\n        <div className=\"bg-gradient-to-r from-cyan-600/20 to-blue-600/20 border-b border-border px-6 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-lg\">\n                <Target className=\"h-5 w-5 text-white\" />\n              </div>\n              <div>\n                <h3 className=\"font-semibold text-foreground\">New Evaluation</h3>\n                <p className=\"text-xs text-muted-foreground\">Start an autonomous exploit validation</p>\n              </div>\n            </div>\n            <Button variant=\"ghost\" size=\"icon\" onClick={onClose} data-testid=\"button-close-modal\">\n              <X className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"p-6 space-y-5\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"assetId\" className=\"text-xs uppercase tracking-wider\">\n              Target Asset ID\n            </Label>\n            <Input\n              id=\"assetId\"\n              placeholder=\"e.g., web-server-01, api-gateway\"\n              value={formData.assetId}\n              onChange={(e) => setFormData({ ...formData, assetId: e.target.value })}\n              className=\"font-mono\"\n              required\n              data-testid=\"input-asset-id\"\n            />\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label className=\"text-xs uppercase tracking-wider\">Exposure Type</Label>\n              <Select\n                value={formData.exposureType}\n                onValueChange={(value) => setFormData({ ...formData, exposureType: value })}\n              >\n                <SelectTrigger data-testid=\"select-exposure-type\">\n                  <SelectValue placeholder=\"Select type\" />\n                </SelectTrigger>\n                <SelectContent className=\"max-h-80\">\n                  {Object.entries(exposureTypeGroups).map(([group, types]) => (\n                    <SelectGroup key={group}>\n                      <SelectLabel className=\"text-xs text-muted-foreground\">{group}</SelectLabel>\n                      {types.map((type) => (\n                        <SelectItem key={type} value={type} data-testid={`option-${type}`}>\n                          {exposureTypeLabels[type]}\n                        </SelectItem>\n                      ))}\n                    </SelectGroup>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label className=\"text-xs uppercase tracking-wider\">Priority</Label>\n              <Select\n                value={formData.priority}\n                onValueChange={(value) => setFormData({ ...formData, priority: value })}\n              >\n                <SelectTrigger data-testid=\"select-priority\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"critical\">Critical</SelectItem>\n                  <SelectItem value=\"high\">High</SelectItem>\n                  <SelectItem value=\"medium\">Medium</SelectItem>\n                  <SelectItem value=\"low\">Low</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center gap-2\">\n              <Label className=\"text-xs uppercase tracking-wider\">Adversary Profile</Label>\n              <Tooltip>\n                <TooltipTrigger>\n                  <UserRound className=\"h-3 w-3 text-muted-foreground\" />\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p className=\"max-w-xs text-xs\">Simulates attack from a specific threat actor type. The AI will adjust its tactics and techniques accordingly.</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n            <Select\n              value={formData.adversaryProfile || \"__none__\"}\n              onValueChange={(value) => setFormData({ ...formData, adversaryProfile: value === \"__none__\" ? undefined : value })}\n            >\n              <SelectTrigger data-testid=\"select-adversary-profile\">\n                <SelectValue placeholder=\"Default (balanced analysis)\" />\n              </SelectTrigger>\n              <SelectContent className=\"max-h-80\">\n                <SelectItem value=\"__none__\">Default (balanced analysis)</SelectItem>\n                {(Object.keys(adversaryProfileLabels) as AdversaryProfile[]).map((profile) => (\n                  <SelectItem key={profile} value={profile} data-testid={`option-${profile}`}>\n                    <span className=\"flex flex-col\">\n                      <span>{adversaryProfileLabels[profile].label}</span>\n                    </span>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"description\" className=\"text-xs uppercase tracking-wider\">\n              Description\n            </Label>\n            <Textarea\n              id=\"description\"\n              placeholder=\"Describe the exposure to be validated...\"\n              rows={3}\n              value={formData.description}\n              onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n              required\n              data-testid=\"input-description\"\n            />\n          </div>\n\n          <div className=\"flex items-start gap-2 p-3 bg-muted/30 rounded-lg border border-border\">\n            <Info className=\"h-4 w-4 text-cyan-400 mt-0.5 flex-shrink-0\" />\n            <p className=\"text-xs text-muted-foreground\">\n              The AI will autonomously discover attack paths and chain exploits without predefined patterns.\n            </p>\n          </div>\n\n          <Button\n            type=\"submit\"\n            className=\"w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500\"\n            data-testid=\"button-start-evaluation\"\n          >\n            <Zap className=\"h-4 w-4 mr-2\" />\n            Start Autonomous Evaluation\n          </Button>\n        </form>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10038,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/components/Dashboard.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { \n  Zap, \n  Target, \n  ShieldCheck, \n  AlertTriangle, \n  Activity, \n  RefreshCw,\n  Plus,\n  Loader2,\n  Wand2,\n  FileText,\n  ChevronDown\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { StatCard } from \"./StatCard\";\nimport { FilterBar } from \"./FilterBar\";\nimport { EvaluationTable, Evaluation } from \"./EvaluationTable\";\nimport { NewEvaluationModal, EvaluationFormData } from \"./NewEvaluationModal\";\nimport { ProgressModal } from \"./ProgressModal\";\nimport { EvaluationDetail } from \"./EvaluationDetail\";\nimport { EvaluationWizard } from \"./EvaluationWizard\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\ninterface EvaluationDetailData {\n  id: string;\n  assetId: string;\n  exposureType: string;\n  priority: string;\n  description: string;\n  status: string;\n  exploitable?: boolean;\n  score?: number;\n  confidence?: number;\n  createdAt: string;\n  duration?: number;\n  attackPath?: Array<{\n    id: number;\n    title: string;\n    description: string;\n    technique?: string;\n    severity: \"critical\" | \"high\" | \"medium\" | \"low\";\n  }>;\n  recommendations?: Array<{\n    id: string;\n    title: string;\n    description: string;\n    priority: \"critical\" | \"high\" | \"medium\" | \"low\";\n    type: \"remediation\" | \"compensating\" | \"preventive\";\n  }>;\n}\n\ninterface ProgressEvent {\n  type: \"aev_progress\" | \"aev_complete\";\n  evaluationId: string;\n  agentName?: string;\n  stage?: string;\n  progress?: number;\n  message?: string;\n  success?: boolean;\n  error?: string;\n}\n\nexport function Dashboard() {\n  const [filter, setFilter] = useState(\"all\");\n  const [showNewModal, setShowNewModal] = useState(false);\n  const [showWizard, setShowWizard] = useState(false);\n  const [showProgressModal, setShowProgressModal] = useState(false);\n  const [activeEvaluation, setActiveEvaluation] = useState<{ assetId: string; id: string } | null>(null);\n  const [selectedEvaluationId, setSelectedEvaluationId] = useState<string | null>(null);\n  const [progressData, setProgressData] = useState<{ agentName?: string; stage: string; progress: number; message: string } | null>(null);\n  const wsRef = useRef<WebSocket | null>(null);\n\n  const { data: evaluations = [], isLoading, refetch } = useQuery<Evaluation[]>({\n    queryKey: [\"/api/aev/evaluations\"],\n  });\n\n  const { data: selectedEvaluation, isLoading: isLoadingDetail } = useQuery<EvaluationDetailData>({\n    queryKey: [\"/api/aev/evaluations\", selectedEvaluationId],\n    enabled: !!selectedEvaluationId,\n  });\n\n  const createEvaluationMutation = useMutation({\n    mutationFn: async (data: EvaluationFormData) => {\n      const response = await apiRequest(\"POST\", \"/api/aev/evaluate\", data);\n      return response.json();\n    },\n    onSuccess: (data) => {\n      setActiveEvaluation({ assetId: data.assetId, id: data.evaluationId });\n      setShowProgressModal(true);\n    },\n  });\n\n  useEffect(() => {\n    const protocol = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n    const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);\n    wsRef.current = ws;\n\n    ws.onmessage = (event) => {\n      const data: ProgressEvent = JSON.parse(event.data);\n      \n      if (data.type === \"aev_progress\" && data.evaluationId === activeEvaluation?.id) {\n        setProgressData({\n          agentName: data.agentName,\n          stage: data.stage || \"\",\n          progress: data.progress || 0,\n          message: data.message || \"\",\n        });\n      }\n      \n      if (data.type === \"aev_complete\") {\n        if (data.evaluationId === activeEvaluation?.id) {\n          setTimeout(() => {\n            setShowProgressModal(false);\n            setActiveEvaluation(null);\n            setProgressData(null);\n            queryClient.invalidateQueries({ queryKey: [\"/api/aev/evaluations\"] });\n          }, 1000);\n        } else {\n          queryClient.invalidateQueries({ queryKey: [\"/api/aev/evaluations\"] });\n        }\n      }\n    };\n\n    ws.onerror = (error) => {\n      console.error(\"WebSocket error:\", error);\n    };\n\n    return () => {\n      ws.close();\n    };\n  }, [activeEvaluation?.id]);\n\n  const filteredEvaluations = evaluations.filter((e) => {\n    if (filter === \"all\") return true;\n    if (filter === \"pending\") return e.status === \"pending\" || e.status === \"in_progress\";\n    if (filter === \"completed\") return e.status === \"completed\";\n    if (filter === \"exploitable\") return e.exploitable === true;\n    if (filter === \"safe\") return e.exploitable === false;\n    return true;\n  });\n\n  const stats = {\n    total: evaluations.length,\n    active: evaluations.filter((e) => e.status === \"pending\" || e.status === \"in_progress\").length,\n    exploitable: evaluations.filter((e) => e.exploitable).length,\n    safe: evaluations.filter((e) => e.exploitable === false).length,\n    avgConfidence: evaluations.filter(e => e.confidence).length > 0\n      ? Math.round(\n          evaluations.filter(e => e.confidence).reduce((sum, e) => sum + (e.confidence || 0), 0) / \n          evaluations.filter(e => e.confidence).length * 100\n        )\n      : 0,\n  };\n\n  const filterOptions = [\n    { value: \"all\", label: \"All\", count: evaluations.length },\n    { value: \"pending\", label: \"Active\", count: stats.active },\n    { value: \"completed\", label: \"Completed\", count: evaluations.filter(e => e.status === \"completed\").length },\n    { value: \"exploitable\", label: \"Exploitable\", count: stats.exploitable },\n    { value: \"safe\", label: \"Safe\", count: stats.safe },\n  ];\n\n  const handleNewEvaluation = (data: EvaluationFormData) => {\n    setShowNewModal(false);\n    createEvaluationMutation.mutate(data);\n  };\n\n  const handleViewDetails = (evaluation: Evaluation) => {\n    setSelectedEvaluationId(evaluation.id);\n  };\n\n  const handleRunEvaluation = (evaluation: Evaluation) => {\n    setActiveEvaluation({ assetId: evaluation.assetId, id: evaluation.id });\n    setShowProgressModal(true);\n  };\n\n  if (selectedEvaluationId && selectedEvaluation) {\n    return (\n      <EvaluationDetail \n        evaluation={selectedEvaluation} \n        onBack={() => setSelectedEvaluationId(null)} \n      />\n    );\n  }\n\n  if (selectedEvaluationId && isLoadingDetail) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-xl font-bold text-foreground flex items-center gap-2 flex-wrap\">\n            OdinForge AI\n            <span className=\"text-xs font-medium px-2 py-0.5 rounded bg-gradient-to-r from-cyan-500/20 to-blue-500/20 text-cyan-400 border border-cyan-500/30\">\n              AUTONOMOUS VALIDATION\n            </span>\n          </h1>\n          <p className=\"text-sm text-muted-foreground mt-0.5\">\n            AI-powered adversarial exposure validation with autonomous exploit chaining\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2 flex-wrap\">\n          <Button \n            variant=\"outline\" \n            size=\"sm\" \n            data-testid=\"button-refresh\"\n            onClick={() => refetch()}\n            disabled={isLoading}\n          >\n            <RefreshCw className={`h-3.5 w-3.5 mr-2 ${isLoading ? \"animate-spin\" : \"\"}`} />\n            Refresh\n          </Button>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button \n                size=\"sm\"\n                className=\"bg-gradient-to-r from-cyan-600 to-blue-600\"\n                data-testid=\"button-new-evaluation\"\n              >\n                <Plus className=\"h-3.5 w-3.5 mr-2\" />\n                New Evaluation\n                <ChevronDown className=\"h-3.5 w-3.5 ml-2\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\" className=\"w-56\">\n              <DropdownMenuItem onClick={() => setShowWizard(true)} data-testid=\"menu-guided-wizard\">\n                <Wand2 className=\"h-4 w-4 mr-2\" />\n                <div>\n                  <div className=\"font-medium\">Guided Wizard</div>\n                  <div className=\"text-xs text-muted-foreground\">Step-by-step templates</div>\n                </div>\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={() => setShowNewModal(true)} data-testid=\"menu-quick-evaluation\">\n                <FileText className=\"h-4 w-4 mr-2\" />\n                <div>\n                  <div className=\"font-medium\">Quick Evaluation</div>\n                  <div className=\"text-xs text-muted-foreground\">Manual description input</div>\n                </div>\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4\">\n        <StatCard \n          label=\"Total Evaluations\" \n          value={stats.total} \n          icon={Target}\n        />\n        <StatCard \n          label=\"Active\" \n          value={stats.active} \n          icon={Activity}\n          colorClass=\"text-amber-400\"\n        />\n        <StatCard \n          label=\"Exploitable\" \n          value={stats.exploitable} \n          icon={AlertTriangle}\n          colorClass=\"text-red-400\"\n        />\n        <StatCard \n          label=\"Safe\" \n          value={stats.safe} \n          icon={ShieldCheck}\n          colorClass=\"text-emerald-400\"\n        />\n        <StatCard \n          label=\"Avg Confidence\" \n          value={`${stats.avgConfidence}%`} \n          icon={Zap}\n          colorClass=\"text-cyan-400\"\n        />\n      </div>\n\n      <FilterBar \n        options={filterOptions} \n        activeFilter={filter} \n        onFilterChange={setFilter} \n      />\n\n      {isLoading ? (\n        <div className=\"flex items-center justify-center h-32\">\n          <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n        </div>\n      ) : (\n        <EvaluationTable \n          evaluations={filteredEvaluations}\n          onViewDetails={handleViewDetails}\n          onRunEvaluation={handleRunEvaluation}\n        />\n      )}\n\n      <NewEvaluationModal \n        isOpen={showNewModal}\n        onClose={() => setShowNewModal(false)}\n        onSubmit={handleNewEvaluation}\n      />\n\n      <EvaluationWizard\n        open={showWizard}\n        onOpenChange={setShowWizard}\n      />\n\n      <ProgressModal \n        isOpen={showProgressModal}\n        onClose={() => {\n          setShowProgressModal(false);\n          setProgressData(null);\n        }}\n        assetId={activeEvaluation?.assetId || \"\"}\n        evaluationId={activeEvaluation?.id || \"\"}\n        progressData={progressData}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":10930,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"script/build.ts":{"content":"import { build as esbuild } from \"esbuild\";\nimport { build as viteBuild } from \"vite\";\nimport { rm, readFile } from \"fs/promises\";\n\n// server deps to bundle to reduce openat(2) syscalls\n// which helps cold start times\nconst allowlist = [\n  \"@google/generative-ai\",\n  \"axios\",\n  \"connect-pg-simple\",\n  \"cors\",\n  \"date-fns\",\n  \"drizzle-orm\",\n  \"drizzle-zod\",\n  \"express\",\n  \"express-rate-limit\",\n  \"express-session\",\n  \"jsonwebtoken\",\n  \"memorystore\",\n  \"multer\",\n  \"nanoid\",\n  \"nodemailer\",\n  \"openai\",\n  \"passport\",\n  \"passport-local\",\n  \"pg\",\n  \"stripe\",\n  \"uuid\",\n  \"ws\",\n  \"xlsx\",\n  \"zod\",\n  \"zod-validation-error\",\n];\n\nasync function buildAll() {\n  await rm(\"dist\", { recursive: true, force: true });\n\n  console.log(\"building client...\");\n  await viteBuild();\n\n  console.log(\"building server...\");\n  const pkg = JSON.parse(await readFile(\"package.json\", \"utf-8\"));\n  const allDeps = [\n    ...Object.keys(pkg.dependencies || {}),\n    ...Object.keys(pkg.devDependencies || {}),\n  ];\n  const externals = allDeps.filter((dep) => !allowlist.includes(dep));\n\n  await esbuild({\n    entryPoints: [\"server/index.ts\"],\n    platform: \"node\",\n    bundle: true,\n    format: \"cjs\",\n    outfile: \"dist/index.cjs\",\n    define: {\n      \"process.env.NODE_ENV\": '\"production\"',\n    },\n    minify: true,\n    external: externals,\n    logLevel: \"info\",\n  });\n}\n\nbuildAll().catch((err) => {\n  console.error(err);\n  process.exit(1);\n});\n","path":null,"size_bytes":1417,"size_tokens":null},"server/services/agents/lateral.ts":{"content":"import OpenAI from \"openai\";\nimport type { AgentMemory, AgentResult, LateralFindings, LateralShadowAdminIndicator } from \"./types\";\nimport { generateAdversaryPromptContext } from \"./adversary-profile\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\ntype ProgressCallback = (stage: string, progress: number, message: string) => void;\n\nexport async function runLateralAgent(\n  memory: AgentMemory,\n  onProgress?: ProgressCallback\n): Promise<AgentResult<LateralFindings>> {\n  const startTime = Date.now();\n  \n  onProgress?.(\"lateral\", 50, \"Mapping lateral movement paths...\");\n\n  const previousContext = `\nRecon Findings:\n${memory.recon ? `- Technologies: ${memory.recon.technologies.join(\", \")}\n- Auth Mechanisms: ${memory.recon.authMechanisms.join(\", \")}` : \"None\"}\n\nExploit Findings:\n${memory.exploit ? `- Exploitable: ${memory.exploit.exploitable}\n- Exploit Chains: ${memory.exploit.exploitChains.map((c) => c.name).join(\", \")}` : \"None\"}\n`;\n\n  const adversaryContext = memory.context.adversaryProfile \n    ? generateAdversaryPromptContext(memory.context.adversaryProfile)\n    : \"\";\n\n  const systemPrompt = `You are the LATERAL MOVEMENT AGENT, a specialized AI system for analyzing post-exploitation movement opportunities for OdinForge AI.\n${adversaryContext}\n\nYour mission is to analyze how an attacker could move laterally after initial compromise:\n1. Pivot paths - how to move from one system/asset to another\n2. Privilege escalation opportunities\n3. Token reuse and credential harvesting opportunities\n4. Shadow admin discovery - identify users/accounts with admin-equivalent privileges who:\n   - Don't appear in official admin groups\n   - Have accumulated permissions over time through delegated/inherited access\n   - Can perform privileged actions through indirect paths (role assumption, service accounts)\n   - Control critical resources without proper oversight\n\nUse MITRE ATT&CK lateral movement techniques (TA0008). Think like a red team operator planning post-exploitation.\nFor cloud and SaaS environments, focus on IAM abuse paths and shadow admin indicators.`;\n\n  const userPrompt = `Analyze lateral movement opportunities for this exposure:\n\nAsset ID: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nPriority: ${memory.context.priority}\nDescription: ${memory.context.description}\n${previousContext}\n\nProvide your lateral movement analysis as a JSON object with this structure:\n{\n  \"pivotPaths\": [\n    {\n      \"from\": \"Starting point/asset\",\n      \"to\": \"Target asset\",\n      \"method\": \"How to pivot\",\n      \"technique\": \"MITRE ATT&CK technique ID\"\n    }\n  ],\n  \"privilegeEscalation\": [\n    {\n      \"target\": \"Target privilege level or system\",\n      \"method\": \"How to escalate\",\n      \"likelihood\": \"high\" | \"medium\" | \"low\"\n    }\n  ],\n  \"tokenReuse\": [\"list of token/credential reuse opportunities\"],\n  \"shadowAdminIndicators\": [\n    {\n      \"principal\": \"User or service account identifier\",\n      \"platform\": \"AWS|GCP|Azure|Google Workspace|Microsoft 365|etc\",\n      \"indicatorType\": \"excessive_permissions|dormant_admin|service_account_abuse|delegated_admin|hidden_role\",\n      \"evidence\": [\"evidence of shadow admin status\"],\n      \"riskLevel\": \"critical|high|medium|low\"\n    }\n  ]\n}`;\n\n  try {\n    onProgress?.(\"lateral\", 55, \"Analyzing privilege escalation paths...\");\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 2048,\n    });\n\n    onProgress?.(\"lateral\", 60, \"Mapping network pivot opportunities...\");\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response from Lateral Movement Agent\");\n    }\n\n    const findings = JSON.parse(content) as LateralFindings;\n    \n    const validatedFindings: LateralFindings = {\n      pivotPaths: Array.isArray(findings.pivotPaths)\n        ? findings.pivotPaths.map((path) => ({\n            from: String(path.from || \"Initial Access\"),\n            to: String(path.to || \"Unknown\"),\n            method: String(path.method || \"\"),\n            technique: String(path.technique || \"T1021\"),\n          }))\n        : [],\n      privilegeEscalation: Array.isArray(findings.privilegeEscalation)\n        ? findings.privilegeEscalation.map((esc) => ({\n            target: String(esc.target || \"\"),\n            method: String(esc.method || \"\"),\n            likelihood: validateLikelihood(esc.likelihood),\n          }))\n        : [],\n      tokenReuse: Array.isArray(findings.tokenReuse) ? findings.tokenReuse : [],\n      shadowAdminIndicators: Array.isArray(findings.shadowAdminIndicators)\n        ? findings.shadowAdminIndicators.map((ind): LateralShadowAdminIndicator => ({\n            principal: String(ind.principal || \"\"),\n            platform: String(ind.platform || \"\"),\n            indicatorType: validateIndicatorType(ind.indicatorType),\n            evidence: Array.isArray(ind.evidence) ? ind.evidence.map(String) : [],\n            riskLevel: validateRiskLevel(ind.riskLevel),\n          }))\n        : [],\n    };\n\n    return {\n      success: true,\n      findings: validatedFindings,\n      agentName: \"Lateral Movement Agent\",\n      processingTime: Date.now() - startTime,\n    };\n  } catch (error) {\n    console.error(\"Lateral Movement Agent error:\", error);\n    throw error;\n  }\n}\n\nfunction validateLikelihood(likelihood: unknown): \"high\" | \"medium\" | \"low\" {\n  const valid = [\"high\", \"medium\", \"low\"];\n  return valid.includes(String(likelihood)) ? (likelihood as \"high\" | \"medium\" | \"low\") : \"medium\";\n}\n\nfunction validateRiskLevel(level: unknown): \"critical\" | \"high\" | \"medium\" | \"low\" {\n  const valid = [\"critical\", \"high\", \"medium\", \"low\"];\n  return valid.includes(String(level)) ? (level as \"critical\" | \"high\" | \"medium\" | \"low\") : \"medium\";\n}\n\nfunction validateIndicatorType(type: unknown): LateralShadowAdminIndicator[\"indicatorType\"] {\n  const valid = [\"excessive_permissions\", \"dormant_admin\", \"service_account_abuse\", \"delegated_admin\", \"hidden_role\"];\n  return valid.includes(String(type)) ? (type as LateralShadowAdminIndicator[\"indicatorType\"]) : \"excessive_permissions\";\n}\n","path":null,"size_bytes":6363,"size_tokens":null},"attached_assets/aev_1765772491190.ts":{"content":"import axios from \"axios\";\nimport { logger } from \"../logger\";\nimport { websocket } from \"./websocket\";\nimport { kafka, KafkaEvent, TOPICS } from \"./kafka\";\nimport { nanoid } from \"nanoid\";\nimport { \n  createAevResult, \n  getAevResults, \n  getAevResultByEvaluationId,\n  updateAevResult,\n} from \"../storage/security\";\n\nconst AEV_SERVICE_URL = process.env.AEV_SERVICE_URL || \"http://localhost:8000\";\nconst AEV_SERVICE_SECRET = process.env.AEV_SERVICE_SECRET || \"\";\nconst AEV_TIMEOUT_MS = (() => {\n  const timeout = parseInt(process.env.AEV_TIMEOUT_MS || \"120000\", 10);\n  return isNaN(timeout) || timeout <= 0 ? 120000 : timeout;\n})();\n\nexport interface ExposureInput {\n  assetId: string;\n  exposureType: \"cve\" | \"misconfiguration\" | \"behavior\" | \"network\" | \"custom\";\n  description: string;\n  data: Record<string, any>;\n  organizationId: string;\n  module?: \"posture\" | \"spear\" | \"sentinel\" | \"vulnmgmt\";\n  priority?: \"low\" | \"medium\" | \"high\" | \"critical\";\n}\n\nexport interface SimulationResult {\n  evaluationId: string;\n  exploitable: boolean;\n  confidence: number;\n  attackPath: string[];\n  impact: string;\n  recommendedFix: string;\n  score: number;\n  status: \"pending\" | \"in_progress\" | \"completed\" | \"failed\";\n  error?: string;\n  duration?: number;\n  completedAt?: string;\n}\n\ninterface AEVEvaluation {\n  id: string;\n  input: ExposureInput;\n  status: \"pending\" | \"in_progress\" | \"completed\" | \"failed\";\n  result?: SimulationResult;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nclass AEVService {\n  private evaluations: Map<string, AEVEvaluation> = new Map();\n  private enabled: boolean = false;\n\n  constructor() {\n    this.enabled = !!process.env.AEV_SERVICE_URL;\n    if (this.enabled) {\n      logger.info({ url: AEV_SERVICE_URL, timeout: AEV_TIMEOUT_MS }, \" AEV Service initialized\");\n    } else {\n      logger.info(\" AEV Service URL not configured, running in mock mode\");\n    }\n  }\n\n  startEvaluation(input: ExposureInput, providedEvaluationId?: string): string {\n    const evaluationId = providedEvaluationId || `aev-${nanoid()}`;\n    \n    if (!this.evaluations.has(evaluationId)) {\n      const evaluation: AEVEvaluation = {\n        id: evaluationId,\n        input,\n        status: \"pending\",\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      };\n      this.evaluations.set(evaluationId, evaluation);\n    }\n    return evaluationId;\n  }\n\n  async evaluate(input: ExposureInput, existingEvaluationId?: string): Promise<SimulationResult> {\n    const evaluationId = existingEvaluationId || this.startEvaluation(input);\n    const startTime = Date.now();\n\n    let evaluation = this.evaluations.get(evaluationId);\n    if (!evaluation) {\n      evaluation = {\n        id: evaluationId,\n        input,\n        status: \"pending\",\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      };\n      this.evaluations.set(evaluationId, evaluation);\n    }\n\n    try {\n      this.updateProgress(evaluationId, input.organizationId, 0, \"Initializing evaluation...\");\n      evaluation.status = \"in_progress\";\n      evaluation.updatedAt = new Date();\n\n      if (!this.enabled) {\n        return await this.mockEvaluate(evaluationId, input);\n      }\n\n      this.updateProgress(evaluationId, input.organizationId, 20, \"Connecting to AEV engine...\");\n\n      const response = await axios.post(\n        `${AEV_SERVICE_URL}/aev/evaluate`,\n        {\n          asset_id: input.assetId,\n          exposure_type: input.exposureType,\n          description: input.description,\n          data: input.data,\n        },\n        {\n          headers: {\n            \"Content-Type\": \"application/json\",\n            ...(AEV_SERVICE_SECRET && { \"X-AI-Service-Secret\": AEV_SERVICE_SECRET }),\n          },\n          timeout: AEV_TIMEOUT_MS,\n        }\n      );\n\n      this.updateProgress(evaluationId, input.organizationId, 80, \"Processing results...\");\n\n      const result: SimulationResult = {\n        evaluationId,\n        exploitable: response.data.exploitable,\n        confidence: response.data.confidence,\n        attackPath: response.data.attack_path,\n        impact: response.data.impact,\n        recommendedFix: response.data.recommended_fix,\n        score: response.data.score,\n        status: \"completed\",\n        duration: Date.now() - startTime,\n        completedAt: new Date().toISOString(),\n      };\n\n      evaluation.status = \"completed\";\n      evaluation.result = result;\n      evaluation.updatedAt = new Date();\n\n      await this.persistResult(input, result);\n\n      this.notifyComplete(evaluationId, input.organizationId, result);\n\n      await this.emitKafkaEvent(\"aev.completed\", input.organizationId, {\n        evaluationId,\n        assetId: input.assetId,\n        exposureType: input.exposureType,\n        result,\n      });\n\n      logger.info({\n        evaluationId,\n        assetId: input.assetId,\n        exploitable: result.exploitable,\n        score: result.score,\n        duration: result.duration,\n      }, \"AEV evaluation completed\");\n\n      return result;\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n      \n      evaluation.status = \"failed\";\n      evaluation.updatedAt = new Date();\n\n      const result: SimulationResult = {\n        evaluationId,\n        exploitable: false,\n        confidence: 0,\n        attackPath: [],\n        impact: \"Unable to determine\",\n        recommendedFix: \"Manual review required\",\n        score: 0,\n        status: \"failed\",\n        error: errorMessage,\n        duration: Date.now() - startTime,\n      };\n\n      evaluation.result = result;\n\n      await this.persistResult(input, result);\n\n      this.notifyComplete(evaluationId, input.organizationId, result);\n\n      logger.error({\n        evaluationId,\n        assetId: input.assetId,\n        error: errorMessage,\n      }, \"AEV evaluation failed\");\n\n      return result;\n    }\n  }\n\n  private async mockEvaluate(evaluationId: string, input: ExposureInput): Promise<SimulationResult> {\n    const stages = [\n      { \n        progress: 15, \n        stageNumber: 1,\n        stageName: \"Analyzing Exposure\",\n        message: \"Parsing vulnerability characteristics...\",\n      },\n      { \n        progress: 25, \n        stageNumber: 1,\n        stageName: \"Analyzing Exposure\",\n        message: \"Mapping attack surface and entry points...\",\n      },\n      { \n        progress: 35, \n        stageNumber: 2,\n        stageName: \"Simulating Exploit Chain\",\n        message: \"Testing potential attack vectors...\",\n      },\n      { \n        progress: 50, \n        stageNumber: 2,\n        stageName: \"Simulating Exploit Chain\",\n        message: \"Validating exploit chain feasibility...\",\n      },\n      { \n        progress: 60, \n        stageNumber: 3,\n        stageName: \"Impact Assessment\",\n        message: \"Calculating blast radius and damage potential...\",\n      },\n      { \n        progress: 75, \n        stageNumber: 3,\n        stageName: \"Impact Assessment\",\n        message: \"Evaluating data exposure risk...\",\n      },\n      { \n        progress: 85, \n        stageNumber: 4,\n        stageName: \"Recommendations\",\n        message: \"Generating remediation strategies...\",\n      },\n      { \n        progress: 95, \n        stageNumber: 4,\n        stageName: \"Recommendations\",\n        message: \"Compiling mitigation playbook...\",\n      },\n    ];\n\n    for (const stage of stages) {\n      await new Promise((resolve) => setTimeout(resolve, 400 + Math.random() * 300));\n      this.updateProgress(\n        evaluationId, \n        input.organizationId, \n        stage.progress, \n        stage.message,\n        stage.stageNumber,\n        stage.stageName\n      );\n    }\n\n    const isExploitable = Math.random() > 0.5;\n    const confidence = 0.7 + Math.random() * 0.25;\n    const score = isExploitable ? 60 + Math.random() * 40 : 10 + Math.random() * 30;\n\n    const result: SimulationResult = {\n      evaluationId,\n      exploitable: isExploitable,\n      confidence: Math.round(confidence * 100) / 100,\n      attackPath: isExploitable\n        ? [\n            \"Initial access via network service\",\n            \"Privilege escalation through misconfiguration\",\n            \"Data exfiltration attempt\",\n          ]\n        : [],\n      impact: isExploitable\n        ? input.priority === \"critical\"\n          ? \"Critical system compromise possible\"\n          : \"Moderate impact on affected systems\"\n        : \"Limited exposure, low risk\",\n      recommendedFix: isExploitable\n        ? `Apply security patch for ${input.exposureType}. Review access controls and network segmentation.`\n        : \"No immediate action required. Monitor for changes.\",\n      score: Math.round(score * 10) / 10,\n      status: \"completed\",\n      duration: 2000 + Math.random() * 1000,\n      completedAt: new Date().toISOString(),\n    };\n\n    const evaluation = this.evaluations.get(evaluationId);\n    if (evaluation) {\n      evaluation.status = \"completed\";\n      evaluation.result = result;\n      evaluation.updatedAt = new Date();\n    }\n\n    await this.persistResult(input, result);\n\n    this.notifyComplete(evaluationId, input.organizationId, result);\n\n    return result;\n  }\n\n  private async persistResult(input: ExposureInput, result: SimulationResult): Promise<void> {\n    try {\n      await createAevResult({\n        organizationId: input.organizationId,\n        evaluationId: result.evaluationId,\n        exploitable: result.exploitable,\n        confidence: Math.round(result.confidence * 100),\n        score: Math.round(result.score),\n        attackPath: result.attackPath,\n        impact: result.impact,\n        impactCategory: input.exposureType === \"cve\" ? \"confidentiality\" : \"integrity\",\n        recommendedFix: result.recommendedFix,\n        exploitComplexity: result.exploitable ? \"medium\" : \"high\",\n        privilegesRequired: result.exploitable ? \"low\" : \"none\",\n        userInteraction: \"none\",\n        scope: \"unchanged\",\n        status: result.status,\n        errorMessage: result.error,\n        duration: result.duration,\n        metadata: {\n          assetId: input.assetId,\n          exposureType: input.exposureType,\n          module: input.module,\n          priority: input.priority,\n          description: input.description,\n        },\n      });\n\n      logger.info({ evaluationId: result.evaluationId }, \"AEV result persisted to database\");\n    } catch (error) {\n      logger.error({ error, evaluationId: result.evaluationId }, \"Failed to persist AEV result to database\");\n    }\n  }\n\n  private updateProgress(\n    evaluationId: string,\n    organizationId: string,\n    progress: number,\n    stage: string,\n    currentStage?: number,\n    stageName?: string\n  ): void {\n    websocket.notifyAEVProgress(organizationId, {\n      evaluationId,\n      progress,\n      stage,\n      currentStage,\n      stageName,\n    });\n  }\n\n  private notifyComplete(\n    evaluationId: string,\n    organizationId: string,\n    result: SimulationResult\n  ): void {\n    websocket.notifyAEVComplete(organizationId, {\n      evaluationId,\n      exploitable: result.exploitable,\n      confidence: result.confidence,\n      score: result.score,\n      status: result.status,\n      error: result.error,\n    });\n  }\n\n  private async emitKafkaEvent(\n    eventType: string,\n    organizationId: string,\n    payload: Record<string, any>\n  ): Promise<void> {\n    if (!kafka.isConnected()) return;\n\n    const event: KafkaEvent = {\n      eventId: nanoid(),\n      eventType,\n      organizationId,\n      payload,\n      timestamp: new Date().toISOString(),\n      source: \"aev-service\",\n      version: \"1.0\",\n    };\n\n    await kafka.publishEvent(TOPICS.SECURITY_EVENTS, event);\n  }\n\n  getEvaluation(evaluationId: string): AEVEvaluation | undefined {\n    return this.evaluations.get(evaluationId);\n  }\n\n  getEvaluationsByOrganization(organizationId: string): AEVEvaluation[] {\n    return Array.from(this.evaluations.values())\n      .filter((e) => e.input.organizationId === organizationId)\n      .sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());\n  }\n\n  async getPersistedResults(\n    organizationId: string, \n    filters: { taskId?: string; exploitable?: boolean; status?: string } = {},\n    pagination = { limit: 50, offset: 0 }\n  ) {\n    return await getAevResults(organizationId, filters, pagination, { sortBy: \"evaluatedAt\", sortOrder: \"desc\" });\n  }\n\n  async getPersistedResultByEvaluationId(organizationId: string, evaluationId: string) {\n    return await getAevResultByEvaluationId(organizationId, evaluationId);\n  }\n\n  isEnabled(): boolean {\n    return this.enabled;\n  }\n\n  getStats(): { enabled: boolean; totalEvaluations: number; pendingCount: number } {\n    const evaluations = Array.from(this.evaluations.values());\n    return {\n      enabled: this.enabled,\n      totalEvaluations: evaluations.length,\n      pendingCount: evaluations.filter((e) => e.status === \"in_progress\" || e.status === \"pending\").length,\n    };\n  }\n}\n\nexport const aevService = new AEVService();\n","path":null,"size_bytes":12884,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/components/FilterBar.tsx":{"content":"import { Button } from \"@/components/ui/button\";\n\ninterface FilterOption {\n  value: string;\n  label: string;\n  count?: number;\n}\n\ninterface FilterBarProps {\n  options: FilterOption[];\n  activeFilter: string;\n  onFilterChange: (filter: string) => void;\n}\n\nexport function FilterBar({ options, activeFilter, onFilterChange }: FilterBarProps) {\n  return (\n    <div className=\"flex items-center gap-2 flex-wrap\" data-testid=\"filter-bar\">\n      {options.map((option) => (\n        <Button\n          key={option.value}\n          variant={activeFilter === option.value ? \"default\" : \"outline\"}\n          size=\"sm\"\n          onClick={() => onFilterChange(option.value)}\n          className={activeFilter === option.value \n            ? \"bg-gradient-to-r from-cyan-600 to-blue-600 border-0\" \n            : \"\"}\n          data-testid={`filter-${option.value}`}\n        >\n          {option.label}\n          {option.count !== undefined && (\n            <span className={`ml-1.5 px-1.5 py-0.5 text-xs rounded ${\n              activeFilter === option.value \n                ? \"bg-white/20\" \n                : \"bg-muted\"\n            }`}>\n              {option.count}\n            </span>\n          )}\n        </Button>\n      ))}\n    </div>\n  );\n}\n","path":null,"size_bytes":1229,"size_tokens":null},"server/services/agents/index.ts":{"content":"export { runAgentOrchestrator } from \"./orchestrator\";\nexport { runEnhancedBusinessLogicEngine, shouldRunEnhancedEngine } from \"./business-logic\";\nexport { runMultiVectorAnalysisAgent, shouldRunMultiVectorAnalysis } from \"./multi-vector\";\nexport { runDefenderAgent } from \"./defender\";\nexport { runAISimulation } from \"./ai-simulation\";\nexport type {\n  AgentContext,\n  AgentMemory,\n  OrchestratorResult,\n  ProgressCallback,\n  ReconFindings,\n  ExploitFindings,\n  LateralFindings,\n  LateralShadowAdminIndicator,\n  BusinessLogicFindings,\n  EnhancedBusinessLogicFindings,\n  MultiVectorFindings,\n  ImpactFindings,\n} from \"./types\";\nexport type {\n  DefenderFindings,\n  DetectedAttack,\n  DefensiveControl,\n  MitigationAction,\n  BlockedPath,\n  Alert,\n} from \"./defender\";\nexport type {\n  AISimulationResult,\n  SimulationRound,\n  PurpleTeamFeedback,\n  SimulationRecommendation,\n  SimulationProgressCallback,\n} from \"./ai-simulation\";\n","path":null,"size_bytes":925,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/examples/StatCard.tsx":{"content":"import { StatCard } from \"../StatCard\";\nimport { Target, AlertTriangle, ShieldCheck, Activity, Zap } from \"lucide-react\";\n\nexport default function StatCardExample() {\n  return (\n    <div className=\"grid grid-cols-5 gap-4 p-4\">\n      <StatCard \n        label=\"Total Evaluations\" \n        value={42} \n        icon={Target}\n        trend={{ value: 12, isPositive: true }}\n      />\n      <StatCard \n        label=\"Active\" \n        value={3} \n        icon={Activity}\n        colorClass=\"text-amber-400\"\n      />\n      <StatCard \n        label=\"Exploitable\" \n        value={8} \n        icon={AlertTriangle}\n        colorClass=\"text-red-400\"\n        trend={{ value: 5, isPositive: false }}\n      />\n      <StatCard \n        label=\"Safe\" \n        value={31} \n        icon={ShieldCheck}\n        colorClass=\"text-emerald-400\"\n      />\n      <StatCard \n        label=\"Avg Confidence\" \n        value=\"87%\" \n        icon={Zap}\n        colorClass=\"text-cyan-400\"\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":976,"size_tokens":null},"server/db.ts":{"content":"import { drizzle } from \"drizzle-orm/node-postgres\";\nimport pg from \"pg\";\nimport * as schema from \"@shared/schema\";\n\nconst { Pool } = pg;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle(pool, { schema });\n","path":null,"size_bytes":395,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { insertEvaluationSchema, insertReportSchema, insertBatchJobSchema, insertScheduledScanSchema, complianceFrameworks } from \"@shared/schema\";\nimport { runAgentOrchestrator } from \"./services/agents\";\nimport { runAISimulation } from \"./services/agents/ai-simulation\";\nimport { wsService } from \"./services/websocket\";\nimport { reportGenerator } from \"./services/report-generator\";\nimport { unifiedAuthService } from \"./services/unified-auth\";\nimport { mtlsAuthService } from \"./services/mtls-auth\";\nimport { jwtAuthService } from \"./services/jwt-auth\";\nimport { \n  apiRateLimiter, \n  authRateLimiter, \n  agentTelemetryRateLimiter, \n  batchRateLimiter, \n  evaluationRateLimiter,\n  reportRateLimiter,\n  simulationRateLimiter\n} from \"./services/rate-limiter\";\nimport { randomUUID } from \"crypto\";\nimport bcrypt from \"bcrypt\";\nimport { z } from \"zod\";\nimport { registerReportV2Routes } from \"./src/reportsV2/routes\";\nimport { calculateDefensivePosture, calculateAttackPredictions } from \"./services/metrics-calculator\";\n\n// Agent API Validation Schemas\nconst agentRegisterSchema = z.object({\n  agentName: z.string().min(1).max(128),\n  hostname: z.string().max(256).optional(),\n  platform: z.enum([\"linux\", \"windows\", \"macos\", \"container\", \"kubernetes\"]).optional(),\n  platformVersion: z.string().max(64).optional(),\n  architecture: z.string().max(32).optional(),\n  capabilities: z.array(z.string().max(64)).max(50).optional(),\n  environment: z.enum([\"production\", \"staging\", \"development\"]).optional(),\n  tags: z.array(z.string().max(64)).max(20).optional(),\n});\n\nconst securityFindingSchema = z.object({\n  type: z.string().max(64).optional(),\n  severity: z.enum([\"critical\", \"high\", \"medium\", \"low\", \"info\"]).optional(),\n  title: z.string().max(256),\n  description: z.string().max(4096).optional(),\n  affectedComponent: z.string().max(256).optional(),\n  recommendation: z.string().max(2048).optional(),\n});\n\nconst agentTelemetrySchema = z.object({\n  systemInfo: z.record(z.unknown()).optional(),\n  resourceMetrics: z.record(z.unknown()).optional(),\n  services: z.array(z.record(z.unknown())).optional(),\n  openPorts: z.array(z.record(z.unknown())).optional(),\n  networkConnections: z.array(z.record(z.unknown())).optional(),\n  installedSoftware: z.array(z.record(z.unknown())).optional(),\n  configData: z.record(z.unknown()).optional(),\n  securityFindings: z.array(securityFindingSchema).max(100).optional(),\n  collectedAt: z.string().datetime().optional(),\n});\n\nexport async function registerRoutes(\n  httpServer: Server,\n  app: Express\n): Promise<Server> {\n  wsService.initialize(httpServer);\n  \n  // Apply API-wide rate limiting as a fallback for all endpoints\n  app.use(\"/api\", apiRateLimiter);\n\n  app.post(\"/api/aev/evaluate\", evaluationRateLimiter, async (req, res) => {\n    try {\n      const parsed = insertEvaluationSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid request body\", details: parsed.error });\n      }\n\n      const evaluation = await storage.createEvaluation(parsed.data);\n      \n      res.json({ evaluationId: evaluation.id, assetId: evaluation.assetId, status: \"started\" });\n\n      runEvaluation(evaluation.id, {\n        assetId: parsed.data.assetId,\n        exposureType: parsed.data.exposureType,\n        priority: parsed.data.priority || \"medium\",\n        description: parsed.data.description,\n        adversaryProfile: parsed.data.adversaryProfile || undefined,\n        organizationId: parsed.data.organizationId || \"default\",\n      });\n    } catch (error) {\n      console.error(\"Error starting evaluation:\", error);\n      res.status(500).json({ error: \"Failed to start evaluation\" });\n    }\n  });\n\n  app.get(\"/api/aev/evaluations\", async (req, res) => {\n    try {\n      const organizationId = req.query.organizationId as string | undefined;\n      const evaluations = await storage.getEvaluations(organizationId);\n      \n      const evaluationsWithResults = await Promise.all(\n        evaluations.map(async (evaluation) => {\n          const result = await storage.getResultByEvaluationId(evaluation.id);\n          return {\n            ...evaluation,\n            exploitable: result?.exploitable,\n            score: result?.score,\n            confidence: result?.confidence ? result.confidence / 100 : undefined,\n            intelligentScore: result?.intelligentScore,\n          };\n        })\n      );\n      \n      res.json(evaluationsWithResults);\n    } catch (error) {\n      console.error(\"Error fetching evaluations:\", error);\n      res.status(500).json({ error: \"Failed to fetch evaluations\" });\n    }\n  });\n\n  app.get(\"/api/aev/evaluations/:id\", async (req, res) => {\n    try {\n      const evaluation = await storage.getEvaluation(req.params.id);\n      if (!evaluation) {\n        return res.status(404).json({ error: \"Evaluation not found\" });\n      }\n\n      const result = await storage.getResultByEvaluationId(evaluation.id);\n      \n      res.json({\n        ...evaluation,\n        exploitable: result?.exploitable,\n        score: result?.score,\n        confidence: result?.confidence ? result.confidence / 100 : undefined,\n        attackPath: result?.attackPath,\n        attackGraph: result?.attackGraph,\n        businessLogicFindings: result?.businessLogicFindings,\n        multiVectorFindings: result?.multiVectorFindings,\n        workflowAnalysis: result?.workflowAnalysis,\n        recommendations: result?.recommendations,\n        impact: result?.impact,\n        evidenceArtifacts: result?.evidenceArtifacts,\n        intelligentScore: result?.intelligentScore,\n        remediationGuidance: result?.remediationGuidance,\n        duration: result?.duration,\n      });\n    } catch (error) {\n      console.error(\"Error fetching evaluation:\", error);\n      res.status(500).json({ error: \"Failed to fetch evaluation\" });\n    }\n  });\n\n  app.delete(\"/api/aev/evaluations/:id\", async (req, res) => {\n    try {\n      const evaluationId = req.params.id;\n      const evaluation = await storage.getEvaluation(evaluationId);\n      \n      if (!evaluation) {\n        return res.status(404).json({ error: \"Evaluation not found\" });\n      }\n\n      await storage.deleteResult(evaluationId);\n      await storage.deleteEvaluation(evaluationId);\n      \n      res.json({ success: true, message: \"Evaluation deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting evaluation:\", error);\n      res.status(500).json({ error: \"Failed to delete evaluation\" });\n    }\n  });\n\n  app.patch(\"/api/aev/evaluations/:id/archive\", async (req, res) => {\n    try {\n      const evaluationId = req.params.id;\n      const evaluation = await storage.getEvaluation(evaluationId);\n      \n      if (!evaluation) {\n        return res.status(404).json({ error: \"Evaluation not found\" });\n      }\n\n      await storage.updateEvaluationStatus(evaluationId, \"archived\");\n      \n      res.json({ success: true, message: \"Evaluation archived successfully\" });\n    } catch (error) {\n      console.error(\"Error archiving evaluation:\", error);\n      res.status(500).json({ error: \"Failed to archive evaluation\" });\n    }\n  });\n\n  app.patch(\"/api/aev/evaluations/:id/unarchive\", async (req, res) => {\n    try {\n      const evaluationId = req.params.id;\n      const evaluation = await storage.getEvaluation(evaluationId);\n      \n      if (!evaluation) {\n        return res.status(404).json({ error: \"Evaluation not found\" });\n      }\n\n      await storage.updateEvaluationStatus(evaluationId, \"completed\");\n      \n      res.json({ success: true, message: \"Evaluation restored successfully\" });\n    } catch (error) {\n      console.error(\"Error restoring evaluation:\", error);\n      res.status(500).json({ error: \"Failed to restore evaluation\" });\n    }\n  });\n\n  app.get(\"/api/aev/stats\", async (req, res) => {\n    try {\n      const evaluations = await storage.getEvaluations();\n      const resultsPromises = evaluations.map(e => storage.getResultByEvaluationId(e.id));\n      const results = await Promise.all(resultsPromises);\n      \n      const completedResults = results.filter(r => r !== undefined);\n      const exploitableCount = completedResults.filter(r => r?.exploitable).length;\n      const safeCount = completedResults.filter(r => r && !r.exploitable).length;\n      \n      const avgConfidence = completedResults.length > 0\n        ? Math.round(completedResults.reduce((sum, r) => sum + (r?.confidence || 0), 0) / completedResults.length)\n        : 0;\n\n      res.json({\n        total: evaluations.length,\n        active: evaluations.filter(e => e.status === \"pending\" || e.status === \"in_progress\").length,\n        completed: evaluations.filter(e => e.status === \"completed\").length,\n        exploitable: exploitableCount,\n        safe: safeCount,\n        avgConfidence,\n      });\n    } catch (error) {\n      console.error(\"Error fetching stats:\", error);\n      res.status(500).json({ error: \"Failed to fetch stats\" });\n    }\n  });\n\n  // ========== SYSTEM MONITORING ENDPOINTS ==========\n  \n  app.get(\"/api/system/websocket-stats\", async (req, res) => {\n    try {\n      const stats = wsService.getStats();\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching WebSocket stats:\", error);\n      res.status(500).json({ error: \"Failed to fetch WebSocket stats\" });\n    }\n  });\n\n  // ========== REPORTING ENDPOINTS ==========\n  \n  app.post(\"/api/reports/generate\", reportRateLimiter, async (req, res) => {\n    try {\n      const { type, format, from, to, framework, organizationId = \"default\", evaluationId } = req.body;\n      \n      // If evaluationId is provided, generate single-evaluation report\n      if (evaluationId) {\n        if (!type || !format) {\n          return res.status(400).json({ error: \"Missing required fields: type, format\" });\n        }\n        \n        let reportData: any;\n        let title = \"\";\n        \n        switch (type) {\n          case \"executive_summary\":\n            reportData = await reportGenerator.generateSingleEvaluationExecutiveSummary(evaluationId);\n            title = `Executive Summary - Evaluation ${evaluationId}`;\n            break;\n          case \"technical_deep_dive\":\n            reportData = await reportGenerator.generateSingleEvaluationTechnicalReport(evaluationId);\n            title = `Technical Report - Evaluation ${evaluationId}`;\n            break;\n          case \"compliance_mapping\":\n            if (!framework) {\n              return res.status(400).json({ error: \"Compliance reports require a framework parameter\" });\n            }\n            if (!complianceFrameworks.includes(framework)) {\n              return res.status(400).json({ error: `Invalid framework. Valid options: ${complianceFrameworks.join(\", \")}` });\n            }\n            reportData = await reportGenerator.generateSingleEvaluationComplianceReport(evaluationId, framework);\n            title = `Compliance Report (${framework.toUpperCase()}) - Evaluation ${evaluationId}`;\n            break;\n          default:\n            return res.status(400).json({ error: \"Invalid report type\" });\n        }\n        \n        let content: string;\n        let contentType: string;\n        \n        switch (format) {\n          case \"json\":\n            content = reportGenerator.exportToJSON(reportData);\n            contentType = \"application/json\";\n            break;\n          case \"csv\":\n            const flatData = type === \"technical_deep_dive\" ? reportData.findings : [reportData];\n            const headers = Object.keys(flatData[0] || {});\n            content = reportGenerator.exportToCSV(flatData, headers);\n            contentType = \"text/csv\";\n            break;\n          default:\n            content = reportGenerator.exportToJSON(reportData);\n            contentType = \"application/json\";\n        }\n        \n        const report = await storage.createReport({\n          reportType: type,\n          title,\n          organizationId: reportData.organizationId || organizationId,\n          status: \"completed\",\n          content: reportData,\n          dateRangeFrom: new Date(),\n          dateRangeTo: new Date(),\n          framework,\n        });\n        \n        return res.json({ \n          reportId: report.id, \n          title,\n          data: reportData,\n          content,\n          contentType,\n        });\n      }\n      \n      // Date range based reports\n      if (!type || !format || !from || !to) {\n        return res.status(400).json({ error: \"Missing required fields: type, format, from, to (or evaluationId for single evaluation reports)\" });\n      }\n      \n      const fromDate = new Date(from);\n      // Set toDate to end of day (23:59:59.999) to include entire end date\n      const toDate = new Date(to);\n      toDate.setHours(23, 59, 59, 999);\n      \n      let reportData: any;\n      let title = \"\";\n      \n      switch (type) {\n        case \"executive_summary\":\n          reportData = await reportGenerator.generateExecutiveSummary(fromDate, toDate, organizationId);\n          title = `Executive Summary - ${fromDate.toLocaleDateString()} to ${toDate.toLocaleDateString()}`;\n          break;\n        case \"technical_deep_dive\":\n          reportData = await reportGenerator.generateTechnicalReport(fromDate, toDate, organizationId);\n          title = `Technical Report - ${fromDate.toLocaleDateString()} to ${toDate.toLocaleDateString()}`;\n          break;\n        case \"compliance_mapping\":\n          if (!framework) {\n            return res.status(400).json({ error: \"Compliance reports require a framework parameter\" });\n          }\n          if (!complianceFrameworks.includes(framework)) {\n            return res.status(400).json({ error: `Invalid framework. Valid options: ${complianceFrameworks.join(\", \")}` });\n          }\n          reportData = await reportGenerator.generateComplianceReport(framework, fromDate, toDate, organizationId);\n          title = `Compliance Report (${framework.toUpperCase()}) - ${fromDate.toLocaleDateString()} to ${toDate.toLocaleDateString()}`;\n          break;\n        default:\n          return res.status(400).json({ error: \"Invalid report type\" });\n      }\n      \n      let content: string;\n      let contentType: string;\n      \n      switch (format) {\n        case \"json\":\n          content = reportGenerator.exportToJSON(reportData);\n          contentType = \"application/json\";\n          break;\n        case \"csv\":\n          const flatData = type === \"technical_deep_dive\" ? reportData.findings : [reportData];\n          const headers = Object.keys(flatData[0] || {});\n          content = reportGenerator.exportToCSV(flatData, headers);\n          contentType = \"text/csv\";\n          break;\n        default:\n          content = reportGenerator.exportToJSON(reportData);\n          contentType = \"application/json\";\n      }\n      \n      const report = await storage.createReport({\n        reportType: type,\n        title,\n        organizationId,\n        status: \"completed\",\n        content: reportData,\n        dateRangeFrom: fromDate,\n        dateRangeTo: toDate,\n        framework,\n      });\n      \n      res.json({ \n        reportId: report.id, \n        title,\n        data: reportData,\n        content,\n        contentType,\n      });\n    } catch (error) {\n      console.error(\"Error generating report:\", error);\n      res.status(500).json({ error: \"Failed to generate report\" });\n    }\n  });\n  \n  app.get(\"/api/reports\", async (req, res) => {\n    try {\n      const organizationId = req.query.organizationId as string | undefined;\n      const reports = await storage.getReports(organizationId);\n      res.json(reports);\n    } catch (error) {\n      console.error(\"Error fetching reports:\", error);\n      res.status(500).json({ error: \"Failed to fetch reports\" });\n    }\n  });\n  \n  app.get(\"/api/reports/:id\", async (req, res) => {\n    try {\n      const report = await storage.getReport(req.params.id);\n      if (!report) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n      res.json(report);\n    } catch (error) {\n      console.error(\"Error fetching report:\", error);\n      res.status(500).json({ error: \"Failed to fetch report\" });\n    }\n  });\n  \n  app.delete(\"/api/reports/:id\", async (req, res) => {\n    try {\n      const report = await storage.getReport(req.params.id);\n      if (!report) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n      await storage.deleteReport(req.params.id);\n      res.json({ success: true, message: \"Report deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting report:\", error);\n      res.status(500).json({ error: \"Failed to delete report\" });\n    }\n  });\n  \n  app.get(\"/api/reports/:id/download\", async (req, res) => {\n    try {\n      const report = await storage.getReport(req.params.id);\n      if (!report) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n      \n      const format = req.query.format || \"json\";\n      let content: string;\n      let filename: string;\n      let contentType: string;\n      \n      switch (format) {\n        case \"csv\":\n          const data = report.content as any;\n          const flatData = data?.findings || [data];\n          const headers = Object.keys(flatData[0] || {});\n          content = reportGenerator.exportToCSV(flatData, headers);\n          filename = `${report.title.replace(/\\s+/g, \"_\")}.csv`;\n          contentType = \"text/csv\";\n          break;\n        case \"json\":\n        default:\n          content = reportGenerator.exportToJSON(report.content);\n          filename = `${report.title.replace(/\\s+/g, \"_\")}.json`;\n          contentType = \"application/json\";\n          break;\n      }\n      \n      res.setHeader(\"Content-Type\", contentType);\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${filename}\"`);\n      res.send(content);\n    } catch (error) {\n      console.error(\"Error downloading report:\", error);\n      res.status(500).json({ error: \"Failed to download report\" });\n    }\n  });\n\n  app.get(\"/api/reports/enhanced/:evaluationId\", async (req, res) => {\n    try {\n      const { evaluationId } = req.params;\n      const includeKillChain = req.query.includeKillChain !== \"false\";\n      const includeRemediation = req.query.includeRemediation !== \"false\";\n      const includeVulnerabilityDetails = req.query.includeVulnerabilityDetails !== \"false\";\n      \n      const enhancedReport = await reportGenerator.generateEnhancedReport(evaluationId, {\n        includeKillChain,\n        includeRemediation,\n        includeVulnerabilityDetails,\n      });\n      \n      res.json(enhancedReport);\n    } catch (error: any) {\n      console.error(\"Error generating enhanced report:\", error);\n      if (error.message?.includes(\"not found\")) {\n        return res.status(404).json({ error: error.message });\n      }\n      res.status(500).json({ error: \"Failed to generate enhanced report\" });\n    }\n  });\n\n  app.post(\"/api/reports/enhanced/date-range\", reportRateLimiter, async (req, res) => {\n    try {\n      const { from, to, organizationId = \"default\", includeKillChain = true, includeRemediation = true } = req.body;\n      \n      if (!from || !to) {\n        return res.status(400).json({ error: \"Missing required fields: from, to\" });\n      }\n      \n      const fromDate = new Date(from);\n      const toDate = new Date(to);\n      toDate.setHours(23, 59, 59, 999);\n      \n      const enhancedReport = await reportGenerator.generateEnhancedDateRangeReport(\n        fromDate,\n        toDate,\n        organizationId,\n        { includeKillChain, includeRemediation }\n      );\n      \n      res.json(enhancedReport);\n    } catch (error) {\n      console.error(\"Error generating enhanced date range report:\", error);\n      res.status(500).json({ error: \"Failed to generate enhanced report\" });\n    }\n  });\n\n  // ========== REPORT V2 NARRATIVE ENDPOINTS ==========\n  registerReportV2Routes(app);\n\n  // ========== EVIDENCE EXPORT ENDPOINT ==========\n  \n  app.post(\"/api/evidence/:evaluationId/export\", async (req, res) => {\n    try {\n      const { evaluationId } = req.params;\n      const { format = \"json\" } = req.body;\n      \n      // Get the evaluation and its result\n      const evaluation = await storage.getEvaluation(evaluationId);\n      if (!evaluation) {\n        return res.status(404).json({ error: \"Evaluation not found\" });\n      }\n      \n      const result = await storage.getResultByEvaluationId(evaluationId);\n      \n      // Extract artifacts from the result\n      const artifacts = (result?.evidenceArtifacts as any[]) || [];\n      \n      // Generate AI-enhanced evidence package\n      const evidencePackage = await reportGenerator.generateEvidencePackage(\n        evaluationId,\n        artifacts,\n        result\n      );\n      \n      if (format === \"pdf\") {\n        // Return structured data for PDF generation (handled on frontend)\n        res.json({\n          success: true,\n          format: \"pdf\",\n          data: evidencePackage,\n        });\n      } else {\n        // Return JSON with natural language narratives\n        res.json({\n          success: true,\n          format: \"json\",\n          data: evidencePackage,\n        });\n      }\n    } catch (error) {\n      console.error(\"Error exporting evidence:\", error);\n      res.status(500).json({ error: \"Failed to export evidence\" });\n    }\n  });\n\n  // ========== BATCH JOB ENDPOINTS ==========\n  \n  app.post(\"/api/batch-jobs\", batchRateLimiter, async (req, res) => {\n    try {\n      const parsed = insertBatchJobSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid request body\", details: parsed.error });\n      }\n      \n      const batchJob = await storage.createBatchJob({\n        ...parsed.data,\n        totalEvaluations: (parsed.data.assets as any[]).length,\n      });\n      \n      res.json({ batchJobId: batchJob.id, status: \"created\" });\n      \n      runBatchJob(batchJob.id, parsed.data.assets as any[]);\n    } catch (error) {\n      console.error(\"Error creating batch job:\", error);\n      res.status(500).json({ error: \"Failed to create batch job\" });\n    }\n  });\n  \n  app.get(\"/api/batch-jobs\", async (req, res) => {\n    try {\n      const organizationId = req.query.organizationId as string | undefined;\n      const jobs = await storage.getBatchJobs(organizationId);\n      res.json(jobs);\n    } catch (error) {\n      console.error(\"Error fetching batch jobs:\", error);\n      res.status(500).json({ error: \"Failed to fetch batch jobs\" });\n    }\n  });\n  \n  app.get(\"/api/batch-jobs/:id\", async (req, res) => {\n    try {\n      const job = await storage.getBatchJob(req.params.id);\n      if (!job) {\n        return res.status(404).json({ error: \"Batch job not found\" });\n      }\n      res.json(job);\n    } catch (error) {\n      console.error(\"Error fetching batch job:\", error);\n      res.status(500).json({ error: \"Failed to fetch batch job\" });\n    }\n  });\n  \n  app.delete(\"/api/batch-jobs/:id\", async (req, res) => {\n    try {\n      const job = await storage.getBatchJob(req.params.id);\n      if (!job) {\n        return res.status(404).json({ error: \"Batch job not found\" });\n      }\n      await storage.deleteBatchJob(req.params.id);\n      res.json({ success: true, message: \"Batch job deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting batch job:\", error);\n      res.status(500).json({ error: \"Failed to delete batch job\" });\n    }\n  });\n\n  app.patch(\"/api/batch-jobs/:id\", async (req, res) => {\n    try {\n      const job = await storage.getBatchJob(req.params.id);\n      if (!job) {\n        return res.status(404).json({ error: \"Batch job not found\" });\n      }\n      await storage.updateBatchJob(req.params.id, req.body);\n      const updatedJob = await storage.getBatchJob(req.params.id);\n      res.json(updatedJob);\n    } catch (error) {\n      console.error(\"Error updating batch job:\", error);\n      res.status(500).json({ error: \"Failed to update batch job\" });\n    }\n  });\n\n  // ========== SCHEDULED SCAN ENDPOINTS ==========\n  \n  app.post(\"/api/scheduled-scans\", async (req, res) => {\n    try {\n      const parsed = insertScheduledScanSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid request body\", details: parsed.error });\n      }\n      \n      const scan = await storage.createScheduledScan(parsed.data);\n      res.json(scan);\n    } catch (error) {\n      console.error(\"Error creating scheduled scan:\", error);\n      res.status(500).json({ error: \"Failed to create scheduled scan\" });\n    }\n  });\n  \n  app.get(\"/api/scheduled-scans\", async (req, res) => {\n    try {\n      const organizationId = req.query.organizationId as string | undefined;\n      const scans = await storage.getScheduledScans(organizationId);\n      res.json(scans);\n    } catch (error) {\n      console.error(\"Error fetching scheduled scans:\", error);\n      res.status(500).json({ error: \"Failed to fetch scheduled scans\" });\n    }\n  });\n  \n  app.get(\"/api/scheduled-scans/:id\", async (req, res) => {\n    try {\n      const scan = await storage.getScheduledScan(req.params.id);\n      if (!scan) {\n        return res.status(404).json({ error: \"Scheduled scan not found\" });\n      }\n      res.json(scan);\n    } catch (error) {\n      console.error(\"Error fetching scheduled scan:\", error);\n      res.status(500).json({ error: \"Failed to fetch scheduled scan\" });\n    }\n  });\n  \n  app.patch(\"/api/scheduled-scans/:id\", async (req, res) => {\n    try {\n      const scan = await storage.getScheduledScan(req.params.id);\n      if (!scan) {\n        return res.status(404).json({ error: \"Scheduled scan not found\" });\n      }\n      await storage.updateScheduledScan(req.params.id, req.body);\n      const updated = await storage.getScheduledScan(req.params.id);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating scheduled scan:\", error);\n      res.status(500).json({ error: \"Failed to update scheduled scan\" });\n    }\n  });\n  \n  app.delete(\"/api/scheduled-scans/:id\", async (req, res) => {\n    try {\n      const scan = await storage.getScheduledScan(req.params.id);\n      if (!scan) {\n        return res.status(404).json({ error: \"Scheduled scan not found\" });\n      }\n      await storage.deleteScheduledScan(req.params.id);\n      res.json({ success: true, message: \"Scheduled scan deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting scheduled scan:\", error);\n      res.status(500).json({ error: \"Failed to delete scheduled scan\" });\n    }\n  });\n\n  // ========== GOVERNANCE ENDPOINTS ==========\n  \n  // Get or create organization governance settings\n  app.get(\"/api/governance/:organizationId\", async (req, res) => {\n    try {\n      let governance = await storage.getOrganizationGovernance(req.params.organizationId);\n      if (!governance) {\n        governance = await storage.createOrganizationGovernance({\n          organizationId: req.params.organizationId,\n        });\n      }\n      res.json(governance);\n    } catch (error) {\n      console.error(\"Error fetching governance:\", error);\n      res.status(500).json({ error: \"Failed to fetch governance settings\" });\n    }\n  });\n\n  app.patch(\"/api/governance/:organizationId\", async (req, res) => {\n    try {\n      await storage.updateOrganizationGovernance(req.params.organizationId, req.body);\n      \n      // Log the change\n      await storage.createAuthorizationLog({\n        organizationId: req.params.organizationId,\n        action: \"execution_mode_changed\",\n        details: req.body,\n        authorized: true,\n      });\n      \n      const updated = await storage.getOrganizationGovernance(req.params.organizationId);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating governance:\", error);\n      res.status(500).json({ error: \"Failed to update governance settings\" });\n    }\n  });\n\n  // Kill Switch\n  app.post(\"/api/governance/:organizationId/kill-switch\", async (req, res) => {\n    try {\n      const { activate, activatedBy } = req.body;\n      \n      if (activate) {\n        await storage.activateKillSwitch(req.params.organizationId, activatedBy || \"system\");\n        await storage.createAuthorizationLog({\n          organizationId: req.params.organizationId,\n          action: \"kill_switch_activated\",\n          userId: activatedBy,\n          authorized: true,\n          riskLevel: \"critical\",\n        });\n      } else {\n        await storage.deactivateKillSwitch(req.params.organizationId);\n        await storage.createAuthorizationLog({\n          organizationId: req.params.organizationId,\n          action: \"kill_switch_deactivated\",\n          userId: activatedBy,\n          authorized: true,\n        });\n      }\n      \n      const governance = await storage.getOrganizationGovernance(req.params.organizationId);\n      res.json(governance);\n    } catch (error) {\n      console.error(\"Error toggling kill switch:\", error);\n      res.status(500).json({ error: \"Failed to toggle kill switch\" });\n    }\n  });\n\n  // Authorization Logs\n  app.get(\"/api/authorization-logs/:organizationId\", async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 100;\n      const logs = await storage.getAuthorizationLogs(req.params.organizationId, limit);\n      res.json(logs);\n    } catch (error) {\n      console.error(\"Error fetching authorization logs:\", error);\n      res.status(500).json({ error: \"Failed to fetch authorization logs\" });\n    }\n  });\n\n  // Scope Rules\n  app.get(\"/api/scope-rules/:organizationId\", async (req, res) => {\n    try {\n      const rules = await storage.getScopeRules(req.params.organizationId);\n      res.json(rules);\n    } catch (error) {\n      console.error(\"Error fetching scope rules:\", error);\n      res.status(500).json({ error: \"Failed to fetch scope rules\" });\n    }\n  });\n\n  app.post(\"/api/scope-rules\", async (req, res) => {\n    try {\n      const rule = await storage.createScopeRule(req.body);\n      \n      await storage.createAuthorizationLog({\n        organizationId: req.body.organizationId,\n        action: \"scope_rule_modified\",\n        details: { action: \"created\", ruleId: rule.id, ruleName: rule.name },\n        authorized: true,\n      });\n      \n      res.json(rule);\n    } catch (error) {\n      console.error(\"Error creating scope rule:\", error);\n      res.status(500).json({ error: \"Failed to create scope rule\" });\n    }\n  });\n\n  app.delete(\"/api/scope-rules/:id\", async (req, res) => {\n    try {\n      await storage.deleteScopeRule(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting scope rule:\", error);\n      res.status(500).json({ error: \"Failed to delete scope rule\" });\n    }\n  });\n\n  // ========== ADVANCED AI ENDPOINTS ==========\n\n  // Adversary Profiles\n  app.get(\"/api/adversary-profiles\", async (req, res) => {\n    try {\n      let profiles = await storage.getAdversaryProfiles();\n      \n      // Seed built-in profiles if none exist\n      if (profiles.length === 0) {\n        const builtInProfiles = [\n          {\n            name: \"Script Kiddie\",\n            profileType: \"script_kiddie\",\n            description: \"Low-skill attacker using pre-made tools and scripts\",\n            capabilities: {\n              technicalSophistication: 2,\n              resources: 1,\n              persistence: 2,\n              stealth: 1,\n              targetedAttacks: false,\n              zerodays: false,\n              socialEngineering: false,\n              physicalAccess: false,\n            },\n            typicalTTPs: [\"T1190\", \"T1110\", \"T1059\"],\n            motivations: [\"curiosity\", \"recognition\"],\n            targetPreferences: [\"any\", \"opportunistic\"],\n            avgDwellTime: 1,\n            detectionDifficulty: \"low\",\n            isBuiltIn: true,\n          },\n          {\n            name: \"Organized Crime\",\n            profileType: \"organized_crime\",\n            description: \"Financially motivated criminal organization with moderate resources\",\n            capabilities: {\n              technicalSophistication: 6,\n              resources: 7,\n              persistence: 7,\n              stealth: 5,\n              targetedAttacks: true,\n              zerodays: false,\n              socialEngineering: true,\n              physicalAccess: false,\n            },\n            typicalTTPs: [\"T1566\", \"T1486\", \"T1078\", \"T1027\"],\n            motivations: [\"financial\", \"ransomware\"],\n            targetPreferences: [\"healthcare\", \"finance\", \"retail\"],\n            avgDwellTime: 14,\n            detectionDifficulty: \"medium\",\n            isBuiltIn: true,\n          },\n          {\n            name: \"Nation State Actor\",\n            profileType: \"nation_state\",\n            description: \"State-sponsored threat actor with extensive resources and capabilities\",\n            capabilities: {\n              technicalSophistication: 10,\n              resources: 10,\n              persistence: 10,\n              stealth: 9,\n              targetedAttacks: true,\n              zerodays: true,\n              socialEngineering: true,\n              physicalAccess: true,\n            },\n            typicalTTPs: [\"T1195\", \"T1190\", \"T1003\", \"T1071\", \"T1020\"],\n            motivations: [\"espionage\", \"disruption\", \"intelligence\"],\n            targetPreferences: [\"government\", \"defense\", \"critical_infrastructure\"],\n            avgDwellTime: 365,\n            detectionDifficulty: \"very_high\",\n            isBuiltIn: true,\n          },\n          {\n            name: \"Insider Threat\",\n            profileType: \"insider_threat\",\n            description: \"Malicious insider with legitimate access and system knowledge\",\n            capabilities: {\n              technicalSophistication: 5,\n              resources: 3,\n              persistence: 6,\n              stealth: 8,\n              targetedAttacks: true,\n              zerodays: false,\n              socialEngineering: false,\n              physicalAccess: true,\n            },\n            typicalTTPs: [\"T1078\", \"T1530\", \"T1567\", \"T1552\"],\n            motivations: [\"financial\", \"revenge\", \"ideology\"],\n            targetPreferences: [\"employer_data\", \"trade_secrets\"],\n            avgDwellTime: 90,\n            detectionDifficulty: \"high\",\n            isBuiltIn: true,\n          },\n          {\n            name: \"APT Group\",\n            profileType: \"apt_group\",\n            description: \"Advanced Persistent Threat group with sophisticated tradecraft\",\n            capabilities: {\n              technicalSophistication: 9,\n              resources: 8,\n              persistence: 9,\n              stealth: 8,\n              targetedAttacks: true,\n              zerodays: true,\n              socialEngineering: true,\n              physicalAccess: false,\n            },\n            typicalTTPs: [\"T1566.001\", \"T1059.001\", \"T1003\", \"T1021\", \"T1071\"],\n            motivations: [\"espionage\", \"financial\"],\n            targetPreferences: [\"technology\", \"finance\", \"energy\"],\n            avgDwellTime: 180,\n            detectionDifficulty: \"high\",\n            isBuiltIn: true,\n          },\n        ];\n        \n        for (const profile of builtInProfiles) {\n          await storage.createAdversaryProfile(profile);\n        }\n        \n        profiles = await storage.getAdversaryProfiles();\n      }\n      \n      res.json(profiles);\n    } catch (error) {\n      console.error(\"Error fetching adversary profiles:\", error);\n      res.status(500).json({ error: \"Failed to fetch adversary profiles\" });\n    }\n  });\n\n  app.get(\"/api/adversary-profiles/:id\", async (req, res) => {\n    try {\n      const profile = await storage.getAdversaryProfile(req.params.id);\n      if (!profile) {\n        return res.status(404).json({ error: \"Adversary profile not found\" });\n      }\n      res.json(profile);\n    } catch (error) {\n      console.error(\"Error fetching adversary profile:\", error);\n      res.status(500).json({ error: \"Failed to fetch adversary profile\" });\n    }\n  });\n\n  app.post(\"/api/adversary-profiles\", async (req, res) => {\n    try {\n      const profile = await storage.createAdversaryProfile(req.body);\n      res.json(profile);\n    } catch (error) {\n      console.error(\"Error creating adversary profile:\", error);\n      res.status(500).json({ error: \"Failed to create adversary profile\" });\n    }\n  });\n\n  // Attack Predictions - computed from real evaluation data\n  app.get(\"/api/attack-predictions/:organizationId\", async (req, res) => {\n    try {\n      const timeHorizon = req.query.timeHorizon as string || \"30d\";\n      const predictions = await calculateAttackPredictions(req.params.organizationId, timeHorizon);\n      res.json(predictions);\n    } catch (error) {\n      console.error(\"Error calculating attack predictions:\", error);\n      res.status(500).json({ error: \"Failed to calculate attack predictions\" });\n    }\n  });\n\n  app.post(\"/api/attack-predictions/generate\", async (req, res) => {\n    try {\n      const { organizationId, timeHorizon } = req.body;\n      const predictions = await calculateAttackPredictions(organizationId, timeHorizon || \"30d\");\n      res.json(predictions);\n    } catch (error) {\n      console.error(\"Error generating attack prediction:\", error);\n      res.status(500).json({ error: \"Failed to generate attack prediction\" });\n    }\n  });\n\n  // Defensive Posture - computed from real evaluation data\n  app.get(\"/api/defensive-posture/:organizationId\", async (req, res) => {\n    try {\n      const posture = await calculateDefensivePosture(req.params.organizationId);\n      res.json(posture);\n    } catch (error) {\n      console.error(\"Error calculating defensive posture:\", error);\n      res.status(500).json({ error: \"Failed to calculate defensive posture\" });\n    }\n  });\n\n  app.get(\"/api/defensive-posture/:organizationId/history\", async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 30;\n      const history = await storage.getDefensivePostureHistory(req.params.organizationId, limit);\n      res.json(history);\n    } catch (error) {\n      console.error(\"Error fetching posture history:\", error);\n      res.status(500).json({ error: \"Failed to fetch posture history\" });\n    }\n  });\n\n  // Purple Team Findings\n  app.get(\"/api/purple-team/:organizationId\", async (req, res) => {\n    try {\n      const findings = await storage.getPurpleTeamFindings(req.params.organizationId);\n      res.json(findings);\n    } catch (error) {\n      console.error(\"Error fetching purple team findings:\", error);\n      res.status(500).json({ error: \"Failed to fetch purple team findings\" });\n    }\n  });\n\n  app.post(\"/api/purple-team\", async (req, res) => {\n    try {\n      const finding = await storage.createPurpleTeamFinding(req.body);\n      res.json(finding);\n    } catch (error) {\n      console.error(\"Error creating purple team finding:\", error);\n      res.status(500).json({ error: \"Failed to create purple team finding\" });\n    }\n  });\n\n  app.patch(\"/api/purple-team/:id\", async (req, res) => {\n    try {\n      await storage.updatePurpleTeamFinding(req.params.id, req.body);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error updating purple team finding:\", error);\n      res.status(500).json({ error: \"Failed to update purple team finding\" });\n    }\n  });\n\n  // AI Simulations\n  app.get(\"/api/ai-simulations/:organizationId\", async (req, res) => {\n    try {\n      const simulations = await storage.getAiSimulations(req.params.organizationId);\n      res.json(simulations);\n    } catch (error) {\n      console.error(\"Error fetching AI simulations:\", error);\n      res.status(500).json({ error: \"Failed to fetch AI simulations\" });\n    }\n  });\n\n  app.post(\"/api/ai-simulations\", async (req, res) => {\n    try {\n      const simulation = await storage.createAiSimulation({\n        ...req.body,\n        simulationStatus: \"pending\",\n      });\n      \n      // Start simulation in background\n      runAiSimulation(simulation.id);\n      \n      res.json(simulation);\n    } catch (error) {\n      console.error(\"Error creating AI simulation:\", error);\n      res.status(500).json({ error: \"Failed to create AI simulation\" });\n    }\n  });\n\n  app.get(\"/api/ai-simulations/detail/:id\", async (req, res) => {\n    try {\n      const simulation = await storage.getAiSimulation(req.params.id);\n      if (!simulation) {\n        return res.status(404).json({ error: \"Simulation not found\" });\n      }\n      res.json(simulation);\n    } catch (error) {\n      console.error(\"Error fetching AI simulation:\", error);\n      res.status(500).json({ error: \"Failed to fetch AI simulation\" });\n    }\n  });\n\n  // ============================================\n  // INFRASTRUCTURE DATA INGESTION ENDPOINTS\n  // ============================================\n\n  // Get infrastructure statistics\n  app.get(\"/api/infrastructure/stats\", async (req, res) => {\n    try {\n      const stats = await storage.getInfrastructureStats();\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching infrastructure stats:\", error);\n      res.status(500).json({ error: \"Failed to fetch infrastructure stats\" });\n    }\n  });\n\n  // ========== DISCOVERED ASSETS ==========\n\n  app.get(\"/api/assets\", async (req, res) => {\n    try {\n      const assets = await storage.getDiscoveredAssets();\n      res.json(assets);\n    } catch (error) {\n      console.error(\"Error fetching assets:\", error);\n      res.status(500).json({ error: \"Failed to fetch assets\" });\n    }\n  });\n\n  app.get(\"/api/assets/:id\", async (req, res) => {\n    try {\n      const asset = await storage.getDiscoveredAsset(req.params.id);\n      if (!asset) {\n        return res.status(404).json({ error: \"Asset not found\" });\n      }\n      res.json(asset);\n    } catch (error) {\n      console.error(\"Error fetching asset:\", error);\n      res.status(500).json({ error: \"Failed to fetch asset\" });\n    }\n  });\n\n  app.get(\"/api/assets/:id/vulnerabilities\", async (req, res) => {\n    try {\n      const vulns = await storage.getVulnerabilityImportsByAssetId(req.params.id);\n      res.json(vulns);\n    } catch (error) {\n      console.error(\"Error fetching asset vulnerabilities:\", error);\n      res.status(500).json({ error: \"Failed to fetch asset vulnerabilities\" });\n    }\n  });\n\n  app.patch(\"/api/assets/:id\", async (req, res) => {\n    try {\n      await storage.updateDiscoveredAsset(req.params.id, req.body);\n      const updated = await storage.getDiscoveredAsset(req.params.id);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating asset:\", error);\n      res.status(500).json({ error: \"Failed to update asset\" });\n    }\n  });\n\n  app.delete(\"/api/assets/:id\", async (req, res) => {\n    try {\n      await storage.deleteDiscoveredAsset(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting asset:\", error);\n      res.status(500).json({ error: \"Failed to delete asset\" });\n    }\n  });\n\n  // ========== VULNERABILITY IMPORTS ==========\n\n  app.get(\"/api/vulnerabilities\", async (req, res) => {\n    try {\n      const vulns = await storage.getVulnerabilityImports();\n      res.json(vulns);\n    } catch (error) {\n      console.error(\"Error fetching vulnerabilities:\", error);\n      res.status(500).json({ error: \"Failed to fetch vulnerabilities\" });\n    }\n  });\n\n  app.get(\"/api/vulnerabilities/:id\", async (req, res) => {\n    try {\n      const vuln = await storage.getVulnerabilityImport(req.params.id);\n      if (!vuln) {\n        return res.status(404).json({ error: \"Vulnerability not found\" });\n      }\n      res.json(vuln);\n    } catch (error) {\n      console.error(\"Error fetching vulnerability:\", error);\n      res.status(500).json({ error: \"Failed to fetch vulnerability\" });\n    }\n  });\n\n  app.patch(\"/api/vulnerabilities/:id\", async (req, res) => {\n    try {\n      await storage.updateVulnerabilityImport(req.params.id, req.body);\n      const updated = await storage.getVulnerabilityImport(req.params.id);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating vulnerability:\", error);\n      res.status(500).json({ error: \"Failed to update vulnerability\" });\n    }\n  });\n\n  // Create AEV evaluation from imported vulnerability\n  app.post(\"/api/vulnerabilities/:id/evaluate\", async (req, res) => {\n    try {\n      const vuln = await storage.getVulnerabilityImport(req.params.id);\n      if (!vuln) {\n        return res.status(404).json({ error: \"Vulnerability not found\" });\n      }\n\n      // Create evaluation from vulnerability\n      const evaluation = await storage.createEvaluation({\n        assetId: vuln.affectedHost || vuln.assetId || \"unknown\",\n        exposureType: vuln.cveId ? \"cve\" : \"misconfiguration\",\n        priority: vuln.severity === \"critical\" ? \"critical\" : \n                  vuln.severity === \"high\" ? \"high\" : \n                  vuln.severity === \"medium\" ? \"medium\" : \"low\",\n        description: `${vuln.title}${vuln.cveId ? ` (${vuln.cveId})` : \"\"}: ${vuln.description || \"No description\"}`,\n        status: \"pending\",\n      });\n\n      // Link vulnerability to evaluation\n      await storage.updateVulnerabilityImport(req.params.id, { aevEvaluationId: evaluation.id });\n\n      // Start evaluation in background\n      runEvaluation(evaluation.id, {\n        assetId: evaluation.assetId,\n        exposureType: evaluation.exposureType,\n        priority: evaluation.priority,\n        description: evaluation.description,\n      });\n\n      res.json({ evaluation, vulnerability: vuln });\n    } catch (error) {\n      console.error(\"Error creating evaluation from vulnerability:\", error);\n      res.status(500).json({ error: \"Failed to create evaluation\" });\n    }\n  });\n\n  // ========== IMPORT JOBS ==========\n\n  app.get(\"/api/imports\", async (req, res) => {\n    try {\n      const jobs = await storage.getImportJobs();\n      res.json(jobs);\n    } catch (error) {\n      console.error(\"Error fetching import jobs:\", error);\n      res.status(500).json({ error: \"Failed to fetch import jobs\" });\n    }\n  });\n\n  app.get(\"/api/imports/:id\", async (req, res) => {\n    try {\n      const job = await storage.getImportJob(req.params.id);\n      if (!job) {\n        return res.status(404).json({ error: \"Import job not found\" });\n      }\n      res.json(job);\n    } catch (error) {\n      console.error(\"Error fetching import job:\", error);\n      res.status(500).json({ error: \"Failed to fetch import job\" });\n    }\n  });\n\n  app.get(\"/api/imports/:id/vulnerabilities\", async (req, res) => {\n    try {\n      const vulns = await storage.getVulnerabilityImportsByJobId(req.params.id);\n      res.json(vulns);\n    } catch (error) {\n      console.error(\"Error fetching import vulnerabilities:\", error);\n      res.status(500).json({ error: \"Failed to fetch import vulnerabilities\" });\n    }\n  });\n\n  app.delete(\"/api/imports/:id\", async (req, res) => {\n    try {\n      await storage.deleteImportJob(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting import job:\", error);\n      res.status(500).json({ error: \"Failed to delete import job\" });\n    }\n  });\n\n  // Upload and parse scanner file\n  app.post(\"/api/imports/upload\", async (req, res) => {\n    try {\n      const { content, fileName, mimeType, name, sourceType } = req.body;\n      \n      if (!content) {\n        return res.status(400).json({ error: \"No file content provided\" });\n      }\n\n      // Import parsers dynamically to avoid issues\n      const { autoParseFile } = await import(\"./services/import-parsers\");\n\n      // Create import job\n      const job = await storage.createImportJob({\n        name: name || fileName || \"Scanner Import\",\n        sourceType: sourceType || \"custom_csv\",\n        fileName,\n        status: \"processing\",\n      });\n\n      // Parse file\n      const { result, detectedFormat } = autoParseFile(content, job.id, fileName, mimeType);\n\n      // Store assets\n      const createdAssets = await storage.createDiscoveredAssets(result.assets);\n      \n      // Link assets to vulnerabilities and store\n      const vulnsWithAssets = result.vulnerabilities.map(v => {\n        const matchingAsset = createdAssets.find(a => a.assetIdentifier === v.affectedHost);\n        return { ...v, assetId: matchingAsset?.id };\n      });\n      await storage.createVulnerabilityImports(vulnsWithAssets);\n\n      // Update job with results\n      await storage.updateImportJob(job.id, {\n        status: result.failedRecords > 0 && result.successfulRecords === 0 ? \"failed\" : \"completed\",\n        progress: 100,\n        totalRecords: result.totalRecords,\n        processedRecords: result.totalRecords,\n        successfulRecords: result.successfulRecords,\n        failedRecords: result.failedRecords,\n        assetsDiscovered: createdAssets.length,\n        vulnerabilitiesFound: result.vulnerabilities.length,\n        errors: result.errors.length > 0 ? result.errors : undefined,\n        completedAt: new Date(),\n        sourceType: detectedFormat,\n      });\n\n      const updatedJob = await storage.getImportJob(job.id);\n      res.json({\n        job: updatedJob,\n        summary: {\n          assetsDiscovered: createdAssets.length,\n          vulnerabilitiesFound: result.vulnerabilities.length,\n          errors: result.errors.length,\n          detectedFormat,\n        }\n      });\n    } catch (error) {\n      console.error(\"Error processing import:\", error);\n      res.status(500).json({ error: \"Failed to process import\" });\n    }\n  });\n\n  // ========== CLOUD CONNECTIONS ==========\n\n  app.get(\"/api/cloud-connections\", async (req, res) => {\n    try {\n      const connections = await storage.getCloudConnections();\n      res.json(connections);\n    } catch (error) {\n      console.error(\"Error fetching cloud connections:\", error);\n      res.status(500).json({ error: \"Failed to fetch cloud connections\" });\n    }\n  });\n\n  app.get(\"/api/cloud-connections/:id\", async (req, res) => {\n    try {\n      const connection = await storage.getCloudConnection(req.params.id);\n      if (!connection) {\n        return res.status(404).json({ error: \"Cloud connection not found\" });\n      }\n      res.json(connection);\n    } catch (error) {\n      console.error(\"Error fetching cloud connection:\", error);\n      res.status(500).json({ error: \"Failed to fetch cloud connection\" });\n    }\n  });\n\n  app.post(\"/api/cloud-connections\", async (req, res) => {\n    try {\n      const connection = await storage.createCloudConnection(req.body);\n      res.json(connection);\n    } catch (error) {\n      console.error(\"Error creating cloud connection:\", error);\n      res.status(500).json({ error: \"Failed to create cloud connection\" });\n    }\n  });\n\n  app.patch(\"/api/cloud-connections/:id\", async (req, res) => {\n    try {\n      await storage.updateCloudConnection(req.params.id, req.body);\n      const updated = await storage.getCloudConnection(req.params.id);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating cloud connection:\", error);\n      res.status(500).json({ error: \"Failed to update cloud connection\" });\n    }\n  });\n\n  app.delete(\"/api/cloud-connections/:id\", async (req, res) => {\n    try {\n      await storage.deleteCloudConnection(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting cloud connection:\", error);\n      res.status(500).json({ error: \"Failed to delete cloud connection\" });\n    }\n  });\n\n  // Test cloud connection\n  app.post(\"/api/cloud-connections/:id/test\", async (req, res) => {\n    try {\n      const connection = await storage.getCloudConnection(req.params.id);\n      if (!connection) {\n        return res.status(404).json({ error: \"Cloud connection not found\" });\n      }\n\n      // Simulate testing connection (in production, would use AWS/Azure/GCP SDKs)\n      await storage.updateCloudConnection(req.params.id, {\n        status: \"connected\",\n        lastSyncAt: new Date(),\n        lastSyncStatus: \"success\",\n      });\n\n      res.json({ success: true, message: \"Connection test successful\" });\n    } catch (error) {\n      console.error(\"Error testing cloud connection:\", error);\n      res.status(500).json({ error: \"Failed to test cloud connection\" });\n    }\n  });\n\n  // ========== AI VS AI SIMULATION API ==========\n\n  // Import the AI simulation runner\n  const { runAISimulation } = await import(\"./services/agents/ai-simulation\");\n\n  // Validation schema for simulation creation\n  const createSimulationSchema = z.object({\n    assetId: z.string().min(1, \"assetId is required\"),\n    exposureType: z.enum([\"cve\", \"misconfiguration\", \"network\", \"api\", \"iam_abuse\", \"data_exfiltration\", \"payment_flow\"]),\n    priority: z.enum([\"critical\", \"high\", \"medium\", \"low\"]).default(\"high\"),\n    description: z.string().min(1, \"description is required\"),\n    rounds: z.number().int().min(1).max(10).default(3),\n  });\n\n  // Start a new AI vs AI simulation\n  app.post(\"/api/simulations\", simulationRateLimiter, async (req, res) => {\n    try {\n      const parseResult = createSimulationSchema.safeParse(req.body);\n      if (!parseResult.success) {\n        return res.status(400).json({ error: parseResult.error.errors[0].message });\n      }\n      const { assetId, exposureType, priority, description, rounds } = parseResult.data;\n\n      // Create simulation record in database\n      const simulation = await storage.createAiSimulation({\n        organizationId: \"default\",\n        name: `AI vs AI Simulation: ${assetId}`,\n        description,\n        simulationStatus: \"running\",\n        startedAt: new Date(),\n      });\n      const simulationId = simulation.id;\n\n      // Run simulation asynchronously\n      runSimulation(simulationId, assetId, exposureType, priority || \"high\", description, rounds);\n\n      res.json({ \n        simulationId,\n        status: \"running\",\n        message: \"AI vs AI simulation started. Use WebSocket or GET /api/simulations/:id for progress updates.\",\n      });\n    } catch (error) {\n      console.error(\"Error starting simulation:\", error);\n      res.status(500).json({ error: \"Failed to start simulation\" });\n    }\n  });\n\n  // Get all simulations\n  app.get(\"/api/simulations\", async (req, res) => {\n    try {\n      const simulations = await storage.getAllAiSimulations();\n      res.json(simulations);\n    } catch (error) {\n      console.error(\"Error fetching simulations:\", error);\n      res.status(500).json({ error: \"Failed to fetch simulations\" });\n    }\n  });\n\n  // Get a specific simulation\n  app.get(\"/api/simulations/:id\", async (req, res) => {\n    try {\n      const simulation = await storage.getAiSimulation(req.params.id);\n      if (!simulation) {\n        return res.status(404).json({ error: \"Simulation not found\" });\n      }\n      res.json(simulation);\n    } catch (error) {\n      console.error(\"Error fetching simulation:\", error);\n      res.status(500).json({ error: \"Failed to fetch simulation\" });\n    }\n  });\n\n  // Delete a simulation\n  app.delete(\"/api/simulations/:id\", async (req, res) => {\n    try {\n      const simulation = await storage.getAiSimulation(req.params.id);\n      if (!simulation) {\n        return res.status(404).json({ error: \"Simulation not found\" });\n      }\n      await storage.deleteAiSimulation(req.params.id);\n      res.json({ success: true, message: \"Simulation deleted\" });\n    } catch (error) {\n      console.error(\"Error deleting simulation:\", error);\n      res.status(500).json({ error: \"Failed to delete simulation\" });\n    }\n  });\n\n  // Helper function to run simulation asynchronously\n  async function runSimulation(\n    simulationId: string,\n    assetId: string,\n    exposureType: string,\n    priority: string,\n    description: string,\n    rounds: number\n  ) {\n    try {\n      wsService.sendProgress(simulationId, \"AI Simulation\", \"starting\", 0, \"Starting AI vs AI simulation...\");\n\n      const result = await runAISimulation(\n        assetId,\n        exposureType,\n        priority,\n        description,\n        simulationId,\n        rounds,\n        (phase, round, progress, message) => {\n          wsService.sendProgress(simulationId, `AI Simulation (Round ${round})`, phase, progress, message);\n        }\n      );\n\n      // Update simulation with results\n      await storage.updateAiSimulation(simulationId, {\n        simulationStatus: \"completed\",\n        completedAt: new Date(),\n        simulationResults: {\n          attackerSuccesses: Math.round(result.finalAttackScore * 100),\n          defenderBlocks: Math.round(result.finalDefenseScore * 100),\n          timeToDetection: 0,\n          timeToContainment: 0,\n          attackPath: result.rounds.flatMap(r => \n            r.attackerFindings.attackPath.map(s => s.title)\n          ),\n          detectionPoints: result.rounds.flatMap(r => \n            r.defenderFindings.detectedAttacks.map(d => d.attackType)\n          ),\n          missedAttacks: result.rounds.flatMap(r => \n            r.defenderFindings.gapsIdentified\n          ),\n          recommendations: result.recommendations.map(r => r.description),\n        },\n      });\n\n      wsService.sendComplete(simulationId, true);\n    } catch (error) {\n      console.error(\"Simulation failed:\", error);\n      await storage.updateAiSimulation(simulationId, {\n        simulationStatus: \"failed\",\n        completedAt: new Date(),\n      });\n      wsService.sendComplete(simulationId, false, String(error));\n    }\n  }\n\n  // ========== ENDPOINT AGENT API ==========\n\n  // Generate API key for agent\n  function generateApiKey(): string {\n    return `odin-${randomUUID().replace(/-/g, \"\")}`;\n  }\n\n  // Hash API key for storage\n  async function hashApiKey(apiKey: string): Promise<string> {\n    return bcrypt.hash(apiKey, 10);\n  }\n\n  // Verify API key against hash\n  async function verifyApiKey(apiKey: string, hash: string): Promise<boolean> {\n    return bcrypt.compare(apiKey, hash);\n  }\n\n  // Agent authentication middleware - supports API key, mTLS, and JWT\n  async function authenticateAgent(req: any, res: any, next: any) {\n    const authHeader = req.headers.authorization;\n    const clientCertHeader = req.headers[\"x-client-cert-fingerprint\"] || req.headers[\"x-ssl-client-cert\"];\n    const certSecretHeader = req.headers[\"x-cert-secret\"];\n    \n    // Get all agents for API key comparison\n    const agents = await storage.getEndpointAgents();\n    \n    // Use unified auth service for multi-method authentication\n    const authResult = await unifiedAuthService.authenticateRequest(\n      authHeader,\n      clientCertHeader,\n      agents,\n      certSecretHeader\n    );\n    \n    if (!authResult.authenticated) {\n      return res.status(401).json({ error: authResult.error || \"Authentication failed\" });\n    }\n    \n    // Find the authenticated agent\n    let authenticatedAgent = null;\n    if (authResult.agentId) {\n      authenticatedAgent = agents.find(a => a.id === authResult.agentId);\n    }\n    \n    if (!authenticatedAgent) {\n      return res.status(401).json({ error: \"Agent not found\" });\n    }\n    \n    req.agent = authenticatedAgent;\n    next();\n  }\n\n  // Register a new agent\n  app.post(\"/api/agents/register\", authRateLimiter, async (req, res) => {\n    try {\n      const parsed = agentRegisterSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid request body\", details: parsed.error.errors });\n      }\n\n      const { agentName, hostname, platform, platformVersion, architecture, capabilities, environment, tags } = parsed.data;\n\n      const apiKey = generateApiKey();\n      const apiKeyHash = await hashApiKey(apiKey);\n      \n      const agent = await storage.createEndpointAgent({\n        agentName,\n        apiKey: \"\", // Don't store plaintext key\n        apiKeyHash, // Store the hash\n        hostname,\n        platform,\n        platformVersion,\n        architecture,\n        capabilities: capabilities || [],\n        environment,\n        tags: tags || [],\n        organizationId: \"default\",\n        status: \"online\",\n      });\n\n      res.json({\n        id: agent.id,\n        apiKey, // Return plaintext key only once at registration\n        agentName: agent.agentName,\n        message: \"Agent registered successfully. Store the API key securely - it cannot be retrieved again.\",\n      });\n    } catch (error) {\n      console.error(\"Error registering agent:\", error);\n      res.status(500).json({ error: \"Failed to register agent\" });\n    }\n  });\n\n  // Agent heartbeat\n  app.post(\"/api/agents/heartbeat\", authenticateAgent, async (req: any, res) => {\n    try {\n      await storage.updateAgentHeartbeat(req.agent.id);\n      res.json({ success: true, timestamp: new Date().toISOString() });\n    } catch (error) {\n      console.error(\"Error processing heartbeat:\", error);\n      res.status(500).json({ error: \"Failed to process heartbeat\" });\n    }\n  });\n\n  // Agent telemetry ingestion\n  app.post(\"/api/agents/telemetry\", agentTelemetryRateLimiter, authenticateAgent, async (req: any, res) => {\n    try {\n      const parsed = agentTelemetrySchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid telemetry data\", details: parsed.error.errors });\n      }\n\n      const { systemInfo, resourceMetrics, services, openPorts, networkConnections, installedSoftware, configData, securityFindings, collectedAt } = parsed.data;\n\n      const telemetry = await storage.createAgentTelemetry({\n        agentId: req.agent.id,\n        organizationId: req.agent.organizationId,\n        systemInfo,\n        resourceMetrics,\n        services,\n        openPorts,\n        networkConnections,\n        installedSoftware,\n        configData,\n        securityFindings,\n        collectedAt: collectedAt ? new Date(collectedAt) : new Date(),\n      });\n\n      // Process security findings with deduplication\n      const createdFindings: string[] = [];\n      const triggeredEvaluations: string[] = [];\n      \n      if (securityFindings && Array.isArray(securityFindings)) {\n        // Get existing findings for this agent to deduplicate\n        const existingFindings = await storage.getAgentFindings(req.agent.id);\n        const existingFindingKeys = new Set(\n          existingFindings\n            .filter(f => f.status !== \"resolved\")\n            .map(f => `${f.findingType}|${f.title}|${f.affectedComponent || \"\"}`)\n        );\n\n        for (const finding of securityFindings) {\n          const findingKey = `${finding.type || \"unknown\"}|${finding.title}|${finding.affectedComponent || \"\"}`;\n          \n          // Skip if this finding already exists and is not resolved\n          if (existingFindingKeys.has(findingKey)) {\n            continue;\n          }\n\n          const agentFinding = await storage.createAgentFinding({\n            agentId: req.agent.id,\n            organizationId: req.agent.organizationId,\n            telemetryId: telemetry.id,\n            findingType: finding.type || \"unknown\",\n            severity: finding.severity || \"medium\",\n            title: finding.title,\n            description: finding.description,\n            affectedComponent: finding.affectedComponent,\n            recommendation: finding.recommendation,\n            detectedAt: new Date(),\n          });\n          createdFindings.push(agentFinding.id);\n          \n          // Add to set to prevent duplicates within same batch\n          existingFindingKeys.add(findingKey);\n\n          // Auto-trigger evaluation for critical/high severity findings\n          if (finding.severity === \"critical\" || finding.severity === \"high\") {\n            const evaluation = await storage.createEvaluation({\n              assetId: `${req.agent.hostname || req.agent.agentName}-${finding.affectedComponent || \"unknown\"}`,\n              exposureType: finding.type || \"misconfiguration\",\n              priority: finding.severity,\n              description: `Auto-triggered from agent finding:\\n\\nAgent: ${req.agent.agentName}\\nHost: ${req.agent.hostname || \"Unknown\"}\\n\\n${finding.title}\\n\\n${finding.description}`,\n              organizationId: req.agent.organizationId,\n            });\n\n            await storage.updateAgentFinding(agentFinding.id, {\n              aevEvaluationId: evaluation.id,\n              autoEvaluationTriggered: true,\n            });\n            \n            triggeredEvaluations.push(evaluation.id);\n\n            // Run evaluation async\n            runEvaluation(evaluation.id, {\n              assetId: evaluation.assetId,\n              exposureType: evaluation.exposureType,\n              priority: evaluation.priority,\n              description: evaluation.description,\n            });\n          }\n        }\n      }\n\n      res.json({ \n        success: true, \n        telemetryId: telemetry.id,\n        findingsCreated: createdFindings.length,\n        findingIds: createdFindings,\n        evaluationsTriggered: triggeredEvaluations.length,\n      });\n    } catch (error) {\n      console.error(\"Error ingesting telemetry:\", error);\n      res.status(500).json({ error: \"Failed to ingest telemetry\" });\n    }\n  });\n\n  // Go Agent batched events endpoint\n  // Accepts batched events from the Go agent collector\n  app.post(\"/api/agents/events\", agentTelemetryRateLimiter, authenticateAgent, async (req: any, res) => {\n    try {\n      const { events } = req.body;\n      // Note: tenant_id is ignored - we use req.agent.organizationId from authentication\n      \n      if (!Array.isArray(events)) {\n        return res.status(400).json({ error: \"Events must be an array\" });\n      }\n\n      if (events.length === 0) {\n        return res.json({ success: true, eventsProcessed: 0 });\n      }\n\n      let processedCount = 0;\n      let skippedCount = 0;\n      const validationErrors: string[] = [];\n      const createdFindings: string[] = [];\n      const triggeredEvaluations: string[] = [];\n      const telemetryIds: string[] = [];\n\n      // Get existing findings for deduplication (include severity for better deduplication)\n      const existingFindings = await storage.getAgentFindings(req.agent.id);\n      const existingFindingKeys = new Set(\n        existingFindings\n          .filter(f => f.status !== \"resolved\")\n          .map(f => `${f.findingType}|${f.severity}|${f.title}|${f.affectedComponent || \"\"}`)\n      );\n\n      for (let i = 0; i < events.length; i++) {\n        const rawEvent = events[i];\n        \n        // Parse event if it's a JSON string (Go agent may send stringified events)\n        let event: any;\n        if (typeof rawEvent === \"string\") {\n          try {\n            event = JSON.parse(rawEvent);\n          } catch {\n            validationErrors.push(`Event ${i}: invalid JSON string`);\n            skippedCount++;\n            continue;\n          }\n        } else {\n          event = rawEvent;\n        }\n        \n        // Validate event is an object\n        if (!event || typeof event !== \"object\") {\n          validationErrors.push(`Event ${i}: must be an object`);\n          skippedCount++;\n          continue;\n        }\n\n        // Validate with schema (strict validation - reject invalid events)\n        const parsed = agentTelemetrySchema.safeParse(event);\n        if (!parsed.success) {\n          validationErrors.push(`Event ${i}: ${parsed.error.errors.map(e => e.message).join(\", \")}`);\n          skippedCount++;\n          continue;\n        }\n\n        // Use validated data\n        const validatedEvent = parsed.data;\n        processedCount++;\n        \n        // Always create telemetry record to ensure findings have linkage\n        const telemetry = await storage.createAgentTelemetry({\n          agentId: req.agent.id,\n          organizationId: req.agent.organizationId,\n          systemInfo: validatedEvent.systemInfo || null,\n          resourceMetrics: validatedEvent.resourceMetrics || null,\n          services: validatedEvent.services || null,\n          openPorts: validatedEvent.openPorts || null,\n          networkConnections: validatedEvent.networkConnections || null,\n          installedSoftware: validatedEvent.installedSoftware || null,\n          configData: validatedEvent.configData || null,\n          securityFindings: validatedEvent.securityFindings || null,\n          collectedAt: validatedEvent.collectedAt ? new Date(validatedEvent.collectedAt) : new Date(),\n        });\n        const telemetryId = telemetry.id;\n        telemetryIds.push(telemetry.id);\n\n        // Process security findings with deduplication\n        if (validatedEvent.securityFindings && Array.isArray(validatedEvent.securityFindings)) {\n          for (const finding of validatedEvent.securityFindings) {\n            // Skip findings without required title\n            if (!finding.title) continue;\n            \n            const severity = finding.severity || \"medium\";\n            const findingType = finding.type || \"unknown\";\n            const findingKey = `${findingType}|${severity}|${finding.title}|${finding.affectedComponent || \"\"}`;\n            \n            if (existingFindingKeys.has(findingKey)) {\n              continue;\n            }\n\n            const agentFinding = await storage.createAgentFinding({\n              agentId: req.agent.id,\n              organizationId: req.agent.organizationId,\n              telemetryId: telemetryId,\n              findingType: findingType,\n              severity: severity,\n              title: finding.title,\n              description: finding.description || \"\",\n              affectedComponent: finding.affectedComponent || null,\n              recommendation: finding.recommendation || null,\n              detectedAt: new Date(),\n            });\n            createdFindings.push(agentFinding.id);\n            existingFindingKeys.add(findingKey);\n\n            // Auto-trigger evaluation for critical/high severity\n            if (severity === \"critical\" || severity === \"high\") {\n              const evaluation = await storage.createEvaluation({\n                assetId: `${req.agent.hostname || req.agent.agentName}-${finding.affectedComponent || \"unknown\"}`,\n                exposureType: findingType,\n                priority: severity,\n                description: `Auto-triggered from agent finding:\\n\\nAgent: ${req.agent.agentName}\\nHost: ${req.agent.hostname || \"Unknown\"}\\n\\n${finding.title}\\n\\n${finding.description || \"\"}`,\n                organizationId: req.agent.organizationId,\n              });\n\n              await storage.updateAgentFinding(agentFinding.id, {\n                aevEvaluationId: evaluation.id,\n                autoEvaluationTriggered: true,\n              });\n              \n              triggeredEvaluations.push(evaluation.id);\n\n              runEvaluation(evaluation.id, {\n                assetId: evaluation.assetId,\n                exposureType: evaluation.exposureType,\n                priority: evaluation.priority,\n                description: evaluation.description,\n              });\n            }\n          }\n        }\n      }\n\n      // Return failure if no events were processed successfully\n      if (processedCount === 0 && skippedCount > 0) {\n        return res.status(400).json({ \n          success: false, \n          error: \"All events in batch were invalid\",\n          eventsSkipped: skippedCount,\n          validationErrors: validationErrors.slice(0, 10),\n        });\n      }\n\n      res.json({ \n        success: processedCount > 0, \n        eventsProcessed: processedCount,\n        eventsSkipped: skippedCount,\n        telemetryRecords: telemetryIds.length,\n        findingsCreated: createdFindings.length,\n        evaluationsTriggered: triggeredEvaluations.length,\n        ...(validationErrors.length > 0 && { validationWarnings: validationErrors.slice(0, 5) }),\n      });\n    } catch (error) {\n      console.error(\"Error processing agent events:\", error);\n      res.status(500).json({ error: \"Failed to process events\" });\n    }\n  });\n\n  // Get all agents (for dashboard)\n  app.get(\"/api/agents\", async (req, res) => {\n    try {\n      const agents = await storage.getEndpointAgents();\n      // Don't expose API keys in list view\n      const safeAgents = agents.map(({ apiKey, apiKeyHash, ...agent }) => agent);\n      res.json(safeAgents);\n    } catch (error) {\n      console.error(\"Error fetching agents:\", error);\n      res.status(500).json({ error: \"Failed to fetch agents\" });\n    }\n  });\n\n  // Agent stats for dashboard (must be before :id route)\n  app.get(\"/api/agents/stats/summary\", async (req, res) => {\n    try {\n      const stats = await storage.getAgentStats();\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching agent stats:\", error);\n      res.status(500).json({ error: \"Failed to fetch agent stats\" });\n    }\n  });\n\n  // Get agent by ID\n  app.get(\"/api/agents/:id\", async (req, res) => {\n    try {\n      const agent = await storage.getEndpointAgent(req.params.id);\n      if (!agent) {\n        return res.status(404).json({ error: \"Agent not found\" });\n      }\n      // Don't expose API key\n      const { apiKey, apiKeyHash, ...safeAgent } = agent;\n      res.json(safeAgent);\n    } catch (error) {\n      console.error(\"Error fetching agent:\", error);\n      res.status(500).json({ error: \"Failed to fetch agent\" });\n    }\n  });\n\n  // Get agent telemetry\n  app.get(\"/api/agents/:id/telemetry\", async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 100;\n      const telemetry = await storage.getAgentTelemetry(req.params.id, limit);\n      res.json(telemetry);\n    } catch (error) {\n      console.error(\"Error fetching agent telemetry:\", error);\n      res.status(500).json({ error: \"Failed to fetch agent telemetry\" });\n    }\n  });\n\n  // Get agent findings\n  app.get(\"/api/agents/:id/findings\", async (req, res) => {\n    try {\n      const findings = await storage.getAgentFindings(req.params.id);\n      res.json(findings);\n    } catch (error) {\n      console.error(\"Error fetching agent findings:\", error);\n      res.status(500).json({ error: \"Failed to fetch agent findings\" });\n    }\n  });\n\n  // Delete agent\n  app.delete(\"/api/agents/:id\", async (req, res) => {\n    try {\n      await storage.deleteEndpointAgent(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting agent:\", error);\n      res.status(500).json({ error: \"Failed to delete agent\" });\n    }\n  });\n\n  // Get all agent findings\n  app.get(\"/api/agent-findings\", async (req, res) => {\n    try {\n      const findings = await storage.getAgentFindings();\n      res.json(findings);\n    } catch (error) {\n      console.error(\"Error fetching agent findings:\", error);\n      res.status(500).json({ error: \"Failed to fetch agent findings\" });\n    }\n  });\n\n  // Update agent finding status\n  app.patch(\"/api/agent-findings/:id\", async (req, res) => {\n    try {\n      await storage.updateAgentFinding(req.params.id, req.body);\n      const finding = await storage.getAgentFinding(req.params.id);\n      res.json(finding);\n    } catch (error) {\n      console.error(\"Error updating agent finding:\", error);\n      res.status(500).json({ error: \"Failed to update agent finding\" });\n    }\n  });\n\n  // ============================================================================\n  // mTLS Certificate Management Endpoints\n  // Note: These endpoints require authenticated session (admin access)\n  // ============================================================================\n\n  // Middleware to check admin authentication for credential management\n  const requireAdminAuth = (req: any, res: any, next: any) => {\n    // Check for authenticated session (Replit Auth)\n    if (req.isAuthenticated && req.isAuthenticated()) {\n      return next();\n    }\n    // Check for admin API key header\n    const adminKey = req.headers[\"x-admin-key\"];\n    const expectedAdminKey = process.env.ADMIN_API_KEY;\n    if (expectedAdminKey && adminKey === expectedAdminKey) {\n      return next();\n    }\n    // In development mode without session, allow access with warning\n    if (process.env.NODE_ENV === \"development\" && !expectedAdminKey) {\n      console.warn(\"WARNING: Credential management endpoint accessed without authentication (development mode)\");\n      return next();\n    }\n    return res.status(401).json({ error: \"Admin authentication required for credential management\" });\n  };\n\n  // Request a new certificate for an agent\n  app.post(\"/api/agents/:id/certificates\", requireAdminAuth, async (req, res) => {\n    try {\n      const agent = await storage.getEndpointAgent(req.params.id);\n      if (!agent) {\n        return res.status(404).json({ error: \"Agent not found\" });\n      }\n\n      const commonName = req.body.commonName || agent.agentName;\n      const validityDays = req.body.validityDays || 365;\n\n      const certificate = await mtlsAuthService.generateCertificate({\n        agentId: agent.id,\n        organizationId: agent.organizationId,\n        commonName,\n        validityDays,\n      });\n\n      console.log(`[AUDIT] Certificate generated for agent ${agent.id} by admin`);\n\n      res.json({\n        certificateId: certificate.certificateId,\n        fingerprint: certificate.fingerprint,\n        certificate: certificate.certificate,\n        privateKey: certificate.privateKey,\n        validFrom: certificate.validFrom,\n        validTo: certificate.validTo,\n        message: \"Certificate generated. Store the private key securely - it cannot be retrieved again.\",\n      });\n    } catch (error) {\n      console.error(\"Error generating certificate:\", error);\n      res.status(500).json({ error: \"Failed to generate certificate\" });\n    }\n  });\n\n  // List certificates for an agent\n  app.get(\"/api/agents/:id/certificates\", async (req, res) => {\n    try {\n      const agent = await storage.getEndpointAgent(req.params.id);\n      if (!agent) {\n        return res.status(404).json({ error: \"Agent not found\" });\n      }\n\n      const certificates = await mtlsAuthService.getAgentCertificates(agent.id);\n      res.json(certificates.map(cert => ({\n        id: cert.id,\n        fingerprint: cert.fingerprint,\n        subject: cert.subject,\n        issuer: cert.issuer,\n        validFrom: cert.validFrom,\n        validTo: cert.validTo,\n        status: cert.status,\n        createdAt: cert.createdAt,\n      })));\n    } catch (error) {\n      console.error(\"Error fetching certificates:\", error);\n      res.status(500).json({ error: \"Failed to fetch certificates\" });\n    }\n  });\n\n  // Renew a certificate\n  app.post(\"/api/agents/:id/certificates/:certId/renew\", requireAdminAuth, async (req, res) => {\n    try {\n      const agent = await storage.getEndpointAgent(req.params.id);\n      if (!agent) {\n        return res.status(404).json({ error: \"Agent not found\" });\n      }\n\n      const newCert = await mtlsAuthService.renewCertificate(req.params.certId);\n      if (!newCert) {\n        return res.status(400).json({ error: \"Unable to renew certificate\" });\n      }\n\n      console.log(`[AUDIT] Certificate ${req.params.certId} renewed for agent ${agent.id} by admin`);\n\n      res.json({\n        certificateId: newCert.certificateId,\n        fingerprint: newCert.fingerprint,\n        certificate: newCert.certificate,\n        privateKey: newCert.privateKey,\n        validFrom: newCert.validFrom,\n        validTo: newCert.validTo,\n        message: \"Certificate renewed. Store the new private key securely.\",\n      });\n    } catch (error) {\n      console.error(\"Error renewing certificate:\", error);\n      res.status(500).json({ error: \"Failed to renew certificate\" });\n    }\n  });\n\n  // Revoke a certificate\n  app.delete(\"/api/agents/:id/certificates/:certId\", requireAdminAuth, async (req, res) => {\n    try {\n      const reason = req.body.reason || \"Manually revoked\";\n      const success = await mtlsAuthService.revokeCertificate(req.params.certId, reason);\n      \n      if (!success) {\n        return res.status(404).json({ error: \"Certificate not found\" });\n      }\n\n      console.log(`[AUDIT] Certificate ${req.params.certId} revoked by admin: ${reason}`);\n\n      res.json({ success: true, message: \"Certificate revoked\" });\n    } catch (error) {\n      console.error(\"Error revoking certificate:\", error);\n      res.status(500).json({ error: \"Failed to revoke certificate\" });\n    }\n  });\n\n  // ============================================================================\n  // JWT Token Management Endpoints\n  // Note: Token generation requires admin auth, refresh is self-service\n  // ============================================================================\n\n  // Generate JWT tokens for an agent\n  app.post(\"/api/agents/:id/tokens\", requireAdminAuth, async (req, res) => {\n    try {\n      const agent = await storage.getEndpointAgent(req.params.id);\n      if (!agent) {\n        return res.status(404).json({ error: \"Agent not found\" });\n      }\n\n      const scopes = req.body.scopes || [\"read\", \"write\"];\n      const tokenPair = await jwtAuthService.generateTokenPair({\n        organizationId: agent.organizationId,\n        agentId: agent.id,\n        scopes,\n        subject: agent.agentName,\n      });\n\n      console.log(`[AUDIT] JWT tokens generated for agent ${agent.id} by admin`);\n\n      res.json({\n        accessToken: tokenPair.accessToken,\n        refreshToken: tokenPair.refreshToken,\n        accessTokenExpiresAt: tokenPair.accessTokenExpiresAt,\n        refreshTokenExpiresAt: tokenPair.refreshTokenExpiresAt,\n        message: \"Tokens generated. Store the refresh token securely.\",\n      });\n    } catch (error) {\n      console.error(\"Error generating tokens:\", error);\n      res.status(500).json({ error: \"Failed to generate tokens\" });\n    }\n  });\n\n  // Refresh JWT tokens\n  app.post(\"/api/auth/refresh\", async (req, res) => {\n    try {\n      const { refreshToken } = req.body;\n      if (!refreshToken) {\n        return res.status(400).json({ error: \"Refresh token required\" });\n      }\n\n      const newTokens = await jwtAuthService.refreshAccessToken(refreshToken);\n      if (!newTokens) {\n        return res.status(401).json({ error: \"Invalid or expired refresh token\" });\n      }\n\n      res.json({\n        accessToken: newTokens.accessToken,\n        refreshToken: newTokens.refreshToken,\n        accessTokenExpiresAt: newTokens.accessTokenExpiresAt,\n        refreshTokenExpiresAt: newTokens.refreshTokenExpiresAt,\n      });\n    } catch (error) {\n      console.error(\"Error refreshing tokens:\", error);\n      res.status(500).json({ error: \"Failed to refresh tokens\" });\n    }\n  });\n\n  // Revoke all credentials for an agent\n  app.post(\"/api/agents/:id/revoke-all\", requireAdminAuth, async (req, res) => {\n    try {\n      const agent = await storage.getEndpointAgent(req.params.id);\n      if (!agent) {\n        return res.status(404).json({ error: \"Agent not found\" });\n      }\n\n      const result = await unifiedAuthService.revokeAgentCredentials(agent.id);\n      console.log(`[AUDIT] All credentials revoked for agent ${agent.id} by admin: ${result.revokedCerts} certs, ${result.revokedTokens} tokens`);\n      \n      res.json({\n        success: true,\n        revokedCertificates: result.revokedCerts,\n        revokedTokens: result.revokedTokens,\n        message: \"All agent credentials revoked\",\n      });\n    } catch (error) {\n      console.error(\"Error revoking credentials:\", error);\n      res.status(500).json({ error: \"Failed to revoke credentials\" });\n    }\n  });\n\n  // Get agent authentication status\n  app.get(\"/api/agents/:id/auth-status\", async (req, res) => {\n    try {\n      const agent = await storage.getEndpointAgent(req.params.id);\n      if (!agent) {\n        return res.status(404).json({ error: \"Agent not found\" });\n      }\n\n      const status = await unifiedAuthService.getAgentAuthStatus(agent.id);\n      res.json({\n        agentId: agent.id,\n        agentName: agent.agentName,\n        hasApiKey: !!agent.apiKeyHash || !!agent.apiKey,\n        ...status,\n      });\n    } catch (error) {\n      console.error(\"Error fetching auth status:\", error);\n      res.status(500).json({ error: \"Failed to fetch auth status\" });\n    }\n  });\n\n  // ============================================================================\n  // Tenant Management Endpoints\n  // Note: These endpoints require admin authentication\n  // ============================================================================\n\n  // Create a new tenant\n  app.post(\"/api/tenants\", requireAdminAuth, async (req, res) => {\n    try {\n      const { name, organizationId, allowedScopes, accessTokenTTL, refreshTokenTTL } = req.body;\n      if (!name) {\n        return res.status(400).json({ error: \"Tenant name required\" });\n      }\n\n      const tenant = await jwtAuthService.createTenant({\n        organizationId: organizationId || \"default\",\n        name,\n        allowedScopes,\n        accessTokenTTL,\n        refreshTokenTTL,\n      });\n\n      console.log(`[AUDIT] Tenant ${tenant.id} created by admin: ${name}`);\n\n      res.json({\n        id: tenant.id,\n        name: tenant.name,\n        organizationId: tenant.organizationId,\n        secretKey: tenant.secretKey,\n        allowedScopes: tenant.allowedScopes,\n        accessTokenTTL: tenant.accessTokenTTL,\n        refreshTokenTTL: tenant.refreshTokenTTL,\n        createdAt: tenant.createdAt,\n        message: \"Tenant created. Store the secret key securely - it cannot be retrieved again.\",\n      });\n    } catch (error) {\n      console.error(\"Error creating tenant:\", error);\n      res.status(500).json({ error: \"Failed to create tenant\" });\n    }\n  });\n\n  // List tenants\n  app.get(\"/api/tenants\", async (req, res) => {\n    try {\n      const organizationId = req.query.organizationId as string | undefined;\n      const tenants = await jwtAuthService.listTenants(organizationId);\n      res.json(tenants);\n    } catch (error) {\n      console.error(\"Error fetching tenants:\", error);\n      res.status(500).json({ error: \"Failed to fetch tenants\" });\n    }\n  });\n\n  // Get tenant by ID\n  app.get(\"/api/tenants/:id\", async (req, res) => {\n    try {\n      const tenant = await jwtAuthService.getTenant(req.params.id);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n      \n      res.json({\n        id: tenant.id,\n        name: tenant.name,\n        organizationId: tenant.organizationId,\n        allowedScopes: tenant.allowedScopes,\n        accessTokenTTL: tenant.accessTokenTTL,\n        refreshTokenTTL: tenant.refreshTokenTTL,\n        active: tenant.active,\n        createdAt: tenant.createdAt,\n        updatedAt: tenant.updatedAt,\n      });\n    } catch (error) {\n      console.error(\"Error fetching tenant:\", error);\n      res.status(500).json({ error: \"Failed to fetch tenant\" });\n    }\n  });\n\n  // Deactivate tenant\n  app.delete(\"/api/tenants/:id\", requireAdminAuth, async (req, res) => {\n    try {\n      const success = await jwtAuthService.deactivateTenant(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n      \n      console.log(`[AUDIT] Tenant ${req.params.id} deactivated by admin`);\n      \n      res.json({ success: true, message: \"Tenant deactivated\" });\n    } catch (error) {\n      console.error(\"Error deactivating tenant:\", error);\n      res.status(500).json({ error: \"Failed to deactivate tenant\" });\n    }\n  });\n\n  // ============================================================================\n  // Auth Configuration Endpoint\n  // Note: Config changes require admin authentication\n  // ============================================================================\n\n  // Get authentication configuration (read-only, no auth required)\n  app.get(\"/api/auth/config\", async (req, res) => {\n    try {\n      const config = unifiedAuthService.getConfig();\n      res.json(config);\n    } catch (error) {\n      console.error(\"Error fetching auth config:\", error);\n      res.status(500).json({ error: \"Failed to fetch auth config\" });\n    }\n  });\n\n  // Update authentication configuration (admin only)\n  app.patch(\"/api/auth/config\", requireAdminAuth, async (req, res) => {\n    try {\n      const updates = req.body;\n      unifiedAuthService.configure(updates);\n      console.log(`[AUDIT] Auth config updated by admin:`, updates);\n      const config = unifiedAuthService.getConfig();\n      res.json(config);\n    } catch (error) {\n      console.error(\"Error updating auth config:\", error);\n      res.status(500).json({ error: \"Failed to update auth config\" });\n    }\n  });\n\n  // ============================================================================\n  // ORGANIZATION SETTINGS ENDPOINTS\n  // ============================================================================\n\n  // In-memory organization settings (extends governance table data)\n  const organizationSettings = {\n    organizationName: \"OdinForge Security\",\n    organizationDescription: \"Advanced adversarial exposure validation platform\",\n    contactEmail: \"security@odinforge.ai\",\n    contactPhone: \"\",\n    sessionTimeoutMinutes: 30,\n    mfaRequired: false,\n    mfaGracePeriodDays: 7,\n    passwordMinLength: 12,\n    passwordRequireUppercase: true,\n    passwordRequireLowercase: true,\n    passwordRequireNumbers: true,\n    passwordRequireSpecial: true,\n    passwordExpiryDays: 90,\n    emailNotificationsEnabled: true,\n    emailCriticalAlerts: true,\n    emailHighAlerts: true,\n    emailMediumAlerts: false,\n    emailLowAlerts: false,\n    emailDailyDigest: true,\n    alertThresholdCritical: 90,\n    alertThresholdHigh: 70,\n    alertThresholdMedium: 40,\n    apiRateLimitPerMinute: 60,\n    apiRateLimitPerHour: 1000,\n    apiRateLimitPerDay: 10000,\n    apiLoggingEnabled: true,\n    webhooksEnabled: false,\n    webhookUrl: \"\",\n  };\n\n  // Get organization settings\n  app.get(\"/api/organization/settings\", requireAdminAuth, async (req, res) => {\n    try {\n      res.json(organizationSettings);\n    } catch (error) {\n      console.error(\"Error fetching organization settings:\", error);\n      res.status(500).json({ error: \"Failed to fetch organization settings\" });\n    }\n  });\n\n  // Update organization settings\n  app.patch(\"/api/organization/settings\", requireAdminAuth, async (req, res) => {\n    try {\n      const updates = req.body;\n      Object.keys(updates).forEach(key => {\n        if (key in organizationSettings) {\n          (organizationSettings as any)[key] = updates[key];\n        }\n      });\n      console.log(`[AUDIT] Organization settings updated:`, Object.keys(updates));\n      res.json(organizationSettings);\n    } catch (error) {\n      console.error(\"Error updating organization settings:\", error);\n      res.status(500).json({ error: \"Failed to update organization settings\" });\n    }\n  });\n\n  // ============================================================================\n  // USER MANAGEMENT ENDPOINTS\n  // Note: Requires admin authentication for all operations\n  // ============================================================================\n\n  // Get all users\n  app.get(\"/api/users\", requireAdminAuth, async (req, res) => {\n    try {\n      const organizationId = req.query.organizationId as string | undefined;\n      const users = await storage.getAllUsers(organizationId);\n      res.json(users.map(u => ({ ...u, password: undefined })));\n    } catch (error) {\n      console.error(\"Error fetching users:\", error);\n      res.status(500).json({ error: \"Failed to fetch users\" });\n    }\n  });\n\n  // Create a new user\n  app.post(\"/api/users\", requireAdminAuth, async (req, res) => {\n    try {\n      const { username, password, role, displayName, email } = req.body;\n      \n      if (!username || !password) {\n        return res.status(400).json({ error: \"Username and password are required\" });\n      }\n\n      const existingUser = await storage.getUserByUsername(username);\n      if (existingUser) {\n        return res.status(409).json({ error: \"Username already exists\" });\n      }\n\n      const hashedPassword = await bcrypt.hash(password, 10);\n      const user = await storage.createUser({\n        username,\n        password: hashedPassword,\n        role: role || \"security_analyst\",\n        displayName,\n        email,\n      });\n\n      console.log(`[AUDIT] User ${user.id} (${username}) created by admin`);\n      res.json({ ...user, password: undefined });\n    } catch (error) {\n      console.error(\"Error creating user:\", error);\n      res.status(500).json({ error: \"Failed to create user\" });\n    }\n  });\n\n  // Update a user\n  app.patch(\"/api/users/:id\", requireAdminAuth, async (req, res) => {\n    try {\n      const { role, displayName, email, password } = req.body;\n      const user = await storage.getUser(req.params.id);\n      \n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      const updates: any = {};\n      if (role !== undefined) updates.role = role;\n      if (displayName !== undefined) updates.displayName = displayName;\n      if (email !== undefined) updates.email = email;\n      if (password) updates.password = await bcrypt.hash(password, 10);\n\n      await storage.updateUser(req.params.id, updates);\n      const updatedUser = await storage.getUser(req.params.id);\n      \n      console.log(`[AUDIT] User ${req.params.id} updated by admin`);\n      res.json({ ...updatedUser, password: undefined });\n    } catch (error) {\n      console.error(\"Error updating user:\", error);\n      res.status(500).json({ error: \"Failed to update user\" });\n    }\n  });\n\n  // Delete a user\n  app.delete(\"/api/users/:id\", requireAdminAuth, async (req, res) => {\n    try {\n      const user = await storage.getUser(req.params.id);\n      \n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      await storage.deleteUser(req.params.id);\n      \n      console.log(`[AUDIT] User ${req.params.id} (${user.username}) deleted by admin`);\n      res.json({ success: true, message: \"User deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting user:\", error);\n      res.status(500).json({ error: \"Failed to delete user\" });\n    }\n  });\n\n  return httpServer;\n}\n\nasync function runEvaluation(evaluationId: string, data: {\n  assetId: string;\n  exposureType: string;\n  priority: string;\n  description: string;\n  adversaryProfile?: string;\n  organizationId?: string;\n}) {\n  const startTime = Date.now();\n  const orgId = data.organizationId || \"default\";\n  \n  try {\n    // Check governance execution mode\n    const governance = await storage.getOrganizationGovernance(orgId);\n    const executionMode = governance?.executionMode || \"safe\";\n    \n    // Check kill switch\n    if (governance?.killSwitchActive) {\n      console.log(`[GOVERNANCE] Evaluation ${evaluationId} blocked - kill switch active`);\n      await storage.updateEvaluationStatus(evaluationId, \"failed\");\n      wsService.sendComplete(evaluationId, false, \"Kill switch is active - all evaluations are blocked\");\n      return;\n    }\n    \n    await storage.updateEvaluationStatus(evaluationId, \"in_progress\", executionMode);\n\n    // If in simulation mode, run AI vs AI simulation instead\n    if (executionMode === \"simulation\") {\n      console.log(`[GOVERNANCE] Running AI vs AI simulation for evaluation ${evaluationId}`);\n      \n      const simulationResult = await runAISimulation(\n        data.assetId,\n        data.exposureType,\n        data.priority,\n        data.description,\n        evaluationId,\n        3, // 3 rounds by default\n        (phase, round, progress, message) => {\n          wsService.sendProgress(evaluationId, `Simulation ${phase}`, `round-${round}`, progress, message);\n        }\n      );\n\n      const duration = Date.now() - startTime;\n\n      // Store as AI simulation result\n      await storage.createAiSimulation({\n        id: `sim-${randomUUID().slice(0, 8)}`,\n        evaluationId,\n        assetId: data.assetId,\n        exposureType: data.exposureType,\n        status: \"completed\",\n        rounds: simulationResult.rounds.length,\n        attackerScore: simulationResult.finalAttackScore,\n        defenderScore: simulationResult.finalDefenseScore,\n        attackerResults: simulationResult.rounds.map(r => r.attackerFindings),\n        defenderResults: simulationResult.rounds.map(r => r.defenderFindings),\n        purpleTeamFindings: [simulationResult.purpleTeamFeedback],\n        recommendations: simulationResult.recommendations,\n        duration,\n      });\n\n      // Also create a standard result with simulation summary for UI compatibility\n      const attackerScore = simulationResult.finalAttackScore;\n      const defenderScore = simulationResult.finalDefenseScore;\n      const recsAsStrings = simulationResult.recommendations.map(r => r.title);\n      \n      await storage.createResult({\n        id: `res-${randomUUID().slice(0, 8)}`,\n        evaluationId,\n        exploitable: attackerScore > 50,\n        confidence: Math.round((attackerScore + defenderScore) / 2),\n        score: attackerScore,\n        attackPath: simulationResult.rounds[0]?.attackerFindings?.attackPath || [],\n        attackGraph: simulationResult.rounds[0]?.attackerFindings?.attackGraph,\n        businessLogicFindings: simulationResult.rounds[0]?.attackerFindings?.businessLogicFindings,\n        multiVectorFindings: simulationResult.rounds[0]?.attackerFindings?.multiVectorFindings,\n        workflowAnalysis: simulationResult.rounds[0]?.attackerFindings?.workflowAnalysis,\n        impact: simulationResult.rounds[0]?.attackerFindings?.impact,\n        recommendations: recsAsStrings,\n        evidenceArtifacts: [],\n        intelligentScore: {\n          overall: attackerScore,\n          exploitability: attackerScore,\n          impact: defenderScore > 70 ? 30 : 70,\n          defensibility: defenderScore,\n          confidence: 85,\n        },\n        remediationGuidance: {\n          immediate: recsAsStrings.slice(0, 2),\n          shortTerm: recsAsStrings.slice(2, 4),\n          longTerm: recsAsStrings.slice(4),\n          estimatedEffort: \"medium\",\n          priorityOrder: recsAsStrings,\n        },\n        duration,\n      });\n\n      await storage.updateEvaluationStatus(evaluationId, \"completed\");\n      wsService.sendComplete(evaluationId, true);\n      return;\n    }\n\n    // Standard evaluation (safe mode or live mode)\n    const result = await runAgentOrchestrator(\n      data.assetId,\n      data.exposureType,\n      data.priority,\n      data.description,\n      evaluationId,\n      (agentName, stage, progress, message) => {\n        wsService.sendProgress(evaluationId, agentName, stage, progress, message);\n      },\n      { adversaryProfile: data.adversaryProfile as any }\n    );\n\n    const duration = Date.now() - startTime;\n\n    await storage.createResult({\n      id: `res-${randomUUID().slice(0, 8)}`,\n      evaluationId,\n      exploitable: result.exploitable,\n      confidence: result.confidence,\n      score: result.score,\n      attackPath: result.attackPath,\n      attackGraph: result.attackGraph,\n      businessLogicFindings: result.businessLogicFindings,\n      multiVectorFindings: result.multiVectorFindings,\n      workflowAnalysis: result.workflowAnalysis,\n      impact: result.impact,\n      recommendations: result.recommendations,\n      evidenceArtifacts: result.evidenceArtifacts,\n      intelligentScore: result.intelligentScore,\n      remediationGuidance: result.remediationGuidance,\n      duration,\n    });\n\n    await storage.updateEvaluationStatus(evaluationId, \"completed\");\n    wsService.sendComplete(evaluationId, true);\n  } catch (error) {\n    console.error(\"Evaluation failed:\", error);\n    await storage.updateEvaluationStatus(evaluationId, \"failed\");\n    wsService.sendComplete(evaluationId, false, String(error));\n  }\n}\n\nasync function runBatchJob(batchJobId: string, configs: Array<{\n  assetId: string;\n  exposureType: string;\n  priority: string;\n  description: string;\n}>) {\n  try {\n    await storage.updateBatchJob(batchJobId, { status: \"running\" });\n    \n    const evaluationIds: string[] = [];\n    const jobResults: Array<{ evaluationId: string; success: boolean }> = [];\n    let completed = 0;\n    let failed = 0;\n    \n    for (const config of configs) {\n      try {\n        const evaluation = await storage.createEvaluation({\n          assetId: config.assetId,\n          exposureType: config.exposureType,\n          priority: config.priority,\n          description: config.description,\n          organizationId: \"default\",\n        });\n        \n        evaluationIds.push(evaluation.id);\n        \n        const startTime = Date.now();\n        await storage.updateEvaluationStatus(evaluation.id, \"in_progress\");\n        \n        const result = await runAgentOrchestrator(\n          config.assetId,\n          config.exposureType,\n          config.priority,\n          config.description,\n          evaluation.id,\n          (agentName, stage, progress, message) => {\n            wsService.sendProgress(evaluation.id, agentName, stage, progress, message);\n          }\n        );\n        \n        const duration = Date.now() - startTime;\n        \n        await storage.createResult({\n          id: `res-${randomUUID().slice(0, 8)}`,\n          evaluationId: evaluation.id,\n          exploitable: result.exploitable,\n          confidence: result.confidence,\n          score: result.score,\n          attackPath: result.attackPath,\n          attackGraph: result.attackGraph,\n          businessLogicFindings: result.businessLogicFindings,\n          multiVectorFindings: result.multiVectorFindings,\n          workflowAnalysis: result.workflowAnalysis,\n          impact: result.impact,\n          recommendations: result.recommendations,\n          evidenceArtifacts: result.evidenceArtifacts,\n          intelligentScore: result.intelligentScore,\n          remediationGuidance: result.remediationGuidance,\n          duration,\n        });\n        \n        await storage.updateEvaluationStatus(evaluation.id, \"completed\");\n        wsService.sendComplete(evaluation.id, true);\n        \n        jobResults.push({ evaluationId: evaluation.id, success: true });\n        completed++;\n      } catch (error) {\n        console.error(`Batch evaluation failed for ${config.assetId}:`, error);\n        jobResults.push({ evaluationId: config.assetId, success: false });\n        failed++;\n      }\n      \n      await storage.updateBatchJob(batchJobId, {\n        completedEvaluations: completed,\n        failedEvaluations: failed,\n        evaluationIds,\n        progress: Math.round(((completed + failed) / configs.length) * 100),\n      });\n    }\n    \n    await storage.updateBatchJob(batchJobId, {\n      status: failed === configs.length ? \"failed\" : \"completed\",\n      completedAt: new Date(),\n      completedEvaluations: completed,\n      failedEvaluations: failed,\n      evaluationIds,\n      progress: 100,\n    });\n  } catch (error) {\n    console.error(\"Batch job failed:\", error);\n    await storage.updateBatchJob(batchJobId, { \n      status: \"failed\",\n      completedAt: new Date(),\n    });\n  }\n}\n\n// AI vs AI Simulation runner\nasync function runAiSimulation(simulationId: string) {\n  try {\n    await storage.updateAiSimulation(simulationId, { \n      simulationStatus: \"running\",\n      startedAt: new Date(),\n    });\n    \n    // Simulate AI vs AI battle with realistic delays\n    await new Promise(resolve => setTimeout(resolve, 3000));\n    \n    // Generate simulation results\n    const results = {\n      attackerSuccesses: Math.floor(Math.random() * 5) + 1,\n      defenderBlocks: Math.floor(Math.random() * 8) + 3,\n      timeToDetection: Math.floor(Math.random() * 30) + 5,\n      timeToContainment: Math.floor(Math.random() * 60) + 15,\n      attackPath: [\n        \"T1190 - Exploit Public-Facing Application\",\n        \"T1059.001 - PowerShell Execution\",\n        \"T1003.001 - LSASS Memory Dump\",\n        \"T1021.002 - SMB/Windows Admin Shares\",\n        \"T1486 - Data Encrypted for Impact\",\n      ],\n      detectionPoints: [\n        \"Network IDS flagged anomalous traffic\",\n        \"EDR detected credential dumping\",\n        \"SIEM correlated lateral movement\",\n      ],\n      missedAttacks: [\n        \"Initial exploitation went undetected\",\n        \"Persistence mechanism not flagged\",\n      ],\n      recommendations: [\n        \"Improve web application firewall rules\",\n        \"Enable enhanced PowerShell logging\",\n        \"Deploy deception technology\",\n        \"Implement network segmentation\",\n      ],\n    };\n    \n    await storage.updateAiSimulation(simulationId, {\n      simulationStatus: \"completed\",\n      completedAt: new Date(),\n      simulationResults: results,\n    });\n  } catch (error) {\n    console.error(\"AI simulation failed:\", error);\n    await storage.updateAiSimulation(simulationId, {\n      simulationStatus: \"failed\",\n      completedAt: new Date(),\n    });\n  }\n}\n","path":null,"size_bytes":104133,"size_tokens":null},"client/src/components/AttackGraphVisualizer.tsx":{"content":"import { useState } from \"react\";\nimport { \n  Target, Shield, AlertTriangle, Clock, Gauge, Network, \n  ChevronDown, ChevronUp, Zap, ArrowRight, Layers\n} from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\n\ninterface AttackNode {\n  id: string;\n  label: string;\n  description: string;\n  nodeType: \"entry\" | \"pivot\" | \"objective\" | \"dead-end\";\n  tactic: string;\n  compromiseLevel: \"none\" | \"limited\" | \"user\" | \"admin\" | \"system\";\n  assets?: string[];\n  discoveredBy?: \"recon\" | \"exploit\" | \"lateral\" | \"business-logic\" | \"impact\";\n}\n\ninterface AttackEdge {\n  id: string;\n  source: string;\n  target: string;\n  technique: string;\n  techniqueId?: string;\n  description: string;\n  successProbability: number;\n  complexity: \"trivial\" | \"low\" | \"medium\" | \"high\" | \"expert\";\n  timeEstimate: number;\n  prerequisites?: string[];\n  alternatives?: string[];\n  edgeType: \"primary\" | \"alternative\" | \"fallback\";\n  discoveredBy?: \"recon\" | \"exploit\" | \"lateral\" | \"business-logic\" | \"impact\";\n}\n\ninterface AttackGraph {\n  nodes: AttackNode[];\n  edges: AttackEdge[];\n  entryNodeId: string;\n  objectiveNodeIds: string[];\n  criticalPath: string[];\n  alternativePaths?: string[][];\n  killChainCoverage: string[];\n  complexityScore: number;\n  timeToCompromise: {\n    minimum: number;\n    expected: number;\n    maximum: number;\n    unit: \"minutes\" | \"hours\" | \"days\";\n  };\n  chainedExploits?: Array<{\n    name: string;\n    techniques: string[];\n    combinedImpact: string;\n  }>;\n}\n\ninterface AttackGraphVisualizerProps {\n  attackGraph: AttackGraph;\n  isExploitable: boolean;\n}\n\nexport function AttackGraphVisualizer({ attackGraph, isExploitable }: AttackGraphVisualizerProps) {\n  const [expandedNodes, setExpandedNodes] = useState<Set<string>>(new Set());\n  const [showAlternativePaths, setShowAlternativePaths] = useState(false);\n\n  const toggleNode = (nodeId: string) => {\n    const newExpanded = new Set(expandedNodes);\n    if (newExpanded.has(nodeId)) {\n      newExpanded.delete(nodeId);\n    } else {\n      newExpanded.add(nodeId);\n    }\n    setExpandedNodes(newExpanded);\n  };\n\n  const getNodeTypeIcon = (nodeType: string) => {\n    switch (nodeType) {\n      case \"entry\": return Target;\n      case \"pivot\": return Network;\n      case \"objective\": return Zap;\n      case \"dead-end\": return Shield;\n      default: return Network;\n    }\n  };\n\n  const getNodeTypeColor = (nodeType: string, isOnCriticalPath: boolean) => {\n    if (isOnCriticalPath) {\n      switch (nodeType) {\n        case \"entry\": return \"border-cyan-500 bg-cyan-500/10\";\n        case \"objective\": return \"border-red-500 bg-red-500/10\";\n        default: return \"border-orange-500 bg-orange-500/10\";\n      }\n    }\n    return \"border-border bg-muted/30\";\n  };\n\n  const getCompromiseLevelColor = (level: string) => {\n    switch (level) {\n      case \"system\": return \"bg-red-500/10 text-red-400 border-red-500/30\";\n      case \"admin\": return \"bg-orange-500/10 text-orange-400 border-orange-500/30\";\n      case \"user\": return \"bg-amber-500/10 text-amber-400 border-amber-500/30\";\n      case \"limited\": return \"bg-blue-500/10 text-blue-400 border-blue-500/30\";\n      default: return \"bg-muted text-muted-foreground border-border\";\n    }\n  };\n\n  const getComplexityColor = (complexity: string) => {\n    switch (complexity) {\n      case \"trivial\": return \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\";\n      case \"low\": return \"bg-blue-500/10 text-blue-400 border-blue-500/30\";\n      case \"medium\": return \"bg-amber-500/10 text-amber-400 border-amber-500/30\";\n      case \"high\": return \"bg-orange-500/10 text-orange-400 border-orange-500/30\";\n      case \"expert\": return \"bg-red-500/10 text-red-400 border-red-500/30\";\n      default: return \"bg-muted text-muted-foreground\";\n    }\n  };\n\n  const getSuccessProbColor = (prob: number) => {\n    if (prob >= 80) return \"text-red-400\";\n    if (prob >= 60) return \"text-orange-400\";\n    if (prob >= 40) return \"text-amber-400\";\n    return \"text-emerald-400\";\n  };\n\n  const formatTactic = (tactic: string) => {\n    return tactic.split(\"-\").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(\" \");\n  };\n\n  const isNodeOnCriticalPath = (nodeId: string) => {\n    return attackGraph.criticalPath.includes(nodeId);\n  };\n\n  const getEdgesFromNode = (nodeId: string) => {\n    return attackGraph.edges.filter(e => e.source === nodeId);\n  };\n\n  const getNodeById = (nodeId: string) => {\n    return attackGraph.nodes.find(n => n.id === nodeId);\n  };\n\n  const orderedNodes = attackGraph.criticalPath\n    .map(id => getNodeById(id))\n    .filter((n): n is AttackNode => n !== undefined);\n\n  if (attackGraph.nodes.length === 0) {\n    return (\n      <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n        <div className=\"p-4 rounded-full bg-emerald-500/10 mb-4\">\n          <Shield className=\"h-10 w-10 text-emerald-400\" />\n        </div>\n        <h4 className=\"font-semibold text-emerald-400\">No Attack Graph Generated</h4>\n        <p className=\"text-sm text-muted-foreground mt-1 max-w-xs\">\n          The AI agents could not construct an attack graph for this exposure.\n        </p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"attack-graph-visualizer\">\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n        <div className=\"bg-muted/30 rounded-lg p-4 border border-border\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <Gauge className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"text-xs uppercase tracking-wider text-muted-foreground\">Complexity</span>\n          </div>\n          <div className=\"text-2xl font-bold text-foreground\">{attackGraph.complexityScore}</div>\n          <div className=\"text-xs text-muted-foreground\">out of 100</div>\n        </div>\n        \n        <div className=\"bg-muted/30 rounded-lg p-4 border border-border\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"text-xs uppercase tracking-wider text-muted-foreground\">Time to Compromise</span>\n          </div>\n          <div className=\"text-2xl font-bold text-foreground\">{attackGraph.timeToCompromise.expected}</div>\n          <div className=\"text-xs text-muted-foreground\">{attackGraph.timeToCompromise.unit}</div>\n        </div>\n        \n        <div className=\"bg-muted/30 rounded-lg p-4 border border-border\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <Network className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"text-xs uppercase tracking-wider text-muted-foreground\">Attack Steps</span>\n          </div>\n          <div className=\"text-2xl font-bold text-foreground\">{attackGraph.criticalPath.length}</div>\n          <div className=\"text-xs text-muted-foreground\">critical path</div>\n        </div>\n        \n        <div className=\"bg-muted/30 rounded-lg p-4 border border-border\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <Layers className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"text-xs uppercase tracking-wider text-muted-foreground\">Kill Chain Coverage</span>\n          </div>\n          <div className=\"text-2xl font-bold text-foreground\">{attackGraph.killChainCoverage.length}</div>\n          <div className=\"text-xs text-muted-foreground\">tactics</div>\n        </div>\n      </div>\n\n      <div className=\"bg-muted/20 rounded-lg p-4 border border-border\">\n        <div className=\"flex items-center gap-2 mb-3\">\n          <AlertTriangle className={`h-4 w-4 ${isExploitable ? \"text-red-400\" : \"text-emerald-400\"}`} />\n          <span className=\"text-sm font-medium text-foreground\">MITRE ATT&CK Kill Chain Coverage</span>\n        </div>\n        <div className=\"flex flex-wrap gap-2\">\n          {attackGraph.killChainCoverage.map((tactic, index) => (\n            <Badge \n              key={tactic} \n              className=\"bg-cyan-500/10 text-cyan-400 border-cyan-500/30\"\n              data-testid={`kill-chain-tactic-${index}`}\n            >\n              {formatTactic(tactic)}\n            </Badge>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <h4 className=\"font-semibold text-foreground flex items-center gap-2\">\n            <Target className=\"h-4 w-4\" />\n            Critical Attack Path\n          </h4>\n          {attackGraph.alternativePaths && attackGraph.alternativePaths.length > 0 && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setShowAlternativePaths(!showAlternativePaths)}\n              data-testid=\"button-toggle-alt-paths\"\n            >\n              {showAlternativePaths ? \"Hide\" : \"Show\"} {attackGraph.alternativePaths.length} Alternative Path(s)\n            </Button>\n          )}\n        </div>\n\n        <div className=\"relative\">\n          {orderedNodes.map((node, index) => {\n            const NodeIcon = getNodeTypeIcon(node.nodeType);\n            const outgoingEdges = getEdgesFromNode(node.id);\n            const nextNodeId = attackGraph.criticalPath[index + 1];\n            const criticalEdge = outgoingEdges.find(e => e.target === nextNodeId);\n            const isExpanded = expandedNodes.has(node.id);\n\n            return (\n              <div key={node.id} data-testid={`graph-node-${node.id}`}>\n                <Collapsible open={isExpanded} onOpenChange={() => toggleNode(node.id)}>\n                  <div className=\"flex gap-4\">\n                    <div className=\"flex flex-col items-center\">\n                      <div className={`w-12 h-12 rounded-full flex items-center justify-center border-2 ${\n                        getNodeTypeColor(node.nodeType, true)\n                      }`}>\n                        <NodeIcon className={`h-5 w-5 ${\n                          node.nodeType === \"entry\" ? \"text-cyan-400\" :\n                          node.nodeType === \"objective\" ? \"text-red-400\" :\n                          \"text-orange-400\"\n                        }`} />\n                      </div>\n                      {index < orderedNodes.length - 1 && (\n                        <div className=\"w-0.5 flex-1 min-h-8 bg-gradient-to-b from-orange-500/50 to-orange-500/20\" />\n                      )}\n                    </div>\n                    \n                    <div className=\"flex-1 pb-4\">\n                      <CollapsibleTrigger asChild>\n                        <div \n                          className=\"p-4 rounded-lg border border-border bg-card hover-elevate cursor-pointer\"\n                          data-testid={`node-trigger-${node.id}`}\n                        >\n                          <div className=\"flex items-start justify-between gap-4\">\n                            <div className=\"flex-1 min-w-0\">\n                              <div className=\"flex items-center gap-2 flex-wrap mb-1\">\n                                <Badge className={getCompromiseLevelColor(node.compromiseLevel)}>\n                                  {node.compromiseLevel.toUpperCase()}\n                                </Badge>\n                                <Badge className=\"bg-purple-500/10 text-purple-400 border-purple-500/30\">\n                                  {formatTactic(node.tactic)}\n                                </Badge>\n                                <Badge className={\n                                  node.nodeType === \"entry\" ? \"bg-cyan-500/10 text-cyan-400 border-cyan-500/30\" :\n                                  node.nodeType === \"objective\" ? \"bg-red-500/10 text-red-400 border-red-500/30\" :\n                                  \"bg-muted text-muted-foreground border-border\"\n                                }>\n                                  {node.nodeType.toUpperCase()}\n                                </Badge>\n                              </div>\n                              <h5 className=\"font-medium text-foreground\">{node.label}</h5>\n                              <p className=\"text-sm text-muted-foreground mt-1 line-clamp-2\">{node.description}</p>\n                            </div>\n                            {isExpanded ? (\n                              <ChevronUp className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                            ) : (\n                              <ChevronDown className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                            )}\n                          </div>\n                        </div>\n                      </CollapsibleTrigger>\n\n                      <CollapsibleContent>\n                        <div className=\"mt-2 p-4 rounded-lg border border-border bg-muted/30 space-y-3\">\n                          {node.assets && node.assets.length > 0 && (\n                            <div>\n                              <label className=\"text-xs uppercase tracking-wider text-muted-foreground block mb-1\">\n                                Affected Assets\n                              </label>\n                              <div className=\"flex flex-wrap gap-1\">\n                                {node.assets.map((asset, i) => (\n                                  <code key={i} className=\"text-xs px-2 py-0.5 rounded bg-background/50 text-foreground\">\n                                    {asset}\n                                  </code>\n                                ))}\n                              </div>\n                            </div>\n                          )}\n                          {node.discoveredBy && (\n                            <div>\n                              <label className=\"text-xs uppercase tracking-wider text-muted-foreground block mb-1\">\n                                Discovered By\n                              </label>\n                              <Badge className=\"bg-blue-500/10 text-blue-400 border-blue-500/30\">\n                                {node.discoveredBy.toUpperCase()} Agent\n                              </Badge>\n                            </div>\n                          )}\n                        </div>\n                      </CollapsibleContent>\n\n                      {criticalEdge && (\n                        <div className=\"mt-3 ml-4 flex items-start gap-3\">\n                          <ArrowRight className=\"h-4 w-4 text-orange-400 mt-1 flex-shrink-0\" />\n                          <div className=\"flex-1 p-3 rounded-lg border border-dashed border-orange-500/30 bg-orange-500/5\">\n                            <div className=\"flex items-center gap-2 flex-wrap mb-1\">\n                              <span className=\"text-sm font-medium text-foreground\">{criticalEdge.technique}</span>\n                              {criticalEdge.techniqueId && (\n                                <code className=\"text-[10px] px-1.5 py-0.5 rounded bg-background/50 text-muted-foreground\">\n                                  {criticalEdge.techniqueId}\n                                </code>\n                              )}\n                              <Badge className={getComplexityColor(criticalEdge.complexity)}>\n                                {criticalEdge.complexity.toUpperCase()}\n                              </Badge>\n                              <span className={`text-xs font-medium ${getSuccessProbColor(criticalEdge.successProbability)}`}>\n                                {criticalEdge.successProbability}% success\n                              </span>\n                            </div>\n                            <p className=\"text-xs text-muted-foreground\">{criticalEdge.description}</p>\n                            <div className=\"flex items-center gap-4 mt-2 text-xs text-muted-foreground\">\n                              <span className=\"flex items-center gap-1\">\n                                <Clock className=\"h-3 w-3\" />\n                                {criticalEdge.timeEstimate} min\n                              </span>\n                              {criticalEdge.prerequisites && criticalEdge.prerequisites.length > 0 && (\n                                <span>Prerequisites: {criticalEdge.prerequisites.length}</span>\n                              )}\n                            </div>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </Collapsible>\n              </div>\n            );\n          })}\n        </div>\n      </div>\n\n      {attackGraph.chainedExploits && attackGraph.chainedExploits.length > 0 && (\n        <div className=\"bg-red-500/5 border border-red-500/30 rounded-lg p-4\">\n          <h4 className=\"font-semibold text-red-400 mb-3 flex items-center gap-2\">\n            <Zap className=\"h-4 w-4\" />\n            Chained Exploit Combinations\n          </h4>\n          <div className=\"space-y-3\">\n            {attackGraph.chainedExploits.map((chain, index) => (\n              <div \n                key={index} \n                className=\"p-3 bg-background/30 rounded-lg\"\n                data-testid={`chained-exploit-${index}`}\n              >\n                <div className=\"font-medium text-foreground mb-1\">{chain.name}</div>\n                <div className=\"flex flex-wrap gap-1 mb-2\">\n                  {chain.techniques.map((tech, i) => (\n                    <code key={i} className=\"text-[10px] px-1.5 py-0.5 rounded bg-red-500/10 text-red-400\">\n                      {tech}\n                    </code>\n                  ))}\n                </div>\n                <p className=\"text-xs text-muted-foreground\">{chain.combinedImpact}</p>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":17787,"size_tokens":null},"client/src/components/RecommendationsPanel.tsx":{"content":"import { Lightbulb, Shield, AlertCircle, CheckCircle, ArrowRight, ShieldCheck } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface Recommendation {\n  id: string;\n  title: string;\n  description: string;\n  priority: \"critical\" | \"high\" | \"medium\" | \"low\";\n  type: \"remediation\" | \"compensating\" | \"preventive\";\n}\n\ninterface RecommendationsPanelProps {\n  recommendations: Recommendation[];\n}\n\nexport function RecommendationsPanel({ recommendations }: RecommendationsPanelProps) {\n  const remediations = recommendations.filter(r => r.type === \"remediation\");\n  const compensating = recommendations.filter(r => r.type === \"compensating\");\n  const preventive = recommendations.filter(r => r.type === \"preventive\");\n\n  const getPriorityIcon = (priority: string) => {\n    switch (priority) {\n      case \"critical\": return <AlertCircle className=\"h-4 w-4 text-red-400\" />;\n      case \"high\": return <AlertCircle className=\"h-4 w-4 text-orange-400\" />;\n      case \"medium\": return <Lightbulb className=\"h-4 w-4 text-amber-400\" />;\n      default: return <CheckCircle className=\"h-4 w-4 text-emerald-400\" />;\n    }\n  };\n\n  const getPriorityBadge = (priority: string) => {\n    const classes: Record<string, string> = {\n      critical: \"bg-red-500/10 text-red-400 border-red-500/30\",\n      high: \"bg-orange-500/10 text-orange-400 border-orange-500/30\",\n      medium: \"bg-amber-500/10 text-amber-400 border-amber-500/30\",\n      low: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\",\n    };\n    return <Badge className={classes[priority]}>{priority}</Badge>;\n  };\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"recommendations-panel\">\n      {remediations.length > 0 && (\n        <div>\n          <div className=\"flex items-center gap-2 mb-3\">\n            <Lightbulb className=\"h-4 w-4 text-cyan-400\" />\n            <h4 className=\"text-sm font-semibold text-foreground uppercase tracking-wider\">\n              Remediation Steps\n            </h4>\n          </div>\n          <div className=\"space-y-3\">\n            {remediations.map((rec, index) => (\n              <div \n                key={rec.id}\n                className=\"p-3 rounded-lg border border-border bg-muted/20 hover-elevate\"\n                data-testid={`remediation-${rec.id}`}\n              >\n                <div className=\"flex items-start gap-3\">\n                  <div className=\"flex items-center justify-center w-6 h-6 rounded-full bg-cyan-500/20 text-cyan-400 text-xs font-bold flex-shrink-0\">\n                    {index + 1}\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      <span className=\"font-medium text-foreground\">{rec.title}</span>\n                      {getPriorityBadge(rec.priority)}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground mt-1\">{rec.description}</p>\n                  </div>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {compensating.length > 0 && (\n        <div>\n          <div className=\"flex items-center gap-2 mb-3\">\n            <Shield className=\"h-4 w-4 text-purple-400\" />\n            <h4 className=\"text-sm font-semibold text-foreground uppercase tracking-wider\">\n              Compensating Controls\n            </h4>\n          </div>\n          <div className=\"space-y-2\">\n            {compensating.map((rec) => (\n              <div \n                key={rec.id}\n                className=\"flex items-start gap-2 p-3 rounded-lg border border-border bg-muted/10\"\n                data-testid={`compensating-${rec.id}`}\n              >\n                <ArrowRight className=\"h-4 w-4 text-purple-400 mt-0.5 flex-shrink-0\" />\n                <div>\n                  <span className=\"text-sm text-foreground\">{rec.title}</span>\n                  <p className=\"text-xs text-muted-foreground mt-0.5\">{rec.description}</p>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {preventive.length > 0 && (\n        <div>\n          <div className=\"flex items-center gap-2 mb-3\">\n            <ShieldCheck className=\"h-4 w-4 text-emerald-400\" />\n            <h4 className=\"text-sm font-semibold text-foreground uppercase tracking-wider\">\n              Preventive Measures\n            </h4>\n          </div>\n          <div className=\"space-y-2\">\n            {preventive.map((rec) => (\n              <div \n                key={rec.id}\n                className=\"flex items-start gap-2 p-3 rounded-lg border border-border bg-muted/10\"\n                data-testid={`preventive-${rec.id}`}\n              >\n                <ShieldCheck className=\"h-4 w-4 text-emerald-400 mt-0.5 flex-shrink-0\" />\n                <div>\n                  <span className=\"text-sm text-foreground\">{rec.title}</span>\n                  <p className=\"text-xs text-muted-foreground mt-0.5\">{rec.description}</p>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {recommendations.length === 0 && (\n        <div className=\"text-center py-8\">\n          <CheckCircle className=\"h-10 w-10 text-emerald-400 mx-auto mb-3\" />\n          <p className=\"text-muted-foreground\">No remediation required</p>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":5362,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"server/services/agents/business-logic.ts":{"content":"import OpenAI from \"openai\";\nimport type { \n  AgentMemory, \n  AgentResult, \n  BusinessLogicFindings,\n  EnhancedBusinessLogicFindings,\n  PaymentFlowVulnerability,\n  StateTransitionViolation,\n  InferredWorkflow\n} from \"./types\";\nimport type { BusinessLogicFinding, WorkflowStateMachine, BusinessLogicCategory } from \"@shared/schema\";\nimport { businessLogicCategories } from \"@shared/schema\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\ntype ProgressCallback = (stage: string, progress: number, message: string) => void;\n\nconst BUSINESS_LOGIC_EXPOSURE_TYPES = [\n  \"api_sequence_abuse\",\n  \"payment_flow\", \n  \"subscription_bypass\",\n  \"state_machine\",\n  \"privilege_boundary\",\n  \"workflow_desync\",\n  \"order_lifecycle\"\n];\n\nfunction isBusinessLogicExposure(exposureType: string): boolean {\n  return BUSINESS_LOGIC_EXPOSURE_TYPES.includes(exposureType);\n}\n\nexport async function runBusinessLogicAgent(\n  memory: AgentMemory,\n  onProgress?: ProgressCallback\n): Promise<AgentResult<BusinessLogicFindings>> {\n  const startTime = Date.now();\n  \n  onProgress?.(\"business_logic\", 70, \"Analyzing business logic flaws...\");\n\n  const previousContext = `\nRecon Findings:\n${memory.recon ? `- API Endpoints: ${memory.recon.apiEndpoints.join(\", \")}\n- Auth Mechanisms: ${memory.recon.authMechanisms.join(\", \")}` : \"None\"}\n\nExploit Findings:\n${memory.exploit ? `- Exploitable: ${memory.exploit.exploitable}\n- Misconfigurations: ${memory.exploit.misconfigurations.join(\", \")}` : \"None\"}\n\nLateral Movement Findings:\n${memory.lateral ? `- Privilege Escalation: ${memory.lateral.privilegeEscalation.map((p) => p.target).join(\", \")}` : \"None\"}\n`;\n\n  const systemPrompt = `You are the BUSINESS LOGIC AGENT, a specialized AI system for analyzing application logic vulnerabilities for OdinForge AI.\n\nYour mission is to identify business logic flaws that could be exploited:\n1. Workflow abuse - bypassing intended application flows\n2. State manipulation - exploiting state management issues\n3. Race conditions - TOCTOU and concurrency issues\n4. Authorization bypass - accessing resources without proper authorization\n5. Critical flows - business-critical processes that could be abused\n\nThink like an application security expert looking for logic flaws that automated scanners miss.`;\n\n  const userPrompt = `Analyze business logic vulnerabilities for this exposure:\n\nAsset ID: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nPriority: ${memory.context.priority}\nDescription: ${memory.context.description}\n${previousContext}\n\nProvide your business logic analysis as a JSON object with this structure:\n{\n  \"workflowAbuse\": [\"list of workflow bypass opportunities\"],\n  \"stateManipulation\": [\"list of state manipulation vulnerabilities\"],\n  \"raceConditions\": [\"list of race condition opportunities\"],\n  \"authorizationBypass\": [\"list of authorization bypass methods\"],\n  \"criticalFlows\": [\"list of critical business flows that could be abused\"]\n}`;\n\n  try {\n    onProgress?.(\"business_logic\", 75, \"Detecting race conditions...\");\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 2048,\n    });\n\n    onProgress?.(\"business_logic\", 80, \"Analyzing authorization flows...\");\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response from Business Logic Agent\");\n    }\n\n    const findings = JSON.parse(content) as BusinessLogicFindings;\n    \n    const validatedFindings: BusinessLogicFindings = {\n      workflowAbuse: Array.isArray(findings.workflowAbuse) ? findings.workflowAbuse : [],\n      stateManipulation: Array.isArray(findings.stateManipulation) ? findings.stateManipulation : [],\n      raceConditions: Array.isArray(findings.raceConditions) ? findings.raceConditions : [],\n      authorizationBypass: Array.isArray(findings.authorizationBypass) ? findings.authorizationBypass : [],\n      criticalFlows: Array.isArray(findings.criticalFlows) ? findings.criticalFlows : [],\n    };\n\n    return {\n      success: true,\n      findings: validatedFindings,\n      agentName: \"Business Logic Agent\",\n      processingTime: Date.now() - startTime,\n    };\n  } catch (error) {\n    console.error(\"Business Logic Agent error:\", error);\n    throw error;\n  }\n}\n\nexport async function runEnhancedBusinessLogicEngine(\n  memory: AgentMemory,\n  onProgress?: ProgressCallback\n): Promise<AgentResult<EnhancedBusinessLogicFindings>> {\n  const startTime = Date.now();\n  \n  onProgress?.(\"business_logic_engine\", 70, \"Initializing Business Logic Engine...\");\n\n  const basicResult = await runBusinessLogicAgent(memory, onProgress);\n  \n  onProgress?.(\"business_logic_engine\", 73, \"Inferring application workflows...\");\n  const inferredWorkflows = await inferWorkflows(memory);\n  \n  onProgress?.(\"business_logic_engine\", 76, \"Analyzing state machine transitions...\");\n  const workflowAnalysis = await analyzeStateMachine(memory, inferredWorkflows);\n  \n  onProgress?.(\"business_logic_engine\", 79, \"Detecting state transition violations...\");\n  const stateTransitionViolations = await detectStateTransitionViolations(memory, workflowAnalysis);\n  \n  onProgress?.(\"business_logic_engine\", 82, \"Analyzing payment flows...\");\n  const paymentFlowVulnerabilities = await analyzePaymentFlows(memory);\n  \n  onProgress?.(\"business_logic_engine\", 85, \"Generating detailed findings...\");\n  const detailedFindings = await generateDetailedFindings(\n    memory, \n    basicResult.findings, \n    stateTransitionViolations, \n    paymentFlowVulnerabilities,\n    workflowAnalysis\n  );\n\n  const enhancedFindings: EnhancedBusinessLogicFindings = {\n    basicFindings: basicResult.findings,\n    detailedFindings,\n    workflowAnalysis,\n    paymentFlowVulnerabilities,\n    stateTransitionViolations,\n    inferredWorkflows,\n  };\n\n  return {\n    success: true,\n    findings: enhancedFindings,\n    agentName: \"Business Logic Engine\",\n    processingTime: Date.now() - startTime,\n  };\n}\n\nasync function inferWorkflows(memory: AgentMemory): Promise<InferredWorkflow[]> {\n  const systemPrompt = `You are a WORKFLOW INFERENCE ENGINE for OdinForge AI.\n\nYour task is to analyze the target system and infer the application's business workflows based on:\n1. API endpoints discovered during reconnaissance\n2. Authentication mechanisms in place\n3. The exposure type and description provided\n\nFor each workflow, identify:\n- The intended sequence of steps\n- Security checkpoints (authentication, authorization, validation)\n- Potential bypass opportunities\n\nFocus on high-value workflows: authentication, payment, order processing, subscription management, admin operations.`;\n\n  const userPrompt = `Infer the application workflows for:\n\nAsset ID: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nDescription: ${memory.context.description}\n\n${memory.recon ? `Discovered API Endpoints: ${memory.recon.apiEndpoints.join(\", \")}\nAuth Mechanisms: ${memory.recon.authMechanisms.join(\", \")}\nTechnologies: ${memory.recon.technologies.join(\", \")}` : \"\"}\n\nReturn a JSON object with this structure:\n{\n  \"workflows\": [\n    {\n      \"name\": \"workflow name\",\n      \"description\": \"what this workflow does\",\n      \"steps\": [\"step1\", \"step2\", \"step3\"],\n      \"securityCheckpoints\": [\"where security checks occur\"],\n      \"potentialBypasses\": [\"ways to bypass security in this workflow\"]\n    }\n  ]\n}`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 2048,\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) return [];\n\n    const result = JSON.parse(content);\n    return Array.isArray(result.workflows) ? result.workflows : [];\n  } catch (error) {\n    console.error(\"Workflow inference error:\", error);\n    return [];\n  }\n}\n\nasync function analyzeStateMachine(\n  memory: AgentMemory, \n  inferredWorkflows: InferredWorkflow[]\n): Promise<WorkflowStateMachine | null> {\n  const systemPrompt = `You are a STATE MACHINE ANALYZER for OdinForge AI.\n\nYour task is to model the application's state machine based on inferred workflows.\nCreate a formal state machine representation that captures:\n1. All possible states in the application workflow\n2. Valid transitions between states\n3. Security boundaries and privilege requirements\n4. Critical transitions that require special authorization\n\nFocus on identifying states where unauthorized transitions could lead to security vulnerabilities.`;\n\n  const workflowContext = inferredWorkflows.length > 0 \n    ? `Inferred Workflows:\\n${inferredWorkflows.map(w => \n        `- ${w.name}: ${w.steps.join(\" -> \")}`\n      ).join(\"\\n\")}`\n    : \"No workflows inferred yet\";\n\n  const userPrompt = `Analyze the state machine for:\n\nAsset ID: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nDescription: ${memory.context.description}\n\n${workflowContext}\n\nReturn a JSON object with this structure:\n{\n  \"name\": \"Application State Machine\",\n  \"states\": [\n    {\n      \"id\": \"state_id\",\n      \"name\": \"State Name\",\n      \"type\": \"initial|intermediate|terminal|error\",\n      \"requiredAuth\": \"none|user|admin|system\"\n    }\n  ],\n  \"transitions\": [\n    {\n      \"id\": \"transition_id\",\n      \"from\": \"from_state_id\",\n      \"to\": \"to_state_id\",\n      \"trigger\": \"what triggers this transition\",\n      \"guard\": \"condition that must be true\",\n      \"isSecurityCritical\": true\n    }\n  ],\n  \"securityBoundaries\": [\n    {\n      \"name\": \"boundary name\",\n      \"statesWithin\": [\"state_ids\"],\n      \"requiredPrivilege\": \"privilege level\"\n    }\n  ]\n}`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 2048,\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) return null;\n\n    const result = JSON.parse(content);\n    return result as WorkflowStateMachine;\n  } catch (error) {\n    console.error(\"State machine analysis error:\", error);\n    return null;\n  }\n}\n\nasync function detectStateTransitionViolations(\n  memory: AgentMemory,\n  stateMachine: WorkflowStateMachine | null\n): Promise<StateTransitionViolation[]> {\n  if (!stateMachine) return [];\n\n  const systemPrompt = `You are a STATE TRANSITION VIOLATION DETECTOR for OdinForge AI.\n\nYour task is to identify potential state transition violations that could be exploited:\n1. SKIP violations - jumping over required intermediate states\n2. REVERSE violations - going backward in a one-way flow\n3. UNAUTHORIZED violations - transitioning without proper authorization\n4. RACE CONDITION violations - exploiting timing issues in state transitions\n\nFor each violation, assess its severity and exploitability.`;\n\n  const userPrompt = `Detect state transition violations for:\n\nAsset ID: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nDescription: ${memory.context.description}\n\nState Machine:\nStates: ${stateMachine.states.map(s => `${s.id}(${s.name})`).join(\", \")}\nTransitions: ${stateMachine.transitions.map(t => `${t.from}->${t.to}[${t.trigger}]`).join(\", \")}\nSecurity Boundaries: ${stateMachine.securityBoundaries?.map(b => `${b.name}: ${b.statesWithin.join(\", \")}`).join(\"; \") || \"none\"}\n\nReturn a JSON object with this structure:\n{\n  \"violations\": [\n    {\n      \"id\": \"violation_id\",\n      \"fromState\": \"state_id\",\n      \"toState\": \"target_state_id\",\n      \"expectedTransitions\": [\"list of valid transitions\"],\n      \"actualTransition\": \"the invalid transition being attempted\",\n      \"violationType\": \"skip|reverse|unauthorized|race_condition\",\n      \"severity\": \"critical|high|medium|low\",\n      \"exploitability\": \"description of how this can be exploited\"\n    }\n  ]\n}`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 2048,\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) return [];\n\n    const result = JSON.parse(content);\n    return Array.isArray(result.violations) ? result.violations : [];\n  } catch (error) {\n    console.error(\"State transition violation detection error:\", error);\n    return [];\n  }\n}\n\nasync function analyzePaymentFlows(memory: AgentMemory): Promise<PaymentFlowVulnerability[]> {\n  const isPaymentRelated = [\n    \"payment_flow\",\n    \"subscription_bypass\", \n    \"order_lifecycle\"\n  ].includes(memory.context.exposureType);\n\n  const hasPaymentEndpoints = memory.recon?.apiEndpoints.some(ep => \n    /payment|checkout|order|cart|subscription|billing|stripe|paypal/i.test(ep)\n  );\n\n  if (!isPaymentRelated && !hasPaymentEndpoints) {\n    return [];\n  }\n\n  const systemPrompt = `You are a PAYMENT FLOW VULNERABILITY ANALYZER for OdinForge AI.\n\nYour task is to identify vulnerabilities in payment and financial transaction flows:\n1. Payment bypass - skipping payment steps entirely\n2. Subscription abuse - trial extension, plan switching exploits\n3. Order manipulation - price tampering, quantity abuse\n4. Price tampering - modifying prices in requests\n5. Coupon abuse - stacking coupons, expired coupon reuse\n\nFor each vulnerability, assess financial impact and provide exploit steps.`;\n\n  const userPrompt = `Analyze payment flow vulnerabilities for:\n\nAsset ID: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nDescription: ${memory.context.description}\n\n${memory.recon ? `Payment-related endpoints: ${memory.recon.apiEndpoints.filter(ep => \n  /payment|checkout|order|cart|subscription|billing/i.test(ep)\n).join(\", \")}` : \"\"}\n\nReturn a JSON object with this structure:\n{\n  \"vulnerabilities\": [\n    {\n      \"id\": \"vuln_id\",\n      \"category\": \"payment_bypass|subscription_abuse|order_manipulation|price_tampering|coupon_abuse\",\n      \"title\": \"Vulnerability title\",\n      \"description\": \"Detailed description\",\n      \"severity\": \"critical|high|medium|low\",\n      \"affectedFlow\": [\"step1\", \"step2\"],\n      \"exploitSteps\": [\"step1\", \"step2\", \"step3\"],\n      \"financialImpact\": \"Estimated financial impact\",\n      \"validatedExploit\": false\n    }\n  ]\n}`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 2048,\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) return [];\n\n    const result = JSON.parse(content);\n    return Array.isArray(result.vulnerabilities) ? result.vulnerabilities : [];\n  } catch (error) {\n    console.error(\"Payment flow analysis error:\", error);\n    return [];\n  }\n}\n\nasync function generateDetailedFindings(\n  memory: AgentMemory,\n  basicFindings: BusinessLogicFindings,\n  stateViolations: StateTransitionViolation[],\n  paymentVulns: PaymentFlowVulnerability[],\n  stateMachine: WorkflowStateMachine | null\n): Promise<BusinessLogicFinding[]> {\n  const findings: BusinessLogicFinding[] = [];\n  let findingId = 1;\n\n  for (const violation of stateViolations) {\n    findings.push({\n      id: `bl-${findingId++}`,\n      category: \"state_transition\" as BusinessLogicCategory,\n      title: `State Transition Violation: ${violation.fromState} -> ${violation.toState}`,\n      description: violation.exploitability,\n      severity: violation.severity,\n      intendedWorkflow: violation.expectedTransitions,\n      actualWorkflow: [violation.actualTransition],\n      stateViolations: [{\n        fromState: violation.fromState,\n        toState: violation.toState,\n        expectedTransitions: violation.expectedTransitions,\n        actualTransition: violation.actualTransition,\n        isViolation: true,\n      }],\n      exploitSteps: [`Attempt transition from ${violation.fromState} directly to ${violation.toState}`],\n      impact: `${violation.violationType} violation allows bypassing security controls`,\n      validatedExploit: false,\n    });\n  }\n\n  for (const vuln of paymentVulns) {\n    const category = mapPaymentCategoryToBusinessLogic(vuln.category);\n    findings.push({\n      id: `bl-${findingId++}`,\n      category,\n      title: vuln.title,\n      description: vuln.description,\n      severity: vuln.severity,\n      intendedWorkflow: vuln.affectedFlow,\n      actualWorkflow: vuln.exploitSteps,\n      exploitSteps: vuln.exploitSteps,\n      impact: vuln.financialImpact,\n      businessImpact: {\n        financialLoss: vuln.financialImpact,\n      },\n      validatedExploit: vuln.validatedExploit,\n    });\n  }\n\n  for (const abuse of basicFindings.workflowAbuse) {\n    findings.push({\n      id: `bl-${findingId++}`,\n      category: \"workflow_bypass\" as BusinessLogicCategory,\n      title: `Workflow Bypass: ${abuse.substring(0, 50)}...`,\n      description: abuse,\n      severity: \"medium\",\n      intendedWorkflow: stateMachine?.states.map(s => s.name) || [],\n      actualWorkflow: [],\n      exploitSteps: [abuse],\n      impact: \"Potential bypass of intended workflow controls\",\n      validatedExploit: false,\n    });\n  }\n\n  for (const race of basicFindings.raceConditions) {\n    findings.push({\n      id: `bl-${findingId++}`,\n      category: \"race_condition\" as BusinessLogicCategory,\n      title: `Race Condition: ${race.substring(0, 50)}...`,\n      description: race,\n      severity: \"high\",\n      intendedWorkflow: [],\n      actualWorkflow: [],\n      exploitSteps: [race],\n      impact: \"TOCTOU or double-spend vulnerability\",\n      validatedExploit: false,\n    });\n  }\n\n  for (const bypass of basicFindings.authorizationBypass) {\n    findings.push({\n      id: `bl-${findingId++}`,\n      category: \"privilege_escalation\" as BusinessLogicCategory,\n      title: `Authorization Bypass: ${bypass.substring(0, 50)}...`,\n      description: bypass,\n      severity: \"high\",\n      intendedWorkflow: [],\n      actualWorkflow: [],\n      exploitSteps: [bypass],\n      impact: \"Unauthorized access to protected resources\",\n      validatedExploit: false,\n    });\n  }\n\n  return findings;\n}\n\nfunction mapPaymentCategoryToBusinessLogic(\n  category: PaymentFlowVulnerability[\"category\"]\n): BusinessLogicCategory {\n  const mapping: Record<PaymentFlowVulnerability[\"category\"], BusinessLogicCategory> = {\n    \"payment_bypass\": \"payment_bypass\",\n    \"subscription_abuse\": \"subscription_abuse\",\n    \"order_manipulation\": \"order_manipulation\",\n    \"price_tampering\": \"parameter_tampering\",\n    \"coupon_abuse\": \"payment_bypass\",\n  };\n  return mapping[category];\n}\n\nexport function shouldRunEnhancedEngine(exposureType: string): boolean {\n  return isBusinessLogicExposure(exposureType);\n}\n","path":null,"size_bytes":19260,"size_tokens":null},"client/src/components/examples/Header.tsx":{"content":"import { Header } from \"../Header\";\nimport { ThemeProvider } from \"../ThemeProvider\";\n\nexport default function HeaderExample() {\n  return (\n    <ThemeProvider>\n      <Header />\n    </ThemeProvider>\n  );\n}\n","path":null,"size_bytes":205,"size_tokens":null},"client/src/components/Header.tsx":{"content":"import { Shield, Moon, Sun, Bell, User, ChevronDown, Brain, Server, Swords } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useTheme } from \"./ThemeProvider\";\nimport { Link, useLocation } from \"wouter\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\nexport function Header() {\n  const { theme, toggleTheme } = useTheme();\n  const [location] = useLocation();\n\n  const isActive = (path: string) => location === path;\n\n  return (\n    <header className=\"h-16 border-b border-border bg-card/80 backdrop-blur-sm sticky top-0 z-50\">\n      <div className=\"h-full px-6 flex items-center justify-between gap-4\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"relative\">\n            <div className=\"absolute inset-0 bg-gradient-to-r from-cyan-500 to-blue-600 blur-lg opacity-50\" />\n            <div className=\"relative p-2 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-lg\">\n              <Shield className=\"h-6 w-6 text-white\" />\n            </div>\n          </div>\n          <div className=\"flex flex-col\">\n            <span className=\"text-lg font-bold tracking-tight bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent\">\n              OdinForge\n            </span>\n            <span className=\"text-[10px] uppercase tracking-widest text-muted-foreground -mt-1\">\n              AEV Platform\n            </span>\n          </div>\n        </div>\n\n        <nav className=\"hidden md:flex items-center gap-1\">\n          <Link href=\"/\">\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              className={isActive(\"/\") ? \"text-foreground\" : \"text-muted-foreground\"} \n              data-testid=\"nav-dashboard\"\n            >\n              Dashboard\n            </Button>\n          </Link>\n          <Link href=\"/assets\">\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              className={isActive(\"/assets\") ? \"text-foreground\" : \"text-muted-foreground\"} \n              data-testid=\"nav-assets\"\n            >\n              Assets\n            </Button>\n          </Link>\n          <Link href=\"/infrastructure\">\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              className={isActive(\"/infrastructure\") ? \"text-foreground\" : \"text-muted-foreground\"} \n              data-testid=\"nav-infrastructure\"\n            >\n              Infrastructure\n            </Button>\n          </Link>\n          <Link href=\"/risk\">\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              className={isActive(\"/risk\") ? \"text-foreground\" : \"text-muted-foreground\"} \n              data-testid=\"nav-risk\"\n            >\n              Risk Dashboard\n            </Button>\n          </Link>\n          <Link href=\"/reports\">\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              className={isActive(\"/reports\") ? \"text-foreground\" : \"text-muted-foreground\"} \n              data-testid=\"nav-reports\"\n            >\n              Reports\n            </Button>\n          </Link>\n          <Link href=\"/batch\">\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              className={isActive(\"/batch\") ? \"text-foreground\" : \"text-muted-foreground\"} \n              data-testid=\"nav-batch\"\n            >\n              Batch Jobs\n            </Button>\n          </Link>\n          <Link href=\"/governance\">\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              className={isActive(\"/governance\") ? \"text-foreground\" : \"text-muted-foreground\"} \n              data-testid=\"nav-governance\"\n            >\n              Governance\n            </Button>\n          </Link>\n          <Link href=\"/agents\">\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              className={`${isActive(\"/agents\") ? \"text-foreground\" : \"text-muted-foreground\"} gap-1`} \n              data-testid=\"nav-agents\"\n            >\n              <Server className=\"h-3.5 w-3.5\" />\n              Agents\n            </Button>\n          </Link>\n          <Link href=\"/simulations\">\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              className={`${isActive(\"/simulations\") ? \"text-foreground\" : \"text-muted-foreground\"} gap-1`} \n              data-testid=\"nav-simulations\"\n            >\n              <Swords className=\"h-3.5 w-3.5\" />\n              Simulations\n            </Button>\n          </Link>\n          <Link href=\"/advanced\">\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              className={`${isActive(\"/advanced\") ? \"text-foreground\" : \"text-muted-foreground\"} gap-1`} \n              data-testid=\"nav-advanced\"\n            >\n              <Brain className=\"h-3.5 w-3.5\" />\n              Advanced\n            </Button>\n          </Link>\n        </nav>\n\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={toggleTheme}\n            data-testid=\"button-theme-toggle\"\n          >\n            {theme === \"dark\" ? (\n              <Sun className=\"h-4 w-4\" />\n            ) : (\n              <Moon className=\"h-4 w-4\" />\n            )}\n          </Button>\n          <Button variant=\"ghost\" size=\"icon\" className=\"relative\" data-testid=\"button-notifications\">\n            <Bell className=\"h-4 w-4\" />\n            <span className=\"absolute top-1.5 right-1.5 h-2 w-2 bg-red-500 rounded-full\" />\n          </Button>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"ghost\" size=\"sm\" className=\"gap-2\" data-testid=\"button-user-menu\">\n                <div className=\"h-7 w-7 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center\">\n                  <User className=\"h-4 w-4 text-white\" />\n                </div>\n                <span className=\"hidden sm:inline text-sm\">Admin</span>\n                <ChevronDown className=\"h-3 w-3\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\">\n              <DropdownMenuItem data-testid=\"menu-profile\">Profile</DropdownMenuItem>\n              <DropdownMenuItem data-testid=\"menu-settings\">Settings</DropdownMenuItem>\n              <DropdownMenuItem data-testid=\"menu-logout\">Log out</DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      </div>\n    </header>\n  );\n}\n","path":null,"size_bytes":6615,"size_tokens":null},"server/services/aev.ts":{"content":"import OpenAI from \"openai\";\nimport { type AttackPathStep, type Recommendation } from \"@shared/schema\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\nexport interface AEVAnalysisResult {\n  exploitable: boolean;\n  confidence: number;\n  score: number;\n  attackPath: AttackPathStep[];\n  impact: string;\n  recommendations: Recommendation[];\n}\n\nexport type ProgressCallback = (stage: string, progress: number, message: string) => void;\n\nexport async function analyzeExposure(\n  assetId: string,\n  exposureType: string,\n  priority: string,\n  description: string,\n  onProgress?: ProgressCallback\n): Promise<AEVAnalysisResult> {\n  const stages = [\n    { name: \"attack_surface\", progress: 25, message: \"Analyzing attack surface...\" },\n    { name: \"exploit_chain\", progress: 50, message: \"Constructing exploit chain...\" },\n    { name: \"impact\", progress: 75, message: \"Assessing impact potential...\" },\n    { name: \"remediation\", progress: 100, message: \"Generating remediation recommendations...\" },\n  ];\n\n  onProgress?.(stages[0].name, stages[0].progress, stages[0].message);\n\n  const systemPrompt = `You are OdinForge AI (Autonomous Exploit Validation), an advanced AI security analyst specializing in adversarial exposure validation. Your task is to analyze security exposures and determine their exploitability through autonomous reasoning.\n\nFor each exposure, you must:\n1. Analyze the attack surface and potential entry points\n2. Construct a realistic attack path using MITRE ATT&CK techniques\n3. Assess the potential impact if exploited\n4. Generate actionable remediation recommendations\n\nAlways provide structured, actionable output in JSON format.`;\n\n  const userPrompt = `Analyze this security exposure for exploitability:\n\nAsset ID: ${assetId}\nExposure Type: ${exposureType}\nPriority: ${priority}\nDescription: ${description}\n\nProvide your analysis as a JSON object with this exact structure:\n{\n  \"exploitable\": boolean (true if the exposure can be exploited in real-world conditions),\n  \"confidence\": number (0-100, your confidence level in the assessment),\n  \"score\": number (0-100, exploitability severity score),\n  \"attackPath\": [\n    {\n      \"id\": number (sequential step number),\n      \"title\": string (brief title for this attack step),\n      \"description\": string (detailed description of what happens),\n      \"technique\": string (MITRE ATT&CK technique ID, e.g., \"T1190\"),\n      \"severity\": \"critical\" | \"high\" | \"medium\" | \"low\"\n    }\n  ],\n  \"impact\": string (description of potential business impact if exploited),\n  \"recommendations\": [\n    {\n      \"id\": string (unique ID like \"rec-1\"),\n      \"title\": string (brief title),\n      \"description\": string (detailed remediation steps),\n      \"priority\": \"critical\" | \"high\" | \"medium\" | \"low\",\n      \"type\": \"remediation\" | \"compensating\" | \"preventive\"\n    }\n  ]\n}`;\n\n  try {\n    onProgress?.(stages[1].name, stages[1].progress, stages[1].message);\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 4096,\n    });\n\n    onProgress?.(stages[2].name, stages[2].progress, stages[2].message);\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response content from AI\");\n    }\n\n    const result = JSON.parse(content) as AEVAnalysisResult;\n\n    onProgress?.(stages[3].name, stages[3].progress, stages[3].message);\n\n    const validatedResult: AEVAnalysisResult = {\n      exploitable: Boolean(result.exploitable),\n      confidence: Math.min(100, Math.max(0, Number(result.confidence) || 50)),\n      score: Math.min(100, Math.max(0, Number(result.score) || 50)),\n      attackPath: Array.isArray(result.attackPath) \n        ? result.attackPath.map((step, index) => ({\n            id: step.id || index + 1,\n            title: String(step.title || \"Attack Step\"),\n            description: String(step.description || \"\"),\n            technique: step.technique ? String(step.technique) : undefined,\n            severity: validateSeverity(step.severity),\n          }))\n        : [],\n      impact: String(result.impact || \"Impact assessment pending\"),\n      recommendations: Array.isArray(result.recommendations)\n        ? result.recommendations.map((rec, index) => ({\n            id: String(rec.id || `rec-${index + 1}`),\n            title: String(rec.title || \"Recommendation\"),\n            description: String(rec.description || \"\"),\n            priority: validateSeverity(rec.priority),\n            type: validateRecType(rec.type),\n          }))\n        : [],\n    };\n\n    return validatedResult;\n  } catch (error) {\n    console.error(\"AEV analysis error:\", error);\n    throw error;\n  }\n}\n\nfunction validateSeverity(severity: unknown): \"critical\" | \"high\" | \"medium\" | \"low\" {\n  const valid = [\"critical\", \"high\", \"medium\", \"low\"];\n  return valid.includes(String(severity)) \n    ? (severity as \"critical\" | \"high\" | \"medium\" | \"low\") \n    : \"medium\";\n}\n\nfunction validateRecType(type: unknown): \"remediation\" | \"compensating\" | \"preventive\" {\n  const valid = [\"remediation\", \"compensating\", \"preventive\"];\n  return valid.includes(String(type)) \n    ? (type as \"remediation\" | \"compensating\" | \"preventive\") \n    : \"remediation\";\n}\n","path":null,"size_bytes":5467,"size_tokens":null},"attached_assets/AEVPage_1765772491190.tsx":{"content":"import { useState, useCallback, useRef, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { useAuth } from \"../lib/auth\";\nimport { useWebSocket, WSMessage } from \"../hooks/use-websocket\";\nimport { apiRequest, queryClient } from \"../lib/queryClient\";\nimport { AEVProgressModal, AEVProgressData, AEVCompleteData } from \"../components/AEVProgressModal\";\nimport {\n  Zap,\n  Play,\n  RefreshCw,\n  Clock,\n  CheckCircle,\n  XCircle,\n  AlertTriangle,\n  Loader2,\n  ChevronDown,\n  ChevronUp,\n  Target,\n  Shield,\n  Activity,\n  Eye,\n  ExternalLink,\n  X,\n} from \"lucide-react\";\n\ninterface AEVEvaluation {\n  id: string;\n  assetId: string;\n  exposureType: string;\n  module?: string;\n  priority?: string;\n  status: string;\n  result?: {\n    evaluationId?: string;\n    exploitable: boolean;\n    confidence: number;\n    score: number;\n    status: string;\n    exploitPath?: string[];\n    mitigations?: string[];\n    evidence?: string[];\n    technicalDetails?: any;\n  };\n  createdAt: string;\n  updatedAt?: string;\n}\n\ninterface AEVResponse {\n  evaluations: AEVEvaluation[];\n  total: number;\n}\n\ninterface AEVStats {\n  totalEvaluations: number;\n  activeEvaluations: number;\n  completedEvaluations: number;\n  exploitableCount: number;\n  notExploitableCount: number;\n  averageConfidence: number;\n}\n\nexport default function AEVPage() {\n  const { token } = useAuth();\n  const [selectedEvaluation, setSelectedEvaluation] = useState<AEVEvaluation | null>(null);\n  const [showNewEvalModal, setShowNewEvalModal] = useState(false);\n  const [sortField, setSortField] = useState<\"createdAt\" | \"status\" | \"priority\">(\"createdAt\");\n  const [sortOrder, setSortOrder] = useState<\"asc\" | \"desc\">(\"desc\");\n  const [filter, setFilter] = useState<string>(\"all\");\n  \n  const [showProgressModal, setShowProgressModal] = useState(false);\n  const [activeEvaluationId, setActiveEvaluationId] = useState<string | null>(null);\n  const [activeAssetId, setActiveAssetId] = useState<string>(\"\");\n  const [progressData, setProgressData] = useState<AEVProgressData | null>(null);\n  const [resultData, setResultData] = useState<AEVCompleteData | null>(null);\n  \n  const activeEvaluationIdRef = useRef<string | null>(null);\n  useEffect(() => {\n    activeEvaluationIdRef.current = activeEvaluationId;\n  }, [activeEvaluationId]);\n  \n  const [newEvalForm, setNewEvalForm] = useState({\n    assetId: \"\",\n    exposureType: \"cve\" as \"cve\" | \"misconfiguration\" | \"behavior\" | \"network\" | \"custom\",\n    description: \"\",\n    module: \"vulnmgmt\" as \"posture\" | \"spear\" | \"sentinel\" | \"vulnmgmt\",\n    priority: \"medium\" as \"low\" | \"medium\" | \"high\" | \"critical\",\n  });\n\n  const handleWSMessage = useCallback((message: WSMessage) => {\n    const currentId = activeEvaluationIdRef.current;\n    if (message.type === \"aev_progress\" && message.data.evaluationId === currentId) {\n      setProgressData({\n        evaluationId: message.data.evaluationId,\n        progress: message.data.progress,\n        stage: message.data.stage,\n        currentStage: message.data.currentStage,\n        stageName: message.data.stageName,\n      });\n    } else if (message.type === \"aev_complete\" && message.data.evaluationId === currentId) {\n      setResultData({\n        evaluationId: message.data.evaluationId,\n        exploitable: message.data.exploitable,\n        confidence: message.data.confidence,\n        score: message.data.score,\n        status: message.data.status,\n        error: message.data.error,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/aev/evaluations\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/aev/stats\"] });\n    }\n  }, []);\n\n  const { subscribe } = useWebSocket({\n    token,\n    onMessage: handleWSMessage,\n    onConnect: () => subscribe(\"aev\"),\n  });\n\n  const { data: aevResponse, isLoading } = useQuery<AEVResponse>({\n    queryKey: [\"/api/aev/evaluations\"],\n    refetchInterval: 10000,\n    retry: 1,\n  });\n\n  const { data: aevStats } = useQuery<AEVStats>({\n    queryKey: [\"/api/aev/stats\"],\n    refetchInterval: 30000,\n    retry: 1,\n  });\n\n  const handleCloseProgressModal = useCallback(() => {\n    setShowProgressModal(false);\n    setActiveEvaluationId(null);\n    setActiveAssetId(\"\");\n    setProgressData(null);\n    setResultData(null);\n  }, []);\n\n  const newEvaluationMutation = useMutation({\n    mutationFn: async (data: typeof newEvalForm) => {\n      const evaluationId = `aev-${crypto.randomUUID().slice(0, 8)}`;\n      \n      setActiveAssetId(data.assetId);\n      setProgressData(null);\n      setResultData(null);\n      setActiveEvaluationId(evaluationId);\n      activeEvaluationIdRef.current = evaluationId;\n      setShowProgressModal(true);\n      setShowNewEvalModal(false);\n      \n      const response = await apiRequest(\"/api/aev/evaluate\", {\n        method: \"POST\",\n        body: JSON.stringify({\n          evaluationId,\n          assetId: data.assetId,\n          exposureType: data.exposureType,\n          description: data.description,\n          module: data.module,\n          priority: data.priority,\n          data: {},\n        }),\n      });\n      return response;\n    },\n    onSuccess: () => {\n      setNewEvalForm({\n        assetId: \"\",\n        exposureType: \"cve\",\n        description: \"\",\n        module: \"vulnmgmt\",\n        priority: \"medium\",\n      });\n    },\n    onError: () => {\n      setShowProgressModal(false);\n      setActiveEvaluationId(null);\n      activeEvaluationIdRef.current = null;\n    },\n  });\n\n  const evaluations = aevResponse?.evaluations || [];\n\n  const filteredEvaluations = evaluations.filter((e) => {\n    if (filter === \"all\") return true;\n    if (filter === \"pending\") return e.status === \"pending\" || e.status === \"in_progress\";\n    if (filter === \"completed\") return e.status === \"completed\";\n    if (filter === \"exploitable\") return e.result?.exploitable === true;\n    if (filter === \"safe\") return e.result?.exploitable === false;\n    return true;\n  });\n\n  const sortedEvaluations = [...filteredEvaluations].sort((a, b) => {\n    let comparison = 0;\n    if (sortField === \"createdAt\") {\n      comparison = new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime();\n    } else if (sortField === \"status\") {\n      comparison = a.status.localeCompare(b.status);\n    } else if (sortField === \"priority\") {\n      const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };\n      const aPriority = (a.priority || \"medium\") as keyof typeof priorityOrder;\n      const bPriority = (b.priority || \"medium\") as keyof typeof priorityOrder;\n      comparison = priorityOrder[aPriority] - priorityOrder[bPriority];\n    }\n    return sortOrder === \"asc\" ? comparison : -comparison;\n  });\n\n  const stats = aevStats || {\n    totalEvaluations: evaluations.length,\n    activeEvaluations: evaluations.filter((e) => e.status === \"pending\" || e.status === \"in_progress\").length,\n    completedEvaluations: evaluations.filter((e) => e.status === \"completed\").length,\n    exploitableCount: evaluations.filter((e) => e.result?.exploitable).length,\n    notExploitableCount: evaluations.filter((e) => e.result?.exploitable === false).length,\n    averageConfidence: evaluations.length > 0 \n      ? Math.round(evaluations.reduce((sum, e) => sum + (e.result?.confidence || 0), 0) / evaluations.length)\n      : 0,\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"completed\": return \"bg-teal-500/10 text-teal-400 border border-teal-500/30\";\n      case \"in_progress\": return \"bg-yellow-500/10 text-yellow-400 border border-yellow-500/30\";\n      case \"pending\": return \"bg-blue-500/10 text-blue-400 border border-blue-500/30\";\n      case \"failed\": return \"bg-red-500/10 text-red-400 border border-red-500/30\";\n      default: return \"bg-muted text-muted-foreground border border-border\";\n    }\n  };\n\n  const getPriorityBadge = (priority?: string) => {\n    switch (priority) {\n      case \"critical\": return \"badge-critical\";\n      case \"high\": return \"badge-high\";\n      case \"medium\": return \"badge-medium\";\n      case \"low\": return \"badge-low\";\n      default: return \"bg-muted text-muted-foreground\";\n    }\n  };\n\n  const getExposureTypeIcon = (type: string) => {\n    switch (type) {\n      case \"cve\": return <AlertTriangle className=\"h-4 w-4 text-orange-400\" />;\n      case \"misconfiguration\": return <Shield className=\"h-4 w-4 text-blue-400\" />;\n      case \"behavior\": return <Activity className=\"h-4 w-4 text-purple-400\" />;\n      case \"network\": return <Target className=\"h-4 w-4 text-teal-400\" />;\n      default: return <Zap className=\"h-4 w-4 text-yellow-400\" />;\n    }\n  };\n\n  const getModuleLabel = (module?: string) => {\n    switch (module) {\n      case \"posture\": return \"CSPM\";\n      case \"spear\": return \"PENTEST\";\n      case \"sentinel\": return \"XDR\";\n      case \"vulnmgmt\": return \"CVE\";\n      default: return \"GENERAL\";\n    }\n  };\n\n  const toggleSort = (field: typeof sortField) => {\n    if (sortField === field) {\n      setSortOrder(sortOrder === \"asc\" ? \"desc\" : \"asc\");\n    } else {\n      setSortField(field);\n      setSortOrder(\"desc\");\n    }\n  };\n\n  const SortIcon = ({ field }: { field: typeof sortField }) => {\n    if (sortField !== field) return null;\n    return sortOrder === \"asc\" ? (\n      <ChevronUp className=\"h-3 w-3\" />\n    ) : (\n      <ChevronDown className=\"h-3 w-3\" />\n    );\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-xl font-bold text-foreground flex items-center gap-2\">\n            AEV Management\n            <span className=\"text-xs font-medium px-2 py-0.5 rounded bg-primary/10 text-primary border border-primary/30\">\n              EXPLOIT VALIDATION\n            </span>\n          </h1>\n          <p className=\"text-sm text-muted-foreground mt-0.5\">\n            Autonomous Exploit Validation evaluations and results\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <button\n            onClick={() => queryClient.invalidateQueries({ queryKey: [\"/api/aev/evaluations\"] })}\n            className=\"flex items-center gap-2 px-3 py-1.5 bg-muted hover:bg-muted/80 text-foreground rounded-md text-sm font-medium transition-colors\"\n            data-testid=\"button-refresh\"\n          >\n            <RefreshCw className=\"h-3.5 w-3.5\" />\n            Refresh\n          </button>\n          <button\n            onClick={() => setShowNewEvalModal(true)}\n            className=\"flex items-center gap-2 px-3 py-1.5 bg-primary text-primary-foreground rounded-md text-sm font-medium hover:bg-primary/90 transition-colors\"\n            data-testid=\"button-new-evaluation\"\n          >\n            <Play className=\"h-3.5 w-3.5\" />\n            Run New Evaluation\n          </button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-5 gap-4\">\n        <div className=\"stat-card\">\n          <div className=\"text-2xl font-bold text-foreground tabular-nums\">{stats.totalEvaluations}</div>\n          <div className=\"text-xs text-muted-foreground uppercase tracking-wider mt-1\">Total</div>\n        </div>\n        <div className=\"stat-card\">\n          <div className=\"text-2xl font-bold text-yellow-400 tabular-nums\">{stats.activeEvaluations}</div>\n          <div className=\"text-xs text-muted-foreground uppercase tracking-wider mt-1\">Active</div>\n        </div>\n        <div className=\"stat-card\">\n          <div className=\"text-2xl font-bold text-teal-400 tabular-nums\">{stats.completedEvaluations}</div>\n          <div className=\"text-xs text-muted-foreground uppercase tracking-wider mt-1\">Completed</div>\n        </div>\n        <div className=\"stat-card\">\n          <div className=\"text-2xl font-bold text-red-400 tabular-nums\">{stats.exploitableCount}</div>\n          <div className=\"text-xs text-muted-foreground uppercase tracking-wider mt-1\">Exploitable</div>\n        </div>\n        <div className=\"stat-card\">\n          <div className=\"text-2xl font-bold text-primary tabular-nums\">{stats.averageConfidence}%</div>\n          <div className=\"text-xs text-muted-foreground uppercase tracking-wider mt-1\">Avg Confidence</div>\n        </div>\n      </div>\n\n      <div className=\"flex items-center gap-2 flex-wrap\">\n        {[\n          { value: \"all\", label: \"All\" },\n          { value: \"pending\", label: \"Pending/Active\" },\n          { value: \"completed\", label: \"Completed\" },\n          { value: \"exploitable\", label: \"Exploitable\" },\n          { value: \"safe\", label: \"Not Exploitable\" },\n        ].map((f) => (\n          <button\n            key={f.value}\n            onClick={() => setFilter(f.value)}\n            className={`px-3 py-1.5 rounded-md text-xs font-medium transition-colors ${\n              filter === f.value\n                ? \"bg-primary text-primary-foreground\"\n                : \"bg-muted text-muted-foreground hover:text-foreground\"\n            }`}\n            data-testid={`filter-${f.value}`}\n          >\n            {f.label}\n          </button>\n        ))}\n      </div>\n\n      <div className=\"card-enterprise overflow-hidden\">\n        <div className=\"panel-header\">\n          <h2 className=\"panel-title flex items-center gap-2\">\n            <Zap className=\"h-4 w-4 text-primary\" />\n            Evaluations\n          </h2>\n          <span className=\"text-xs text-muted-foreground tabular-nums\">{sortedEvaluations.length} results</span>\n        </div>\n        \n        <div className=\"overflow-x-auto\">\n          <table className=\"w-full\">\n            <thead>\n              <tr className=\"border-b border-border bg-muted/30\">\n                <th className=\"px-4 py-3 text-left text-[10px] font-semibold uppercase tracking-wider text-muted-foreground\">\n                  Exposure\n                </th>\n                <th className=\"px-4 py-3 text-left text-[10px] font-semibold uppercase tracking-wider text-muted-foreground\">\n                  Type\n                </th>\n                <th className=\"px-4 py-3 text-left text-[10px] font-semibold uppercase tracking-wider text-muted-foreground\">\n                  Module\n                </th>\n                <th \n                  className=\"px-4 py-3 text-left text-[10px] font-semibold uppercase tracking-wider text-muted-foreground cursor-pointer hover:text-foreground transition-colors\"\n                  onClick={() => toggleSort(\"priority\")}\n                >\n                  <div className=\"flex items-center gap-1\">\n                    Severity\n                    <SortIcon field=\"priority\" />\n                  </div>\n                </th>\n                <th \n                  className=\"px-4 py-3 text-left text-[10px] font-semibold uppercase tracking-wider text-muted-foreground cursor-pointer hover:text-foreground transition-colors\"\n                  onClick={() => toggleSort(\"status\")}\n                >\n                  <div className=\"flex items-center gap-1\">\n                    Status\n                    <SortIcon field=\"status\" />\n                  </div>\n                </th>\n                <th className=\"px-4 py-3 text-left text-[10px] font-semibold uppercase tracking-wider text-muted-foreground\">\n                  Result\n                </th>\n                <th className=\"px-4 py-3 text-left text-[10px] font-semibold uppercase tracking-wider text-muted-foreground\">\n                  Score\n                </th>\n                <th \n                  className=\"px-4 py-3 text-left text-[10px] font-semibold uppercase tracking-wider text-muted-foreground cursor-pointer hover:text-foreground transition-colors\"\n                  onClick={() => toggleSort(\"createdAt\")}\n                >\n                  <div className=\"flex items-center gap-1\">\n                    Created\n                    <SortIcon field=\"createdAt\" />\n                  </div>\n                </th>\n                <th className=\"px-4 py-3 text-right text-[10px] font-semibold uppercase tracking-wider text-muted-foreground\">\n                  Actions\n                </th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y divide-border\">\n              {isLoading ? (\n                <tr>\n                  <td colSpan={9} className=\"py-12 text-center\">\n                    <Loader2 className=\"h-8 w-8 mx-auto text-muted-foreground animate-spin\" />\n                    <p className=\"text-sm text-muted-foreground mt-3\">Loading evaluations...</p>\n                  </td>\n                </tr>\n              ) : sortedEvaluations.length === 0 ? (\n                <tr>\n                  <td colSpan={9} className=\"py-12 text-center text-muted-foreground\">\n                    <Zap className=\"h-8 w-8 mx-auto opacity-30\" />\n                    <p className=\"mt-3 text-sm\">No evaluations found</p>\n                    <p className=\"text-xs mt-1\">Run a new evaluation to get started</p>\n                  </td>\n                </tr>\n              ) : (\n                sortedEvaluations.map((evaluation) => (\n                  <tr\n                    key={evaluation.id}\n                    className=\"hover:bg-muted/30 transition-colors\"\n                    data-testid={`evaluation-row-${evaluation.id}`}\n                  >\n                    <td className=\"px-4 py-3\">\n                      <div className=\"flex items-center gap-2\">\n                        {getExposureTypeIcon(evaluation.exposureType)}\n                        <span className=\"font-medium text-sm text-foreground truncate max-w-[200px]\">\n                          {evaluation.assetId}\n                        </span>\n                      </div>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <span className=\"text-xs font-mono bg-muted/50 px-2 py-0.5 rounded capitalize\">\n                        {evaluation.exposureType}\n                      </span>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <span className=\"text-[10px] font-semibold bg-primary/10 text-primary px-2 py-0.5 rounded\">\n                        {getModuleLabel(evaluation.module)}\n                      </span>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <span className={`text-[10px] font-semibold uppercase px-2 py-0.5 rounded ${getPriorityBadge(evaluation.priority)}`}>\n                        {evaluation.priority || \"medium\"}\n                      </span>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <span className={`text-[10px] font-medium px-2 py-0.5 rounded ${getStatusBadge(evaluation.status)}`}>\n                        {evaluation.status}\n                      </span>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      {evaluation.status === \"completed\" && evaluation.result ? (\n                        <div className=\"flex items-center gap-2\">\n                          {evaluation.result.exploitable ? (\n                            <>\n                              <XCircle className=\"h-4 w-4 text-red-400\" />\n                              <span className=\"text-xs font-medium text-red-400\">Exploitable</span>\n                            </>\n                          ) : (\n                            <>\n                              <CheckCircle className=\"h-4 w-4 text-teal-400\" />\n                              <span className=\"text-xs font-medium text-teal-400\">Not Exploitable</span>\n                            </>\n                          )}\n                        </div>\n                      ) : evaluation.status === \"in_progress\" ? (\n                        <div className=\"flex items-center gap-2\">\n                          <Loader2 className=\"h-4 w-4 text-yellow-400 animate-spin\" />\n                          <span className=\"text-xs text-muted-foreground\">Analyzing...</span>\n                        </div>\n                      ) : (\n                        <span className=\"text-xs text-muted-foreground\">Pending</span>\n                      )}\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      {evaluation.result?.score !== undefined ? (\n                        <div className=\"flex items-center gap-2\">\n                          <div className=\"w-16 bg-muted rounded-full h-1.5 overflow-hidden\">\n                            <div\n                              className={`h-1.5 rounded-full ${\n                                evaluation.result.score >= 70 ? \"bg-red-500\" :\n                                evaluation.result.score >= 40 ? \"bg-yellow-500\" : \"bg-teal-500\"\n                              }`}\n                              style={{ width: `${evaluation.result.score}%` }}\n                            />\n                          </div>\n                          <span className=\"text-xs font-medium tabular-nums\">{evaluation.result.score}</span>\n                        </div>\n                      ) : (\n                        <span className=\"text-xs text-muted-foreground\"></span>\n                      )}\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n                        <Clock className=\"h-3 w-3\" />\n                        {new Date(evaluation.createdAt).toLocaleDateString()}\n                      </div>\n                    </td>\n                    <td className=\"px-4 py-3 text-right\">\n                      <div className=\"flex items-center justify-end gap-2\">\n                        <button\n                          onClick={() => setSelectedEvaluation(evaluation)}\n                          className=\"text-xs font-medium text-muted-foreground hover:text-foreground transition-colors flex items-center gap-1\"\n                          data-testid={`button-quick-view-${evaluation.id}`}\n                        >\n                          <Eye className=\"h-3 w-3\" />\n                          Quick\n                        </button>\n                        <Link\n                          href={`/aev/${evaluation.id}`}\n                          className=\"text-xs font-medium text-primary hover:text-primary/80 transition-colors flex items-center gap-1\"\n                          data-testid={`link-full-details-${evaluation.id}`}\n                        >\n                          <ExternalLink className=\"h-3 w-3\" />\n                          Full Details\n                        </Link>\n                      </div>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n      {selectedEvaluation && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\n          <div className=\"bg-card border border-border rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\n            <div className=\"panel-header sticky top-0 bg-card z-10\">\n              <h3 className=\"panel-title flex items-center gap-2\">\n                <Zap className=\"h-4 w-4 text-primary\" />\n                Evaluation Details\n              </h3>\n              <button\n                onClick={() => setSelectedEvaluation(null)}\n                className=\"p-1 hover:bg-muted rounded-md transition-colors\"\n                data-testid=\"button-close-details\"\n              >\n                <X className=\"h-4 w-4\" />\n              </button>\n            </div>\n            <div className=\"p-6 space-y-6\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider\">Asset/Exposure ID</div>\n                  <div className=\"font-medium text-foreground mt-1\">{selectedEvaluation.assetId}</div>\n                </div>\n                <div>\n                  <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider\">Type</div>\n                  <div className=\"mt-1 flex items-center gap-2\">\n                    {getExposureTypeIcon(selectedEvaluation.exposureType)}\n                    <span className=\"font-medium capitalize\">{selectedEvaluation.exposureType}</span>\n                  </div>\n                </div>\n                <div>\n                  <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider\">Module</div>\n                  <div className=\"mt-1\">\n                    <span className=\"text-[10px] font-semibold bg-primary/10 text-primary px-2 py-0.5 rounded\">\n                      {getModuleLabel(selectedEvaluation.module)}\n                    </span>\n                  </div>\n                </div>\n                <div>\n                  <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider\">Priority</div>\n                  <div className=\"mt-1\">\n                    <span className={`text-[10px] font-semibold uppercase px-2 py-0.5 rounded ${getPriorityBadge(selectedEvaluation.priority)}`}>\n                      {selectedEvaluation.priority || \"medium\"}\n                    </span>\n                  </div>\n                </div>\n                <div>\n                  <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider\">Status</div>\n                  <div className=\"mt-1\">\n                    <span className={`text-[10px] font-medium px-2 py-0.5 rounded ${getStatusBadge(selectedEvaluation.status)}`}>\n                      {selectedEvaluation.status.toUpperCase()}\n                    </span>\n                  </div>\n                </div>\n                <div>\n                  <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider\">Created</div>\n                  <div className=\"font-medium text-foreground mt-1 flex items-center gap-2\">\n                    <Clock className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                    {new Date(selectedEvaluation.createdAt).toLocaleString()}\n                  </div>\n                </div>\n              </div>\n\n              {selectedEvaluation.result && (\n                <>\n                  <div className=\"border-t border-border pt-6\">\n                    <h4 className=\"text-sm font-semibold text-foreground mb-4\">Evaluation Result</h4>\n                    <div className={`p-4 rounded-lg border ${\n                      selectedEvaluation.result.exploitable \n                        ? \"bg-red-500/10 border-red-500/30\" \n                        : \"bg-teal-500/10 border-teal-500/30\"\n                    }`}>\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-3\">\n                          {selectedEvaluation.result.exploitable ? (\n                            <XCircle className=\"h-6 w-6 text-red-400\" />\n                          ) : (\n                            <CheckCircle className=\"h-6 w-6 text-teal-400\" />\n                          )}\n                          <div>\n                            <div className={`font-bold text-lg ${\n                              selectedEvaluation.result.exploitable ? \"text-red-400\" : \"text-teal-400\"\n                            }`}>\n                              {selectedEvaluation.result.exploitable ? \"Exploitable\" : \"Not Exploitable\"}\n                            </div>\n                            <div className=\"text-xs text-muted-foreground\">\n                              {selectedEvaluation.result.confidence}% confidence\n                            </div>\n                          </div>\n                        </div>\n                        <div className=\"text-right\">\n                          <div className=\"text-2xl font-bold tabular-nums\">{selectedEvaluation.result.score}</div>\n                          <div className=\"text-[10px] text-muted-foreground uppercase\">Risk Score</div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  {selectedEvaluation.result.exploitPath && selectedEvaluation.result.exploitPath.length > 0 && (\n                    <div>\n                      <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider mb-2\">Exploit Path</div>\n                      <div className=\"bg-muted/30 rounded-md p-3 space-y-1\">\n                        {selectedEvaluation.result.exploitPath.map((step, idx) => (\n                          <div key={idx} className=\"flex items-start gap-2 text-sm\">\n                            <span className=\"text-primary font-mono text-xs\">{idx + 1}.</span>\n                            <span className=\"text-foreground\">{step}</span>\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {selectedEvaluation.result.mitigations && selectedEvaluation.result.mitigations.length > 0 && (\n                    <div>\n                      <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider mb-2\">Recommended Mitigations</div>\n                      <div className=\"space-y-2\">\n                        {selectedEvaluation.result.mitigations.map((mitigation, idx) => (\n                          <div key={idx} className=\"flex items-start gap-2 text-sm bg-blue-500/10 border border-blue-500/30 rounded-md p-2\">\n                            <Shield className=\"h-4 w-4 text-blue-400 flex-shrink-0 mt-0.5\" />\n                            <span className=\"text-foreground\">{mitigation}</span>\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {selectedEvaluation.result.evidence && selectedEvaluation.result.evidence.length > 0 && (\n                    <div>\n                      <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider mb-2\">Evidence</div>\n                      <div className=\"bg-muted/50 rounded-md p-3 font-mono text-xs space-y-1 overflow-x-auto\">\n                        {selectedEvaluation.result.evidence.map((ev, idx) => (\n                          <div key={idx} className=\"text-muted-foreground\">{ev}</div>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {selectedEvaluation.result.technicalDetails && (\n                    <div>\n                      <div className=\"text-[10px] text-muted-foreground uppercase tracking-wider mb-2\">Technical Details</div>\n                      <pre className=\"bg-muted/50 rounded-md p-3 font-mono text-xs overflow-x-auto text-muted-foreground\">\n                        {JSON.stringify(selectedEvaluation.result.technicalDetails, null, 2)}\n                      </pre>\n                    </div>\n                  )}\n                </>\n              )}\n              \n              <div className=\"border-t border-border pt-4 mt-4\">\n                <Link\n                  href={`/aev/${selectedEvaluation.id}`}\n                  className=\"w-full inline-flex items-center justify-center gap-2 px-4 py-2 bg-primary/10 hover:bg-primary/20 border border-primary/30 text-primary rounded-md text-sm font-medium transition-colors\"\n                  data-testid=\"link-view-full-details\"\n                >\n                  <ExternalLink className=\"h-4 w-4\" />\n                  View Full Analysis Report\n                </Link>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {showNewEvalModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\n          <div className=\"bg-card border border-border rounded-lg w-full max-w-md\">\n            <div className=\"panel-header\">\n              <h3 className=\"panel-title flex items-center gap-2\">\n                <Play className=\"h-4 w-4 text-primary\" />\n                New AEV Evaluation\n              </h3>\n              <button\n                onClick={() => setShowNewEvalModal(false)}\n                className=\"p-1 hover:bg-muted rounded-md transition-colors\"\n                data-testid=\"button-close-new-eval\"\n              >\n                <X className=\"h-4 w-4\" />\n              </button>\n            </div>\n            <div className=\"p-6 space-y-4\">\n              <div>\n                <label className=\"text-[10px] text-muted-foreground uppercase tracking-wider block mb-1\">\n                  Asset / Exposure ID *\n                </label>\n                <input\n                  type=\"text\"\n                  value={newEvalForm.assetId}\n                  onChange={(e) => setNewEvalForm({ ...newEvalForm, assetId: e.target.value })}\n                  placeholder=\"Enter asset or CVE ID...\"\n                  className=\"w-full px-3 py-2 bg-muted/30 border border-border rounded-md text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-primary\"\n                  data-testid=\"input-asset-id\"\n                />\n              </div>\n              <div>\n                <label className=\"text-[10px] text-muted-foreground uppercase tracking-wider block mb-1\">\n                  Description *\n                </label>\n                <textarea\n                  value={newEvalForm.description}\n                  onChange={(e) => setNewEvalForm({ ...newEvalForm, description: e.target.value })}\n                  placeholder=\"Describe the exposure...\"\n                  rows={3}\n                  className=\"w-full px-3 py-2 bg-muted/30 border border-border rounded-md text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-primary resize-none\"\n                  data-testid=\"input-description\"\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"text-[10px] text-muted-foreground uppercase tracking-wider block mb-1\">\n                    Exposure Type\n                  </label>\n                  <select\n                    value={newEvalForm.exposureType}\n                    onChange={(e) => setNewEvalForm({ ...newEvalForm, exposureType: e.target.value as any })}\n                    className=\"w-full px-3 py-2 bg-muted/30 border border-border rounded-md text-foreground focus:outline-none focus:ring-1 focus:ring-primary\"\n                    data-testid=\"select-exposure-type\"\n                  >\n                    <option value=\"cve\">CVE</option>\n                    <option value=\"misconfiguration\">Misconfiguration</option>\n                    <option value=\"behavior\">Behavior</option>\n                    <option value=\"network\">Network</option>\n                    <option value=\"custom\">Custom</option>\n                  </select>\n                </div>\n                <div>\n                  <label className=\"text-[10px] text-muted-foreground uppercase tracking-wider block mb-1\">\n                    Module\n                  </label>\n                  <select\n                    value={newEvalForm.module}\n                    onChange={(e) => setNewEvalForm({ ...newEvalForm, module: e.target.value as any })}\n                    className=\"w-full px-3 py-2 bg-muted/30 border border-border rounded-md text-foreground focus:outline-none focus:ring-1 focus:ring-primary\"\n                    data-testid=\"select-module\"\n                  >\n                    <option value=\"vulnmgmt\">Vulnerability Management</option>\n                    <option value=\"posture\">Posture (CSPM)</option>\n                    <option value=\"spear\">Spear (Pentest)</option>\n                    <option value=\"sentinel\">Sentinel (XDR)</option>\n                  </select>\n                </div>\n              </div>\n              <div>\n                <label className=\"text-[10px] text-muted-foreground uppercase tracking-wider block mb-1\">\n                  Priority\n                </label>\n                <div className=\"grid grid-cols-4 gap-2\">\n                  {([\"low\", \"medium\", \"high\", \"critical\"] as const).map((priority) => (\n                    <button\n                      key={priority}\n                      type=\"button\"\n                      onClick={() => setNewEvalForm({ ...newEvalForm, priority })}\n                      className={`px-3 py-1.5 rounded-md text-xs font-medium transition-colors capitalize ${\n                        newEvalForm.priority === priority\n                          ? getPriorityBadge(priority)\n                          : \"bg-muted text-muted-foreground hover:text-foreground\"\n                      }`}\n                      data-testid={`priority-${priority}`}\n                    >\n                      {priority}\n                    </button>\n                  ))}\n                </div>\n              </div>\n              <div className=\"flex gap-2 pt-4\">\n                <button\n                  onClick={() => setShowNewEvalModal(false)}\n                  className=\"flex-1 px-3 py-2 bg-muted text-foreground rounded-md text-sm font-medium hover:bg-muted/80 transition-colors\"\n                  data-testid=\"button-cancel-eval\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={() => newEvaluationMutation.mutate(newEvalForm)}\n                  disabled={!newEvalForm.assetId.trim() || !newEvalForm.description.trim() || newEvaluationMutation.isPending}\n                  className=\"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-primary text-primary-foreground rounded-md text-sm font-medium hover:bg-primary/90 transition-colors disabled:opacity-50\"\n                  data-testid=\"button-submit-eval\"\n                >\n                  {newEvaluationMutation.isPending ? (\n                    <Loader2 className=\"h-4 w-4 animate-spin\" />\n                  ) : (\n                    <>\n                      <Play className=\"h-4 w-4\" />\n                      Start Evaluation\n                    </>\n                  )}\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      <AEVProgressModal\n        isOpen={showProgressModal}\n        onClose={handleCloseProgressModal}\n        evaluationId={activeEvaluationId}\n        progress={progressData}\n        result={resultData}\n        assetId={activeAssetId}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":38245,"size_tokens":null},"client/src/components/examples/ExploitabilityGauge.tsx":{"content":"import { ExploitabilityGauge } from \"../ExploitabilityGauge\";\n\nexport default function ExploitabilityGaugeExample() {\n  return (\n    <div className=\"flex gap-8 p-6 justify-center\">\n      <div className=\"bg-card p-6 rounded-lg border border-border\">\n        <ExploitabilityGauge score={87} confidence={0.92} size=\"md\" />\n      </div>\n      <div className=\"bg-card p-6 rounded-lg border border-border\">\n        <ExploitabilityGauge score={45} confidence={0.78} size=\"md\" />\n      </div>\n      <div className=\"bg-card p-6 rounded-lg border border-border\">\n        <ExploitabilityGauge score={15} confidence={0.95} size=\"md\" />\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":655,"size_tokens":null},"attached_assets/AEVDetailPage_1765772491190.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { useRoute, Link } from \"wouter\";\nimport { useAuth } from \"../lib/auth\";\nimport {\n  Shield,\n  AlertTriangle,\n  CheckCircle,\n  XCircle,\n  ArrowLeft,\n  Activity,\n  Clock,\n  FileText,\n  ChevronRight,\n  Loader2,\n  AlertCircle,\n  Lightbulb,\n  Route as RouteIcon,\n  BarChart3,\n  ShieldCheck,\n  ShieldAlert,\n  Wrench,\n} from \"lucide-react\";\n\ninterface EvaluationInput {\n  assetId: string;\n  exposureType: string;\n  description: string;\n  module?: string;\n  priority?: string;\n}\n\ninterface EvaluationResult {\n  evaluationId: string;\n  exploitable: boolean;\n  confidence: number;\n  attackPath: string[];\n  impact: string;\n  recommendedFix: string;\n  score: number;\n  status: string;\n  error?: string;\n  duration?: number;\n  completedAt?: string;\n}\n\ninterface EvaluationDetail {\n  id: string;\n  input: EvaluationInput;\n  status: string;\n  result?: EvaluationResult;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport default function AEVDetailPage() {\n  const { token } = useAuth();\n  const [, params] = useRoute(\"/aev/:id\");\n  const evaluationId = params?.id;\n\n  const { data: evaluation, isLoading, error } = useQuery<EvaluationDetail>({\n    queryKey: [`/api/aev/evaluations/${evaluationId}`],\n    enabled: !!evaluationId && !!token,\n    retry: 1,\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\" data-testid=\"loading-state\">\n        <div className=\"flex flex-col items-center gap-4\">\n          <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\n          <p className=\"text-muted-foreground\">Loading evaluation details...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (error || !evaluation) {\n    return (\n      <div className=\"min-h-screen p-6\">\n        <Link href=\"/aev\" className=\"inline-flex items-center gap-2 text-muted-foreground hover:text-foreground mb-6\">\n          <ArrowLeft className=\"w-4 h-4\" />\n          Back to AEV Dashboard\n        </Link>\n        <div className=\"flex flex-col items-center justify-center py-20\" data-testid=\"error-state\">\n          <AlertCircle className=\"w-12 h-12 text-destructive mb-4\" />\n          <h2 className=\"text-xl font-semibold text-foreground mb-2\">Evaluation Not Found</h2>\n          <p className=\"text-muted-foreground\">The requested evaluation could not be found or you don't have access to it.</p>\n        </div>\n      </div>\n    );\n  }\n\n  const { input, result, status, createdAt } = evaluation;\n  const isCompleted = status === \"completed\" && result;\n  const isFailed = status === \"failed\";\n  const isPending = status === \"pending\" || status === \"in_progress\";\n\n  const getSeverityColor = (priority?: string) => {\n    switch (priority) {\n      case \"critical\": return \"text-red-400 bg-red-500/10 border-red-500/30\";\n      case \"high\": return \"text-orange-400 bg-orange-500/10 border-orange-500/30\";\n      case \"medium\": return \"text-yellow-400 bg-yellow-500/10 border-yellow-500/30\";\n      case \"low\": return \"text-teal-400 bg-teal-500/10 border-teal-500/30\";\n      default: return \"text-muted-foreground bg-muted/10 border-border\";\n    }\n  };\n\n  const getModuleLabel = (module?: string) => {\n    switch (module) {\n      case \"posture\": return \"OdinPosture\";\n      case \"spear\": return \"OdinSpear\";\n      case \"sentinel\": return \"OdinSentinel\";\n      case \"vulnmgmt\": return \"Vulnerability Management\";\n      default: return \"Unknown\";\n    }\n  };\n\n  const getExposureTypeLabel = (type: string) => {\n    switch (type) {\n      case \"cve\": return \"CVE\";\n      case \"misconfiguration\": return \"Misconfiguration\";\n      case \"behavior\": return \"Behavioral\";\n      case \"network\": return \"Network\";\n      case \"custom\": return \"Custom\";\n      default: return type;\n    }\n  };\n\n  const getExploitabilityLevel = (score: number) => {\n    if (score >= 80) return { level: \"Critical\", color: \"text-red-400\", bgColor: \"bg-red-500/10\" };\n    if (score >= 60) return { level: \"High\", color: \"text-orange-400\", bgColor: \"bg-orange-500/10\" };\n    if (score >= 40) return { level: \"Medium\", color: \"text-yellow-400\", bgColor: \"bg-yellow-500/10\" };\n    if (score >= 20) return { level: \"Low\", color: \"text-teal-400\", bgColor: \"bg-teal-500/10\" };\n    return { level: \"Minimal\", color: \"text-green-400\", bgColor: \"bg-green-500/10\" };\n  };\n\n  const getConfidenceLevel = (confidence: number) => {\n    if (confidence >= 0.9) return { level: \"Very High\", color: \"text-green-400\" };\n    if (confidence >= 0.75) return { level: \"High\", color: \"text-teal-400\" };\n    if (confidence >= 0.5) return { level: \"Medium\", color: \"text-yellow-400\" };\n    if (confidence >= 0.25) return { level: \"Low\", color: \"text-orange-400\" };\n    return { level: \"Very Low\", color: \"text-red-400\" };\n  };\n\n  return (\n    <div className=\"min-h-screen p-6 space-y-6\" data-testid=\"aev-detail-page\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Link \n            href=\"/aev\" \n            className=\"inline-flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors\"\n            data-testid=\"back-link\"\n          >\n            <ArrowLeft className=\"w-4 h-4\" />\n          </Link>\n          <div>\n            <div className=\"flex items-center gap-3\">\n              <h1 className=\"text-2xl font-bold text-foreground\" data-testid=\"evaluation-title\">\n                AEV Evaluation\n              </h1>\n              <span className={`px-2 py-0.5 rounded text-xs font-medium border ${\n                isCompleted && result?.exploitable \n                  ? \"bg-red-500/10 text-red-400 border-red-500/30\"\n                  : isCompleted && !result?.exploitable\n                  ? \"bg-teal-500/10 text-teal-400 border-teal-500/30\"\n                  : isPending\n                  ? \"bg-yellow-500/10 text-yellow-400 border-yellow-500/30\"\n                  : isFailed\n                  ? \"bg-red-500/10 text-red-400 border-red-500/30\"\n                  : \"bg-muted text-muted-foreground border-border\"\n              }`} data-testid=\"status-badge\">\n                {isCompleted && result?.exploitable ? \"EXPLOITABLE\" : \n                 isCompleted && !result?.exploitable ? \"NOT EXPLOITABLE\" :\n                 isPending ? \"IN PROGRESS\" : \n                 isFailed ? \"FAILED\" : status.toUpperCase()}\n              </span>\n            </div>\n            <p className=\"text-sm text-muted-foreground mt-1\" data-testid=\"evaluation-id\">\n              ID: {evaluation.id}\n            </p>\n          </div>\n        </div>\n        <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n          <div className=\"flex items-center gap-2\">\n            <Clock className=\"w-4 h-4\" />\n            <span data-testid=\"created-at\">Created: {new Date(createdAt).toLocaleString()}</span>\n          </div>\n          {result?.duration && (\n            <div className=\"flex items-center gap-2\">\n              <Activity className=\"w-4 h-4\" />\n              <span data-testid=\"duration\">Duration: {(result.duration / 1000).toFixed(1)}s</span>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Main Content Grid */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Left Column - Exposure Summary and Attack Path */}\n        <div className=\"lg:col-span-2 space-y-6\">\n          {/* Section 1: Exposure Summary */}\n          <div className=\"bg-card border border-border rounded-lg overflow-hidden\" data-testid=\"exposure-summary-section\">\n            <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 rounded-lg bg-primary/10\">\n                  <FileText className=\"w-5 h-5 text-primary\" />\n                </div>\n                <h2 className=\"text-lg font-semibold text-foreground\">Exposure Summary</h2>\n              </div>\n            </div>\n            <div className=\"p-6 space-y-6\">\n              <div className=\"grid grid-cols-2 gap-6\">\n                <div>\n                  <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-1 block\">Asset ID</label>\n                  <p className=\"text-foreground font-mono text-sm\" data-testid=\"asset-id\">{input.assetId}</p>\n                </div>\n                <div>\n                  <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-1 block\">Exposure Type</label>\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"px-2 py-1 bg-blue-500/10 text-blue-400 border border-blue-500/30 rounded text-xs font-medium\" data-testid=\"exposure-type\">\n                      {getExposureTypeLabel(input.exposureType)}\n                    </span>\n                  </div>\n                </div>\n                <div>\n                  <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-1 block\">Severity</label>\n                  <span className={`inline-flex px-2 py-1 rounded text-xs font-medium border ${getSeverityColor(input.priority)}`} data-testid=\"severity\">\n                    {(input.priority || \"medium\").toUpperCase()}\n                  </span>\n                </div>\n                <div>\n                  <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-1 block\">Source Module</label>\n                  <div className=\"flex items-center gap-2\">\n                    <Shield className=\"w-4 h-4 text-primary\" />\n                    <span className=\"text-foreground\" data-testid=\"source-module\">{getModuleLabel(input.module)}</span>\n                  </div>\n                </div>\n              </div>\n              <div>\n                <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-2 block\">Description</label>\n                <p className=\"text-muted-foreground leading-relaxed\" data-testid=\"description\">{input.description}</p>\n              </div>\n            </div>\n          </div>\n\n          {/* Section 3: Attack Path Summary */}\n          <div className=\"bg-card border border-border rounded-lg overflow-hidden\" data-testid=\"attack-path-section\">\n            <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 rounded-lg bg-orange-500/10\">\n                  <RouteIcon className=\"w-5 h-5 text-orange-400\" />\n                </div>\n                <h2 className=\"text-lg font-semibold text-foreground\">Attack Path</h2>\n              </div>\n            </div>\n            <div className=\"p-6\">\n              {isPending ? (\n                <div className=\"flex items-center justify-center py-8 text-muted-foreground\">\n                  <Loader2 className=\"w-5 h-5 animate-spin mr-2\" />\n                  <span>Analyzing attack vectors...</span>\n                </div>\n              ) : isFailed ? (\n                <div className=\"flex items-center justify-center py-8 text-red-400\">\n                  <AlertCircle className=\"w-5 h-5 mr-2\" />\n                  <span>Failed to determine attack path</span>\n                </div>\n              ) : result?.attackPath && result.attackPath.length > 0 ? (\n                <div className=\"space-y-4\">\n                  {result.attackPath.map((step, index) => (\n                    <div key={index} className=\"flex items-start gap-4\" data-testid={`attack-step-${index}`}>\n                      <div className=\"flex flex-col items-center\">\n                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${\n                          result.exploitable \n                            ? \"bg-red-500/20 text-red-400 border border-red-500/30\" \n                            : \"bg-teal-500/20 text-teal-400 border border-teal-500/30\"\n                        }`}>\n                          {index + 1}\n                        </div>\n                        {index < result.attackPath.length - 1 && (\n                          <div className={`w-0.5 h-8 mt-2 ${result.exploitable ? \"bg-red-500/30\" : \"bg-teal-500/30\"}`} />\n                        )}\n                      </div>\n                      <div className=\"flex-1 pt-1\">\n                        <p className=\"text-foreground\">{step}</p>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"flex flex-col items-center justify-center py-8 text-muted-foreground\">\n                  <ShieldCheck className=\"w-12 h-12 text-teal-400 mb-3\" />\n                  <p className=\"font-medium text-teal-400\">No Attack Path Identified</p>\n                  <p className=\"text-sm mt-1\">This exposure does not have a viable attack chain.</p>\n                </div>\n              )}\n            </div>\n          </div>\n\n          {/* Impact Summary */}\n          {result?.impact && (\n            <div className=\"bg-card border border-border rounded-lg overflow-hidden\" data-testid=\"impact-section\">\n              <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-red-500/10\">\n                    <AlertTriangle className=\"w-5 h-5 text-red-400\" />\n                  </div>\n                  <h2 className=\"text-lg font-semibold text-foreground\">Impact Assessment</h2>\n                </div>\n              </div>\n              <div className=\"p-6\">\n                <p className=\"text-foreground leading-relaxed\" data-testid=\"impact-text\">{result.impact}</p>\n              </div>\n            </div>\n          )}\n        </div>\n\n        {/* Right Column - Scores and Recommendations */}\n        <div className=\"space-y-6\">\n          {/* Section 2: Exploitability Scores */}\n          <div className=\"bg-card border border-border rounded-lg overflow-hidden\" data-testid=\"scores-section\">\n            <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 rounded-lg bg-primary/10\">\n                  <BarChart3 className=\"w-5 h-5 text-primary\" />\n                </div>\n                <h2 className=\"text-lg font-semibold text-foreground\">Exploitability Scores</h2>\n              </div>\n            </div>\n            <div className=\"p-6 space-y-6\">\n              {isPending ? (\n                <div className=\"flex items-center justify-center py-8 text-muted-foreground\">\n                  <Loader2 className=\"w-5 h-5 animate-spin mr-2\" />\n                  <span>Calculating scores...</span>\n                </div>\n              ) : isFailed ? (\n                <div className=\"flex items-center justify-center py-8 text-red-400\">\n                  <XCircle className=\"w-5 h-5 mr-2\" />\n                  <span>Scoring failed</span>\n                </div>\n              ) : result ? (\n                <>\n                  {/* Main Exploitability Score */}\n                  <div className=\"text-center\">\n                    <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-3 block\">Exploitability Score</label>\n                    <div className={`inline-flex items-center justify-center w-24 h-24 rounded-full ${\n                      getExploitabilityLevel(result.score).bgColor\n                    } border-4 border-current`}>\n                      <div>\n                        <span className={`text-3xl font-bold ${getExploitabilityLevel(result.score).color}`} data-testid=\"exploit-score\">\n                          {Math.round(result.score)}\n                        </span>\n                      </div>\n                    </div>\n                    <p className={`mt-2 font-medium ${getExploitabilityLevel(result.score).color}`} data-testid=\"exploit-level\">\n                      {getExploitabilityLevel(result.score).level} Risk\n                    </p>\n                  </div>\n\n                  {/* Confidence */}\n                  <div>\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <label className=\"text-xs uppercase tracking-wider text-muted-foreground\">Confidence</label>\n                      <span className={`text-sm font-medium ${getConfidenceLevel(result.confidence).color}`} data-testid=\"confidence-level\">\n                        {getConfidenceLevel(result.confidence).level}\n                      </span>\n                    </div>\n                    <div className=\"h-2 bg-muted rounded-full overflow-hidden\">\n                      <div \n                        className={`h-full rounded-full transition-all duration-500 ${\n                          result.confidence >= 0.75 ? \"bg-teal-400\" :\n                          result.confidence >= 0.5 ? \"bg-yellow-400\" : \"bg-orange-400\"\n                        }`}\n                        style={{ width: `${result.confidence * 100}%` }}\n                        data-testid=\"confidence-bar\"\n                      />\n                    </div>\n                    <p className=\"text-right text-sm text-muted-foreground mt-1\" data-testid=\"confidence-value\">\n                      {Math.round(result.confidence * 100)}%\n                    </p>\n                  </div>\n\n                  {/* Exploitable Status */}\n                  <div className=\"flex items-center justify-between p-4 rounded-lg bg-muted/30 border border-border\">\n                    <span className=\"text-sm text-muted-foreground\">Exploitable</span>\n                    <div className=\"flex items-center gap-2\" data-testid=\"exploitable-status\">\n                      {result.exploitable ? (\n                        <>\n                          <ShieldAlert className=\"w-5 h-5 text-red-400\" />\n                          <span className=\"font-medium text-red-400\">Yes</span>\n                        </>\n                      ) : (\n                        <>\n                          <ShieldCheck className=\"w-5 h-5 text-teal-400\" />\n                          <span className=\"font-medium text-teal-400\">No</span>\n                        </>\n                      )}\n                    </div>\n                  </div>\n                </>\n              ) : null}\n            </div>\n          </div>\n\n          {/* Section 4: Recommendations */}\n          <div className=\"bg-card border border-border rounded-lg overflow-hidden\" data-testid=\"recommendations-section\">\n            <div className=\"px-6 py-4 border-b border-border bg-muted/30\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 rounded-lg bg-teal-500/10\">\n                  <Lightbulb className=\"w-5 h-5 text-teal-400\" />\n                </div>\n                <h2 className=\"text-lg font-semibold text-foreground\">Recommendations</h2>\n              </div>\n            </div>\n            <div className=\"p-6 space-y-6\">\n              {isPending ? (\n                <div className=\"flex items-center justify-center py-8 text-muted-foreground\">\n                  <Loader2 className=\"w-5 h-5 animate-spin mr-2\" />\n                  <span>Generating recommendations...</span>\n                </div>\n              ) : isFailed ? (\n                <div className=\"flex items-center justify-center py-8 text-red-400\">\n                  <AlertCircle className=\"w-5 h-5 mr-2\" />\n                  <span>Unable to generate recommendations</span>\n                </div>\n              ) : result?.recommendedFix ? (\n                <>\n                  {/* Primary Remediation */}\n                  <div>\n                    <div className=\"flex items-center gap-2 mb-3\">\n                      <Wrench className=\"w-4 h-4 text-teal-400\" />\n                      <label className=\"text-xs uppercase tracking-wider text-teal-400 font-medium\">Remediation Steps</label>\n                    </div>\n                    <div className=\"p-4 bg-muted/30 rounded-lg border border-border\">\n                      <p className=\"text-foreground leading-relaxed\" data-testid=\"remediation-text\">{result.recommendedFix}</p>\n                    </div>\n                  </div>\n\n                  {/* Compensating Controls */}\n                  {result.exploitable && (\n                    <div>\n                      <div className=\"flex items-center gap-2 mb-3\">\n                        <Shield className=\"w-4 h-4 text-yellow-400\" />\n                        <label className=\"text-xs uppercase tracking-wider text-yellow-400 font-medium\">Compensating Controls</label>\n                      </div>\n                      <ul className=\"space-y-2\" data-testid=\"compensating-controls\">\n                        <li className=\"flex items-start gap-2 p-3 bg-muted/30 rounded-lg border border-border\">\n                          <ChevronRight className=\"w-4 h-4 text-yellow-400 mt-0.5 flex-shrink-0\" />\n                          <span className=\"text-sm text-muted-foreground\">Implement network segmentation to limit lateral movement</span>\n                        </li>\n                        <li className=\"flex items-start gap-2 p-3 bg-muted/30 rounded-lg border border-border\">\n                          <ChevronRight className=\"w-4 h-4 text-yellow-400 mt-0.5 flex-shrink-0\" />\n                          <span className=\"text-sm text-muted-foreground\">Enable enhanced monitoring and alerting for suspicious activity</span>\n                        </li>\n                        <li className=\"flex items-start gap-2 p-3 bg-muted/30 rounded-lg border border-border\">\n                          <ChevronRight className=\"w-4 h-4 text-yellow-400 mt-0.5 flex-shrink-0\" />\n                          <span className=\"text-sm text-muted-foreground\">Review and restrict access permissions for affected systems</span>\n                        </li>\n                      </ul>\n                    </div>\n                  )}\n\n                  {/* Priority Banner */}\n                  {result.exploitable && (\n                    <div className={`p-4 rounded-lg border ${\n                      input.priority === \"critical\" \n                        ? \"bg-red-500/10 border-red-500/30\" \n                        : input.priority === \"high\"\n                        ? \"bg-orange-500/10 border-orange-500/30\"\n                        : \"bg-yellow-500/10 border-yellow-500/30\"\n                    }`} data-testid=\"priority-banner\">\n                      <div className=\"flex items-center gap-2\">\n                        <AlertTriangle className={`w-4 h-4 ${\n                          input.priority === \"critical\" \n                            ? \"text-red-400\" \n                            : input.priority === \"high\"\n                            ? \"text-orange-400\"\n                            : \"text-yellow-400\"\n                        }`} />\n                        <span className={`text-sm font-medium ${\n                          input.priority === \"critical\" \n                            ? \"text-red-400\" \n                            : input.priority === \"high\"\n                            ? \"text-orange-400\"\n                            : \"text-yellow-400\"\n                        }`}>\n                          {input.priority === \"critical\" \n                            ? \"Immediate action required\" \n                            : input.priority === \"high\"\n                            ? \"Address within 24-48 hours\"\n                            : \"Schedule for remediation\"}\n                        </span>\n                      </div>\n                    </div>\n                  )}\n                </>\n              ) : (\n                <div className=\"flex flex-col items-center justify-center py-8 text-muted-foreground\">\n                  <CheckCircle className=\"w-12 h-12 text-teal-400 mb-3\" />\n                  <p className=\"font-medium text-teal-400\">No Action Required</p>\n                  <p className=\"text-sm mt-1 text-center\">This exposure does not require immediate remediation.</p>\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":24060,"size_tokens":null},"client/src/components/ProgressModal.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport {\n  Search,\n  Crosshair,\n  Network,\n  Workflow,\n  TrendingUp,\n  CheckCircle,\n  Loader2,\n  X,\n  Target,\n  Brain,\n  AlertTriangle,\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface Stage {\n  id: number;\n  name: string;\n  agentKey: string;\n  description: string;\n  icon: typeof Search;\n}\n\nconst stages: Stage[] = [\n  {\n    id: 1,\n    name: \"Recon Agent\",\n    agentKey: \"recon\",\n    description: \"Mapping attack surface, entry points, and reconnaissance\",\n    icon: Search,\n  },\n  {\n    id: 2,\n    name: \"Exploit Agent\",\n    agentKey: \"exploit\",\n    description: \"Analyzing CVEs, exploit chains, and misconfigurations\",\n    icon: Crosshair,\n  },\n  {\n    id: 3,\n    name: \"Lateral Movement Agent\",\n    agentKey: \"lateral\",\n    description: \"Identifying pivot paths and privilege escalation\",\n    icon: Network,\n  },\n  {\n    id: 4,\n    name: \"Business Logic Agent\",\n    agentKey: \"business_logic\",\n    description: \"Detecting workflow abuse and authorization bypass\",\n    icon: Workflow,\n  },\n  {\n    id: 5,\n    name: \"Impact Agent\",\n    agentKey: \"impact\",\n    description: \"Assessing data exposure and financial risk\",\n    icon: TrendingUp,\n  },\n];\n\ninterface ProgressModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  assetId: string;\n  evaluationId: string;\n  progressData?: { agentName?: string; stage: string; progress: number; message: string } | null;\n}\n\nexport function ProgressModal({ isOpen, onClose, assetId, evaluationId, progressData }: ProgressModalProps) {\n  const [progress, setProgress] = useState(0);\n  const [currentAgentKey, setCurrentAgentKey] = useState(\"recon\");\n  const [currentAgentName, setCurrentAgentName] = useState(\"Recon Agent\");\n  const [stageMessage, setStageMessage] = useState(\"Initializing AI agents...\");\n  const [isComplete, setIsComplete] = useState(false);\n  const [lastUpdateTime, setLastUpdateTime] = useState<number>(Date.now());\n  const [isStuck, setIsStuck] = useState(false);\n\n  useEffect(() => {\n    if (!isOpen) {\n      setProgress(0);\n      setCurrentAgentKey(\"recon\");\n      setCurrentAgentName(\"Recon Agent\");\n      setIsComplete(false);\n      setStageMessage(\"Initializing AI agents...\");\n      setLastUpdateTime(Date.now());\n      setIsStuck(false);\n      return;\n    }\n  }, [isOpen]);\n\n  useEffect(() => {\n    if (!isOpen || isComplete) return;\n    \n    const checkStuck = setInterval(() => {\n      const timeSinceUpdate = Date.now() - lastUpdateTime;\n      if (timeSinceUpdate > 60000) {\n        setIsStuck(true);\n      }\n    }, 5000);\n    \n    return () => clearInterval(checkStuck);\n  }, [isOpen, isComplete, lastUpdateTime]);\n\n  useEffect(() => {\n    if (progressData) {\n      setProgress(progressData.progress);\n      setStageMessage(progressData.message);\n      setCurrentAgentKey(progressData.stage);\n      setLastUpdateTime(Date.now());\n      setIsStuck(false);\n      if (progressData.agentName) {\n        setCurrentAgentName(progressData.agentName);\n      }\n      \n      if (progressData.progress >= 100 || progressData.stage === \"complete\") {\n        setIsComplete(true);\n      }\n    }\n  }, [progressData]);\n\n  if (!isOpen) return null;\n\n  const getStageStatus = (stage: Stage): \"pending\" | \"active\" | \"complete\" => {\n    const stageIndex = stages.findIndex(s => s.agentKey === stage.agentKey);\n    const currentIndex = stages.findIndex(s => s.agentKey === currentAgentKey);\n    \n    if (currentAgentKey === \"synthesis\" || currentAgentKey === \"complete\") {\n      return \"complete\";\n    }\n    if (stageIndex < currentIndex) return \"complete\";\n    if (stageIndex === currentIndex) return \"active\";\n    return \"pending\";\n  };\n\n  return (\n    <div className=\"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4\">\n      <div \n        className=\"bg-card border border-border rounded-xl w-full max-w-lg shadow-2xl overflow-hidden\"\n        data-testid=\"progress-modal\"\n      >\n        <div className=\"bg-gradient-to-r from-cyan-600/20 via-blue-600/20 to-purple-600/20 border-b border-border p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"relative\">\n                <div className=\"absolute inset-0 bg-gradient-to-r from-cyan-500 to-purple-500 blur-lg opacity-50 animate-pulse\" />\n                <div className=\"relative p-2 bg-gradient-to-br from-cyan-500 via-blue-500 to-purple-500 rounded-lg\">\n                  <Brain className=\"h-5 w-5 text-white\" />\n                </div>\n              </div>\n              <div>\n                <h3 className=\"font-semibold text-foreground\">Multi-Agent Validation</h3>\n                <p className=\"text-xs text-muted-foreground font-mono\">{assetId}</p>\n              </div>\n            </div>\n            {(isComplete || isStuck) && (\n              <Button variant=\"ghost\" size=\"icon\" onClick={onClose} data-testid=\"button-close-progress\">\n                <X className=\"h-4 w-4\" />\n              </Button>\n            )}\n          </div>\n        </div>\n\n        <div className=\"p-6\">\n          {!isComplete ? (\n            <>\n              <div className=\"mb-6\">\n                <div className=\"flex justify-between text-sm mb-2 gap-2 flex-wrap\">\n                  <span className=\"text-muted-foreground\">Active: <span className=\"text-cyan-400 font-medium\">{currentAgentName}</span></span>\n                  <span className=\"font-mono text-foreground\">{Math.round(progress)}%</span>\n                </div>\n                <div className=\"h-2 bg-muted rounded-full overflow-hidden\">\n                  <div\n                    className=\"h-full bg-gradient-to-r from-cyan-500 via-blue-500 to-purple-500 transition-all duration-300 ease-out\"\n                    style={{ width: `${progress}%` }}\n                  />\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                {stages.map((stage) => {\n                  const status = getStageStatus(stage);\n                  const Icon = stage.icon;\n                  \n                  return (\n                    <div\n                      key={stage.id}\n                      className={`flex items-start gap-3 p-2.5 rounded-lg border transition-all duration-300 ${\n                        status === \"active\"\n                          ? \"bg-gradient-to-r from-cyan-500/10 to-blue-500/10 border-cyan-500/30\"\n                          : status === \"complete\"\n                          ? \"bg-emerald-500/10 border-emerald-500/30\"\n                          : \"bg-muted/30 border-border opacity-50\"\n                      }`}\n                      data-testid={`stage-${stage.agentKey}`}\n                    >\n                      <div className={`p-1.5 rounded-lg flex-shrink-0 ${\n                        status === \"active\"\n                          ? \"bg-gradient-to-br from-cyan-500/20 to-blue-500/20\"\n                          : status === \"complete\"\n                          ? \"bg-emerald-500/20\"\n                          : \"bg-muted\"\n                      }`}>\n                        {status === \"active\" ? (\n                          <Loader2 className=\"h-4 w-4 text-cyan-400 animate-spin\" />\n                        ) : status === \"complete\" ? (\n                          <CheckCircle className=\"h-4 w-4 text-emerald-400\" />\n                        ) : (\n                          <Icon className=\"h-4 w-4 text-muted-foreground\" />\n                        )}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2 flex-wrap\">\n                          <span className={`text-sm font-medium ${\n                            status === \"pending\" ? \"text-muted-foreground\" : \"text-foreground\"\n                          }`}>\n                            {stage.name}\n                          </span>\n                          {status === \"active\" && (\n                            <span className=\"text-[10px] font-medium text-cyan-400 bg-cyan-500/20 px-1.5 py-0.5 rounded\">\n                              ACTIVE\n                            </span>\n                          )}\n                        </div>\n                        <p className=\"text-xs text-muted-foreground mt-0.5 truncate\">\n                          {status === \"active\" ? stageMessage : stage.description}\n                        </p>\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n\n              {isStuck && (\n                <div className=\"mt-4 p-3 bg-amber-500/10 rounded-lg border border-amber-500/30\">\n                  <div className=\"flex items-center gap-2 text-sm\">\n                    <AlertTriangle className=\"h-4 w-4 text-amber-400 flex-shrink-0\" />\n                    <span className=\"text-amber-400\">Evaluation appears stuck. You can close this and check results later.</span>\n                  </div>\n                </div>\n              )}\n\n              <div className=\"mt-4 p-3 bg-muted/30 rounded-lg border border-border\">\n                <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                  <Target className=\"h-3.5 w-3.5 text-cyan-400 animate-pulse flex-shrink-0\" />\n                  <span className=\"font-mono truncate\">{stageMessage}</span>\n                </div>\n              </div>\n            </>\n          ) : (\n            <div className=\"space-y-4\">\n              <div className=\"p-4 rounded-lg border bg-emerald-500/10 border-emerald-500/30\">\n                <div className=\"flex items-center gap-3\">\n                  <CheckCircle className=\"h-8 w-8 text-emerald-400 flex-shrink-0\" />\n                  <div>\n                    <h4 className=\"font-semibold text-lg\">Analysis Complete</h4>\n                    <p className=\"text-sm text-muted-foreground\">\n                      All 5 AI agents finished validation\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              <Button\n                onClick={onClose}\n                className=\"w-full bg-gradient-to-r from-cyan-600 to-blue-600\"\n                data-testid=\"button-view-details\"\n              >\n                View Full Analysis\n              </Button>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10371,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"client/src/components/MultiVectorFindingsPanel.tsx":{"content":"import { Cloud, Key, Users, Globe, Server, ArrowRight } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card } from \"@/components/ui/card\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\nimport type { MultiVectorFinding } from \"@shared/schema\";\n\ninterface MultiVectorFindingsPanelProps {\n  findings: MultiVectorFinding[];\n}\n\nconst vectorIcons: Record<string, typeof Cloud> = {\n  cloud_misconfiguration: Cloud,\n  iam_abuse: Key,\n  saas_permission: Users,\n  shadow_admin: Users,\n};\n\nconst vectorLabels: Record<string, string> = {\n  cve: \"CVE\",\n  misconfiguration: \"Misconfiguration\",\n  behavioral_anomaly: \"Behavioral Anomaly\",\n  network_vulnerability: \"Network\",\n  cloud_misconfiguration: \"Cloud Misconfiguration\",\n  iam_abuse: \"IAM Abuse\",\n  saas_permission: \"SaaS Permission\",\n  shadow_admin: \"Shadow Admin\",\n  api_sequence_abuse: \"API Abuse\",\n  payment_flow: \"Payment Flow\",\n  subscription_bypass: \"Subscription Bypass\",\n  state_machine: \"State Machine\",\n  privilege_boundary: \"Privilege Boundary\",\n  workflow_desync: \"Workflow Desync\",\n  order_lifecycle: \"Order Lifecycle\",\n};\n\nconst cloudVectorLabels: Record<string, string> = {\n  s3_public_bucket: \"S3 Public Bucket\",\n  iam_role_chaining: \"IAM Role Chaining\",\n  cross_account_access: \"Cross Account Access\",\n  metadata_service_abuse: \"Metadata Service\",\n  lambda_privilege_escalation: \"Lambda Priv Esc\",\n  storage_account_exposure: \"Storage Account\",\n  service_account_abuse: \"Service Account\",\n  federation_bypass: \"Federation Bypass\",\n  permission_boundary_bypass: \"Permission Boundary\",\n  resource_policy_abuse: \"Resource Policy\",\n};\n\nconst severityColors: Record<string, string> = {\n  critical: \"bg-red-500/10 text-red-400 border-red-500/30\",\n  high: \"bg-orange-500/10 text-orange-400 border-orange-500/30\",\n  medium: \"bg-amber-500/10 text-amber-400 border-amber-500/30\",\n  low: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\",\n};\n\nconst providerColors: Record<string, string> = {\n  aws: \"bg-orange-500/10 text-orange-400 border-orange-500/30\",\n  gcp: \"bg-blue-500/10 text-blue-400 border-blue-500/30\",\n  azure: \"bg-cyan-500/10 text-cyan-400 border-cyan-500/30\",\n  \"multi-cloud\": \"bg-purple-500/10 text-purple-400 border-purple-500/30\",\n};\n\nexport function MultiVectorFindingsPanel({ findings }: MultiVectorFindingsPanelProps) {\n  if (findings.length === 0) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <Cloud className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n        <p className=\"text-sm\">No multi-vector findings</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\" data-testid=\"multi-vector-findings\">\n      {findings.map((finding, index) => {\n        const Icon = vectorIcons[finding.vectorType] || Globe;\n        return (\n          <Collapsible key={finding.id || index}>\n            <Card className=\"overflow-hidden\">\n              <CollapsibleTrigger className=\"w-full text-left\">\n                <div className=\"p-4 flex items-start gap-4\">\n                  <div className=\"p-2 rounded-lg bg-cyan-500/10\">\n                    <Icon className=\"h-5 w-5 text-cyan-400\" />\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2 flex-wrap mb-1\">\n                      <h4 className=\"font-semibold text-foreground\">{finding.title}</h4>\n                      <Badge className={severityColors[finding.severity]}>\n                        {finding.severity.toUpperCase()}\n                      </Badge>\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        {vectorLabels[finding.vectorType] || finding.vectorType}\n                      </Badge>\n                      {finding.cloudVector && (\n                        <Badge variant=\"outline\" className=\"text-xs bg-cyan-500/5\">\n                          {cloudVectorLabels[finding.cloudVector] || finding.cloudVector}\n                        </Badge>\n                      )}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground line-clamp-2\">{finding.description}</p>\n                  </div>\n                </div>\n              </CollapsibleTrigger>\n              <CollapsibleContent>\n                <div className=\"px-4 pb-4 space-y-4 border-t border-border pt-4\">\n                  <div>\n                    <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-2 block\">\n                      Affected Resources\n                    </label>\n                    <div className=\"flex gap-2 flex-wrap\">\n                      {finding.affectedResources.map((resource, i) => (\n                        <Badge key={i} variant=\"outline\" className=\"font-mono text-xs\">\n                          <Server className=\"h-3 w-3 mr-1\" />\n                          {resource}\n                        </Badge>\n                      ))}\n                    </div>\n                  </div>\n\n                  {finding.exploitPath && finding.exploitPath.length > 0 && (\n                    <div>\n                      <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-2 block\">\n                        Exploit Path\n                      </label>\n                      <div className=\"space-y-2\">\n                        {finding.exploitPath.map((step, i) => (\n                          <div key={i} className=\"flex items-center gap-3 p-2 bg-muted/30 rounded-lg\">\n                            <span className=\"flex items-center justify-center w-6 h-6 rounded-full bg-cyan-500/20 text-cyan-400 text-xs font-bold\">\n                              {step.step}\n                            </span>\n                            <div className=\"flex-1\">\n                              <p className=\"text-sm text-foreground\">{step.action}</p>\n                              <p className=\"text-xs text-muted-foreground\">\n                                Target: <span className=\"font-mono\">{step.target}</span>\n                                {step.technique && (\n                                  <>\n                                    {\" \"}| Technique: <span className=\"text-cyan-400\">{step.technique}</span>\n                                  </>\n                                )}\n                              </p>\n                            </div>\n                            {i < finding.exploitPath.length - 1 && (\n                              <ArrowRight className=\"h-4 w-4 text-muted-foreground\" />\n                            )}\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {finding.iamContext && (\n                    <div>\n                      <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-2 block\">\n                        IAM Context\n                      </label>\n                      <div className=\"p-3 bg-muted/30 rounded-lg space-y-2 text-sm\">\n                        {finding.iamContext.principal && (\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"text-muted-foreground\">Principal:</span>\n                            <span className=\"font-mono text-foreground\">{finding.iamContext.principal}</span>\n                          </div>\n                        )}\n                        {finding.iamContext.assumableRoles && finding.iamContext.assumableRoles.length > 0 && (\n                          <div>\n                            <span className=\"text-muted-foreground\">Assumable Roles:</span>\n                            <div className=\"flex gap-2 flex-wrap mt-1\">\n                              {finding.iamContext.assumableRoles.map((role, i) => (\n                                <Badge key={i} variant=\"outline\" className=\"font-mono text-xs\">\n                                  <Key className=\"h-3 w-3 mr-1\" />\n                                  {role}\n                                </Badge>\n                              ))}\n                            </div>\n                          </div>\n                        )}\n                        {finding.iamContext.privilegeEscalationPath && (\n                          <div className=\"mt-2 p-2 bg-red-500/10 rounded border border-red-500/30\">\n                            <span className=\"text-red-400 text-xs uppercase tracking-wider\">Priv Esc Path:</span>\n                            <p className=\"text-foreground mt-1\">{finding.iamContext.privilegeEscalationPath}</p>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  )}\n\n                  {finding.cloudContext && (\n                    <div>\n                      <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-2 block\">\n                        Cloud Context\n                      </label>\n                      <div className=\"flex gap-2 flex-wrap\">\n                        {finding.cloudContext.provider && (\n                          <Badge className={providerColors[finding.cloudContext.provider]}>\n                            {finding.cloudContext.provider.toUpperCase()}\n                          </Badge>\n                        )}\n                        {finding.cloudContext.service && (\n                          <Badge variant=\"outline\">{finding.cloudContext.service}</Badge>\n                        )}\n                        {finding.cloudContext.region && (\n                          <Badge variant=\"outline\" className=\"font-mono text-xs\">\n                            {finding.cloudContext.region}\n                          </Badge>\n                        )}\n                      </div>\n                      {finding.cloudContext.resourceArn && (\n                        <p className=\"mt-2 text-xs font-mono text-muted-foreground\">\n                          ARN: {finding.cloudContext.resourceArn}\n                        </p>\n                      )}\n                    </div>\n                  )}\n\n                  {finding.saasContext && (\n                    <div>\n                      <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-2 block\">\n                        SaaS Context\n                      </label>\n                      <div className=\"p-3 bg-muted/30 rounded-lg space-y-2 text-sm\">\n                        {finding.saasContext.platform && (\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"text-muted-foreground\">Platform:</span>\n                            <Badge variant=\"outline\">{finding.saasContext.platform}</Badge>\n                          </div>\n                        )}\n                        {finding.saasContext.permissionLevel && (\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"text-muted-foreground\">Permission Level:</span>\n                            <span className=\"text-foreground\">{finding.saasContext.permissionLevel}</span>\n                          </div>\n                        )}\n                        {finding.saasContext.shadowAdminIndicators && finding.saasContext.shadowAdminIndicators.length > 0 && (\n                          <div>\n                            <span className=\"text-muted-foreground\">Shadow Admin Indicators:</span>\n                            <div className=\"flex gap-2 flex-wrap mt-1\">\n                              {finding.saasContext.shadowAdminIndicators.map((indicator, i) => (\n                                <Badge key={i} className=\"bg-purple-500/10 text-purple-400 border-purple-500/30 text-xs\">\n                                  {indicator}\n                                </Badge>\n                              ))}\n                            </div>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  )}\n\n                  {finding.chainableWith && finding.chainableWith.length > 0 && (\n                    <div>\n                      <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-2 block\">\n                        Chainable With\n                      </label>\n                      <div className=\"flex gap-2 flex-wrap\">\n                        {finding.chainableWith.map((chain, i) => (\n                          <Badge key={i} variant=\"outline\" className=\"text-xs\">\n                            {chain}\n                          </Badge>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n                </div>\n              </CollapsibleContent>\n            </Card>\n          </Collapsible>\n        );\n      })}\n    </div>\n  );\n}\n","path":null,"size_bytes":12850,"size_tokens":null},"client/src/components/AnimatedAttackGraph.tsx":{"content":"import { useState, useEffect, useRef, useCallback } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport {\n  ZoomIn,\n  ZoomOut,\n  Maximize2,\n  Play,\n  Pause,\n  RotateCcw,\n  Target,\n  Shield,\n  AlertTriangle,\n  XCircle,\n  Clock,\n} from \"lucide-react\";\nimport type { AttackGraph, AttackNode, AttackEdge } from \"@shared/schema\";\n\ninterface AnimatedAttackGraphProps {\n  attackGraph: AttackGraph;\n  isExploitable: boolean;\n  showControls?: boolean;\n}\n\ninterface NodePosition {\n  x: number;\n  y: number;\n}\n\nexport function AnimatedAttackGraph({ \n  attackGraph, \n  isExploitable,\n  showControls = true \n}: AnimatedAttackGraphProps) {\n  const containerRef = useRef<HTMLDivElement>(null);\n  const [zoom, setZoom] = useState(1);\n  const [pan, setPan] = useState({ x: 0, y: 0 });\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });\n  const [selectedNode, setSelectedNode] = useState<string | null>(null);\n  const [isAnimating, setIsAnimating] = useState(true);\n  const [animationStep, setAnimationStep] = useState(0);\n  const [nodePositions, setNodePositions] = useState<Record<string, NodePosition>>({});\n\n  const criticalPath = attackGraph.criticalPath || [];\n  const nodes = attackGraph.nodes || [];\n  const edges = attackGraph.edges || [];\n\n  useEffect(() => {\n    const positions: Record<string, NodePosition> = {};\n    const levelGroups: Record<number, AttackNode[]> = {};\n    \n    nodes.forEach(node => {\n      const pathIndex = criticalPath.indexOf(node.id);\n      const level = pathIndex >= 0 ? pathIndex : criticalPath.length;\n      if (!levelGroups[level]) levelGroups[level] = [];\n      levelGroups[level].push(node);\n    });\n\n    const maxLevel = Math.max(...Object.keys(levelGroups).map(Number));\n    const width = 600;\n    const height = 400;\n    const levelWidth = width / (maxLevel + 2);\n\n    Object.entries(levelGroups).forEach(([levelStr, nodesAtLevel]) => {\n      const level = parseInt(levelStr);\n      const x = (level + 1) * levelWidth;\n      const levelHeight = height / (nodesAtLevel.length + 1);\n      \n      nodesAtLevel.forEach((node, i) => {\n        positions[node.id] = {\n          x,\n          y: (i + 1) * levelHeight,\n        };\n      });\n    });\n\n    setNodePositions(positions);\n  }, [nodes, criticalPath]);\n\n  useEffect(() => {\n    if (!isAnimating) return;\n    \n    const interval = setInterval(() => {\n      setAnimationStep(prev => {\n        if (prev >= criticalPath.length) {\n          return 0;\n        }\n        return prev + 1;\n      });\n    }, 1500);\n\n    return () => clearInterval(interval);\n  }, [isAnimating, criticalPath.length]);\n\n  const handleMouseDown = useCallback((e: React.MouseEvent) => {\n    if (e.target === containerRef.current || (e.target as HTMLElement).closest('.graph-canvas')) {\n      setIsDragging(true);\n      setDragStart({ x: e.clientX - pan.x, y: e.clientY - pan.y });\n    }\n  }, [pan]);\n\n  const handleMouseMove = useCallback((e: React.MouseEvent) => {\n    if (!isDragging) return;\n    setPan({\n      x: e.clientX - dragStart.x,\n      y: e.clientY - dragStart.y,\n    });\n  }, [isDragging, dragStart]);\n\n  const handleMouseUp = useCallback(() => {\n    setIsDragging(false);\n  }, []);\n\n  const getNodeColor = (node: AttackNode, isActive: boolean, isOnPath: boolean) => {\n    if (node.nodeType === \"entry\") return \"bg-cyan-500\";\n    if (node.nodeType === \"objective\") return isExploitable ? \"bg-red-500\" : \"bg-emerald-500\";\n    if (node.nodeType === \"dead-end\") return \"bg-gray-500\";\n    if (isActive) return \"bg-amber-500\";\n    if (isOnPath) return \"bg-orange-400\";\n    return \"bg-blue-500\";\n  };\n\n  const getNodeIcon = (nodeType: string) => {\n    switch (nodeType) {\n      case \"entry\": return <Target className=\"h-4 w-4 text-white\" />;\n      case \"objective\": return <AlertTriangle className=\"h-4 w-4 text-white\" />;\n      case \"dead-end\": return <XCircle className=\"h-4 w-4 text-white\" />;\n      default: return <Shield className=\"h-4 w-4 text-white\" />;\n    }\n  };\n\n  const getEdgeProgress = (edge: AttackEdge) => {\n    const sourceIndex = criticalPath.indexOf(edge.source);\n    const targetIndex = criticalPath.indexOf(edge.target);\n    \n    if (sourceIndex === -1 || targetIndex === -1) return 0;\n    if (animationStep > targetIndex) return 100;\n    if (animationStep === targetIndex) return 50;\n    return 0;\n  };\n\n  const resetView = () => {\n    setZoom(1);\n    setPan({ x: 0, y: 0 });\n    setAnimationStep(0);\n  };\n\n  const selectedNodeData = selectedNode ? nodes.find(n => n.id === selectedNode) : null;\n\n  return (\n    <div className=\"space-y-4\" data-testid=\"animated-attack-graph\">\n      {showControls && (\n        <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n          <div className=\"flex items-center gap-2\">\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              onClick={() => setZoom(z => Math.min(z + 0.2, 2))}\n              data-testid=\"btn-zoom-in\"\n            >\n              <ZoomIn className=\"h-4 w-4\" />\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              onClick={() => setZoom(z => Math.max(z - 0.2, 0.5))}\n              data-testid=\"btn-zoom-out\"\n            >\n              <ZoomOut className=\"h-4 w-4\" />\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              onClick={resetView}\n              data-testid=\"btn-reset-view\"\n            >\n              <RotateCcw className=\"h-4 w-4\" />\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              onClick={() => setIsAnimating(!isAnimating)}\n              data-testid=\"btn-toggle-animation-graph\"\n            >\n              {isAnimating ? <Pause className=\"h-4 w-4\" /> : <Play className=\"h-4 w-4\" />}\n            </Button>\n          </div>\n          <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-3 h-3 rounded-full bg-cyan-500\" />\n              <span>Entry</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-3 h-3 rounded-full bg-blue-500\" />\n              <span>Pivot</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className={`w-3 h-3 rounded-full ${isExploitable ? \"bg-red-500\" : \"bg-emerald-500\"}`} />\n              <span>Objective</span>\n            </div>\n          </div>\n        </div>\n      )}\n\n      <div\n        ref={containerRef}\n        className=\"relative bg-muted/30 rounded-lg border border-border overflow-hidden cursor-grab active:cursor-grabbing\"\n        style={{ height: 400 }}\n        onMouseDown={handleMouseDown}\n        onMouseMove={handleMouseMove}\n        onMouseUp={handleMouseUp}\n        onMouseLeave={handleMouseUp}\n        data-testid=\"graph-canvas\"\n      >\n        <div\n          className=\"graph-canvas absolute inset-0\"\n          style={{\n            transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`,\n            transformOrigin: \"center center\",\n            transition: isDragging ? \"none\" : \"transform 0.2s ease\",\n          }}\n        >\n          <svg className=\"absolute inset-0 w-full h-full pointer-events-none\">\n            <defs>\n              <marker\n                id=\"arrowhead\"\n                markerWidth=\"10\"\n                markerHeight=\"7\"\n                refX=\"9\"\n                refY=\"3.5\"\n                orient=\"auto\"\n              >\n                <polygon points=\"0 0, 10 3.5, 0 7\" fill=\"currentColor\" className=\"text-muted-foreground\" />\n              </marker>\n              <marker\n                id=\"arrowhead-active\"\n                markerWidth=\"10\"\n                markerHeight=\"7\"\n                refX=\"9\"\n                refY=\"3.5\"\n                orient=\"auto\"\n              >\n                <polygon points=\"0 0, 10 3.5, 0 7\" fill=\"currentColor\" className=\"text-amber-500\" />\n              </marker>\n            </defs>\n            {edges.map(edge => {\n              const sourcePos = nodePositions[edge.source];\n              const targetPos = nodePositions[edge.target];\n              if (!sourcePos || !targetPos) return null;\n\n              const isOnPath = criticalPath.includes(edge.source) && criticalPath.includes(edge.target);\n              const progress = getEdgeProgress(edge);\n              const isActive = progress > 0 && progress < 100;\n\n              return (\n                <g key={edge.id}>\n                  <motion.line\n                    x1={sourcePos.x}\n                    y1={sourcePos.y}\n                    x2={targetPos.x}\n                    y2={targetPos.y}\n                    stroke={isActive ? \"rgb(245 158 11)\" : isOnPath ? \"rgb(251 146 60)\" : \"rgb(100 116 139)\"}\n                    strokeWidth={isOnPath ? 3 : 2}\n                    strokeDasharray={edge.edgeType === \"alternative\" ? \"5,5\" : edge.edgeType === \"fallback\" ? \"2,4\" : undefined}\n                    markerEnd={isActive ? \"url(#arrowhead-active)\" : \"url(#arrowhead)\"}\n                    initial={{ pathLength: 0, opacity: 0 }}\n                    animate={{ pathLength: 1, opacity: 1 }}\n                    transition={{ duration: 0.5, delay: 0.1 }}\n                  />\n                  {isActive && (\n                    <motion.circle\n                      r={4}\n                      fill=\"rgb(245 158 11)\"\n                      initial={{ cx: sourcePos.x, cy: sourcePos.y }}\n                      animate={{\n                        cx: sourcePos.x + (targetPos.x - sourcePos.x) * 0.5,\n                        cy: sourcePos.y + (targetPos.y - sourcePos.y) * 0.5,\n                      }}\n                      transition={{ duration: 0.75, repeat: Infinity }}\n                    />\n                  )}\n                </g>\n              );\n            })}\n          </svg>\n\n          {nodes.map((node, index) => {\n            const pos = nodePositions[node.id];\n            if (!pos) return null;\n\n            const pathIndex = criticalPath.indexOf(node.id);\n            const isOnPath = pathIndex >= 0;\n            const isActive = pathIndex === animationStep;\n\n            return (\n              <motion.div\n                key={node.id}\n                className=\"absolute\"\n                style={{\n                  left: pos.x - 24,\n                  top: pos.y - 24,\n                }}\n                initial={{ scale: 0, opacity: 0 }}\n                animate={{\n                  scale: isActive ? 1.2 : 1,\n                  opacity: 1,\n                }}\n                transition={{ delay: index * 0.1, duration: 0.3 }}\n              >\n                <button\n                  className={`w-12 h-12 rounded-full flex items-center justify-center ${getNodeColor(node, isActive, isOnPath)} shadow-lg transition-all hover:ring-2 hover:ring-white/30`}\n                  onClick={() => setSelectedNode(selectedNode === node.id ? null : node.id)}\n                  data-testid={`node-${node.id}`}\n                >\n                  {getNodeIcon(node.nodeType)}\n                </button>\n                <div className=\"absolute top-full left-1/2 -translate-x-1/2 mt-1 text-xs text-center whitespace-nowrap text-foreground font-medium max-w-[80px] truncate\">\n                  {node.label}\n                </div>\n                {isActive && (\n                  <motion.div\n                    className=\"absolute inset-0 rounded-full border-2 border-amber-500\"\n                    initial={{ scale: 1, opacity: 1 }}\n                    animate={{ scale: 1.5, opacity: 0 }}\n                    transition={{ duration: 1, repeat: Infinity }}\n                  />\n                )}\n              </motion.div>\n            );\n          })}\n        </div>\n\n        <div className=\"absolute bottom-4 left-4 right-4\">\n          <div className=\"flex items-center gap-2 bg-background/80 backdrop-blur-sm rounded-lg p-2 border border-border\">\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"text-xs text-muted-foreground\">Time to Compromise:</span>\n            <span className=\"text-sm font-medium text-foreground\">\n              {attackGraph.timeToCompromise.expected} {attackGraph.timeToCompromise.unit}\n            </span>\n            <span className=\"text-xs text-muted-foreground ml-2\">\n              (range: {attackGraph.timeToCompromise.minimum}-{attackGraph.timeToCompromise.maximum})\n            </span>\n          </div>\n        </div>\n      </div>\n\n      <AnimatePresence>\n        {selectedNodeData && (\n          <motion.div\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            exit={{ opacity: 0, y: 10 }}\n          >\n            <Card className=\"p-4\" data-testid=\"node-details-panel\">\n              <div className=\"flex items-start justify-between gap-4\">\n                <div>\n                  <h4 className=\"font-semibold text-foreground\">{selectedNodeData.label}</h4>\n                  <p className=\"text-sm text-muted-foreground mt-1\">{selectedNodeData.description}</p>\n                </div>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={() => setSelectedNode(null)}\n                >\n                  <XCircle className=\"h-4 w-4\" />\n                </Button>\n              </div>\n              <div className=\"flex flex-wrap gap-2 mt-3\">\n                <Badge className=\"bg-purple-500/10 text-purple-400 border-purple-500/30\">\n                  {selectedNodeData.tactic}\n                </Badge>\n                <Badge className=\"bg-blue-500/10 text-blue-400 border-blue-500/30\">\n                  {selectedNodeData.compromiseLevel} access\n                </Badge>\n                <Badge className={\n                  selectedNodeData.nodeType === \"entry\" ? \"bg-cyan-500/10 text-cyan-400 border-cyan-500/30\" :\n                  selectedNodeData.nodeType === \"objective\" ? \"bg-red-500/10 text-red-400 border-red-500/30\" :\n                  \"bg-gray-500/10 text-gray-400 border-gray-500/30\"\n                }>\n                  {selectedNodeData.nodeType}\n                </Badge>\n              </div>\n              {selectedNodeData.assets && selectedNodeData.assets.length > 0 && (\n                <div className=\"mt-3 pt-3 border-t border-border\">\n                  <span className=\"text-xs text-muted-foreground\">Affected Assets:</span>\n                  <div className=\"flex flex-wrap gap-1 mt-1\">\n                    {selectedNodeData.assets.map((asset, i) => (\n                      <Badge key={i} size=\"sm\" className=\"bg-muted text-muted-foreground\">\n                        {asset}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n              )}\n            </Card>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n","path":null,"size_bytes":15103,"size_tokens":null},"client/src/components/ViewModeToggle.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Briefcase, Wrench } from \"lucide-react\";\n\ninterface ViewModeToggleProps {\n  mode: \"executive\" | \"engineer\";\n  onChange: (mode: \"executive\" | \"engineer\") => void;\n}\n\nexport function ViewModeToggle({ mode, onChange }: ViewModeToggleProps) {\n  return (\n    <div className=\"inline-flex items-center gap-1 bg-muted/50 rounded-lg p-1\" data-testid=\"view-mode-toggle\">\n      <Button\n        variant={mode === \"executive\" ? \"default\" : \"ghost\"}\n        size=\"sm\"\n        onClick={() => onChange(\"executive\")}\n        className=\"gap-1.5\"\n        data-testid=\"btn-executive-view\"\n      >\n        <Briefcase className=\"h-3.5 w-3.5\" />\n        Executive\n      </Button>\n      <Button\n        variant={mode === \"engineer\" ? \"default\" : \"ghost\"}\n        size=\"sm\"\n        onClick={() => onChange(\"engineer\")}\n        className=\"gap-1.5\"\n        data-testid=\"btn-engineer-view\"\n      >\n        <Wrench className=\"h-3.5 w-3.5\" />\n        Engineer\n      </Button>\n    </div>\n  );\n}\n","path":null,"size_bytes":1022,"size_tokens":null},"client/src/components/ConfidenceGauge.tsx":{"content":"import { motion } from \"framer-motion\";\n\ninterface ConfidenceGaugeProps {\n  confidence: number;\n  label?: string;\n  size?: \"sm\" | \"md\" | \"lg\";\n}\n\nexport function ConfidenceGauge({ \n  confidence, \n  label = \"Confidence\", \n  size = \"md\" \n}: ConfidenceGaugeProps) {\n  const sizeClasses = {\n    sm: { container: \"w-24 h-12\", text: \"text-lg\", label: \"text-[10px]\" },\n    md: { container: \"w-32 h-16\", text: \"text-2xl\", label: \"text-xs\" },\n    lg: { container: \"w-40 h-20\", text: \"text-3xl\", label: \"text-sm\" },\n  };\n\n  const classes = sizeClasses[size];\n\n  const getColor = () => {\n    if (confidence >= 90) return { stroke: \"stroke-red-500\", text: \"text-red-400\", glow: \"drop-shadow-[0_0_8px_rgba(239,68,68,0.5)]\" };\n    if (confidence >= 75) return { stroke: \"stroke-orange-500\", text: \"text-orange-400\", glow: \"drop-shadow-[0_0_8px_rgba(249,115,22,0.5)]\" };\n    if (confidence >= 50) return { stroke: \"stroke-amber-500\", text: \"text-amber-400\", glow: \"drop-shadow-[0_0_8px_rgba(245,158,11,0.5)]\" };\n    if (confidence >= 25) return { stroke: \"stroke-emerald-500\", text: \"text-emerald-400\", glow: \"drop-shadow-[0_0_8px_rgba(16,185,129,0.5)]\" };\n    return { stroke: \"stroke-blue-500\", text: \"text-blue-400\", glow: \"drop-shadow-[0_0_8px_rgba(59,130,246,0.5)]\" };\n  };\n\n  const colors = getColor();\n  \n  const radius = 45;\n  const strokeWidth = 8;\n  const normalizedRadius = radius - strokeWidth / 2;\n  const circumference = normalizedRadius * Math.PI;\n  const strokeDashoffset = circumference - (confidence / 100) * circumference;\n\n  return (\n    <div className=\"flex flex-col items-center\" data-testid=\"confidence-gauge\">\n      <div className={`${classes.container} relative`}>\n        <svg className=\"w-full h-full transform -rotate-90\" viewBox=\"0 0 100 50\">\n          <path\n            d={`M 5,50 A ${normalizedRadius},${normalizedRadius} 0 0,1 95,50`}\n            fill=\"none\"\n            stroke=\"currentColor\"\n            strokeWidth={strokeWidth}\n            className=\"text-muted/30\"\n          />\n          <motion.path\n            d={`M 5,50 A ${normalizedRadius},${normalizedRadius} 0 0,1 95,50`}\n            fill=\"none\"\n            strokeWidth={strokeWidth}\n            strokeLinecap=\"round\"\n            className={`${colors.stroke} ${colors.glow}`}\n            initial={{ strokeDasharray: circumference, strokeDashoffset: circumference }}\n            animate={{ strokeDashoffset }}\n            transition={{ duration: 1, ease: \"easeOut\" }}\n          />\n        </svg>\n        <div className=\"absolute inset-0 flex items-end justify-center pb-1\">\n          <motion.span\n            className={`${classes.text} font-bold ${colors.text}`}\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            transition={{ delay: 0.5 }}\n          >\n            {confidence}%\n          </motion.span>\n        </div>\n      </div>\n      <span className={`${classes.label} text-muted-foreground mt-1`}>{label}</span>\n    </div>\n  );\n}\n","path":null,"size_bytes":2950,"size_tokens":null},"client/src/components/BusinessLogicFindingsPanel.tsx":{"content":"import { AlertTriangle, ArrowRight, CheckCircle2, DollarSign, XCircle } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card } from \"@/components/ui/card\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\nimport type { BusinessLogicFinding } from \"@shared/schema\";\n\ninterface BusinessLogicFindingsPanelProps {\n  findings: BusinessLogicFinding[];\n}\n\nconst categoryLabels: Record<string, string> = {\n  payment_bypass: \"Payment Bypass\",\n  subscription_abuse: \"Subscription Abuse\",\n  order_manipulation: \"Order Manipulation\",\n  state_transition: \"State Transition\",\n  privilege_escalation: \"Privilege Escalation\",\n  workflow_bypass: \"Workflow Bypass\",\n  race_condition: \"Race Condition\",\n  parameter_tampering: \"Parameter Tampering\",\n  session_abuse: \"Session Abuse\",\n  logic_flaw: \"Logic Flaw\",\n};\n\nconst severityColors: Record<string, string> = {\n  critical: \"bg-red-500/10 text-red-400 border-red-500/30\",\n  high: \"bg-orange-500/10 text-orange-400 border-orange-500/30\",\n  medium: \"bg-amber-500/10 text-amber-400 border-amber-500/30\",\n  low: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\",\n};\n\nexport function BusinessLogicFindingsPanel({ findings }: BusinessLogicFindingsPanelProps) {\n  if (findings.length === 0) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <AlertTriangle className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n        <p className=\"text-sm\">No business logic findings</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\" data-testid=\"business-logic-findings\">\n      {findings.map((finding, index) => (\n        <Collapsible key={finding.id || index}>\n          <Card className=\"overflow-hidden\">\n            <CollapsibleTrigger className=\"w-full text-left\">\n              <div className=\"p-4 flex items-start gap-4\">\n                <div className={`p-2 rounded-lg ${finding.validatedExploit ? \"bg-red-500/10\" : \"bg-amber-500/10\"}`}>\n                  {finding.validatedExploit ? (\n                    <XCircle className={`h-5 w-5 ${finding.validatedExploit ? \"text-red-400\" : \"text-amber-400\"}`} />\n                  ) : (\n                    <AlertTriangle className=\"h-5 w-5 text-amber-400\" />\n                  )}\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center gap-2 flex-wrap mb-1\">\n                    <h4 className=\"font-semibold text-foreground\">{finding.title}</h4>\n                    <Badge className={severityColors[finding.severity]}>\n                      {finding.severity.toUpperCase()}\n                    </Badge>\n                    <Badge variant=\"outline\" className=\"text-xs\">\n                      {categoryLabels[finding.category] || finding.category}\n                    </Badge>\n                    {finding.validatedExploit && (\n                      <Badge className=\"bg-red-500/10 text-red-400 border-red-500/30\">\n                        VALIDATED\n                      </Badge>\n                    )}\n                  </div>\n                  <p className=\"text-sm text-muted-foreground line-clamp-2\">{finding.description}</p>\n                </div>\n              </div>\n            </CollapsibleTrigger>\n            <CollapsibleContent>\n              <div className=\"px-4 pb-4 space-y-4 border-t border-border pt-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-2 block\">\n                      Intended Workflow\n                    </label>\n                    <div className=\"flex items-center gap-1 flex-wrap text-xs font-mono\">\n                      {finding.intendedWorkflow.map((step, i) => (\n                        <span key={i} className=\"flex items-center gap-1\">\n                          <span className=\"px-2 py-1 bg-emerald-500/10 text-emerald-400 rounded\">\n                            {step}\n                          </span>\n                          {i < finding.intendedWorkflow.length - 1 && (\n                            <ArrowRight className=\"h-3 w-3 text-muted-foreground\" />\n                          )}\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                  <div>\n                    <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-2 block\">\n                      Actual Workflow\n                    </label>\n                    <div className=\"flex items-center gap-1 flex-wrap text-xs font-mono\">\n                      {finding.actualWorkflow.map((step, i) => (\n                        <span key={i} className=\"flex items-center gap-1\">\n                          <span className=\"px-2 py-1 bg-red-500/10 text-red-400 rounded\">\n                            {step}\n                          </span>\n                          {i < finding.actualWorkflow.length - 1 && (\n                            <ArrowRight className=\"h-3 w-3 text-muted-foreground\" />\n                          )}\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                </div>\n\n                {finding.stateViolations && finding.stateViolations.length > 0 && (\n                  <div>\n                    <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-2 block\">\n                      State Violations\n                    </label>\n                    <div className=\"space-y-2\">\n                      {finding.stateViolations.map((violation, i) => (\n                        <div key={i} className=\"flex items-center gap-2 text-xs p-2 bg-muted/30 rounded-lg\">\n                          <Badge variant=\"outline\">{violation.fromState}</Badge>\n                          <ArrowRight className=\"h-3 w-3 text-red-400\" />\n                          <Badge variant=\"outline\">{violation.toState}</Badge>\n                          <span className=\"text-muted-foreground\">via</span>\n                          <Badge className=\"bg-red-500/10 text-red-400 border-red-500/30\">\n                            {violation.actualTransition}\n                          </Badge>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                <div>\n                  <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-2 block\">\n                    Exploit Steps\n                  </label>\n                  <ol className=\"space-y-1 text-sm text-muted-foreground list-decimal list-inside\">\n                    {finding.exploitSteps.map((step, i) => (\n                      <li key={i}>{step}</li>\n                    ))}\n                  </ol>\n                </div>\n\n                {finding.businessImpact && (\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    {finding.businessImpact.financialLoss && (\n                      <div className=\"flex items-center gap-2 p-2 bg-red-500/5 rounded-lg\">\n                        <DollarSign className=\"h-4 w-4 text-red-400\" />\n                        <div>\n                          <p className=\"text-xs text-muted-foreground\">Financial Loss</p>\n                          <p className=\"text-sm text-foreground\">{finding.businessImpact.financialLoss}</p>\n                        </div>\n                      </div>\n                    )}\n                    {finding.businessImpact.reputationalDamage && (\n                      <div className=\"flex items-center gap-2 p-2 bg-orange-500/5 rounded-lg\">\n                        <AlertTriangle className=\"h-4 w-4 text-orange-400\" />\n                        <div>\n                          <p className=\"text-xs text-muted-foreground\">Reputation Risk</p>\n                          <p className=\"text-sm text-foreground\">{finding.businessImpact.reputationalDamage}</p>\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                )}\n\n                <div>\n                  <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-2 block\">\n                    Impact\n                  </label>\n                  <p className=\"text-sm text-foreground\">{finding.impact}</p>\n                </div>\n\n                {finding.proofOfConcept && (\n                  <div>\n                    <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-2 block\">\n                      Proof of Concept\n                    </label>\n                    <pre className=\"p-3 bg-muted/50 rounded-lg text-xs font-mono overflow-x-auto\">\n                      {finding.proofOfConcept}\n                    </pre>\n                  </div>\n                )}\n              </div>\n            </CollapsibleContent>\n          </Card>\n        </Collapsible>\n      ))}\n    </div>\n  );\n}\n","path":null,"size_bytes":8950,"size_tokens":null},"server/services/agents/remediation-engine.ts":{"content":"import type { \n  RemediationGuidance, \n  CodeFix, \n  WafRule, \n  IamPolicy, \n  NetworkControl, \n  DetectionRule, \n  CompensatingControl,\n  AttackPathStep,\n  AttackGraph,\n  BusinessLogicFinding,\n  MultiVectorFinding,\n  IntelligentScore\n} from \"@shared/schema\";\nimport { randomUUID } from \"crypto\";\n\ninterface RemediationContext {\n  assetId: string;\n  exposureType: string;\n  priority: string;\n  description: string;\n  exploitable: boolean;\n  attackPath?: AttackPathStep[];\n  attackGraph?: AttackGraph;\n  businessLogicFindings?: BusinessLogicFinding[];\n  multiVectorFindings?: MultiVectorFinding[];\n  intelligentScore?: IntelligentScore;\n}\n\nexport async function generateRemediationGuidance(\n  context: RemediationContext,\n  evaluationId: string,\n  onProgress?: (stage: string, progress: number, message: string) => void\n): Promise<RemediationGuidance> {\n  onProgress?.(\"remediation\", 0, \"Analyzing vulnerability context...\");\n  \n  const codeFixes = await generateCodeFixes(context);\n  onProgress?.(\"remediation\", 20, \"Generated code-level fixes\");\n\n  const wafRules = await generateWafRules(context);\n  onProgress?.(\"remediation\", 40, \"Generated WAF rules\");\n\n  const iamPolicies = await generateIamPolicies(context);\n  onProgress?.(\"remediation\", 55, \"Generated IAM policies\");\n\n  const networkControls = await generateNetworkControls(context);\n  onProgress?.(\"remediation\", 70, \"Generated network controls\");\n\n  const detectionRules = await generateDetectionRules(context);\n  onProgress?.(\"remediation\", 85, \"Generated detection signatures\");\n\n  const compensatingControls = await generateCompensatingControls(context);\n  onProgress?.(\"remediation\", 95, \"Generated compensating controls\");\n\n  const prioritizedActions = buildPrioritizedActions(\n    codeFixes, wafRules, iamPolicies, networkControls, detectionRules, compensatingControls\n  );\n\n  const totalRiskReduction = calculateTotalRiskReduction(prioritizedActions);\n\n  onProgress?.(\"remediation\", 100, \"Remediation guidance complete\");\n\n  return {\n    id: `rem-${randomUUID().slice(0, 8)}`,\n    evaluationId,\n    generatedAt: new Date().toISOString(),\n    summary: `Generated ${prioritizedActions.length} remediation actions targeting ${context.exposureType} vulnerability on ${context.assetId}`,\n    executiveSummary: generateExecutiveSummary(context, prioritizedActions, totalRiskReduction),\n    codeFixes: codeFixes.length > 0 ? codeFixes : undefined,\n    wafRules: wafRules.length > 0 ? wafRules : undefined,\n    iamPolicies: iamPolicies.length > 0 ? iamPolicies : undefined,\n    networkControls: networkControls.length > 0 ? networkControls : undefined,\n    detectionRules: detectionRules.length > 0 ? detectionRules : undefined,\n    compensatingControls: compensatingControls.length > 0 ? compensatingControls : undefined,\n    prioritizedActions,\n    totalRiskReduction,\n    estimatedImplementationTime: estimateImplementationTime(prioritizedActions),\n  };\n}\n\nasync function generateCodeFixes(context: RemediationContext): Promise<CodeFix[]> {\n  const exposureType = context.exposureType;\n  const fixes: CodeFix[] = [];\n\n  if (exposureType === \"cve\" || exposureType === \"misconfiguration\") {\n    fixes.push({\n      id: `cf-${randomUUID().slice(0, 6)}`,\n      title: \"Input Validation Enhancement\",\n      language: \"javascript\",\n      filePath: \"src/controllers/api.js\",\n      vulnerability: \"Insufficient input validation\",\n      beforeCode: `app.post('/api/data', (req, res) => {\n  const data = req.body.data;\n  processData(data);\n});`,\n      afterCode: `import { z } from 'zod';\n\nconst DataSchema = z.object({\n  data: z.string().max(1000).regex(/^[a-zA-Z0-9-_]+$/),\n});\n\napp.post('/api/data', (req, res) => {\n  const result = DataSchema.safeParse(req.body);\n  if (!result.success) {\n    return res.status(400).json({ error: 'Invalid input' });\n  }\n  processData(result.data.data);\n});`,\n      explanation: \"Implement strict input validation using Zod schema to prevent injection attacks and malformed data processing.\",\n      complexity: \"low\",\n      testingNotes: \"Test with boundary values, special characters, and oversized inputs\",\n    });\n  }\n\n  if (exposureType === \"payment_flow\" || exposureType === \"subscription_bypass\") {\n    fixes.push({\n      id: `cf-${randomUUID().slice(0, 6)}`,\n      title: \"Server-Side Price Validation\",\n      language: \"typescript\",\n      filePath: \"src/services/payment.ts\",\n      vulnerability: \"Client-side price manipulation\",\n      beforeCode: `async function processOrder(order: Order) {\n  const total = order.total; // Client-provided\n  await chargePayment(order.userId, total);\n}`,\n      afterCode: `async function processOrder(order: Order) {\n  // Server-side price calculation\n  const items = await getCartItems(order.userId);\n  const total = items.reduce((sum, item) => {\n    const product = await getProduct(item.productId);\n    return sum + (product.price * item.quantity);\n  }, 0);\n  \n  // Apply validated discounts only\n  const discount = await validateDiscount(order.discountCode, order.userId);\n  const finalTotal = total - discount;\n  \n  await chargePayment(order.userId, finalTotal);\n}`,\n      explanation: \"Always calculate prices server-side using authoritative product database. Never trust client-provided totals.\",\n      complexity: \"medium\",\n      testingNotes: \"Test price manipulation attempts, discount stacking, and race conditions\",\n    });\n  }\n\n  if (exposureType === \"api_sequence_abuse\" || exposureType === \"state_machine\") {\n    fixes.push({\n      id: `cf-${randomUUID().slice(0, 6)}`,\n      title: \"State Machine Enforcement\",\n      language: \"typescript\",\n      filePath: \"src/services/workflow.ts\",\n      vulnerability: \"State transition bypass\",\n      beforeCode: `async function updateOrderStatus(orderId: string, newStatus: string) {\n  await db.update(orders)\n    .set({ status: newStatus })\n    .where(eq(orders.id, orderId));\n}`,\n      afterCode: `const VALID_TRANSITIONS: Record<string, string[]> = {\n  'pending': ['confirmed', 'cancelled'],\n  'confirmed': ['processing', 'cancelled'],\n  'processing': ['shipped', 'cancelled'],\n  'shipped': ['delivered'],\n  'delivered': ['returned'],\n};\n\nasync function updateOrderStatus(orderId: string, newStatus: string) {\n  const order = await db.select().from(orders).where(eq(orders.id, orderId)).then(r => r[0]);\n  \n  const allowedTransitions = VALID_TRANSITIONS[order.status] || [];\n  if (!allowedTransitions.includes(newStatus)) {\n    throw new InvalidStateTransitionError(\n      \\`Cannot transition from \\${order.status} to \\${newStatus}\\`\n    );\n  }\n  \n  await db.update(orders)\n    .set({ status: newStatus, updatedAt: new Date() })\n    .where(eq(orders.id, orderId));\n}`,\n      explanation: \"Implement explicit state machine with validated transitions to prevent workflow bypass attacks.\",\n      complexity: \"medium\",\n      testingNotes: \"Test all invalid transition combinations and concurrent update scenarios\",\n    });\n  }\n\n  if (exposureType === \"iam_abuse\" || exposureType === \"privilege_boundary\") {\n    fixes.push({\n      id: `cf-${randomUUID().slice(0, 6)}`,\n      title: \"Role-Based Access Control Enhancement\",\n      language: \"typescript\",\n      filePath: \"src/middleware/auth.ts\",\n      vulnerability: \"Privilege escalation via role manipulation\",\n      beforeCode: `function checkPermission(user: User, resource: string) {\n  return user.permissions.includes(resource);\n}`,\n      afterCode: `const ROLE_PERMISSIONS: Record<string, string[]> = {\n  'user': ['read:own', 'write:own'],\n  'moderator': ['read:own', 'write:own', 'read:all', 'moderate'],\n  'admin': ['read:own', 'write:own', 'read:all', 'write:all', 'admin'],\n};\n\nfunction checkPermission(user: User, resource: string, action: string) {\n  const rolePermissions = ROLE_PERMISSIONS[user.role] || [];\n  const requiredPermission = \\`\\${action}:\\${resource}\\`;\n  \n  // Check both specific and wildcard permissions\n  return rolePermissions.some(p => \n    p === requiredPermission || \n    p === \\`\\${action}:all\\` ||\n    (resource === 'own' && p.endsWith(':own'))\n  );\n}\n\nfunction requirePermission(resource: string, action: string) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    if (!checkPermission(req.user, resource, action)) {\n      return res.status(403).json({ error: 'Insufficient permissions' });\n    }\n    next();\n  };\n}`,\n      explanation: \"Implement hierarchical RBAC with explicit permission mapping to prevent horizontal and vertical privilege escalation.\",\n      complexity: \"high\",\n      testingNotes: \"Test cross-user access, role enumeration, and permission inheritance\",\n    });\n  }\n\n  return fixes;\n}\n\nasync function generateWafRules(context: RemediationContext): Promise<WafRule[]> {\n  const rules: WafRule[] = [];\n\n  rules.push({\n    id: `waf-${randomUUID().slice(0, 6)}`,\n    title: \"Block Suspicious API Patterns\",\n    platform: \"cloudflare\",\n    ruleType: \"block\",\n    condition: `http.request.uri.path contains \"/api/\" and (\n      http.request.body.size > 1048576 or\n      http.request.headers[\"content-type\"][0] ne \"application/json\"\n    )`,\n    action: \"block\",\n    priority: 1,\n    description: \"Block oversized API requests and non-JSON content types to API endpoints\",\n    falsePositiveRisk: \"low\",\n    rawConfig: `{\n  \"expression\": \"http.request.uri.path contains \\\\\"/api/\\\\\" and (http.request.body.size > 1048576 or http.request.headers[\\\\\"content-type\\\\\"][0] ne \\\\\"application/json\\\\\")\",\n  \"action\": \"block\",\n  \"description\": \"Block suspicious API patterns\"\n}`,\n  });\n\n  if (context.exposureType === \"payment_flow\" || context.exposureType === \"subscription_bypass\") {\n    rules.push({\n      id: `waf-${randomUUID().slice(0, 6)}`,\n      title: \"Rate Limit Payment Endpoints\",\n      platform: \"cloudflare\",\n      ruleType: \"rate_limit\",\n      condition: `http.request.uri.path matches \"^/api/(checkout|payment|subscribe)\"`,\n      action: \"rate_limit(10, 60)\",\n      priority: 2,\n      description: \"Limit payment-related requests to 10 per minute per IP to prevent abuse\",\n      falsePositiveRisk: \"medium\",\n      rawConfig: `{\n  \"expression\": \"http.request.uri.path matches \\\\\"^/api/(checkout|payment|subscribe)\\\\\"\",\n  \"action\": \"rate_limit\",\n  \"characteristics\": [\"ip.src\"],\n  \"period\": 60,\n  \"requests_per_period\": 10\n}`,\n    });\n  }\n\n  rules.push({\n    id: `waf-${randomUUID().slice(0, 6)}`,\n    title: \"SQL Injection Protection\",\n    platform: \"modsecurity\",\n    ruleType: \"block\",\n    condition: \"ARGS|ARGS_NAMES|REQUEST_BODY\",\n    action: \"deny,status:403,id:9001\",\n    priority: 1,\n    description: \"Block common SQL injection patterns in request parameters\",\n    falsePositiveRisk: \"medium\",\n    rawConfig: `SecRule ARGS|ARGS_NAMES|REQUEST_BODY \"@detectSQLi\" \\\\\n  \"id:9001,\\\\\n  phase:2,\\\\\n  deny,\\\\\n  status:403,\\\\\n  msg:'SQL Injection Attempt Detected',\\\\\n  logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\\\\\n  severity:CRITICAL\"`,\n  });\n\n  return rules;\n}\n\nasync function generateIamPolicies(context: RemediationContext): Promise<IamPolicy[]> {\n  const policies: IamPolicy[] = [];\n\n  if (context.exposureType === \"iam_abuse\" || context.exposureType === \"cloud_misconfiguration\") {\n    policies.push({\n      id: `iam-${randomUUID().slice(0, 6)}`,\n      title: \"Restrict IAM Role Assumption\",\n      platform: \"aws\",\n      policyType: \"deny\",\n      currentState: \"Allows sts:AssumeRole on *\",\n      recommendedState: \"Restrict to specific roles with conditions\",\n      affectedPrincipals: [\"arn:aws:iam::*:role/ServiceRole*\"],\n      riskReduction: 75,\n      implementationSteps: [\n        \"Audit current role trust policies\",\n        \"Identify legitimate cross-account access patterns\",\n        \"Implement explicit deny for unauthorized assumptions\",\n        \"Add MFA requirement for sensitive role assumptions\",\n        \"Enable CloudTrail logging for AssumeRole events\"\n      ],\n      rollbackPlan: \"Remove deny policy and restore original trust relationships\",\n      rawPolicy: `{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"DenyUnauthorizedRoleAssumption\",\n      \"Effect\": \"Deny\",\n      \"Action\": \"sts:AssumeRole\",\n      \"Resource\": \"*\",\n      \"Condition\": {\n        \"StringNotEquals\": {\n          \"aws:PrincipalOrgID\": \"o-xxxxxxxxxx\"\n        },\n        \"Bool\": {\n          \"aws:MultiFactorAuthPresent\": \"false\"\n        }\n      }\n    }\n  ]\n}`,\n    });\n  }\n\n  policies.push({\n    id: `iam-${randomUUID().slice(0, 6)}`,\n    title: \"Implement Least Privilege\",\n    platform: \"aws\",\n    policyType: \"boundary\",\n    currentState: \"Service role has broad permissions\",\n    recommendedState: \"Scoped permissions with permission boundary\",\n    affectedPrincipals: [\"Application service roles\"],\n    riskReduction: 60,\n    implementationSteps: [\n      \"Generate IAM Access Analyzer findings\",\n      \"Create permission boundary based on actual usage\",\n      \"Apply boundary to existing roles\",\n      \"Monitor for access denied events\",\n      \"Iterate and refine boundary policy\"\n    ],\n    rawPolicy: `{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"AllowedServices\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:GetObject\",\n        \"s3:PutObject\",\n        \"dynamodb:GetItem\",\n        \"dynamodb:PutItem\",\n        \"dynamodb:Query\"\n      ],\n      \"Resource\": [\n        \"arn:aws:s3:::app-bucket/*\",\n        \"arn:aws:dynamodb:*:*:table/app-*\"\n      ]\n    },\n    {\n      \"Sid\": \"DenyPrivilegedActions\",\n      \"Effect\": \"Deny\",\n      \"Action\": [\n        \"iam:*\",\n        \"organizations:*\",\n        \"sts:AssumeRole\"\n      ],\n      \"Resource\": \"*\"\n    }\n  ]\n}`,\n  });\n\n  return policies;\n}\n\nasync function generateNetworkControls(context: RemediationContext): Promise<NetworkControl[]> {\n  const controls: NetworkControl[] = [];\n\n  controls.push({\n    id: `net-${randomUUID().slice(0, 6)}`,\n    title: \"Segment Application Tier\",\n    controlType: \"segmentation\",\n    sourceZone: \"web-tier\",\n    destinationZone: \"app-tier\",\n    protocol: \"TCP\",\n    ports: [\"443\", \"8080\"],\n    action: \"allow\",\n    description: \"Allow only HTTPS traffic from web tier to application tier\",\n    implementationGuide: `1. Create network security group for app tier\n2. Allow inbound 443/8080 from web tier subnet only\n3. Deny all other inbound traffic\n4. Allow outbound to database tier on specific ports\n5. Enable flow logging for audit`,\n  });\n\n  controls.push({\n    id: `net-${randomUUID().slice(0, 6)}`,\n    title: \"Restrict Database Access\",\n    controlType: \"firewall\",\n    sourceZone: \"app-tier\",\n    destinationZone: \"data-tier\",\n    protocol: \"TCP\",\n    ports: [\"5432\", \"3306\"],\n    action: \"allow\",\n    description: \"Allow database connections only from application tier\",\n    implementationGuide: `1. Configure database security group\n2. Allow inbound from app tier private IPs only\n3. Block all internet-facing access\n4. Enable TLS for database connections\n5. Implement connection pooling with authentication`,\n  });\n\n  return controls;\n}\n\nasync function generateDetectionRules(context: RemediationContext): Promise<DetectionRule[]> {\n  const rules: DetectionRule[] = [];\n\n  rules.push({\n    id: `det-${randomUUID().slice(0, 6)}`,\n    title: \"Detect Anomalous API Access Patterns\",\n    platform: \"sigma\",\n    ruleType: \"anomaly\",\n    severity: \"high\",\n    description: \"Detect unusual API access patterns indicative of exploitation attempts\",\n    logic: \"Count API requests per user, alert when >3 standard deviations from baseline\",\n    dataSource: [\"api_logs\", \"waf_logs\"],\n    mitreTechniques: [\"T1190\", \"T1212\"],\n    falsePositiveGuidance: \"Review legitimate automation and batch processing patterns\",\n    responsePlaybook: \"Isolate source IP, review access logs, escalate to security team\",\n    rawRule: `title: Anomalous API Access Pattern\nstatus: experimental\nlogsource:\n  category: webserver\n  product: any\ndetection:\n  selection:\n    cs-method: POST\n    cs-uri-stem|contains: /api/\n  timeframe: 1m\n  condition: selection | count() by src_ip > 100\nfalsepositives:\n  - Automated testing\n  - Batch processing\nlevel: high\ntags:\n  - attack.initial_access\n  - attack.t1190`,\n  });\n\n  if (context.exposureType === \"payment_flow\" || context.exposureType === \"subscription_bypass\") {\n    rules.push({\n      id: `det-${randomUUID().slice(0, 6)}`,\n      title: \"Payment Flow Manipulation Detection\",\n      platform: \"elastic\",\n      ruleType: \"correlation\",\n      severity: \"critical\",\n      description: \"Detect attempts to manipulate payment flows\",\n      logic: \"Correlate price mismatches between client requests and server calculations\",\n      dataSource: [\"payment_logs\", \"application_logs\"],\n      mitreTechniques: [\"T1565.001\"],\n      falsePositiveGuidance: \"Review legitimate discount applications and currency conversions\",\n      responsePlaybook: \"Block transaction, flag account, notify fraud team\",\n      rawRule: `{\n  \"rule\": {\n    \"name\": \"Payment Manipulation Attempt\",\n    \"type\": \"eql\",\n    \"query\": \"sequence by user.id [payment where event.action == 'checkout_initiated'] [payment where event.action == 'payment_processed' and payment.client_total != payment.server_total]\",\n    \"risk_score\": 90,\n    \"severity\": \"critical\"\n  }\n}`,\n    });\n  }\n\n  rules.push({\n    id: `det-${randomUUID().slice(0, 6)}`,\n    title: \"Privilege Escalation Attempt\",\n    platform: \"splunk\",\n    ruleType: \"signature\",\n    severity: \"critical\",\n    description: \"Detect unauthorized access to privileged resources\",\n    logic: \"Match access to admin endpoints by non-admin users\",\n    dataSource: [\"auth_logs\", \"api_logs\"],\n    mitreTechniques: [\"T1068\", \"T1548\"],\n    falsePositiveGuidance: \"Verify against authorized admin user list\",\n    responsePlaybook: \"Lock account, review session history, reset credentials\",\n    rawRule: `index=web sourcetype=access_combined \n| search uri_path=\"/admin/*\" OR uri_path=\"/api/admin/*\"\n| lookup authorized_admins user AS user OUTPUT is_admin\n| where isnull(is_admin) OR is_admin=false\n| stats count by user, src_ip, uri_path\n| where count > 0`,\n  });\n\n  return rules;\n}\n\nasync function generateCompensatingControls(context: RemediationContext): Promise<CompensatingControl[]> {\n  const controls: CompensatingControl[] = [];\n\n  controls.push({\n    id: `comp-${randomUUID().slice(0, 6)}`,\n    title: \"Enhanced Monitoring\",\n    controlType: \"monitoring\",\n    description: \"Implement enhanced monitoring for vulnerable endpoints until patch is deployed\",\n    rationale: \"Provides visibility into exploitation attempts while remediation is in progress\",\n    implementationGuide: `1. Enable verbose logging on affected endpoints\n2. Set up real-time alerting for suspicious patterns\n3. Create dashboard for security team monitoring\n4. Configure automated ticket creation for alerts\n5. Establish 24/7 on-call rotation for critical alerts`,\n    effectiveness: 65,\n    duration: \"temporary\",\n    reviewDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],\n  });\n\n  controls.push({\n    id: `comp-${randomUUID().slice(0, 6)}`,\n    title: \"Access Review\",\n    controlType: \"access_review\",\n    description: \"Conduct immediate access review for affected systems\",\n    rationale: \"Identify and remove unnecessary access that could be exploited\",\n    implementationGuide: `1. Export current access lists for affected resources\n2. Compare against job function requirements\n3. Remove unnecessary permissions immediately\n4. Document access decisions for audit trail\n5. Schedule recurring reviews`,\n    effectiveness: 50,\n    duration: \"permanent\",\n    dependencies: [\"IAM inventory\", \"HR system integration\"],\n  });\n\n  if (context.priority === \"critical\" || context.priority === \"high\") {\n    controls.push({\n      id: `comp-${randomUUID().slice(0, 6)}`,\n      title: \"Emergency Network Isolation\",\n      controlType: \"monitoring\",\n      description: \"Prepare network isolation procedures for emergency response\",\n      rationale: \"Enable rapid containment if active exploitation is detected\",\n      implementationGuide: `1. Document isolation procedures in runbook\n2. Pre-configure firewall rules (disabled)\n3. Test isolation in non-production environment\n4. Train incident response team on procedures\n5. Establish communication plan for stakeholders`,\n      effectiveness: 90,\n      duration: \"temporary\",\n      reviewDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],\n    });\n  }\n\n  return controls;\n}\n\nfunction buildPrioritizedActions(\n  codeFixes: CodeFix[],\n  wafRules: WafRule[],\n  iamPolicies: IamPolicy[],\n  networkControls: NetworkControl[],\n  detectionRules: DetectionRule[],\n  compensatingControls: CompensatingControl[]\n): RemediationGuidance[\"prioritizedActions\"] {\n  const actions: RemediationGuidance[\"prioritizedActions\"] = [];\n  let order = 1;\n\n  compensatingControls.forEach(c => {\n    actions.push({\n      order: order++,\n      action: c.title,\n      type: \"compensating\",\n      timeEstimate: \"1-2 hours\",\n      riskReduction: c.effectiveness,\n      effort: \"low\",\n    });\n  });\n\n  wafRules.forEach(r => {\n    actions.push({\n      order: order++,\n      action: r.title,\n      type: \"waf_rule\",\n      timeEstimate: \"30 minutes\",\n      riskReduction: r.falsePositiveRisk === \"low\" ? 40 : 25,\n      effort: \"low\",\n    });\n  });\n\n  detectionRules.forEach(r => {\n    actions.push({\n      order: order++,\n      action: r.title,\n      type: \"detection_rule\",\n      timeEstimate: \"1-2 hours\",\n      riskReduction: 20,\n      effort: \"low\",\n    });\n  });\n\n  codeFixes.forEach(f => {\n    actions.push({\n      order: order++,\n      action: f.title,\n      type: \"code_fix\",\n      timeEstimate: f.complexity === \"trivial\" ? \"1 hour\" : f.complexity === \"low\" ? \"2-4 hours\" : f.complexity === \"medium\" ? \"1-2 days\" : \"3-5 days\",\n      riskReduction: f.complexity === \"trivial\" ? 30 : f.complexity === \"low\" ? 50 : f.complexity === \"medium\" ? 70 : 90,\n      effort: f.complexity === \"trivial\" || f.complexity === \"low\" ? \"low\" : f.complexity === \"medium\" ? \"medium\" : \"high\",\n    });\n  });\n\n  iamPolicies.forEach(p => {\n    actions.push({\n      order: order++,\n      action: p.title,\n      type: \"iam_policy\",\n      timeEstimate: \"2-4 hours\",\n      riskReduction: p.riskReduction,\n      effort: \"medium\",\n    });\n  });\n\n  networkControls.forEach(c => {\n    actions.push({\n      order: order++,\n      action: c.title,\n      type: \"network_control\",\n      timeEstimate: \"2-4 hours\",\n      riskReduction: 40,\n      effort: \"medium\",\n    });\n  });\n\n  return actions;\n}\n\nfunction calculateTotalRiskReduction(actions: RemediationGuidance[\"prioritizedActions\"]): number {\n  if (actions.length === 0) return 0;\n  let remaining = 100;\n  actions.forEach(a => {\n    remaining = remaining * (1 - a.riskReduction / 100);\n  });\n  return Math.round(100 - remaining);\n}\n\nfunction estimateImplementationTime(actions: RemediationGuidance[\"prioritizedActions\"]): string {\n  const lowEffort = actions.filter(a => a.effort === \"low\").length;\n  const mediumEffort = actions.filter(a => a.effort === \"medium\").length;\n  const highEffort = actions.filter(a => a.effort === \"high\").length;\n\n  const totalHours = lowEffort * 2 + mediumEffort * 6 + highEffort * 24;\n  \n  if (totalHours <= 8) return \"1 day\";\n  if (totalHours <= 40) return `${Math.ceil(totalHours / 8)} days`;\n  return `${Math.ceil(totalHours / 40)} weeks`;\n}\n\nfunction generateExecutiveSummary(\n  context: RemediationContext,\n  actions: RemediationGuidance[\"prioritizedActions\"],\n  totalRiskReduction: number\n): string {\n  const immediateActions = actions.filter(a => a.effort === \"low\").length;\n  const codeChanges = actions.filter(a => a.type === \"code_fix\").length;\n  \n  return `A ${context.priority} severity ${context.exposureType.replace(/_/g, \" \")} vulnerability has been identified affecting ${context.assetId}. ${context.exploitable ? \"This vulnerability has been confirmed as exploitable.\" : \"This vulnerability requires further validation.\"} \n\nOur analysis recommends ${actions.length} remediation actions that collectively reduce risk by ${totalRiskReduction}%. ${immediateActions} actions can be implemented immediately with low effort, including WAF rules and enhanced monitoring. ${codeChanges > 0 ? `${codeChanges} code-level fixes are recommended for permanent remediation.` : \"\"} \n\nPriority should be given to compensating controls for immediate risk reduction while longer-term fixes are developed and tested.`;\n}\n","path":null,"size_bytes":24320,"size_tokens":null},"server/services/agents/scoring-engine.ts":{"content":"import OpenAI from \"openai\";\nimport type {\n  ExploitabilityScore,\n  BusinessImpactScore,\n  RiskRank,\n  IntelligentScore,\n  AttackPathStep,\n  AttackGraph,\n  BusinessLogicFinding,\n  MultiVectorFinding,\n  ComplianceFramework,\n} from \"@shared/schema\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\nexport interface ScoringContext {\n  assetId: string;\n  exposureType: string;\n  priority: string;\n  description: string;\n  exploitable: boolean;\n  attackPath?: AttackPathStep[];\n  attackGraph?: AttackGraph;\n  businessLogicFindings?: BusinessLogicFinding[];\n  multiVectorFindings?: MultiVectorFinding[];\n  environmentInfo?: {\n    networkSegment?: string;\n    patchStatus?: string;\n    hasWaf?: boolean;\n    hasEdr?: boolean;\n    hasSiem?: boolean;\n  };\n  businessContext?: {\n    industry?: string;\n    dataTypes?: string[];\n    userBase?: string;\n    annualRevenue?: string;\n  };\n}\n\nconst SCORING_SYSTEM_PROMPT = `You are an advanced security risk scoring engine that provides contextual, business-aware risk assessments that go beyond traditional CVSS scoring.\n\nYour role is to analyze security findings and generate intelligent scores that consider:\n1. Real-world exploitability based on environmental context\n2. Business impact including financial, compliance, and reputational factors\n3. Actionable prioritization for security teams\n\nYou must return valid JSON matching the exact schema provided. Be precise with numbers and classifications.`;\n\nfunction buildScoringPrompt(context: ScoringContext): string {\n  const attackStepsSummary = context.attackPath\n    ?.map((s) => `- Step ${s.id}: ${s.title} (${s.severity})`)\n    .join(\"\\n\") || \"No attack path available\";\n\n  const businessLogicSummary = context.businessLogicFindings\n    ?.map((f) => `- ${f.title}: ${f.category} (${f.severity})`)\n    .join(\"\\n\") || \"No business logic findings\";\n\n  const multiVectorSummary = context.multiVectorFindings\n    ?.map((f) => `- ${f.title}: ${f.vectorType} (${f.severity})`)\n    .join(\"\\n\") || \"No multi-vector findings\";\n\n  const criticalSteps = [\n    ...(context.attackPath?.filter((s) => s.severity === \"critical\") || []),\n    ...(context.businessLogicFindings?.filter((f) => f.severity === \"critical\") || []),\n    ...(context.multiVectorFindings?.filter((f) => f.severity === \"critical\") || []),\n  ];\n\n  return `Analyze this security evaluation and generate comprehensive intelligent scores.\n\n## Target Asset\n- Asset ID: ${context.assetId}\n- Exposure Type: ${context.exposureType}\n- Initial Priority: ${context.priority}\n- Description: ${context.description}\n- Exploitable: ${context.exploitable}\n\n## Environmental Context\n${context.environmentInfo ? `\n- Network Segment: ${context.environmentInfo.networkSegment || \"Unknown\"}\n- Patch Status: ${context.environmentInfo.patchStatus || \"Unknown\"}\n- WAF Present: ${context.environmentInfo.hasWaf ?? \"Unknown\"}\n- EDR Present: ${context.environmentInfo.hasEdr ?? \"Unknown\"}\n- SIEM Present: ${context.environmentInfo.hasSiem ?? \"Unknown\"}\n` : \"No environmental context provided - assume typical enterprise environment\"}\n\n## Business Context\n${context.businessContext ? `\n- Industry: ${context.businessContext.industry || \"Unknown\"}\n- Data Types: ${context.businessContext.dataTypes?.join(\", \") || \"Unknown\"}\n- User Base: ${context.businessContext.userBase || \"Unknown\"}\n- Annual Revenue: ${context.businessContext.annualRevenue || \"Unknown\"}\n` : \"No business context provided - estimate based on asset type\"}\n\n## Attack Analysis Summary\n### Attack Path Steps\n${attackStepsSummary}\n\n### Business Logic Findings\n${businessLogicSummary}\n\n### Multi-Vector Findings\n${multiVectorSummary}\n\n### Critical Findings Count: ${criticalSteps.length}\n\n${context.attackGraph ? `\n### Attack Graph Metrics\n- Complexity Score: ${context.attackGraph.complexityScore}\n- Time to Compromise: ${context.attackGraph.timeToCompromise.expected} ${context.attackGraph.timeToCompromise.unit}\n- Kill Chain Coverage: ${context.attackGraph.killChainCoverage.join(\", \")}\n` : \"\"}\n\nGenerate a comprehensive intelligent score with the following structure:\n\n{\n  \"exploitability\": {\n    \"score\": <0-100 overall exploitability>,\n    \"confidence\": <0-100 confidence in assessment>,\n    \"factors\": {\n      \"attackComplexity\": {\n        \"level\": \"<trivial|low|medium|high|expert>\",\n        \"score\": <0-100>,\n        \"rationale\": \"<explanation>\"\n      },\n      \"authenticationRequired\": {\n        \"level\": \"<none|single|multi-factor|privileged>\",\n        \"score\": <0-100>,\n        \"rationale\": \"<explanation>\"\n      },\n      \"environmentalContext\": {\n        \"networkExposure\": \"<internet|dmz|internal|isolated>\",\n        \"patchLevel\": \"<current|behind|significantly_behind|eol>\",\n        \"compensatingControls\": [\"<list of controls>\"],\n        \"score\": <0-100>\n      },\n      \"detectionLikelihood\": {\n        \"level\": \"<unlikely|possible|likely|certain>\",\n        \"monitoringCoverage\": <0-100>,\n        \"evasionDifficulty\": \"<trivial|moderate|difficult|near_impossible>\",\n        \"score\": <0-100>\n      },\n      \"exploitMaturity\": {\n        \"availability\": \"<theoretical|poc|weaponized|in_the_wild>\",\n        \"skillRequired\": \"<script_kiddie|intermediate|advanced|nation_state>\",\n        \"score\": <0-100>\n      }\n    }\n  },\n  \"businessImpact\": {\n    \"score\": <0-100>,\n    \"riskLabel\": \"<minimal|low|moderate|significant|severe|catastrophic>\",\n    \"factors\": {\n      \"dataSensitivity\": {\n        \"classification\": \"<public|internal|confidential|restricted|top_secret>\",\n        \"dataTypes\": [\"<pii|phi|pci|credentials|trade_secrets|financial|customer_data>\"],\n        \"recordsAtRisk\": \"<estimate>\",\n        \"score\": <0-100>\n      },\n      \"financialExposure\": {\n        \"directLoss\": { \"min\": <number>, \"max\": <number>, \"currency\": \"USD\" },\n        \"regulatoryFines\": { \"potential\": <number>, \"frameworks\": [\"<list>\"] },\n        \"remediationCost\": <number>,\n        \"businessDisruptionCost\": <number>,\n        \"score\": <0-100>\n      },\n      \"complianceImpact\": {\n        \"affectedFrameworks\": [\"<pci_dss|hipaa|sox|gdpr|ccpa|iso27001|nist|soc2>\"],\n        \"violations\": [{ \"framework\": \"<name>\", \"requirement\": \"<specific requirement>\", \"severity\": \"<minor|major|critical>\" }],\n        \"auditImplications\": \"<description>\",\n        \"score\": <0-100>\n      },\n      \"blastRadius\": {\n        \"affectedSystems\": <number>,\n        \"affectedUsers\": \"<estimate>\",\n        \"downstreamDependencies\": [\"<list>\"],\n        \"propagationRisk\": \"<contained|limited|spreading|uncontained>\",\n        \"score\": <0-100>\n      },\n      \"reputationalRisk\": {\n        \"customerTrust\": \"<minimal|moderate|significant|severe>\",\n        \"mediaExposure\": \"<unlikely|possible|likely|certain>\",\n        \"competitiveAdvantage\": \"<none|minor|moderate|major>\",\n        \"score\": <0-100>\n      }\n    }\n  },\n  \"riskRank\": {\n    \"overallScore\": <0-100 combined score>,\n    \"riskLevel\": \"<info|low|medium|high|critical|emergency>\",\n    \"executiveLabel\": \"<concise executive-readable summary>\",\n    \"fixPriority\": <1-100 where 1 is highest priority>,\n    \"recommendation\": {\n      \"action\": \"<specific recommended action>\",\n      \"timeframe\": \"<immediate|24_hours|7_days|30_days|90_days|acceptable_risk>\",\n      \"justification\": \"<business justification>\"\n    },\n    \"comparison\": {\n      \"cvssEquivalent\": <0-10 CVSS score>,\n      \"industryPercentile\": <0-100>\n    },\n    \"trendIndicator\": \"<improving|stable|degrading|new>\"\n  }\n}`;\n}\n\nexport async function generateIntelligentScore(\n  context: ScoringContext\n): Promise<IntelligentScore> {\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: SCORING_SYSTEM_PROMPT },\n        { role: \"user\", content: buildScoringPrompt(context) },\n      ],\n      temperature: 0.3,\n      response_format: { type: \"json_object\" },\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response from scoring engine\");\n    }\n\n    const parsed = JSON.parse(content);\n    \n    const intelligentScore: IntelligentScore = {\n      exploitability: parsed.exploitability as ExploitabilityScore,\n      businessImpact: parsed.businessImpact as BusinessImpactScore,\n      riskRank: parsed.riskRank as RiskRank,\n      calculatedAt: new Date().toISOString(),\n      methodology: \"OdinForge Intelligent Risk Scoring v1.0 - Contextual business-aware assessment\",\n    };\n\n    return intelligentScore;\n  } catch (error) {\n    console.error(\"Scoring engine error:\", error);\n    return generateFallbackScore(context);\n  }\n}\n\nfunction generateFallbackScore(context: ScoringContext): IntelligentScore {\n  const criticalCount = [\n    ...(context.attackPath?.filter((s) => s.severity === \"critical\") || []),\n    ...(context.businessLogicFindings?.filter((f) => f.severity === \"critical\") || []),\n    ...(context.multiVectorFindings?.filter((f) => f.severity === \"critical\") || []),\n  ].length;\n\n  const highCount = [\n    ...(context.attackPath?.filter((s) => s.severity === \"high\") || []),\n    ...(context.businessLogicFindings?.filter((f) => f.severity === \"high\") || []),\n    ...(context.multiVectorFindings?.filter((f) => f.severity === \"high\") || []),\n  ].length;\n\n  const baseScore = context.exploitable ? 70 : 30;\n  const exploitabilityScore = Math.min(100, baseScore + criticalCount * 10 + highCount * 5);\n\n  const priorityMultiplier: Record<string, number> = {\n    critical: 1.0,\n    high: 0.8,\n    medium: 0.6,\n    low: 0.4,\n  };\n\n  const businessScore = Math.round(\n    exploitabilityScore * (priorityMultiplier[context.priority] || 0.5)\n  );\n\n  const overallScore = Math.round((exploitabilityScore * 0.6 + businessScore * 0.4));\n\n  let riskLevel: \"info\" | \"low\" | \"medium\" | \"high\" | \"critical\" | \"emergency\";\n  if (overallScore >= 90) riskLevel = \"emergency\";\n  else if (overallScore >= 75) riskLevel = \"critical\";\n  else if (overallScore >= 55) riskLevel = \"high\";\n  else if (overallScore >= 35) riskLevel = \"medium\";\n  else if (overallScore >= 15) riskLevel = \"low\";\n  else riskLevel = \"info\";\n\n  let timeframe: \"immediate\" | \"24_hours\" | \"7_days\" | \"30_days\" | \"90_days\" | \"acceptable_risk\";\n  if (overallScore >= 90) timeframe = \"immediate\";\n  else if (overallScore >= 75) timeframe = \"24_hours\";\n  else if (overallScore >= 55) timeframe = \"7_days\";\n  else if (overallScore >= 35) timeframe = \"30_days\";\n  else if (overallScore >= 15) timeframe = \"90_days\";\n  else timeframe = \"acceptable_risk\";\n\n  return {\n    exploitability: {\n      score: exploitabilityScore,\n      confidence: 60,\n      factors: {\n        attackComplexity: {\n          level: criticalCount > 0 ? \"low\" : \"medium\",\n          score: criticalCount > 0 ? 80 : 50,\n          rationale: \"Estimated based on finding severity distribution\",\n        },\n        authenticationRequired: {\n          level: \"single\",\n          score: 60,\n          rationale: \"Default assumption - requires authentication\",\n        },\n        environmentalContext: {\n          networkExposure: \"dmz\",\n          patchLevel: \"behind\",\n          compensatingControls: [],\n          score: 50,\n        },\n        detectionLikelihood: {\n          level: \"possible\",\n          monitoringCoverage: 50,\n          evasionDifficulty: \"moderate\",\n          score: 50,\n        },\n        exploitMaturity: {\n          availability: \"poc\",\n          skillRequired: \"intermediate\",\n          score: 60,\n        },\n      },\n    },\n    businessImpact: {\n      score: businessScore,\n      riskLabel: businessScore >= 70 ? \"severe\" : businessScore >= 50 ? \"significant\" : \"moderate\",\n      factors: {\n        dataSensitivity: {\n          classification: \"confidential\",\n          dataTypes: [\"customer_data\"],\n          recordsAtRisk: \"Unknown\",\n          score: businessScore,\n        },\n        financialExposure: {\n          directLoss: { min: 10000, max: 100000, currency: \"USD\" },\n          regulatoryFines: { potential: 50000, frameworks: [] },\n          remediationCost: 25000,\n          businessDisruptionCost: 50000,\n          score: businessScore,\n        },\n        complianceImpact: {\n          affectedFrameworks: [],\n          violations: [],\n          auditImplications: \"Potential audit findings\",\n          score: 40,\n        },\n        blastRadius: {\n          affectedSystems: 1,\n          affectedUsers: \"Unknown\",\n          downstreamDependencies: [],\n          propagationRisk: \"limited\",\n          score: 40,\n        },\n        reputationalRisk: {\n          customerTrust: \"moderate\",\n          mediaExposure: \"unlikely\",\n          competitiveAdvantage: \"minor\",\n          score: 40,\n        },\n      },\n    },\n    riskRank: {\n      overallScore,\n      riskLevel,\n      executiveLabel: `${riskLevel.toUpperCase()} RISK: ${context.exposureType.replace(\"_\", \" \")} on ${context.assetId}`,\n      fixPriority: Math.max(1, 100 - overallScore),\n      recommendation: {\n        action: context.exploitable\n          ? \"Address exploitable vulnerability immediately\"\n          : \"Review and monitor for changes\",\n        timeframe,\n        justification: `Based on ${criticalCount} critical and ${highCount} high severity findings`,\n      },\n      comparison: {\n        cvssEquivalent: Math.round((overallScore / 10) * 10) / 10,\n      },\n      trendIndicator: \"new\",\n    },\n    calculatedAt: new Date().toISOString(),\n    methodology: \"OdinForge Fallback Scoring - Limited context assessment\",\n  };\n}\n\nexport function calculateFixPriority(\n  intelligentScore: IntelligentScore,\n  existingScores?: IntelligentScore[]\n): number {\n  const { exploitability, businessImpact, riskRank } = intelligentScore;\n\n  let priority = riskRank.fixPriority;\n\n  if (exploitability.factors.exploitMaturity.availability === \"in_the_wild\") {\n    priority = Math.max(1, priority - 20);\n  }\n\n  if (businessImpact.factors.complianceImpact.affectedFrameworks.length > 0) {\n    priority = Math.max(1, priority - 10);\n  }\n\n  if (existingScores && existingScores.length > 0) {\n    const higherPriorityCount = existingScores.filter(\n      (s) => s.riskRank.overallScore > riskRank.overallScore\n    ).length;\n    priority = Math.max(1, priority + Math.floor(higherPriorityCount * 0.5));\n  }\n\n  return Math.min(100, Math.max(1, priority));\n}\n","path":null,"size_bytes":14277,"size_tokens":null},"client/src/components/RemediationPanel.tsx":{"content":"import { useState } from \"react\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport {\n  Code,\n  Shield,\n  Network,\n  Bell,\n  Layers,\n  Copy,\n  Check,\n  ChevronDown,\n  ChevronUp,\n  Clock,\n  TrendingDown,\n  AlertTriangle,\n  FileCode,\n  Zap,\n} from \"lucide-react\";\nimport type { RemediationGuidance } from \"@shared/schema\";\n\ninterface RemediationPanelProps {\n  guidance: RemediationGuidance;\n  viewMode?: \"executive\" | \"engineer\";\n}\n\nexport function RemediationPanel({ guidance, viewMode = \"engineer\" }: RemediationPanelProps) {\n  const [expandedItems, setExpandedItems] = useState<Set<string>>(new Set());\n  const [copiedId, setCopiedId] = useState<string | null>(null);\n\n  const toggleExpanded = (id: string) => {\n    setExpandedItems(prev => {\n      const next = new Set(prev);\n      if (next.has(id)) {\n        next.delete(id);\n      } else {\n        next.add(id);\n      }\n      return next;\n    });\n  };\n\n  const copyToClipboard = (text: string, id: string) => {\n    navigator.clipboard.writeText(text);\n    setCopiedId(id);\n    setTimeout(() => setCopiedId(null), 2000);\n  };\n\n  const getEffortColor = (effort: \"low\" | \"medium\" | \"high\") => {\n    switch (effort) {\n      case \"low\": return \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\";\n      case \"medium\": return \"bg-amber-500/10 text-amber-400 border-amber-500/30\";\n      case \"high\": return \"bg-red-500/10 text-red-400 border-red-500/30\";\n    }\n  };\n\n  const getTypeIcon = (type: string) => {\n    switch (type) {\n      case \"code_fix\": return <Code className=\"h-4 w-4\" />;\n      case \"waf_rule\": return <Shield className=\"h-4 w-4\" />;\n      case \"iam_policy\": return <Layers className=\"h-4 w-4\" />;\n      case \"network_control\": return <Network className=\"h-4 w-4\" />;\n      case \"detection_rule\": return <Bell className=\"h-4 w-4\" />;\n      case \"compensating\": return <AlertTriangle className=\"h-4 w-4\" />;\n      default: return <Zap className=\"h-4 w-4\" />;\n    }\n  };\n\n  if (viewMode === \"executive\") {\n    return (\n      <div className=\"space-y-6\" data-testid=\"remediation-panel-executive\">\n        <div className=\"bg-gradient-to-r from-emerald-500/10 to-cyan-500/10 rounded-lg p-6 border border-emerald-500/20\">\n          <div className=\"flex items-center justify-between flex-wrap gap-4 mb-4\">\n            <div>\n              <h3 className=\"text-lg font-semibold text-foreground\">Risk Reduction Summary</h3>\n              <p className=\"text-sm text-muted-foreground\">Implementation roadmap</p>\n            </div>\n            <div className=\"text-right\">\n              <div className=\"text-3xl font-bold text-emerald-400\">{guidance.totalRiskReduction}%</div>\n              <div className=\"text-xs text-muted-foreground\">Total Risk Reduction</div>\n            </div>\n          </div>\n          <p className=\"text-sm text-muted-foreground leading-relaxed\">{guidance.executiveSummary}</p>\n        </div>\n\n        <div className=\"grid grid-cols-2 gap-4\">\n          <div className=\"bg-card border border-border rounded-lg p-4\">\n            <div className=\"flex items-center gap-2 text-muted-foreground mb-2\">\n              <Clock className=\"h-4 w-4\" />\n              <span className=\"text-sm\">Implementation Time</span>\n            </div>\n            <div className=\"text-xl font-semibold text-foreground\">{guidance.estimatedImplementationTime}</div>\n          </div>\n          <div className=\"bg-card border border-border rounded-lg p-4\">\n            <div className=\"flex items-center gap-2 text-muted-foreground mb-2\">\n              <Zap className=\"h-4 w-4\" />\n              <span className=\"text-sm\">Total Actions</span>\n            </div>\n            <div className=\"text-xl font-semibold text-foreground\">{guidance.prioritizedActions.length}</div>\n          </div>\n        </div>\n\n        <div className=\"space-y-3\">\n          <h4 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">Priority Actions</h4>\n          {guidance.prioritizedActions.slice(0, 5).map((action) => (\n            <div\n              key={action.order}\n              className=\"flex items-center gap-4 p-3 bg-card border border-border rounded-lg\"\n              data-testid={`action-item-${action.order}`}\n            >\n              <div className=\"flex items-center justify-center w-8 h-8 rounded-full bg-muted text-foreground font-medium\">\n                {action.order}\n              </div>\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"flex items-center gap-2 flex-wrap\">\n                  {getTypeIcon(action.type)}\n                  <span className=\"font-medium text-foreground truncate\">{action.action}</span>\n                </div>\n                <div className=\"flex items-center gap-3 mt-1 text-xs text-muted-foreground\">\n                  <span>{action.timeEstimate}</span>\n                  <span className=\"flex items-center gap-1\">\n                    <TrendingDown className=\"h-3 w-3 text-emerald-400\" />\n                    {action.riskReduction}% reduction\n                  </span>\n                </div>\n              </div>\n              <Badge className={getEffortColor(action.effort)}>{action.effort}</Badge>\n            </div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\" data-testid=\"remediation-panel-engineer\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h3 className=\"font-semibold text-foreground\">Remediation Guidance</h3>\n          <p className=\"text-xs text-muted-foreground\">{guidance.summary}</p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Badge className=\"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\">\n            {guidance.totalRiskReduction}% Risk Reduction\n          </Badge>\n        </div>\n      </div>\n\n      <Tabs defaultValue=\"priority\" className=\"w-full\">\n        <TabsList className=\"flex flex-wrap gap-1 h-auto p-1\">\n          <TabsTrigger value=\"priority\" className=\"gap-1.5 text-xs\" data-testid=\"tab-priority\">\n            <Zap className=\"h-3.5 w-3.5\" />\n            Priority\n          </TabsTrigger>\n          {guidance.codeFixes && guidance.codeFixes.length > 0 && (\n            <TabsTrigger value=\"code\" className=\"gap-1.5 text-xs\" data-testid=\"tab-code\">\n              <Code className=\"h-3.5 w-3.5\" />\n              Code ({guidance.codeFixes.length})\n            </TabsTrigger>\n          )}\n          {guidance.wafRules && guidance.wafRules.length > 0 && (\n            <TabsTrigger value=\"waf\" className=\"gap-1.5 text-xs\" data-testid=\"tab-waf\">\n              <Shield className=\"h-3.5 w-3.5\" />\n              WAF ({guidance.wafRules.length})\n            </TabsTrigger>\n          )}\n          {guidance.iamPolicies && guidance.iamPolicies.length > 0 && (\n            <TabsTrigger value=\"iam\" className=\"gap-1.5 text-xs\" data-testid=\"tab-iam\">\n              <Layers className=\"h-3.5 w-3.5\" />\n              IAM ({guidance.iamPolicies.length})\n            </TabsTrigger>\n          )}\n          {guidance.detectionRules && guidance.detectionRules.length > 0 && (\n            <TabsTrigger value=\"detection\" className=\"gap-1.5 text-xs\" data-testid=\"tab-detection\">\n              <Bell className=\"h-3.5 w-3.5\" />\n              Detection ({guidance.detectionRules.length})\n            </TabsTrigger>\n          )}\n          {guidance.compensatingControls && guidance.compensatingControls.length > 0 && (\n            <TabsTrigger value=\"compensating\" className=\"gap-1.5 text-xs\" data-testid=\"tab-compensating\">\n              <AlertTriangle className=\"h-3.5 w-3.5\" />\n              Compensating ({guidance.compensatingControls.length})\n            </TabsTrigger>\n          )}\n        </TabsList>\n\n        <TabsContent value=\"priority\" className=\"mt-4\">\n          <ScrollArea className=\"h-[400px] pr-4\">\n            <div className=\"space-y-2\">\n              {guidance.prioritizedActions.map((action) => (\n                <div\n                  key={action.order}\n                  className=\"flex items-center gap-3 p-3 bg-muted/30 rounded-lg border border-border\"\n                  data-testid={`priority-action-${action.order}`}\n                >\n                  <div className=\"flex items-center justify-center w-6 h-6 rounded-full bg-primary/10 text-primary text-xs font-medium\">\n                    {action.order}\n                  </div>\n                  <div className=\"flex items-center gap-2 text-muted-foreground\">\n                    {getTypeIcon(action.type)}\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <span className=\"text-sm font-medium text-foreground\">{action.action}</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"text-xs text-muted-foreground\">{action.timeEstimate}</span>\n                    <Badge size=\"sm\" className=\"bg-emerald-500/10 text-emerald-400 border-emerald-500/30 text-xs\">\n                      -{action.riskReduction}%\n                    </Badge>\n                    <Badge size=\"sm\" className={`${getEffortColor(action.effort)} text-xs`}>\n                      {action.effort}\n                    </Badge>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </ScrollArea>\n        </TabsContent>\n\n        <TabsContent value=\"code\" className=\"mt-4\">\n          <ScrollArea className=\"h-[400px] pr-4\">\n            <div className=\"space-y-4\">\n              {guidance.codeFixes?.map((fix) => (\n                <Card key={fix.id} className=\"overflow-hidden\" data-testid={`code-fix-${fix.id}`}>\n                  <div\n                    className=\"p-4 cursor-pointer\"\n                    onClick={() => toggleExpanded(fix.id)}\n                  >\n                    <div className=\"flex items-center justify-between gap-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <FileCode className=\"h-5 w-5 text-cyan-400\" />\n                        <div>\n                          <h4 className=\"font-medium text-foreground\">{fix.title}</h4>\n                          <div className=\"flex items-center gap-2 mt-1\">\n                            <Badge size=\"sm\" className=\"bg-blue-500/10 text-blue-400 border-blue-500/30 text-xs\">\n                              {fix.language}\n                            </Badge>\n                            <Badge size=\"sm\" className={getEffortColor(fix.complexity === \"trivial\" ? \"low\" : fix.complexity === \"low\" ? \"low\" : fix.complexity === \"medium\" ? \"medium\" : \"high\")}>\n                              {fix.complexity}\n                            </Badge>\n                          </div>\n                        </div>\n                      </div>\n                      {expandedItems.has(fix.id) ? (\n                        <ChevronUp className=\"h-5 w-5 text-muted-foreground\" />\n                      ) : (\n                        <ChevronDown className=\"h-5 w-5 text-muted-foreground\" />\n                      )}\n                    </div>\n                  </div>\n                  {expandedItems.has(fix.id) && (\n                    <div className=\"px-4 pb-4 space-y-4 border-t border-border pt-4\">\n                      {fix.filePath && (\n                        <div className=\"text-xs font-mono text-muted-foreground\">{fix.filePath}</div>\n                      )}\n                      <p className=\"text-sm text-muted-foreground\">{fix.explanation}</p>\n                      \n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"text-xs font-medium text-red-400 uppercase\">Before (Vulnerable)</span>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => copyToClipboard(fix.beforeCode, `before-${fix.id}`)}\n                            data-testid={`copy-before-${fix.id}`}\n                          >\n                            {copiedId === `before-${fix.id}` ? (\n                              <Check className=\"h-4 w-4 text-emerald-400\" />\n                            ) : (\n                              <Copy className=\"h-4 w-4\" />\n                            )}\n                          </Button>\n                        </div>\n                        <pre className=\"bg-red-500/5 border border-red-500/20 rounded-md p-3 text-xs font-mono overflow-x-auto text-foreground\">\n                          {fix.beforeCode}\n                        </pre>\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"text-xs font-medium text-emerald-400 uppercase\">After (Fixed)</span>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => copyToClipboard(fix.afterCode, `after-${fix.id}`)}\n                            data-testid={`copy-after-${fix.id}`}\n                          >\n                            {copiedId === `after-${fix.id}` ? (\n                              <Check className=\"h-4 w-4 text-emerald-400\" />\n                            ) : (\n                              <Copy className=\"h-4 w-4\" />\n                            )}\n                          </Button>\n                        </div>\n                        <pre className=\"bg-emerald-500/5 border border-emerald-500/20 rounded-md p-3 text-xs font-mono overflow-x-auto text-foreground\">\n                          {fix.afterCode}\n                        </pre>\n                      </div>\n\n                      {fix.testingNotes && (\n                        <div className=\"text-xs text-muted-foreground bg-muted/50 rounded-md p-3\">\n                          <span className=\"font-medium\">Testing Notes:</span> {fix.testingNotes}\n                        </div>\n                      )}\n                    </div>\n                  )}\n                </Card>\n              ))}\n            </div>\n          </ScrollArea>\n        </TabsContent>\n\n        <TabsContent value=\"waf\" className=\"mt-4\">\n          <ScrollArea className=\"h-[400px] pr-4\">\n            <div className=\"space-y-4\">\n              {guidance.wafRules?.map((rule) => (\n                <Card key={rule.id} className=\"overflow-hidden\" data-testid={`waf-rule-${rule.id}`}>\n                  <div\n                    className=\"p-4 cursor-pointer\"\n                    onClick={() => toggleExpanded(rule.id)}\n                  >\n                    <div className=\"flex items-center justify-between gap-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <Shield className=\"h-5 w-5 text-orange-400\" />\n                        <div>\n                          <h4 className=\"font-medium text-foreground\">{rule.title}</h4>\n                          <div className=\"flex items-center gap-2 mt-1\">\n                            <Badge size=\"sm\" className=\"bg-orange-500/10 text-orange-400 border-orange-500/30 text-xs\">\n                              {rule.platform}\n                            </Badge>\n                            <Badge size=\"sm\" className=\"bg-purple-500/10 text-purple-400 border-purple-500/30 text-xs\">\n                              {rule.ruleType}\n                            </Badge>\n                          </div>\n                        </div>\n                      </div>\n                      {expandedItems.has(rule.id) ? (\n                        <ChevronUp className=\"h-5 w-5 text-muted-foreground\" />\n                      ) : (\n                        <ChevronDown className=\"h-5 w-5 text-muted-foreground\" />\n                      )}\n                    </div>\n                  </div>\n                  {expandedItems.has(rule.id) && (\n                    <div className=\"px-4 pb-4 space-y-4 border-t border-border pt-4\">\n                      <p className=\"text-sm text-muted-foreground\">{rule.description}</p>\n                      \n                      <div className=\"grid grid-cols-2 gap-4 text-xs\">\n                        <div>\n                          <span className=\"text-muted-foreground\">Priority:</span>\n                          <span className=\"ml-2 text-foreground\">{rule.priority}</span>\n                        </div>\n                        <div>\n                          <span className=\"text-muted-foreground\">False Positive Risk:</span>\n                          <Badge size=\"sm\" className={`ml-2 ${rule.falsePositiveRisk === \"low\" ? \"bg-emerald-500/10 text-emerald-400\" : rule.falsePositiveRisk === \"medium\" ? \"bg-amber-500/10 text-amber-400\" : \"bg-red-500/10 text-red-400\"}`}>\n                            {rule.falsePositiveRisk}\n                          </Badge>\n                        </div>\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"text-xs font-medium text-muted-foreground uppercase\">Rule Configuration</span>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => copyToClipboard(rule.rawConfig, rule.id)}\n                            data-testid={`copy-waf-${rule.id}`}\n                          >\n                            {copiedId === rule.id ? (\n                              <Check className=\"h-4 w-4 text-emerald-400\" />\n                            ) : (\n                              <Copy className=\"h-4 w-4\" />\n                            )}\n                          </Button>\n                        </div>\n                        <pre className=\"bg-muted/50 rounded-md p-3 text-xs font-mono overflow-x-auto text-foreground\">\n                          {rule.rawConfig}\n                        </pre>\n                      </div>\n                    </div>\n                  )}\n                </Card>\n              ))}\n            </div>\n          </ScrollArea>\n        </TabsContent>\n\n        <TabsContent value=\"iam\" className=\"mt-4\">\n          <ScrollArea className=\"h-[400px] pr-4\">\n            <div className=\"space-y-4\">\n              {guidance.iamPolicies?.map((policy) => (\n                <Card key={policy.id} className=\"overflow-hidden\" data-testid={`iam-policy-${policy.id}`}>\n                  <div\n                    className=\"p-4 cursor-pointer\"\n                    onClick={() => toggleExpanded(policy.id)}\n                  >\n                    <div className=\"flex items-center justify-between gap-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <Layers className=\"h-5 w-5 text-purple-400\" />\n                        <div>\n                          <h4 className=\"font-medium text-foreground\">{policy.title}</h4>\n                          <div className=\"flex items-center gap-2 mt-1\">\n                            <Badge size=\"sm\" className=\"bg-purple-500/10 text-purple-400 border-purple-500/30 text-xs\">\n                              {policy.platform}\n                            </Badge>\n                            <Badge size=\"sm\" className=\"bg-blue-500/10 text-blue-400 border-blue-500/30 text-xs\">\n                              {policy.policyType}\n                            </Badge>\n                            <Badge size=\"sm\" className=\"bg-emerald-500/10 text-emerald-400 border-emerald-500/30 text-xs\">\n                              -{policy.riskReduction}% risk\n                            </Badge>\n                          </div>\n                        </div>\n                      </div>\n                      {expandedItems.has(policy.id) ? (\n                        <ChevronUp className=\"h-5 w-5 text-muted-foreground\" />\n                      ) : (\n                        <ChevronDown className=\"h-5 w-5 text-muted-foreground\" />\n                      )}\n                    </div>\n                  </div>\n                  {expandedItems.has(policy.id) && (\n                    <div className=\"px-4 pb-4 space-y-4 border-t border-border pt-4\">\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <div>\n                          <span className=\"text-xs font-medium text-red-400 uppercase block mb-1\">Current State</span>\n                          <p className=\"text-sm text-muted-foreground\">{policy.currentState}</p>\n                        </div>\n                        <div>\n                          <span className=\"text-xs font-medium text-emerald-400 uppercase block mb-1\">Recommended State</span>\n                          <p className=\"text-sm text-muted-foreground\">{policy.recommendedState}</p>\n                        </div>\n                      </div>\n\n                      <div>\n                        <span className=\"text-xs font-medium text-muted-foreground uppercase block mb-2\">Implementation Steps</span>\n                        <ol className=\"list-decimal list-inside space-y-1 text-sm text-muted-foreground\">\n                          {policy.implementationSteps.map((step, i) => (\n                            <li key={i}>{step}</li>\n                          ))}\n                        </ol>\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"text-xs font-medium text-muted-foreground uppercase\">Policy JSON</span>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => copyToClipboard(policy.rawPolicy, policy.id)}\n                            data-testid={`copy-iam-${policy.id}`}\n                          >\n                            {copiedId === policy.id ? (\n                              <Check className=\"h-4 w-4 text-emerald-400\" />\n                            ) : (\n                              <Copy className=\"h-4 w-4\" />\n                            )}\n                          </Button>\n                        </div>\n                        <pre className=\"bg-muted/50 rounded-md p-3 text-xs font-mono overflow-x-auto text-foreground\">\n                          {policy.rawPolicy}\n                        </pre>\n                      </div>\n                    </div>\n                  )}\n                </Card>\n              ))}\n            </div>\n          </ScrollArea>\n        </TabsContent>\n\n        <TabsContent value=\"detection\" className=\"mt-4\">\n          <ScrollArea className=\"h-[400px] pr-4\">\n            <div className=\"space-y-4\">\n              {guidance.detectionRules?.map((rule) => (\n                <Card key={rule.id} className=\"overflow-hidden\" data-testid={`detection-rule-${rule.id}`}>\n                  <div\n                    className=\"p-4 cursor-pointer\"\n                    onClick={() => toggleExpanded(rule.id)}\n                  >\n                    <div className=\"flex items-center justify-between gap-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <Bell className=\"h-5 w-5 text-yellow-400\" />\n                        <div>\n                          <h4 className=\"font-medium text-foreground\">{rule.title}</h4>\n                          <div className=\"flex items-center gap-2 mt-1\">\n                            <Badge size=\"sm\" className=\"bg-yellow-500/10 text-yellow-400 border-yellow-500/30 text-xs\">\n                              {rule.platform}\n                            </Badge>\n                            <Badge size=\"sm\" className={`text-xs ${\n                              rule.severity === \"critical\" ? \"bg-red-500/10 text-red-400 border-red-500/30\" :\n                              rule.severity === \"high\" ? \"bg-orange-500/10 text-orange-400 border-orange-500/30\" :\n                              rule.severity === \"medium\" ? \"bg-amber-500/10 text-amber-400 border-amber-500/30\" :\n                              \"bg-blue-500/10 text-blue-400 border-blue-500/30\"\n                            }`}>\n                              {rule.severity}\n                            </Badge>\n                          </div>\n                        </div>\n                      </div>\n                      {expandedItems.has(rule.id) ? (\n                        <ChevronUp className=\"h-5 w-5 text-muted-foreground\" />\n                      ) : (\n                        <ChevronDown className=\"h-5 w-5 text-muted-foreground\" />\n                      )}\n                    </div>\n                  </div>\n                  {expandedItems.has(rule.id) && (\n                    <div className=\"px-4 pb-4 space-y-4 border-t border-border pt-4\">\n                      <p className=\"text-sm text-muted-foreground\">{rule.description}</p>\n                      \n                      <div className=\"text-xs text-muted-foreground\">\n                        <span className=\"font-medium\">Logic:</span> {rule.logic}\n                      </div>\n\n                      <div className=\"flex flex-wrap gap-1\">\n                        <span className=\"text-xs text-muted-foreground\">Data Sources:</span>\n                        {rule.dataSource.map((ds, i) => (\n                          <Badge key={i} size=\"sm\" className=\"bg-muted text-muted-foreground text-xs\">\n                            {ds}\n                          </Badge>\n                        ))}\n                      </div>\n\n                      {rule.mitreTechniques && rule.mitreTechniques.length > 0 && (\n                        <div className=\"flex flex-wrap gap-1\">\n                          <span className=\"text-xs text-muted-foreground\">MITRE:</span>\n                          {rule.mitreTechniques.map((tech, i) => (\n                            <Badge key={i} size=\"sm\" className=\"bg-red-500/10 text-red-400 border-red-500/30 text-xs\">\n                              {tech}\n                            </Badge>\n                          ))}\n                        </div>\n                      )}\n\n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"text-xs font-medium text-muted-foreground uppercase\">Detection Rule</span>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => copyToClipboard(rule.rawRule, rule.id)}\n                            data-testid={`copy-detection-${rule.id}`}\n                          >\n                            {copiedId === rule.id ? (\n                              <Check className=\"h-4 w-4 text-emerald-400\" />\n                            ) : (\n                              <Copy className=\"h-4 w-4\" />\n                            )}\n                          </Button>\n                        </div>\n                        <pre className=\"bg-muted/50 rounded-md p-3 text-xs font-mono overflow-x-auto text-foreground\">\n                          {rule.rawRule}\n                        </pre>\n                      </div>\n\n                      {rule.responsePlaybook && (\n                        <div className=\"text-xs text-muted-foreground bg-amber-500/5 border border-amber-500/20 rounded-md p-3\">\n                          <span className=\"font-medium text-amber-400\">Response Playbook:</span> {rule.responsePlaybook}\n                        </div>\n                      )}\n                    </div>\n                  )}\n                </Card>\n              ))}\n            </div>\n          </ScrollArea>\n        </TabsContent>\n\n        <TabsContent value=\"compensating\" className=\"mt-4\">\n          <ScrollArea className=\"h-[400px] pr-4\">\n            <div className=\"space-y-4\">\n              {guidance.compensatingControls?.map((control) => (\n                <Card key={control.id} className=\"overflow-hidden\" data-testid={`compensating-control-${control.id}`}>\n                  <div\n                    className=\"p-4 cursor-pointer\"\n                    onClick={() => toggleExpanded(control.id)}\n                  >\n                    <div className=\"flex items-center justify-between gap-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <AlertTriangle className=\"h-5 w-5 text-amber-400\" />\n                        <div>\n                          <h4 className=\"font-medium text-foreground\">{control.title}</h4>\n                          <div className=\"flex items-center gap-2 mt-1\">\n                            <Badge size=\"sm\" className=\"bg-amber-500/10 text-amber-400 border-amber-500/30 text-xs\">\n                              {control.controlType}\n                            </Badge>\n                            <Badge size=\"sm\" className={control.duration === \"temporary\" ? \"bg-blue-500/10 text-blue-400 border-blue-500/30 text-xs\" : \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30 text-xs\"}>\n                              {control.duration}\n                            </Badge>\n                            <Badge size=\"sm\" className=\"bg-emerald-500/10 text-emerald-400 border-emerald-500/30 text-xs\">\n                              {control.effectiveness}% effective\n                            </Badge>\n                          </div>\n                        </div>\n                      </div>\n                      {expandedItems.has(control.id) ? (\n                        <ChevronUp className=\"h-5 w-5 text-muted-foreground\" />\n                      ) : (\n                        <ChevronDown className=\"h-5 w-5 text-muted-foreground\" />\n                      )}\n                    </div>\n                  </div>\n                  {expandedItems.has(control.id) && (\n                    <div className=\"px-4 pb-4 space-y-4 border-t border-border pt-4\">\n                      <p className=\"text-sm text-muted-foreground\">{control.description}</p>\n                      \n                      <div className=\"text-sm text-muted-foreground bg-muted/50 rounded-md p-3\">\n                        <span className=\"font-medium text-foreground\">Rationale:</span> {control.rationale}\n                      </div>\n\n                      <div>\n                        <span className=\"text-xs font-medium text-muted-foreground uppercase block mb-2\">Implementation Guide</span>\n                        <p className=\"text-sm text-muted-foreground whitespace-pre-line\">{control.implementationGuide}</p>\n                      </div>\n\n                      {control.reviewDate && (\n                        <div className=\"text-xs text-muted-foreground\">\n                          <span className=\"font-medium\">Review Date:</span> {control.reviewDate}\n                        </div>\n                      )}\n                    </div>\n                  )}\n                </Card>\n              ))}\n            </div>\n          </ScrollArea>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":31291,"size_tokens":null},"client/src/components/WorkflowStateMachineVisualizer.tsx":{"content":"import { CircleDot, Circle, CheckCircle, AlertCircle, ArrowRight, Lock } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport type { WorkflowStateMachine } from \"@shared/schema\";\n\ninterface WorkflowStateMachineVisualizerProps {\n  workflow: WorkflowStateMachine;\n}\n\nconst stateTypeIcons = {\n  initial: CircleDot,\n  intermediate: Circle,\n  terminal: CheckCircle,\n  error: AlertCircle,\n};\n\nconst stateTypeColors = {\n  initial: \"text-cyan-400 bg-cyan-500/10\",\n  intermediate: \"text-blue-400 bg-blue-500/10\",\n  terminal: \"text-emerald-400 bg-emerald-500/10\",\n  error: \"text-red-400 bg-red-500/10\",\n};\n\nconst authColors = {\n  none: \"\",\n  user: \"border-blue-500/30\",\n  admin: \"border-orange-500/30\",\n  system: \"border-red-500/30\",\n};\n\nexport function WorkflowStateMachineVisualizer({ workflow }: WorkflowStateMachineVisualizerProps) {\n  const stateMap = new Map(workflow.states.map(s => [s.id, s]));\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"workflow-state-machine\">\n      <div className=\"flex items-center gap-2 mb-4\">\n        <h4 className=\"font-semibold text-foreground\">{workflow.name}</h4>\n        <Badge variant=\"outline\" className=\"text-xs\">\n          {workflow.states.length} states\n        </Badge>\n        <Badge variant=\"outline\" className=\"text-xs\">\n          {workflow.transitions.length} transitions\n        </Badge>\n      </div>\n\n      <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3\">\n        {workflow.states.map((state) => {\n          const Icon = stateTypeIcons[state.type];\n          const colorClass = stateTypeColors[state.type];\n          const authBorder = state.requiredAuth ? authColors[state.requiredAuth] : \"\";\n          \n          return (\n            <div\n              key={state.id}\n              className={`p-3 rounded-lg border ${authBorder || \"border-border\"} bg-card`}\n              data-testid={`state-${state.id}`}\n            >\n              <div className=\"flex items-center gap-2 mb-1\">\n                <div className={`p-1 rounded ${colorClass}`}>\n                  <Icon className=\"h-4 w-4\" />\n                </div>\n                <span className=\"font-medium text-sm text-foreground truncate\">{state.name}</span>\n              </div>\n              <div className=\"flex items-center gap-1 mt-2\">\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  {state.type}\n                </Badge>\n                {state.requiredAuth && state.requiredAuth !== \"none\" && (\n                  <Badge variant=\"outline\" className=\"text-xs gap-1\">\n                    <Lock className=\"h-3 w-3\" />\n                    {state.requiredAuth}\n                  </Badge>\n                )}\n              </div>\n            </div>\n          );\n        })}\n      </div>\n\n      <div>\n        <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-3 block\">\n          Transitions\n        </label>\n        <div className=\"space-y-2\">\n          {workflow.transitions.map((transition) => {\n            const fromState = stateMap.get(transition.from);\n            const toState = stateMap.get(transition.to);\n            \n            return (\n              <div\n                key={transition.id}\n                className={`flex items-center gap-3 p-3 rounded-lg border ${\n                  transition.isSecurityCritical \n                    ? \"border-red-500/30 bg-red-500/5\" \n                    : \"border-border bg-muted/30\"\n                }`}\n                data-testid={`transition-${transition.id}`}\n              >\n                <Badge variant=\"outline\" className=\"font-mono text-xs\">\n                  {fromState?.name || transition.from}\n                </Badge>\n                <div className=\"flex items-center gap-2 flex-1\">\n                  <ArrowRight className=\"h-4 w-4 text-muted-foreground\" />\n                  <div className=\"flex-1\">\n                    <span className=\"text-sm text-foreground\">{transition.trigger}</span>\n                    {transition.guard && (\n                      <span className=\"text-xs text-muted-foreground ml-2\">\n                        [guard: {transition.guard}]\n                      </span>\n                    )}\n                  </div>\n                  <ArrowRight className=\"h-4 w-4 text-muted-foreground\" />\n                </div>\n                <Badge variant=\"outline\" className=\"font-mono text-xs\">\n                  {toState?.name || transition.to}\n                </Badge>\n                {transition.isSecurityCritical && (\n                  <Badge className=\"bg-red-500/10 text-red-400 border-red-500/30 text-xs\">\n                    Security Critical\n                  </Badge>\n                )}\n              </div>\n            );\n          })}\n        </div>\n      </div>\n\n      {workflow.securityBoundaries && workflow.securityBoundaries.length > 0 && (\n        <div>\n          <label className=\"text-xs uppercase tracking-wider text-muted-foreground mb-3 block\">\n            Security Boundaries\n          </label>\n          <div className=\"space-y-2\">\n            {workflow.securityBoundaries.map((boundary, i) => (\n              <div\n                key={i}\n                className=\"p-3 rounded-lg border border-purple-500/30 bg-purple-500/5\"\n              >\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Lock className=\"h-4 w-4 text-purple-400\" />\n                  <span className=\"font-medium text-foreground\">{boundary.name}</span>\n                  <Badge className=\"bg-purple-500/10 text-purple-400 border-purple-500/30 text-xs\">\n                    {boundary.requiredPrivilege}\n                  </Badge>\n                </div>\n                <div className=\"flex gap-2 flex-wrap\">\n                  {boundary.statesWithin.map((stateId, j) => {\n                    const state = stateMap.get(stateId);\n                    return (\n                      <Badge key={j} variant=\"outline\" className=\"text-xs font-mono\">\n                        {state?.name || stateId}\n                      </Badge>\n                    );\n                  })}\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":6202,"size_tokens":null},"client/src/components/RiskHeatmap.tsx":{"content":"import { motion } from \"framer-motion\";\nimport { Badge } from \"@/components/ui/badge\";\nimport type { IntelligentScore } from \"@shared/schema\";\n\ninterface RiskHeatmapProps {\n  intelligentScore: IntelligentScore;\n  compact?: boolean;\n}\n\nexport function RiskHeatmap({ intelligentScore, compact = false }: RiskHeatmapProps) {\n  const exploitabilityScore = intelligentScore.exploitability?.score || 0;\n  const businessScore = intelligentScore.businessImpact?.score || 0;\n  const riskScore = intelligentScore.riskRank?.overallScore || 0;\n  const financialImpact = intelligentScore.businessImpact?.factors?.financialExposure?.score || 0;\n\n  const compositeScore = Math.round((exploitabilityScore + businessScore + riskScore) / 3);\n\n  const categories = [\n    { key: \"exploitability\", label: \"Exploitability\", value: exploitabilityScore, weight: 35 },\n    { key: \"business\", label: \"Business Impact\", value: businessScore, weight: 30 },\n    { key: \"risk\", label: \"Risk Level\", value: riskScore, weight: 25 },\n    { key: \"financial\", label: \"Financial\", value: financialImpact, weight: 10 },\n  ];\n\n  const getColorForValue = (value: number) => {\n    if (value >= 80) return { bg: \"bg-red-500\", text: \"text-red-400\", border: \"border-red-500/50\" };\n    if (value >= 60) return { bg: \"bg-orange-500\", text: \"text-orange-400\", border: \"border-orange-500/50\" };\n    if (value >= 40) return { bg: \"bg-amber-500\", text: \"text-amber-400\", border: \"border-amber-500/50\" };\n    if (value >= 20) return { bg: \"bg-emerald-500\", text: \"text-emerald-400\", border: \"border-emerald-500/50\" };\n    return { bg: \"bg-blue-500\", text: \"text-blue-400\", border: \"border-blue-500/50\" };\n  };\n\n  const compositeColors = getColorForValue(compositeScore);\n\n  if (compact) {\n    return (\n      <div className=\"grid grid-cols-4 gap-1\" data-testid=\"risk-heatmap-compact\">\n        {categories.map((cat) => {\n          const colors = getColorForValue(cat.value);\n          return (\n            <motion.div\n              key={cat.key}\n              className={`p-2 rounded-md ${colors.bg} relative overflow-hidden`}\n              style={{ opacity: 0.3 + (cat.value / 100) * 0.7 }}\n              initial={{ scale: 0.8, opacity: 0 }}\n              animate={{ scale: 1, opacity: 0.3 + (cat.value / 100) * 0.7 }}\n              transition={{ duration: 0.3 }}\n              data-testid={`heatmap-cell-${cat.key}`}\n            >\n              <div className=\"text-center\">\n                <div className=\"text-xs font-medium text-white\">{cat.value}</div>\n              </div>\n            </motion.div>\n          );\n        })}\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\" data-testid=\"risk-heatmap\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h4 className=\"font-medium text-foreground\">Risk Assessment Matrix</h4>\n          <p className=\"text-xs text-muted-foreground\">Multi-dimensional risk analysis</p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <span className=\"text-sm text-muted-foreground\">Composite Score:</span>\n          <Badge className={`${compositeColors.bg}/10 ${compositeColors.text} ${compositeColors.border} text-lg px-3`}>\n            {compositeScore}\n          </Badge>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-2 gap-3\">\n        {categories.map((cat, index) => {\n          const colors = getColorForValue(cat.value);\n          return (\n            <motion.div\n              key={cat.key}\n              className={`p-4 rounded-lg bg-muted/30 border ${colors.border}`}\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: index * 0.1 }}\n              data-testid={`risk-category-${cat.key}`}\n            >\n              <div className=\"flex items-center justify-between gap-2 mb-2\">\n                <span className=\"text-sm font-medium text-foreground\">{cat.label}</span>\n                <span className={`text-lg font-bold ${colors.text}`}>{cat.value}</span>\n              </div>\n              <div className=\"h-2 bg-muted/50 rounded-full overflow-hidden\">\n                <motion.div\n                  className={`h-full ${colors.bg} rounded-full`}\n                  initial={{ width: 0 }}\n                  animate={{ width: `${cat.value}%` }}\n                  transition={{ duration: 0.8, delay: index * 0.1 }}\n                />\n              </div>\n              <div className=\"flex items-center justify-between mt-2\">\n                <span className=\"text-[10px] text-muted-foreground\">Weight: {cat.weight}%</span>\n                <span className=\"text-[10px] text-muted-foreground\">\n                  Contribution: {Math.round(cat.value * cat.weight / 100)}pts\n                </span>\n              </div>\n            </motion.div>\n          );\n        })}\n      </div>\n\n      <div className=\"grid grid-cols-5 gap-1 pt-2\">\n        {[20, 40, 60, 80, 100].map((threshold, i) => {\n          const colors = getColorForValue(threshold - 10);\n          return (\n            <div key={threshold} className=\"text-center\">\n              <div className={`h-3 ${colors.bg} rounded-sm`} style={{ opacity: 0.3 + i * 0.175 }} />\n              <span className=\"text-[10px] text-muted-foreground\">{threshold - 20}-{threshold}</span>\n            </div>\n          );\n        })}\n      </div>\n\n      {intelligentScore.riskRank?.riskLevel && (\n        <div className=\"pt-2 border-t border-border\">\n          <div className=\"flex items-center justify-between text-sm\">\n            <span className=\"text-muted-foreground\">Risk Level:</span>\n            <Badge className={getColorForValue(riskScore).bg + \"/10 \" + getColorForValue(riskScore).text}>\n              {intelligentScore.riskRank.riskLevel}\n            </Badge>\n          </div>\n          <div className=\"flex items-center justify-between text-sm mt-1\">\n            <span className=\"text-muted-foreground\">Fix Priority:</span>\n            <span className={getColorForValue(riskScore).text}>{intelligentScore.riskRank.recommendation?.timeframe || \"N/A\"}</span>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":6142,"size_tokens":null},"client/src/components/IntelligentScorePanel.tsx":{"content":"import { TrendingUp, TrendingDown, Minus, AlertTriangle, Shield, DollarSign, Scale, Users, Building2, Clock } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport type { IntelligentScore } from \"@shared/schema\";\n\ninterface IntelligentScorePanelProps {\n  score: IntelligentScore;\n}\n\nexport function IntelligentScorePanel({ score }: IntelligentScorePanelProps) {\n  const getRiskLevelColor = (level: string) => {\n    const colors: Record<string, string> = {\n      emergency: \"bg-red-600 text-white\",\n      critical: \"bg-red-500/10 text-red-400 border-red-500/30\",\n      high: \"bg-orange-500/10 text-orange-400 border-orange-500/30\",\n      medium: \"bg-amber-500/10 text-amber-400 border-amber-500/30\",\n      low: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\",\n      info: \"bg-blue-500/10 text-blue-400 border-blue-500/30\",\n    };\n    return colors[level] || colors.medium;\n  };\n\n  const getTimeframeLabel = (timeframe: string) => {\n    const labels: Record<string, string> = {\n      immediate: \"Fix Immediately\",\n      \"24_hours\": \"Fix Within 24 Hours\",\n      \"7_days\": \"Fix Within 7 Days\",\n      \"30_days\": \"Fix Within 30 Days\",\n      \"90_days\": \"Fix Within 90 Days\",\n      acceptable_risk: \"Acceptable Risk\",\n    };\n    return labels[timeframe] || timeframe;\n  };\n\n  const getTrendIcon = (trend?: string) => {\n    switch (trend) {\n      case \"improving\":\n        return <TrendingDown className=\"h-4 w-4 text-emerald-400\" />;\n      case \"degrading\":\n        return <TrendingUp className=\"h-4 w-4 text-red-400\" />;\n      case \"stable\":\n        return <Minus className=\"h-4 w-4 text-muted-foreground\" />;\n      default:\n        return null;\n    }\n  };\n\n  const formatCurrency = (value: number) => {\n    if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;\n    if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;\n    return `$${value.toFixed(0)}`;\n  };\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"intelligent-score-panel\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div className=\"flex items-center gap-4\">\n          <div className=\"relative\">\n            <div className=\"w-20 h-20 rounded-full border-4 border-muted flex items-center justify-center\">\n              <span className=\"text-2xl font-bold text-foreground\">{score.riskRank.overallScore}</span>\n            </div>\n            <div className=\"absolute -bottom-1 -right-1\">\n              {getTrendIcon(score.riskRank.trendIndicator)}\n            </div>\n          </div>\n          <div>\n            <Badge className={getRiskLevelColor(score.riskRank.riskLevel)}>\n              {score.riskRank.riskLevel.toUpperCase()}\n            </Badge>\n            <p className=\"text-lg font-semibold text-foreground mt-1\">{score.riskRank.executiveLabel}</p>\n            <p className=\"text-sm text-muted-foreground\">Fix Priority: #{score.riskRank.fixPriority}</p>\n          </div>\n        </div>\n        <div className=\"text-right\">\n          <Badge className=\"bg-cyan-500/10 text-cyan-400 border-cyan-500/30 gap-1\">\n            <Clock className=\"h-3 w-3\" />\n            {getTimeframeLabel(score.riskRank.recommendation.timeframe)}\n          </Badge>\n        </div>\n      </div>\n\n      <div className=\"p-4 bg-muted/30 rounded-lg border border-border\">\n        <div className=\"flex items-start gap-3\">\n          <AlertTriangle className=\"h-5 w-5 text-amber-400 flex-shrink-0 mt-0.5\" />\n          <div>\n            <p className=\"font-medium text-foreground\">{score.riskRank.recommendation.action}</p>\n            <p className=\"text-sm text-muted-foreground mt-1\">{score.riskRank.recommendation.justification}</p>\n          </div>\n        </div>\n      </div>\n\n      <Tabs defaultValue=\"exploitability\" className=\"w-full\">\n        <TabsList className=\"w-full\">\n          <TabsTrigger value=\"exploitability\" className=\"flex-1\" data-testid=\"tab-exploitability\">\n            Exploitability\n          </TabsTrigger>\n          <TabsTrigger value=\"business\" className=\"flex-1\" data-testid=\"tab-business-impact\">\n            Business Impact\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"exploitability\" className=\"mt-4 space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-sm text-muted-foreground\">Exploitability Score</span>\n            <div className=\"flex items-center gap-2\">\n              <Progress value={score.exploitability.score} className=\"w-24 h-2\" />\n              <span className=\"font-mono text-sm\">{score.exploitability.score}/100</span>\n            </div>\n          </div>\n\n          <div className=\"space-y-3\">\n            <div className=\"p-3 bg-muted/20 rounded-lg border border-border\">\n              <div className=\"flex items-center justify-between mb-2\">\n                <span className=\"text-sm font-medium text-foreground\">Attack Complexity</span>\n                <Badge variant=\"outline\">{score.exploitability.factors.attackComplexity.level}</Badge>\n              </div>\n              <p className=\"text-xs text-muted-foreground\">{score.exploitability.factors.attackComplexity.rationale}</p>\n              <Progress value={score.exploitability.factors.attackComplexity.score} className=\"mt-2 h-1.5\" />\n            </div>\n\n            <div className=\"p-3 bg-muted/20 rounded-lg border border-border\">\n              <div className=\"flex items-center justify-between mb-2\">\n                <span className=\"text-sm font-medium text-foreground\">Authentication Required</span>\n                <Badge variant=\"outline\">{score.exploitability.factors.authenticationRequired.level}</Badge>\n              </div>\n              <p className=\"text-xs text-muted-foreground\">{score.exploitability.factors.authenticationRequired.rationale}</p>\n              <Progress value={score.exploitability.factors.authenticationRequired.score} className=\"mt-2 h-1.5\" />\n            </div>\n\n            <div className=\"p-3 bg-muted/20 rounded-lg border border-border\">\n              <div className=\"flex items-center justify-between mb-2\">\n                <span className=\"text-sm font-medium text-foreground\">Detection Likelihood</span>\n                <Badge variant=\"outline\">{score.exploitability.factors.detectionLikelihood.level}</Badge>\n              </div>\n              <div className=\"text-xs text-muted-foreground\">\n                Monitoring Coverage: {score.exploitability.factors.detectionLikelihood.monitoringCoverage}%\n              </div>\n              <Progress value={score.exploitability.factors.detectionLikelihood.score} className=\"mt-2 h-1.5\" />\n            </div>\n\n            <div className=\"p-3 bg-muted/20 rounded-lg border border-border\">\n              <div className=\"flex items-center justify-between mb-2\">\n                <span className=\"text-sm font-medium text-foreground\">Exploit Maturity</span>\n                <Badge variant=\"outline\">{score.exploitability.factors.exploitMaturity.availability}</Badge>\n              </div>\n              <div className=\"text-xs text-muted-foreground\">\n                Skill Required: {score.exploitability.factors.exploitMaturity.skillRequired.replace(\"_\", \" \")}\n              </div>\n              <Progress value={score.exploitability.factors.exploitMaturity.score} className=\"mt-2 h-1.5\" />\n            </div>\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"business\" className=\"mt-4 space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-sm text-muted-foreground\">Business Impact Score</span>\n            <div className=\"flex items-center gap-2\">\n              <Badge className={getRiskLevelColor(score.businessImpact.riskLabel)}>\n                {score.businessImpact.riskLabel}\n              </Badge>\n              <span className=\"font-mono text-sm\">{score.businessImpact.score}/100</span>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-3\">\n            <div className=\"p-3 bg-muted/20 rounded-lg border border-border\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Shield className=\"h-4 w-4 text-cyan-400\" />\n                <span className=\"text-sm font-medium text-foreground\">Data Sensitivity</span>\n              </div>\n              <Badge className=\"mb-2\" variant=\"outline\">\n                {score.businessImpact.factors.dataSensitivity.classification}\n              </Badge>\n              <div className=\"text-xs text-muted-foreground\">\n                {score.businessImpact.factors.dataSensitivity.recordsAtRisk} records at risk\n              </div>\n              <div className=\"flex flex-wrap gap-1 mt-2\">\n                {score.businessImpact.factors.dataSensitivity.dataTypes.map((type) => (\n                  <Badge key={type} className=\"text-xs bg-red-500/10 text-red-400 border-red-500/30\">\n                    {type.toUpperCase()}\n                  </Badge>\n                ))}\n              </div>\n            </div>\n\n            <div className=\"p-3 bg-muted/20 rounded-lg border border-border\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <DollarSign className=\"h-4 w-4 text-emerald-400\" />\n                <span className=\"text-sm font-medium text-foreground\">Financial Exposure</span>\n              </div>\n              <div className=\"text-lg font-semibold text-foreground\">\n                {formatCurrency(score.businessImpact.factors.financialExposure.directLoss.min)} - {formatCurrency(score.businessImpact.factors.financialExposure.directLoss.max)}\n              </div>\n              <div className=\"text-xs text-muted-foreground mt-1\">\n                Regulatory Fines: {formatCurrency(score.businessImpact.factors.financialExposure.regulatoryFines.potential)}\n              </div>\n            </div>\n\n            <div className=\"p-3 bg-muted/20 rounded-lg border border-border\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Scale className=\"h-4 w-4 text-purple-400\" />\n                <span className=\"text-sm font-medium text-foreground\">Compliance Impact</span>\n              </div>\n              <div className=\"flex flex-wrap gap-1\">\n                {score.businessImpact.factors.complianceImpact.affectedFrameworks.map((fw) => (\n                  <Badge key={fw} variant=\"outline\" className=\"text-xs\">\n                    {fw.toUpperCase()}\n                  </Badge>\n                ))}\n              </div>\n              {score.businessImpact.factors.complianceImpact.violations.length > 0 && (\n                <div className=\"text-xs text-muted-foreground mt-2\">\n                  {score.businessImpact.factors.complianceImpact.violations.length} violation(s) identified\n                </div>\n              )}\n            </div>\n\n            <div className=\"p-3 bg-muted/20 rounded-lg border border-border\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Users className=\"h-4 w-4 text-orange-400\" />\n                <span className=\"text-sm font-medium text-foreground\">Blast Radius</span>\n              </div>\n              <div className=\"text-sm text-foreground\">\n                {score.businessImpact.factors.blastRadius.affectedSystems} systems\n              </div>\n              <div className=\"text-xs text-muted-foreground\">\n                {score.businessImpact.factors.blastRadius.affectedUsers} users affected\n              </div>\n              <Badge className=\"mt-2\" variant=\"outline\">\n                {score.businessImpact.factors.blastRadius.propagationRisk}\n              </Badge>\n            </div>\n          </div>\n\n          <div className=\"p-3 bg-muted/20 rounded-lg border border-border\">\n            <div className=\"flex items-center gap-2 mb-2\">\n              <Building2 className=\"h-4 w-4 text-blue-400\" />\n              <span className=\"text-sm font-medium text-foreground\">Reputational Risk</span>\n            </div>\n            <div className=\"grid grid-cols-3 gap-4 text-xs\">\n              <div>\n                <span className=\"text-muted-foreground block\">Customer Trust</span>\n                <Badge variant=\"outline\" className=\"mt-1\">{score.businessImpact.factors.reputationalRisk.customerTrust}</Badge>\n              </div>\n              <div>\n                <span className=\"text-muted-foreground block\">Media Exposure</span>\n                <Badge variant=\"outline\" className=\"mt-1\">{score.businessImpact.factors.reputationalRisk.mediaExposure}</Badge>\n              </div>\n              <div>\n                <span className=\"text-muted-foreground block\">Competitive Impact</span>\n                <Badge variant=\"outline\" className=\"mt-1\">{score.businessImpact.factors.reputationalRisk.competitiveAdvantage}</Badge>\n              </div>\n            </div>\n          </div>\n        </TabsContent>\n      </Tabs>\n\n      {score.riskRank.comparison && (\n        <div className=\"pt-4 border-t border-border\">\n          <div className=\"text-xs text-muted-foreground mb-2\">Comparison</div>\n          <div className=\"flex items-center gap-4\">\n            {score.riskRank.comparison.cvssEquivalent && (\n              <div className=\"text-sm\">\n                <span className=\"text-muted-foreground\">CVSS Equivalent: </span>\n                <span className=\"font-mono\">{score.riskRank.comparison.cvssEquivalent.toFixed(1)}</span>\n              </div>\n            )}\n            {score.riskRank.comparison.industryPercentile && (\n              <div className=\"text-sm\">\n                <span className=\"text-muted-foreground\">Industry Percentile: </span>\n                <span className=\"font-mono\">{score.riskRank.comparison.industryPercentile}%</span>\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n\n      <div className=\"text-xs text-muted-foreground text-right\">\n        Calculated: {new Date(score.calculatedAt).toLocaleString()}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":14026,"size_tokens":null},"client/src/components/EvidencePanel.tsx":{"content":"import { useState } from \"react\";\nimport { Download, Clock, FileCode, Terminal, FileText, ChevronDown, ChevronRight, Loader2 } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport pdfMake from \"pdfmake/build/pdfmake\";\nimport type { EvidenceArtifact } from \"@shared/schema\";\n\ninterface EvidencePanelProps {\n  artifacts: EvidenceArtifact[];\n  evaluationId: string;\n}\n\nexport function EvidencePanel({ artifacts, evaluationId }: EvidencePanelProps) {\n  const [expandedIds, setExpandedIds] = useState<Set<string>>(new Set());\n  const [isExporting, setIsExporting] = useState(false);\n  const { toast } = useToast();\n\n  const toggleExpanded = (id: string) => {\n    const newSet = new Set(expandedIds);\n    if (newSet.has(id)) {\n      newSet.delete(id);\n    } else {\n      newSet.add(id);\n    }\n    setExpandedIds(newSet);\n  };\n\n  const getTypeIcon = (type: string) => {\n    switch (type) {\n      case \"request_response\":\n        return <FileCode className=\"h-4 w-4\" />;\n      case \"execution_trace\":\n        return <Terminal className=\"h-4 w-4\" />;\n      case \"log_capture\":\n        return <FileText className=\"h-4 w-4\" />;\n      default:\n        return <FileText className=\"h-4 w-4\" />;\n    }\n  };\n\n  const getTypeBadge = (type: string) => {\n    const typeLabels: Record<string, { label: string; className: string }> = {\n      request_response: { label: \"HTTP\", className: \"bg-blue-500/10 text-blue-400 border-blue-500/30\" },\n      execution_trace: { label: \"Trace\", className: \"bg-purple-500/10 text-purple-400 border-purple-500/30\" },\n      log_capture: { label: \"Logs\", className: \"bg-amber-500/10 text-amber-400 border-amber-500/30\" },\n      screenshot: { label: \"Screenshot\", className: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\" },\n      configuration_dump: { label: \"Config\", className: \"bg-cyan-500/10 text-cyan-400 border-cyan-500/30\" },\n      data_sample: { label: \"Data\", className: \"bg-orange-500/10 text-orange-400 border-orange-500/30\" },\n      network_capture: { label: \"Network\", className: \"bg-red-500/10 text-red-400 border-red-500/30\" },\n      timeline_event: { label: \"Event\", className: \"bg-indigo-500/10 text-indigo-400 border-indigo-500/30\" },\n    };\n    const config = typeLabels[type] || { label: type, className: \"bg-gray-500/10 text-gray-400 border-gray-500/30\" };\n    return <Badge className={config.className}>{config.label}</Badge>;\n  };\n\n  const exportEvidence = async (format: \"json\" | \"pdf\") => {\n    setIsExporting(true);\n    try {\n      const response = await apiRequest(\"POST\", `/api/evidence/${evaluationId}/export`, { format });\n      const result = await response.json();\n      \n      if (!result.success) {\n        throw new Error(result.error || \"Export failed\");\n      }\n      \n      const { data } = result;\n      \n      if (format === \"json\") {\n        const blob = new Blob([JSON.stringify(data, null, 2)], { type: \"application/json\" });\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement(\"a\");\n        a.href = url;\n        a.download = `evidence-${evaluationId}.json`;\n        document.body.appendChild(a);\n        a.click();\n        document.body.removeChild(a);\n        URL.revokeObjectURL(url);\n      } else if (format === \"pdf\") {\n        // Generate PDF with the AI-enhanced narratives\n        const docDefinition: any = {\n          content: [\n            { text: \"Evidence Package\", style: \"header\" },\n            { text: `Evaluation ID: ${evaluationId}`, style: \"subheader\" },\n            { text: `Generated: ${data.metadata.generatedAt}`, style: \"metadata\" },\n            { text: \" \" },\n            \n            { text: \"Executive Summary\", style: \"sectionHeader\" },\n            { text: data.executiveSummary, style: \"paragraph\" },\n            { text: \" \" },\n            \n            { text: \"Timeline of Events\", style: \"sectionHeader\" },\n            { text: data.timelineNarrative, style: \"paragraph\" },\n            { text: \" \" },\n            \n            { text: \"Key Findings\", style: \"sectionHeader\" },\n            { text: data.findingsNarrative, style: \"paragraph\" },\n            { text: \" \" },\n            \n            { text: \"Technical Details\", style: \"sectionHeader\" },\n            { text: data.technicalDetails, style: \"paragraph\" },\n            { text: \" \" },\n            \n            { text: \"Evidence Artifacts\", style: \"sectionHeader\" },\n            {\n              ul: data.artifacts.slice(0, 20).map((a: any) => ({\n                text: [\n                  { text: `${a.title}`, bold: true },\n                  { text: ` (${a.type})` },\n                  a.description ? { text: ` - ${a.description.substring(0, 100)}${a.description.length > 100 ? \"...\" : \"\"}` } : \"\",\n                ],\n              })),\n            },\n          ],\n          styles: {\n            header: { fontSize: 22, bold: true, margin: [0, 0, 0, 10] },\n            subheader: { fontSize: 14, color: \"#666\", margin: [0, 0, 0, 5] },\n            metadata: { fontSize: 10, color: \"#999\", margin: [0, 0, 0, 20] },\n            sectionHeader: { fontSize: 14, bold: true, margin: [0, 10, 0, 5], color: \"#333\" },\n            paragraph: { fontSize: 11, lineHeight: 1.4, margin: [0, 0, 0, 10] },\n          },\n          defaultStyle: { font: \"Helvetica\" },\n          pageMargins: [40, 40, 40, 40],\n        };\n        \n        pdfMake.createPdf(docDefinition).download(`evidence-${evaluationId}.pdf`);\n      }\n      \n      toast({\n        title: \"Export Successful\",\n        description: `Evidence package exported as ${format.toUpperCase()}`,\n      });\n    } catch (error) {\n      console.error(\"Export failed:\", error);\n      toast({\n        title: \"Export Failed\",\n        description: \"Failed to generate evidence package. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsExporting(false);\n    }\n  };\n\n  if (!artifacts || artifacts.length === 0) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <FileText className=\"h-12 w-12 mx-auto mb-3 opacity-30\" />\n        <p>No evidence artifacts captured</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\" data-testid=\"evidence-panel\">\n      <div className=\"flex items-center justify-between gap-2\">\n        <div className=\"text-sm text-muted-foreground\">\n          {artifacts.length} artifact{artifacts.length !== 1 ? \"s\" : \"\"} captured\n        </div>\n        <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <Button variant=\"outline\" size=\"sm\" disabled={isExporting} data-testid=\"button-download-evidence\">\n              {isExporting ? (\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n              ) : (\n                <Download className=\"h-4 w-4 mr-2\" />\n              )}\n              {isExporting ? \"Generating...\" : \"Export\"}\n              <ChevronDown className=\"h-3 w-3 ml-2\" />\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent align=\"end\">\n            <DropdownMenuItem \n              onClick={() => exportEvidence(\"pdf\")}\n              data-testid=\"button-export-pdf\"\n            >\n              <FileText className=\"h-4 w-4 mr-2\" />\n              Export as PDF\n            </DropdownMenuItem>\n            <DropdownMenuItem \n              onClick={() => exportEvidence(\"json\")}\n              data-testid=\"button-export-json\"\n            >\n              <FileCode className=\"h-4 w-4 mr-2\" />\n              Export as JSON\n            </DropdownMenuItem>\n          </DropdownMenuContent>\n        </DropdownMenu>\n      </div>\n\n      <ScrollArea className=\"h-[400px]\">\n        <div className=\"space-y-2 pr-4\">\n          {artifacts.map((artifact) => (\n            <Collapsible\n              key={artifact.id}\n              open={expandedIds.has(artifact.id)}\n              onOpenChange={() => toggleExpanded(artifact.id)}\n            >\n              <div className=\"border border-border rounded-lg overflow-visible\" data-testid={`evidence-artifact-${artifact.id}`}>\n                <CollapsibleTrigger className=\"w-full\" data-testid={`button-expand-artifact-${artifact.id}`}>\n                  <div className=\"flex items-center gap-3 p-3 hover-elevate\">\n                    <div className=\"text-muted-foreground\">\n                      {expandedIds.has(artifact.id) ? (\n                        <ChevronDown className=\"h-4 w-4\" />\n                      ) : (\n                        <ChevronRight className=\"h-4 w-4\" />\n                      )}\n                    </div>\n                    <div className=\"p-2 rounded-lg bg-muted/50\">\n                      {getTypeIcon(artifact.type)}\n                    </div>\n                    <div className=\"flex-1 text-left\">\n                      <div className=\"font-medium text-sm text-foreground\">{artifact.title}</div>\n                      <div className=\"text-xs text-muted-foreground flex items-center gap-2 mt-0.5\">\n                        <Clock className=\"h-3 w-3\" />\n                        {new Date(artifact.timestamp).toLocaleString()}\n                      </div>\n                    </div>\n                    {getTypeBadge(artifact.type)}\n                    {artifact.isSanitized && (\n                      <Badge variant=\"outline\" className=\"text-xs\">Sanitized</Badge>\n                    )}\n                  </div>\n                </CollapsibleTrigger>\n\n                <CollapsibleContent>\n                  <div className=\"border-t border-border p-4 space-y-4 bg-muted/20\">\n                    <p className=\"text-sm text-muted-foreground\">{artifact.description}</p>\n\n                    {artifact.data.request && (\n                      <div className=\"space-y-2\">\n                        <div className=\"text-xs font-medium uppercase text-muted-foreground\">Request</div>\n                        <div className=\"bg-background rounded-lg p-3 font-mono text-xs\">\n                          <div className=\"flex items-center gap-2 mb-2\">\n                            <Badge className=\"bg-blue-500/10 text-blue-400 border-blue-500/30\">\n                              {artifact.data.request.method}\n                            </Badge>\n                            <span className=\"text-foreground truncate\">{artifact.data.request.url}</span>\n                          </div>\n                          {artifact.data.request.body && (\n                            <pre className=\"text-muted-foreground overflow-x-auto whitespace-pre-wrap\">\n                              {artifact.data.request.body}\n                            </pre>\n                          )}\n                        </div>\n                      </div>\n                    )}\n\n                    {artifact.data.response && (\n                      <div className=\"space-y-2\">\n                        <div className=\"text-xs font-medium uppercase text-muted-foreground\">Response</div>\n                        <div className=\"bg-background rounded-lg p-3 font-mono text-xs\">\n                          <div className=\"flex items-center gap-2 mb-2\">\n                            <Badge className={\n                              artifact.data.response.statusCode < 400\n                                ? \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\"\n                                : \"bg-red-500/10 text-red-400 border-red-500/30\"\n                            }>\n                              {artifact.data.response.statusCode}\n                            </Badge>\n                            {artifact.data.response.timing && (\n                              <span className=\"text-muted-foreground\">{artifact.data.response.timing}ms</span>\n                            )}\n                          </div>\n                          {artifact.data.response.body && (\n                            <pre className=\"text-muted-foreground overflow-x-auto whitespace-pre-wrap max-h-40\">\n                              {artifact.data.response.body.substring(0, 500)}\n                              {artifact.data.response.body.length > 500 && \"...\"}\n                            </pre>\n                          )}\n                        </div>\n                      </div>\n                    )}\n\n                    {artifact.data.trace && artifact.data.trace.length > 0 && (\n                      <div className=\"space-y-2\">\n                        <div className=\"text-xs font-medium uppercase text-muted-foreground\">Execution Trace</div>\n                        <div className=\"space-y-1\">\n                          {artifact.data.trace.map((step, idx) => (\n                            <div key={idx} className=\"flex items-start gap-3 p-2 bg-background rounded-lg\">\n                              <div className=\"min-w-[24px] h-6 flex items-center justify-center rounded bg-muted text-xs font-mono\">\n                                {step.step}\n                              </div>\n                              <div className=\"flex-1\">\n                                <div className=\"text-sm font-medium text-foreground\">{step.action}</div>\n                                <div className=\"text-xs text-muted-foreground\">{step.result}</div>\n                              </div>\n                              {step.duration && (\n                                <div className=\"text-xs text-muted-foreground\">{step.duration}ms</div>\n                              )}\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n\n                    {artifact.data.logs && artifact.data.logs.length > 0 && (\n                      <div className=\"space-y-2\">\n                        <div className=\"text-xs font-medium uppercase text-muted-foreground\">Log Entries</div>\n                        <div className=\"bg-background rounded-lg p-3 font-mono text-xs space-y-1 max-h-40 overflow-y-auto\">\n                          {artifact.data.logs.map((log, idx) => (\n                            <div key={idx} className=\"flex items-start gap-2\">\n                              <Badge className={\n                                log.level === \"error\" ? \"bg-red-500/10 text-red-400 border-red-500/30\" :\n                                log.level === \"warn\" ? \"bg-amber-500/10 text-amber-400 border-amber-500/30\" :\n                                log.level === \"info\" ? \"bg-blue-500/10 text-blue-400 border-blue-500/30\" :\n                                \"bg-gray-500/10 text-gray-400 border-gray-500/30\"\n                              }>\n                                {log.level}\n                              </Badge>\n                              <span className=\"text-muted-foreground\">{log.message}</span>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n\n                    {artifact.tags && artifact.tags.length > 0 && (\n                      <div className=\"flex items-center gap-2 flex-wrap\">\n                        {artifact.tags.map((tag) => (\n                          <Badge key={tag} variant=\"outline\" className=\"text-xs\">\n                            {tag}\n                          </Badge>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                </CollapsibleContent>\n              </div>\n            </Collapsible>\n          ))}\n        </div>\n      </ScrollArea>\n    </div>\n  );\n}\n","path":null,"size_bytes":15816,"size_tokens":null},"client/src/pages/Assets.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Server, AlertTriangle, CheckCircle, Clock, Trash2, MoreVertical } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { useState } from \"react\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/contexts/AuthContext\";\n\ninterface Evaluation {\n  id: string;\n  assetId: string;\n  exposureType: string;\n  priority: string;\n  status: string;\n  createdAt: string;\n  exploitable?: boolean;\n  score?: number;\n}\n\ninterface AssetSummary {\n  assetId: string;\n  evaluationIds: string[];\n  evaluationCount: number;\n  exploitableCount: number;\n  highestPriority: string;\n  latestEvaluation: string;\n  avgScore: number;\n  exposureTypes: string[];\n}\n\nexport default function Assets() {\n  const { toast } = useToast();\n  const { hasPermission } = useAuth();\n  const [deleteAsset, setDeleteAsset] = useState<AssetSummary | null>(null);\n  const [deletingAssetId, setDeletingAssetId] = useState<string | null>(null);\n\n  const { data: evaluations = [], isLoading } = useQuery<Evaluation[]>({\n    queryKey: [\"/api/aev/evaluations\"],\n  });\n\n  const deleteEvaluationMutation = useMutation({\n    mutationFn: async (evaluationId: string) => {\n      await apiRequest(\"DELETE\", `/api/aev/evaluations/${evaluationId}`);\n    },\n  });\n\n  const handleDeleteAsset = async (asset: AssetSummary) => {\n    setDeletingAssetId(asset.assetId);\n    let successCount = 0;\n    let failCount = 0;\n    \n    try {\n      // Delete all evaluations for this asset\n      for (const evalId of asset.evaluationIds) {\n        try {\n          await deleteEvaluationMutation.mutateAsync(evalId);\n          successCount++;\n        } catch {\n          failCount++;\n        }\n      }\n      \n      // Invalidate all relevant caches\n      queryClient.invalidateQueries({ queryKey: [\"/api/aev/evaluations\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/aev/stats\"] });\n      \n      if (failCount === 0) {\n        toast({\n          title: \"Asset deleted\",\n          description: `Successfully deleted ${successCount} evaluation(s) for \"${asset.assetId}\"`,\n        });\n      } else {\n        toast({\n          title: \"Partial deletion\",\n          description: `Deleted ${successCount} of ${asset.evaluationCount} evaluation(s). ${failCount} failed.`,\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      toast({\n        title: \"Delete failed\",\n        description: \"Failed to delete asset evaluations. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setDeletingAssetId(null);\n      setDeleteAsset(null);\n    }\n  };\n\n  const assetSummaries: AssetSummary[] = (() => {\n    const assetMap = new Map<string, Evaluation[]>();\n    \n    evaluations.forEach(e => {\n      const existing = assetMap.get(e.assetId) || [];\n      assetMap.set(e.assetId, [...existing, e]);\n    });\n\n    return Array.from(assetMap.entries()).map(([assetId, evals]) => {\n      const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };\n      const sorted = [...evals].sort((a, b) => \n        (priorityOrder[a.priority as keyof typeof priorityOrder] ?? 4) - \n        (priorityOrder[b.priority as keyof typeof priorityOrder] ?? 4)\n      );\n      \n      const scores = evals.filter(e => e.score !== undefined).map(e => e.score!);\n      const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;\n      \n      return {\n        assetId,\n        evaluationIds: evals.map(e => e.id),\n        evaluationCount: evals.length,\n        exploitableCount: evals.filter(e => e.exploitable).length,\n        highestPriority: sorted[0]?.priority || \"low\",\n        latestEvaluation: evals.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())[0]?.createdAt || \"\",\n        avgScore,\n        exposureTypes: Array.from(new Set(evals.map(e => e.exposureType))),\n      };\n    }).sort((a, b) => b.exploitableCount - a.exploitableCount);\n  })();\n\n  const getPriorityBadge = (priority: string) => {\n    const styles: Record<string, string> = {\n      critical: \"bg-red-500/10 text-red-400 border-red-500/30\",\n      high: \"bg-orange-500/10 text-orange-400 border-orange-500/30\",\n      medium: \"bg-amber-500/10 text-amber-400 border-amber-500/30\",\n      low: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\",\n    };\n    return styles[priority] || styles.low;\n  };\n\n  const canDelete = hasPermission(\"assets:delete\");\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 w-48 bg-muted rounded\" />\n          <div className=\"grid grid-cols-3 gap-4\">\n            {[1, 2, 3].map(i => (\n              <div key={i} className=\"h-40 bg-muted rounded-lg\" />\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"assets-page\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-foreground\">Assets</h1>\n        <p className=\"text-sm text-muted-foreground mt-1\">\n          Overview of all evaluated assets and their security posture\n        </p>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total Assets</CardTitle>\n            <Server className=\"h-4 w-4 text-cyan-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-3xl font-bold text-foreground\" data-testid=\"stat-total-assets\">\n              {assetSummaries.length}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">At Risk</CardTitle>\n            <AlertTriangle className=\"h-4 w-4 text-red-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-3xl font-bold text-foreground\" data-testid=\"stat-at-risk\">\n              {assetSummaries.filter(a => a.exploitableCount > 0).length}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Secure</CardTitle>\n            <CheckCircle className=\"h-4 w-4 text-emerald-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-3xl font-bold text-foreground\" data-testid=\"stat-secure\">\n              {assetSummaries.filter(a => a.exploitableCount === 0).length}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {assetSummaries.length === 0 ? (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <Server className=\"h-12 w-12 mx-auto mb-3 text-muted-foreground opacity-30\" />\n            <p className=\"text-muted-foreground\">No assets evaluated yet</p>\n            <p className=\"text-sm text-muted-foreground mt-1\">Run an evaluation to see assets here</p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {assetSummaries.map((asset) => (\n            <Card \n              key={asset.assetId} \n              className={`hover-elevate ${deletingAssetId === asset.assetId ? \"opacity-50\" : \"\"}`} \n              data-testid={`asset-card-${asset.assetId}`}\n            >\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-start justify-between gap-2\">\n                  <div className=\"flex items-center gap-2 min-w-0\">\n                    <div className=\"p-2 rounded-lg bg-muted/50\">\n                      <Server className=\"h-4 w-4 text-cyan-400\" />\n                    </div>\n                    <CardTitle className=\"text-sm font-medium truncate\" title={asset.assetId}>\n                      {asset.assetId}\n                    </CardTitle>\n                  </div>\n                  <div className=\"flex items-center gap-1\">\n                    <Badge className={getPriorityBadge(asset.highestPriority)}>\n                      {asset.highestPriority.toUpperCase()}\n                    </Badge>\n                    {canDelete && (\n                      <DropdownMenu>\n                        <DropdownMenuTrigger asChild>\n                          <Button variant=\"ghost\" size=\"icon\" className=\"h-7 w-7\" data-testid={`asset-menu-${asset.assetId}`}>\n                            <MoreVertical className=\"h-4 w-4\" />\n                          </Button>\n                        </DropdownMenuTrigger>\n                        <DropdownMenuContent align=\"end\">\n                          <DropdownMenuItem\n                            className=\"text-destructive focus:text-destructive\"\n                            onClick={() => setDeleteAsset(asset)}\n                            data-testid={`delete-asset-${asset.assetId}`}\n                          >\n                            <Trash2 className=\"h-4 w-4 mr-2\" />\n                            Delete Asset\n                          </DropdownMenuItem>\n                        </DropdownMenuContent>\n                      </DropdownMenu>\n                    )}\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"flex items-center justify-between text-sm\">\n                  <span className=\"text-muted-foreground\">Evaluations</span>\n                  <span className=\"font-mono\">{asset.evaluationCount}</span>\n                </div>\n                \n                <div className=\"flex items-center justify-between text-sm\">\n                  <span className=\"text-muted-foreground\">Exploitable</span>\n                  <span className={`font-mono ${asset.exploitableCount > 0 ? \"text-red-400\" : \"text-emerald-400\"}`}>\n                    {asset.exploitableCount}\n                  </span>\n                </div>\n\n                <div>\n                  <div className=\"flex items-center justify-between text-sm mb-1\">\n                    <span className=\"text-muted-foreground\">Avg Risk Score</span>\n                    <span className=\"font-mono\">{asset.avgScore}</span>\n                  </div>\n                  <Progress value={asset.avgScore} className=\"h-1.5\" />\n                </div>\n\n                <div className=\"flex items-center gap-1 flex-wrap\">\n                  {asset.exposureTypes.slice(0, 3).map((type) => (\n                    <Badge key={type} variant=\"outline\" className=\"text-xs\">\n                      {type.replace(\"_\", \" \")}\n                    </Badge>\n                  ))}\n                  {asset.exposureTypes.length > 3 && (\n                    <Badge variant=\"outline\" className=\"text-xs\">\n                      +{asset.exposureTypes.length - 3}\n                    </Badge>\n                  )}\n                </div>\n\n                <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n                  <Clock className=\"h-3 w-3\" />\n                  <span>Last: {new Date(asset.latestEvaluation).toLocaleDateString()}</span>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      <AlertDialog open={!!deleteAsset} onOpenChange={() => setDeleteAsset(null)}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Asset?</AlertDialogTitle>\n            <AlertDialogDescription>\n              This will permanently delete all {deleteAsset?.evaluationCount} evaluation(s) \n              for asset \"{deleteAsset?.assetId}\". This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"cancel-delete-asset\">Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              onClick={() => deleteAsset && handleDeleteAsset(deleteAsset)}\n              data-testid=\"confirm-delete-asset\"\n            >\n              Delete\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":13060,"size_tokens":null},"client/src/components/TimeToCompromiseMeter.tsx":{"content":"import { motion } from \"framer-motion\";\nimport { Clock, Zap, AlertTriangle, Shield } from \"lucide-react\";\n\ninterface TimeToCompromiseMeterProps {\n  expected: number;\n  minimum: number;\n  maximum: number;\n  unit: \"minutes\" | \"hours\" | \"days\";\n}\n\nexport function TimeToCompromiseMeter({ \n  expected, \n  minimum, \n  maximum, \n  unit \n}: TimeToCompromiseMeterProps) {\n  const normalizedHours = unit === \"minutes\" ? expected / 60 : unit === \"days\" ? expected * 24 : expected;\n  \n  const getUrgencyLevel = () => {\n    if (normalizedHours < 1) return { level: \"critical\", color: \"red\", label: \"Immediate\" };\n    if (normalizedHours < 4) return { level: \"high\", color: \"orange\", label: \"Urgent\" };\n    if (normalizedHours < 24) return { level: \"medium\", color: \"amber\", label: \"Moderate\" };\n    return { level: \"low\", color: \"emerald\", label: \"Extended\" };\n  };\n\n  const urgency = getUrgencyLevel();\n  \n  const maxDisplay = Math.max(maximum, expected * 1.5);\n  const expectedPercent = Math.min((expected / maxDisplay) * 100, 100);\n  const minPercent = (minimum / maxDisplay) * 100;\n  const maxPercent = (maximum / maxDisplay) * 100;\n\n  const colorClasses = {\n    red: {\n      bg: \"bg-red-500\",\n      bgFaded: \"bg-red-500/20\",\n      text: \"text-red-400\",\n      border: \"border-red-500/30\",\n      glow: \"shadow-red-500/20\",\n    },\n    orange: {\n      bg: \"bg-orange-500\",\n      bgFaded: \"bg-orange-500/20\",\n      text: \"text-orange-400\",\n      border: \"border-orange-500/30\",\n      glow: \"shadow-orange-500/20\",\n    },\n    amber: {\n      bg: \"bg-amber-500\",\n      bgFaded: \"bg-amber-500/20\",\n      text: \"text-amber-400\",\n      border: \"border-amber-500/30\",\n      glow: \"shadow-amber-500/20\",\n    },\n    emerald: {\n      bg: \"bg-emerald-500\",\n      bgFaded: \"bg-emerald-500/20\",\n      text: \"text-emerald-400\",\n      border: \"border-emerald-500/30\",\n      glow: \"shadow-emerald-500/20\",\n    },\n  };\n\n  const colors = colorClasses[urgency.color as keyof typeof colorClasses];\n\n  const getIcon = () => {\n    switch (urgency.level) {\n      case \"critical\": return <Zap className=\"h-5 w-5\" />;\n      case \"high\": return <AlertTriangle className=\"h-5 w-5\" />;\n      case \"medium\": return <Clock className=\"h-5 w-5\" />;\n      default: return <Shield className=\"h-5 w-5\" />;\n    }\n  };\n\n  return (\n    <div className=\"space-y-4\" data-testid=\"time-to-compromise-meter\">\n      <div className=\"flex items-center justify-between gap-4\">\n        <div className=\"flex items-center gap-3\">\n          <div className={`p-2 rounded-lg ${colors.bgFaded} ${colors.text}`}>\n            {getIcon()}\n          </div>\n          <div>\n            <h4 className=\"font-medium text-foreground\">Time to Compromise</h4>\n            <p className=\"text-xs text-muted-foreground\">Estimated exploitation timeframe</p>\n          </div>\n        </div>\n        <div className=\"text-right\">\n          <div className={`text-2xl font-bold ${colors.text}`}>\n            {expected} <span className=\"text-sm font-normal\">{unit}</span>\n          </div>\n          <div className={`text-xs ${colors.text} flex items-center gap-1 justify-end`}>\n            {getIcon()}\n            {urgency.label}\n          </div>\n        </div>\n      </div>\n\n      <div className=\"relative h-8\">\n        <div className=\"absolute inset-0 rounded-full bg-muted/50 overflow-hidden\">\n          <div\n            className={`absolute left-0 top-0 h-full ${colors.bgFaded} transition-all duration-300`}\n            style={{ width: `${maxPercent}%` }}\n          />\n          <div\n            className=\"absolute left-0 top-0 h-full bg-muted/30 transition-all duration-300\"\n            style={{ left: `${minPercent}%`, width: `${maxPercent - minPercent}%` }}\n          />\n        </div>\n        \n        <motion.div\n          className=\"absolute top-1/2 -translate-y-1/2 w-4 h-4\"\n          style={{ left: `${expectedPercent}%`, marginLeft: -8 }}\n          initial={{ scale: 0 }}\n          animate={{ scale: 1 }}\n          transition={{ delay: 0.5, type: \"spring\" }}\n        >\n          <div className={`w-full h-full rounded-full ${colors.bg} shadow-lg ${colors.glow} ring-2 ring-background`} />\n        </motion.div>\n\n        <div className=\"absolute bottom-[-20px] left-0 text-[10px] text-muted-foreground\">\n          {minimum}{unit.charAt(0)}\n        </div>\n        <div \n          className=\"absolute bottom-[-20px] text-[10px] text-muted-foreground\"\n          style={{ left: `${expectedPercent}%`, transform: \"translateX(-50%)\" }}\n        >\n          <span className={colors.text}>{expected}{unit.charAt(0)}</span>\n        </div>\n        <div className=\"absolute bottom-[-20px] right-0 text-[10px] text-muted-foreground\">\n          {maximum}{unit.charAt(0)}\n        </div>\n      </div>\n\n      <div className=\"pt-4 grid grid-cols-4 gap-2 text-center text-xs\">\n        <div className={`p-2 rounded-md ${urgency.level === \"critical\" ? colors.bgFaded + \" \" + colors.border + \" border\" : \"bg-muted/30\"}`}>\n          <span className={urgency.level === \"critical\" ? colors.text : \"text-muted-foreground\"}>Immediate</span>\n          <div className=\"text-[10px] text-muted-foreground mt-0.5\">&lt;1h</div>\n        </div>\n        <div className={`p-2 rounded-md ${urgency.level === \"high\" ? colors.bgFaded + \" \" + colors.border + \" border\" : \"bg-muted/30\"}`}>\n          <span className={urgency.level === \"high\" ? colors.text : \"text-muted-foreground\"}>Urgent</span>\n          <div className=\"text-[10px] text-muted-foreground mt-0.5\">1-4h</div>\n        </div>\n        <div className={`p-2 rounded-md ${urgency.level === \"medium\" ? colors.bgFaded + \" \" + colors.border + \" border\" : \"bg-muted/30\"}`}>\n          <span className={urgency.level === \"medium\" ? colors.text : \"text-muted-foreground\"}>Moderate</span>\n          <div className=\"text-[10px] text-muted-foreground mt-0.5\">4-24h</div>\n        </div>\n        <div className={`p-2 rounded-md ${urgency.level === \"low\" ? colors.bgFaded + \" \" + colors.border + \" border\" : \"bg-muted/30\"}`}>\n          <span className={urgency.level === \"low\" ? colors.text : \"text-muted-foreground\"}>Extended</span>\n          <div className=\"text-[10px] text-muted-foreground mt-0.5\">&gt;24h</div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6194,"size_tokens":null},"client/src/pages/RiskDashboard.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { AlertTriangle, Clock, TrendingUp, Shield, Filter, ArrowUpRight, Building2, Trash2 } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { useState } from \"react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface EvaluationWithScore {\n  id: string;\n  assetId: string;\n  exposureType: string;\n  priority: string;\n  description: string;\n  status: string;\n  createdAt: string;\n  exploitable?: boolean;\n  score?: number;\n  intelligentScore?: {\n    riskRank: {\n      overallScore: number;\n      riskLevel: string;\n      executiveLabel: string;\n      fixPriority: number;\n      recommendation: {\n        action: string;\n        timeframe: string;\n        justification: string;\n      };\n    };\n    businessImpact: {\n      score: number;\n      riskLabel: string;\n      factors: {\n        financialExposure: {\n          directLoss: { min: number; max: number };\n        };\n        complianceImpact: {\n          affectedFrameworks: string[];\n        };\n      };\n    };\n    exploitability: {\n      score: number;\n    };\n  };\n}\n\nexport default function RiskDashboard() {\n  const { toast } = useToast();\n  const [riskFilter, setRiskFilter] = useState<string>(\"all\");\n  const [timeframeFilter, setTimeframeFilter] = useState<string>(\"all\");\n\n  const { data: evaluations = [], isLoading } = useQuery<EvaluationWithScore[]>({\n    queryKey: [\"/api/aev/evaluations\"],\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/aev/evaluations/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/aev/evaluations\"] });\n      toast({\n        title: \"Evaluation removed\",\n        description: \"The evaluation has been deleted from the queue\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Delete failed\",\n        description: \"Failed to delete the evaluation\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const evaluationsWithScores = evaluations.filter(e => e.intelligentScore);\n\n  const filteredEvaluations = evaluationsWithScores\n    .filter(e => {\n      if (riskFilter !== \"all\" && e.intelligentScore?.riskRank.riskLevel !== riskFilter) return false;\n      if (timeframeFilter !== \"all\" && e.intelligentScore?.riskRank.recommendation.timeframe !== timeframeFilter) return false;\n      return true;\n    })\n    .sort((a, b) => {\n      const aPriority = a.intelligentScore?.riskRank.fixPriority ?? 100;\n      const bPriority = b.intelligentScore?.riskRank.fixPriority ?? 100;\n      return aPriority - bPriority;\n    });\n\n  const getRiskLevelColor = (level: string) => {\n    const colors: Record<string, string> = {\n      emergency: \"bg-red-600 text-white\",\n      critical: \"bg-red-500/10 text-red-400 border-red-500/30\",\n      high: \"bg-orange-500/10 text-orange-400 border-orange-500/30\",\n      medium: \"bg-amber-500/10 text-amber-400 border-amber-500/30\",\n      low: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\",\n      info: \"bg-blue-500/10 text-blue-400 border-blue-500/30\",\n    };\n    return colors[level] || colors.medium;\n  };\n\n  const getTimeframeColor = (timeframe: string) => {\n    const colors: Record<string, string> = {\n      immediate: \"bg-red-500/10 text-red-400 border-red-500/30\",\n      \"24_hours\": \"bg-orange-500/10 text-orange-400 border-orange-500/30\",\n      \"7_days\": \"bg-amber-500/10 text-amber-400 border-amber-500/30\",\n      \"30_days\": \"bg-blue-500/10 text-blue-400 border-blue-500/30\",\n      \"90_days\": \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\",\n      acceptable_risk: \"bg-gray-500/10 text-gray-400 border-gray-500/30\",\n    };\n    return colors[timeframe] || colors[\"30_days\"];\n  };\n\n  const getTimeframeLabel = (timeframe: string) => {\n    const labels: Record<string, string> = {\n      immediate: \"Immediate\",\n      \"24_hours\": \"24 Hours\",\n      \"7_days\": \"7 Days\",\n      \"30_days\": \"30 Days\",\n      \"90_days\": \"90 Days\",\n      acceptable_risk: \"Accept Risk\",\n    };\n    return labels[timeframe] || timeframe;\n  };\n\n  const formatCurrency = (value: number) => {\n    if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;\n    if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;\n    return `$${value.toFixed(0)}`;\n  };\n\n  const stats = {\n    critical: evaluationsWithScores.filter(e => e.intelligentScore?.riskRank.riskLevel === \"critical\" || e.intelligentScore?.riskRank.riskLevel === \"emergency\").length,\n    high: evaluationsWithScores.filter(e => e.intelligentScore?.riskRank.riskLevel === \"high\").length,\n    medium: evaluationsWithScores.filter(e => e.intelligentScore?.riskRank.riskLevel === \"medium\").length,\n    low: evaluationsWithScores.filter(e => e.intelligentScore?.riskRank.riskLevel === \"low\" || e.intelligentScore?.riskRank.riskLevel === \"info\").length,\n    totalExposure: evaluationsWithScores.reduce((sum, e) => {\n      const max = e.intelligentScore?.businessImpact.factors.financialExposure.directLoss.max || 0;\n      return sum + max;\n    }, 0),\n    avgRiskScore: evaluationsWithScores.length > 0\n      ? Math.round(evaluationsWithScores.reduce((sum, e) => sum + (e.intelligentScore?.riskRank.overallScore || 0), 0) / evaluationsWithScores.length)\n      : 0,\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 w-48 bg-muted rounded\" />\n          <div className=\"grid grid-cols-4 gap-4\">\n            {[1, 2, 3, 4].map(i => (\n              <div key={i} className=\"h-32 bg-muted rounded-lg\" />\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"risk-dashboard\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-foreground\">Risk Dashboard</h1>\n          <p className=\"text-sm text-muted-foreground mt-1\">\n            Executive view of security risks prioritized by business impact\n          </p>\n        </div>\n        <div className=\"flex items-center gap-3 flex-wrap\">\n          <div className=\"flex items-center gap-2\">\n            <Filter className=\"h-4 w-4 text-muted-foreground\" />\n            <Select value={riskFilter} onValueChange={setRiskFilter}>\n              <SelectTrigger className=\"w-[140px]\" data-testid=\"select-risk-filter\">\n                <SelectValue placeholder=\"Risk Level\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Levels</SelectItem>\n                <SelectItem value=\"emergency\">Emergency</SelectItem>\n                <SelectItem value=\"critical\">Critical</SelectItem>\n                <SelectItem value=\"high\">High</SelectItem>\n                <SelectItem value=\"medium\">Medium</SelectItem>\n                <SelectItem value=\"low\">Low</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          <Select value={timeframeFilter} onValueChange={setTimeframeFilter}>\n            <SelectTrigger className=\"w-[140px]\" data-testid=\"select-timeframe-filter\">\n              <SelectValue placeholder=\"Timeframe\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Timeframes</SelectItem>\n              <SelectItem value=\"immediate\">Immediate</SelectItem>\n              <SelectItem value=\"24_hours\">24 Hours</SelectItem>\n              <SelectItem value=\"7_days\">7 Days</SelectItem>\n              <SelectItem value=\"30_days\">30 Days</SelectItem>\n              <SelectItem value=\"90_days\">90 Days</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Critical/Emergency</CardTitle>\n            <AlertTriangle className=\"h-4 w-4 text-red-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-3xl font-bold text-foreground\" data-testid=\"stat-critical\">{stats.critical}</div>\n            <p className=\"text-xs text-muted-foreground mt-1\">Require immediate attention</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">High Priority</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-orange-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-3xl font-bold text-foreground\" data-testid=\"stat-high\">{stats.high}</div>\n            <p className=\"text-xs text-muted-foreground mt-1\">Should be addressed soon</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total Exposure</CardTitle>\n            <Building2 className=\"h-4 w-4 text-cyan-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-3xl font-bold text-foreground\" data-testid=\"stat-exposure\">{formatCurrency(stats.totalExposure)}</div>\n            <p className=\"text-xs text-muted-foreground mt-1\">Maximum financial risk</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Avg Risk Score</CardTitle>\n            <Shield className=\"h-4 w-4 text-purple-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-3xl font-bold text-foreground\" data-testid=\"stat-avg-score\">{stats.avgRiskScore}</div>\n            <Progress value={stats.avgRiskScore} className=\"mt-2 h-1.5\" />\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Clock className=\"h-5 w-5 text-cyan-400\" />\n            Fix Priority Queue\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {filteredEvaluations.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              <Shield className=\"h-12 w-12 mx-auto mb-3 opacity-30\" />\n              <p>No evaluations with intelligent scores yet</p>\n              <p className=\"text-sm mt-1\">Run an evaluation to see risk prioritization</p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {filteredEvaluations.map((evaluation, index) => (\n                <div\n                  key={evaluation.id}\n                  className=\"flex items-center gap-4 p-4 bg-muted/20 rounded-lg border border-border hover-elevate\"\n                  data-testid={`risk-item-${evaluation.id}`}\n                >\n                  <div className=\"flex items-center justify-center w-8 h-8 rounded-full bg-muted font-mono text-sm font-bold\">\n                    {index + 1}\n                  </div>\n\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      <span className=\"font-medium text-foreground truncate\">{evaluation.assetId}</span>\n                      <Badge className={getRiskLevelColor(evaluation.intelligentScore?.riskRank.riskLevel || \"medium\")}>\n                        {evaluation.intelligentScore?.riskRank.riskLevel?.toUpperCase()}\n                      </Badge>\n                      <Badge className={getTimeframeColor(evaluation.intelligentScore?.riskRank.recommendation.timeframe || \"30_days\")}>\n                        <Clock className=\"h-3 w-3 mr-1\" />\n                        {getTimeframeLabel(evaluation.intelligentScore?.riskRank.recommendation.timeframe || \"30_days\")}\n                      </Badge>\n                    </div>\n                    <p className=\"text-sm text-muted-foreground mt-1 truncate\">\n                      {evaluation.intelligentScore?.riskRank.executiveLabel}\n                    </p>\n                  </div>\n\n                  <div className=\"text-right hidden sm:block\">\n                    <div className=\"text-sm text-muted-foreground\">Financial Exposure</div>\n                    <div className=\"font-semibold text-foreground\">\n                      {formatCurrency(evaluation.intelligentScore?.businessImpact.factors.financialExposure.directLoss.max || 0)}\n                    </div>\n                  </div>\n\n                  <div className=\"text-right hidden md:block\">\n                    <div className=\"text-sm text-muted-foreground\">Risk Score</div>\n                    <div className=\"font-mono font-bold text-lg text-foreground\">\n                      {evaluation.intelligentScore?.riskRank.overallScore}\n                    </div>\n                  </div>\n\n                  <div className=\"hidden lg:flex flex-wrap gap-1 max-w-[150px]\">\n                    {evaluation.intelligentScore?.businessImpact.factors.complianceImpact.affectedFrameworks.slice(0, 3).map((fw) => (\n                      <Badge key={fw} variant=\"outline\" className=\"text-xs\">\n                        {fw.toUpperCase()}\n                      </Badge>\n                    ))}\n                  </div>\n\n                  <Button variant=\"ghost\" size=\"icon\" asChild>\n                    <a href={`/?evaluation=${evaluation.id}`} data-testid={`link-evaluation-${evaluation.id}`}>\n                      <ArrowUpRight className=\"h-4 w-4\" />\n                    </a>\n                  </Button>\n\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={() => deleteMutation.mutate(evaluation.id)}\n                    disabled={deleteMutation.isPending}\n                    data-testid={`btn-delete-risk-${evaluation.id}`}\n                  >\n                    <Trash2 className=\"h-4 w-4 text-muted-foreground\" />\n                  </Button>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {evaluationsWithScores.length > 0 && (\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg\">Risk Distribution</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-muted-foreground\">Critical/Emergency</span>\n                  <div className=\"flex items-center gap-2\">\n                    <Progress value={(stats.critical / evaluationsWithScores.length) * 100} className=\"w-32 h-2\" />\n                    <span className=\"text-sm font-mono w-8\">{stats.critical}</span>\n                  </div>\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-muted-foreground\">High</span>\n                  <div className=\"flex items-center gap-2\">\n                    <Progress value={(stats.high / evaluationsWithScores.length) * 100} className=\"w-32 h-2\" />\n                    <span className=\"text-sm font-mono w-8\">{stats.high}</span>\n                  </div>\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-muted-foreground\">Medium</span>\n                  <div className=\"flex items-center gap-2\">\n                    <Progress value={(stats.medium / evaluationsWithScores.length) * 100} className=\"w-32 h-2\" />\n                    <span className=\"text-sm font-mono w-8\">{stats.medium}</span>\n                  </div>\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-muted-foreground\">Low/Info</span>\n                  <div className=\"flex items-center gap-2\">\n                    <Progress value={(stats.low / evaluationsWithScores.length) * 100} className=\"w-32 h-2\" />\n                    <span className=\"text-sm font-mono w-8\">{stats.low}</span>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg\">Top Actions Required</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-3\">\n                {filteredEvaluations.slice(0, 5).map((evaluation) => (\n                  <div key={evaluation.id} className=\"flex items-start gap-3\">\n                    <AlertTriangle className={`h-4 w-4 mt-0.5 ${\n                      evaluation.intelligentScore?.riskRank.riskLevel === \"critical\" || evaluation.intelligentScore?.riskRank.riskLevel === \"emergency\"\n                        ? \"text-red-400\"\n                        : evaluation.intelligentScore?.riskRank.riskLevel === \"high\"\n                        ? \"text-orange-400\"\n                        : \"text-amber-400\"\n                    }`} />\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-sm font-medium text-foreground truncate\">\n                        {evaluation.intelligentScore?.riskRank.recommendation.action}\n                      </p>\n                      <p className=\"text-xs text-muted-foreground\">{evaluation.assetId}</p>\n                    </div>\n                  </div>\n                ))}\n                {filteredEvaluations.length === 0 && (\n                  <p className=\"text-sm text-muted-foreground text-center py-4\">No actions pending</p>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":18379,"size_tokens":null},"server/services/agents/evidence-collector.ts":{"content":"import type {\n  EvidenceArtifact,\n  EvidencePacket,\n  AttackPathStep,\n  BusinessLogicFinding,\n  MultiVectorFinding,\n} from \"@shared/schema\";\n\nexport interface EvidenceContext {\n  evaluationId: string;\n  assetId: string;\n  exposureType: string;\n  attackPath?: AttackPathStep[];\n  businessLogicFindings?: BusinessLogicFinding[];\n  multiVectorFindings?: MultiVectorFinding[];\n}\n\nexport class EvidenceCollector {\n  private artifacts: EvidenceArtifact[] = [];\n  private timeline: Array<{ timestamp: string; event: string; artifactId?: string }> = [];\n\n  constructor(private context: EvidenceContext) {}\n\n  captureRequestResponse(\n    title: string,\n    description: string,\n    request: {\n      method: string;\n      url: string;\n      headers?: Record<string, string>;\n      body?: string;\n    },\n    response: {\n      statusCode: number;\n      headers?: Record<string, string>;\n      body?: string;\n      timing?: number;\n    },\n    attackStepId?: number\n  ): EvidenceArtifact {\n    const artifact: EvidenceArtifact = {\n      id: `artifact-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      type: \"request_response\",\n      timestamp: new Date().toISOString(),\n      title,\n      description,\n      data: {\n        request: this.sanitizeRequest(request),\n        response: this.sanitizeResponse(response),\n      },\n      attackStepId,\n      isSanitized: true,\n    };\n\n    this.artifacts.push(artifact);\n    this.addTimelineEvent(`Captured request/response: ${title}`, artifact.id);\n    return artifact;\n  }\n\n  captureExecutionTrace(\n    title: string,\n    description: string,\n    steps: Array<{\n      step: number;\n      action: string;\n      result: string;\n      duration?: number;\n    }>,\n    attackStepId?: number\n  ): EvidenceArtifact {\n    const artifact: EvidenceArtifact = {\n      id: `artifact-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      type: \"execution_trace\",\n      timestamp: new Date().toISOString(),\n      title,\n      description,\n      data: {\n        trace: steps,\n      },\n      attackStepId,\n      isSanitized: true,\n    };\n\n    this.artifacts.push(artifact);\n    this.addTimelineEvent(`Captured execution trace: ${title}`, artifact.id);\n    return artifact;\n  }\n\n  captureLogEntries(\n    title: string,\n    description: string,\n    logs: Array<{\n      timestamp: string;\n      level: \"debug\" | \"info\" | \"warn\" | \"error\";\n      message: string;\n      source?: string;\n    }>,\n    findingId?: string\n  ): EvidenceArtifact {\n    const artifact: EvidenceArtifact = {\n      id: `artifact-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      type: \"log_capture\",\n      timestamp: new Date().toISOString(),\n      title,\n      description,\n      data: {\n        logs: logs.map((log) => ({\n          ...log,\n          message: this.sanitizeLogMessage(log.message),\n        })),\n      },\n      findingId,\n      isSanitized: true,\n    };\n\n    this.artifacts.push(artifact);\n    this.addTimelineEvent(`Captured logs: ${title}`, artifact.id);\n    return artifact;\n  }\n\n  captureTimelineEvent(\n    event: string,\n    details?: string\n  ): void {\n    const artifact: EvidenceArtifact = {\n      id: `artifact-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      type: \"timeline_event\",\n      timestamp: new Date().toISOString(),\n      title: event,\n      description: details || event,\n      data: {},\n      isSanitized: true,\n    };\n\n    this.artifacts.push(artifact);\n    this.addTimelineEvent(event, artifact.id);\n  }\n\n  private addTimelineEvent(event: string, artifactId?: string): void {\n    this.timeline.push({\n      timestamp: new Date().toISOString(),\n      event,\n      artifactId,\n    });\n  }\n\n  private sanitizeRequest(request: {\n    method: string;\n    url: string;\n    headers?: Record<string, string>;\n    body?: string;\n  }): typeof request {\n    const sanitized = { ...request };\n    \n    if (sanitized.headers) {\n      const sensitiveHeaders = [\"authorization\", \"cookie\", \"x-api-key\", \"x-auth-token\"];\n      sanitized.headers = { ...sanitized.headers };\n      for (const header of sensitiveHeaders) {\n        if (sanitized.headers[header]) {\n          sanitized.headers[header] = \"[REDACTED]\";\n        }\n      }\n    }\n\n    if (sanitized.body) {\n      sanitized.body = this.sanitizeBody(sanitized.body);\n    }\n\n    return sanitized;\n  }\n\n  private sanitizeResponse(response: {\n    statusCode: number;\n    headers?: Record<string, string>;\n    body?: string;\n    timing?: number;\n  }): typeof response {\n    const sanitized = { ...response };\n    \n    if (sanitized.headers) {\n      const sensitiveHeaders = [\"set-cookie\", \"x-amz-security-token\"];\n      sanitized.headers = { ...sanitized.headers };\n      for (const header of sensitiveHeaders) {\n        if (sanitized.headers[header]) {\n          sanitized.headers[header] = \"[REDACTED]\";\n        }\n      }\n    }\n\n    if (sanitized.body) {\n      sanitized.body = this.sanitizeBody(sanitized.body);\n    }\n\n    return sanitized;\n  }\n\n  private sanitizeBody(body: string): string {\n    const sensitivePatterns = [\n      /password['\":\\s]*['\"]?[^'\"}\\s,]+/gi,\n      /api[_-]?key['\":\\s]*['\"]?[^'\"}\\s,]+/gi,\n      /secret['\":\\s]*['\"]?[^'\"}\\s,]+/gi,\n      /token['\":\\s]*['\"]?[^'\"}\\s,]+/gi,\n      /\\b[A-Za-z0-9+/]{40,}\\b/g,\n    ];\n\n    let sanitized = body;\n    for (const pattern of sensitivePatterns) {\n      sanitized = sanitized.replace(pattern, \"[REDACTED]\");\n    }\n    return sanitized;\n  }\n\n  private sanitizeLogMessage(message: string): string {\n    return this.sanitizeBody(message);\n  }\n\n  getArtifacts(): EvidenceArtifact[] {\n    return this.artifacts;\n  }\n\n  generatePacket(): EvidencePacket {\n    const criticalFindings = [\n      ...(this.context.attackPath?.filter((s) => s.severity === \"critical\") || []),\n      ...(this.context.businessLogicFindings?.filter((f) => f.severity === \"critical\") || []),\n      ...(this.context.multiVectorFindings?.filter((f) => f.severity === \"critical\") || []),\n    ].length;\n\n    return {\n      id: `packet-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      evaluationId: this.context.evaluationId,\n      createdAt: new Date().toISOString(),\n      title: `Evidence Packet: ${this.context.assetId}`,\n      summary: this.generateSummary(),\n      artifacts: this.artifacts,\n      timeline: this.timeline,\n      executiveSummary: this.generateExecutiveSummary(),\n      replayInstructions: this.generateReplayInstructions(),\n      metadata: {\n        evaluationType: this.context.exposureType,\n        assetId: this.context.assetId,\n        totalArtifacts: this.artifacts.length,\n        criticalFindings,\n      },\n    };\n  }\n\n  private generateSummary(): string {\n    const artifactCounts = this.artifacts.reduce(\n      (acc, a) => {\n        acc[a.type] = (acc[a.type] || 0) + 1;\n        return acc;\n      },\n      {} as Record<string, number>\n    );\n\n    const parts = Object.entries(artifactCounts)\n      .map(([type, count]) => `${count} ${type.replace(\"_\", \" \")}(s)`)\n      .join(\", \");\n\n    return `Evidence collection for ${this.context.assetId} (${this.context.exposureType}): ${parts || \"No artifacts captured\"}`;\n  }\n\n  private generateExecutiveSummary(): string {\n    const attackSteps = this.context.attackPath?.length || 0;\n    const businessFindings = this.context.businessLogicFindings?.length || 0;\n    const multiVectorFindings = this.context.multiVectorFindings?.length || 0;\n\n    return `Security validation completed for asset ${this.context.assetId}. ` +\n      `Analysis identified ${attackSteps} attack path steps, ` +\n      `${businessFindings} business logic findings, and ` +\n      `${multiVectorFindings} multi-vector findings. ` +\n      `${this.artifacts.length} evidence artifacts were captured to support these findings.`;\n  }\n\n  private generateReplayInstructions(): string {\n    const requestArtifacts = this.artifacts.filter((a) => a.type === \"request_response\");\n    \n    if (requestArtifacts.length === 0) {\n      return \"No replay instructions available - execution traces can be reviewed in the timeline.\";\n    }\n\n    return `To replay the attack path:\\n` +\n      requestArtifacts\n        .map((a, i) => `${i + 1}. ${a.title}: Review the captured request/response pair`)\n        .join(\"\\n\") +\n      `\\n\\nNote: All sensitive data has been sanitized. Actual credentials and tokens were redacted for security.`;\n  }\n}\n\nexport function generateEvidenceFromAnalysis(\n  context: EvidenceContext,\n  aiAnalysisSteps?: Array<{ action: string; observation: string; duration?: number }>\n): EvidenceArtifact[] {\n  const collector = new EvidenceCollector(context);\n\n  collector.captureTimelineEvent(\"Evaluation started\", `Beginning analysis of ${context.assetId}`);\n\n  if (aiAnalysisSteps) {\n    collector.captureExecutionTrace(\n      \"AI Analysis Execution\",\n      \"Step-by-step AI reasoning and observations\",\n      aiAnalysisSteps.map((step, i) => ({\n        step: i + 1,\n        action: step.action,\n        result: step.observation,\n        duration: step.duration,\n      }))\n    );\n  }\n\n  if (context.attackPath) {\n    for (const step of context.attackPath) {\n      collector.captureTimelineEvent(\n        `Attack Step ${step.id}: ${step.title}`,\n        step.description\n      );\n\n      if (step.technique) {\n        collector.captureExecutionTrace(\n          `Technique: ${step.technique}`,\n          step.description,\n          [\n            {\n              step: 1,\n              action: `Execute ${step.technique}`,\n              result: `Severity: ${step.severity}`,\n            },\n          ],\n          step.id\n        );\n      }\n    }\n  }\n\n  if (context.businessLogicFindings) {\n    for (const finding of context.businessLogicFindings) {\n      collector.captureExecutionTrace(\n        `Business Logic: ${finding.title}`,\n        finding.description,\n        finding.exploitSteps.map((step, i) => ({\n          step: i + 1,\n          action: step,\n          result: i === finding.exploitSteps.length - 1 ? finding.impact : \"Step completed\",\n        })),\n        undefined\n      );\n\n      if (finding.proofOfConcept) {\n        collector.captureLogEntries(\n          `Proof of Concept: ${finding.title}`,\n          \"Captured proof of concept evidence\",\n          [\n            {\n              timestamp: new Date().toISOString(),\n              level: \"info\",\n              message: finding.proofOfConcept,\n              source: \"business-logic-engine\",\n            },\n          ],\n          finding.id\n        );\n      }\n    }\n  }\n\n  collector.captureTimelineEvent(\"Evaluation completed\", \"All analysis steps finished\");\n\n  return collector.getArtifacts();\n}\n","path":null,"size_bytes":10568,"size_tokens":null},"client/src/pages/Infrastructure.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { \n  Server, \n  Upload, \n  Cloud, \n  AlertTriangle, \n  CheckCircle,\n  Trash2,\n  RefreshCw,\n  FileUp,\n  Play,\n  Eye,\n  Search,\n  Filter,\n  Download,\n  MoreVertical,\n  Database,\n  Globe,\n  Shield\n} from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Progress } from \"@/components/ui/progress\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\n\ninterface DiscoveredAsset {\n  id: string;\n  assetIdentifier: string;\n  displayName: string | null;\n  assetType: string;\n  status: string | null;\n  ipAddresses: string[] | null;\n  hostname: string | null;\n  fqdn: string | null;\n  cloudProvider: string | null;\n  cloudRegion: string | null;\n  operatingSystem: string | null;\n  criticality: string | null;\n  environment: string | null;\n  openPorts: Array<{port: number; protocol: string; service?: string}> | null;\n  createdAt: string;\n}\n\ninterface VulnerabilityImport {\n  id: string;\n  title: string;\n  severity: string;\n  cveId: string | null;\n  affectedHost: string | null;\n  affectedPort: number | null;\n  status: string | null;\n  aevEvaluationId: string | null;\n  createdAt: string;\n}\n\ninterface ImportJob {\n  id: string;\n  name: string;\n  sourceType: string;\n  status: string;\n  progress: number;\n  totalRecords: number | null;\n  assetsDiscovered: number | null;\n  vulnerabilitiesFound: number | null;\n  createdAt: string;\n  completedAt: string | null;\n}\n\ninterface CloudConnection {\n  id: string;\n  name: string;\n  provider: string;\n  status: string;\n  lastSyncAt: string | null;\n  assetsDiscovered: number | null;\n  createdAt: string;\n}\n\ninterface InfraStats {\n  totalAssets: number;\n  totalVulnerabilities: number;\n  criticalVulns: number;\n  highVulns: number;\n  pendingImports: number;\n  cloudConnections: number;\n}\n\nexport default function Infrastructure() {\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"assets\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [importDialogOpen, setImportDialogOpen] = useState(false);\n  const [cloudDialogOpen, setCloudDialogOpen] = useState(false);\n  const [selectedAsset, setSelectedAsset] = useState<DiscoveredAsset | null>(null);\n\n  // Queries\n  const { data: stats, isLoading: statsLoading } = useQuery<InfraStats>({\n    queryKey: [\"/api/infrastructure/stats\"],\n  });\n\n  const { data: assets = [], isLoading: assetsLoading } = useQuery<DiscoveredAsset[]>({\n    queryKey: [\"/api/assets\"],\n  });\n\n  const { data: vulnerabilities = [], isLoading: vulnsLoading } = useQuery<VulnerabilityImport[]>({\n    queryKey: [\"/api/vulnerabilities\"],\n  });\n\n  const { data: importJobs = [], isLoading: jobsLoading } = useQuery<ImportJob[]>({\n    queryKey: [\"/api/imports\"],\n  });\n\n  const { data: cloudConnections = [], isLoading: cloudLoading } = useQuery<CloudConnection[]>({\n    queryKey: [\"/api/cloud-connections\"],\n  });\n\n  // Import mutation\n  const uploadMutation = useMutation({\n    mutationFn: async (data: { content: string; fileName: string; name: string }) => {\n      const res = await apiRequest(\"POST\", \"/api/imports/upload\", data);\n      return res.json();\n    },\n    onSuccess: (data: unknown) => {\n      const result = data as { summary: { assetsDiscovered: number; vulnerabilitiesFound: number } };\n      queryClient.invalidateQueries({ queryKey: [\"/api/assets\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/vulnerabilities\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/imports\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/infrastructure/stats\"] });\n      setImportDialogOpen(false);\n      toast({\n        title: \"Import Complete\",\n        description: `Discovered ${result.summary.assetsDiscovered} assets and ${result.summary.vulnerabilitiesFound} vulnerabilities`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Import Failed\",\n        description: \"Failed to process the import file\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Create AEV evaluation from vulnerability\n  const evaluateMutation = useMutation({\n    mutationFn: async (vulnId: string) => {\n      const res = await apiRequest(\"POST\", `/api/vulnerabilities/${vulnId}/evaluate`);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/vulnerabilities\"] });\n      toast({\n        title: \"Evaluation Started\",\n        description: \"AEV analysis has been initiated for this vulnerability\",\n      });\n    },\n  });\n\n  // Delete import job\n  const deleteImportMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/imports/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/imports\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/assets\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/vulnerabilities\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/infrastructure/stats\"] });\n      toast({ title: \"Import Deleted\" });\n    },\n  });\n\n  // Create cloud connection\n  const createCloudMutation = useMutation({\n    mutationFn: async (data: { name: string; provider: string }) => {\n      const res = await apiRequest(\"POST\", \"/api/cloud-connections\", data);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cloud-connections\"] });\n      setCloudDialogOpen(false);\n      toast({ title: \"Cloud Connection Created\" });\n    },\n  });\n\n  // Test cloud connection\n  const testCloudMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"POST\", `/api/cloud-connections/${id}/test`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cloud-connections\"] });\n      toast({ title: \"Connection Test Successful\" });\n    },\n  });\n\n  // Delete cloud connection\n  const deleteCloudMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/cloud-connections/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cloud-connections\"] });\n      toast({ title: \"Cloud Connection Deleted\" });\n    },\n  });\n\n  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    const reader = new FileReader();\n    reader.onload = (event) => {\n      const content = event.target?.result as string;\n      uploadMutation.mutate({\n        content,\n        fileName: file.name,\n        name: file.name.replace(/\\.[^/.]+$/, \"\"),\n      });\n    };\n    reader.readAsText(file);\n  };\n\n  const getSeverityBadge = (severity: string) => {\n    const styles: Record<string, string> = {\n      critical: \"bg-red-500/10 text-red-400 border-red-500/30\",\n      high: \"bg-orange-500/10 text-orange-400 border-orange-500/30\",\n      medium: \"bg-amber-500/10 text-amber-400 border-amber-500/30\",\n      low: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\",\n      informational: \"bg-blue-500/10 text-blue-400 border-blue-500/30\",\n    };\n    return styles[severity] || styles.medium;\n  };\n\n  const getStatusBadge = (status: string) => {\n    const styles: Record<string, string> = {\n      connected: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\",\n      completed: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\",\n      active: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\",\n      processing: \"bg-amber-500/10 text-amber-400 border-amber-500/30\",\n      pending: \"bg-blue-500/10 text-blue-400 border-blue-500/30\",\n      error: \"bg-red-500/10 text-red-400 border-red-500/30\",\n      failed: \"bg-red-500/10 text-red-400 border-red-500/30\",\n      disconnected: \"bg-gray-500/10 text-gray-400 border-gray-500/30\",\n    };\n    return styles[status] || styles.pending;\n  };\n\n  const getAssetTypeIcon = (type: string) => {\n    switch(type) {\n      case \"database\": return <Database className=\"h-4 w-4\" />;\n      case \"web_application\": return <Globe className=\"h-4 w-4\" />;\n      case \"cloud_instance\": return <Cloud className=\"h-4 w-4\" />;\n      case \"firewall\": return <Shield className=\"h-4 w-4\" />;\n      default: return <Server className=\"h-4 w-4\" />;\n    }\n  };\n\n  const filteredAssets = assets.filter(a => \n    a.assetIdentifier.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    a.displayName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    a.hostname?.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  const filteredVulns = vulnerabilities.filter(v =>\n    v.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    v.cveId?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    v.affectedHost?.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"infrastructure-page\">\n      <div className=\"flex items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-foreground\">Infrastructure</h1>\n          <p className=\"text-sm text-muted-foreground mt-1\">\n            Manage discovered assets, vulnerability imports, and cloud connections\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Dialog open={importDialogOpen} onOpenChange={setImportDialogOpen}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"button-import\">\n                <Upload className=\"h-4 w-4 mr-2\" />\n                Import\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Import Scanner Data</DialogTitle>\n                <DialogDescription>\n                  Upload a vulnerability scan file (Nessus, Qualys, CSV, or JSON format)\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-4 py-4\">\n                <div className=\"border-2 border-dashed border-muted rounded-lg p-8 text-center\">\n                  <FileUp className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n                  <Label htmlFor=\"file-upload\" className=\"cursor-pointer\">\n                    <span className=\"text-foreground font-medium\">Click to upload</span>\n                    <span className=\"text-muted-foreground\"> or drag and drop</span>\n                  </Label>\n                  <Input\n                    id=\"file-upload\"\n                    type=\"file\"\n                    accept=\".csv,.json,.xml,.nessus\"\n                    className=\"hidden\"\n                    onChange={handleFileUpload}\n                    data-testid=\"input-file-upload\"\n                  />\n                  <p className=\"text-xs text-muted-foreground mt-2\">\n                    Supported formats: .nessus, .xml, .csv, .json\n                  </p>\n                </div>\n                {uploadMutation.isPending && (\n                  <div className=\"space-y-2\">\n                    <Progress value={50} />\n                    <p className=\"text-sm text-center text-muted-foreground\">Processing...</p>\n                  </div>\n                )}\n              </div>\n            </DialogContent>\n          </Dialog>\n\n          <Dialog open={cloudDialogOpen} onOpenChange={setCloudDialogOpen}>\n            <DialogTrigger asChild>\n              <Button variant=\"outline\" data-testid=\"button-add-cloud\">\n                <Cloud className=\"h-4 w-4 mr-2\" />\n                Add Cloud\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Connect Cloud Account</DialogTitle>\n                <DialogDescription>\n                  Connect AWS, Azure, or GCP for automatic asset discovery\n                </DialogDescription>\n              </DialogHeader>\n              <form onSubmit={(e) => {\n                e.preventDefault();\n                const formData = new FormData(e.currentTarget);\n                createCloudMutation.mutate({\n                  name: formData.get(\"name\") as string,\n                  provider: formData.get(\"provider\") as string,\n                });\n              }}>\n                <div className=\"space-y-4 py-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"cloud-name\">Connection Name</Label>\n                    <Input\n                      id=\"cloud-name\"\n                      name=\"name\"\n                      placeholder=\"Production AWS Account\"\n                      required\n                      data-testid=\"input-cloud-name\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"cloud-provider\">Cloud Provider</Label>\n                    <Select name=\"provider\" defaultValue=\"aws\">\n                      <SelectTrigger data-testid=\"select-cloud-provider\">\n                        <SelectValue placeholder=\"Select provider\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"aws\">Amazon Web Services (AWS)</SelectItem>\n                        <SelectItem value=\"azure\">Microsoft Azure</SelectItem>\n                        <SelectItem value=\"gcp\">Google Cloud Platform (GCP)</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n                <DialogFooter>\n                  <Button type=\"submit\" disabled={createCloudMutation.isPending} data-testid=\"button-create-cloud\">\n                    Connect\n                  </Button>\n                </DialogFooter>\n              </form>\n            </DialogContent>\n          </Dialog>\n        </div>\n      </div>\n\n      {/* Stats Cards */}\n      <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Assets</CardTitle>\n            <Server className=\"h-4 w-4 text-cyan-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"stat-total-assets\">\n              {statsLoading ? \"...\" : stats?.totalAssets || 0}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Vulnerabilities</CardTitle>\n            <AlertTriangle className=\"h-4 w-4 text-amber-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"stat-total-vulns\">\n              {statsLoading ? \"...\" : stats?.totalVulnerabilities || 0}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Critical</CardTitle>\n            <AlertTriangle className=\"h-4 w-4 text-red-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-red-400\" data-testid=\"stat-critical\">\n              {statsLoading ? \"...\" : stats?.criticalVulns || 0}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">High</CardTitle>\n            <AlertTriangle className=\"h-4 w-4 text-orange-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-orange-400\" data-testid=\"stat-high\">\n              {statsLoading ? \"...\" : stats?.highVulns || 0}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Pending</CardTitle>\n            <RefreshCw className=\"h-4 w-4 text-blue-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"stat-pending\">\n              {statsLoading ? \"...\" : stats?.pendingImports || 0}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Cloud</CardTitle>\n            <Cloud className=\"h-4 w-4 text-emerald-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"stat-cloud\">\n              {statsLoading ? \"...\" : stats?.cloudConnections || 0}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Search */}\n      <div className=\"flex items-center gap-2\">\n        <div className=\"relative flex-1 max-w-sm\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search assets, vulnerabilities...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"input-search\"\n          />\n        </div>\n      </div>\n\n      {/* Tabs */}\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList>\n          <TabsTrigger value=\"assets\" data-testid=\"tab-assets\">\n            <Server className=\"h-4 w-4 mr-2\" />\n            Assets ({assets.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"vulnerabilities\" data-testid=\"tab-vulnerabilities\">\n            <AlertTriangle className=\"h-4 w-4 mr-2\" />\n            Vulnerabilities ({vulnerabilities.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"imports\" data-testid=\"tab-imports\">\n            <Upload className=\"h-4 w-4 mr-2\" />\n            Imports ({importJobs.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"cloud\" data-testid=\"tab-cloud\">\n            <Cloud className=\"h-4 w-4 mr-2\" />\n            Cloud ({cloudConnections.length})\n          </TabsTrigger>\n        </TabsList>\n\n        {/* Assets Tab */}\n        <TabsContent value=\"assets\" className=\"mt-4\">\n          {assetsLoading ? (\n            <div className=\"text-center py-12 text-muted-foreground\">Loading assets...</div>\n          ) : filteredAssets.length === 0 ? (\n            <Card>\n              <CardContent className=\"py-12 text-center\">\n                <Server className=\"h-12 w-12 mx-auto mb-3 text-muted-foreground opacity-30\" />\n                <p className=\"text-muted-foreground\">No assets discovered yet</p>\n                <p className=\"text-sm text-muted-foreground mt-1\">Import a scanner file to discover assets</p>\n              </CardContent>\n            </Card>\n          ) : (\n            <Card>\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Asset</TableHead>\n                    <TableHead>Type</TableHead>\n                    <TableHead>IP / Hostname</TableHead>\n                    <TableHead>Environment</TableHead>\n                    <TableHead>Ports</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead className=\"w-[100px]\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredAssets.map((asset) => (\n                    <TableRow key={asset.id} data-testid={`row-asset-${asset.id}`}>\n                      <TableCell>\n                        <div className=\"flex items-center gap-2\">\n                          <div className=\"p-1.5 rounded bg-muted text-cyan-400\">\n                            {getAssetTypeIcon(asset.assetType)}\n                          </div>\n                          <div>\n                            <div className=\"font-medium\">{asset.displayName || asset.assetIdentifier}</div>\n                            {asset.displayName && (\n                              <div className=\"text-xs text-muted-foreground\">{asset.assetIdentifier}</div>\n                            )}\n                          </div>\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {asset.assetType.replace(\"_\", \" \")}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"text-sm\">\n                          {asset.ipAddresses?.[0] || asset.hostname || \"-\"}\n                        </div>\n                        {asset.fqdn && (\n                          <div className=\"text-xs text-muted-foreground\">{asset.fqdn}</div>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        {asset.environment ? (\n                          <Badge variant=\"outline\" className=\"text-xs\">{asset.environment}</Badge>\n                        ) : \"-\"}\n                      </TableCell>\n                      <TableCell>\n                        <span className=\"text-sm font-mono\">\n                          {asset.openPorts?.length || 0}\n                        </span>\n                      </TableCell>\n                      <TableCell>\n                        <Badge className={getStatusBadge(asset.status || \"active\")}>\n                          {asset.status || \"active\"}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        <DropdownMenu>\n                          <DropdownMenuTrigger asChild>\n                            <Button variant=\"ghost\" size=\"icon\" data-testid={`button-asset-actions-${asset.id}`}>\n                              <MoreVertical className=\"h-4 w-4\" />\n                            </Button>\n                          </DropdownMenuTrigger>\n                          <DropdownMenuContent align=\"end\">\n                            <DropdownMenuItem onClick={() => setSelectedAsset(asset)}>\n                              <Eye className=\"h-4 w-4 mr-2\" />\n                              View Details\n                            </DropdownMenuItem>\n                            <DropdownMenuItem>\n                              <Play className=\"h-4 w-4 mr-2\" />\n                              Run Evaluation\n                            </DropdownMenuItem>\n                          </DropdownMenuContent>\n                        </DropdownMenu>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </Card>\n          )}\n        </TabsContent>\n\n        {/* Vulnerabilities Tab */}\n        <TabsContent value=\"vulnerabilities\" className=\"mt-4\">\n          {vulnsLoading ? (\n            <div className=\"text-center py-12 text-muted-foreground\">Loading vulnerabilities...</div>\n          ) : filteredVulns.length === 0 ? (\n            <Card>\n              <CardContent className=\"py-12 text-center\">\n                <AlertTriangle className=\"h-12 w-12 mx-auto mb-3 text-muted-foreground opacity-30\" />\n                <p className=\"text-muted-foreground\">No vulnerabilities imported yet</p>\n                <p className=\"text-sm text-muted-foreground mt-1\">Import a scanner file to see vulnerabilities</p>\n              </CardContent>\n            </Card>\n          ) : (\n            <Card>\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Vulnerability</TableHead>\n                    <TableHead>CVE</TableHead>\n                    <TableHead>Severity</TableHead>\n                    <TableHead>Affected Host</TableHead>\n                    <TableHead>Port</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead className=\"w-[100px]\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredVulns.map((vuln) => (\n                    <TableRow key={vuln.id} data-testid={`row-vuln-${vuln.id}`}>\n                      <TableCell>\n                        <div className=\"font-medium max-w-[300px] truncate\" title={vuln.title}>\n                          {vuln.title}\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        {vuln.cveId ? (\n                          <Badge variant=\"outline\" className=\"font-mono text-xs\">\n                            {vuln.cveId}\n                          </Badge>\n                        ) : \"-\"}\n                      </TableCell>\n                      <TableCell>\n                        <Badge className={getSeverityBadge(vuln.severity)}>\n                          {vuln.severity.toUpperCase()}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        <span className=\"font-mono text-sm\">{vuln.affectedHost || \"-\"}</span>\n                      </TableCell>\n                      <TableCell>\n                        <span className=\"font-mono text-sm\">{vuln.affectedPort || \"-\"}</span>\n                      </TableCell>\n                      <TableCell>\n                        {vuln.aevEvaluationId ? (\n                          <Badge className=\"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\">\n                            Evaluated\n                          </Badge>\n                        ) : (\n                          <Badge className=\"bg-blue-500/10 text-blue-400 border-blue-500/30\">\n                            {vuln.status || \"open\"}\n                          </Badge>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        <DropdownMenu>\n                          <DropdownMenuTrigger asChild>\n                            <Button variant=\"ghost\" size=\"icon\" data-testid={`button-vuln-actions-${vuln.id}`}>\n                              <MoreVertical className=\"h-4 w-4\" />\n                            </Button>\n                          </DropdownMenuTrigger>\n                          <DropdownMenuContent align=\"end\">\n                            <DropdownMenuItem>\n                              <Eye className=\"h-4 w-4 mr-2\" />\n                              View Details\n                            </DropdownMenuItem>\n                            {!vuln.aevEvaluationId && (\n                              <DropdownMenuItem\n                                onClick={() => evaluateMutation.mutate(vuln.id)}\n                                disabled={evaluateMutation.isPending}\n                              >\n                                <Play className=\"h-4 w-4 mr-2\" />\n                                Run AEV Analysis\n                              </DropdownMenuItem>\n                            )}\n                          </DropdownMenuContent>\n                        </DropdownMenu>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </Card>\n          )}\n        </TabsContent>\n\n        {/* Imports Tab */}\n        <TabsContent value=\"imports\" className=\"mt-4\">\n          {jobsLoading ? (\n            <div className=\"text-center py-12 text-muted-foreground\">Loading imports...</div>\n          ) : importJobs.length === 0 ? (\n            <Card>\n              <CardContent className=\"py-12 text-center\">\n                <Upload className=\"h-12 w-12 mx-auto mb-3 text-muted-foreground opacity-30\" />\n                <p className=\"text-muted-foreground\">No import jobs yet</p>\n                <Button\n                  variant=\"outline\"\n                  className=\"mt-4\"\n                  onClick={() => setImportDialogOpen(true)}\n                  data-testid=\"button-first-import\"\n                >\n                  <Upload className=\"h-4 w-4 mr-2\" />\n                  Import Scanner Data\n                </Button>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid gap-4\">\n              {importJobs.map((job) => (\n                <Card key={job.id} data-testid={`card-import-${job.id}`}>\n                  <CardHeader className=\"flex flex-row items-center justify-between gap-4 pb-2\">\n                    <div>\n                      <CardTitle className=\"text-base\">{job.name}</CardTitle>\n                      <CardDescription className=\"flex items-center gap-2 mt-1\">\n                        <Badge variant=\"outline\" className=\"text-xs\">{job.sourceType}</Badge>\n                        <span>\n                          {new Date(job.createdAt).toLocaleString()}\n                        </span>\n                      </CardDescription>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Badge className={getStatusBadge(job.status)}>\n                        {job.status}\n                      </Badge>\n                      <DropdownMenu>\n                        <DropdownMenuTrigger asChild>\n                          <Button variant=\"ghost\" size=\"icon\">\n                            <MoreVertical className=\"h-4 w-4\" />\n                          </Button>\n                        </DropdownMenuTrigger>\n                        <DropdownMenuContent align=\"end\">\n                          <DropdownMenuItem\n                            className=\"text-destructive\"\n                            onClick={() => deleteImportMutation.mutate(job.id)}\n                          >\n                            <Trash2 className=\"h-4 w-4 mr-2\" />\n                            Delete\n                          </DropdownMenuItem>\n                        </DropdownMenuContent>\n                      </DropdownMenu>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"flex items-center gap-6 text-sm\">\n                      <div>\n                        <span className=\"text-muted-foreground\">Records:</span>\n                        <span className=\"ml-2 font-mono\">{job.totalRecords || 0}</span>\n                      </div>\n                      <div>\n                        <span className=\"text-muted-foreground\">Assets:</span>\n                        <span className=\"ml-2 font-mono text-cyan-400\">{job.assetsDiscovered || 0}</span>\n                      </div>\n                      <div>\n                        <span className=\"text-muted-foreground\">Vulnerabilities:</span>\n                        <span className=\"ml-2 font-mono text-amber-400\">{job.vulnerabilitiesFound || 0}</span>\n                      </div>\n                    </div>\n                    {job.status === \"processing\" && (\n                      <Progress value={job.progress} className=\"mt-3 h-1\" />\n                    )}\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </TabsContent>\n\n        {/* Cloud Tab */}\n        <TabsContent value=\"cloud\" className=\"mt-4\">\n          {cloudLoading ? (\n            <div className=\"text-center py-12 text-muted-foreground\">Loading cloud connections...</div>\n          ) : cloudConnections.length === 0 ? (\n            <Card>\n              <CardContent className=\"py-12 text-center\">\n                <Cloud className=\"h-12 w-12 mx-auto mb-3 text-muted-foreground opacity-30\" />\n                <p className=\"text-muted-foreground\">No cloud connections yet</p>\n                <p className=\"text-sm text-muted-foreground mt-1\">Connect AWS, Azure, or GCP for automatic asset discovery</p>\n                <Button\n                  variant=\"outline\"\n                  className=\"mt-4\"\n                  onClick={() => setCloudDialogOpen(true)}\n                  data-testid=\"button-first-cloud\"\n                >\n                  <Cloud className=\"h-4 w-4 mr-2\" />\n                  Connect Cloud Account\n                </Button>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-4\">\n              {cloudConnections.map((conn) => (\n                <Card key={conn.id} data-testid={`card-cloud-${conn.id}`}>\n                  <CardHeader className=\"flex flex-row items-center justify-between gap-4 pb-2\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"p-2 rounded-lg bg-muted\">\n                        <Cloud className=\"h-5 w-5 text-cyan-400\" />\n                      </div>\n                      <div>\n                        <CardTitle className=\"text-base\">{conn.name}</CardTitle>\n                        <CardDescription>{conn.provider.toUpperCase()}</CardDescription>\n                      </div>\n                    </div>\n                    <Badge className={getStatusBadge(conn.status)}>\n                      {conn.status}\n                    </Badge>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-3\">\n                      <div className=\"flex items-center justify-between text-sm\">\n                        <span className=\"text-muted-foreground\">Assets Discovered</span>\n                        <span className=\"font-mono\">{conn.assetsDiscovered || 0}</span>\n                      </div>\n                      {conn.lastSyncAt && (\n                        <div className=\"flex items-center justify-between text-sm\">\n                          <span className=\"text-muted-foreground\">Last Sync</span>\n                          <span>{new Date(conn.lastSyncAt).toLocaleString()}</span>\n                        </div>\n                      )}\n                      <div className=\"flex items-center gap-2 pt-2\">\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          className=\"flex-1\"\n                          onClick={() => testCloudMutation.mutate(conn.id)}\n                          disabled={testCloudMutation.isPending}\n                          data-testid={`button-test-cloud-${conn.id}`}\n                        >\n                          <RefreshCw className=\"h-3 w-3 mr-1\" />\n                          Sync\n                        </Button>\n                        <Button\n                          size=\"sm\"\n                          variant=\"ghost\"\n                          onClick={() => deleteCloudMutation.mutate(conn.id)}\n                          data-testid={`button-delete-cloud-${conn.id}`}\n                        >\n                          <Trash2 className=\"h-3 w-3\" />\n                        </Button>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </TabsContent>\n      </Tabs>\n\n      {/* Asset Detail Dialog */}\n      <Dialog open={!!selectedAsset} onOpenChange={() => setSelectedAsset(null)}>\n        <DialogContent className=\"max-w-2xl\">\n          {selectedAsset && (\n            <>\n              <DialogHeader>\n                <DialogTitle className=\"flex items-center gap-2\">\n                  {getAssetTypeIcon(selectedAsset.assetType)}\n                  {selectedAsset.displayName || selectedAsset.assetIdentifier}\n                </DialogTitle>\n                <DialogDescription>\n                  {selectedAsset.assetType.replace(\"_\", \" \")} - {selectedAsset.status}\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-4 py-4\">\n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                  <div>\n                    <span className=\"text-muted-foreground\">Identifier</span>\n                    <p className=\"font-mono\">{selectedAsset.assetIdentifier}</p>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">Hostname</span>\n                    <p className=\"font-mono\">{selectedAsset.hostname || \"-\"}</p>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">IP Addresses</span>\n                    <p className=\"font-mono\">{selectedAsset.ipAddresses?.join(\", \") || \"-\"}</p>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">FQDN</span>\n                    <p className=\"font-mono\">{selectedAsset.fqdn || \"-\"}</p>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">Operating System</span>\n                    <p>{selectedAsset.operatingSystem || \"-\"}</p>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">Cloud Provider</span>\n                    <p>{selectedAsset.cloudProvider?.toUpperCase() || \"-\"}</p>\n                  </div>\n                </div>\n                {selectedAsset.openPorts && selectedAsset.openPorts.length > 0 && (\n                  <div>\n                    <span className=\"text-muted-foreground text-sm\">Open Ports</span>\n                    <div className=\"flex flex-wrap gap-2 mt-2\">\n                      {selectedAsset.openPorts.map((port, i) => (\n                        <Badge key={i} variant=\"outline\" className=\"font-mono\">\n                          {port.port}/{port.protocol}\n                          {port.service && ` (${port.service})`}\n                        </Badge>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </div>\n            </>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":38841,"size_tokens":null},"client/src/pages/Reports.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from \"@/components/ui/dropdown-menu\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { \n  FileText, \n  Download, \n  Trash2, \n  Calendar, \n  FileSpreadsheet, \n  FileJson, \n  BarChart3, \n  Shield, \n  Briefcase,\n  Loader2,\n  Plus,\n  AlertTriangle,\n  CheckCircle2,\n  Clock,\n  FileType,\n  Lock,\n  Sparkles,\n  FileCode,\n} from \"lucide-react\";\nimport pdfMake from \"pdfmake/build/pdfmake\";\nimport pdfFonts from \"pdfmake/build/vfs_fonts\";\n\npdfMake.vfs = pdfFonts.vfs;\nimport { format } from \"date-fns\";\nimport type { Report } from \"@shared/schema\";\n\nconst reportTypes = [\n  { value: \"executive_summary\", label: \"Executive Summary\", icon: Briefcase, description: \"High-level overview for leadership\" },\n  { value: \"technical_deep_dive\", label: \"Technical Deep-Dive\", icon: FileText, description: \"Detailed findings for engineers\" },\n  { value: \"compliance_mapping\", label: \"Compliance Report\", icon: Shield, description: \"Framework-specific compliance status\" },\n];\n\nconst complianceFrameworks = [\n  { value: \"soc2\", label: \"SOC 2\" },\n  { value: \"pci_dss\", label: \"PCI DSS\" },\n  { value: \"hipaa\", label: \"HIPAA\" },\n  { value: \"gdpr\", label: \"GDPR\" },\n  { value: \"ccpa\", label: \"CCPA\" },\n  { value: \"iso27001\", label: \"ISO 27001\" },\n  { value: \"nist_csf\", label: \"NIST CSF\" },\n  { value: \"fedramp\", label: \"FedRAMP\" },\n];\n\nconst exportFormats = [\n  { value: \"pdf\", label: \"PDF\", icon: FileType },\n  { value: \"json\", label: \"JSON\", icon: FileJson },\n  { value: \"csv\", label: \"CSV\", icon: FileSpreadsheet },\n];\n\nexport default function Reports() {\n  const { toast } = useToast();\n  const { hasPermission, needsSanitizedView } = useAuth();\n  \n  const canGenerateReport = hasPermission(\"reports:generate\");\n  const canDeleteReport = hasPermission(\"reports:delete\");\n  const canExportReport = hasPermission(\"reports:export\");\n  const isExecutiveView = needsSanitizedView();\n  \n  const [isGenerateOpen, setIsGenerateOpen] = useState(false);\n  const [selectedType, setSelectedType] = useState<string>(\"executive_summary\");\n  const [selectedFormat, setSelectedFormat] = useState<string>(\"pdf\");\n  const [selectedFramework, setSelectedFramework] = useState<string>(\"soc2\");\n  const [reportVersion, setReportVersion] = useState<\"v1_template\" | \"v2_narrative\">(\"v1_template\");\n  const [dateFrom, setDateFrom] = useState<string>(\n    format(new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), \"yyyy-MM-dd\")\n  );\n  const [dateTo, setDateTo] = useState<string>(format(new Date(), \"yyyy-MM-dd\"));\n  const [previewData, setPreviewData] = useState<any>(null);\n  const [isV2Generating, setIsV2Generating] = useState(false);\n\n  const { data: reports = [], isLoading } = useQuery<Report[]>({\n    queryKey: [\"/api/reports\"],\n  });\n\n  const { data: v2FeatureStatus } = useQuery<{ enabled: boolean }>({\n    queryKey: [\"/api/reports/v2/feature-status\"],\n  });\n\n  const isV2Enabled = v2FeatureStatus?.enabled ?? false;\n\n  const generateMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const response = await apiRequest(\"POST\", \"/api/reports/generate\", data);\n      return response.json();\n    },\n    onSuccess: (data) => {\n      setPreviewData(data);\n      queryClient.invalidateQueries({ queryKey: [\"/api/reports\"] });\n      toast({\n        title: \"Report generated\",\n        description: `Successfully generated: ${data.title}`,\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Generation failed\",\n        description: String(error),\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const generateV2Mutation = useMutation({\n    mutationFn: async (data: any) => {\n      const response = await apiRequest(\"POST\", \"/api/reports/v2/generate\", data);\n      return response.json();\n    },\n    onSuccess: (data) => {\n      setPreviewData(data.report);\n      queryClient.invalidateQueries({ queryKey: [\"/api/reports\"] });\n      setIsGenerateOpen(false);\n      if (data.fallbackReason) {\n        toast({\n          title: \"Report generated (V1 fallback)\",\n          description: data.fallbackReason,\n          variant: \"default\",\n        });\n      } else {\n        toast({\n          title: \"AI Narrative Report generated\",\n          description: `Successfully generated ${data.sectionsGenerated?.join(\", \")} sections`,\n        });\n      }\n    },\n    onError: (error) => {\n      toast({\n        title: \"V2 Report generation failed\",\n        description: String(error),\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/reports/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/reports\"] });\n      toast({\n        title: \"Report deleted\",\n        description: \"Report has been removed\",\n      });\n    },\n  });\n\n  const handleGenerate = () => {\n    if (reportVersion === \"v2_narrative\") {\n      if (!isV2Enabled) {\n        toast({\n          title: \"Feature not available\",\n          description: \"AI Narrative reports are not enabled for your organization\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      const reportTypesMap: Record<string, string[]> = {\n        \"executive_summary\": [\"executive\"],\n        \"technical_deep_dive\": [\"technical\", \"evidence\"],\n        \"compliance_mapping\": [\"compliance\"],\n      };\n      generateV2Mutation.mutate({\n        dateRange: { from: dateFrom, to: dateTo },\n        reportTypes: reportTypesMap[selectedType] || [\"executive\"],\n        reportVersion: \"v2_narrative\",\n        customerContext: {\n          riskTolerance: \"medium\",\n        },\n      });\n    } else {\n      generateMutation.mutate({\n        type: selectedType,\n        format: selectedFormat,\n        from: dateFrom,\n        to: dateTo,\n        framework: selectedType === \"compliance_mapping\" ? selectedFramework : undefined,\n      });\n    }\n  };\n\n  const handleDownload = (report: Report, downloadFormat: \"pdf\" | \"json\" | \"csv\" = \"pdf\") => {\n    const filename = report.title.replace(/\\s+/g, \"_\");\n    \n    if (downloadFormat === \"pdf\") {\n      generatePdf(report);\n    } else if (downloadFormat === \"json\") {\n      const content = JSON.stringify(report.content, null, 2);\n      const blob = new Blob([content], { type: \"application/json\" });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = `${filename}.json`;\n      a.click();\n      URL.revokeObjectURL(url);\n    } else if (downloadFormat === \"csv\") {\n      const csvContent = convertToCSV(report.content);\n      const blob = new Blob([csvContent], { type: \"text/csv\" });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = `${filename}.csv`;\n      a.click();\n      URL.revokeObjectURL(url);\n    }\n  };\n\n  const convertToCSV = (data: any): string => {\n    if (!data) return \"\";\n    const sections: string[] = [];\n    \n    const escapeCSV = (value: any): string => {\n      const str = String(value ?? \"\");\n      if (str.includes(\",\") || str.includes(\"\\n\") || str.includes('\"')) {\n        return `\"${str.replace(/\"/g, '\"\"')}\"`;\n      }\n      return str;\n    };\n\n    // Executive Summary section\n    if (data.executiveSummary) {\n      sections.push(\"EXECUTIVE SUMMARY\");\n      sections.push(escapeCSV(data.executiveSummary));\n      sections.push(\"\");\n    }\n\n    // Key Metrics section\n    if (data.keyMetrics) {\n      sections.push(\"KEY METRICS\");\n      sections.push(\"Metric,Value\");\n      for (const [key, value] of Object.entries(data.keyMetrics)) {\n        const label = key.replace(/([A-Z])/g, \" $1\").replace(/^./, s => s.toUpperCase());\n        sections.push(`${escapeCSV(label)},${escapeCSV(value)}`);\n      }\n      sections.push(\"\");\n    }\n\n    // Findings section\n    if (data.findings && Array.isArray(data.findings)) {\n      sections.push(\"SECURITY FINDINGS\");\n      sections.push(\"Severity,Title,Description,Recommendation,Score\");\n      for (const f of data.findings.slice(0, 50)) {\n        sections.push([\n          escapeCSV(f.severity?.toUpperCase() || \"N/A\"),\n          escapeCSV(f.title || \"Untitled\"),\n          escapeCSV(f.description || \"\"),\n          escapeCSV(f.recommendation || \"\"),\n          escapeCSV(f.score || f.riskScore || \"N/A\"),\n        ].join(\",\"));\n      }\n      sections.push(\"\");\n    }\n\n    // Recommendations section\n    if (data.recommendations && Array.isArray(data.recommendations)) {\n      sections.push(\"RECOMMENDATIONS\");\n      sections.push(\"Priority,Action,Impact,Effort\");\n      for (const rec of data.recommendations.slice(0, 20)) {\n        if (typeof rec === \"string\") {\n          sections.push(`1,${escapeCSV(rec)},,`);\n        } else if (rec.action) {\n          sections.push([\n            escapeCSV(rec.priority || \"\"),\n            escapeCSV(rec.action),\n            escapeCSV(rec.impact || \"\"),\n            escapeCSV(rec.effort || \"\"),\n          ].join(\",\"));\n        } else {\n          sections.push(`1,${escapeCSV(rec.description || rec.title || rec.text || \"\")},,`);\n        }\n      }\n      sections.push(\"\");\n    }\n\n    // Attack Paths section (for technical reports)\n    if (data.attackPaths && Array.isArray(data.attackPaths)) {\n      sections.push(\"ATTACK PATHS\");\n      sections.push(\"Asset,Complexity,Time to Compromise,Steps\");\n      for (const path of data.attackPaths.slice(0, 20)) {\n        const stepsText = path.steps?.map((s: any) => s.technique || s.description || s.action).join(\" -> \") || \"\";\n        sections.push([\n          escapeCSV(path.assetId || \"\"),\n          escapeCSV(path.complexity || \"\"),\n          escapeCSV(path.timeToCompromise || \"\"),\n          escapeCSV(stepsText),\n        ].join(\",\"));\n      }\n      sections.push(\"\");\n    }\n\n    // Compliance Status section\n    if (data.complianceStatus) {\n      sections.push(\"COMPLIANCE STATUS\");\n      sections.push(\"Control,Status,Coverage\");\n      for (const [control, status] of Object.entries(data.complianceStatus)) {\n        const statusObj = status as any;\n        sections.push([\n          escapeCSV(control),\n          escapeCSV(typeof statusObj === \"object\" ? statusObj.status : String(statusObj)),\n          escapeCSV(typeof statusObj === \"object\" && statusObj.coverage ? `${statusObj.coverage}%` : \"N/A\"),\n        ].join(\",\"));\n      }\n      sections.push(\"\");\n    }\n\n    // Gaps section (for compliance reports)\n    if (data.gaps && Array.isArray(data.gaps)) {\n      sections.push(\"COMPLIANCE GAPS\");\n      sections.push(\"Control ID,Gap Description,Severity,Remediation Guidance\");\n      for (const gap of data.gaps) {\n        sections.push([\n          escapeCSV(gap.controlId || \"\"),\n          escapeCSV(gap.gapDescription || \"\"),\n          escapeCSV(gap.severity || \"\"),\n          escapeCSV(gap.remediationGuidance || \"\"),\n        ].join(\",\"));\n      }\n      sections.push(\"\");\n    }\n\n    // Top Risks section (for executive reports)\n    if (data.topRisks && Array.isArray(data.topRisks)) {\n      sections.push(\"TOP RISKS\");\n      sections.push(\"Asset,Severity,Risk Description,Financial Impact\");\n      for (const risk of data.topRisks) {\n        sections.push([\n          escapeCSV(risk.assetId || \"\"),\n          escapeCSV(risk.severity || \"\"),\n          escapeCSV(risk.riskDescription || \"\"),\n          escapeCSV(risk.financialImpact || \"\"),\n        ].join(\",\"));\n      }\n      sections.push(\"\");\n    }\n\n    return sections.join(\"\\n\");\n  };\n\n  const generatePdf = (report: Report) => {\n    const content = report.content as any;\n    const reportTypeLabel = reportTypes.find(t => t.value === report.reportType)?.label || report.reportType;\n    \n    const docDefinition: any = {\n      pageSize: \"A4\",\n      pageMargins: [40, 60, 40, 60],\n      info: {\n        title: report.title,\n        author: \"OdinForge AI\",\n        subject: `${reportTypeLabel} - Security Assessment`,\n      },\n      header: {\n        columns: [\n          { text: \"OdinForge AI\", style: \"headerText\", margin: [40, 20, 0, 0] },\n          { text: reportTypeLabel, style: \"headerText\", alignment: \"right\", margin: [0, 20, 40, 0] },\n        ],\n      },\n      footer: (currentPage: number, pageCount: number) => ({\n        columns: [\n          { text: `Generated: ${format(new Date(report.createdAt || new Date()), \"MMM d, yyyy HH:mm\")}`, style: \"footerText\", margin: [40, 0, 0, 0] },\n          { text: `Page ${currentPage} of ${pageCount}`, style: \"footerText\", alignment: \"right\", margin: [0, 0, 40, 0] },\n        ],\n      }),\n      content: [\n        { text: report.title, style: \"title\" },\n        { text: `Date Range: ${format(new Date(report.dateRangeFrom), \"MMM d, yyyy\")} - ${format(new Date(report.dateRangeTo), \"MMM d, yyyy\")}`, style: \"subtitle\" },\n        report.framework && { text: `Compliance Framework: ${report.framework.toUpperCase()}`, style: \"subtitle\" },\n        { text: \"\", margin: [0, 10, 0, 10] },\n        ...buildPdfContent(content, report.reportType),\n      ].filter(Boolean),\n      styles: {\n        title: { fontSize: 22, bold: true, margin: [0, 0, 0, 10], color: \"#1a365d\" },\n        subtitle: { fontSize: 11, color: \"#64748b\", margin: [0, 0, 0, 5] },\n        sectionHeader: { fontSize: 14, bold: true, margin: [0, 15, 0, 8], color: \"#0f172a\" },\n        subHeader: { fontSize: 12, bold: true, margin: [0, 10, 0, 5], color: \"#334155\" },\n        bodyText: { fontSize: 10, margin: [0, 0, 0, 5], lineHeight: 1.4 },\n        tableHeader: { fontSize: 10, bold: true, fillColor: \"#f1f5f9\", color: \"#0f172a\" },\n        tableCell: { fontSize: 9 },\n        criticalBadge: { fontSize: 9, bold: true, color: \"#dc2626\" },\n        highBadge: { fontSize: 9, bold: true, color: \"#ea580c\" },\n        mediumBadge: { fontSize: 9, bold: true, color: \"#ca8a04\" },\n        lowBadge: { fontSize: 9, bold: true, color: \"#16a34a\" },\n        headerText: { fontSize: 9, color: \"#64748b\" },\n        footerText: { fontSize: 8, color: \"#94a3b8\" },\n        listItem: { fontSize: 10, margin: [0, 2, 0, 2] },\n      },\n      defaultStyle: { font: \"Roboto\" },\n    };\n\n    pdfMake.createPdf(docDefinition).download(`${report.title.replace(/\\s+/g, \"_\")}.pdf`);\n    toast({\n      title: \"PDF Downloaded\",\n      description: `${report.title}.pdf has been downloaded`,\n    });\n  };\n\n  const buildPdfContent = (data: any, reportType: string): any[] => {\n    const content: any[] = [];\n    \n    if (!data) {\n      content.push({ text: \"No data available for this report.\", style: \"bodyText\" });\n      return content;\n    }\n\n    if (data.executiveSummary || reportType === \"executive_summary\") {\n      content.push({ text: \"Executive Summary\", style: \"sectionHeader\" });\n      if (data.executiveSummary) {\n        content.push({ text: data.executiveSummary, style: \"bodyText\" });\n      }\n      \n      if (data.keyMetrics) {\n        content.push({ text: \"Key Metrics\", style: \"subHeader\" });\n        const metricsTable = {\n          table: {\n            headerRows: 1,\n            widths: [\"*\", \"*\"],\n            body: [\n              [{ text: \"Metric\", style: \"tableHeader\" }, { text: \"Value\", style: \"tableHeader\" }],\n              ...Object.entries(data.keyMetrics).map(([key, value]) => [\n                { text: key.replace(/([A-Z])/g, \" $1\").replace(/^./, s => s.toUpperCase()), style: \"tableCell\" },\n                { text: String(value), style: \"tableCell\" },\n              ]),\n            ],\n          },\n          layout: \"lightHorizontalLines\",\n          margin: [0, 5, 0, 10],\n        };\n        content.push(metricsTable);\n      }\n    }\n\n    if (data.findings && Array.isArray(data.findings)) {\n      content.push({ text: \"Security Findings\", style: \"sectionHeader\" });\n      const findingsTable = {\n        table: {\n          headerRows: 1,\n          widths: [\"auto\", \"*\", \"auto\", \"auto\"],\n          body: [\n            [\n              { text: \"Severity\", style: \"tableHeader\" },\n              { text: \"Finding\", style: \"tableHeader\" },\n              { text: \"Status\", style: \"tableHeader\" },\n              { text: \"Risk Score\", style: \"tableHeader\" },\n            ],\n            ...data.findings.slice(0, 20).map((finding: any) => [\n              { text: finding.severity?.toUpperCase() || \"N/A\", style: getSeverityStyle(finding.severity) },\n              { text: finding.title || finding.description || \"N/A\", style: \"tableCell\" },\n              { text: finding.status || \"Open\", style: \"tableCell\" },\n              { text: String(finding.riskScore || finding.score || \"N/A\"), style: \"tableCell\" },\n            ]),\n          ],\n        },\n        layout: \"lightHorizontalLines\",\n        margin: [0, 5, 0, 10],\n      };\n      content.push(findingsTable);\n    }\n\n    if (data.recommendations && Array.isArray(data.recommendations)) {\n      content.push({ text: \"Recommendations\", style: \"sectionHeader\" });\n      const recList = {\n        ul: data.recommendations.slice(0, 10).map((rec: any) => {\n          if (typeof rec === \"string\") return rec;\n          if (rec.action) {\n            const priority = rec.priority ? `Priority ${rec.priority}: ` : \"\";\n            const impact = rec.impact ? ` (${rec.impact})` : \"\";\n            return `${priority}${rec.action}${impact}`;\n          }\n          return rec.description || rec.title || rec.text || \"Recommendation pending\";\n        }),\n        style: \"listItem\",\n        margin: [0, 5, 0, 10],\n      };\n      content.push(recList);\n    }\n\n    if (data.complianceStatus) {\n      content.push({ text: \"Compliance Status\", style: \"sectionHeader\" });\n      const complianceTable = {\n        table: {\n          headerRows: 1,\n          widths: [\"*\", \"auto\", \"auto\"],\n          body: [\n            [\n              { text: \"Control\", style: \"tableHeader\" },\n              { text: \"Status\", style: \"tableHeader\" },\n              { text: \"Coverage\", style: \"tableHeader\" },\n            ],\n            ...Object.entries(data.complianceStatus).slice(0, 15).map(([control, status]: [string, any]) => [\n              { text: control, style: \"tableCell\" },\n              { text: typeof status === \"object\" ? status.status : String(status), style: \"tableCell\" },\n              { text: typeof status === \"object\" && status.coverage ? `${status.coverage}%` : \"N/A\", style: \"tableCell\" },\n            ]),\n          ],\n        },\n        layout: \"lightHorizontalLines\",\n        margin: [0, 5, 0, 10],\n      };\n      content.push(complianceTable);\n    }\n\n    if (data.riskBreakdown) {\n      content.push({ text: \"Risk Breakdown\", style: \"sectionHeader\" });\n      const riskTable = {\n        table: {\n          headerRows: 1,\n          widths: [\"*\", \"auto\"],\n          body: [\n            [{ text: \"Category\", style: \"tableHeader\" }, { text: \"Count\", style: \"tableHeader\" }],\n            ...Object.entries(data.riskBreakdown).map(([category, count]) => [\n              { text: category.charAt(0).toUpperCase() + category.slice(1), style: \"tableCell\" },\n              { text: String(count), style: \"tableCell\" },\n            ]),\n          ],\n        },\n        layout: \"lightHorizontalLines\",\n        margin: [0, 5, 0, 10],\n      };\n      content.push(riskTable);\n    }\n\n    // Top Risks section (for executive reports)\n    if (data.topRisks && Array.isArray(data.topRisks) && data.topRisks.length > 0) {\n      content.push({ text: \"Top Business Risks\", style: \"sectionHeader\" });\n      const risksTable = {\n        table: {\n          headerRows: 1,\n          widths: [\"auto\", \"*\", \"auto\", \"auto\"],\n          body: [\n            [\n              { text: \"Severity\", style: \"tableHeader\" },\n              { text: \"Risk Description\", style: \"tableHeader\" },\n              { text: \"Asset\", style: \"tableHeader\" },\n              { text: \"Financial Impact\", style: \"tableHeader\" },\n            ],\n            ...data.topRisks.slice(0, 10).map((risk: any) => [\n              { text: risk.severity?.toUpperCase() || \"N/A\", style: getSeverityStyle(risk.severity) },\n              { text: risk.riskDescription || \"Risk requiring attention\", style: \"tableCell\" },\n              { text: risk.assetId || \"N/A\", style: \"tableCell\" },\n              { text: risk.financialImpact || \"TBD\", style: \"tableCell\" },\n            ]),\n          ],\n        },\n        layout: \"lightHorizontalLines\",\n        margin: [0, 5, 0, 10],\n      };\n      content.push(risksTable);\n    }\n\n    // Attack Paths section (for technical reports)\n    if (data.attackPaths && Array.isArray(data.attackPaths) && data.attackPaths.length > 0) {\n      content.push({ text: \"Attack Path Analysis\", style: \"sectionHeader\" });\n      content.push({ \n        text: \"The following attack paths were identified and validated during the security assessment:\", \n        style: \"bodyText\" \n      });\n      \n      for (const [idx, path] of data.attackPaths.slice(0, 5).entries()) {\n        content.push({ text: `Attack Path ${idx + 1}: ${path.assetId || \"Target Asset\"}`, style: \"subHeader\" });\n        \n        const pathInfo = [];\n        if (path.complexity) pathInfo.push(`Complexity: ${path.complexity}/100`);\n        if (path.timeToCompromise) pathInfo.push(`Estimated Time to Compromise: ${path.timeToCompromise}`);\n        if (pathInfo.length > 0) {\n          content.push({ text: pathInfo.join(\" | \"), style: \"bodyText\", color: \"#64748b\" });\n        }\n        \n        if (path.steps && Array.isArray(path.steps)) {\n          const stepsText = path.steps.map((step: any, i: number) => {\n            const technique = step.technique || step.action || step.description || \"Action\";\n            const desc = step.description || step.details || \"\";\n            return `${i + 1}. ${technique}${desc ? `: ${desc}` : \"\"}`;\n          }).join(\"\\n\");\n          content.push({ text: stepsText, style: \"listItem\", margin: [10, 5, 0, 10] });\n        }\n      }\n    }\n\n    // Vulnerability Breakdown section (for technical reports)\n    if (data.vulnerabilityBreakdown) {\n      content.push({ text: \"Vulnerability Distribution\", style: \"sectionHeader\" });\n      \n      if (data.vulnerabilityBreakdown.bySeverity) {\n        content.push({ text: \"By Severity:\", style: \"subHeader\" });\n        const severityItems = Object.entries(data.vulnerabilityBreakdown.bySeverity)\n          .map(([sev, count]) => `${sev.charAt(0).toUpperCase() + sev.slice(1)}: ${count}`)\n          .join(\", \");\n        content.push({ text: severityItems, style: \"bodyText\" });\n      }\n      \n      if (data.vulnerabilityBreakdown.byType) {\n        content.push({ text: \"By Type:\", style: \"subHeader\" });\n        const typeItems = Object.entries(data.vulnerabilityBreakdown.byType)\n          .map(([type, count]) => `${type.replace(/_/g, \" \")}: ${count}`)\n          .join(\", \");\n        content.push({ text: typeItems, style: \"bodyText\" });\n      }\n    }\n\n    // Compliance Gaps section\n    if (data.gaps && Array.isArray(data.gaps) && data.gaps.length > 0) {\n      content.push({ text: \"Compliance Gaps\", style: \"sectionHeader\" });\n      const gapsTable = {\n        table: {\n          headerRows: 1,\n          widths: [\"auto\", \"*\", \"auto\"],\n          body: [\n            [\n              { text: \"Control ID\", style: \"tableHeader\" },\n              { text: \"Gap Description\", style: \"tableHeader\" },\n              { text: \"Severity\", style: \"tableHeader\" },\n            ],\n            ...data.gaps.slice(0, 15).map((gap: any) => [\n              { text: gap.controlId || \"N/A\", style: \"tableCell\" },\n              { text: gap.gapDescription || \"Gap requiring remediation\", style: \"tableCell\" },\n              { text: gap.severity?.toUpperCase() || \"MEDIUM\", style: getSeverityStyle(gap.severity) },\n            ]),\n          ],\n        },\n        layout: \"lightHorizontalLines\",\n        margin: [0, 5, 0, 10],\n      };\n      content.push(gapsTable);\n      \n      // Add remediation guidance\n      content.push({ text: \"Remediation Guidance\", style: \"subHeader\" });\n      const remediationList = {\n        ul: data.gaps.slice(0, 10).map((gap: any) => \n          `${gap.controlId}: ${gap.remediationGuidance || \"Review and implement required controls\"}`\n        ),\n        style: \"listItem\",\n        margin: [0, 5, 0, 10],\n      };\n      content.push(remediationList);\n    }\n\n    // Audit Readiness section (for compliance reports)\n    if (data.auditReadiness) {\n      content.push({ text: \"Audit Readiness Assessment\", style: \"sectionHeader\" });\n      \n      const readinessInfo = [\n        { label: \"Overall Readiness Score\", value: `${data.auditReadiness.score || 0}%` },\n        { label: \"Compliant Controls\", value: `${data.auditReadiness.readyControls || 0} of ${data.auditReadiness.totalControls || 0}` },\n      ];\n      \n      const readinessTable = {\n        table: {\n          widths: [\"*\", \"auto\"],\n          body: readinessInfo.map(item => [\n            { text: item.label, style: \"tableCell\" },\n            { text: item.value, style: \"tableCell\", bold: true },\n          ]),\n        },\n        layout: \"noBorders\",\n        margin: [0, 5, 0, 10],\n      };\n      content.push(readinessTable);\n      \n      if (data.auditReadiness.priorityActions && Array.isArray(data.auditReadiness.priorityActions)) {\n        content.push({ text: \"Priority Actions for Audit Preparation:\", style: \"subHeader\" });\n        const actionsList = {\n          ol: data.auditReadiness.priorityActions.slice(0, 5),\n          style: \"listItem\",\n          margin: [0, 5, 0, 10],\n        };\n        content.push(actionsList);\n      }\n    }\n\n    if (content.length === 0) {\n      content.push({ text: \"Report Data\", style: \"sectionHeader\" });\n      content.push({ text: JSON.stringify(data, null, 2), style: \"bodyText\", preserveLeadingSpaces: true });\n    }\n\n    return content;\n  };\n\n  const getSeverityStyle = (severity: string): string => {\n    switch (severity?.toLowerCase()) {\n      case \"critical\": return \"criticalBadge\";\n      case \"high\": return \"highBadge\";\n      case \"medium\": return \"mediumBadge\";\n      case \"low\": return \"lowBadge\";\n      default: return \"tableCell\";\n    }\n  };\n\n  const getReportIcon = (type: string) => {\n    switch (type) {\n      case \"executive_summary\": return <Briefcase className=\"w-4 h-4\" />;\n      case \"technical_deep_dive\": return <FileText className=\"w-4 h-4\" />;\n      case \"compliance_mapping\": return <Shield className=\"w-4 h-4\" />;\n      default: return <FileText className=\"w-4 h-4\" />;\n    }\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"completed\":\n        return <Badge variant=\"default\" className=\"bg-green-500/20 text-green-400 border-green-500/30\"><CheckCircle2 className=\"w-3 h-3 mr-1\" />Completed</Badge>;\n      case \"generating\":\n        return <Badge variant=\"secondary\"><Clock className=\"w-3 h-3 mr-1\" />Generating</Badge>;\n      case \"failed\":\n        return <Badge variant=\"destructive\"><AlertTriangle className=\"w-3 h-3 mr-1\" />Failed</Badge>;\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      {isExecutiveView && (\n        <Alert>\n          <Briefcase className=\"h-4 w-4\" />\n          <AlertDescription>\n            You are viewing reports in executive mode. Only executive summary reports are available. \n            Technical details and raw findings are not shown.\n          </AlertDescription>\n        </Alert>\n      )}\n      \n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-reports-title\">Enterprise Reports</h1>\n          <p className=\"text-muted-foreground\">Generate executive, technical, and compliance reports</p>\n        </div>\n        <Dialog open={isGenerateOpen} onOpenChange={setIsGenerateOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"btn-generate-report\" disabled={!canGenerateReport}>\n              {canGenerateReport ? <Plus className=\"w-4 h-4 mr-2\" /> : <Lock className=\"w-4 h-4 mr-2\" />}\n              Generate Report\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>Generate New Report</DialogTitle>\n              <DialogDescription>Configure and generate a security assessment report</DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label>Report Type</Label>\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-3\">\n                  {reportTypes.map((type) => (\n                    <Card\n                      key={type.value}\n                      className={`cursor-pointer transition-colors hover-elevate ${\n                        selectedType === type.value ? \"border-primary bg-primary/5\" : \"\"\n                      }`}\n                      onClick={() => setSelectedType(type.value)}\n                      data-testid={`card-report-type-${type.value}`}\n                    >\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex flex-col items-center text-center gap-2\">\n                          <type.icon className=\"w-6 h-6 text-primary\" />\n                          <span className=\"font-medium text-sm\">{type.label}</span>\n                          <span className=\"text-xs text-muted-foreground\">{type.description}</span>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              </div>\n\n              {selectedType === \"compliance_mapping\" && (\n                <div className=\"space-y-2\">\n                  <Label>Compliance Framework</Label>\n                  <Select value={selectedFramework} onValueChange={setSelectedFramework}>\n                    <SelectTrigger data-testid=\"select-framework\">\n                      <SelectValue placeholder=\"Select framework\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {complianceFrameworks.map((fw) => (\n                        <SelectItem key={fw.value} value={fw.value}>{fw.label}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              )}\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Date From</Label>\n                  <Input\n                    type=\"date\"\n                    value={dateFrom}\n                    onChange={(e) => setDateFrom(e.target.value)}\n                    data-testid=\"input-date-from\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Date To</Label>\n                  <Input\n                    type=\"date\"\n                    value={dateTo}\n                    onChange={(e) => setDateTo(e.target.value)}\n                    data-testid=\"input-date-to\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Export Format</Label>\n                <div className=\"flex gap-2\">\n                  {exportFormats.map((fmt) => (\n                    <Button\n                      key={fmt.value}\n                      variant={selectedFormat === fmt.value ? \"default\" : \"outline\"}\n                      size=\"sm\"\n                      onClick={() => setSelectedFormat(fmt.value)}\n                      data-testid={`btn-format-${fmt.value}`}\n                    >\n                      <fmt.icon className=\"w-4 h-4 mr-2\" />\n                      {fmt.label}\n                    </Button>\n                  ))}\n                </div>\n              </div>\n\n              <Separator />\n\n              <div className=\"space-y-2\">\n                <Label>Report Generation Style</Label>\n                <p className=\"text-xs text-muted-foreground mb-2\">\n                  Choose between structured templates or AI-generated narrative reports\n                </p>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <Card\n                    className={`cursor-pointer transition-colors hover-elevate ${\n                      reportVersion === \"v1_template\" ? \"border-primary bg-primary/5\" : \"\"\n                    }`}\n                    onClick={() => setReportVersion(\"v1_template\")}\n                    data-testid=\"card-report-version-v1\"\n                  >\n                    <CardContent className=\"p-4\">\n                      <div className=\"flex flex-col items-center text-center gap-2\">\n                        <FileCode className=\"w-6 h-6 text-muted-foreground\" />\n                        <span className=\"font-medium text-sm\">Standard Template</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          Logic-based structured reports with kill chain and remediation mapping\n                        </span>\n                      </div>\n                    </CardContent>\n                  </Card>\n                  <Card\n                    className={`cursor-pointer transition-colors hover-elevate ${\n                      reportVersion === \"v2_narrative\" ? \"border-primary bg-primary/5\" : \"\"\n                    } ${!isV2Enabled ? \"opacity-50 pointer-events-none\" : \"\"}`}\n                    onClick={() => isV2Enabled && setReportVersion(\"v2_narrative\")}\n                    data-testid=\"card-report-version-v2\"\n                  >\n                    <CardContent className=\"p-4\">\n                      <div className=\"flex flex-col items-center text-center gap-2\">\n                        <Sparkles className={`w-6 h-6 ${isV2Enabled ? \"text-cyan-400\" : \"text-muted-foreground\"}`} />\n                        <span className=\"font-medium text-sm\">AI Narrative</span>\n                        <div className=\"flex gap-1\">\n                          <Badge variant=\"secondary\" className=\"text-xs\">Beta</Badge>\n                          {!isV2Enabled && <Badge variant=\"outline\" className=\"text-xs\">Disabled</Badge>}\n                        </div>\n                        <span className=\"text-xs text-muted-foreground\">\n                          {isV2Enabled \n                            ? \"Human-grade pentest reports with evidence-anchored narratives\"\n                            : \"Contact admin to enable AI narrative reports\"}\n                        </span>\n                      </div>\n                    </CardContent>\n                  </Card>\n                </div>\n              </div>\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setIsGenerateOpen(false)}>Cancel</Button>\n              <Button \n                onClick={handleGenerate} \n                disabled={generateMutation.isPending || generateV2Mutation.isPending}\n                data-testid=\"btn-confirm-generate\"\n              >\n                {(generateMutation.isPending || generateV2Mutation.isPending) && (\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                )}\n                {reportVersion === \"v2_narrative\" && <Sparkles className=\"w-4 h-4 mr-2\" />}\n                {reportVersion === \"v2_narrative\" ? \"Generate AI Report\" : \"Generate Report\"}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <Tabs defaultValue=\"reports\" className=\"space-y-4\">\n        <TabsList>\n          <TabsTrigger value=\"reports\" data-testid=\"tab-reports\">\n            <FileText className=\"w-4 h-4 mr-2\" />\n            Generated Reports\n          </TabsTrigger>\n          <TabsTrigger value=\"preview\" data-testid=\"tab-preview\" disabled={!previewData}>\n            <BarChart3 className=\"w-4 h-4 mr-2\" />\n            Latest Preview\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"reports\" className=\"space-y-4\">\n          {isLoading ? (\n            <Card>\n              <CardContent className=\"flex items-center justify-center py-8\">\n                <Loader2 className=\"w-6 h-6 animate-spin text-muted-foreground\" />\n              </CardContent>\n            </Card>\n          ) : reports.length === 0 ? (\n            <Card>\n              <CardContent className=\"flex flex-col items-center justify-center py-12 text-center\">\n                <FileText className=\"w-12 h-12 text-muted-foreground mb-4\" />\n                <h3 className=\"font-medium mb-2\">No reports generated yet</h3>\n                <p className=\"text-muted-foreground text-sm mb-4\">\n                  Generate your first report to see it here\n                </p>\n                <Button onClick={() => setIsGenerateOpen(true)} data-testid=\"btn-generate-first\">\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Generate Report\n                </Button>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid gap-4\">\n              {reports.map((report) => (\n                <Card key={report.id} data-testid={`card-report-${report.id}`}>\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"p-2 bg-primary/10 rounded-md\">\n                          {getReportIcon(report.reportType)}\n                        </div>\n                        <div>\n                          <h3 className=\"font-medium\">{report.title}</h3>\n                          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                            <Calendar className=\"w-3 h-3\" />\n                            <span>\n                              {format(new Date(report.dateRangeFrom), \"MMM d, yyyy\")} - {format(new Date(report.dateRangeTo), \"MMM d, yyyy\")}\n                            </span>\n                            {report.framework && (\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                {report.framework.toUpperCase()}\n                              </Badge>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        {getStatusBadge(report.status)}\n                        <DropdownMenu>\n                          <DropdownMenuTrigger asChild>\n                            <Button\n                              size=\"icon\"\n                              variant=\"ghost\"\n                              data-testid={`btn-download-${report.id}`}\n                            >\n                              <Download className=\"w-4 h-4\" />\n                            </Button>\n                          </DropdownMenuTrigger>\n                          <DropdownMenuContent align=\"end\">\n                            <DropdownMenuItem \n                              onClick={() => handleDownload(report, \"pdf\")}\n                              data-testid={`btn-download-pdf-${report.id}`}\n                            >\n                              <FileType className=\"w-4 h-4 mr-2\" />\n                              Download PDF\n                            </DropdownMenuItem>\n                            <DropdownMenuItem \n                              onClick={() => handleDownload(report, \"json\")}\n                              data-testid={`btn-download-json-${report.id}`}\n                            >\n                              <FileJson className=\"w-4 h-4 mr-2\" />\n                              Download JSON\n                            </DropdownMenuItem>\n                            <DropdownMenuItem \n                              onClick={() => handleDownload(report, \"csv\")}\n                              data-testid={`btn-download-csv-${report.id}`}\n                            >\n                              <FileSpreadsheet className=\"w-4 h-4 mr-2\" />\n                              Download CSV\n                            </DropdownMenuItem>\n                          </DropdownMenuContent>\n                        </DropdownMenu>\n                        {canDeleteReport && (\n                          <Button\n                            size=\"icon\"\n                            variant=\"ghost\"\n                            onClick={() => deleteMutation.mutate(report.id)}\n                            disabled={deleteMutation.isPending}\n                            data-testid={`btn-delete-${report.id}`}\n                          >\n                            <Trash2 className=\"w-4 h-4\" />\n                          </Button>\n                        )}\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"preview\">\n          {previewData && (\n            <Card>\n              <CardHeader>\n                <CardTitle>{previewData.title}</CardTitle>\n                <CardDescription>Generated report preview</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <ScrollArea className=\"h-[500px]\">\n                  <div className=\"space-y-6\">\n                    {previewData.data.executiveSummary && (\n                      <div>\n                        <h3 className=\"font-semibold text-lg mb-2\">Executive Summary</h3>\n                        <p className=\"text-muted-foreground\">{previewData.data.executiveSummary}</p>\n                      </div>\n                    )}\n                    \n                    {previewData.data.keyMetrics && (\n                      <div>\n                        <h3 className=\"font-semibold text-lg mb-2\">Key Metrics</h3>\n                        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                          {Object.entries(previewData.data.keyMetrics).map(([key, value]) => (\n                            <div key={key} className=\"bg-muted p-3 rounded-md\">\n                              <div className=\"text-sm text-muted-foreground\">{key.replace(/([A-Z])/g, \" $1\").replace(/^./, s => s.toUpperCase())}</div>\n                              <div className=\"text-lg font-semibold\">{String(value)}</div>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n\n                    {previewData.data.recommendations && Array.isArray(previewData.data.recommendations) && (\n                      <div>\n                        <h3 className=\"font-semibold text-lg mb-2\">Recommendations</h3>\n                        <ul className=\"list-disc list-inside space-y-2\">\n                          {previewData.data.recommendations.map((rec: any, idx: number) => (\n                            <li key={idx} className=\"text-muted-foreground\">\n                              {typeof rec === \"string\" ? rec : (\n                                rec.action ? (\n                                  <span>\n                                    {rec.priority && <Badge className=\"mr-2\">Priority {rec.priority}</Badge>}\n                                    {rec.action}\n                                    {rec.impact && <span className=\"text-sm italic ml-2\">({rec.impact})</span>}\n                                  </span>\n                                ) : (rec.description || rec.title || rec.text || \"Recommendation pending\")\n                              )}\n                            </li>\n                          ))}\n                        </ul>\n                      </div>\n                    )}\n\n                    {previewData.data.findings && Array.isArray(previewData.data.findings) && (\n                      <div>\n                        <h3 className=\"font-semibold text-lg mb-2\">Findings</h3>\n                        <div className=\"space-y-3\">\n                          {previewData.data.findings.slice(0, 10).map((finding: any, idx: number) => (\n                            <div key={idx} className=\"bg-muted p-3 rounded-md\">\n                              <div className=\"flex items-center gap-2 mb-1\">\n                                <Badge variant={finding.severity === \"critical\" ? \"destructive\" : \"secondary\"}>\n                                  {finding.severity?.toUpperCase() || \"N/A\"}\n                                </Badge>\n                                <span className=\"font-medium\">{finding.title || \"Untitled Finding\"}</span>\n                              </div>\n                              <p className=\"text-sm text-muted-foreground\">{finding.description}</p>\n                              {finding.recommendation && (\n                                <p className=\"text-sm mt-2\"><span className=\"font-medium\">Recommendation:</span> {finding.recommendation}</p>\n                              )}\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n\n                    {previewData.data.topRisks && Array.isArray(previewData.data.topRisks) && previewData.data.topRisks.length > 0 && (\n                      <div>\n                        <h3 className=\"font-semibold text-lg mb-2\">Top Business Risks</h3>\n                        <div className=\"space-y-3\">\n                          {previewData.data.topRisks.slice(0, 5).map((risk: any, idx: number) => (\n                            <div key={idx} className=\"bg-muted p-3 rounded-md\">\n                              <div className=\"flex items-center gap-2 mb-1\">\n                                <Badge variant={risk.severity === \"critical\" ? \"destructive\" : \"secondary\"}>\n                                  {risk.severity?.toUpperCase() || \"N/A\"}\n                                </Badge>\n                                <span className=\"font-medium\">{risk.assetId || \"Asset\"}</span>\n                                {risk.financialImpact && (\n                                  <span className=\"text-sm text-muted-foreground ml-auto\">{risk.financialImpact}</span>\n                                )}\n                              </div>\n                              <p className=\"text-sm text-muted-foreground\">{risk.riskDescription}</p>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n\n                    {previewData.data.attackPaths && Array.isArray(previewData.data.attackPaths) && previewData.data.attackPaths.length > 0 && (\n                      <div>\n                        <h3 className=\"font-semibold text-lg mb-2\">Attack Path Analysis</h3>\n                        <div className=\"space-y-3\">\n                          {previewData.data.attackPaths.slice(0, 3).map((path: any, idx: number) => (\n                            <div key={idx} className=\"bg-muted p-3 rounded-md\">\n                              <div className=\"flex items-center gap-2 mb-2\">\n                                <span className=\"font-medium\">Path {idx + 1}: {path.assetId || \"Target\"}</span>\n                                {path.complexity && <Badge variant=\"outline\">Complexity: {path.complexity}</Badge>}\n                                {path.timeToCompromise && <Badge variant=\"outline\">{path.timeToCompromise}</Badge>}\n                              </div>\n                              {path.steps && Array.isArray(path.steps) && (\n                                <div className=\"text-sm text-muted-foreground\">\n                                  {path.steps.map((step: any, i: number) => (\n                                    <span key={i}>\n                                      {i > 0 && \"  \"}\n                                      {step.technique || step.action || step.description || \"Step\"}\n                                    </span>\n                                  ))}\n                                </div>\n                              )}\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n\n                    {previewData.data.gaps && Array.isArray(previewData.data.gaps) && previewData.data.gaps.length > 0 && (\n                      <div>\n                        <h3 className=\"font-semibold text-lg mb-2\">Compliance Gaps</h3>\n                        <div className=\"space-y-3\">\n                          {previewData.data.gaps.slice(0, 5).map((gap: any, idx: number) => (\n                            <div key={idx} className=\"bg-muted p-3 rounded-md\">\n                              <div className=\"flex items-center gap-2 mb-1\">\n                                <Badge variant={gap.severity === \"critical\" ? \"destructive\" : \"secondary\"}>\n                                  {gap.severity?.toUpperCase() || \"MEDIUM\"}\n                                </Badge>\n                                <span className=\"font-medium\">{gap.controlId}</span>\n                              </div>\n                              <p className=\"text-sm text-muted-foreground\">{gap.gapDescription}</p>\n                              {gap.remediationGuidance && (\n                                <p className=\"text-sm mt-2\"><span className=\"font-medium\">Remediation:</span> {gap.remediationGuidance}</p>\n                              )}\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n\n                    {previewData.data.auditReadiness && (\n                      <div>\n                        <h3 className=\"font-semibold text-lg mb-2\">Audit Readiness</h3>\n                        <div className=\"bg-muted p-4 rounded-md\">\n                          <div className=\"grid grid-cols-2 gap-4 mb-3\">\n                            <div>\n                              <div className=\"text-sm text-muted-foreground\">Readiness Score</div>\n                              <div className=\"text-2xl font-bold\">{previewData.data.auditReadiness.score || 0}%</div>\n                            </div>\n                            <div>\n                              <div className=\"text-sm text-muted-foreground\">Compliant Controls</div>\n                              <div className=\"text-2xl font-bold\">\n                                {previewData.data.auditReadiness.readyControls || 0} / {previewData.data.auditReadiness.totalControls || 0}\n                              </div>\n                            </div>\n                          </div>\n                          {previewData.data.auditReadiness.priorityActions && Array.isArray(previewData.data.auditReadiness.priorityActions) && (\n                            <div>\n                              <div className=\"text-sm font-medium mb-2\">Priority Actions:</div>\n                              <ul className=\"list-decimal list-inside text-sm text-muted-foreground space-y-1\">\n                                {previewData.data.auditReadiness.priorityActions.slice(0, 3).map((action: string, idx: number) => (\n                                  <li key={idx}>{action}</li>\n                                ))}\n                              </ul>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    )}\n\n                    {!previewData.data.executiveSummary && !previewData.data.recommendations && !previewData.data.findings && (\n                      <pre className=\"text-sm font-mono bg-muted p-4 rounded-md overflow-x-auto\">\n                        {JSON.stringify(previewData.data, null, 2)}\n                      </pre>\n                    )}\n                  </div>\n                </ScrollArea>\n              </CardContent>\n            </Card>\n          )}\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":52771,"size_tokens":null},"client/src/pages/Advanced.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport {\n  Brain,\n  Target,\n  Shield,\n  Crosshair,\n  Users,\n  Activity,\n  TrendingUp,\n  TrendingDown,\n  Minus,\n  AlertTriangle,\n  CheckCircle2,\n  Clock,\n  Zap,\n  Play,\n  Loader2,\n  Plus,\n  ExternalLink,\n  Eye,\n  EyeOff,\n  Skull,\n  Building2,\n  GraduationCap,\n  Gauge,\n  BarChart3,\n  RefreshCw,\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { \n  DefensivePostureScore, \n  AttackPrediction, \n  AiAdversaryProfile, \n  AiSimulation, \n  PurpleTeamFinding \n} from \"@shared/schema\";\n\nconst ORG_ID = \"default\";\n\nconst adversaryTypeConfig: Record<string, { label: string; icon: typeof Skull; color: string }> = {\n  script_kiddie: { label: \"Script Kiddie\", icon: GraduationCap, color: \"text-emerald-400\" },\n  opportunistic_criminal: { label: \"Opportunistic Criminal\", icon: Target, color: \"text-amber-400\" },\n  organized_crime: { label: \"Organized Crime\", icon: Building2, color: \"text-orange-400\" },\n  insider_threat: { label: \"Insider Threat\", icon: Users, color: \"text-red-400\" },\n  nation_state: { label: \"Nation State\", icon: Shield, color: \"text-red-500\" },\n  apt_group: { label: \"APT Group\", icon: Skull, color: \"text-red-600\" },\n  hacktivist: { label: \"Hacktivist\", icon: Zap, color: \"text-purple-400\" },\n  competitor: { label: \"Competitor\", icon: Building2, color: \"text-blue-400\" },\n};\n\nconst trendIcons = {\n  improving: { icon: TrendingUp, color: \"text-emerald-400\" },\n  stable: { icon: Minus, color: \"text-amber-400\" },\n  degrading: { icon: TrendingDown, color: \"text-red-400\" },\n  new: { icon: Zap, color: \"text-cyan-400\" },\n  increasing: { icon: TrendingUp, color: \"text-red-400\" },\n  decreasing: { icon: TrendingDown, color: \"text-emerald-400\" },\n};\n\nconst detectionStatusConfig: Record<string, { label: string; color: string }> = {\n  detected: { label: \"Detected\", color: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\" },\n  partially_detected: { label: \"Partial\", color: \"bg-amber-500/10 text-amber-400 border-amber-500/30\" },\n  missed: { label: \"Missed\", color: \"bg-red-500/10 text-red-400 border-red-500/30\" },\n};\n\nconst feedbackStatusConfig: Record<string, { label: string; color: string }> = {\n  pending: { label: \"Pending\", color: \"bg-gray-500/10 text-gray-400 border-gray-500/30\" },\n  in_progress: { label: \"In Progress\", color: \"bg-blue-500/10 text-blue-400 border-blue-500/30\" },\n  implemented: { label: \"Implemented\", color: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\" },\n  wont_fix: { label: \"Won't Fix\", color: \"bg-orange-500/10 text-orange-400 border-orange-500/30\" },\n};\n\nconst priorityConfig: Record<string, { label: string; color: string }> = {\n  critical: { label: \"Critical\", color: \"bg-red-500/10 text-red-400 border-red-500/30\" },\n  high: { label: \"High\", color: \"bg-orange-500/10 text-orange-400 border-orange-500/30\" },\n  medium: { label: \"Medium\", color: \"bg-amber-500/10 text-amber-400 border-amber-500/30\" },\n  low: { label: \"Low\", color: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\" },\n};\n\nexport default function Advanced() {\n  const { toast } = useToast();\n  const [timeHorizon, setTimeHorizon] = useState(\"30d\");\n  const [isSimulationDialogOpen, setIsSimulationDialogOpen] = useState(false);\n  const [newSimulation, setNewSimulation] = useState({\n    name: \"\",\n    description: \"\",\n    attackerProfileId: \"\",\n  });\n\n  const { data: posture, isLoading: postureLoading } = useQuery<DefensivePostureScore>({\n    queryKey: [\"/api/defensive-posture\", ORG_ID],\n  });\n\n  const { data: predictions = [], isLoading: predictionsLoading } = useQuery<AttackPrediction[]>({\n    queryKey: [\"/api/attack-predictions\", ORG_ID],\n  });\n\n  const { data: adversaryProfiles = [], isLoading: profilesLoading } = useQuery<AiAdversaryProfile[]>({\n    queryKey: [\"/api/adversary-profiles\"],\n  });\n\n  const { data: simulations = [], isLoading: simulationsLoading } = useQuery<AiSimulation[]>({\n    queryKey: [\"/api/ai-simulations\", ORG_ID],\n  });\n\n  const { data: purpleTeamFindings = [], isLoading: findingsLoading } = useQuery<PurpleTeamFinding[]>({\n    queryKey: [\"/api/purple-team\", ORG_ID],\n  });\n\n  const generatePredictionMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/attack-predictions/generate\", {\n        organizationId: ORG_ID,\n        timeHorizon,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/attack-predictions\", ORG_ID] });\n      toast({\n        title: \"Prediction Generated\",\n        description: \"New attack prediction analysis complete\",\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Generation Failed\",\n        description: String(error),\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createSimulationMutation = useMutation({\n    mutationFn: async (data: typeof newSimulation) => {\n      const response = await apiRequest(\"POST\", \"/api/ai-simulations\", {\n        ...data,\n        organizationId: ORG_ID,\n        targetEnvironment: {\n          assets: [\"web-app-01\", \"db-server-01\", \"api-gateway\"],\n          networkTopology: \"standard\",\n          securityControls: [\"WAF\", \"IDS\", \"EDR\"],\n        },\n        defenderConfig: {\n          detectionCapabilities: [\"network\", \"endpoint\", \"identity\"],\n          responseAutomation: true,\n          honeypots: false,\n          deception: false,\n        },\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/ai-simulations\", ORG_ID] });\n      setIsSimulationDialogOpen(false);\n      setNewSimulation({ name: \"\", description: \"\", attackerProfileId: \"\" });\n      toast({\n        title: \"Simulation Started\",\n        description: \"AI vs AI simulation is now running\",\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Failed to Start Simulation\",\n        description: String(error),\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateFindingMutation = useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<PurpleTeamFinding> }) => {\n      const response = await apiRequest(\"PATCH\", `/api/purple-team/${id}`, updates);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/purple-team\", ORG_ID] });\n      toast({\n        title: \"Finding Updated\",\n        description: \"Purple team finding has been updated\",\n      });\n    },\n  });\n\n  const latestPrediction = predictions.length > 0 ? predictions[0] : null;\n  const categoryScores = posture?.categoryScores as Record<string, number> | undefined;\n\n  const getScoreColor = (score: number) => {\n    if (score >= 80) return \"text-emerald-400\";\n    if (score >= 60) return \"text-amber-400\";\n    if (score >= 40) return \"text-orange-400\";\n    return \"text-red-400\";\n  };\n\n  const getScoreGradient = (score: number) => {\n    if (score >= 80) return \"from-emerald-500 to-emerald-600\";\n    if (score >= 60) return \"from-amber-500 to-amber-600\";\n    if (score >= 40) return \"from-orange-500 to-orange-600\";\n    return \"from-red-500 to-red-600\";\n  };\n\n  if (postureLoading) {\n    return (\n      <div className=\"space-y-6\" data-testid=\"advanced-loading\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 w-64 bg-muted rounded\" />\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n            {[1, 2, 3, 4].map(i => (\n              <div key={i} className=\"h-64 bg-muted rounded-lg\" />\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const isInitialData = simulations.length === 0 && purpleTeamFindings.length === 0 && predictions.length === 0;\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"advanced-page\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-foreground flex items-center gap-2\" data-testid=\"text-advanced-title\">\n          <Brain className=\"h-7 w-7 text-cyan-400\" />\n          Advanced AI Capabilities\n        </h1>\n        <p className=\"text-sm text-muted-foreground mt-1\">\n          Next-generation threat intelligence and predictive security\n        </p>\n      </div>\n\n      {isInitialData && (\n        <Alert className=\"border-amber-500/30 bg-amber-500/10\" data-testid=\"alert-sample-data\">\n          <AlertTriangle className=\"h-4 w-4 text-amber-400\" />\n          <AlertDescription className=\"text-amber-400\">\n            Showing initial sample data. Run evaluations and simulations to generate real security metrics.\n          </AlertDescription>\n        </Alert>\n      )}\n\n      <Card data-testid=\"card-defensive-posture\">\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n            <div className=\"flex items-center gap-2\">\n              <Shield className=\"h-5 w-5 text-cyan-400\" />\n              <CardTitle className=\"text-lg\">Defensive Posture Score</CardTitle>\n            </div>\n            {posture?.trendDirection && (\n              <Badge variant=\"outline\" className={`${trendIcons[posture.trendDirection as keyof typeof trendIcons]?.color || \"text-muted-foreground\"}`}>\n                {(() => {\n                  const TrendIcon = trendIcons[posture.trendDirection as keyof typeof trendIcons]?.icon || Minus;\n                  return <TrendIcon className=\"h-3 w-3 mr-1\" />;\n                })()}\n                {posture.trendDirection.charAt(0).toUpperCase() + posture.trendDirection.slice(1)}\n              </Badge>\n            )}\n          </div>\n          <CardDescription>Overall security posture assessment and industry benchmarking</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n            <div className=\"flex flex-col items-center justify-center\">\n              <div className=\"relative w-40 h-40\">\n                <svg className=\"w-full h-full transform -rotate-90\" viewBox=\"0 0 100 100\">\n                  <circle\n                    cx=\"50\"\n                    cy=\"50\"\n                    r=\"45\"\n                    fill=\"none\"\n                    stroke=\"currentColor\"\n                    strokeWidth=\"8\"\n                    className=\"text-muted/30\"\n                  />\n                  <circle\n                    cx=\"50\"\n                    cy=\"50\"\n                    r=\"45\"\n                    fill=\"none\"\n                    stroke=\"url(#scoreGradient)\"\n                    strokeWidth=\"8\"\n                    strokeLinecap=\"round\"\n                    strokeDasharray={`${(posture?.overallScore || 0) * 2.83} 283`}\n                  />\n                  <defs>\n                    <linearGradient id=\"scoreGradient\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\">\n                      <stop offset=\"0%\" className={`${getScoreGradient(posture?.overallScore || 0).includes(\"emerald\") ? \"text-emerald-500\" : getScoreGradient(posture?.overallScore || 0).includes(\"amber\") ? \"text-amber-500\" : getScoreGradient(posture?.overallScore || 0).includes(\"orange\") ? \"text-orange-500\" : \"text-red-500\"}`} stopColor=\"currentColor\" />\n                      <stop offset=\"100%\" className={`${getScoreGradient(posture?.overallScore || 0).includes(\"emerald\") ? \"text-emerald-600\" : getScoreGradient(posture?.overallScore || 0).includes(\"amber\") ? \"text-amber-600\" : getScoreGradient(posture?.overallScore || 0).includes(\"orange\") ? \"text-orange-600\" : \"text-red-600\"}`} stopColor=\"currentColor\" />\n                    </linearGradient>\n                  </defs>\n                </svg>\n                <div className=\"absolute inset-0 flex flex-col items-center justify-center\">\n                  <span className={`text-4xl font-bold ${getScoreColor(posture?.overallScore || 0)}`} data-testid=\"text-posture-score\">\n                    {posture?.overallScore || 0}\n                  </span>\n                  <span className=\"text-xs text-muted-foreground\">/ 100</span>\n                </div>\n              </div>\n              {posture?.benchmarkPercentile && (\n                <div className=\"mt-3 text-center\">\n                  <Badge variant=\"outline\" className=\"text-cyan-400 border-cyan-500/30\">\n                    Top {100 - posture.benchmarkPercentile}% Industry\n                  </Badge>\n                </div>\n              )}\n            </div>\n\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"p-3 rounded-lg bg-muted/50\">\n                  <div className=\"text-xs text-muted-foreground uppercase tracking-wide\">Breach Likelihood</div>\n                  <div className=\"text-2xl font-bold text-orange-400\" data-testid=\"text-breach-likelihood\">\n                    {posture?.breachLikelihood || 0}%\n                  </div>\n                </div>\n                <div className=\"p-3 rounded-lg bg-muted/50\">\n                  <div className=\"text-xs text-muted-foreground uppercase tracking-wide\">Benchmark</div>\n                  <div className=\"text-2xl font-bold text-cyan-400\" data-testid=\"text-benchmark\">\n                    {posture?.benchmarkPercentile || 0}th %ile\n                  </div>\n                </div>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"p-3 rounded-lg bg-muted/50\">\n                  <div className=\"text-xs text-muted-foreground uppercase tracking-wide flex items-center gap-1\">\n                    <Clock className=\"h-3 w-3\" />\n                    MTTD\n                  </div>\n                  <div className=\"text-2xl font-bold text-foreground\" data-testid=\"text-mttd\">\n                    {posture?.meanTimeToDetect || 0}h\n                  </div>\n                </div>\n                <div className=\"p-3 rounded-lg bg-muted/50\">\n                  <div className=\"text-xs text-muted-foreground uppercase tracking-wide flex items-center gap-1\">\n                    <Zap className=\"h-3 w-3\" />\n                    MTTR\n                  </div>\n                  <div className=\"text-2xl font-bold text-foreground\" data-testid=\"text-mttr\">\n                    {posture?.meanTimeToRespond || 0}h\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <div className=\"text-sm font-medium text-muted-foreground mb-3\">Category Breakdown</div>\n              {categoryScores && Object.entries(categoryScores).map(([key, value]) => (\n                <div key={key} className=\"flex items-center gap-2\">\n                  <div className=\"w-28 text-xs text-muted-foreground truncate capitalize\">\n                    {key.replace(/([A-Z])/g, ' $1').trim()}\n                  </div>\n                  <Progress value={value} className=\"flex-1 h-2\" />\n                  <div className={`w-8 text-xs font-mono ${getScoreColor(value)}`}>{value}</div>\n                </div>\n              ))}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card data-testid=\"card-attack-predictions\">\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <div className=\"flex items-center gap-2\">\n                <Target className=\"h-5 w-5 text-red-400\" />\n                <CardTitle className=\"text-lg\">Attack Predictions</CardTitle>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Tabs value={timeHorizon} onValueChange={setTimeHorizon}>\n                  <TabsList className=\"h-8\">\n                    <TabsTrigger value=\"7d\" className=\"text-xs\">7d</TabsTrigger>\n                    <TabsTrigger value=\"30d\" className=\"text-xs\">30d</TabsTrigger>\n                    <TabsTrigger value=\"90d\" className=\"text-xs\">90d</TabsTrigger>\n                  </TabsList>\n                </Tabs>\n                <Button\n                  size=\"sm\"\n                  onClick={() => generatePredictionMutation.mutate()}\n                  disabled={generatePredictionMutation.isPending}\n                  data-testid=\"btn-generate-prediction\"\n                >\n                  {generatePredictionMutation.isPending ? (\n                    <Loader2 className=\"h-4 w-4 mr-1 animate-spin\" />\n                  ) : (\n                    <RefreshCw className=\"h-4 w-4 mr-1\" />\n                  )}\n                  Generate\n                </Button>\n              </div>\n            </div>\n            <CardDescription>AI-predicted attack vectors and threat intelligence</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {predictionsLoading ? (\n              <div className=\"flex items-center justify-center py-8\">\n                <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n              </div>\n            ) : latestPrediction ? (\n              <>\n                <div className=\"p-3 rounded-lg bg-red-500/10 border border-red-500/30 flex items-center justify-between gap-4 flex-wrap\">\n                  <div className=\"flex items-center gap-2\">\n                    <AlertTriangle className=\"h-5 w-5 text-red-400\" />\n                    <span className=\"text-sm font-medium\">Overall Breach Likelihood</span>\n                  </div>\n                  <span className=\"text-2xl font-bold text-red-400\" data-testid=\"text-overall-breach\">\n                    {latestPrediction.overallBreachLikelihood}%\n                  </span>\n                </div>\n\n                <div className=\"space-y-3\">\n                  <div className=\"text-sm font-medium text-muted-foreground\">Predicted Attack Vectors</div>\n                  {(latestPrediction.predictedAttackVectors as any[])?.map((vector, idx) => (\n                    <div key={idx} className=\"p-3 rounded-lg bg-muted/50 space-y-2\" data-testid={`card-vector-${idx}`}>\n                      <div className=\"flex items-center justify-between gap-2 flex-wrap\">\n                        <span className=\"font-medium\">{vector.vector}</span>\n                        <Badge variant=\"outline\" className={adversaryTypeConfig[vector.adversaryProfile]?.color || \"text-muted-foreground\"}>\n                          {adversaryTypeConfig[vector.adversaryProfile]?.label || vector.adversaryProfile}\n                        </Badge>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Progress value={vector.likelihood} className=\"flex-1 h-2\" />\n                        <span className=\"text-sm font-mono w-12\">{vector.likelihood}%</span>\n                      </div>\n                      <div className=\"flex items-center justify-between gap-2 text-xs text-muted-foreground flex-wrap\">\n                        <span>Confidence: {vector.confidence}%</span>\n                        <a\n                          href={`https://attack.mitre.org/techniques/${vector.mitreAttackId}`}\n                          target=\"_blank\"\n                          rel=\"noopener noreferrer\"\n                          className=\"flex items-center gap-1 text-cyan-400\"\n                          data-testid={`link-mitre-${idx}`}\n                        >\n                          {vector.mitreAttackId}\n                          <ExternalLink className=\"h-3 w-3\" />\n                        </a>\n                      </div>\n                      <div className=\"text-xs text-muted-foreground\">{vector.estimatedImpact}</div>\n                    </div>\n                  ))}\n                </div>\n\n                <div className=\"space-y-3\">\n                  <div className=\"text-sm font-medium text-muted-foreground\">Risk Factors</div>\n                  {(latestPrediction.riskFactors as any[])?.map((factor, idx) => {\n                    const TrendIcon = trendIcons[factor.trend as keyof typeof trendIcons]?.icon || Minus;\n                    const trendColor = trendIcons[factor.trend as keyof typeof trendIcons]?.color || \"text-muted-foreground\";\n                    return (\n                      <div key={idx} className=\"flex items-center justify-between gap-2\" data-testid={`risk-factor-${idx}`}>\n                        <span className=\"text-sm\">{factor.factor}</span>\n                        <div className=\"flex items-center gap-2\">\n                          <span className=\"text-sm font-mono\">{factor.contribution}%</span>\n                          <TrendIcon className={`h-4 w-4 ${trendColor}`} />\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n\n                <div className=\"space-y-2\">\n                  <div className=\"text-sm font-medium text-muted-foreground\">Recommended Actions</div>\n                  <ul className=\"space-y-1\">\n                    {(latestPrediction.recommendedActions as string[])?.map((action, idx) => (\n                      <li key={idx} className=\"flex items-start gap-2 text-sm\" data-testid={`action-${idx}`}>\n                        <CheckCircle2 className=\"h-4 w-4 text-emerald-400 mt-0.5 shrink-0\" />\n                        {action}\n                      </li>\n                    ))}\n                  </ul>\n                </div>\n              </>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Target className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                <p>No predictions yet. Click Generate to create one.</p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-adversary-profiles\">\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-center gap-2\">\n              <Skull className=\"h-5 w-5 text-purple-400\" />\n              <CardTitle className=\"text-lg\">AI Adversary Profiles</CardTitle>\n            </div>\n            <CardDescription>Threat actor personas for attack simulation</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {profilesLoading ? (\n              <div className=\"flex items-center justify-center py-8\">\n                <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n              </div>\n            ) : adversaryProfiles.length > 0 ? (\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3\">\n                {adversaryProfiles.map((profile) => {\n                  const config = adversaryTypeConfig[profile.profileType] || adversaryTypeConfig.script_kiddie;\n                  const ProfileIcon = config.icon;\n                  const capabilities = profile.capabilities as any;\n                  return (\n                    <div\n                      key={profile.id}\n                      className=\"p-3 rounded-lg bg-muted/50 space-y-3\"\n                      data-testid={`card-profile-${profile.id}`}\n                    >\n                      <div className=\"flex items-center justify-between gap-2\">\n                        <div className=\"flex items-center gap-2\">\n                          <ProfileIcon className={`h-5 w-5 ${config.color}`} />\n                          <span className=\"font-medium\">{profile.name}</span>\n                        </div>\n                        <Badge variant=\"outline\" className={`text-xs ${config.color}`}>\n                          {config.label}\n                        </Badge>\n                      </div>\n                      \n                      {capabilities && (\n                        <div className=\"space-y-1.5\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"text-xs text-muted-foreground w-20\">Sophistication</span>\n                            <Progress value={(capabilities.technicalSophistication || 0) * 10} className=\"flex-1 h-1.5\" />\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"text-xs text-muted-foreground w-20\">Resources</span>\n                            <Progress value={(capabilities.resources || 0) * 10} className=\"flex-1 h-1.5\" />\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"text-xs text-muted-foreground w-20\">Persistence</span>\n                            <Progress value={(capabilities.persistence || 0) * 10} className=\"flex-1 h-1.5\" />\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"text-xs text-muted-foreground w-20\">Stealth</span>\n                            <Progress value={(capabilities.stealth || 0) * 10} className=\"flex-1 h-1.5\" />\n                          </div>\n                        </div>\n                      )}\n\n                      <div className=\"flex items-center justify-between gap-2 text-xs text-muted-foreground flex-wrap\">\n                        {profile.detectionDifficulty && (\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            {profile.detectionDifficulty === \"very_high\" ? (\n                              <EyeOff className=\"h-3 w-3 mr-1\" />\n                            ) : (\n                              <Eye className=\"h-3 w-3 mr-1\" />\n                            )}\n                            {profile.detectionDifficulty.replace(\"_\", \" \")}\n                          </Badge>\n                        )}\n                        {profile.avgDwellTime && (\n                          <span className=\"flex items-center gap-1\">\n                            <Clock className=\"h-3 w-3\" />\n                            {profile.avgDwellTime}d dwell\n                          </span>\n                        )}\n                      </div>\n\n                      {(profile.motivations as string[])?.length > 0 && (\n                        <div className=\"flex gap-1 flex-wrap\">\n                          {(profile.motivations as string[]).slice(0, 3).map((m, i) => (\n                            <Badge key={i} variant=\"secondary\" className=\"text-xs\">\n                              {m}\n                            </Badge>\n                          ))}\n                        </div>\n                      )}\n                    </div>\n                  );\n                })}\n              </div>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Skull className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                <p>No adversary profiles configured</p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card data-testid=\"card-ai-simulations\">\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n            <div className=\"flex items-center gap-2\">\n              <Crosshair className=\"h-5 w-5 text-amber-400\" />\n              <CardTitle className=\"text-lg\">AI vs AI Simulations</CardTitle>\n            </div>\n            <Dialog open={isSimulationDialogOpen} onOpenChange={setIsSimulationDialogOpen}>\n              <DialogTrigger asChild>\n                <Button size=\"sm\" data-testid=\"btn-new-simulation\">\n                  <Plus className=\"h-4 w-4 mr-1\" />\n                  New Simulation\n                </Button>\n              </DialogTrigger>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Create AI Simulation</DialogTitle>\n                  <DialogDescription>Configure an AI attacker vs AI defender simulation</DialogDescription>\n                </DialogHeader>\n                <div className=\"space-y-4 py-4\">\n                  <div className=\"space-y-2\">\n                    <Label>Simulation Name</Label>\n                    <Input\n                      value={newSimulation.name}\n                      onChange={(e) => setNewSimulation({ ...newSimulation, name: e.target.value })}\n                      placeholder=\"e.g., Q4 Red Team Exercise\"\n                      data-testid=\"input-simulation-name\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label>Description</Label>\n                    <Input\n                      value={newSimulation.description}\n                      onChange={(e) => setNewSimulation({ ...newSimulation, description: e.target.value })}\n                      placeholder=\"Brief description of simulation goals\"\n                      data-testid=\"input-simulation-description\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label>Attacker Profile</Label>\n                    <Select\n                      value={newSimulation.attackerProfileId}\n                      onValueChange={(v) => setNewSimulation({ ...newSimulation, attackerProfileId: v })}\n                    >\n                      <SelectTrigger data-testid=\"select-attacker-profile\">\n                        <SelectValue placeholder=\"Select attacker profile\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {adversaryProfiles.map((profile) => (\n                          <SelectItem key={profile.id} value={profile.id}>\n                            {profile.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n                <DialogFooter>\n                  <Button variant=\"outline\" onClick={() => setIsSimulationDialogOpen(false)}>\n                    Cancel\n                  </Button>\n                  <Button\n                    onClick={() => createSimulationMutation.mutate(newSimulation)}\n                    disabled={createSimulationMutation.isPending || !newSimulation.name}\n                    data-testid=\"btn-start-simulation\"\n                  >\n                    {createSimulationMutation.isPending && <Loader2 className=\"h-4 w-4 mr-1 animate-spin\" />}\n                    Start Simulation\n                  </Button>\n                </DialogFooter>\n              </DialogContent>\n            </Dialog>\n          </div>\n          <CardDescription>Run attack simulations with AI-powered offense and defense</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {simulationsLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n            </div>\n          ) : simulations.length > 0 ? (\n            <div className=\"space-y-4\">\n              {simulations.map((sim) => {\n                const results = sim.simulationResults as any;\n                return (\n                  <div\n                    key={sim.id}\n                    className=\"p-4 rounded-lg bg-muted/50 space-y-3\"\n                    data-testid={`card-simulation-${sim.id}`}\n                  >\n                    <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                      <div>\n                        <div className=\"font-medium\">{sim.name}</div>\n                        {sim.description && (\n                          <div className=\"text-sm text-muted-foreground\">{sim.description}</div>\n                        )}\n                      </div>\n                      <Badge\n                        variant=\"outline\"\n                        className={\n                          sim.simulationStatus === \"completed\"\n                            ? \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\"\n                            : sim.simulationStatus === \"running\"\n                            ? \"bg-amber-500/10 text-amber-400 border-amber-500/30\"\n                            : sim.simulationStatus === \"failed\"\n                            ? \"bg-red-500/10 text-red-400 border-red-500/30\"\n                            : \"bg-gray-500/10 text-gray-400 border-gray-500/30\"\n                        }\n                      >\n                        {sim.simulationStatus === \"running\" && <Loader2 className=\"h-3 w-3 mr-1 animate-spin\" />}\n                        {sim.simulationStatus === \"completed\" && <CheckCircle2 className=\"h-3 w-3 mr-1\" />}\n                        {(sim.simulationStatus || \"pending\").charAt(0).toUpperCase() + (sim.simulationStatus || \"pending\").slice(1)}\n                      </Badge>\n                    </div>\n\n                    {sim.simulationStatus === \"completed\" && results && (\n                      <>\n                        <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-3\">\n                          <div className=\"p-2 rounded bg-background text-center\">\n                            <div className=\"text-lg font-bold text-red-400\">{results.attackerSuccesses}</div>\n                            <div className=\"text-xs text-muted-foreground\">Attacker Wins</div>\n                          </div>\n                          <div className=\"p-2 rounded bg-background text-center\">\n                            <div className=\"text-lg font-bold text-emerald-400\">{results.defenderBlocks}</div>\n                            <div className=\"text-xs text-muted-foreground\">Defender Blocks</div>\n                          </div>\n                          <div className=\"p-2 rounded bg-background text-center\">\n                            <div className=\"text-lg font-bold text-cyan-400\">{results.timeToDetection}m</div>\n                            <div className=\"text-xs text-muted-foreground\">Time to Detect</div>\n                          </div>\n                          <div className=\"p-2 rounded bg-background text-center\">\n                            <div className=\"text-lg font-bold text-amber-400\">{results.timeToContainment}m</div>\n                            <div className=\"text-xs text-muted-foreground\">Time to Contain</div>\n                          </div>\n                        </div>\n\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm\">\n                          <div>\n                            <div className=\"text-xs text-muted-foreground uppercase tracking-wide mb-2\">Attack Path</div>\n                            <ul className=\"space-y-1\">\n                              {(results.attackPath as string[])?.slice(0, 3).map((step, i) => (\n                                <li key={i} className=\"flex items-start gap-2\">\n                                  <span className=\"text-red-400 font-mono\">{i + 1}.</span>\n                                  <span className=\"text-muted-foreground\">{step}</span>\n                                </li>\n                              ))}\n                            </ul>\n                          </div>\n                          <div>\n                            <div className=\"text-xs text-muted-foreground uppercase tracking-wide mb-2\">Detection Points</div>\n                            <ul className=\"space-y-1\">\n                              {(results.detectionPoints as string[])?.map((point, i) => (\n                                <li key={i} className=\"flex items-start gap-2\">\n                                  <CheckCircle2 className=\"h-4 w-4 text-emerald-400 shrink-0\" />\n                                  <span className=\"text-muted-foreground\">{point}</span>\n                                </li>\n                              ))}\n                            </ul>\n                          </div>\n                        </div>\n\n                        {(results.missedAttacks as string[])?.length > 0 && (\n                          <div>\n                            <div className=\"text-xs text-muted-foreground uppercase tracking-wide mb-2\">Missed Attacks</div>\n                            <ul className=\"space-y-1\">\n                              {(results.missedAttacks as string[])?.map((missed, i) => (\n                                <li key={i} className=\"flex items-start gap-2 text-sm\">\n                                  <AlertTriangle className=\"h-4 w-4 text-red-400 shrink-0\" />\n                                  <span className=\"text-muted-foreground\">{missed}</span>\n                                </li>\n                              ))}\n                            </ul>\n                          </div>\n                        )}\n\n                        {(results.recommendations as string[])?.length > 0 && (\n                          <div>\n                            <div className=\"text-xs text-muted-foreground uppercase tracking-wide mb-2\">Recommendations</div>\n                            <ul className=\"space-y-1\">\n                              {(results.recommendations as string[])?.map((rec, i) => (\n                                <li key={i} className=\"flex items-start gap-2 text-sm\">\n                                  <Zap className=\"h-4 w-4 text-cyan-400 shrink-0\" />\n                                  <span>{rec}</span>\n                                </li>\n                              ))}\n                            </ul>\n                          </div>\n                        )}\n                      </>\n                    )}\n\n                    {sim.simulationStatus === \"running\" && (\n                      <div className=\"flex items-center justify-center py-4\">\n                        <Loader2 className=\"h-6 w-6 animate-spin text-amber-400 mr-2\" />\n                        <span className=\"text-muted-foreground\">Simulation in progress...</span>\n                      </div>\n                    )}\n                  </div>\n                );\n              })}\n            </div>\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Crosshair className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n              <p>No simulations yet. Create one to test your defenses.</p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Card data-testid=\"card-purple-team\">\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex items-center gap-2\">\n            <Activity className=\"h-5 w-5 text-purple-400\" />\n            <CardTitle className=\"text-lg\">Purple Team Feedback Loop</CardTitle>\n          </div>\n          <CardDescription>Connect offensive findings to defensive improvements</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {findingsLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n            </div>\n          ) : purpleTeamFindings.length > 0 ? (\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Technique</TableHead>\n                    <TableHead>Detection</TableHead>\n                    <TableHead>Control %</TableHead>\n                    <TableHead>Recommendation</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Priority</TableHead>\n                    <TableHead>Assigned</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {purpleTeamFindings.map((finding) => (\n                    <TableRow key={finding.id} data-testid={`row-finding-${finding.id}`}>\n                      <TableCell className=\"font-mono text-sm\">\n                        {finding.offensiveTechnique || \"N/A\"}\n                      </TableCell>\n                      <TableCell>\n                        {finding.detectionStatus && (\n                          <Badge\n                            variant=\"outline\"\n                            className={`text-xs ${detectionStatusConfig[finding.detectionStatus]?.color}`}\n                          >\n                            {detectionStatusConfig[finding.detectionStatus]?.label || finding.detectionStatus}\n                          </Badge>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"flex items-center gap-2\">\n                          <Progress\n                            value={finding.controlEffectiveness || 0}\n                            className=\"w-16 h-2\"\n                          />\n                          <span className=\"text-xs font-mono\">{finding.controlEffectiveness || 0}%</span>\n                        </div>\n                      </TableCell>\n                      <TableCell className=\"max-w-xs\">\n                        <span className=\"text-sm text-muted-foreground line-clamp-2\">\n                          {finding.defensiveRecommendation || \"-\"}\n                        </span>\n                      </TableCell>\n                      <TableCell>\n                        <Select\n                          value={finding.feedbackStatus || \"pending\"}\n                          onValueChange={(value) =>\n                            updateFindingMutation.mutate({ id: finding.id, updates: { feedbackStatus: value } })\n                          }\n                        >\n                          <SelectTrigger className=\"h-8 w-28\" data-testid={`select-status-${finding.id}`}>\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {Object.entries(feedbackStatusConfig).map(([key, config]) => (\n                              <SelectItem key={key} value={key}>\n                                {config.label}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </TableCell>\n                      <TableCell>\n                        {finding.implementationPriority && (\n                          <Badge\n                            variant=\"outline\"\n                            className={`text-xs ${priorityConfig[finding.implementationPriority]?.color}`}\n                          >\n                            {priorityConfig[finding.implementationPriority]?.label}\n                          </Badge>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        <span className=\"text-sm text-muted-foreground\">\n                          {finding.assignedTo || \"-\"}\n                        </span>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Activity className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n              <p>No purple team findings yet</p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":43874,"size_tokens":null},"server/services/import-parsers.ts":{"content":"import { \n  type InsertDiscoveredAsset, \n  type InsertVulnerabilityImport,\n  type ScannerType,\n  assetTypes,\n  vulnSeverities\n} from \"@shared/schema\";\n\n// Result of parsing an import file\nexport interface ParseResult {\n  assets: InsertDiscoveredAsset[];\n  vulnerabilities: InsertVulnerabilityImport[];\n  errors: Array<{ line?: number; record?: string; error: string }>;\n  totalRecords: number;\n  successfulRecords: number;\n  failedRecords: number;\n}\n\n// CSV column mapping configuration\nexport interface CsvColumnMapping {\n  ip?: string;\n  hostname?: string;\n  fqdn?: string;\n  assetType?: string;\n  operatingSystem?: string;\n  port?: string;\n  service?: string;\n  cveId?: string;\n  vulnTitle?: string;\n  vulnDescription?: string;\n  severity?: string;\n  cvssScore?: string;\n  solution?: string;\n}\n\n// Default CSV column mappings for different scanners\nconst defaultMappings: Record<string, CsvColumnMapping> = {\n  nessus_csv: {\n    ip: \"Host\",\n    hostname: \"Hostname\",\n    port: \"Port\",\n    cveId: \"CVE\",\n    vulnTitle: \"Name\",\n    vulnDescription: \"Synopsis\",\n    severity: \"Risk\",\n    cvssScore: \"CVSS v3.0 Base Score\",\n    solution: \"Solution\",\n  },\n  qualys_csv: {\n    ip: \"IP\",\n    hostname: \"DNS\",\n    fqdn: \"FQDN\",\n    port: \"Port\",\n    cveId: \"CVE ID\",\n    vulnTitle: \"Title\",\n    vulnDescription: \"Threat\",\n    severity: \"Severity\",\n    cvssScore: \"CVSS Base\",\n    solution: \"Solution\",\n  },\n  generic: {\n    ip: \"ip\",\n    hostname: \"hostname\",\n    fqdn: \"fqdn\",\n    assetType: \"asset_type\",\n    operatingSystem: \"os\",\n    port: \"port\",\n    service: \"service\",\n    cveId: \"cve_id\",\n    vulnTitle: \"vulnerability\",\n    vulnDescription: \"description\",\n    severity: \"severity\",\n    cvssScore: \"cvss\",\n    solution: \"solution\",\n  }\n};\n\n// Normalize severity from different formats\nfunction normalizeSeverity(value: string): typeof vulnSeverities[number] {\n  const lower = value?.toLowerCase()?.trim() || \"\";\n  \n  // Nessus risk levels\n  if (lower === \"critical\" || lower === \"4\") return \"critical\";\n  if (lower === \"high\" || lower === \"3\") return \"high\";\n  if (lower === \"medium\" || lower === \"2\") return \"medium\";\n  if (lower === \"low\" || lower === \"1\") return \"low\";\n  if (lower === \"info\" || lower === \"informational\" || lower === \"none\" || lower === \"0\") return \"informational\";\n  \n  // Qualys severity levels (1-5)\n  if (lower === \"5\") return \"critical\";\n  if (lower === \"4\") return \"high\";\n  if (lower === \"3\") return \"medium\";\n  if (lower === \"2\") return \"low\";\n  if (lower === \"1\") return \"informational\";\n  \n  return \"medium\"; // Default\n}\n\n// Detect asset type from hostname/service\nfunction detectAssetType(hostname?: string, service?: string, port?: number): typeof assetTypes[number] {\n  const h = hostname?.toLowerCase() || \"\";\n  const s = service?.toLowerCase() || \"\";\n  \n  if (h.includes(\"db\") || s.includes(\"mysql\") || s.includes(\"postgres\") || s.includes(\"oracle\") || port === 3306 || port === 5432) {\n    return \"database\";\n  }\n  if (h.includes(\"web\") || s.includes(\"http\") || s.includes(\"nginx\") || s.includes(\"apache\") || port === 80 || port === 443) {\n    return \"web_application\";\n  }\n  if (h.includes(\"k8s\") || h.includes(\"kube\") || h.includes(\"container\") || s.includes(\"docker\")) {\n    return \"kubernetes_cluster\";\n  }\n  if (h.includes(\"lambda\") || h.includes(\"function\")) {\n    return \"lambda_function\";\n  }\n  if (h.includes(\"lb\") || h.includes(\"loadbalancer\") || h.includes(\"elb\") || h.includes(\"alb\")) {\n    return \"load_balancer\";\n  }\n  if (h.includes(\"firewall\") || h.includes(\"fw-\") || s.includes(\"firewall\")) {\n    return \"firewall\";\n  }\n  if (h.includes(\"switch\") || h.includes(\"router\") || h.includes(\"netdev\")) {\n    return \"network_device\";\n  }\n  if (h.includes(\"desktop\") || h.includes(\"workstation\") || h.includes(\"laptop\")) {\n    return \"workstation\";\n  }\n  if (h.includes(\"s3\") || h.includes(\"bucket\") || h.includes(\"storage\") || h.includes(\"blob\")) {\n    return \"storage_bucket\";\n  }\n  if (h.includes(\"ec2\") || h.includes(\"vm-\") || h.includes(\"instance\")) {\n    return \"cloud_instance\";\n  }\n  \n  return \"server\"; // Default\n}\n\n// Parse simple CSV (no quotes handling for now, can be enhanced)\nfunction parseCsvLine(line: string): string[] {\n  const result: string[] = [];\n  let current = \"\";\n  let inQuotes = false;\n  \n  for (let i = 0; i < line.length; i++) {\n    const char = line[i];\n    \n    if (char === '\"') {\n      if (inQuotes && line[i + 1] === '\"') {\n        current += '\"';\n        i++;\n      } else {\n        inQuotes = !inQuotes;\n      }\n    } else if (char === ',' && !inQuotes) {\n      result.push(current.trim());\n      current = \"\";\n    } else {\n      current += char;\n    }\n  }\n  \n  result.push(current.trim());\n  return result;\n}\n\n// Main CSV parser\nexport function parseCsv(\n  content: string, \n  importJobId: string,\n  scannerType: ScannerType = \"custom_csv\",\n  customMapping?: CsvColumnMapping\n): ParseResult {\n  const lines = content.split(/\\r?\\n/).filter(line => line.trim());\n  \n  if (lines.length < 2) {\n    return {\n      assets: [],\n      vulnerabilities: [],\n      errors: [{ error: \"CSV file is empty or has no data rows\" }],\n      totalRecords: 0,\n      successfulRecords: 0,\n      failedRecords: 0,\n    };\n  }\n\n  const headers = parseCsvLine(lines[0]);\n  const mapping = customMapping || defaultMappings[scannerType] || defaultMappings.generic;\n  \n  // Find column indexes\n  const getIndex = (field: keyof CsvColumnMapping): number => {\n    const columnName = mapping[field];\n    if (!columnName) return -1;\n    return headers.findIndex(h => h.toLowerCase() === columnName.toLowerCase());\n  };\n\n  const ipIdx = getIndex(\"ip\");\n  const hostnameIdx = getIndex(\"hostname\");\n  const fqdnIdx = getIndex(\"fqdn\");\n  const assetTypeIdx = getIndex(\"assetType\");\n  const osIdx = getIndex(\"operatingSystem\");\n  const portIdx = getIndex(\"port\");\n  const serviceIdx = getIndex(\"service\");\n  const cveIdx = getIndex(\"cveId\");\n  const vulnTitleIdx = getIndex(\"vulnTitle\");\n  const vulnDescIdx = getIndex(\"vulnDescription\");\n  const severityIdx = getIndex(\"severity\");\n  const cvssIdx = getIndex(\"cvssScore\");\n  const solutionIdx = getIndex(\"solution\");\n\n  const assetsMap = new Map<string, InsertDiscoveredAsset>();\n  const vulnerabilities: InsertVulnerabilityImport[] = [];\n  const errors: Array<{ line?: number; record?: string; error: string }> = [];\n  let successfulRecords = 0;\n  let failedRecords = 0;\n\n  for (let i = 1; i < lines.length; i++) {\n    try {\n      const values = parseCsvLine(lines[i]);\n      \n      const ip = ipIdx >= 0 ? values[ipIdx] : undefined;\n      const hostname = hostnameIdx >= 0 ? values[hostnameIdx] : undefined;\n      const fqdn = fqdnIdx >= 0 ? values[fqdnIdx] : undefined;\n      const port = portIdx >= 0 ? parseInt(values[portIdx]) || undefined : undefined;\n      const service = serviceIdx >= 0 ? values[serviceIdx] : undefined;\n      const cveId = cveIdx >= 0 ? values[cveIdx] : undefined;\n      const vulnTitle = vulnTitleIdx >= 0 ? values[vulnTitleIdx] : undefined;\n      const vulnDesc = vulnDescIdx >= 0 ? values[vulnDescIdx] : undefined;\n      const severity = severityIdx >= 0 ? values[severityIdx] : undefined;\n      const cvssScore = cvssIdx >= 0 ? parseFloat(values[cvssIdx]) : undefined;\n      const solution = solutionIdx >= 0 ? values[solutionIdx] : undefined;\n      const os = osIdx >= 0 ? values[osIdx] : undefined;\n      const assetTypeRaw = assetTypeIdx >= 0 ? values[assetTypeIdx] : undefined;\n\n      // Determine asset identifier\n      const assetIdentifier = ip || hostname || fqdn;\n      if (!assetIdentifier) {\n        errors.push({ line: i + 1, error: \"No IP, hostname, or FQDN found\" });\n        failedRecords++;\n        continue;\n      }\n\n      // Create or update asset\n      if (!assetsMap.has(assetIdentifier)) {\n        const assetType = assetTypeRaw && assetTypes.includes(assetTypeRaw as any) \n          ? (assetTypeRaw as typeof assetTypes[number])\n          : detectAssetType(hostname, service, port);\n\n        assetsMap.set(assetIdentifier, {\n          assetIdentifier,\n          displayName: hostname || fqdn || ip,\n          assetType,\n          ipAddresses: ip ? [ip] : [],\n          hostname: hostname || undefined,\n          fqdn: fqdn || undefined,\n          operatingSystem: os || undefined,\n          openPorts: port ? [{ port, protocol: \"tcp\", service }] : [],\n          importJobId,\n          discoverySource: scannerType,\n        });\n      } else if (port) {\n        // Add port to existing asset\n        const existing = assetsMap.get(assetIdentifier)!;\n        const existingPorts = (existing.openPorts || []) as Array<{port: number; protocol: string; service?: string; version?: string}>;\n        if (!existingPorts.some(p => p.port === port)) {\n          existingPorts.push({ port, protocol: \"tcp\", service });\n          existing.openPorts = existingPorts;\n        }\n      }\n\n      // Create vulnerability if we have vulnerability data\n      if (vulnTitle || cveId) {\n        vulnerabilities.push({\n          importJobId,\n          title: vulnTitle || cveId || \"Unknown Vulnerability\",\n          description: vulnDesc || undefined,\n          severity: normalizeSeverity(severity || \"medium\"),\n          cveId: cveId || undefined,\n          cvssScore: cvssScore ? Math.round(cvssScore * 10) : undefined,\n          scannerName: scannerType,\n          affectedHost: assetIdentifier,\n          affectedPort: port || undefined,\n          affectedService: service || undefined,\n          solution: solution || undefined,\n          rawData: { line: i + 1, values },\n        });\n      }\n\n      successfulRecords++;\n    } catch (err) {\n      errors.push({ line: i + 1, error: String(err) });\n      failedRecords++;\n    }\n  }\n\n  return {\n    assets: Array.from(assetsMap.values()),\n    vulnerabilities,\n    errors,\n    totalRecords: lines.length - 1,\n    successfulRecords,\n    failedRecords,\n  };\n}\n\n// Parse JSON format (array of vulnerability objects)\nexport function parseJson(\n  content: string,\n  importJobId: string,\n  scannerType: ScannerType = \"custom_json\"\n): ParseResult {\n  const assetsMap = new Map<string, InsertDiscoveredAsset>();\n  const vulnerabilities: InsertVulnerabilityImport[] = [];\n  const errors: Array<{ line?: number; record?: string; error: string }> = [];\n  let successfulRecords = 0;\n  let failedRecords = 0;\n\n  let data: any[];\n  try {\n    const parsed = JSON.parse(content);\n    data = Array.isArray(parsed) ? parsed : parsed.vulnerabilities || parsed.findings || parsed.data || [parsed];\n  } catch (err) {\n    return {\n      assets: [],\n      vulnerabilities: [],\n      errors: [{ error: `Invalid JSON: ${err}` }],\n      totalRecords: 0,\n      successfulRecords: 0,\n      failedRecords: 0,\n    };\n  }\n\n  for (let i = 0; i < data.length; i++) {\n    try {\n      const item = data[i];\n      \n      const assetIdentifier = item.ip || item.host || item.hostname || item.target || item.asset_id;\n      if (!assetIdentifier) {\n        errors.push({ record: JSON.stringify(item).slice(0, 100), error: \"No asset identifier found\" });\n        failedRecords++;\n        continue;\n      }\n\n      // Create asset\n      if (!assetsMap.has(assetIdentifier)) {\n        const port = parseInt(item.port) || undefined;\n        assetsMap.set(assetIdentifier, {\n          assetIdentifier,\n          displayName: item.hostname || item.name || assetIdentifier,\n          assetType: item.asset_type || detectAssetType(item.hostname, item.service, port),\n          ipAddresses: item.ip ? [item.ip] : [],\n          hostname: item.hostname || undefined,\n          fqdn: item.fqdn || undefined,\n          operatingSystem: item.os || item.operating_system || undefined,\n          openPorts: port ? [{ port, protocol: \"tcp\", service: item.service }] : [],\n          importJobId,\n          discoverySource: scannerType,\n        });\n      }\n\n      // Create vulnerability\n      const vulnTitle = item.title || item.name || item.vulnerability || item.finding;\n      if (vulnTitle || item.cve || item.cve_id) {\n        vulnerabilities.push({\n          importJobId,\n          title: vulnTitle || item.cve || item.cve_id || \"Unknown Vulnerability\",\n          description: item.description || item.synopsis || item.summary || undefined,\n          severity: normalizeSeverity(item.severity || item.risk || item.criticality || \"medium\"),\n          cveId: item.cve || item.cve_id || item.cveId || undefined,\n          cvssScore: item.cvss ? Math.round(parseFloat(item.cvss) * 10) : undefined,\n          cvssVector: item.cvss_vector || item.cvssVector || undefined,\n          scannerName: scannerType,\n          scannerPluginId: item.plugin_id || item.pluginId || item.id || undefined,\n          affectedHost: assetIdentifier,\n          affectedPort: parseInt(item.port) || undefined,\n          affectedService: item.service || undefined,\n          affectedSoftware: item.software || item.product || undefined,\n          affectedVersion: item.version || undefined,\n          solution: item.solution || item.remediation || item.fix || undefined,\n          exploitAvailable: item.exploit_available || item.exploitAvailable || false,\n          patchAvailable: item.patch_available || item.patchAvailable || undefined,\n          rawData: item,\n        });\n      }\n\n      successfulRecords++;\n    } catch (err) {\n      errors.push({ record: JSON.stringify(data[i]).slice(0, 100), error: String(err) });\n      failedRecords++;\n    }\n  }\n\n  return {\n    assets: Array.from(assetsMap.values()),\n    vulnerabilities,\n    errors,\n    totalRecords: data.length,\n    successfulRecords,\n    failedRecords,\n  };\n}\n\n// Parse Nessus XML format (.nessus)\nexport function parseNessusXml(\n  content: string,\n  importJobId: string\n): ParseResult {\n  const assetsMap = new Map<string, InsertDiscoveredAsset>();\n  const vulnerabilities: InsertVulnerabilityImport[] = [];\n  const errors: Array<{ line?: number; record?: string; error: string }> = [];\n  let successfulRecords = 0;\n  let failedRecords = 0;\n\n  // Simple XML parser for Nessus format\n  const hostRegex = /<ReportHost name=\"([^\"]+)\"[^>]*>([\\s\\S]*?)<\\/ReportHost>/g;\n  const itemRegex = /<ReportItem[^>]*>([\\s\\S]*?)<\\/ReportItem>/g;\n  const tagRegex = /<(\\w+)[^>]*>([^<]*)<\\/\\1>/g;\n  const attrRegex = /<ReportItem([^>]*)>/;\n\n  let hostMatch;\n  while ((hostMatch = hostRegex.exec(content)) !== null) {\n    const hostName = hostMatch[1];\n    const hostContent = hostMatch[2];\n    \n    // Extract host properties\n    const hostTags: Record<string, string> = {};\n    const hostPropsRegex = /<HostProperties>([\\s\\S]*?)<\\/HostProperties>/g;\n    let hostPropsMatch;\n    while ((hostPropsMatch = hostPropsRegex.exec(hostContent)) !== null) {\n      const tagRegexLocal = /<tag name=\"([^\"]+)\">([^<]*)<\\/tag>/g;\n      let tagMatch;\n      while ((tagMatch = tagRegexLocal.exec(hostPropsMatch[1])) !== null) {\n        hostTags[tagMatch[1]] = tagMatch[2];\n      }\n    }\n\n    const assetIdentifier = hostTags[\"host-ip\"] || hostName;\n    \n    // Create asset\n    if (!assetsMap.has(assetIdentifier)) {\n      assetsMap.set(assetIdentifier, {\n        assetIdentifier,\n        displayName: hostTags[\"host-fqdn\"] || hostTags[\"netbios-name\"] || hostName,\n        assetType: detectAssetType(hostTags[\"host-fqdn\"] || hostName, undefined, undefined),\n        ipAddresses: hostTags[\"host-ip\"] ? [hostTags[\"host-ip\"]] : [],\n        hostname: hostTags[\"netbios-name\"] || undefined,\n        fqdn: hostTags[\"host-fqdn\"] || undefined,\n        operatingSystem: hostTags[\"operating-system\"] || undefined,\n        macAddress: hostTags[\"mac-address\"] || undefined,\n        openPorts: [],\n        importJobId,\n        discoverySource: \"nessus\",\n      });\n    }\n\n    // Parse ReportItems (vulnerabilities)\n    let itemMatch;\n    const itemRegexLocal = /<ReportItem([^>]*)>([\\s\\S]*?)<\\/ReportItem>/g;\n    while ((itemMatch = itemRegexLocal.exec(hostContent)) !== null) {\n      try {\n        const attrs = itemMatch[1];\n        const itemContent = itemMatch[2];\n\n        // Parse attributes\n        const getAttr = (name: string): string | undefined => {\n          const match = new RegExp(`${name}=\"([^\"]+)\"`).exec(attrs);\n          return match ? match[1] : undefined;\n        };\n\n        // Parse child tags\n        const getTag = (name: string): string | undefined => {\n          const match = new RegExp(`<${name}[^>]*>([\\\\s\\\\S]*?)<\\\\/${name}>`).exec(itemContent);\n          return match ? match[1].trim() : undefined;\n        };\n\n        const port = parseInt(getAttr(\"port\") || \"0\");\n        const protocol = getAttr(\"protocol\") || \"tcp\";\n        const svcName = getAttr(\"svc_name\");\n        const pluginId = getAttr(\"pluginID\");\n        const pluginName = getAttr(\"pluginName\");\n        const severity = getAttr(\"severity\") || \"0\";\n\n        // Skip informational items if desired (severity 0)\n        const severityNum = parseInt(severity);\n\n        // Add port to asset\n        const asset = assetsMap.get(assetIdentifier);\n        if (asset && port > 0) {\n          const existingPorts = (asset.openPorts || []) as Array<{port: number; protocol: string; service?: string; version?: string}>;\n          if (!existingPorts.some(p => p.port === port && p.protocol === protocol)) {\n            existingPorts.push({ port, protocol, service: svcName });\n            asset.openPorts = existingPorts;\n          }\n        }\n\n        // Create vulnerability\n        if (pluginName && severityNum > 0) {\n          const cveRaw = getTag(\"cve\");\n          vulnerabilities.push({\n            importJobId,\n            title: pluginName,\n            description: getTag(\"synopsis\") || getTag(\"description\"),\n            severity: normalizeSeverity(severity),\n            cveId: cveRaw || undefined,\n            cvssScore: parseFloat(getTag(\"cvss3_base_score\") || getTag(\"cvss_base_score\") || \"0\") * 10 || undefined,\n            cvssVector: getTag(\"cvss3_vector\") || getTag(\"cvss_vector\") || undefined,\n            scannerPluginId: pluginId,\n            scannerName: \"nessus\",\n            affectedHost: assetIdentifier,\n            affectedPort: port > 0 ? port : undefined,\n            affectedService: svcName || undefined,\n            solution: getTag(\"solution\") || undefined,\n            exploitAvailable: getTag(\"exploit_available\") === \"true\",\n            patchAvailable: getTag(\"patch_publication_date\") ? true : undefined,\n            rawData: { pluginId, pluginName, host: hostName },\n          });\n        }\n\n        successfulRecords++;\n      } catch (err) {\n        errors.push({ record: hostName, error: String(err) });\n        failedRecords++;\n      }\n    }\n  }\n\n  return {\n    assets: Array.from(assetsMap.values()),\n    vulnerabilities,\n    errors,\n    totalRecords: successfulRecords + failedRecords,\n    successfulRecords,\n    failedRecords,\n  };\n}\n\n// Parse Qualys XML format\nexport function parseQualysXml(\n  content: string,\n  importJobId: string\n): ParseResult {\n  const assetsMap = new Map<string, InsertDiscoveredAsset>();\n  const vulnerabilities: InsertVulnerabilityImport[] = [];\n  const errors: Array<{ line?: number; record?: string; error: string }> = [];\n  let successfulRecords = 0;\n  let failedRecords = 0;\n\n  // Qualys format parser (simplified)\n  const hostRegex = /<HOST>([\\s\\S]*?)<\\/HOST>/g;\n  \n  const getTag = (content: string, name: string): string | undefined => {\n    const match = new RegExp(`<${name}[^>]*>([\\\\s\\\\S]*?)<\\\\/${name}>`).exec(content);\n    return match ? match[1].trim() : undefined;\n  };\n\n  let hostMatch;\n  while ((hostMatch = hostRegex.exec(content)) !== null) {\n    const hostContent = hostMatch[1];\n    \n    const ip = getTag(hostContent, \"IP\");\n    const dns = getTag(hostContent, \"DNS\");\n    const netbios = getTag(hostContent, \"NETBIOS\");\n    const os = getTag(hostContent, \"OPERATING_SYSTEM\");\n    \n    const assetIdentifier = ip || dns || netbios;\n    if (!assetIdentifier) continue;\n\n    // Create asset\n    if (!assetsMap.has(assetIdentifier)) {\n      assetsMap.set(assetIdentifier, {\n        assetIdentifier,\n        displayName: dns || netbios || ip,\n        assetType: detectAssetType(dns, undefined, undefined),\n        ipAddresses: ip ? [ip] : [],\n        hostname: netbios || undefined,\n        fqdn: dns || undefined,\n        operatingSystem: os || undefined,\n        openPorts: [],\n        importJobId,\n        discoverySource: \"qualys\",\n      });\n    }\n\n    // Parse vulnerabilities (VULN or DETECTION tags)\n    const vulnRegex = /<(?:VULN|DETECTION)[^>]*>([\\s\\S]*?)<\\/(?:VULN|DETECTION)>/g;\n    let vulnMatch;\n    while ((vulnMatch = vulnRegex.exec(hostContent)) !== null) {\n      try {\n        const vulnContent = vulnMatch[1];\n        \n        const qid = getTag(vulnContent, \"QID\");\n        const title = getTag(vulnContent, \"TITLE\") || getTag(vulnContent, \"VULN_TITLE\");\n        const severity = getTag(vulnContent, \"SEVERITY\");\n        const port = parseInt(getTag(vulnContent, \"PORT\") || \"0\");\n        const protocol = getTag(vulnContent, \"PROTOCOL\");\n        const cveList = getTag(vulnContent, \"CVE_LIST\") || getTag(vulnContent, \"CVE_ID\");\n\n        if (title || qid) {\n          vulnerabilities.push({\n            importJobId,\n            title: title || `Qualys QID ${qid}`,\n            description: getTag(vulnContent, \"DIAGNOSIS\") || getTag(vulnContent, \"CONSEQUENCE\"),\n            severity: normalizeSeverity(severity || \"3\"),\n            cveId: cveList?.split(\",\")[0]?.trim() || undefined,\n            scannerPluginId: qid,\n            scannerName: \"qualys\",\n            affectedHost: assetIdentifier,\n            affectedPort: port > 0 ? port : undefined,\n            solution: getTag(vulnContent, \"SOLUTION\"),\n            rawData: { qid, host: assetIdentifier },\n          });\n        }\n\n        successfulRecords++;\n      } catch (err) {\n        errors.push({ record: assetIdentifier, error: String(err) });\n        failedRecords++;\n      }\n    }\n  }\n\n  return {\n    assets: Array.from(assetsMap.values()),\n    vulnerabilities,\n    errors,\n    totalRecords: successfulRecords + failedRecords,\n    successfulRecords,\n    failedRecords,\n  };\n}\n\n// Auto-detect format and parse\nexport function autoParseFile(\n  content: string,\n  importJobId: string,\n  fileName?: string,\n  mimeType?: string\n): { result: ParseResult; detectedFormat: ScannerType } {\n  const lower = content.trim().toLowerCase();\n  const fileExt = fileName?.split(\".\").pop()?.toLowerCase();\n\n  // Check for Nessus XML\n  if (lower.includes(\"<nessusclientdata\") || lower.includes(\"<reporthost\") || fileExt === \"nessus\") {\n    return { result: parseNessusXml(content, importJobId), detectedFormat: \"nessus\" };\n  }\n\n  // Check for Qualys XML\n  if (lower.includes(\"<qualys\") || lower.includes(\"<host_list_output\") || (lower.includes(\"<host>\") && lower.includes(\"<qid>\"))) {\n    return { result: parseQualysXml(content, importJobId), detectedFormat: \"qualys\" };\n  }\n\n  // Check for JSON\n  if (lower.startsWith(\"{\") || lower.startsWith(\"[\")) {\n    return { result: parseJson(content, importJobId), detectedFormat: \"custom_json\" };\n  }\n\n  // Default to CSV\n  return { result: parseCsv(content, importJobId), detectedFormat: \"custom_csv\" };\n}\n","path":null,"size_bytes":23018,"size_tokens":null},"client/src/pages/Governance.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from \"@/components/ui/alert-dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { \n  Shield, \n  AlertTriangle, \n  Power, \n  History, \n  Target, \n  Plus, \n  Trash2,\n  Zap,\n  Lock,\n  CheckCircle2,\n  XCircle,\n  Clock,\n  Activity,\n  Gauge,\n  ShieldAlert,\n  ShieldCheck,\n  Play,\n  Loader2,\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { OrganizationGovernance, ScopeRule, AuthorizationLog } from \"@shared/schema\";\n\nconst ORG_ID = \"default\";\n\nconst executionModeConfig = {\n  safe: {\n    label: \"Safe Mode\",\n    description: \"Dry-run evaluations, no actual exploitation\",\n    icon: ShieldCheck,\n    color: \"text-emerald-400\",\n    bgColor: \"bg-emerald-500/10\",\n    borderColor: \"border-emerald-500/30\",\n  },\n  live: {\n    label: \"Live Mode\",\n    description: \"Real exploitation testing (requires authorization)\",\n    icon: AlertTriangle,\n    color: \"text-red-400\",\n    bgColor: \"bg-red-500/10\",\n    borderColor: \"border-red-500/30\",\n  },\n  simulation: {\n    label: \"Simulation Mode\",\n    description: \"AI vs AI attack simulations\",\n    icon: Play,\n    color: \"text-amber-400\",\n    bgColor: \"bg-amber-500/10\",\n    borderColor: \"border-amber-500/30\",\n  },\n};\n\nconst targetTypes = [\n  { value: \"ip\", label: \"IP Address\" },\n  { value: \"cidr\", label: \"CIDR Range\" },\n  { value: \"hostname\", label: \"Hostname\" },\n  { value: \"pattern\", label: \"Pattern (Regex)\" },\n];\n\nconst ruleTypes = [\n  { value: \"allow\", label: \"Allow\" },\n  { value: \"block\", label: \"Block\" },\n];\n\nconst actionTypes = [\n  { value: \"all\", label: \"All Actions\" },\n  { value: \"evaluation_started\", label: \"Evaluation Started\" },\n  { value: \"evaluation_completed\", label: \"Evaluation Completed\" },\n  { value: \"kill_switch_activated\", label: \"Kill Switch Activated\" },\n  { value: \"kill_switch_deactivated\", label: \"Kill Switch Deactivated\" },\n  { value: \"execution_mode_changed\", label: \"Mode Changed\" },\n  { value: \"scope_rule_modified\", label: \"Scope Rule Modified\" },\n  { value: \"rate_limit_exceeded\", label: \"Rate Limit Exceeded\" },\n  { value: \"unauthorized_target_blocked\", label: \"Unauthorized Blocked\" },\n  { value: \"live_execution_authorized\", label: \"Live Execution Authorized\" },\n  { value: \"batch_job_started\", label: \"Batch Job Started\" },\n  { value: \"simulation_run\", label: \"Simulation Run\" },\n];\n\nexport default function Governance() {\n  const { toast } = useToast();\n  const [isAddRuleOpen, setIsAddRuleOpen] = useState(false);\n  const [actionFilter, setActionFilter] = useState(\"all\");\n  const [logsLimit, setLogsLimit] = useState(25);\n  \n  const [newRule, setNewRule] = useState({\n    name: \"\",\n    ruleType: \"block\",\n    targetType: \"hostname\",\n    targetValue: \"\",\n  });\n\n  const { data: governance, isLoading: govLoading } = useQuery<OrganizationGovernance>({\n    queryKey: [\"/api/governance\", ORG_ID],\n  });\n\n  const { data: scopeRules = [], isLoading: rulesLoading } = useQuery<ScopeRule[]>({\n    queryKey: [\"/api/scope-rules\", ORG_ID],\n  });\n\n  const { data: authLogs = [], isLoading: logsLoading } = useQuery<AuthorizationLog[]>({\n    queryKey: [\"/api/authorization-logs\", ORG_ID],\n  });\n\n  const updateGovernanceMutation = useMutation({\n    mutationFn: async (updates: Partial<OrganizationGovernance>) => {\n      const response = await apiRequest(\"PATCH\", `/api/governance/${ORG_ID}`, updates);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/governance\", ORG_ID] });\n      toast({\n        title: \"Settings updated\",\n        description: \"Governance settings have been updated\",\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Update failed\",\n        description: String(error),\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const killSwitchMutation = useMutation({\n    mutationFn: async (activate: boolean) => {\n      const response = await apiRequest(\"POST\", `/api/governance/${ORG_ID}/kill-switch`, { \n        activate,\n        activatedBy: \"System Admin\"\n      });\n      return response.json();\n    },\n    onSuccess: (_, activate) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/governance\", ORG_ID] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/authorization-logs\", ORG_ID] });\n      toast({\n        title: activate ? \"Kill Switch Activated\" : \"Kill Switch Deactivated\",\n        description: activate ? \"All operations have been halted\" : \"Operations have resumed\",\n        variant: activate ? \"destructive\" : \"default\",\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Kill switch toggle failed\",\n        description: String(error),\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createRuleMutation = useMutation({\n    mutationFn: async (data: typeof newRule) => {\n      const response = await apiRequest(\"POST\", \"/api/scope-rules\", {\n        ...data,\n        organizationId: ORG_ID,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scope-rules\", ORG_ID] });\n      setIsAddRuleOpen(false);\n      setNewRule({ name: \"\", ruleType: \"block\", targetType: \"hostname\", targetValue: \"\" });\n      toast({\n        title: \"Rule created\",\n        description: \"Scope rule has been added\",\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Failed to create rule\",\n        description: String(error),\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteRuleMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/scope-rules/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scope-rules\", ORG_ID] });\n      toast({\n        title: \"Rule deleted\",\n        description: \"Scope rule has been removed\",\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Failed to delete rule\",\n        description: String(error),\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleModeChange = (mode: \"safe\" | \"live\" | \"simulation\") => {\n    updateGovernanceMutation.mutate({ executionMode: mode });\n  };\n\n  const handleCreateRule = () => {\n    if (!newRule.name || !newRule.targetValue) {\n      toast({\n        title: \"Validation error\",\n        description: \"Name and target value are required\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    createRuleMutation.mutate(newRule);\n  };\n\n  const filteredLogs = actionFilter === \"all\" \n    ? authLogs \n    : authLogs.filter(log => log.action === actionFilter);\n\n  const displayedLogs = filteredLogs.slice(0, logsLimit);\n\n  const currentMode = (governance?.executionMode as keyof typeof executionModeConfig) || \"safe\";\n  const modeConfig = executionModeConfig[currentMode];\n  const ModeIcon = modeConfig.icon;\n\n  const hourlyUsage = governance?.currentConcurrentEvaluations || 0;\n  const hourlyLimit = governance?.rateLimitPerHour || 100;\n  const dailyUsage = 0;\n  const dailyLimit = governance?.rateLimitPerDay || 1000;\n  const concurrentUsage = governance?.currentConcurrentEvaluations || 0;\n  const concurrentLimit = governance?.concurrentEvaluationsLimit || 5;\n\n  const getRiskBadge = (riskLevel: string | null) => {\n    const styles: Record<string, string> = {\n      critical: \"bg-red-500/10 text-red-400 border-red-500/30\",\n      high: \"bg-orange-500/10 text-orange-400 border-orange-500/30\",\n      medium: \"bg-amber-500/10 text-amber-400 border-amber-500/30\",\n      low: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\",\n    };\n    return styles[riskLevel || \"low\"] || styles.low;\n  };\n\n  if (govLoading) {\n    return (\n      <div className=\"space-y-6\" data-testid=\"governance-loading\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 w-64 bg-muted rounded\" />\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            {[1, 2, 3, 4].map(i => (\n              <div key={i} className=\"h-40 bg-muted rounded-lg\" />\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"governance-page\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-foreground\" data-testid=\"text-governance-title\">\n          Governance & Safety Controls\n        </h1>\n        <p className=\"text-sm text-muted-foreground mt-1\">\n          Configure execution modes, rate limits, scope rules, and audit red-team activities\n        </p>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card data-testid=\"card-execution-mode\">\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-center gap-2\">\n              <Shield className=\"h-5 w-5 text-cyan-400\" />\n              <CardTitle className=\"text-lg\">Execution Mode</CardTitle>\n            </div>\n            <CardDescription>Control how evaluations are performed</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className={`p-4 rounded-lg border ${modeConfig.bgColor} ${modeConfig.borderColor}`}>\n              <div className=\"flex items-center gap-3\">\n                <ModeIcon className={`h-8 w-8 ${modeConfig.color}`} />\n                <div>\n                  <div className={`font-semibold ${modeConfig.color}`} data-testid=\"text-current-mode\">\n                    {modeConfig.label}\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\">{modeConfig.description}</div>\n                </div>\n              </div>\n            </div>\n\n            <Tabs value={currentMode} onValueChange={(v) => handleModeChange(v as \"safe\" | \"live\" | \"simulation\")}>\n              <TabsList className=\"grid w-full grid-cols-3\">\n                <TabsTrigger value=\"safe\" data-testid=\"tab-safe-mode\">\n                  <ShieldCheck className=\"w-4 h-4 mr-1\" />\n                  Safe\n                </TabsTrigger>\n                <TabsTrigger value=\"simulation\" data-testid=\"tab-simulation-mode\">\n                  <Play className=\"w-4 h-4 mr-1\" />\n                  Simulation\n                </TabsTrigger>\n                <TabsTrigger value=\"live\" data-testid=\"tab-live-mode\">\n                  <AlertTriangle className=\"w-4 h-4 mr-1\" />\n                  Live\n                </TabsTrigger>\n              </TabsList>\n            </Tabs>\n\n            {currentMode === \"live\" && (\n              <div className=\"p-3 rounded-lg bg-red-500/10 border border-red-500/30 text-sm text-red-300\">\n                <AlertTriangle className=\"w-4 h-4 inline mr-2\" />\n                Live mode executes actual exploitation attempts. Ensure proper authorization is in place.\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-kill-switch\">\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-center gap-2\">\n              <Power className=\"h-5 w-5 text-red-400\" />\n              <CardTitle className=\"text-lg\">Emergency Kill Switch</CardTitle>\n            </div>\n            <CardDescription>Immediately halt all evaluation operations</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className={`p-4 rounded-lg border ${\n              governance?.killSwitchActive \n                ? \"bg-red-500/10 border-red-500/30\" \n                : \"bg-emerald-500/10 border-emerald-500/30\"\n            }`}>\n              <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                <div className=\"flex items-center gap-3\">\n                  {governance?.killSwitchActive ? (\n                    <ShieldAlert className=\"h-8 w-8 text-red-400\" />\n                  ) : (\n                    <ShieldCheck className=\"h-8 w-8 text-emerald-400\" />\n                  )}\n                  <div>\n                    <div className={`font-semibold ${governance?.killSwitchActive ? \"text-red-400\" : \"text-emerald-400\"}`} data-testid=\"text-kill-switch-status\">\n                      {governance?.killSwitchActive ? \"Kill Switch ACTIVE\" : \"Operations Normal\"}\n                    </div>\n                    {governance?.killSwitchActive && governance.killSwitchActivatedBy && (\n                      <div className=\"text-xs text-muted-foreground\">\n                        Activated by {governance.killSwitchActivatedBy} at {governance.killSwitchActivatedAt ? format(new Date(governance.killSwitchActivatedAt), \"PPpp\") : \"Unknown\"}\n                      </div>\n                    )}\n                  </div>\n                </div>\n                \n                {governance?.killSwitchActive ? (\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => killSwitchMutation.mutate(false)}\n                    disabled={killSwitchMutation.isPending}\n                    data-testid=\"btn-deactivate-kill-switch\"\n                  >\n                    {killSwitchMutation.isPending && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\n                    Deactivate\n                  </Button>\n                ) : (\n                  <AlertDialog>\n                    <AlertDialogTrigger asChild>\n                      <Button variant=\"destructive\" data-testid=\"btn-activate-kill-switch\">\n                        <Power className=\"w-4 h-4 mr-2\" />\n                        Activate Kill Switch\n                      </Button>\n                    </AlertDialogTrigger>\n                    <AlertDialogContent>\n                      <AlertDialogHeader>\n                        <AlertDialogTitle>Activate Emergency Kill Switch?</AlertDialogTitle>\n                        <AlertDialogDescription>\n                          This will immediately halt all ongoing and queued evaluations. \n                          All in-progress operations will be terminated. This action is logged for audit purposes.\n                        </AlertDialogDescription>\n                      </AlertDialogHeader>\n                      <AlertDialogFooter>\n                        <AlertDialogCancel>Cancel</AlertDialogCancel>\n                        <AlertDialogAction\n                          onClick={() => killSwitchMutation.mutate(true)}\n                          className=\"bg-red-600 text-white\"\n                          data-testid=\"btn-confirm-kill-switch\"\n                        >\n                          Activate Kill Switch\n                        </AlertDialogAction>\n                      </AlertDialogFooter>\n                    </AlertDialogContent>\n                  </AlertDialog>\n                )}\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\">\n                <div className=\"text-sm text-muted-foreground\">Auto-kill on Critical</div>\n                <Switch\n                  checked={governance?.autoKillOnCritical ?? true}\n                  onCheckedChange={(checked) => updateGovernanceMutation.mutate({ autoKillOnCritical: checked })}\n                  data-testid=\"switch-auto-kill\"\n                />\n              </div>\n              <div className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\">\n                <div className=\"text-sm text-muted-foreground\">Require Live Auth</div>\n                <Switch\n                  checked={governance?.requireAuthorizationForLive ?? true}\n                  onCheckedChange={(checked) => updateGovernanceMutation.mutate({ requireAuthorizationForLive: checked })}\n                  data-testid=\"switch-require-live-auth\"\n                />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-rate-limits\">\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-center gap-2\">\n              <Gauge className=\"h-5 w-5 text-amber-400\" />\n              <CardTitle className=\"text-lg\">Rate Limits</CardTitle>\n            </div>\n            <CardDescription>Current usage and configured limits</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-3\">\n              <div>\n                <div className=\"flex items-center justify-between text-sm mb-1\">\n                  <span className=\"text-muted-foreground\">Per Hour</span>\n                  <span className=\"font-mono\" data-testid=\"text-hourly-limit\">{hourlyUsage} / {hourlyLimit}</span>\n                </div>\n                <Progress value={(hourlyUsage / hourlyLimit) * 100} className=\"h-2\" />\n              </div>\n\n              <div>\n                <div className=\"flex items-center justify-between text-sm mb-1\">\n                  <span className=\"text-muted-foreground\">Per Day</span>\n                  <span className=\"font-mono\" data-testid=\"text-daily-limit\">{dailyUsage} / {dailyLimit}</span>\n                </div>\n                <Progress value={(dailyUsage / dailyLimit) * 100} className=\"h-2\" />\n              </div>\n\n              <div>\n                <div className=\"flex items-center justify-between text-sm mb-1\">\n                  <span className=\"text-muted-foreground\">Concurrent Evaluations</span>\n                  <span className=\"font-mono\" data-testid=\"text-concurrent-limit\">{concurrentUsage} / {concurrentLimit}</span>\n                </div>\n                <Progress value={(concurrentUsage / concurrentLimit) * 100} className=\"h-2\" />\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-3 gap-3 pt-2\">\n              <div className=\"p-3 rounded-lg bg-muted/50 text-center\">\n                <div className=\"text-xl font-bold text-foreground\">{hourlyLimit}</div>\n                <div className=\"text-xs text-muted-foreground\">Hourly Limit</div>\n              </div>\n              <div className=\"p-3 rounded-lg bg-muted/50 text-center\">\n                <div className=\"text-xl font-bold text-foreground\">{dailyLimit}</div>\n                <div className=\"text-xs text-muted-foreground\">Daily Limit</div>\n              </div>\n              <div className=\"p-3 rounded-lg bg-muted/50 text-center\">\n                <div className=\"text-xl font-bold text-foreground\">{concurrentLimit}</div>\n                <div className=\"text-xs text-muted-foreground\">Concurrent</div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-scope-rules\">\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <div className=\"flex items-center gap-2\">\n                <Target className=\"h-5 w-5 text-cyan-400\" />\n                <CardTitle className=\"text-lg\">Scope Rules</CardTitle>\n              </div>\n              <Dialog open={isAddRuleOpen} onOpenChange={setIsAddRuleOpen}>\n                <DialogTrigger asChild>\n                  <Button size=\"sm\" data-testid=\"btn-add-rule\">\n                    <Plus className=\"w-4 h-4 mr-1\" />\n                    Add Rule\n                  </Button>\n                </DialogTrigger>\n                <DialogContent>\n                  <DialogHeader>\n                    <DialogTitle>Add Scope Rule</DialogTitle>\n                    <DialogDescription>Define allowed or blocked target patterns</DialogDescription>\n                  </DialogHeader>\n                  <div className=\"space-y-4 py-4\">\n                    <div className=\"space-y-2\">\n                      <Label>Rule Name</Label>\n                      <Input\n                        value={newRule.name}\n                        onChange={(e) => setNewRule({ ...newRule, name: e.target.value })}\n                        placeholder=\"e.g., Block Production Servers\"\n                        data-testid=\"input-rule-name\"\n                      />\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label>Rule Type</Label>\n                        <Select\n                          value={newRule.ruleType}\n                          onValueChange={(v) => setNewRule({ ...newRule, ruleType: v })}\n                        >\n                          <SelectTrigger data-testid=\"select-rule-type\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {ruleTypes.map((rt) => (\n                              <SelectItem key={rt.value} value={rt.value}>{rt.label}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label>Target Type</Label>\n                        <Select\n                          value={newRule.targetType}\n                          onValueChange={(v) => setNewRule({ ...newRule, targetType: v })}\n                        >\n                          <SelectTrigger data-testid=\"select-target-type\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {targetTypes.map((tt) => (\n                              <SelectItem key={tt.value} value={tt.value}>{tt.label}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label>Target Value</Label>\n                      <Input\n                        value={newRule.targetValue}\n                        onChange={(e) => setNewRule({ ...newRule, targetValue: e.target.value })}\n                        placeholder=\"e.g., *.production.example.com\"\n                        data-testid=\"input-target-value\"\n                      />\n                    </div>\n                  </div>\n                  <DialogFooter>\n                    <Button variant=\"outline\" onClick={() => setIsAddRuleOpen(false)}>\n                      Cancel\n                    </Button>\n                    <Button \n                      onClick={handleCreateRule}\n                      disabled={createRuleMutation.isPending}\n                      data-testid=\"btn-save-rule\"\n                    >\n                      {createRuleMutation.isPending && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\n                      Save Rule\n                    </Button>\n                  </DialogFooter>\n                </DialogContent>\n              </Dialog>\n            </div>\n            <CardDescription>Allow/block patterns for target assets</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {rulesLoading ? (\n              <div className=\"text-center py-6 text-muted-foreground\">Loading rules...</div>\n            ) : scopeRules.length === 0 ? (\n              <div className=\"text-center py-6\">\n                <Target className=\"h-10 w-10 mx-auto mb-2 text-muted-foreground opacity-30\" />\n                <p className=\"text-muted-foreground text-sm\">No scope rules defined</p>\n                <p className=\"text-muted-foreground text-xs\">Add rules to control target access</p>\n              </div>\n            ) : (\n              <div className=\"max-h-48 overflow-y-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Name</TableHead>\n                      <TableHead>Type</TableHead>\n                      <TableHead>Target</TableHead>\n                      <TableHead></TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {scopeRules.map((rule) => (\n                      <TableRow key={rule.id} data-testid={`row-rule-${rule.id}`}>\n                        <TableCell className=\"font-medium\">{rule.name}</TableCell>\n                        <TableCell>\n                          <Badge className={rule.ruleType === \"allow\" ? \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\" : \"bg-red-500/10 text-red-400 border-red-500/30\"}>\n                            {rule.ruleType.toUpperCase()}\n                          </Badge>\n                        </TableCell>\n                        <TableCell className=\"font-mono text-xs max-w-[200px] truncate\" title={rule.targetValue}>\n                          {rule.targetValue}\n                        </TableCell>\n                        <TableCell>\n                          <Button\n                            size=\"icon\"\n                            variant=\"ghost\"\n                            onClick={() => deleteRuleMutation.mutate(rule.id)}\n                            disabled={deleteRuleMutation.isPending}\n                            data-testid={`btn-delete-rule-${rule.id}`}\n                          >\n                            <Trash2 className=\"w-4 h-4 text-muted-foreground\" />\n                          </Button>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card data-testid=\"card-authorization-logs\">\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n            <div className=\"flex items-center gap-2\">\n              <History className=\"h-5 w-5 text-cyan-400\" />\n              <CardTitle className=\"text-lg\">Authorization Logs</CardTitle>\n            </div>\n            <Select value={actionFilter} onValueChange={setActionFilter}>\n              <SelectTrigger className=\"w-[200px]\" data-testid=\"select-action-filter\">\n                <SelectValue placeholder=\"Filter by action\" />\n              </SelectTrigger>\n              <SelectContent>\n                {actionTypes.map((at) => (\n                  <SelectItem key={at.value} value={at.value}>{at.label}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n          <CardDescription>Audit trail of red-team activities and authorization events</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {logsLoading ? (\n            <div className=\"text-center py-6 text-muted-foreground\">Loading logs...</div>\n          ) : authLogs.length === 0 ? (\n            <div className=\"text-center py-6\">\n              <History className=\"h-10 w-10 mx-auto mb-2 text-muted-foreground opacity-30\" />\n              <p className=\"text-muted-foreground text-sm\">No authorization logs yet</p>\n              <p className=\"text-muted-foreground text-xs\">Activity will appear here as evaluations run</p>\n            </div>\n          ) : (\n            <>\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Timestamp</TableHead>\n                      <TableHead>Action</TableHead>\n                      <TableHead>User</TableHead>\n                      <TableHead>Target</TableHead>\n                      <TableHead>Risk Level</TableHead>\n                      <TableHead>Authorized</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {displayedLogs.map((log) => (\n                      <TableRow key={log.id} data-testid={`row-log-${log.id}`}>\n                        <TableCell className=\"font-mono text-xs whitespace-nowrap\">\n                          {log.createdAt ? format(new Date(log.createdAt), \"MMM d, HH:mm:ss\") : \"N/A\"}\n                        </TableCell>\n                        <TableCell>\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            {log.action?.replace(/_/g, \" \").toUpperCase()}\n                          </Badge>\n                        </TableCell>\n                        <TableCell className=\"text-sm\">\n                          {log.userName || log.userId || \"System\"}\n                        </TableCell>\n                        <TableCell className=\"font-mono text-xs max-w-[150px] truncate\" title={log.targetAsset || \"\"}>\n                          {log.targetAsset || \"-\"}\n                        </TableCell>\n                        <TableCell>\n                          {log.riskLevel && (\n                            <Badge className={getRiskBadge(log.riskLevel)}>\n                              {log.riskLevel.toUpperCase()}\n                            </Badge>\n                          )}\n                        </TableCell>\n                        <TableCell>\n                          {log.authorized ? (\n                            <CheckCircle2 className=\"w-5 h-5 text-emerald-400\" />\n                          ) : (\n                            <XCircle className=\"w-5 h-5 text-red-400\" />\n                          )}\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </div>\n              \n              {filteredLogs.length > logsLimit && (\n                <div className=\"flex justify-center mt-4\">\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setLogsLimit(prev => prev + 25)}\n                    data-testid=\"btn-load-more-logs\"\n                  >\n                    Load More ({filteredLogs.length - logsLimit} remaining)\n                  </Button>\n                </div>\n              )}\n            </>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":30865,"size_tokens":null},"client/src/pages/BatchJobs.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { \n  Layers, \n  Plus, \n  Trash2, \n  Loader2, \n  CheckCircle2, \n  XCircle, \n  Clock,\n  Server,\n  AlertTriangle,\n  Play,\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { BatchJob } from \"@shared/schema\";\n\nconst exposureTypes = [\n  { value: \"cve\", label: \"CVE Vulnerability\" },\n  { value: \"misconfiguration\", label: \"Misconfiguration\" },\n  { value: \"behavioral_anomaly\", label: \"Behavioral Anomaly\" },\n  { value: \"network_vulnerability\", label: \"Network Vulnerability\" },\n  { value: \"cloud_misconfiguration\", label: \"Cloud Misconfiguration\" },\n  { value: \"iam_abuse\", label: \"IAM Abuse\" },\n  { value: \"saas_permission\", label: \"SaaS Permission Abuse\" },\n  { value: \"api_sequence_abuse\", label: \"API Sequence Abuse\" },\n  { value: \"payment_flow\", label: \"Payment Flow\" },\n  { value: \"subscription_bypass\", label: \"Subscription Bypass\" },\n  { value: \"state_machine\", label: \"State Machine Violation\" },\n];\n\nconst priorities = [\n  { value: \"critical\", label: \"Critical\" },\n  { value: \"high\", label: \"High\" },\n  { value: \"medium\", label: \"Medium\" },\n  { value: \"low\", label: \"Low\" },\n];\n\ninterface AssetConfig {\n  assetId: string;\n  exposureType: string;\n  priority: string;\n  description: string;\n}\n\nexport default function BatchJobs() {\n  const { toast } = useToast();\n  const [isCreateOpen, setIsCreateOpen] = useState(false);\n  const [jobName, setJobName] = useState(\"\");\n  const [jobDescription, setJobDescription] = useState(\"\");\n  const [assets, setAssets] = useState<AssetConfig[]>([\n    { assetId: \"\", exposureType: \"cve\", priority: \"medium\", description: \"\" }\n  ]);\n\n  const { data: jobs = [], isLoading } = useQuery<BatchJob[]>({\n    queryKey: [\"/api/batch-jobs\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const response = await apiRequest(\"POST\", \"/api/batch-jobs\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/batch-jobs\"] });\n      setIsCreateOpen(false);\n      setJobName(\"\");\n      setJobDescription(\"\");\n      setAssets([{ assetId: \"\", exposureType: \"cve\", priority: \"medium\", description: \"\" }]);\n      toast({\n        title: \"Batch job started\",\n        description: \"Your batch evaluation has been queued\",\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Failed to create batch job\",\n        description: String(error),\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/batch-jobs/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/batch-jobs\"] });\n      toast({\n        title: \"Batch job deleted\",\n        description: \"Batch job has been removed\",\n      });\n    },\n  });\n\n  const cancelMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"PATCH\", `/api/batch-jobs/${id}`, { status: \"failed\" });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/batch-jobs\"] });\n      toast({\n        title: \"Batch job stopped\",\n        description: \"Batch job has been cancelled\",\n      });\n    },\n  });\n\n  const addAsset = () => {\n    setAssets([...assets, { assetId: \"\", exposureType: \"cve\", priority: \"medium\", description: \"\" }]);\n  };\n\n  const removeAsset = (index: number) => {\n    if (assets.length > 1) {\n      setAssets(assets.filter((_, i) => i !== index));\n    }\n  };\n\n  const updateAsset = (index: number, field: keyof AssetConfig, value: string) => {\n    const newAssets = [...assets];\n    newAssets[index] = { ...newAssets[index], [field]: value };\n    setAssets(newAssets);\n  };\n\n  const handleCreate = () => {\n    const validAssets = assets.filter(a => a.assetId && a.description);\n    if (!jobName || validAssets.length === 0) {\n      toast({\n        title: \"Validation error\",\n        description: \"Please provide a job name and at least one valid asset configuration\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    createMutation.mutate({\n      name: jobName,\n      description: jobDescription,\n      assets: validAssets,\n    });\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"completed\":\n        return <Badge variant=\"default\" className=\"bg-green-500/20 text-green-400 border-green-500/30\"><CheckCircle2 className=\"w-3 h-3 mr-1\" />Completed</Badge>;\n      case \"running\":\n        return <Badge variant=\"secondary\" className=\"bg-blue-500/20 text-blue-400 border-blue-500/30\"><Loader2 className=\"w-3 h-3 mr-1 animate-spin\" />Running</Badge>;\n      case \"pending\":\n        return <Badge variant=\"outline\"><Clock className=\"w-3 h-3 mr-1\" />Pending</Badge>;\n      case \"failed\":\n        return <Badge variant=\"destructive\"><XCircle className=\"w-3 h-3 mr-1\" />Failed</Badge>;\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-batch-title\">Batch Evaluations</h1>\n          <p className=\"text-muted-foreground\">Run multiple security assessments in parallel</p>\n        </div>\n        <Dialog open={isCreateOpen} onOpenChange={setIsCreateOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"btn-create-batch\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              New Batch Job\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-3xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Create Batch Evaluation</DialogTitle>\n              <DialogDescription>Configure multiple assets for parallel security assessment</DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Job Name</Label>\n                  <Input\n                    value={jobName}\n                    onChange={(e) => setJobName(e.target.value)}\n                    placeholder=\"Weekly infrastructure scan\"\n                    data-testid=\"input-job-name\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Description (Optional)</Label>\n                  <Input\n                    value={jobDescription}\n                    onChange={(e) => setJobDescription(e.target.value)}\n                    placeholder=\"Regular security assessment\"\n                    data-testid=\"input-job-description\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <Label>Assets to Evaluate</Label>\n                  <Button variant=\"outline\" size=\"sm\" onClick={addAsset} data-testid=\"btn-add-asset\">\n                    <Plus className=\"w-3 h-3 mr-1\" />\n                    Add Asset\n                  </Button>\n                </div>\n                \n                {assets.map((asset, index) => (\n                  <Card key={index} className=\"relative\" data-testid={`card-asset-${index}`}>\n                    <CardContent className=\"p-4 space-y-3\">\n                      <div className=\"flex items-center justify-between\">\n                        <span className=\"text-sm font-medium\">Asset {index + 1}</span>\n                        {assets.length > 1 && (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => removeAsset(index)}\n                            data-testid={`btn-remove-asset-${index}`}\n                          >\n                            <Trash2 className=\"w-4 h-4\" />\n                          </Button>\n                        )}\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-3\">\n                        <div className=\"space-y-1\">\n                          <Label className=\"text-xs\">Asset ID</Label>\n                          <Input\n                            value={asset.assetId}\n                            onChange={(e) => updateAsset(index, \"assetId\", e.target.value)}\n                            placeholder=\"server-001, api.example.com\"\n                            data-testid={`input-asset-id-${index}`}\n                          />\n                        </div>\n                        <div className=\"space-y-1\">\n                          <Label className=\"text-xs\">Exposure Type</Label>\n                          <Select \n                            value={asset.exposureType} \n                            onValueChange={(v) => updateAsset(index, \"exposureType\", v)}\n                          >\n                            <SelectTrigger data-testid={`select-exposure-${index}`}>\n                              <SelectValue />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {exposureTypes.map((et) => (\n                                <SelectItem key={et.value} value={et.value}>{et.label}</SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n                        <div className=\"space-y-1\">\n                          <Label className=\"text-xs\">Priority</Label>\n                          <Select \n                            value={asset.priority} \n                            onValueChange={(v) => updateAsset(index, \"priority\", v)}\n                          >\n                            <SelectTrigger data-testid={`select-priority-${index}`}>\n                              <SelectValue />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {priorities.map((p) => (\n                                <SelectItem key={p.value} value={p.value}>{p.label}</SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n                        <div className=\"space-y-1\">\n                          <Label className=\"text-xs\">Description</Label>\n                          <Input\n                            value={asset.description}\n                            onChange={(e) => updateAsset(index, \"description\", e.target.value)}\n                            placeholder=\"Brief description...\"\n                            data-testid={`input-asset-desc-${index}`}\n                          />\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setIsCreateOpen(false)}>Cancel</Button>\n              <Button \n                onClick={handleCreate} \n                disabled={createMutation.isPending}\n                data-testid=\"btn-confirm-create\"\n              >\n                {createMutation.isPending && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\n                <Play className=\"w-4 h-4 mr-2\" />\n                Start Batch Job\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {isLoading ? (\n        <Card>\n          <CardContent className=\"flex items-center justify-center py-8\">\n            <Loader2 className=\"w-6 h-6 animate-spin text-muted-foreground\" />\n          </CardContent>\n        </Card>\n      ) : jobs.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12 text-center\">\n            <Layers className=\"w-12 h-12 text-muted-foreground mb-4\" />\n            <h3 className=\"font-medium mb-2\">No batch jobs yet</h3>\n            <p className=\"text-muted-foreground text-sm mb-4\">\n              Create a batch job to evaluate multiple assets in parallel\n            </p>\n            <Button onClick={() => setIsCreateOpen(true)} data-testid=\"btn-create-first\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Create Batch Job\n            </Button>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4\">\n          {jobs.map((job) => (\n            <Card key={job.id} data-testid={`card-batch-${job.id}`}>\n              <CardContent className=\"p-4\">\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"p-2 bg-primary/10 rounded-md\">\n                        <Server className=\"w-4 h-4\" />\n                      </div>\n                      <div>\n                        <h3 className=\"font-medium\">{job.name}</h3>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {job.description || `${job.totalEvaluations} asset${job.totalEvaluations !== 1 ? \"s\" : \"\"} queued`}\n                        </p>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      {getStatusBadge(job.status)}\n                      {job.status === \"running\" && (\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => cancelMutation.mutate(job.id)}\n                          disabled={cancelMutation.isPending}\n                          data-testid={`btn-cancel-batch-${job.id}`}\n                        >\n                          <XCircle className=\"w-3 h-3 mr-1\" />\n                          Stop\n                        </Button>\n                      )}\n                      <Button\n                        size=\"icon\"\n                        variant=\"ghost\"\n                        onClick={() => deleteMutation.mutate(job.id)}\n                        disabled={deleteMutation.isPending}\n                        data-testid={`btn-delete-batch-${job.id}`}\n                      >\n                        <Trash2 className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                  \n                  {(job.status === \"running\" || job.status === \"completed\") && (\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center justify-between text-sm\">\n                        <span className=\"text-muted-foreground\">Progress</span>\n                        <span>\n                          {job.completedEvaluations || 0} / {job.totalEvaluations} completed\n                          {(job.failedEvaluations ?? 0) > 0 && (\n                            <span className=\"text-destructive ml-2\">\n                              ({job.failedEvaluations} failed)\n                            </span>\n                          )}\n                        </span>\n                      </div>\n                      <Progress value={job.progress || 0} className=\"h-2\" />\n                    </div>\n                  )}\n                  \n                  <div className=\"flex items-center gap-4 text-xs text-muted-foreground\">\n                    <span>Created: {job.createdAt ? format(new Date(job.createdAt), \"MMM d, yyyy HH:mm\") : \"Unknown\"}</span>\n                    {job.completedAt && (\n                      <span>Completed: {format(new Date(job.completedAt), \"MMM d, yyyy HH:mm\")}</span>\n                    )}\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":16770,"size_tokens":null},"server/services/report-generator.ts":{"content":"import { storage } from \"../storage\";\nimport OpenAI from \"openai\";\nimport type { \n  ExecutiveSummary, \n  TechnicalReport, \n  ComplianceReport,\n  ReportFinding,\n  AttackPathStep,\n  ComplianceFramework,\n  ReportType,\n  ExposureType,\n} from \"@shared/schema\";\nimport {\n  getVulnerabilityInfo,\n  getRemediationGuidance,\n  formatVulnerabilityName,\n  formatVulnerabilityShortName,\n  type VulnerabilityInfo,\n  type RemediationGuidance,\n} from \"@shared/vulnerability-catalog\";\nimport {\n  buildKillChainVisualization,\n  generateKillChainReportSection,\n  generateTextualKillChainDiagram,\n  generatePdfKillChainContent,\n  type KillChainReportSection,\n} from \"./kill-chain-graph\";\nimport {\n  computeExecutiveSummary,\n  computeTechnicalReport,\n  computeComplianceReport,\n  formatRemediationSection,\n  type EvaluationData,\n  type ResultData,\n  type ComputedExecutiveSummary,\n  type ComputedTechnicalReport,\n} from \"./report-logic\";\n\n// Create OpenAI client lazily to handle missing API key gracefully\nlet openaiClient: OpenAI | null = null;\n\nfunction getOpenAIClient(): OpenAI | null {\n  if (openaiClient) return openaiClient;\n  \n  const apiKey = process.env.AI_INTEGRATIONS_OPENAI_API_KEY;\n  if (!apiKey) {\n    console.warn(\"OpenAI API key not configured - reports will use templated narratives\");\n    return null;\n  }\n  \n  openaiClient = new OpenAI({\n    apiKey,\n    baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n  });\n  \n  return openaiClient;\n}\n\ninterface AIResponse {\n  executiveSummary: string;\n  findings: Array<{title: string; description: string; recommendation: string}>;\n  recommendations: string[];\n}\n\nexport class ReportGenerator {\n  \n  private generateTemplatedNarrative(\n    reportType: \"executive\" | \"technical\" | \"compliance\",\n    data: any\n  ): AIResponse {\n    const templates = {\n      executive: {\n        executiveSummary: `During the assessment period, ${data.metrics?.totalEvaluations || 0} security evaluations were conducted. ${data.metrics?.exploitableFindings || 0} exploitable vulnerabilities were identified, with ${data.metrics?.criticalFindings || 0} classified as critical. The overall risk level is ${data.overallRiskLevel?.toUpperCase() || \"UNKNOWN\"}. Immediate action is recommended for critical findings to prevent potential security incidents and business impact.`,\n        findings: (data.topRisks || []).slice(0, 5).map((r: any) => ({\n          title: `Security Issue: ${r.assetId || \"Unknown Asset\"}`,\n          description: r.riskDescription || \"Security vulnerability requiring attention\",\n          recommendation: \"Remediate according to priority and business impact assessment\"\n        })),\n        recommendations: [\n          \"Address critical vulnerabilities within 24-48 hours\",\n          \"Implement compensating controls for high-risk findings\",\n          \"Schedule regular security assessments to maintain posture\"\n        ]\n      },\n      technical: {\n        executiveSummary: `Technical security assessment identified ${data.findingsCount || 0} findings across the evaluated assets. ${data.attackPathsCount || 0} exploitable attack paths were documented. Vulnerability distribution shows ${JSON.stringify(data.vulnerabilityBreakdown?.bySeverity || {})}. Technical remediation guidance is provided for each finding.`,\n        findings: (data.topFindings || []).slice(0, 5).map((f: any) => ({\n          title: f.title || \"Technical Finding\",\n          description: f.description || \"Technical vulnerability requiring remediation\",\n          recommendation: f.recommendation || \"Apply vendor patches and configuration hardening\"\n        })),\n        recommendations: [\n          \"Apply security patches to affected systems\",\n          \"Implement network segmentation to limit lateral movement\",\n          \"Enable enhanced logging and monitoring for affected assets\"\n        ]\n      },\n      compliance: {\n        executiveSummary: `Compliance assessment against ${data.framework?.toUpperCase() || \"framework\"} shows ${data.overallCompliance || 0}% overall compliance. ${data.gaps?.length || 0} control gaps were identified requiring remediation. Audit readiness score is ${data.auditReadiness?.score || 0}%. Priority actions should focus on addressing control gaps to improve compliance posture.`,\n        findings: (data.gaps || []).slice(0, 5).map((g: any) => ({\n          title: `Control Gap: ${g.controlId || \"Unknown Control\"}`,\n          description: g.gapDescription || \"Compliance control gap requiring attention\",\n          recommendation: g.remediationGuidance || \"Implement required controls to achieve compliance\"\n        })),\n        recommendations: [\n          \"Prioritize remediation of non-compliant controls\",\n          \"Document compensating controls for gaps that cannot be immediately addressed\",\n          \"Schedule follow-up assessment to verify remediation effectiveness\"\n        ]\n      }\n    };\n    \n    return templates[reportType];\n  }\n  \n  private async generateAINarrative(\n    reportType: \"executive\" | \"technical\" | \"compliance\",\n    data: any\n  ): Promise<AIResponse> {\n    const client = getOpenAIClient();\n    \n    // Fall back to templated narratives if OpenAI is not available\n    if (!client) {\n      return this.generateTemplatedNarrative(reportType, data);\n    }\n    \n    try {\n      const prompts = {\n        executive: `You are a cybersecurity executive advisor writing a security report for C-suite executives and board members.\n\nBased on the following security assessment data, write a comprehensive executive summary in natural language:\n\n${JSON.stringify(data, null, 2)}\n\nProvide your response as JSON with this exact structure (no additional fields):\n{\n  \"executiveSummary\": \"A 2-3 paragraph executive summary written in clear, non-technical language suitable for executives. Include overall risk posture, key concerns, and strategic recommendations.\",\n  \"findings\": [\n    {\"title\": \"Finding title\", \"description\": \"Clear description of the security issue and its business impact\", \"recommendation\": \"Recommended action to address this\"}\n  ],\n  \"recommendations\": [\"Strategic recommendation 1\", \"Strategic recommendation 2\", \"Strategic recommendation 3\"]\n}\n\nFocus on business impact, financial risk, and strategic priorities. Avoid technical jargon. Limit findings to maximum 5 items.`,\n\n        technical: `You are a senior security engineer writing a technical security report.\n\nBased on the following security assessment data, write detailed technical findings:\n\n${JSON.stringify(data, null, 2)}\n\nProvide your response as JSON with this exact structure (no additional fields):\n{\n  \"executiveSummary\": \"A technical summary of the security assessment covering methodology, scope, and key technical findings.\",\n  \"findings\": [\n    {\"title\": \"Technical finding title\", \"description\": \"Detailed technical description including attack vectors, CVE references, and exploitation details\", \"recommendation\": \"Specific technical remediation steps\"}\n  ],\n  \"recommendations\": [\"Technical recommendation 1\", \"Technical recommendation 2\", \"Technical recommendation 3\"]\n}\n\nInclude specific technical details, attack paths, and concrete remediation steps. Limit findings to maximum 10 items.`,\n\n        compliance: `You are a compliance and audit specialist writing a compliance assessment report.\n\nBased on the following compliance assessment data, write a compliance-focused report:\n\n${JSON.stringify(data, null, 2)}\n\nProvide your response as JSON with this exact structure (no additional fields):\n{\n  \"executiveSummary\": \"A compliance summary covering audit readiness, control gaps, and remediation priorities for the specified framework.\",\n  \"findings\": [\n    {\"title\": \"Compliance gap title\", \"description\": \"Description of the control gap and its compliance implications\", \"recommendation\": \"Steps to achieve compliance\"}\n  ],\n  \"recommendations\": [\"Compliance recommendation 1\", \"Compliance recommendation 2\", \"Compliance recommendation 3\"]\n}\n\nFocus on regulatory requirements, control effectiveness, and audit readiness. Limit findings to maximum 5 items.`\n      };\n\n      const response = await client.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [\n          { role: \"system\", content: \"You are a cybersecurity report writer. Always respond with valid JSON matching the exact schema requested. Never include extra fields.\" },\n          { role: \"user\", content: prompts[reportType] }\n        ],\n        response_format: { type: \"json_object\" },\n        temperature: 0.7,\n        max_tokens: 2500,\n      });\n\n      const content = response.choices[0].message.content;\n      if (!content) {\n        throw new Error(\"No response from AI\");\n      }\n\n      const parsed = JSON.parse(content);\n      \n      // Validate and sanitize the AI response\n      const validated: AIResponse = {\n        executiveSummary: typeof parsed.executiveSummary === \"string\" \n          ? parsed.executiveSummary \n          : this.generateTemplatedNarrative(reportType, data).executiveSummary,\n        findings: Array.isArray(parsed.findings) \n          ? parsed.findings.slice(0, 10).map((f: any) => ({\n              title: String(f.title || \"Untitled Finding\"),\n              description: String(f.description || \"No description provided\"),\n              recommendation: String(f.recommendation || \"Review and remediate\")\n            }))\n          : [],\n        recommendations: Array.isArray(parsed.recommendations) \n          ? parsed.recommendations.slice(0, 5).map((r: any) => String(r))\n          : this.generateTemplatedNarrative(reportType, data).recommendations\n      };\n      \n      return validated;\n    } catch (error) {\n      console.error(\"AI narrative generation failed, using template:\", error);\n      return this.generateTemplatedNarrative(reportType, data);\n    }\n  }\n\n  async generateExecutiveSummary(\n    from: Date,\n    to: Date,\n    organizationId: string = \"default\"\n  ): Promise<ExecutiveSummary> {\n    const evaluations = await storage.getEvaluationsByDateRange(from, to, organizationId);\n    const evaluationIds = evaluations.map(e => e.id);\n    const results = await storage.getResultsByEvaluationIds(evaluationIds);\n    \n    const resultsMap = new Map(results.map(r => [r.evaluationId, r]));\n    \n    let criticalCount = 0;\n    let highCount = 0;\n    let mediumCount = 0;\n    let lowCount = 0;\n    let exploitableCount = 0;\n    let totalScore = 0;\n    let totalConfidence = 0;\n    let scoredCount = 0;\n    \n    const topRisks: ExecutiveSummary[\"topRisks\"] = [];\n    \n    for (const evaluation of evaluations) {\n      const result = resultsMap.get(evaluation.id);\n      \n      switch (evaluation.priority) {\n        case \"critical\": criticalCount++; break;\n        case \"high\": highCount++; break;\n        case \"medium\": mediumCount++; break;\n        case \"low\": lowCount++; break;\n      }\n      \n      if (result) {\n        if (result.exploitable) {\n          exploitableCount++;\n          \n          const intelligentScore = result.intelligentScore as any;\n          const financialExposure = intelligentScore?.businessImpact?.factors?.financialExposure;\n          \n          topRisks.push({\n            assetId: evaluation.assetId,\n            riskDescription: evaluation.description,\n            severity: evaluation.priority as \"critical\" | \"high\" | \"medium\" | \"low\",\n            financialImpact: financialExposure ? \n              `$${financialExposure.directLoss?.min?.toLocaleString() || 0} - $${financialExposure.directLoss?.max?.toLocaleString() || 0}` : \n              undefined,\n          });\n        }\n        \n        if (result.score) {\n          totalScore += result.score;\n          totalConfidence += result.confidence || 0;\n          scoredCount++;\n        }\n      }\n    }\n    \n    const sortedRisks = topRisks\n      .sort((a, b) => {\n        const severityOrder = { critical: 0, high: 1, medium: 2, low: 3 };\n        return severityOrder[a.severity] - severityOrder[b.severity];\n      })\n      .slice(0, 5);\n    \n    const overallRiskLevel: \"critical\" | \"high\" | \"medium\" | \"low\" = criticalCount > 0 ? \"critical\" :\n      highCount > 0 ? \"high\" :\n      mediumCount > 0 ? \"medium\" : \"low\";\n    \n    const recommendations: ExecutiveSummary[\"recommendations\"] = [];\n    \n    if (criticalCount > 0) {\n      recommendations.push({\n        priority: 1,\n        action: \"Immediately remediate critical vulnerabilities\",\n        impact: `${criticalCount} critical findings require immediate attention`,\n        effort: \"high\",\n      });\n    }\n    \n    if (exploitableCount > evaluations.length * 0.3) {\n      recommendations.push({\n        priority: 2,\n        action: \"Implement network segmentation and access controls\",\n        impact: \"Reduce blast radius of potential compromises\",\n        effort: \"medium\",\n      });\n    }\n    \n    recommendations.push({\n      priority: recommendations.length + 1,\n      action: \"Schedule recurring security assessments\",\n      impact: \"Continuous monitoring for new vulnerabilities\",\n      effort: \"low\",\n    });\n    \n    const baseNarrative = this.generateExecutiveNarrative(\n      evaluations.length,\n      exploitableCount,\n      criticalCount,\n      overallRiskLevel\n    );\n    \n    const baseReport = {\n      reportDate: new Date().toISOString(),\n      reportPeriod: {\n        from: from.toISOString(),\n        to: to.toISOString(),\n      },\n      organizationId,\n      overallRiskLevel,\n      keyMetrics: {\n        totalEvaluations: evaluations.length,\n        exploitableFindings: exploitableCount,\n        criticalFindings: criticalCount,\n        highFindings: highCount,\n        mediumFindings: mediumCount,\n        lowFindings: lowCount,\n        averageScore: scoredCount > 0 ? Math.round(totalScore / scoredCount) : 0,\n        averageConfidence: scoredCount > 0 ? Math.round(totalConfidence / scoredCount) : 0,\n      },\n      riskTrend: \"stable\" as const,\n      topRisks: sortedRisks,\n      recommendations,\n      executiveNarrative: baseNarrative,\n    };\n\n    // Generate AI-powered natural language content\n    const aiNarrative = await this.generateAINarrative(\"executive\", {\n      metrics: baseReport.keyMetrics,\n      topRisks: sortedRisks,\n      recommendations,\n      overallRiskLevel,\n    });\n\n    // Merge AI-generated content with safe severity mapping\n    const defaultSeverity: \"critical\" | \"high\" | \"medium\" | \"low\" = \"medium\";\n    const enrichedFindings = aiNarrative.findings.length > 0 \n      ? aiNarrative.findings.map((f, i) => ({\n          ...f,\n          severity: sortedRisks[i]?.severity || defaultSeverity,\n        }))\n      : sortedRisks.map(r => ({\n          title: `Risk: ${r.assetId}`,\n          description: r.riskDescription,\n          recommendation: \"Immediate remediation recommended\",\n          severity: r.severity,\n        }));\n\n    return {\n      ...baseReport,\n      executiveSummary: aiNarrative.executiveSummary,\n      executiveNarrative: aiNarrative.executiveSummary || baseNarrative,\n      findings: enrichedFindings,\n      recommendations: aiNarrative.recommendations.length > 0 \n        ? aiNarrative.recommendations.map((r, i) => ({\n            priority: i + 1,\n            action: r,\n            impact: \"Improved security posture\",\n            effort: i === 0 ? \"high\" as const : i === 1 ? \"medium\" as const : \"low\" as const,\n          }))\n        : recommendations,\n    };\n  }\n  \n  async generateTechnicalReport(\n    from: Date,\n    to: Date,\n    organizationId: string = \"default\"\n  ): Promise<TechnicalReport> {\n    const evaluations = await storage.getEvaluationsByDateRange(from, to, organizationId);\n    const evaluationIds = evaluations.map(e => e.id);\n    const results = await storage.getResultsByEvaluationIds(evaluationIds);\n    \n    const resultsMap = new Map(results.map(r => [r.evaluationId, r]));\n    \n    const findings: ReportFinding[] = [];\n    const attackPaths: TechnicalReport[\"attackPaths\"] = [];\n    const technicalDetails: TechnicalReport[\"technicalDetails\"] = [];\n    \n    const byType: Record<string, number> = {};\n    const bySeverity: Record<string, number> = {};\n    const byAsset: Record<string, number> = {};\n    \n    for (const evaluation of evaluations) {\n      const result = resultsMap.get(evaluation.id);\n      \n      byType[evaluation.exposureType] = (byType[evaluation.exposureType] || 0) + 1;\n      bySeverity[evaluation.priority] = (bySeverity[evaluation.priority] || 0) + 1;\n      byAsset[evaluation.assetId] = (byAsset[evaluation.assetId] || 0) + 1;\n      \n      findings.push({\n        id: evaluation.id,\n        evaluationId: evaluation.id,\n        assetId: evaluation.assetId,\n        title: `${evaluation.exposureType.replace(/_/g, \" \")} - ${evaluation.assetId}`,\n        severity: evaluation.priority as \"critical\" | \"high\" | \"medium\" | \"low\",\n        exploitable: result?.exploitable || false,\n        score: result?.score || 0,\n        description: evaluation.description,\n        impact: result?.impact || undefined,\n        recommendation: result?.recommendations?.[0]?.description,\n      });\n      \n      if (result?.attackPath) {\n        const attackGraph = result.attackGraph as any;\n        attackPaths.push({\n          evaluationId: evaluation.id,\n          assetId: evaluation.assetId,\n          steps: result.attackPath as AttackPathStep[],\n          complexity: attackGraph?.complexityScore || 50,\n          timeToCompromise: attackGraph?.timeToCompromise ? \n            `${attackGraph.timeToCompromise.expected} ${attackGraph.timeToCompromise.unit}` : \n            undefined,\n        });\n      }\n      \n      technicalDetails.push({\n        evaluationId: evaluation.id,\n        assetId: evaluation.assetId,\n        exposureType: evaluation.exposureType,\n        technicalAnalysis: result?.impact || evaluation.description,\n        mitigations: result?.recommendations?.map(r => r.description) || [],\n      });\n    }\n    \n    const baseReport = {\n      reportDate: new Date().toISOString(),\n      reportPeriod: {\n        from: from.toISOString(),\n        to: to.toISOString(),\n      },\n      organizationId,\n      findings,\n      attackPaths,\n      vulnerabilityBreakdown: {\n        byType,\n        bySeverity,\n        byAsset,\n      },\n      technicalDetails,\n    };\n\n    // Generate AI-powered natural language content\n    const aiNarrative = await this.generateAINarrative(\"technical\", {\n      findingsCount: findings.length,\n      vulnerabilityBreakdown: { byType, bySeverity },\n      attackPathsCount: attackPaths.length,\n      topFindings: findings.slice(0, 5),\n    });\n\n    // Merge AI-generated content with enhanced findings\n    const enhancedFindings = findings.map((f, i) => {\n      const aiF = aiNarrative.findings[i];\n      return {\n        ...f,\n        title: aiF?.title || f.title,\n        description: aiF?.description || f.description,\n        recommendation: aiF?.recommendation || f.recommendation,\n      };\n    });\n\n    return {\n      ...baseReport,\n      executiveSummary: aiNarrative.executiveSummary,\n      findings: enhancedFindings,\n      recommendations: aiNarrative.recommendations,\n    };\n  }\n  \n  async generateComplianceReport(\n    framework: ComplianceFramework,\n    from: Date,\n    to: Date,\n    organizationId: string = \"default\"\n  ): Promise<ComplianceReport> {\n    const evaluations = await storage.getEvaluationsByDateRange(from, to, organizationId);\n    const evaluationIds = evaluations.map(e => e.id);\n    const results = await storage.getResultsByEvaluationIds(evaluationIds);\n    \n    const resultsMap = new Map(results.map(r => [r.evaluationId, r]));\n    \n    const controlMappings = this.getFrameworkControls(framework);\n    const controlStatus: ComplianceReport[\"controlStatus\"] = [];\n    const gaps: ComplianceReport[\"gaps\"] = [];\n    \n    let compliantControls = 0;\n    \n    for (const control of controlMappings) {\n      const relatedFindings: string[] = [];\n      let hasViolation = false;\n      let maxSeverity: \"critical\" | \"high\" | \"medium\" | \"low\" = \"low\";\n      \n      for (const evaluation of evaluations) {\n        const result = resultsMap.get(evaluation.id);\n        const intelligentScore = result?.intelligentScore as any;\n        const complianceImpact = intelligentScore?.businessImpact?.factors?.complianceImpact;\n        \n        if (complianceImpact?.affectedFrameworks?.includes(framework.toLowerCase())) {\n          relatedFindings.push(evaluation.id);\n          hasViolation = true;\n          \n          const violations = complianceImpact.violations || [];\n          for (const v of violations) {\n            if (v.severity === \"critical\" && maxSeverity !== \"critical\") maxSeverity = \"critical\";\n            else if (v.severity === \"major\" && maxSeverity !== \"critical\") maxSeverity = \"high\";\n          }\n        }\n      }\n      \n      const status = hasViolation ? \"non_compliant\" : \"compliant\";\n      if (status === \"compliant\") compliantControls++;\n      \n      controlStatus.push({\n        controlId: control.id,\n        controlName: control.name,\n        status,\n        findings: relatedFindings,\n        remediationRequired: hasViolation,\n      });\n      \n      if (hasViolation) {\n        gaps.push({\n          controlId: control.id,\n          gapDescription: `${control.name} has ${relatedFindings.length} finding(s) that may impact compliance`,\n          severity: maxSeverity,\n          remediationGuidance: `Review and remediate findings: ${relatedFindings.join(\", \")}`,\n        });\n      }\n    }\n    \n    const overallCompliance = Math.round((compliantControls / controlMappings.length) * 100);\n    \n    const baseReport = {\n      reportDate: new Date().toISOString(),\n      framework,\n      organizationId,\n      overallCompliance,\n      controlStatus,\n      gaps,\n      auditReadiness: {\n        score: overallCompliance,\n        readyControls: compliantControls,\n        totalControls: controlMappings.length,\n        priorityActions: gaps.slice(0, 3).map(g => `Remediate ${g.controlId}: ${g.gapDescription}`),\n      },\n    };\n\n    // Generate AI-powered natural language content\n    const aiNarrative = await this.generateAINarrative(\"compliance\", {\n      framework,\n      overallCompliance,\n      gaps: gaps.slice(0, 5),\n      controlStatus: controlStatus.slice(0, 10),\n      auditReadiness: baseReport.auditReadiness,\n    });\n\n    // Create compliance findings from AI narrative\n    const complianceFindings = aiNarrative.findings.length > 0\n      ? aiNarrative.findings.map((f, i) => ({\n          ...f,\n          severity: gaps[i]?.severity || \"medium\" as const,\n          status: \"open\" as const,\n        }))\n      : gaps.map(g => ({\n          title: `Control Gap: ${g.controlId}`,\n          description: g.gapDescription,\n          recommendation: g.remediationGuidance,\n          severity: g.severity,\n          status: \"open\" as const,\n        }));\n\n    return {\n      ...baseReport,\n      executiveSummary: aiNarrative.executiveSummary,\n      findings: complianceFindings,\n      recommendations: aiNarrative.recommendations,\n      complianceStatus: Object.fromEntries(\n        controlStatus.map(c => [c.controlName, { status: c.status, coverage: c.status === \"compliant\" ? 100 : 0 }])\n      ),\n    };\n  }\n  \n  exportToCSV(data: any[], headers: string[]): string {\n    const headerRow = headers.join(\",\");\n    const rows = data.map(item => \n      headers.map(h => {\n        const value = item[h];\n        if (value === null || value === undefined) return \"\";\n        if (typeof value === \"string\" && (value.includes(\",\") || value.includes(\"\\n\"))) {\n          return `\"${value.replace(/\"/g, '\"\"')}\"`;\n        }\n        return String(value);\n      }).join(\",\")\n    );\n    return [headerRow, ...rows].join(\"\\n\");\n  }\n  \n  exportToJSON(data: any): string {\n    return JSON.stringify(data, null, 2);\n  }\n  \n  private generateExecutiveNarrative(\n    totalEvaluations: number,\n    exploitableCount: number,\n    criticalCount: number,\n    overallRiskLevel: string\n  ): string {\n    const exploitablePercent = totalEvaluations > 0 ? \n      Math.round((exploitableCount / totalEvaluations) * 100) : 0;\n    \n    let narrative = `During the reporting period, ${totalEvaluations} security evaluations were conducted. `;\n    \n    if (exploitableCount === 0) {\n      narrative += \"No exploitable vulnerabilities were identified, indicating a strong security posture. \";\n    } else {\n      narrative += `${exploitableCount} (${exploitablePercent}%) of the evaluated exposures were found to be exploitable. `;\n    }\n    \n    if (criticalCount > 0) {\n      narrative += `Critical attention is required for ${criticalCount} critical finding${criticalCount > 1 ? \"s\" : \"\"} that pose${criticalCount === 1 ? \"s\" : \"\"} immediate risk to the organization. `;\n    }\n    \n    switch (overallRiskLevel) {\n      case \"critical\":\n        narrative += \"The overall risk posture is CRITICAL and requires immediate executive attention and resource allocation for remediation.\";\n        break;\n      case \"high\":\n        narrative += \"The overall risk posture is HIGH. A prioritized remediation plan should be executed within the next 30 days.\";\n        break;\n      case \"medium\":\n        narrative += \"The overall risk posture is MODERATE. Continued monitoring and scheduled remediation activities are recommended.\";\n        break;\n      case \"low\":\n        narrative += \"The overall risk posture is LOW. Maintain current security practices and continue regular assessments.\";\n        break;\n    }\n    \n    return narrative;\n  }\n  \n  private getFrameworkControls(framework: ComplianceFramework): Array<{ id: string; name: string }> {\n    const frameworkControls: Record<string, Array<{ id: string; name: string }>> = {\n      soc2: [\n        { id: \"CC6.1\", name: \"Logical and Physical Access Controls\" },\n        { id: \"CC6.6\", name: \"Logical Access Security Measures\" },\n        { id: \"CC6.7\", name: \"System Boundary Protection\" },\n        { id: \"CC7.1\", name: \"Detection and Monitoring\" },\n        { id: \"CC7.2\", name: \"Security Incident Response\" },\n      ],\n      pci_dss: [\n        { id: \"1.1\", name: \"Install and Maintain Network Security Controls\" },\n        { id: \"2.1\", name: \"Apply Secure Configurations\" },\n        { id: \"6.1\", name: \"Develop and Maintain Secure Systems\" },\n        { id: \"10.1\", name: \"Log and Monitor Access\" },\n        { id: \"11.1\", name: \"Test Security Regularly\" },\n      ],\n      hipaa: [\n        { id: \"164.308(a)(1)\", name: \"Security Management Process\" },\n        { id: \"164.308(a)(5)\", name: \"Security Awareness Training\" },\n        { id: \"164.312(a)(1)\", name: \"Access Control\" },\n        { id: \"164.312(b)\", name: \"Audit Controls\" },\n        { id: \"164.312(d)\", name: \"Person or Entity Authentication\" },\n      ],\n      gdpr: [\n        { id: \"Art.25\", name: \"Data Protection by Design\" },\n        { id: \"Art.32\", name: \"Security of Processing\" },\n        { id: \"Art.33\", name: \"Breach Notification\" },\n        { id: \"Art.35\", name: \"Data Protection Impact Assessment\" },\n        { id: \"Art.5\", name: \"Principles of Processing\" },\n      ],\n      ccpa: [\n        { id: \"1798.100\", name: \"Consumer Right to Know\" },\n        { id: \"1798.105\", name: \"Consumer Right to Delete\" },\n        { id: \"1798.150\", name: \"Data Security Requirements\" },\n        { id: \"1798.125\", name: \"Non-Discrimination\" },\n        { id: \"1798.140\", name: \"Definition Compliance\" },\n      ],\n      iso27001: [\n        { id: \"A.5\", name: \"Information Security Policies\" },\n        { id: \"A.9\", name: \"Access Control\" },\n        { id: \"A.12\", name: \"Operations Security\" },\n        { id: \"A.14\", name: \"System Acquisition and Development\" },\n        { id: \"A.16\", name: \"Security Incident Management\" },\n      ],\n      nist_csf: [\n        { id: \"ID.AM\", name: \"Asset Management\" },\n        { id: \"PR.AC\", name: \"Access Control\" },\n        { id: \"DE.CM\", name: \"Continuous Monitoring\" },\n        { id: \"RS.RP\", name: \"Response Planning\" },\n        { id: \"RC.RP\", name: \"Recovery Planning\" },\n      ],\n      fedramp: [\n        { id: \"AC-1\", name: \"Access Control Policy\" },\n        { id: \"AU-1\", name: \"Audit and Accountability Policy\" },\n        { id: \"CA-1\", name: \"Security Assessment Policy\" },\n        { id: \"SC-1\", name: \"System and Communications Protection\" },\n        { id: \"SI-1\", name: \"System and Information Integrity\" },\n      ],\n    };\n    \n    return frameworkControls[framework] || [];\n  }\n  \n  async generateEvidencePackage(\n    evaluationId: string,\n    artifacts: any[],\n    evaluationData?: any\n  ): Promise<{\n    executiveSummary: string;\n    timelineNarrative: string;\n    findingsNarrative: string;\n    technicalDetails: string;\n    artifacts: any[];\n    metadata: {\n      evaluationId: string;\n      generatedAt: string;\n      totalArtifacts: number;\n      criticalFindings: number;\n    };\n  }> {\n    const client = getOpenAIClient();\n    \n    // Build context about the evidence\n    const criticalFindings = artifacts.filter(a => a.tags?.includes(\"critical\")).length;\n    const artifactTypes = Array.from(new Set(artifacts.map(a => a.type)));\n    const timeline = artifacts.map(a => ({\n      timestamp: a.timestamp,\n      type: a.type,\n      title: a.title,\n      description: a.description?.substring(0, 200),\n    })).sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());\n    \n    const contextData = {\n      evaluationId,\n      totalArtifacts: artifacts.length,\n      criticalFindings,\n      artifactTypes,\n      timeline,\n      artifacts: artifacts.slice(0, 10).map(a => ({\n        type: a.type,\n        title: a.title,\n        description: a.description,\n        tags: a.tags,\n      })),\n      evaluationResult: evaluationData,\n    };\n    \n    // Templated fallback narratives\n    const templatedResponse = {\n      executiveSummary: `This evidence package contains ${artifacts.length} artifacts collected during the security evaluation of ${evaluationId}. ${criticalFindings > 0 ? `${criticalFindings} critical findings were identified that require immediate attention.` : \"No critical findings were identified.\"} The evidence documents the complete attack chain validation and exploitation attempts conducted during the assessment.`,\n      timelineNarrative: `The evaluation began at ${timeline[0]?.timestamp || \"unknown time\"} and concluded with ${artifacts.length} total evidence artifacts captured. The assessment followed a systematic approach, documenting each phase of the security validation process from reconnaissance through exploitation verification.`,\n      findingsNarrative: criticalFindings > 0 \n        ? `The assessment identified ${criticalFindings} critical security issues requiring immediate remediation. These findings demonstrate exploitable vulnerabilities that could lead to unauthorized access or data compromise. Full technical details are provided in the artifact data below.`\n        : `The assessment completed successfully with no critical vulnerabilities identified. The evidence documents the testing methodology and confirms the security controls functioned as expected.`,\n      technicalDetails: `Evidence types collected: ${artifactTypes.join(\", \")}. Total artifacts: ${artifacts.length}. The evidence package includes request/response captures, execution traces, log entries, and other forensic data supporting the evaluation conclusions.`,\n    };\n    \n    if (!client) {\n      return {\n        ...templatedResponse,\n        artifacts,\n        metadata: {\n          evaluationId,\n          generatedAt: new Date().toISOString(),\n          totalArtifacts: artifacts.length,\n          criticalFindings,\n        },\n      };\n    }\n    \n    try {\n      const response = await client.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [\n          { \n            role: \"system\", \n            content: \"You are a cybersecurity forensics specialist writing evidence documentation. Always respond with valid JSON matching the exact schema requested.\" \n          },\n          { \n            role: \"user\", \n            content: `You are documenting evidence from a security assessment. Based on the following evidence artifacts and evaluation data, write clear narratives that explain what the evidence shows.\n\nEvidence Data:\n${JSON.stringify(contextData, null, 2)}\n\nProvide your response as JSON with this exact structure:\n{\n  \"executiveSummary\": \"A 2-3 sentence summary suitable for executives explaining what the evidence collection demonstrates about the security posture. Focus on business impact.\",\n  \"timelineNarrative\": \"A paragraph describing the sequence of events documented in the evidence, written in chronological order.\",\n  \"findingsNarrative\": \"A paragraph explaining the key security findings demonstrated by this evidence, what vulnerabilities were proven exploitable, and the risk implications.\",\n  \"technicalDetails\": \"A paragraph summarizing the technical evidence types collected, the attack techniques documented, and any notable exploitation methods captured.\"\n}\n\nWrite in clear, professional language. Be specific about what the evidence demonstrates.`\n          }\n        ],\n        response_format: { type: \"json_object\" },\n        temperature: 0.7,\n        max_tokens: 1500,\n      });\n      \n      const content = response.choices[0].message.content;\n      if (!content) {\n        throw new Error(\"No response from AI\");\n      }\n      \n      const parsed = JSON.parse(content);\n      \n      // Validate and sanitize the response\n      const validated = {\n        executiveSummary: typeof parsed.executiveSummary === \"string\" \n          ? parsed.executiveSummary \n          : templatedResponse.executiveSummary,\n        timelineNarrative: typeof parsed.timelineNarrative === \"string\"\n          ? parsed.timelineNarrative\n          : templatedResponse.timelineNarrative,\n        findingsNarrative: typeof parsed.findingsNarrative === \"string\"\n          ? parsed.findingsNarrative\n          : templatedResponse.findingsNarrative,\n        technicalDetails: typeof parsed.technicalDetails === \"string\"\n          ? parsed.technicalDetails\n          : templatedResponse.technicalDetails,\n      };\n      \n      return {\n        ...validated,\n        artifacts,\n        metadata: {\n          evaluationId,\n          generatedAt: new Date().toISOString(),\n          totalArtifacts: artifacts.length,\n          criticalFindings,\n        },\n      };\n    } catch (error) {\n      console.error(\"AI evidence narrative generation failed, using template:\", error);\n      return {\n        ...templatedResponse,\n        artifacts,\n        metadata: {\n          evaluationId,\n          generatedAt: new Date().toISOString(),\n          totalArtifacts: artifacts.length,\n          criticalFindings,\n        },\n      };\n    }\n  }\n\n  // Single Evaluation Reports\n  async generateSingleEvaluationExecutiveSummary(\n    evaluationId: string\n  ): Promise<ExecutiveSummary> {\n    const evaluation = await storage.getEvaluation(evaluationId);\n    if (!evaluation) {\n      throw new Error(`Evaluation not found: ${evaluationId}`);\n    }\n    \n    const result = await storage.getResultByEvaluationId(evaluationId);\n    \n    const criticalCount = evaluation.priority === \"critical\" ? 1 : 0;\n    const highCount = evaluation.priority === \"high\" ? 1 : 0;\n    const mediumCount = evaluation.priority === \"medium\" ? 1 : 0;\n    const lowCount = evaluation.priority === \"low\" ? 1 : 0;\n    const exploitableCount = result?.exploitable ? 1 : 0;\n    \n    const intelligentScore = result?.intelligentScore as any;\n    const financialExposure = intelligentScore?.businessImpact?.factors?.financialExposure;\n    \n    const topRisks: ExecutiveSummary[\"topRisks\"] = result?.exploitable ? [{\n      assetId: evaluation.assetId,\n      riskDescription: evaluation.description,\n      severity: evaluation.priority as \"critical\" | \"high\" | \"medium\" | \"low\",\n      financialImpact: financialExposure ? \n        `$${financialExposure.directLoss?.min?.toLocaleString() || 0} - $${financialExposure.directLoss?.max?.toLocaleString() || 0}` : \n        undefined,\n    }] : [];\n    \n    const overallRiskLevel = evaluation.priority as \"critical\" | \"high\" | \"medium\" | \"low\";\n    \n    const recommendations: ExecutiveSummary[\"recommendations\"] = [];\n    if (result?.recommendations) {\n      result.recommendations.forEach((rec: any, i: number) => {\n        recommendations.push({\n          priority: i + 1,\n          action: rec.description || rec.title || \"Remediation required\",\n          impact: rec.impact || \"Improved security posture\",\n          effort: rec.effort || \"medium\",\n        });\n      });\n    }\n    \n    const baseReport = {\n      reportDate: new Date().toISOString(),\n      reportPeriod: {\n        from: evaluation.createdAt?.toISOString() || new Date().toISOString(),\n        to: evaluation.createdAt?.toISOString() || new Date().toISOString(),\n      },\n      organizationId: evaluation.organizationId || \"default\",\n      overallRiskLevel,\n      keyMetrics: {\n        totalEvaluations: 1,\n        exploitableFindings: exploitableCount,\n        criticalFindings: criticalCount,\n        highFindings: highCount,\n        mediumFindings: mediumCount,\n        lowFindings: lowCount,\n        averageScore: result?.score || 0,\n        averageConfidence: result?.confidence || 0,\n      },\n      riskTrend: \"stable\" as const,\n      topRisks,\n      recommendations,\n      executiveNarrative: this.generateExecutiveNarrative(1, exploitableCount, criticalCount, overallRiskLevel),\n    };\n\n    const aiNarrative = await this.generateAINarrative(\"executive\", {\n      metrics: baseReport.keyMetrics,\n      topRisks,\n      recommendations,\n      overallRiskLevel,\n      assetId: evaluation.assetId,\n      exposureType: evaluation.exposureType,\n      description: evaluation.description,\n      attackPath: result?.attackPath,\n      impact: result?.impact,\n    });\n\n    const defaultSeverity: \"critical\" | \"high\" | \"medium\" | \"low\" = \"medium\";\n    const enrichedFindings = aiNarrative.findings.length > 0 \n      ? aiNarrative.findings.map((f, i) => ({\n          ...f,\n          severity: topRisks[i]?.severity || defaultSeverity,\n        }))\n      : topRisks.map(r => ({\n          title: `Risk: ${r.assetId}`,\n          description: r.riskDescription,\n          recommendation: \"Immediate remediation recommended\",\n          severity: r.severity,\n        }));\n\n    return {\n      ...baseReport,\n      executiveSummary: aiNarrative.executiveSummary,\n      executiveNarrative: aiNarrative.executiveSummary || baseReport.executiveNarrative,\n      findings: enrichedFindings,\n      recommendations: aiNarrative.recommendations.length > 0 \n        ? aiNarrative.recommendations.map((r, i) => ({\n            priority: i + 1,\n            action: r,\n            impact: \"Improved security posture\",\n            effort: i === 0 ? \"high\" as const : i === 1 ? \"medium\" as const : \"low\" as const,\n          }))\n        : recommendations,\n    };\n  }\n\n  async generateSingleEvaluationTechnicalReport(\n    evaluationId: string\n  ): Promise<TechnicalReport> {\n    const evaluation = await storage.getEvaluation(evaluationId);\n    if (!evaluation) {\n      throw new Error(`Evaluation not found: ${evaluationId}`);\n    }\n    \n    const result = await storage.getResultByEvaluationId(evaluationId);\n    \n    const findings: ReportFinding[] = [{\n      id: evaluation.id,\n      evaluationId: evaluation.id,\n      assetId: evaluation.assetId,\n      title: `${evaluation.exposureType.replace(/_/g, \" \")} - ${evaluation.assetId}`,\n      severity: evaluation.priority as \"critical\" | \"high\" | \"medium\" | \"low\",\n      exploitable: result?.exploitable || false,\n      score: result?.score || 0,\n      description: evaluation.description,\n      impact: result?.impact || undefined,\n      recommendation: result?.recommendations?.[0]?.description,\n    }];\n    \n    const attackPaths: TechnicalReport[\"attackPaths\"] = [];\n    if (result?.attackPath) {\n      const attackGraph = result.attackGraph as any;\n      attackPaths.push({\n        evaluationId: evaluation.id,\n        assetId: evaluation.assetId,\n        steps: result.attackPath as AttackPathStep[],\n        complexity: attackGraph?.complexityScore || 50,\n        timeToCompromise: attackGraph?.timeToCompromise ? \n          `${attackGraph.timeToCompromise.expected} ${attackGraph.timeToCompromise.unit}` : \n          undefined,\n      });\n    }\n    \n    const technicalDetails: TechnicalReport[\"technicalDetails\"] = [{\n      evaluationId: evaluation.id,\n      assetId: evaluation.assetId,\n      exposureType: evaluation.exposureType,\n      technicalAnalysis: result?.impact || evaluation.description,\n      mitigations: result?.recommendations?.map((r: any) => r.description) || [],\n    }];\n    \n    const baseReport = {\n      reportDate: new Date().toISOString(),\n      reportPeriod: {\n        from: evaluation.createdAt?.toISOString() || new Date().toISOString(),\n        to: evaluation.createdAt?.toISOString() || new Date().toISOString(),\n      },\n      organizationId: evaluation.organizationId || \"default\",\n      findings,\n      attackPaths,\n      vulnerabilityBreakdown: {\n        byType: { [evaluation.exposureType]: 1 },\n        bySeverity: { [evaluation.priority]: 1 },\n        byAsset: { [evaluation.assetId]: 1 },\n      },\n      technicalDetails,\n    };\n\n    const aiNarrative = await this.generateAINarrative(\"technical\", {\n      findingsCount: 1,\n      vulnerabilityBreakdown: baseReport.vulnerabilityBreakdown,\n      attackPathsCount: attackPaths.length,\n      topFindings: findings,\n      assetId: evaluation.assetId,\n      exposureType: evaluation.exposureType,\n      description: evaluation.description,\n      attackPath: result?.attackPath,\n      impact: result?.impact,\n    });\n\n    const enhancedFindings = findings.map((f, i) => {\n      const aiF = aiNarrative.findings[i];\n      return {\n        ...f,\n        title: aiF?.title || f.title,\n        description: aiF?.description || f.description,\n        recommendation: aiF?.recommendation || f.recommendation,\n      };\n    });\n\n    return {\n      ...baseReport,\n      executiveSummary: aiNarrative.executiveSummary,\n      findings: enhancedFindings,\n      recommendations: aiNarrative.recommendations,\n    };\n  }\n\n  async generateSingleEvaluationComplianceReport(\n    evaluationId: string,\n    framework: ComplianceFramework\n  ): Promise<ComplianceReport> {\n    const evaluation = await storage.getEvaluation(evaluationId);\n    if (!evaluation) {\n      throw new Error(`Evaluation not found: ${evaluationId}`);\n    }\n    \n    const result = await storage.getResultByEvaluationId(evaluationId);\n    \n    const controlMappings = this.getFrameworkControls(framework);\n    const controlStatus: ComplianceReport[\"controlStatus\"] = [];\n    const gaps: ComplianceReport[\"gaps\"] = [];\n    \n    const intelligentScore = result?.intelligentScore as any;\n    const complianceImpact = intelligentScore?.businessImpact?.factors?.complianceImpact;\n    let compliantControls = 0;\n    \n    for (const control of controlMappings) {\n      let hasViolation = false;\n      let maxSeverity: \"critical\" | \"high\" | \"medium\" | \"low\" = \"low\";\n      \n      if (complianceImpact?.affectedFrameworks?.includes(framework.toLowerCase())) {\n        hasViolation = true;\n        const violations = complianceImpact.violations || [];\n        for (const v of violations) {\n          if (v.severity === \"critical\" && maxSeverity !== \"critical\") maxSeverity = \"critical\";\n          else if (v.severity === \"major\" && maxSeverity !== \"critical\") maxSeverity = \"high\";\n        }\n      }\n      \n      const status = hasViolation ? \"non_compliant\" : \"compliant\";\n      if (status === \"compliant\") compliantControls++;\n      \n      controlStatus.push({\n        controlId: control.id,\n        controlName: control.name,\n        status,\n        findings: hasViolation ? [evaluation.id] : [],\n        remediationRequired: hasViolation,\n      });\n      \n      if (hasViolation) {\n        gaps.push({\n          controlId: control.id,\n          gapDescription: `${control.name} has finding(s) that may impact compliance`,\n          severity: maxSeverity,\n          remediationGuidance: `Review and remediate finding: ${evaluation.id}`,\n        });\n      }\n    }\n    \n    const overallCompliance = Math.round((compliantControls / controlMappings.length) * 100);\n    \n    const baseReport = {\n      reportDate: new Date().toISOString(),\n      framework,\n      organizationId: evaluation.organizationId || \"default\",\n      overallCompliance,\n      controlStatus,\n      gaps,\n      auditReadiness: {\n        score: overallCompliance,\n        readyControls: compliantControls,\n        totalControls: controlMappings.length,\n        priorityActions: gaps.slice(0, 3).map(g => `Remediate ${g.controlId}: ${g.gapDescription}`),\n      },\n    };\n\n    const aiNarrative = await this.generateAINarrative(\"compliance\", {\n      framework,\n      overallCompliance,\n      gaps: gaps.slice(0, 5),\n      controlStatus: controlStatus.slice(0, 10),\n      auditReadiness: baseReport.auditReadiness,\n      assetId: evaluation.assetId,\n      exposureType: evaluation.exposureType,\n      description: evaluation.description,\n    });\n\n    const complianceFindings = aiNarrative.findings.length > 0\n      ? aiNarrative.findings.map((f, i) => ({\n          ...f,\n          severity: gaps[i]?.severity || \"medium\" as const,\n          status: \"open\" as const,\n        }))\n      : gaps.map(g => ({\n          title: `Control Gap: ${g.controlId}`,\n          description: g.gapDescription,\n          recommendation: g.remediationGuidance,\n          severity: g.severity,\n          status: \"open\" as const,\n        }));\n\n    return {\n      ...baseReport,\n      executiveSummary: aiNarrative.executiveSummary,\n      findings: complianceFindings,\n      recommendations: aiNarrative.recommendations,\n      complianceStatus: Object.fromEntries(\n        controlStatus.map(c => [c.controlId, { status: c.status, coverage: c.status === \"compliant\" ? 100 : 0 }])\n      ),\n    };\n  }\n\n  async generateEnhancedReport(\n    evaluationId: string,\n    options: {\n      includeKillChain?: boolean;\n      includeRemediation?: boolean;\n      includeVulnerabilityDetails?: boolean;\n    } = {}\n  ): Promise<{\n    reportMetadata: {\n      generatedAt: string;\n      reportType: \"single_evaluation\";\n      evaluationId: string;\n    };\n    evaluation: any;\n    result: any;\n    vulnerability: {\n      info: VulnerabilityInfo;\n      humanReadableName: string;\n      shortName: string;\n      cweId: string;\n      mitreTechniques: string[];\n      businessImpact: string;\n    };\n    remediationGuidance: {\n      structured: RemediationGuidance;\n      formatted: string;\n      steps: Array<{\n        order: number;\n        title: string;\n        description: string;\n        effort: string;\n        estimatedTime?: string;\n        requiredTools?: string[];\n        requiredSkills?: string[];\n        verificationSteps?: string[];\n      }>;\n    };\n    killChain: {\n      section: KillChainReportSection | null;\n      textualDiagram: string;\n      pdfContent: any[] | null;\n    };\n    executiveSummary: ComputedExecutiveSummary;\n    technicalReport: ComputedTechnicalReport;\n    dataStatus: {\n      hasEvaluation: boolean;\n      hasResult: boolean;\n      hasAttackPath: boolean;\n      message: string;\n    };\n  }> {\n    const evaluation = await storage.getEvaluation(evaluationId);\n    if (!evaluation) {\n      throw new Error(`Evaluation not found: ${evaluationId}`);\n    }\n    \n    const result = await storage.getResultByEvaluationId(evaluationId);\n    \n    const exposureType = evaluation.exposureType as ExposureType;\n    const vulnerabilityInfo = getVulnerabilityInfo(exposureType);\n    const remediationGuidance = getRemediationGuidance(exposureType);\n    \n    const evalData: EvaluationData = {\n      id: evaluation.id,\n      assetId: evaluation.assetId,\n      exposureType: exposureType,\n      priority: evaluation.priority as \"critical\" | \"high\" | \"medium\" | \"low\",\n      description: evaluation.description,\n      organizationId: evaluation.organizationId || undefined,\n      createdAt: evaluation.createdAt || undefined,\n    };\n    \n    const resultsMap = new Map<string, ResultData>();\n    if (result) {\n      resultsMap.set(evaluation.id, {\n        evaluationId: result.evaluationId,\n        exploitable: result.exploitable || false,\n        score: result.score || 0,\n        confidence: result.confidence || 0,\n        impact: result.impact || undefined,\n        attackPath: result.attackPath as AttackPathStep[] | undefined,\n        recommendations: result.recommendations as any[] | undefined,\n        attackGraph: result.attackGraph as any | undefined,\n        intelligentScore: result.intelligentScore as any | undefined,\n      });\n    }\n    \n    const computedSummary = computeExecutiveSummary([evalData], resultsMap);\n    const computedTechnical = computeTechnicalReport([evalData], resultsMap);\n    \n    let killChainSection: KillChainReportSection | null = null;\n    let killChainDiagram = \"\";\n    let killChainPdfContent: any[] | null = null;\n    \n    if (options.includeKillChain !== false && result?.attackPath) {\n      const attackPath = result.attackPath as AttackPathStep[];\n      const attackGraph = result.attackGraph as any;\n      const visualization = buildKillChainVisualization(attackPath, attackGraph);\n      killChainSection = generateKillChainReportSection(visualization);\n      killChainDiagram = generateTextualKillChainDiagram(visualization);\n      killChainPdfContent = generatePdfKillChainContent(visualization);\n    }\n    \n    let formattedRemediation = \"\";\n    if (options.includeRemediation !== false) {\n      formattedRemediation = formatRemediationSection({\n        exposureType,\n        vulnerabilityName: formatVulnerabilityName(exposureType),\n        priority: evaluation.priority as \"critical\" | \"high\" | \"medium\" | \"low\",\n        remediationSteps: remediationGuidance.steps,\n        compensatingControls: remediationGuidance.compensatingControls,\n      });\n    }\n    \n    const dataStatus = {\n      hasEvaluation: true,\n      hasResult: !!result,\n      hasAttackPath: !!(result?.attackPath && (result.attackPath as any[]).length > 0),\n      message: result \n        ? \"Complete evaluation data available\" \n        : \"Evaluation exists but analysis results not yet available\",\n    };\n    \n    const vulnerabilityData = options.includeVulnerabilityDetails !== false ? {\n      info: vulnerabilityInfo,\n      humanReadableName: formatVulnerabilityName(exposureType),\n      shortName: formatVulnerabilityShortName(exposureType),\n      cweId: vulnerabilityInfo.cweId,\n      mitreTechniques: vulnerabilityInfo.mitreTechniques,\n      businessImpact: vulnerabilityInfo.businessImpact,\n    } : {\n      info: { name: vulnerabilityInfo.name, description: \"\", cweId: vulnerabilityInfo.cweId, mitreTechniques: [], businessImpact: \"\" } as VulnerabilityInfo,\n      humanReadableName: formatVulnerabilityName(exposureType),\n      shortName: formatVulnerabilityShortName(exposureType),\n      cweId: vulnerabilityInfo.cweId,\n      mitreTechniques: [] as string[],\n      businessImpact: \"\",\n    };\n    \n    const remediationData = options.includeRemediation !== false ? {\n      structured: remediationGuidance,\n      formatted: formattedRemediation,\n      steps: remediationGuidance.steps.map((step) => ({\n        order: step.order,\n        title: step.title,\n        description: step.description,\n        effort: step.effort,\n        estimatedTime: step.estimatedTime,\n        requiredTools: step.requiredTools,\n        requiredSkills: step.requiredSkills,\n        verificationSteps: step.verificationSteps,\n      })),\n    } : {\n      structured: { steps: [], compensatingControls: [] } as RemediationGuidance,\n      formatted: \"\",\n      steps: [] as Array<{\n        order: number;\n        title: string;\n        description: string;\n        effort: string;\n        estimatedTime?: string;\n        requiredTools?: string[];\n        requiredSkills?: string[];\n        verificationSteps?: string[];\n      }>,\n    };\n    \n    return {\n      reportMetadata: {\n        generatedAt: new Date().toISOString(),\n        reportType: \"single_evaluation\",\n        evaluationId,\n      },\n      evaluation,\n      result,\n      vulnerability: vulnerabilityData,\n      remediationGuidance: remediationData,\n      killChain: {\n        section: killChainSection,\n        textualDiagram: killChainDiagram,\n        pdfContent: killChainPdfContent,\n      },\n      executiveSummary: computedSummary,\n      technicalReport: computedTechnical,\n      dataStatus,\n    };\n  }\n\n  async generateEnhancedDateRangeReport(\n    from: Date,\n    to: Date,\n    organizationId: string = \"default\",\n    options: {\n      includeKillChain?: boolean;\n      includeRemediation?: boolean;\n    } = {}\n  ): Promise<{\n    reportMetadata: {\n      generatedAt: string;\n      reportType: \"date_range\";\n      period: { from: string; to: string };\n      organizationId: string;\n    };\n    dataStatus: {\n      hasEvaluations: boolean;\n      hasResults: boolean;\n      evaluationCount: number;\n      resultCount: number;\n      message: string;\n    };\n    evaluations: any[];\n    results: any[];\n    executiveSummary: ComputedExecutiveSummary;\n    technicalReport: ComputedTechnicalReport;\n    killChain: {\n      section: KillChainReportSection | null;\n      textualDiagram: string;\n      pdfContent: any[] | null;\n    };\n    vulnerabilityBreakdown: Array<{\n      type: string;\n      humanReadableName: string;\n      shortName: string;\n      cweId: string;\n      mitreTechniques: string[];\n      businessImpact: string;\n      count: number;\n      exploitableCount: number;\n      remediationGuidance: {\n        steps: Array<{\n          order: number;\n          title: string;\n          description: string;\n          effort: string;\n          estimatedTime?: string;\n          requiredTools?: string[];\n          requiredSkills?: string[];\n          verificationSteps?: string[];\n        }>;\n        compensatingControls: string[];\n      };\n    }>;\n    aggregatedRemediation: {\n      totalVulnerabilityTypes: number;\n      byExposureType: Array<{\n        exposureType: string;\n        humanReadableName: string;\n        count: number;\n        priority: \"critical\" | \"high\" | \"medium\" | \"low\";\n        formattedPlan: string;\n      }>;\n      prioritizedPlan: string;\n      byPriority: {\n        critical: number;\n        high: number;\n        medium: number;\n        low: number;\n      };\n    };\n  }> {\n    const evaluations = await storage.getEvaluationsByDateRange(from, to, organizationId);\n    const evaluationIds = evaluations.map(e => e.id);\n    const results = await storage.getResultsByEvaluationIds(evaluationIds);\n    \n    const evalDataList: EvaluationData[] = evaluations.map(e => ({\n      id: e.id,\n      assetId: e.assetId,\n      exposureType: e.exposureType as ExposureType,\n      priority: e.priority as \"critical\" | \"high\" | \"medium\" | \"low\",\n      description: e.description,\n      organizationId: e.organizationId || undefined,\n      createdAt: e.createdAt || undefined,\n    }));\n    \n    const resultsMap = new Map<string, ResultData>();\n    results.forEach(r => {\n      resultsMap.set(r.evaluationId, {\n        evaluationId: r.evaluationId,\n        exploitable: r.exploitable || false,\n        score: r.score || 0,\n        confidence: r.confidence || 0,\n        impact: r.impact || undefined,\n        attackPath: r.attackPath as AttackPathStep[] | undefined,\n        recommendations: r.recommendations as any[] | undefined,\n        attackGraph: r.attackGraph as any | undefined,\n        intelligentScore: r.intelligentScore as any | undefined,\n      });\n    });\n    \n    const computedSummary = computeExecutiveSummary(evalDataList, resultsMap);\n    const computedTechnical = computeTechnicalReport(evalDataList, resultsMap);\n    \n    const allAttackSteps: AttackPathStep[] = [];\n    let aggregatedGraph: any | undefined;\n    results.forEach(r => {\n      if (r.attackPath) {\n        allAttackSteps.push(...(r.attackPath as AttackPathStep[]));\n      }\n      if (r.attackGraph && !aggregatedGraph) {\n        aggregatedGraph = r.attackGraph;\n      }\n    });\n    \n    let killChainSection: KillChainReportSection | null = null;\n    let killChainDiagram = \"\";\n    let killChainPdfContent: any[] | null = null;\n    \n    if (options.includeKillChain !== false && allAttackSteps.length > 0) {\n      const visualization = buildKillChainVisualization(allAttackSteps, aggregatedGraph);\n      killChainSection = generateKillChainReportSection(visualization);\n      killChainDiagram = generateTextualKillChainDiagram(visualization);\n      killChainPdfContent = generatePdfKillChainContent(visualization);\n    }\n    \n    const vulnTypeCount = new Map<ExposureType, { count: number; exploitableCount: number }>();\n    evaluations.forEach(e => {\n      const type = e.exposureType as ExposureType;\n      const entry = vulnTypeCount.get(type) || { count: 0, exploitableCount: 0 };\n      entry.count++;\n      const result = resultsMap.get(e.id);\n      if (result?.exploitable) entry.exploitableCount++;\n      vulnTypeCount.set(type, entry);\n    });\n    \n    const vulnerabilityBreakdown = Array.from(vulnTypeCount.entries()).map(([type, data]) => {\n      const info = getVulnerabilityInfo(type);\n      const guidance = getRemediationGuidance(type);\n      return {\n        type,\n        humanReadableName: formatVulnerabilityName(type),\n        shortName: formatVulnerabilityShortName(type),\n        cweId: info.cweId,\n        mitreTechniques: info.mitreTechniques,\n        businessImpact: info.businessImpact,\n        count: data.count,\n        exploitableCount: data.exploitableCount,\n        remediationGuidance: {\n          steps: guidance.steps.map(step => ({\n            order: step.order,\n            title: step.title,\n            description: step.description,\n            effort: step.effort,\n            estimatedTime: step.estimatedTime,\n            requiredTools: step.requiredTools,\n            requiredSkills: step.requiredSkills,\n            verificationSteps: step.verificationSteps,\n          })),\n          compensatingControls: guidance.compensatingControls,\n        },\n      };\n    });\n    \n    const remediationByExposureType: Array<{\n      exposureType: string;\n      humanReadableName: string;\n      count: number;\n      priority: \"critical\" | \"high\" | \"medium\" | \"low\";\n      formattedPlan: string;\n    }> = [];\n    \n    if (options.includeRemediation !== false) {\n      vulnerabilityBreakdown.forEach(vuln => {\n        const evalForType = evaluations.find(e => e.exposureType === vuln.type);\n        const priority = evalForType?.priority as \"critical\" | \"high\" | \"medium\" | \"low\" || \"medium\";\n        const guidance = getRemediationGuidance(vuln.type as ExposureType);\n        const formatted = formatRemediationSection({\n          exposureType: vuln.type as ExposureType,\n          vulnerabilityName: vuln.humanReadableName,\n          priority,\n          remediationSteps: guidance.steps,\n          compensatingControls: guidance.compensatingControls,\n        });\n        remediationByExposureType.push({\n          exposureType: vuln.type,\n          humanReadableName: vuln.humanReadableName,\n          count: vuln.count,\n          priority,\n          formattedPlan: formatted,\n        });\n      });\n    }\n    \n    const sortedRemediation = remediationByExposureType.sort((a, b) => {\n      const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };\n      return priorityOrder[a.priority] - priorityOrder[b.priority];\n    });\n    \n    const formattedRemediation = sortedRemediation.length > 0\n      ? sortedRemediation.map(r => r.formattedPlan).join(\"\\n\\n---\\n\\n\")\n      : \"\";\n    \n    const priorityCounts = {\n      critical: evaluations.filter(e => e.priority === \"critical\").length,\n      high: evaluations.filter(e => e.priority === \"high\").length,\n      medium: evaluations.filter(e => e.priority === \"medium\").length,\n      low: evaluations.filter(e => e.priority === \"low\").length,\n    };\n    \n    const dataStatus = {\n      hasEvaluations: evaluations.length > 0,\n      hasResults: results.length > 0,\n      evaluationCount: evaluations.length,\n      resultCount: results.length,\n      message: evaluations.length === 0 \n        ? \"No evaluations found in the specified date range\"\n        : results.length === 0\n          ? `${evaluations.length} evaluations found, but no analysis results yet`\n          : `${evaluations.length} evaluations with ${results.length} completed analyses`,\n    };\n    \n    return {\n      reportMetadata: {\n        generatedAt: new Date().toISOString(),\n        reportType: \"date_range\",\n        period: { from: from.toISOString(), to: to.toISOString() },\n        organizationId,\n      },\n      dataStatus,\n      evaluations,\n      results,\n      executiveSummary: computedSummary,\n      technicalReport: computedTechnical,\n      killChain: {\n        section: killChainSection,\n        textualDiagram: killChainDiagram,\n        pdfContent: killChainPdfContent,\n      },\n      vulnerabilityBreakdown,\n      aggregatedRemediation: {\n        totalVulnerabilityTypes: vulnerabilityBreakdown.length,\n        byExposureType: sortedRemediation,\n        prioritizedPlan: formattedRemediation || \"No remediation plan available - no vulnerabilities found in the specified date range\",\n        byPriority: priorityCounts,\n      },\n    };\n  }\n}\n\nexport const reportGenerator = new ReportGenerator();\n","path":null,"size_bytes":61251,"size_tokens":null},"client/src/components/EvaluationWizard.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport {\n  evaluationTemplates,\n  generateDescription,\n  getExposureType,\n  getPriorityFromAnswers,\n  type TemplateCategory,\n  type InfrastructureType,\n} from \"@/lib/evaluation-templates\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport type { AdversaryProfile } from \"@shared/schema\";\nimport {\n  ArrowLeft,\n  ArrowRight,\n  Check,\n  Globe,\n  Database,\n  Cloud,\n  Box,\n  Network,\n  Users,\n  Mail,\n  Code,\n  Server,\n  Shield,\n  Loader2,\n  Sparkles,\n  FileText,\n  AlertTriangle,\n  UserRound,\n} from \"lucide-react\";\n\nconst adversaryProfileLabels: Record<AdversaryProfile, { label: string; description: string }> = {\n  script_kiddie: { label: \"Script Kiddie\", description: \"Low sophistication, uses public tools\" },\n  opportunistic_criminal: { label: \"Opportunistic Criminal\", description: \"Moderate skill, seeks easy financial gains\" },\n  organized_crime: { label: \"Organized Crime\", description: \"Well-funded criminal organization\" },\n  insider_threat: { label: \"Insider Threat\", description: \"Trusted insider with legitimate access\" },\n  nation_state: { label: \"Nation State\", description: \"State-sponsored with unlimited resources\" },\n  apt_group: { label: \"APT Group\", description: \"Advanced Persistent Threat group\" },\n  hacktivist: { label: \"Hacktivist\", description: \"Ideologically motivated attacker\" },\n  competitor: { label: \"Competitor\", description: \"Corporate espionage actor\" },\n};\n\nconst categoryIcons: Record<string, typeof Globe> = {\n  web_servers: Globe,\n  databases: Database,\n  cloud_storage: Cloud,\n  containers: Box,\n  network: Network,\n  identity: Users,\n  email: Mail,\n  applications: Code,\n};\n\nconst priorityColors: Record<string, string> = {\n  critical: \"bg-red-500/10 text-red-400 border-red-500/30\",\n  high: \"bg-orange-500/10 text-orange-400 border-orange-500/30\",\n  medium: \"bg-amber-500/10 text-amber-400 border-amber-500/30\",\n  low: \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\",\n};\n\ninterface EvaluationWizardProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\ntype WizardStep = \"category\" | \"type\" | \"version\" | \"questions\" | \"review\";\n\nexport function EvaluationWizard({ open, onOpenChange }: EvaluationWizardProps) {\n  const { toast } = useToast();\n  const [step, setStep] = useState<WizardStep>(\"category\");\n  const [selectedCategory, setSelectedCategory] = useState<TemplateCategory | null>(null);\n  const [selectedType, setSelectedType] = useState<InfrastructureType | null>(null);\n  const [selectedVersion, setSelectedVersion] = useState<string>(\"\");\n  const [answers, setAnswers] = useState<Record<string, string | string[]>>({});\n  const [additionalContext, setAdditionalContext] = useState(\"\");\n  const [assetName, setAssetName] = useState(\"\");\n  const [adversaryProfile, setAdversaryProfile] = useState<string>(\"\");\n\n  const resetWizard = () => {\n    setStep(\"category\");\n    setSelectedCategory(null);\n    setSelectedType(null);\n    setSelectedVersion(\"\");\n    setAnswers({});\n    setAdditionalContext(\"\");\n    setAssetName(\"\");\n    setAdversaryProfile(\"\");\n  };\n\n  const handleOpenChange = (open: boolean) => {\n    if (!open) {\n      resetWizard();\n    }\n    onOpenChange(open);\n  };\n\n  const createEvaluationMutation = useMutation({\n    mutationFn: async (data: {\n      assetId: string;\n      exposureType: string;\n      priority: string;\n      description: string;\n      adversaryProfile?: string;\n    }) => {\n      const response = await apiRequest(\"POST\", \"/api/aev/evaluate\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/aev/evaluations\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/aev/stats\"] });\n      toast({\n        title: \"Evaluation Started\",\n        description: \"AI analysis is now running on your infrastructure component.\",\n      });\n      handleOpenChange(false);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleCategorySelect = (category: TemplateCategory) => {\n    setSelectedCategory(category);\n    setStep(\"type\");\n  };\n\n  const handleTypeSelect = (type: InfrastructureType) => {\n    setSelectedType(type);\n    setStep(\"version\");\n  };\n\n  const handleVersionSelect = (version: string) => {\n    setSelectedVersion(version);\n    setStep(\"questions\");\n  };\n\n  const handleAnswerChange = (questionId: string, value: string | string[]) => {\n    setAnswers(prev => ({ ...prev, [questionId]: value }));\n  };\n\n  const handleCheckboxChange = (questionId: string, value: string, checked: boolean) => {\n    setAnswers(prev => {\n      const current = (prev[questionId] as string[]) || [];\n      if (checked) {\n        return { ...prev, [questionId]: [...current, value] };\n      } else {\n        return { ...prev, [questionId]: current.filter(v => v !== value) };\n      }\n    });\n  };\n\n  const isQuestionsComplete = () => {\n    if (!selectedType) return false;\n    const requiredQuestions = selectedType.questions.filter(q => q.required);\n    return requiredQuestions.every(q => {\n      const answer = answers[q.id];\n      if (Array.isArray(answer)) return answer.length > 0;\n      return !!answer;\n    });\n  };\n\n  const handleSubmit = () => {\n    if (!selectedCategory || !selectedType) return;\n\n    let description = generateDescription(\n      selectedCategory,\n      selectedType,\n      selectedVersion,\n      answers\n    );\n\n    if (additionalContext.trim()) {\n      description += `\\n\\nAdditional Context:\\n${additionalContext}`;\n    }\n\n    const assetId = assetName.trim() || `${selectedType.id}-${Date.now()}`;\n    const exposureType = getExposureType(selectedCategory.id, selectedType.id);\n    const priority = getPriorityFromAnswers(answers);\n\n    createEvaluationMutation.mutate({\n      assetId,\n      exposureType,\n      priority,\n      description,\n      adversaryProfile: adversaryProfile || undefined,\n    });\n  };\n\n  const getStepProgress = (): number => {\n    switch (step) {\n      case \"category\": return 20;\n      case \"type\": return 40;\n      case \"version\": return 60;\n      case \"questions\": return 80;\n      case \"review\": return 100;\n      default: return 0;\n    }\n  };\n\n  const renderCategoryStep = () => (\n    <div className=\"space-y-4\">\n      <p className=\"text-sm text-muted-foreground\">\n        Select the type of infrastructure you want to evaluate\n      </p>\n      <div className=\"grid grid-cols-2 gap-3\">\n        {evaluationTemplates.map((category) => {\n          const Icon = categoryIcons[category.id] || Server;\n          return (\n            <Card\n              key={category.id}\n              className=\"cursor-pointer hover-elevate active-elevate-2 transition-colors\"\n              onClick={() => handleCategorySelect(category)}\n              data-testid={`card-category-${category.id}`}\n            >\n              <CardHeader className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-md bg-primary/10\">\n                    <Icon className=\"h-5 w-5 text-primary\" />\n                  </div>\n                  <div>\n                    <CardTitle className=\"text-sm\">{category.name}</CardTitle>\n                    <CardDescription className=\"text-xs line-clamp-1\">\n                      {category.description}\n                    </CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n            </Card>\n          );\n        })}\n      </div>\n    </div>\n  );\n\n  const renderTypeStep = () => (\n    <div className=\"space-y-4\">\n      <p className=\"text-sm text-muted-foreground\">\n        Select the specific {selectedCategory?.name.toLowerCase()} type\n      </p>\n      <ScrollArea className=\"h-[300px] pr-4\">\n        <div className=\"space-y-2\">\n          {selectedCategory?.types.map((type) => (\n            <Card\n              key={type.id}\n              className=\"cursor-pointer hover-elevate active-elevate-2 transition-colors\"\n              onClick={() => handleTypeSelect(type)}\n              data-testid={`card-type-${type.id}`}\n            >\n              <CardHeader className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <Server className=\"h-5 w-5 text-muted-foreground\" />\n                  <div>\n                    <CardTitle className=\"text-sm\">{type.name}</CardTitle>\n                    <CardDescription className=\"text-xs\">\n                      {type.description}\n                    </CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n            </Card>\n          ))}\n        </div>\n      </ScrollArea>\n    </div>\n  );\n\n  const renderVersionStep = () => (\n    <div className=\"space-y-4\">\n      <p className=\"text-sm text-muted-foreground\">\n        What version of {selectedType?.name} is running?\n      </p>\n      <ScrollArea className=\"h-[300px] pr-4\">\n        <div className=\"space-y-2\">\n          {selectedType?.versions.map((version) => (\n            <Card\n              key={version.value}\n              className=\"cursor-pointer hover-elevate active-elevate-2 transition-colors\"\n              onClick={() => handleVersionSelect(version.value)}\n              data-testid={`card-version-${version.value}`}\n            >\n              <CardContent className=\"p-4 flex items-center justify-between\">\n                <span className=\"text-sm font-medium\">{version.label}</span>\n                {version.value.includes(\"EOL\") && (\n                  <Badge variant=\"outline\" className=\"bg-red-500/10 text-red-400 border-red-500/30\">\n                    End of Life\n                  </Badge>\n                )}\n                {version.value.includes(\"CVE\") && (\n                  <Badge variant=\"outline\" className=\"bg-orange-500/10 text-orange-400 border-orange-500/30\">\n                    Known CVEs\n                  </Badge>\n                )}\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </ScrollArea>\n    </div>\n  );\n\n  const renderQuestionsStep = () => (\n    <div className=\"space-y-6\">\n      <p className=\"text-sm text-muted-foreground\">\n        Answer these questions to help analyze your {selectedType?.name}\n      </p>\n      <ScrollArea className=\"h-[350px] pr-4\">\n        <div className=\"space-y-6\">\n          {selectedType?.questions.map((question) => (\n            <div key={question.id} className=\"space-y-3\">\n              <Label className=\"text-sm font-medium flex items-center gap-1\">\n                {question.label}\n                {question.required && <span className=\"text-red-400\">*</span>}\n              </Label>\n              \n              {question.type === \"radio\" && question.options && (\n                <RadioGroup\n                  value={answers[question.id] as string || \"\"}\n                  onValueChange={(value) => handleAnswerChange(question.id, value)}\n                  className=\"space-y-2\"\n                >\n                  {question.options.map((option) => (\n                    <div key={option.value} className=\"flex items-center space-x-2\">\n                      <RadioGroupItem\n                        value={option.value}\n                        id={`${question.id}-${option.value}`}\n                        data-testid={`radio-${question.id}-${option.value}`}\n                      />\n                      <Label\n                        htmlFor={`${question.id}-${option.value}`}\n                        className=\"text-sm font-normal cursor-pointer\"\n                      >\n                        {option.label}\n                      </Label>\n                    </div>\n                  ))}\n                </RadioGroup>\n              )}\n              \n              {question.type === \"select\" && question.options && (\n                <Select\n                  value={answers[question.id] as string || \"\"}\n                  onValueChange={(value) => handleAnswerChange(question.id, value)}\n                >\n                  <SelectTrigger data-testid={`select-${question.id}`}>\n                    <SelectValue placeholder=\"Select an option\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {question.options.map((option) => (\n                      <SelectItem key={option.value} value={option.value}>\n                        {option.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              )}\n              \n              {question.type === \"checkbox\" && question.options && (\n                <div className=\"space-y-2\">\n                  {question.options.map((option) => (\n                    <div key={option.value} className=\"flex items-center space-x-2\">\n                      <Checkbox\n                        id={`${question.id}-${option.value}`}\n                        checked={((answers[question.id] as string[]) || []).includes(option.value)}\n                        onCheckedChange={(checked) =>\n                          handleCheckboxChange(question.id, option.value, checked as boolean)\n                        }\n                        data-testid={`checkbox-${question.id}-${option.value}`}\n                      />\n                      <Label\n                        htmlFor={`${question.id}-${option.value}`}\n                        className=\"text-sm font-normal cursor-pointer\"\n                      >\n                        {option.label}\n                      </Label>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          ))}\n          \n          <div className=\"space-y-3 pt-4 border-t\">\n            <Label className=\"text-sm font-medium\">\n              Asset Name (optional)\n            </Label>\n            <input\n              type=\"text\"\n              value={assetName}\n              onChange={(e) => setAssetName(e.target.value)}\n              placeholder=\"e.g., prod-web-server-01\"\n              className=\"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50\"\n              data-testid=\"input-asset-name\"\n            />\n          </div>\n          \n          <div className=\"space-y-3\">\n            <Label className=\"text-sm font-medium\">\n              Additional Context (optional)\n            </Label>\n            <Textarea\n              value={additionalContext}\n              onChange={(e) => setAdditionalContext(e.target.value)}\n              placeholder=\"Any additional details about this system, recent changes, or specific concerns...\"\n              className=\"min-h-[80px]\"\n              data-testid=\"textarea-additional-context\"\n            />\n          </div>\n          \n          <div className=\"space-y-3 pt-4 border-t\">\n            <div className=\"flex items-center gap-2\">\n              <Label className=\"text-sm font-medium\">Threat Actor Profile (optional)</Label>\n              <Tooltip>\n                <TooltipTrigger>\n                  <UserRound className=\"h-3 w-3 text-muted-foreground\" />\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p className=\"max-w-xs text-xs\">Simulates attack from a specific threat actor type. The AI will adjust its tactics and techniques accordingly.</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n            <Select\n              value={adversaryProfile || \"__none__\"}\n              onValueChange={(value) => setAdversaryProfile(value === \"__none__\" ? \"\" : value)}\n            >\n              <SelectTrigger data-testid=\"select-adversary-profile\">\n                <SelectValue placeholder=\"Default (balanced analysis)\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"__none__\">Default (balanced analysis)</SelectItem>\n                {(Object.keys(adversaryProfileLabels) as AdversaryProfile[]).map((profile) => (\n                  <SelectItem key={profile} value={profile} data-testid={`option-${profile}`}>\n                    {adversaryProfileLabels[profile].label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            {adversaryProfile && (\n              <p className=\"text-xs text-muted-foreground\">\n                {adversaryProfileLabels[adversaryProfile as AdversaryProfile]?.description}\n              </p>\n            )}\n          </div>\n        </div>\n      </ScrollArea>\n      \n      <div className=\"flex justify-end\">\n        <Button\n          onClick={() => setStep(\"review\")}\n          disabled={!isQuestionsComplete()}\n          data-testid=\"btn-continue-to-review\"\n        >\n          Continue to Review\n          <ArrowRight className=\"ml-2 h-4 w-4\" />\n        </Button>\n      </div>\n    </div>\n  );\n\n  const renderReviewStep = () => {\n    if (!selectedCategory || !selectedType) return null;\n    \n    const description = generateDescription(\n      selectedCategory,\n      selectedType,\n      selectedVersion,\n      answers\n    );\n    const priority = getPriorityFromAnswers(answers);\n    const exposureType = getExposureType(selectedCategory.id, selectedType.id);\n    \n    return (\n      <div className=\"space-y-6\">\n        <div className=\"p-4 rounded-lg bg-muted/50 space-y-4\">\n          <div className=\"flex items-center justify-between gap-4\">\n            <div>\n              <p className=\"text-xs text-muted-foreground\">Asset</p>\n              <p className=\"font-medium\">{assetName || `${selectedType.id}-${Date.now()}`}</p>\n            </div>\n            <div>\n              <p className=\"text-xs text-muted-foreground\">Type</p>\n              <p className=\"font-medium\">{selectedType.name}</p>\n            </div>\n            <div>\n              <p className=\"text-xs text-muted-foreground\">Version</p>\n              <p className=\"font-medium\">{selectedVersion}</p>\n            </div>\n          </div>\n          \n          <div className=\"flex items-center gap-4 flex-wrap\">\n            <div>\n              <p className=\"text-xs text-muted-foreground\">Exposure Type</p>\n              <Badge variant=\"outline\">{exposureType}</Badge>\n            </div>\n            <div>\n              <p className=\"text-xs text-muted-foreground\">Auto-detected Priority</p>\n              <Badge variant=\"outline\" className={priorityColors[priority]}>\n                {priority.charAt(0).toUpperCase() + priority.slice(1)}\n              </Badge>\n            </div>\n            {adversaryProfile && (\n              <div>\n                <p className=\"text-xs text-muted-foreground\">Threat Actor</p>\n                <Badge variant=\"outline\" className=\"bg-violet-500/10 text-violet-400 border-violet-500/30\">\n                  {adversaryProfileLabels[adversaryProfile as AdversaryProfile]?.label}\n                </Badge>\n              </div>\n            )}\n          </div>\n        </div>\n        \n        <div className=\"space-y-2\">\n          <Label className=\"text-sm font-medium flex items-center gap-2\">\n            <FileText className=\"h-4 w-4\" />\n            Generated Analysis Request\n          </Label>\n          <div className=\"p-3 rounded-lg bg-muted/30 border text-sm font-mono whitespace-pre-wrap max-h-[200px] overflow-auto\">\n            {description}\n            {additionalContext && (\n              <>\n                {\"\\n\\nAdditional Context:\\n\"}\n                {additionalContext}\n              </>\n            )}\n          </div>\n        </div>\n        \n        <div className=\"flex items-center gap-2 p-3 rounded-lg bg-primary/5 border border-primary/20\">\n          <Sparkles className=\"h-5 w-5 text-primary\" />\n          <p className=\"text-sm\">\n            AI will analyze this configuration for vulnerabilities, attack vectors, and provide remediation recommendations.\n          </p>\n        </div>\n      </div>\n    );\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={handleOpenChange}>\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-hidden flex flex-col\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-primary\" />\n            {step === \"category\" && \"New Security Evaluation\"}\n            {step === \"type\" && selectedCategory?.name}\n            {step === \"version\" && selectedType?.name}\n            {step === \"questions\" && `Configure ${selectedType?.name}`}\n            {step === \"review\" && \"Review & Start Evaluation\"}\n          </DialogTitle>\n          <DialogDescription>\n            {step === \"category\" && \"Select an infrastructure category to begin\"}\n            {step === \"type\" && \"Choose the specific component type\"}\n            {step === \"version\" && \"Select the version running in your environment\"}\n            {step === \"questions\" && \"Answer a few questions about your configuration\"}\n            {step === \"review\" && \"Review the details and start the AI analysis\"}\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"py-2\">\n          <Progress value={getStepProgress()} className=\"h-1\" />\n        </div>\n        \n        <div className=\"flex-1 overflow-hidden\">\n          {step === \"category\" && renderCategoryStep()}\n          {step === \"type\" && renderTypeStep()}\n          {step === \"version\" && renderVersionStep()}\n          {step === \"questions\" && renderQuestionsStep()}\n          {step === \"review\" && renderReviewStep()}\n        </div>\n        \n        <div className=\"flex items-center justify-between pt-4 border-t mt-4\">\n          <Button\n            variant=\"ghost\"\n            onClick={() => {\n              if (step === \"type\") setStep(\"category\");\n              else if (step === \"version\") setStep(\"type\");\n              else if (step === \"questions\") setStep(\"version\");\n              else if (step === \"review\") setStep(\"questions\");\n            }}\n            disabled={step === \"category\" || createEvaluationMutation.isPending}\n            data-testid=\"btn-wizard-back\"\n          >\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          \n          {step === \"review\" && (\n            <Button\n              onClick={handleSubmit}\n              disabled={createEvaluationMutation.isPending}\n              data-testid=\"btn-start-evaluation\"\n            >\n              {createEvaluationMutation.isPending ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Starting...\n                </>\n              ) : (\n                <>\n                  <Sparkles className=\"mr-2 h-4 w-4\" />\n                  Start AI Evaluation\n                </>\n              )}\n            </Button>\n          )}\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":23926,"size_tokens":null},"client/src/pages/Agents.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { \n  Server, \n  Activity, \n  AlertTriangle, \n  Trash2, \n  Plus, \n  Copy, \n  CheckCircle2, \n  XCircle,\n  MonitorSmartphone,\n  Wifi,\n  WifiOff,\n  Terminal,\n  Eye,\n  Lock,\n  Shield\n} from \"lucide-react\";\n\ninterface EndpointAgent {\n  id: string;\n  agentName: string;\n  hostname: string | null;\n  platform: string | null;\n  platformVersion: string | null;\n  architecture: string | null;\n  ipAddresses: string[] | null;\n  status: string;\n  lastHeartbeat: string | null;\n  lastTelemetry: string | null;\n  environment: string | null;\n  tags: string[] | null;\n  registeredAt: string;\n}\n\ninterface AgentFinding {\n  id: string;\n  agentId: string;\n  findingType: string;\n  severity: string;\n  title: string;\n  description: string | null;\n  affectedComponent: string | null;\n  status: string;\n  detectedAt: string;\n  aevEvaluationId: string | null;\n  autoEvaluationTriggered: boolean;\n}\n\ninterface AgentStats {\n  totalAgents: number;\n  onlineAgents: number;\n  offlineAgents: number;\n  totalFindings: number;\n  criticalFindings: number;\n  highFindings: number;\n  newFindings: number;\n}\n\nexport default function Agents() {\n  const { toast } = useToast();\n  const { hasPermission } = useAuth();\n  \n  const canRegisterAgent = hasPermission(\"agents:register\");\n  const canManageAgent = hasPermission(\"agents:manage\");\n  const canDeleteAgent = hasPermission(\"agents:delete\");\n  \n  const [registerDialogOpen, setRegisterDialogOpen] = useState(false);\n  const [newAgentName, setNewAgentName] = useState(\"\");\n  const [newAgentPlatform, setNewAgentPlatform] = useState(\"linux\");\n  const [newAgentEnvironment, setNewAgentEnvironment] = useState(\"production\");\n  const [registeredApiKey, setRegisteredApiKey] = useState<string | null>(null);\n  const [selectedAgent, setSelectedAgent] = useState<EndpointAgent | null>(null);\n  const [scriptDialogOpen, setScriptDialogOpen] = useState(false);\n\n  const { data: agents = [], isLoading: agentsLoading } = useQuery<EndpointAgent[]>({\n    queryKey: [\"/api/agents\"],\n  });\n\n  const { data: stats } = useQuery<AgentStats>({\n    queryKey: [\"/api/agents/stats/summary\"],\n  });\n\n  const { data: findings = [] } = useQuery<AgentFinding[]>({\n    queryKey: [\"/api/agent-findings\"],\n  });\n\n  const registerAgentMutation = useMutation({\n    mutationFn: async (data: { agentName: string; platform: string; environment: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/agents/register\", data);\n      return response.json();\n    },\n    onSuccess: (data) => {\n      setRegisteredApiKey(data.apiKey);\n      queryClient.invalidateQueries({ queryKey: [\"/api/agents\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/agents/stats/summary\"] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Registration Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteAgentMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/agents/${id}`);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Agent Deleted\",\n        description: \"The agent has been removed.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/agents\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/agents/stats/summary\"] });\n    },\n  });\n\n  const handleRegister = () => {\n    if (!newAgentName.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"Agent name is required\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    registerAgentMutation.mutate({\n      agentName: newAgentName,\n      platform: newAgentPlatform,\n      environment: newAgentEnvironment,\n    });\n  };\n\n  const copyToClipboard = (text: string) => {\n    navigator.clipboard.writeText(text);\n    toast({\n      title: \"Copied\",\n      description: \"API key copied to clipboard\",\n    });\n  };\n\n  const getSeverityColor = (severity: string) => {\n    switch (severity.toLowerCase()) {\n      case \"critical\": return \"destructive\";\n      case \"high\": return \"destructive\";\n      case \"medium\": return \"secondary\";\n      case \"low\": return \"outline\";\n      default: return \"outline\";\n    }\n  };\n\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case \"online\": return <Wifi className=\"h-4 w-4 text-green-500\" />;\n      case \"offline\": return <WifiOff className=\"h-4 w-4 text-muted-foreground\" />;\n      case \"stale\": return <WifiOff className=\"h-4 w-4 text-yellow-500\" />;\n      default: return <WifiOff className=\"h-4 w-4 text-muted-foreground\" />;\n    }\n  };\n\n  const goAgentInstructions = `# OdinForge Agent Installation\n\n## Quick Install (Auto-detect environment)\n# Download the agent binary for your platform, then run:\n\nsudo ./odinforge-agent install \\\\\n  --server-url ${window.location.origin} \\\\\n  --api-key YOUR_API_KEY_HERE\n\n# Check installation status\n./odinforge-agent status\n\n# Uninstall when needed\nsudo ./odinforge-agent uninstall\n\n## Manual Configuration (agent.yaml)\nserver_url: \"${window.location.origin}\"\napi_key: \"YOUR_API_KEY_HERE\"\ntelemetry_interval: 60s\nbatch_size: 100\nqueue_path: /var/lib/odinforge/queue.db\n\n# Optional mTLS configuration\nmtls:\n  enabled: false\n  cert_path: /etc/odinforge/agent.crt\n  key_path: /etc/odinforge/agent.key\n  ca_path: /etc/odinforge/ca.crt\n\n## Docker Deployment\ndocker run -d \\\\\n  --name odinforge-agent \\\\\n  -e ODINFORGE_SERVER_URL=${window.location.origin} \\\\\n  -e ODINFORGE_API_KEY=YOUR_API_KEY_HERE \\\\\n  -v /var/lib/odinforge:/data \\\\\n  odinforge/agent:latest\n\n## Kubernetes DaemonSet\n# Apply the manifests from odinforge-agent/deploy/kubernetes/\nkubectl create secret generic odinforge-agent \\\\\n  --from-literal=api-key=YOUR_API_KEY_HERE\nkubectl apply -f daemonset.yaml\n\n## Supported Platforms\n- Linux (systemd service with security hardening)\n- macOS (launchd daemon)\n- Windows (Windows Service)\n- Docker (container with volume persistence)\n- Kubernetes (DaemonSet for cluster-wide deployment)\n\n## Features\n- Offline resilience with BoltDB queue\n- Batched HTTPS transmission\n- Optional mTLS and SPKI pinning\n- Auto-restart on failure\n- Stable agent ID across restarts\n`;\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"text-page-title\">Endpoint Agents</h1>\n          <p className=\"text-muted-foreground\">\n            Deploy agents on your infrastructure for live security monitoring\n          </p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" onClick={() => setScriptDialogOpen(true)} data-testid=\"btn-view-script\">\n            <Terminal className=\"h-4 w-4 mr-2\" />\n            Installation Guide\n          </Button>\n          <Dialog open={registerDialogOpen} onOpenChange={(open) => {\n            setRegisterDialogOpen(open);\n            if (!open) {\n              setRegisteredApiKey(null);\n              setNewAgentName(\"\");\n            }\n          }}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"btn-register-agent\" disabled={!canRegisterAgent}>\n                {canRegisterAgent ? <Plus className=\"h-4 w-4 mr-2\" /> : <Lock className=\"h-4 w-4 mr-2\" />}\n                Register Agent\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Register New Agent</DialogTitle>\n                <DialogDescription>\n                  Create credentials for a new endpoint agent\n                </DialogDescription>\n              </DialogHeader>\n              \n              {registeredApiKey ? (\n                <div className=\"space-y-4\">\n                  <div className=\"bg-green-500/10 border border-green-500/20 rounded-md p-4\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <CheckCircle2 className=\"h-5 w-5 text-green-500\" />\n                      <span className=\"font-medium\">Agent Registered Successfully</span>\n                    </div>\n                    <p className=\"text-sm text-muted-foreground mb-4\">\n                      Copy the API key below. It will not be shown again.\n                    </p>\n                    <div className=\"flex gap-2\">\n                      <Input \n                        value={registeredApiKey} \n                        readOnly \n                        className=\"font-mono text-sm\"\n                        data-testid=\"input-api-key\"\n                      />\n                      <Button \n                        variant=\"outline\" \n                        size=\"icon\"\n                        onClick={() => copyToClipboard(registeredApiKey)}\n                        data-testid=\"btn-copy-api-key\"\n                      >\n                        <Copy className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                  <Button \n                    className=\"w-full\" \n                    onClick={() => {\n                      setRegisterDialogOpen(false);\n                      setRegisteredApiKey(null);\n                      setNewAgentName(\"\");\n                    }}\n                    data-testid=\"btn-close-dialog\"\n                  >\n                    Done\n                  </Button>\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"agentName\">Agent Name</Label>\n                    <Input\n                      id=\"agentName\"\n                      placeholder=\"e.g., prod-webserver-01\"\n                      value={newAgentName}\n                      onChange={(e) => setNewAgentName(e.target.value)}\n                      data-testid=\"input-agent-name\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label>Platform</Label>\n                    <Select value={newAgentPlatform} onValueChange={setNewAgentPlatform}>\n                      <SelectTrigger data-testid=\"select-platform\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"linux\">Linux</SelectItem>\n                        <SelectItem value=\"windows\">Windows</SelectItem>\n                        <SelectItem value=\"macos\">macOS</SelectItem>\n                        <SelectItem value=\"container\">Container</SelectItem>\n                        <SelectItem value=\"kubernetes\">Kubernetes</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label>Environment</Label>\n                    <Select value={newAgentEnvironment} onValueChange={setNewAgentEnvironment}>\n                      <SelectTrigger data-testid=\"select-environment\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"production\">Production</SelectItem>\n                        <SelectItem value=\"staging\">Staging</SelectItem>\n                        <SelectItem value=\"development\">Development</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <Button \n                    className=\"w-full\" \n                    onClick={handleRegister}\n                    disabled={registerAgentMutation.isPending}\n                    data-testid=\"btn-submit-register\"\n                  >\n                    {registerAgentMutation.isPending ? \"Registering...\" : \"Register Agent\"}\n                  </Button>\n                </div>\n              )}\n            </DialogContent>\n          </Dialog>\n        </div>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Agents</CardTitle>\n            <Server className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-agents\">\n              {stats?.totalAgents ?? 0}\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Online</CardTitle>\n            <Activity className=\"h-4 w-4 text-green-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\" data-testid=\"text-online-agents\">\n              {stats?.onlineAgents ?? 0}\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Critical Findings</CardTitle>\n            <AlertTriangle className=\"h-4 w-4 text-red-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-red-600\" data-testid=\"text-critical-findings\">\n              {stats?.criticalFindings ?? 0}\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">New Findings</CardTitle>\n            <MonitorSmartphone className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-new-findings\">\n              {stats?.newFindings ?? 0}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Tabs defaultValue=\"agents\" className=\"space-y-4\">\n        <TabsList>\n          <TabsTrigger value=\"agents\" data-testid=\"tab-agents\">Agents</TabsTrigger>\n          <TabsTrigger value=\"findings\" data-testid=\"tab-findings\">Findings</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"agents\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Connected Agents</CardTitle>\n              <CardDescription>\n                Endpoint agents reporting telemetry to OdinForge\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {agentsLoading ? (\n                <div className=\"text-center py-8 text-muted-foreground\">Loading agents...</div>\n              ) : agents.length === 0 ? (\n                <div className=\"text-center py-8\">\n                  <Server className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                  <h3 className=\"font-medium mb-2\">No Agents Registered</h3>\n                  <p className=\"text-muted-foreground text-sm mb-4\">\n                    Register an agent to start collecting live security data\n                  </p>\n                  <Button onClick={() => setRegisterDialogOpen(true)} data-testid=\"btn-register-first-agent\">\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Register First Agent\n                  </Button>\n                </div>\n              ) : (\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Status</TableHead>\n                      <TableHead>Name</TableHead>\n                      <TableHead>Hostname</TableHead>\n                      <TableHead>Platform</TableHead>\n                      <TableHead>Environment</TableHead>\n                      <TableHead>Last Seen</TableHead>\n                      <TableHead className=\"text-right\">Actions</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {agents.map((agent) => (\n                      <TableRow key={agent.id} data-testid={`row-agent-${agent.id}`}>\n                        <TableCell>\n                          <div className=\"flex items-center gap-2\">\n                            {getStatusIcon(agent.status)}\n                            <span className=\"capitalize text-sm\">{agent.status}</span>\n                          </div>\n                        </TableCell>\n                        <TableCell className=\"font-medium\">{agent.agentName}</TableCell>\n                        <TableCell>{agent.hostname || \"-\"}</TableCell>\n                        <TableCell className=\"capitalize\">{agent.platform || \"-\"}</TableCell>\n                        <TableCell>\n                          {agent.environment && (\n                            <Badge variant=\"outline\" className=\"capitalize\">\n                              {agent.environment}\n                            </Badge>\n                          )}\n                        </TableCell>\n                        <TableCell>\n                          {agent.lastHeartbeat\n                            ? formatDistanceToNow(new Date(agent.lastHeartbeat), { addSuffix: true })\n                            : \"Never\"}\n                        </TableCell>\n                        <TableCell className=\"text-right\">\n                          <div className=\"flex justify-end gap-2\">\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              onClick={() => setSelectedAgent(agent)}\n                              data-testid={`btn-view-agent-${agent.id}`}\n                            >\n                              <Eye className=\"h-4 w-4\" />\n                            </Button>\n                            {canDeleteAgent && (\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                onClick={() => deleteAgentMutation.mutate(agent.id)}\n                                data-testid={`btn-delete-agent-${agent.id}`}\n                              >\n                                <Trash2 className=\"h-4 w-4\" />\n                              </Button>\n                            )}\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"findings\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Security Findings</CardTitle>\n              <CardDescription>\n                Issues detected by endpoint agents\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {findings.length === 0 ? (\n                <div className=\"text-center py-8\">\n                  <CheckCircle2 className=\"h-12 w-12 mx-auto text-green-500 mb-4\" />\n                  <h3 className=\"font-medium mb-2\">No Findings Yet</h3>\n                  <p className=\"text-muted-foreground text-sm\">\n                    Agent findings will appear here when detected\n                  </p>\n                </div>\n              ) : (\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Severity</TableHead>\n                      <TableHead>Title</TableHead>\n                      <TableHead>Type</TableHead>\n                      <TableHead>Component</TableHead>\n                      <TableHead>Status</TableHead>\n                      <TableHead>Detected</TableHead>\n                      <TableHead>Auto-Eval</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {findings.map((finding) => (\n                      <TableRow key={finding.id} data-testid={`row-finding-${finding.id}`}>\n                        <TableCell>\n                          <Badge variant={getSeverityColor(finding.severity)}>\n                            {finding.severity}\n                          </Badge>\n                        </TableCell>\n                        <TableCell className=\"font-medium max-w-xs truncate\">\n                          {finding.title}\n                        </TableCell>\n                        <TableCell className=\"capitalize\">\n                          {finding.findingType.replace(/_/g, \" \")}\n                        </TableCell>\n                        <TableCell>{finding.affectedComponent || \"-\"}</TableCell>\n                        <TableCell className=\"capitalize\">{finding.status}</TableCell>\n                        <TableCell>\n                          {formatDistanceToNow(new Date(finding.detectedAt), { addSuffix: true })}\n                        </TableCell>\n                        <TableCell>\n                          {finding.autoEvaluationTriggered ? (\n                            <CheckCircle2 className=\"h-4 w-4 text-green-500\" />\n                          ) : (\n                            <XCircle className=\"h-4 w-4 text-muted-foreground\" />\n                          )}\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      <Dialog open={scriptDialogOpen} onOpenChange={setScriptDialogOpen}>\n        <DialogContent className=\"max-w-4xl max-h-[80vh] overflow-hidden flex flex-col\">\n          <DialogHeader>\n            <DialogTitle>OdinForge Agent Installation</DialogTitle>\n            <DialogDescription>\n              Deploy the Go agent on your endpoints for live security monitoring\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"flex-1 overflow-auto\">\n            <div className=\"relative\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"absolute right-2 top-2\"\n                onClick={() => {\n                  navigator.clipboard.writeText(goAgentInstructions);\n                  toast({ title: \"Copied\", description: \"Instructions copied to clipboard\" });\n                }}\n                data-testid=\"btn-copy-script\"\n              >\n                <Copy className=\"h-4 w-4 mr-2\" />\n                Copy\n              </Button>\n              <pre className=\"bg-muted p-4 rounded-lg overflow-auto text-xs font-mono\">\n                {goAgentInstructions}\n              </pre>\n            </div>\n          </div>\n          <div className=\"pt-4 border-t\">\n            <h4 className=\"font-medium mb-2\">Quick Start:</h4>\n            <ol className=\"list-decimal list-inside space-y-1 text-sm text-muted-foreground\">\n              <li>Register an agent above to get an API key</li>\n              <li>Download the agent binary for your platform</li>\n              <li>Run: sudo ./odinforge-agent install --server-url URL --api-key KEY</li>\n              <li>Check status: ./odinforge-agent status</li>\n            </ol>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Agent Details Dialog */}\n      <Dialog open={selectedAgent !== null} onOpenChange={(open) => !open && setSelectedAgent(null)}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Server className=\"h-5 w-5\" />\n              {selectedAgent?.agentName}\n            </DialogTitle>\n            <DialogDescription>\n              Agent details and system information\n            </DialogDescription>\n          </DialogHeader>\n          {selectedAgent && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-1\">\n                  <Label className=\"text-xs text-muted-foreground\">Status</Label>\n                  <div className=\"flex items-center gap-2\">\n                    {getStatusIcon(selectedAgent.status)}\n                    <span className=\"capitalize font-medium\">{selectedAgent.status}</span>\n                  </div>\n                </div>\n                <div className=\"space-y-1\">\n                  <Label className=\"text-xs text-muted-foreground\">Environment</Label>\n                  <div>\n                    <Badge variant=\"outline\" className=\"capitalize\">\n                      {selectedAgent.environment || \"Unknown\"}\n                    </Badge>\n                  </div>\n                </div>\n                <div className=\"space-y-1\">\n                  <Label className=\"text-xs text-muted-foreground\">Hostname</Label>\n                  <p className=\"font-mono text-sm\">{selectedAgent.hostname || \"-\"}</p>\n                </div>\n                <div className=\"space-y-1\">\n                  <Label className=\"text-xs text-muted-foreground\">Platform</Label>\n                  <p className=\"font-mono text-sm capitalize\">\n                    {selectedAgent.platform || \"-\"} {selectedAgent.platformVersion || \"\"}\n                  </p>\n                </div>\n                <div className=\"space-y-1\">\n                  <Label className=\"text-xs text-muted-foreground\">Architecture</Label>\n                  <p className=\"font-mono text-sm\">{selectedAgent.architecture || \"-\"}</p>\n                </div>\n                <div className=\"space-y-1\">\n                  <Label className=\"text-xs text-muted-foreground\">Registered</Label>\n                  <p className=\"text-sm\">\n                    {formatDistanceToNow(new Date(selectedAgent.registeredAt), { addSuffix: true })}\n                  </p>\n                </div>\n                <div className=\"space-y-1 col-span-2\">\n                  <Label className=\"text-xs text-muted-foreground\">IP Addresses</Label>\n                  <div className=\"flex flex-wrap gap-1\">\n                    {selectedAgent.ipAddresses && selectedAgent.ipAddresses.length > 0 ? (\n                      selectedAgent.ipAddresses.map((ip, i) => (\n                        <Badge key={i} variant=\"secondary\" className=\"font-mono text-xs\">\n                          {ip}\n                        </Badge>\n                      ))\n                    ) : (\n                      <span className=\"text-sm text-muted-foreground\">No IP addresses reported</span>\n                    )}\n                  </div>\n                </div>\n                <div className=\"space-y-1 col-span-2\">\n                  <Label className=\"text-xs text-muted-foreground\">Tags</Label>\n                  <div className=\"flex flex-wrap gap-1\">\n                    {selectedAgent.tags && selectedAgent.tags.length > 0 ? (\n                      selectedAgent.tags.map((tag, i) => (\n                        <Badge key={i} variant=\"outline\" className=\"text-xs\">\n                          {tag}\n                        </Badge>\n                      ))\n                    ) : (\n                      <span className=\"text-sm text-muted-foreground\">No tags</span>\n                    )}\n                  </div>\n                </div>\n                <div className=\"space-y-1\">\n                  <Label className=\"text-xs text-muted-foreground\">Last Heartbeat</Label>\n                  <p className=\"text-sm\">\n                    {selectedAgent.lastHeartbeat\n                      ? formatDistanceToNow(new Date(selectedAgent.lastHeartbeat), { addSuffix: true })\n                      : \"Never\"}\n                  </p>\n                </div>\n                <div className=\"space-y-1\">\n                  <Label className=\"text-xs text-muted-foreground\">Last Telemetry</Label>\n                  <p className=\"text-sm\">\n                    {selectedAgent.lastTelemetry\n                      ? formatDistanceToNow(new Date(selectedAgent.lastTelemetry), { addSuffix: true })\n                      : \"Never\"}\n                  </p>\n                </div>\n              </div>\n              <div className=\"pt-2 border-t\">\n                <p className=\"text-xs text-muted-foreground font-mono\">ID: {selectedAgent.id}</p>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":29294,"size_tokens":null},"client/src/lib/evaluation-templates.ts":{"content":"export interface TemplateQuestion {\n  id: string;\n  label: string;\n  type: \"select\" | \"radio\" | \"checkbox\" | \"text\";\n  options?: { value: string; label: string }[];\n  required?: boolean;\n  helpText?: string;\n}\n\nexport interface InfrastructureType {\n  id: string;\n  name: string;\n  description: string;\n  icon: string;\n  versions: { value: string; label: string }[];\n  questions: TemplateQuestion[];\n}\n\nexport interface TemplateCategory {\n  id: string;\n  name: string;\n  description: string;\n  icon: string;\n  types: InfrastructureType[];\n}\n\nconst commonQuestions: Record<string, TemplateQuestion> = {\n  internetExposed: {\n    id: \"internetExposed\",\n    label: \"Is this system exposed to the internet?\",\n    type: \"radio\",\n    options: [\n      { value: \"yes\", label: \"Yes - Publicly accessible\" },\n      { value: \"no\", label: \"No - Internal network only\" },\n      { value: \"unsure\", label: \"Not sure\" },\n    ],\n    required: true,\n  },\n  dataSensitivity: {\n    id: \"dataSensitivity\",\n    label: \"What type of data does this system handle?\",\n    type: \"select\",\n    options: [\n      { value: \"pii\", label: \"PII (Personal Identifiable Information)\" },\n      { value: \"financial\", label: \"Financial/Payment data\" },\n      { value: \"healthcare\", label: \"Healthcare/PHI data\" },\n      { value: \"credentials\", label: \"Credentials/Secrets\" },\n      { value: \"business\", label: \"Business confidential\" },\n      { value: \"public\", label: \"Public/Non-sensitive data\" },\n      { value: \"unknown\", label: \"Not sure\" },\n    ],\n    required: true,\n  },\n  patchStatus: {\n    id: \"patchStatus\",\n    label: \"Patch status\",\n    type: \"radio\",\n    options: [\n      { value: \"current\", label: \"Fully patched and up to date\" },\n      { value: \"behind\", label: \"Behind on patches\" },\n      { value: \"unknown\", label: \"Unknown/Not monitored\" },\n    ],\n    required: true,\n  },\n  authMethod: {\n    id: \"authMethod\",\n    label: \"Authentication method\",\n    type: \"select\",\n    options: [\n      { value: \"none\", label: \"No authentication\" },\n      { value: \"basic\", label: \"Username/Password only\" },\n      { value: \"mfa\", label: \"Multi-factor authentication\" },\n      { value: \"sso\", label: \"SSO/Enterprise authentication\" },\n      { value: \"cert\", label: \"Certificate-based\" },\n      { value: \"api_key\", label: \"API key\" },\n      { value: \"unknown\", label: \"Not sure\" },\n    ],\n    required: true,\n  },\n};\n\nexport const evaluationTemplates: TemplateCategory[] = [\n  {\n    id: \"web_servers\",\n    name: \"Web Servers\",\n    description: \"Apache, Nginx, IIS, and other HTTP servers\",\n    icon: \"Globe\",\n    types: [\n      {\n        id: \"apache\",\n        name: \"Apache HTTP Server\",\n        description: \"Open-source web server\",\n        icon: \"Server\",\n        versions: [\n          { value: \"2.4.58\", label: \"2.4.58 (Latest)\" },\n          { value: \"2.4.57\", label: \"2.4.57\" },\n          { value: \"2.4.54\", label: \"2.4.54\" },\n          { value: \"2.4.51\", label: \"2.4.51\" },\n          { value: \"2.4.49\", label: \"2.4.49 (CVE-2021-41773)\" },\n          { value: \"2.4.48\", label: \"2.4.48\" },\n          { value: \"2.2.x\", label: \"2.2.x (EOL)\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          commonQuestions.dataSensitivity,\n          {\n            id: \"modules\",\n            label: \"Which modules are enabled?\",\n            type: \"checkbox\",\n            options: [\n              { value: \"mod_ssl\", label: \"SSL/TLS (mod_ssl)\" },\n              { value: \"mod_php\", label: \"PHP (mod_php)\" },\n              { value: \"mod_cgi\", label: \"CGI scripts (mod_cgi)\" },\n              { value: \"mod_proxy\", label: \"Reverse proxy (mod_proxy)\" },\n              { value: \"mod_status\", label: \"Server status (mod_status)\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          commonQuestions.patchStatus,\n        ],\n      },\n      {\n        id: \"nginx\",\n        name: \"Nginx\",\n        description: \"High-performance web server and reverse proxy\",\n        icon: \"Server\",\n        versions: [\n          { value: \"1.25.x\", label: \"1.25.x (Latest mainline)\" },\n          { value: \"1.24.x\", label: \"1.24.x (Latest stable)\" },\n          { value: \"1.22.x\", label: \"1.22.x\" },\n          { value: \"1.20.x\", label: \"1.20.x\" },\n          { value: \"1.18.x\", label: \"1.18.x\" },\n          { value: \"older\", label: \"Older than 1.18\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          commonQuestions.dataSensitivity,\n          {\n            id: \"config\",\n            label: \"What is Nginx used for?\",\n            type: \"checkbox\",\n            options: [\n              { value: \"static\", label: \"Serving static files\" },\n              { value: \"reverse_proxy\", label: \"Reverse proxy\" },\n              { value: \"load_balancer\", label: \"Load balancing\" },\n              { value: \"ssl_termination\", label: \"SSL termination\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          commonQuestions.patchStatus,\n        ],\n      },\n      {\n        id: \"iis\",\n        name: \"Microsoft IIS\",\n        description: \"Windows-based web server\",\n        icon: \"Server\",\n        versions: [\n          { value: \"10.0\", label: \"IIS 10.0 (Windows Server 2016/2019/2022)\" },\n          { value: \"8.5\", label: \"IIS 8.5 (Windows Server 2012 R2)\" },\n          { value: \"8.0\", label: \"IIS 8.0 (Windows Server 2012)\" },\n          { value: \"7.5\", label: \"IIS 7.5 (Windows Server 2008 R2)\" },\n          { value: \"older\", label: \"Older version\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          commonQuestions.dataSensitivity,\n          {\n            id: \"features\",\n            label: \"Which features are enabled?\",\n            type: \"checkbox\",\n            options: [\n              { value: \"asp_net\", label: \"ASP.NET\" },\n              { value: \"webdav\", label: \"WebDAV\" },\n              { value: \"ftp\", label: \"FTP service\" },\n              { value: \"cgi\", label: \"CGI\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          commonQuestions.patchStatus,\n        ],\n      },\n      {\n        id: \"tomcat\",\n        name: \"Apache Tomcat\",\n        description: \"Java servlet container\",\n        icon: \"Server\",\n        versions: [\n          { value: \"10.1.x\", label: \"10.1.x (Latest)\" },\n          { value: \"10.0.x\", label: \"10.0.x\" },\n          { value: \"9.0.x\", label: \"9.0.x\" },\n          { value: \"8.5.x\", label: \"8.5.x\" },\n          { value: \"8.0.x\", label: \"8.0.x (EOL)\" },\n          { value: \"7.x\", label: \"7.x (EOL)\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          commonQuestions.dataSensitivity,\n          {\n            id: \"manager\",\n            label: \"Is the Tomcat Manager accessible?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes_default\", label: \"Yes, with default credentials\" },\n              { value: \"yes_custom\", label: \"Yes, with custom credentials\" },\n              { value: \"no\", label: \"No, disabled or restricted\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          commonQuestions.patchStatus,\n        ],\n      },\n    ],\n  },\n  {\n    id: \"databases\",\n    name: \"Databases\",\n    description: \"SQL and NoSQL database systems\",\n    icon: \"Database\",\n    types: [\n      {\n        id: \"mysql\",\n        name: \"MySQL\",\n        description: \"Popular open-source relational database\",\n        icon: \"Database\",\n        versions: [\n          { value: \"8.0.x\", label: \"8.0.x (Latest)\" },\n          { value: \"5.7.x\", label: \"5.7.x\" },\n          { value: \"5.6.x\", label: \"5.6.x (EOL)\" },\n          { value: \"5.5.x\", label: \"5.5.x (EOL)\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          commonQuestions.dataSensitivity,\n          commonQuestions.authMethod,\n          {\n            id: \"remote_access\",\n            label: \"Is remote access enabled?\",\n            type: \"radio\",\n            options: [\n              { value: \"all\", label: \"Yes, from any host\" },\n              { value: \"specific\", label: \"Yes, from specific IPs only\" },\n              { value: \"localhost\", label: \"No, localhost only\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          commonQuestions.patchStatus,\n        ],\n      },\n      {\n        id: \"postgresql\",\n        name: \"PostgreSQL\",\n        description: \"Advanced open-source relational database\",\n        icon: \"Database\",\n        versions: [\n          { value: \"16.x\", label: \"16.x (Latest)\" },\n          { value: \"15.x\", label: \"15.x\" },\n          { value: \"14.x\", label: \"14.x\" },\n          { value: \"13.x\", label: \"13.x\" },\n          { value: \"12.x\", label: \"12.x\" },\n          { value: \"older\", label: \"Older version\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          commonQuestions.dataSensitivity,\n          commonQuestions.authMethod,\n          {\n            id: \"pg_hba\",\n            label: \"How is host-based authentication configured?\",\n            type: \"radio\",\n            options: [\n              { value: \"trust\", label: \"Trust (no password required)\" },\n              { value: \"md5\", label: \"MD5 password\" },\n              { value: \"scram\", label: \"SCRAM-SHA-256\" },\n              { value: \"cert\", label: \"Certificate authentication\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          commonQuestions.patchStatus,\n        ],\n      },\n      {\n        id: \"mongodb\",\n        name: \"MongoDB\",\n        description: \"Document-oriented NoSQL database\",\n        icon: \"Database\",\n        versions: [\n          { value: \"7.0\", label: \"7.0 (Latest)\" },\n          { value: \"6.0\", label: \"6.0\" },\n          { value: \"5.0\", label: \"5.0\" },\n          { value: \"4.4\", label: \"4.4\" },\n          { value: \"4.2\", label: \"4.2\" },\n          { value: \"older\", label: \"Older version\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          commonQuestions.dataSensitivity,\n          {\n            id: \"auth_enabled\",\n            label: \"Is authentication enabled?\",\n            type: \"radio\",\n            options: [\n              { value: \"no\", label: \"No - Anyone can connect\" },\n              { value: \"yes\", label: \"Yes - Credentials required\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n            required: true,\n          },\n          {\n            id: \"bind_ip\",\n            label: \"What IP is MongoDB bound to?\",\n            type: \"radio\",\n            options: [\n              { value: \"all\", label: \"0.0.0.0 (All interfaces)\" },\n              { value: \"localhost\", label: \"127.0.0.1 (Localhost only)\" },\n              { value: \"specific\", label: \"Specific internal IPs\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          commonQuestions.patchStatus,\n        ],\n      },\n      {\n        id: \"redis\",\n        name: \"Redis\",\n        description: \"In-memory data store\",\n        icon: \"Database\",\n        versions: [\n          { value: \"7.2\", label: \"7.2 (Latest)\" },\n          { value: \"7.0\", label: \"7.0\" },\n          { value: \"6.2\", label: \"6.2\" },\n          { value: \"6.0\", label: \"6.0\" },\n          { value: \"5.x\", label: \"5.x\" },\n          { value: \"older\", label: \"Older version\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          commonQuestions.dataSensitivity,\n          {\n            id: \"protected_mode\",\n            label: \"Is protected mode enabled?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          {\n            id: \"requirepass\",\n            label: \"Is a password required?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          commonQuestions.patchStatus,\n        ],\n      },\n      {\n        id: \"mssql\",\n        name: \"Microsoft SQL Server\",\n        description: \"Enterprise relational database\",\n        icon: \"Database\",\n        versions: [\n          { value: \"2022\", label: \"SQL Server 2022\" },\n          { value: \"2019\", label: \"SQL Server 2019\" },\n          { value: \"2017\", label: \"SQL Server 2017\" },\n          { value: \"2016\", label: \"SQL Server 2016\" },\n          { value: \"2014\", label: \"SQL Server 2014\" },\n          { value: \"older\", label: \"Older version\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          commonQuestions.dataSensitivity,\n          {\n            id: \"auth_mode\",\n            label: \"Authentication mode\",\n            type: \"radio\",\n            options: [\n              { value: \"windows\", label: \"Windows Authentication only\" },\n              { value: \"mixed\", label: \"Mixed Mode (SQL + Windows)\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          {\n            id: \"sa_account\",\n            label: \"Is the SA account enabled?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes_default\", label: \"Yes, with default/weak password\" },\n              { value: \"yes_strong\", label: \"Yes, with strong password\" },\n              { value: \"no\", label: \"No, disabled\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          commonQuestions.patchStatus,\n        ],\n      },\n    ],\n  },\n  {\n    id: \"cloud_storage\",\n    name: \"Cloud Storage\",\n    description: \"AWS S3, Azure Blob, and other cloud storage services\",\n    icon: \"Cloud\",\n    types: [\n      {\n        id: \"aws_s3\",\n        name: \"AWS S3 Bucket\",\n        description: \"Amazon Simple Storage Service\",\n        icon: \"Cloud\",\n        versions: [\n          { value: \"current\", label: \"Current (S3 managed service)\" },\n        ],\n        questions: [\n          {\n            id: \"public_access\",\n            label: \"Is public access enabled?\",\n            type: \"radio\",\n            options: [\n              { value: \"public_read\", label: \"Yes - Public read access\" },\n              { value: \"public_write\", label: \"Yes - Public read/write access\" },\n              { value: \"no\", label: \"No - Private only\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n            required: true,\n          },\n          commonQuestions.dataSensitivity,\n          {\n            id: \"encryption\",\n            label: \"Is server-side encryption enabled?\",\n            type: \"radio\",\n            options: [\n              { value: \"none\", label: \"No encryption\" },\n              { value: \"sse_s3\", label: \"SSE-S3 (S3 managed keys)\" },\n              { value: \"sse_kms\", label: \"SSE-KMS (KMS managed keys)\" },\n              { value: \"sse_c\", label: \"SSE-C (Customer provided keys)\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          {\n            id: \"logging\",\n            label: \"Is access logging enabled?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n        ],\n      },\n      {\n        id: \"azure_blob\",\n        name: \"Azure Blob Storage\",\n        description: \"Microsoft Azure object storage\",\n        icon: \"Cloud\",\n        versions: [\n          { value: \"current\", label: \"Current (Azure managed service)\" },\n        ],\n        questions: [\n          {\n            id: \"access_level\",\n            label: \"Container access level\",\n            type: \"radio\",\n            options: [\n              { value: \"private\", label: \"Private (no anonymous access)\" },\n              { value: \"blob\", label: \"Blob (anonymous read for blobs)\" },\n              { value: \"container\", label: \"Container (anonymous read for container and blobs)\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n            required: true,\n          },\n          commonQuestions.dataSensitivity,\n          {\n            id: \"sas_tokens\",\n            label: \"Are SAS tokens being used?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes_long\", label: \"Yes, with long expiration\" },\n              { value: \"yes_short\", label: \"Yes, with short expiration\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n        ],\n      },\n      {\n        id: \"gcp_storage\",\n        name: \"Google Cloud Storage\",\n        description: \"GCP object storage\",\n        icon: \"Cloud\",\n        versions: [\n          { value: \"current\", label: \"Current (GCP managed service)\" },\n        ],\n        questions: [\n          {\n            id: \"iam_access\",\n            label: \"Who has access to this bucket?\",\n            type: \"radio\",\n            options: [\n              { value: \"public\", label: \"allUsers (Public)\" },\n              { value: \"all_authenticated\", label: \"allAuthenticatedUsers\" },\n              { value: \"specific\", label: \"Specific IAM members only\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n            required: true,\n          },\n          commonQuestions.dataSensitivity,\n          {\n            id: \"uniform_access\",\n            label: \"Is uniform bucket-level access enabled?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes (recommended)\" },\n              { value: \"no\", label: \"No (using ACLs)\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n        ],\n      },\n    ],\n  },\n  {\n    id: \"containers\",\n    name: \"Containers & Kubernetes\",\n    description: \"Docker, Kubernetes, and container orchestration\",\n    icon: \"Box\",\n    types: [\n      {\n        id: \"docker\",\n        name: \"Docker\",\n        description: \"Container runtime\",\n        icon: \"Box\",\n        versions: [\n          { value: \"24.x\", label: \"24.x (Latest)\" },\n          { value: \"23.x\", label: \"23.x\" },\n          { value: \"20.x\", label: \"20.x\" },\n          { value: \"19.x\", label: \"19.x\" },\n          { value: \"older\", label: \"Older version\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          {\n            id: \"socket_exposed\",\n            label: \"Is the Docker socket exposed?\",\n            type: \"radio\",\n            options: [\n              { value: \"network\", label: \"Yes, over network (TCP)\" },\n              { value: \"mount\", label: \"Yes, mounted in containers\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n            required: true,\n          },\n          {\n            id: \"privileged\",\n            label: \"Are containers running in privileged mode?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"some\", label: \"Some containers\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          {\n            id: \"images\",\n            label: \"Image source\",\n            type: \"radio\",\n            options: [\n              { value: \"official\", label: \"Official/verified images only\" },\n              { value: \"mixed\", label: \"Mix of official and third-party\" },\n              { value: \"any\", label: \"Any available images\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n        ],\n      },\n      {\n        id: \"kubernetes\",\n        name: \"Kubernetes\",\n        description: \"Container orchestration platform\",\n        icon: \"Box\",\n        versions: [\n          { value: \"1.29\", label: \"1.29 (Latest)\" },\n          { value: \"1.28\", label: \"1.28\" },\n          { value: \"1.27\", label: \"1.27\" },\n          { value: \"1.26\", label: \"1.26\" },\n          { value: \"1.25\", label: \"1.25\" },\n          { value: \"older\", label: \"Older version\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          {\n            id: \"api_access\",\n            label: \"Is the Kubernetes API publicly accessible?\",\n            type: \"radio\",\n            options: [\n              { value: \"public\", label: \"Yes, from internet\" },\n              { value: \"vpn\", label: \"VPN/internal network only\" },\n              { value: \"no\", label: \"No external access\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n            required: true,\n          },\n          {\n            id: \"rbac\",\n            label: \"Is RBAC enabled?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          {\n            id: \"network_policies\",\n            label: \"Are network policies in place?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n        ],\n      },\n    ],\n  },\n  {\n    id: \"network\",\n    name: \"Network Infrastructure\",\n    description: \"VPN, firewalls, load balancers, and network devices\",\n    icon: \"Network\",\n    types: [\n      {\n        id: \"vpn\",\n        name: \"VPN Gateway\",\n        description: \"Virtual Private Network endpoint\",\n        icon: \"Shield\",\n        versions: [\n          { value: \"openvpn\", label: \"OpenVPN\" },\n          { value: \"wireguard\", label: \"WireGuard\" },\n          { value: \"ipsec\", label: \"IPSec\" },\n          { value: \"ssl_vpn\", label: \"SSL VPN\" },\n          { value: \"other\", label: \"Other\" },\n          { value: \"unknown\", label: \"Unknown\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          commonQuestions.authMethod,\n          {\n            id: \"split_tunnel\",\n            label: \"Is split tunneling enabled?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"no\", label: \"No (full tunnel)\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          {\n            id: \"mfa\",\n            label: \"Is MFA required for VPN access?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n        ],\n      },\n      {\n        id: \"firewall\",\n        name: \"Firewall\",\n        description: \"Network firewall appliance\",\n        icon: \"Shield\",\n        versions: [\n          { value: \"pfsense\", label: \"pfSense\" },\n          { value: \"palo_alto\", label: \"Palo Alto\" },\n          { value: \"fortinet\", label: \"Fortinet FortiGate\" },\n          { value: \"cisco_asa\", label: \"Cisco ASA\" },\n          { value: \"sophos\", label: \"Sophos\" },\n          { value: \"other\", label: \"Other\" },\n          { value: \"unknown\", label: \"Unknown\" },\n        ],\n        questions: [\n          {\n            id: \"mgmt_access\",\n            label: \"Is management interface accessible from internet?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"vpn_only\", label: \"VPN only\" },\n              { value: \"internal\", label: \"Internal network only\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n            required: true,\n          },\n          {\n            id: \"default_rules\",\n            label: \"Are there any default allow rules?\",\n            type: \"radio\",\n            options: [\n              { value: \"allow_all_out\", label: \"Allow all outbound\" },\n              { value: \"allow_all\", label: \"Allow all (inbound and outbound)\" },\n              { value: \"deny_all\", label: \"Deny all by default\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          commonQuestions.patchStatus,\n        ],\n      },\n      {\n        id: \"load_balancer\",\n        name: \"Load Balancer\",\n        description: \"Traffic distribution appliance\",\n        icon: \"Network\",\n        versions: [\n          { value: \"aws_alb\", label: \"AWS ALB/NLB\" },\n          { value: \"azure_lb\", label: \"Azure Load Balancer\" },\n          { value: \"gcp_lb\", label: \"GCP Load Balancer\" },\n          { value: \"haproxy\", label: \"HAProxy\" },\n          { value: \"nginx\", label: \"Nginx\" },\n          { value: \"f5\", label: \"F5 BIG-IP\" },\n          { value: \"other\", label: \"Other\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          {\n            id: \"ssl_termination\",\n            label: \"Where does SSL termination happen?\",\n            type: \"radio\",\n            options: [\n              { value: \"lb\", label: \"At the load balancer\" },\n              { value: \"backend\", label: \"At backend servers\" },\n              { value: \"both\", label: \"End-to-end encryption\" },\n              { value: \"none\", label: \"No SSL/TLS\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          {\n            id: \"health_checks\",\n            label: \"Are health check endpoints authenticated?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n        ],\n      },\n    ],\n  },\n  {\n    id: \"identity\",\n    name: \"Identity & Access\",\n    description: \"Active Directory, LDAP, SSO, and IAM systems\",\n    icon: \"Users\",\n    types: [\n      {\n        id: \"active_directory\",\n        name: \"Active Directory\",\n        description: \"Windows domain services\",\n        icon: \"Users\",\n        versions: [\n          { value: \"2022\", label: \"Windows Server 2022\" },\n          { value: \"2019\", label: \"Windows Server 2019\" },\n          { value: \"2016\", label: \"Windows Server 2016\" },\n          { value: \"2012r2\", label: \"Windows Server 2012 R2\" },\n          { value: \"older\", label: \"Older version\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          {\n            id: \"domain_level\",\n            label: \"Domain functional level\",\n            type: \"select\",\n            options: [\n              { value: \"2016\", label: \"Windows Server 2016\" },\n              { value: \"2012r2\", label: \"Windows Server 2012 R2\" },\n              { value: \"2012\", label: \"Windows Server 2012\" },\n              { value: \"2008r2\", label: \"Windows Server 2008 R2\" },\n              { value: \"older\", label: \"Older\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          {\n            id: \"ldaps\",\n            label: \"Is LDAPS (LDAP over SSL) enabled?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"no\", label: \"No (plain LDAP)\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          {\n            id: \"smb_signing\",\n            label: \"Is SMB signing required?\",\n            type: \"radio\",\n            options: [\n              { value: \"required\", label: \"Required\" },\n              { value: \"optional\", label: \"Optional\" },\n              { value: \"disabled\", label: \"Disabled\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          {\n            id: \"krbtgt\",\n            label: \"When was KRBTGT password last reset?\",\n            type: \"radio\",\n            options: [\n              { value: \"recent\", label: \"Within last 180 days\" },\n              { value: \"old\", label: \"More than 180 days ago\" },\n              { value: \"never\", label: \"Never changed\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          commonQuestions.patchStatus,\n        ],\n      },\n      {\n        id: \"ldap\",\n        name: \"LDAP Server\",\n        description: \"OpenLDAP or similar directory service\",\n        icon: \"Users\",\n        versions: [\n          { value: \"openldap_2.6\", label: \"OpenLDAP 2.6.x\" },\n          { value: \"openldap_2.5\", label: \"OpenLDAP 2.5.x\" },\n          { value: \"openldap_2.4\", label: \"OpenLDAP 2.4.x\" },\n          { value: \"389ds\", label: \"389 Directory Server\" },\n          { value: \"other\", label: \"Other LDAP implementation\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          {\n            id: \"tls\",\n            label: \"Is TLS/SSL enabled?\",\n            type: \"radio\",\n            options: [\n              { value: \"starttls\", label: \"STARTTLS\" },\n              { value: \"ldaps\", label: \"LDAPS (port 636)\" },\n              { value: \"no\", label: \"Plain LDAP only\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          {\n            id: \"anon_bind\",\n            label: \"Is anonymous bind allowed?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          commonQuestions.patchStatus,\n        ],\n      },\n    ],\n  },\n  {\n    id: \"email\",\n    name: \"Email Systems\",\n    description: \"Exchange, O365, and mail servers\",\n    icon: \"Mail\",\n    types: [\n      {\n        id: \"exchange\",\n        name: \"Microsoft Exchange\",\n        description: \"On-premises Exchange Server\",\n        icon: \"Mail\",\n        versions: [\n          { value: \"2019\", label: \"Exchange 2019\" },\n          { value: \"2016\", label: \"Exchange 2016\" },\n          { value: \"2013\", label: \"Exchange 2013\" },\n          { value: \"2010\", label: \"Exchange 2010 (EOL)\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          commonQuestions.dataSensitivity,\n          {\n            id: \"owa\",\n            label: \"Is Outlook Web Access (OWA) publicly accessible?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"vpn\", label: \"VPN only\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          {\n            id: \"activesync\",\n            label: \"Is ActiveSync enabled?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          commonQuestions.patchStatus,\n        ],\n      },\n      {\n        id: \"o365\",\n        name: \"Microsoft 365 / Exchange Online\",\n        description: \"Cloud-based email service\",\n        icon: \"Mail\",\n        versions: [\n          { value: \"current\", label: \"Current (Microsoft managed)\" },\n        ],\n        questions: [\n          {\n            id: \"mfa\",\n            label: \"Is MFA enabled for all users?\",\n            type: \"radio\",\n            options: [\n              { value: \"all\", label: \"Yes, for all users\" },\n              { value: \"admins\", label: \"Only for admins\" },\n              { value: \"optional\", label: \"Optional\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n            required: true,\n          },\n          {\n            id: \"conditional_access\",\n            label: \"Are Conditional Access policies configured?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          {\n            id: \"legacy_auth\",\n            label: \"Is legacy authentication blocked?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes, blocked\" },\n              { value: \"no\", label: \"No, still allowed\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          commonQuestions.dataSensitivity,\n        ],\n      },\n    ],\n  },\n  {\n    id: \"applications\",\n    name: \"Application Servers\",\n    description: \"Node.js, Java, .NET, and Python runtimes\",\n    icon: \"Code\",\n    types: [\n      {\n        id: \"nodejs\",\n        name: \"Node.js Application\",\n        description: \"JavaScript runtime server\",\n        icon: \"Code\",\n        versions: [\n          { value: \"20.x\", label: \"20.x LTS (Current)\" },\n          { value: \"18.x\", label: \"18.x LTS\" },\n          { value: \"16.x\", label: \"16.x (EOL)\" },\n          { value: \"14.x\", label: \"14.x (EOL)\" },\n          { value: \"older\", label: \"Older version\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          commonQuestions.dataSensitivity,\n          {\n            id: \"npm_audit\",\n            label: \"Are there known vulnerabilities in dependencies?\",\n            type: \"radio\",\n            options: [\n              { value: \"none\", label: \"No known vulnerabilities\" },\n              { value: \"low\", label: \"Low severity only\" },\n              { value: \"high\", label: \"High/Critical vulnerabilities\" },\n              { value: \"unknown\", label: \"Not checked\" },\n            ],\n          },\n          {\n            id: \"env_vars\",\n            label: \"How are secrets managed?\",\n            type: \"radio\",\n            options: [\n              { value: \"vault\", label: \"Secrets manager (Vault, AWS Secrets, etc.)\" },\n              { value: \"env\", label: \"Environment variables\" },\n              { value: \"config\", label: \"Config files\" },\n              { value: \"hardcoded\", label: \"Hardcoded in source\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n        ],\n      },\n      {\n        id: \"java\",\n        name: \"Java Application\",\n        description: \"JVM-based application server\",\n        icon: \"Code\",\n        versions: [\n          { value: \"21\", label: \"Java 21 LTS\" },\n          { value: \"17\", label: \"Java 17 LTS\" },\n          { value: \"11\", label: \"Java 11 LTS\" },\n          { value: \"8\", label: \"Java 8\" },\n          { value: \"older\", label: \"Older version\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          commonQuestions.dataSensitivity,\n          {\n            id: \"log4j\",\n            label: \"Is Log4j in use?\",\n            type: \"radio\",\n            options: [\n              { value: \"no\", label: \"No Log4j\" },\n              { value: \"patched\", label: \"Yes, patched (2.17+)\" },\n              { value: \"vulnerable\", label: \"Yes, vulnerable version\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          {\n            id: \"serialization\",\n            label: \"Is Java deserialization used with external input?\",\n            type: \"radio\",\n            options: [\n              { value: \"no\", label: \"No\" },\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n        ],\n      },\n      {\n        id: \"dotnet\",\n        name: \".NET Application\",\n        description: \"Microsoft .NET application\",\n        icon: \"Code\",\n        versions: [\n          { value: \"8.0\", label: \".NET 8 (Latest LTS)\" },\n          { value: \"7.0\", label: \".NET 7\" },\n          { value: \"6.0\", label: \".NET 6 LTS\" },\n          { value: \"5.0\", label: \".NET 5\" },\n          { value: \"core_3.1\", label: \".NET Core 3.1\" },\n          { value: \"framework_4.8\", label: \".NET Framework 4.8\" },\n          { value: \"framework_older\", label: \".NET Framework older\" },\n          { value: \"unknown\", label: \"Unknown version\" },\n        ],\n        questions: [\n          commonQuestions.internetExposed,\n          commonQuestions.dataSensitivity,\n          {\n            id: \"viewstate\",\n            label: \"Is ViewState encryption enabled?\",\n            type: \"radio\",\n            options: [\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"no\", label: \"No\" },\n              { value: \"na\", label: \"Not applicable (not WebForms)\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n          {\n            id: \"debugging\",\n            label: \"Is debugging enabled in production?\",\n            type: \"radio\",\n            options: [\n              { value: \"no\", label: \"No\" },\n              { value: \"yes\", label: \"Yes\" },\n              { value: \"unknown\", label: \"Not sure\" },\n            ],\n          },\n        ],\n      },\n    ],\n  },\n];\n\nexport function generateDescription(\n  category: TemplateCategory,\n  type: InfrastructureType,\n  version: string,\n  answers: Record<string, string | string[]>\n): string {\n  const lines: string[] = [];\n  \n  lines.push(`Infrastructure: ${type.name} (${category.name})`);\n  lines.push(`Version: ${version === \"unknown\" ? \"Unknown/Not specified\" : version}`);\n  \n  const configDetails: string[] = [];\n  \n  for (const question of type.questions) {\n    const answer = answers[question.id];\n    if (!answer || answer === \"unknown\" || answer === \"unsure\") continue;\n    \n    if (Array.isArray(answer)) {\n      const labels = answer\n        .filter(v => v !== \"unknown\" && v !== \"unsure\")\n        .map(v => question.options?.find(o => o.value === v)?.label || v);\n      if (labels.length > 0) {\n        configDetails.push(`${question.label}: ${labels.join(\", \")}`);\n      }\n    } else {\n      const label = question.options?.find(o => o.value === answer)?.label || answer;\n      configDetails.push(`${question.label}: ${label}`);\n    }\n  }\n  \n  if (configDetails.length > 0) {\n    lines.push(\"\");\n    lines.push(\"Configuration Details:\");\n    configDetails.forEach(detail => lines.push(`- ${detail}`));\n  }\n  \n  const riskFactors: string[] = [];\n  if (answers.internetExposed === \"yes\") riskFactors.push(\"Internet-exposed\");\n  if ([\"pii\", \"financial\", \"healthcare\", \"credentials\"].includes(answers.dataSensitivity as string)) {\n    riskFactors.push(\"Handles sensitive data\");\n  }\n  if (answers.patchStatus === \"behind\") riskFactors.push(\"Behind on patches\");\n  if (answers.authMethod === \"none\") riskFactors.push(\"No authentication\");\n  if (answers.public_access === \"public_write\" || answers.public_access === \"public_read\") {\n    riskFactors.push(\"Public access enabled\");\n  }\n  if (answers.auth_enabled === \"no\") riskFactors.push(\"Authentication disabled\");\n  \n  if (riskFactors.length > 0) {\n    lines.push(\"\");\n    lines.push(`Key Risk Factors: ${riskFactors.join(\", \")}`);\n  }\n  \n  lines.push(\"\");\n  lines.push(\"Analysis Request:\");\n  lines.push(\"1. Identify known vulnerabilities and CVEs for this version\");\n  lines.push(\"2. Assess configuration weaknesses based on the details above\");\n  lines.push(\"3. Map potential attack vectors using MITRE ATT&CK framework\");\n  lines.push(\"4. Calculate exploitability considering real-world conditions\");\n  lines.push(\"5. Provide prioritized remediation recommendations\");\n  \n  return lines.join(\"\\n\");\n}\n\nexport function getExposureType(categoryId: string, typeId: string): string {\n  const typeMap: Record<string, string> = {\n    \"apache\": \"Web Server\",\n    \"nginx\": \"Web Server\",\n    \"iis\": \"Web Server\",\n    \"tomcat\": \"Application Server\",\n    \"mysql\": \"Database\",\n    \"postgresql\": \"Database\",\n    \"mongodb\": \"Database\",\n    \"redis\": \"Database\",\n    \"mssql\": \"Database\",\n    \"aws_s3\": \"Cloud Storage\",\n    \"azure_blob\": \"Cloud Storage\",\n    \"gcp_storage\": \"Cloud Storage\",\n    \"docker\": \"Container\",\n    \"kubernetes\": \"Container Orchestration\",\n    \"vpn\": \"Network\",\n    \"firewall\": \"Network\",\n    \"load_balancer\": \"Network\",\n    \"active_directory\": \"Identity\",\n    \"ldap\": \"Identity\",\n    \"exchange\": \"Email\",\n    \"o365\": \"Email\",\n    \"nodejs\": \"Application\",\n    \"java\": \"Application\",\n    \"dotnet\": \"Application\",\n  };\n  \n  return typeMap[typeId] || categoryId;\n}\n\nexport function getPriorityFromAnswers(answers: Record<string, string | string[]>): string {\n  let riskScore = 0;\n  \n  const isInternetExposed = answers.internetExposed === \"yes\" || answers.internetExposed === \"unsure\";\n  const hasSensitiveData = [\"pii\", \"financial\", \"healthcare\", \"credentials\"].includes(answers.dataSensitivity as string);\n  const isUnpatched = answers.patchStatus === \"behind\" || answers.patchStatus === \"unknown\";\n  const hasWeakAuth = answers.authMethod === \"none\" || answers.authMethod === \"basic\";\n  \n  if (answers.internetExposed === \"yes\") riskScore += 4;\n  if (answers.internetExposed === \"unsure\") riskScore += 2;\n  \n  if (answers.dataSensitivity === \"pii\") riskScore += 3;\n  if (answers.dataSensitivity === \"financial\") riskScore += 4;\n  if (answers.dataSensitivity === \"healthcare\") riskScore += 4;\n  if (answers.dataSensitivity === \"credentials\") riskScore += 4;\n  if (answers.dataSensitivity === \"business\") riskScore += 2;\n  \n  if (answers.patchStatus === \"behind\") riskScore += 3;\n  if (answers.patchStatus === \"unknown\") riskScore += 2;\n  \n  if (answers.authMethod === \"none\") riskScore += 4;\n  if (answers.authMethod === \"basic\") riskScore += 2;\n  \n  if (answers.public_access === \"public_write\") riskScore += 5;\n  if (answers.public_access === \"public_read\") riskScore += 3;\n  \n  if (answers.auth_enabled === \"no\") riskScore += 5;\n  if (answers.socket_exposed === \"network\") riskScore += 4;\n  if (answers.api_access === \"public\") riskScore += 4;\n  \n  if (answers.remote_access === \"all\") riskScore += 3;\n  if (answers.bind_ip === \"all\") riskScore += 3;\n  if (answers.protected_mode === \"no\") riskScore += 2;\n  if (answers.requirepass === \"no\") riskScore += 3;\n  if (answers.sa_account === \"yes_default\") riskScore += 4;\n  if (answers.manager === \"yes_default\") riskScore += 4;\n  if (answers.mgmt_access === \"yes\") riskScore += 4;\n  if (answers.mfa === \"no\") riskScore += 3;\n  if (answers.legacy_auth === \"no\") riskScore += 2;\n  if (answers.anon_bind === \"yes\") riskScore += 3;\n  if (answers.privileged === \"yes\") riskScore += 3;\n  if (answers.rbac === \"no\") riskScore += 2;\n  if (answers.log4j === \"vulnerable\") riskScore += 5;\n  if (answers.npm_audit === \"high\") riskScore += 3;\n  if (answers.env_vars === \"hardcoded\") riskScore += 3;\n  if (answers.debugging === \"yes\") riskScore += 2;\n  \n  if (isInternetExposed && hasSensitiveData) riskScore += 2;\n  if (isInternetExposed && isUnpatched) riskScore += 2;\n  if (isInternetExposed && hasWeakAuth) riskScore += 3;\n  if (hasSensitiveData && hasWeakAuth) riskScore += 2;\n  \n  if (riskScore >= 10) return \"critical\";\n  if (riskScore >= 6) return \"high\";\n  if (riskScore >= 3) return \"medium\";\n  return \"low\";\n}\n","path":null,"size_bytes":43641,"size_tokens":null},"client/src/pages/Simulations.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Swords, Play, Trash2, Eye, Clock, CheckCircle2, XCircle, Loader2, Shield, Skull, Zap, Lock } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { AiSimulation } from \"@shared/schema\";\n\nexport default function Simulations() {\n  const { toast } = useToast();\n  const { hasPermission } = useAuth();\n  \n  const canRunSimulation = hasPermission(\"simulations:run\");\n  const canDeleteSimulation = hasPermission(\"simulations:delete\");\n  const [isCreateOpen, setIsCreateOpen] = useState(false);\n  const [selectedSimulation, setSelectedSimulation] = useState<AiSimulation | null>(null);\n  const [formData, setFormData] = useState({\n    assetId: \"\",\n    exposureType: \"cve\",\n    priority: \"high\",\n    description: \"\",\n    rounds: 3,\n  });\n\n  const { data: simulations = [], isLoading } = useQuery<AiSimulation[]>({\n    queryKey: [\"/api/simulations\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      const res = await apiRequest(\"POST\", \"/api/simulations\", data);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/simulations\"] });\n      setIsCreateOpen(false);\n      setFormData({ assetId: \"\", exposureType: \"cve\", priority: \"high\", description: \"\", rounds: 3 });\n      toast({ title: \"Simulation Started\", description: \"AI vs AI simulation is now running.\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/simulations/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/simulations\"] });\n      toast({ title: \"Simulation Deleted\" });\n    },\n  });\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"running\":\n        return <Badge variant=\"outline\" className=\"text-blue-500 border-blue-500\"><Loader2 className=\"h-3 w-3 mr-1 animate-spin\" />Running</Badge>;\n      case \"completed\":\n        return <Badge variant=\"outline\" className=\"text-green-500 border-green-500\"><CheckCircle2 className=\"h-3 w-3 mr-1\" />Completed</Badge>;\n      case \"failed\":\n        return <Badge variant=\"outline\" className=\"text-red-500 border-red-500\"><XCircle className=\"h-3 w-3 mr-1\" />Failed</Badge>;\n      default:\n        return <Badge variant=\"outline\" className=\"text-muted-foreground\"><Clock className=\"h-3 w-3 mr-1\" />Pending</Badge>;\n    }\n  };\n\n  const getSimulationResults = (simulation: AiSimulation) => {\n    const results = simulation.simulationResults as any;\n    if (!results) return null;\n    return {\n      attackerSuccesses: results.attackerSuccesses || 0,\n      defenderBlocks: results.defenderBlocks || 0,\n      attackPath: results.attackPath || [],\n      detectionPoints: results.detectionPoints || [],\n      missedAttacks: results.missedAttacks || [],\n      recommendations: results.recommendations || [],\n    };\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold tracking-tight flex items-center gap-2\">\n            <Swords className=\"h-6 w-6 text-purple-500\" />\n            AI vs AI Simulations\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Purple team exercises with autonomous attack and defense AI agents\n          </p>\n        </div>\n        <Dialog open={isCreateOpen} onOpenChange={setIsCreateOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-new-simulation\" disabled={!canRunSimulation}>\n              {canRunSimulation ? <Play className=\"h-4 w-4 mr-2\" /> : <Lock className=\"h-4 w-4 mr-2\" />}\n              Start Simulation\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"sm:max-w-[500px]\">\n            <DialogHeader>\n              <DialogTitle>Start AI vs AI Simulation</DialogTitle>\n              <DialogDescription>\n                Configure a purple team exercise where attacker and defender AI agents compete\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"assetId\">Target Asset ID</Label>\n                <Input\n                  id=\"assetId\"\n                  value={formData.assetId}\n                  onChange={(e) => setFormData({ ...formData, assetId: e.target.value })}\n                  placeholder=\"e.g., web-server-001\"\n                  data-testid=\"input-simulation-asset\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"exposureType\">Exposure Type</Label>\n                <Select\n                  value={formData.exposureType}\n                  onValueChange={(v) => setFormData({ ...formData, exposureType: v })}\n                >\n                  <SelectTrigger data-testid=\"select-simulation-type\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"cve\">CVE Vulnerability</SelectItem>\n                    <SelectItem value=\"misconfiguration\">Misconfiguration</SelectItem>\n                    <SelectItem value=\"network\">Network Exposure</SelectItem>\n                    <SelectItem value=\"api\">API Vulnerability</SelectItem>\n                    <SelectItem value=\"iam_abuse\">IAM Abuse</SelectItem>\n                    <SelectItem value=\"data_exfiltration\">Data Exfiltration</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"priority\">Priority Level</Label>\n                <Select\n                  value={formData.priority}\n                  onValueChange={(v) => setFormData({ ...formData, priority: v })}\n                >\n                  <SelectTrigger data-testid=\"select-simulation-priority\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"critical\">Critical</SelectItem>\n                    <SelectItem value=\"high\">High</SelectItem>\n                    <SelectItem value=\"medium\">Medium</SelectItem>\n                    <SelectItem value=\"low\">Low</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"rounds\">Simulation Rounds</Label>\n                <Select\n                  value={String(formData.rounds)}\n                  onValueChange={(v) => setFormData({ ...formData, rounds: parseInt(v) })}\n                >\n                  <SelectTrigger data-testid=\"select-simulation-rounds\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"1\">1 Round</SelectItem>\n                    <SelectItem value=\"2\">2 Rounds</SelectItem>\n                    <SelectItem value=\"3\">3 Rounds</SelectItem>\n                    <SelectItem value=\"5\">5 Rounds</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"description\">Scenario Description</Label>\n                <Textarea\n                  id=\"description\"\n                  value={formData.description}\n                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                  placeholder=\"Describe the attack scenario and target environment...\"\n                  rows={3}\n                  data-testid=\"input-simulation-description\"\n                />\n              </div>\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setIsCreateOpen(false)}>Cancel</Button>\n              <Button\n                onClick={() => createMutation.mutate(formData)}\n                disabled={!formData.assetId || !formData.description || createMutation.isPending}\n                data-testid=\"button-start-simulation\"\n              >\n                {createMutation.isPending ? (\n                  <><Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />Starting...</>\n                ) : (\n                  <><Play className=\"h-4 w-4 mr-2\" />Start Simulation</>\n                )}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {isLoading ? (\n        <div className=\"flex items-center justify-center py-12\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n        </div>\n      ) : simulations.length === 0 ? (\n        <Card>\n          <CardContent className=\"py-12\">\n            <div className=\"text-center\">\n              <Swords className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n              <h3 className=\"text-lg font-medium mb-2\">No Simulations Yet</h3>\n              <p className=\"text-muted-foreground mb-4\">\n                Start your first AI vs AI simulation to test your defenses\n              </p>\n              <Button onClick={() => setIsCreateOpen(true)} data-testid=\"button-start-first-simulation\">\n                <Play className=\"h-4 w-4 mr-2\" />\n                Start First Simulation\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4\">\n          {simulations.map((simulation) => {\n            const results = getSimulationResults(simulation);\n            return (\n              <Card key={simulation.id} data-testid={`card-simulation-${simulation.id}`}>\n                <CardHeader className=\"flex flex-row items-start justify-between gap-4 space-y-0 pb-2\">\n                  <div className=\"space-y-1\">\n                    <CardTitle className=\"text-base font-medium\">{simulation.name}</CardTitle>\n                    <CardDescription className=\"line-clamp-1\">{simulation.description}</CardDescription>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    {getStatusBadge(simulation.simulationStatus || \"pending\")}\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex flex-wrap items-center justify-between gap-4\">\n                    <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n                      <span>Started: {simulation.startedAt ? format(new Date(simulation.startedAt), \"PPp\") : \"Not started\"}</span>\n                      {simulation.completedAt && (\n                        <span>Completed: {format(new Date(simulation.completedAt), \"PPp\")}</span>\n                      )}\n                    </div>\n                    \n                    {results && simulation.simulationStatus === \"completed\" && (\n                      <div className=\"flex items-center gap-4\">\n                        <div className=\"flex items-center gap-1\">\n                          <Skull className=\"h-4 w-4 text-red-500\" />\n                          <span className=\"text-sm font-medium\">{results.attackerSuccesses}%</span>\n                          <span className=\"text-xs text-muted-foreground\">attack success</span>\n                        </div>\n                        <div className=\"flex items-center gap-1\">\n                          <Shield className=\"h-4 w-4 text-green-500\" />\n                          <span className=\"text-sm font-medium\">{results.defenderBlocks}%</span>\n                          <span className=\"text-xs text-muted-foreground\">defended</span>\n                        </div>\n                      </div>\n                    )}\n\n                    <div className=\"flex items-center gap-2\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => setSelectedSimulation(simulation)}\n                        disabled={simulation.simulationStatus !== \"completed\"}\n                        data-testid={`button-view-${simulation.id}`}\n                      >\n                        <Eye className=\"h-4 w-4 mr-1\" />\n                        View Results\n                      </Button>\n                      {canDeleteSimulation && (\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => deleteMutation.mutate(simulation.id)}\n                          data-testid={`button-delete-${simulation.id}`}\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </Button>\n                      )}\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            );\n          })}\n        </div>\n      )}\n\n      <Dialog open={!!selectedSimulation} onOpenChange={() => setSelectedSimulation(null)}>\n        <DialogContent className=\"max-w-3xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Zap className=\"h-5 w-5 text-purple-500\" />\n              Simulation Results\n            </DialogTitle>\n            <DialogDescription>{selectedSimulation?.name}</DialogDescription>\n          </DialogHeader>\n          {selectedSimulation && (() => {\n            const results = getSimulationResults(selectedSimulation);\n            if (!results) return <p>No results available</p>;\n            return (\n              <div className=\"space-y-6\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <Card>\n                    <CardHeader className=\"pb-2\">\n                      <CardTitle className=\"text-sm flex items-center gap-2\">\n                        <Skull className=\"h-4 w-4 text-red-500\" />\n                        Attacker Performance\n                      </CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"text-3xl font-bold text-red-500\">{results.attackerSuccesses}%</div>\n                      <p className=\"text-xs text-muted-foreground\">successful attack techniques</p>\n                    </CardContent>\n                  </Card>\n                  <Card>\n                    <CardHeader className=\"pb-2\">\n                      <CardTitle className=\"text-sm flex items-center gap-2\">\n                        <Shield className=\"h-4 w-4 text-green-500\" />\n                        Defender Performance\n                      </CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"text-3xl font-bold text-green-500\">{results.defenderBlocks}%</div>\n                      <p className=\"text-xs text-muted-foreground\">attacks detected/blocked</p>\n                    </CardContent>\n                  </Card>\n                </div>\n\n                {results.attackPath.length > 0 && (\n                  <div>\n                    <h4 className=\"text-sm font-medium mb-2\">Attack Path Used</h4>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {results.attackPath.map((step: string, i: number) => (\n                        <Badge key={i} variant=\"secondary\" className=\"text-xs\">{step}</Badge>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {results.detectionPoints.length > 0 && (\n                  <div>\n                    <h4 className=\"text-sm font-medium mb-2\">Detection Points</h4>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {results.detectionPoints.map((point: string, i: number) => (\n                        <Badge key={i} variant=\"outline\" className=\"text-xs text-green-600 border-green-600\">{point}</Badge>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {results.missedAttacks.length > 0 && (\n                  <div>\n                    <h4 className=\"text-sm font-medium mb-2\">Gaps Identified</h4>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {results.missedAttacks.map((gap: string, i: number) => (\n                        <Badge key={i} variant=\"outline\" className=\"text-xs text-red-600 border-red-600\">{gap}</Badge>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {results.recommendations.length > 0 && (\n                  <div>\n                    <h4 className=\"text-sm font-medium mb-2\">Purple Team Recommendations</h4>\n                    <ul className=\"list-disc list-inside text-sm text-muted-foreground space-y-1\">\n                      {results.recommendations.map((rec: string, i: number) => (\n                        <li key={i}>{rec}</li>\n                      ))}\n                    </ul>\n                  </div>\n                )}\n              </div>\n            );\n          })()}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":18101,"size_tokens":null},"server/services/agents/ai-simulation.ts":{"content":"import OpenAI from \"openai\";\nimport type { AgentMemory, AgentContext, OrchestratorResult, ProgressCallback } from \"./types\";\nimport { runDefenderAgent, DefenderFindings } from \"./defender\";\nimport { runAgentOrchestrator } from \"./orchestrator\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\nexport interface SimulationRound {\n  roundNumber: number;\n  attackerFindings: OrchestratorResult;\n  defenderFindings: DefenderFindings;\n  attackSuccess: number;\n  defenseSuccess: number;\n  roundSummary: string;\n}\n\nexport interface PurpleTeamFeedback {\n  attackerAdaptations: string[];\n  defenderAdaptations: string[];\n  newAttackVectors: string[];\n  newDefensiveControls: string[];\n  overallInsight: string;\n}\n\nexport interface AISimulationResult {\n  simulationId: string;\n  assetId: string;\n  exposureType: string;\n  totalRounds: number;\n  rounds: SimulationRound[];\n  purpleTeamFeedback: PurpleTeamFeedback;\n  finalAttackScore: number;\n  finalDefenseScore: number;\n  winner: \"attacker\" | \"defender\" | \"draw\";\n  recommendations: SimulationRecommendation[];\n  executiveSummary: string;\n  totalProcessingTime: number;\n}\n\nexport interface SimulationRecommendation {\n  id: string;\n  type: \"offensive\" | \"defensive\" | \"process\";\n  priority: \"critical\" | \"high\" | \"medium\" | \"low\";\n  title: string;\n  description: string;\n  effort: \"low\" | \"medium\" | \"high\";\n  impact: \"low\" | \"medium\" | \"high\";\n}\n\nexport type SimulationProgressCallback = (\n  phase: string,\n  round: number,\n  progress: number,\n  message: string\n) => void;\n\nexport async function runAISimulation(\n  assetId: string,\n  exposureType: string,\n  priority: string,\n  description: string,\n  evaluationId: string,\n  rounds: number = 3,\n  onProgress?: SimulationProgressCallback\n): Promise<AISimulationResult> {\n  const startTime = Date.now();\n  const simulationRounds: SimulationRound[] = [];\n  \n  onProgress?.(\"initialization\", 0, 5, \"Initializing AI vs AI simulation...\");\n\n  const context: AgentContext = {\n    assetId,\n    exposureType,\n    priority,\n    description,\n    evaluationId,\n  };\n\n  let cumulativeAttackScore = 0;\n  let cumulativeDefenseScore = 0;\n  let previousDefenderFindings: DefenderFindings | null = null;\n\n  for (let round = 1; round <= rounds; round++) {\n    const roundProgress = Math.floor((round - 1) / rounds * 80) + 10;\n    onProgress?.(\"attack\", round, roundProgress, `Round ${round}: Attacker phase...`);\n\n    const attackerContext = buildAttackerContext(context, previousDefenderFindings, round);\n    \n    const attackerResult = await runAgentOrchestrator(\n      attackerContext.assetId,\n      attackerContext.exposureType,\n      attackerContext.priority,\n      attackerContext.description,\n      evaluationId,\n      (agentName, stage, progress, message) => {\n        const scaledProgress = roundProgress + Math.floor(progress * 0.3);\n        onProgress?.(\"attack\", round, scaledProgress, `[Attacker] ${agentName}: ${message}`);\n      }\n    );\n\n    onProgress?.(\"defense\", round, roundProgress + 35, `Round ${round}: Defender phase...`);\n\n    const memory: AgentMemory = {\n      context,\n      recon: attackerResult.agentFindings.recon,\n      exploit: attackerResult.agentFindings.exploit,\n      lateral: attackerResult.agentFindings.lateral,\n      businessLogic: attackerResult.agentFindings.businessLogic,\n      enhancedBusinessLogic: attackerResult.agentFindings.enhancedBusinessLogic,\n      multiVector: attackerResult.agentFindings.multiVector,\n      impact: attackerResult.agentFindings.impact,\n    };\n\n    const defenderResult = await runDefenderAgent(memory, (agentName, stage, progress, message) => {\n      const scaledProgress = roundProgress + 35 + Math.floor(progress * 0.3);\n      onProgress?.(\"defense\", round, scaledProgress, `[Defender] ${message}`);\n    });\n\n    const attackSuccess = calculateAttackSuccess(attackerResult, defenderResult.findings);\n    const defenseSuccess = defenderResult.findings.defenseEffectiveness;\n\n    cumulativeAttackScore += attackSuccess;\n    cumulativeDefenseScore += defenseSuccess;\n\n    const roundSummary = await generateRoundSummary(round, attackerResult, defenderResult.findings);\n\n    simulationRounds.push({\n      roundNumber: round,\n      attackerFindings: attackerResult,\n      defenderFindings: defenderResult.findings,\n      attackSuccess,\n      defenseSuccess,\n      roundSummary,\n    });\n\n    previousDefenderFindings = defenderResult.findings;\n  }\n\n  onProgress?.(\"synthesis\", rounds, 90, \"Generating purple team feedback...\");\n\n  const purpleTeamFeedback = await generatePurpleTeamFeedback(simulationRounds);\n\n  onProgress?.(\"finalization\", rounds, 95, \"Generating final recommendations...\");\n\n  const finalAttackScore = cumulativeAttackScore / rounds;\n  const finalDefenseScore = cumulativeDefenseScore / rounds;\n  const winner = determineWinner(finalAttackScore, finalDefenseScore);\n\n  const recommendations = await generateSimulationRecommendations(simulationRounds, purpleTeamFeedback);\n  const executiveSummary = await generateExecutiveSummary(\n    assetId, \n    exposureType, \n    simulationRounds, \n    finalAttackScore, \n    finalDefenseScore, \n    winner\n  );\n\n  onProgress?.(\"complete\", rounds, 100, \"AI vs AI simulation complete\");\n\n  return {\n    simulationId: `sim-${Date.now()}`,\n    assetId,\n    exposureType,\n    totalRounds: rounds,\n    rounds: simulationRounds,\n    purpleTeamFeedback,\n    finalAttackScore,\n    finalDefenseScore,\n    winner,\n    recommendations,\n    executiveSummary,\n    totalProcessingTime: Date.now() - startTime,\n  };\n}\n\nfunction buildAttackerContext(\n  context: AgentContext,\n  previousDefenderFindings: DefenderFindings | null,\n  round: number\n): AgentContext {\n  if (!previousDefenderFindings || round === 1) {\n    return context;\n  }\n\n  const adaptedDescription = `${context.description}\n\nATTACKER ADAPTATION (Round ${round}):\nThe defender has implemented the following controls that the attacker is now aware of:\n- Blocked Paths: ${previousDefenderFindings.blockedPaths.map(p => p.attackPath).join(\"; \")}\n- Detection Methods: ${previousDefenderFindings.detectedAttacks.map(d => d.detectionMethod).join(\"; \")}\n- Active Controls: ${previousDefenderFindings.defensiveControls.map(c => c.name).join(\"; \")}\n\nThe attacker must now attempt to evade these defenses or find alternative attack paths.`;\n\n  return {\n    ...context,\n    description: adaptedDescription,\n  };\n}\n\nfunction calculateAttackSuccess(\n  attackerResult: OrchestratorResult,\n  defenderFindings: DefenderFindings\n): number {\n  const baseAttackScore = attackerResult.score / 100;\n  \n  const blockedPathsPenalty = Math.min(defenderFindings.blockedPaths.length * 0.1, 0.3);\n  const detectionPenalty = Math.min(defenderFindings.detectedAttacks.length * 0.05, 0.2);\n  \n  const adjustedScore = Math.max(0, baseAttackScore - blockedPathsPenalty - detectionPenalty);\n  \n  const exploitBonus = attackerResult.exploitable ? 0.1 : 0;\n  \n  return Math.min(1, adjustedScore + exploitBonus);\n}\n\nfunction determineWinner(attackScore: number, defenseScore: number): \"attacker\" | \"defender\" | \"draw\" {\n  const threshold = 0.1;\n  if (attackScore > defenseScore + threshold) {\n    return \"attacker\";\n  } else if (defenseScore > attackScore + threshold) {\n    return \"defender\";\n  }\n  return \"draw\";\n}\n\nasync function generateRoundSummary(\n  round: number,\n  attackerResult: OrchestratorResult,\n  defenderFindings: DefenderFindings\n): Promise<string> {\n  const exploitCount = attackerResult.agentFindings.exploit.exploitChains.length;\n  const detectedCount = defenderFindings.detectedAttacks.length;\n  const blockedCount = defenderFindings.blockedPaths.length;\n  \n  return `Round ${round}: Attacker identified ${exploitCount} exploit chains. ` +\n         `Defender detected ${detectedCount} attacks and blocked ${blockedCount} paths. ` +\n         `Defense effectiveness: ${Math.round(defenderFindings.defenseEffectiveness * 100)}%`;\n}\n\nasync function generatePurpleTeamFeedback(rounds: SimulationRound[]): Promise<PurpleTeamFeedback> {\n  const roundsSummary = rounds.map(r => ({\n    round: r.roundNumber,\n    attackSuccess: r.attackSuccess,\n    defenseSuccess: r.defenseSuccess,\n    exploitsUsed: r.attackerFindings.agentFindings.exploit.exploitChains.map(e => e.name),\n    detectedAttacks: r.defenderFindings.detectedAttacks.map(d => d.attackType),\n    gaps: r.defenderFindings.gapsIdentified,\n  }));\n\n  const systemPrompt = `You are a PURPLE TEAM ANALYST synthesizing attack and defense simulation results.\nProvide actionable feedback that helps both red and blue teams improve.`;\n\n  const userPrompt = `Analyze these simulation rounds and provide purple team feedback:\n\n${JSON.stringify(roundsSummary, null, 2)}\n\nProvide feedback as JSON:\n{\n  \"attackerAdaptations\": [\"How the attacker adapted between rounds\"],\n  \"defenderAdaptations\": [\"How the defender adapted between rounds\"],\n  \"newAttackVectors\": [\"Novel attack vectors that should be tested\"],\n  \"newDefensiveControls\": [\"New controls that should be implemented\"],\n  \"overallInsight\": \"Key insight from the simulation\"\n}`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 1024,\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response from Purple Team Analyst\");\n    }\n\n    return JSON.parse(content) as PurpleTeamFeedback;\n  } catch (error) {\n    console.error(\"Purple team feedback error:\", error);\n    return {\n      attackerAdaptations: [\"Unable to generate adaptations\"],\n      defenderAdaptations: [\"Unable to generate adaptations\"],\n      newAttackVectors: [],\n      newDefensiveControls: [],\n      overallInsight: \"Simulation completed but feedback generation failed.\",\n    };\n  }\n}\n\nasync function generateSimulationRecommendations(\n  rounds: SimulationRound[],\n  feedback: PurpleTeamFeedback\n): Promise<SimulationRecommendation[]> {\n  const lastRound = rounds[rounds.length - 1];\n  const recommendations: SimulationRecommendation[] = [];\n  let idCounter = 1;\n\n  for (const gap of lastRound.defenderFindings.gapsIdentified.slice(0, 3)) {\n    recommendations.push({\n      id: `rec-${idCounter++}`,\n      type: \"defensive\",\n      priority: \"high\",\n      title: `Address defensive gap: ${gap.slice(0, 50)}`,\n      description: gap,\n      effort: \"medium\",\n      impact: \"high\",\n    });\n  }\n\n  for (const improvement of lastRound.defenderFindings.recommendedImprovements.slice(0, 2)) {\n    recommendations.push({\n      id: `rec-${idCounter++}`,\n      type: \"defensive\",\n      priority: \"medium\",\n      title: `Implement improvement: ${improvement.slice(0, 50)}`,\n      description: improvement,\n      effort: \"medium\",\n      impact: \"medium\",\n    });\n  }\n\n  for (const newVector of feedback.newAttackVectors.slice(0, 2)) {\n    recommendations.push({\n      id: `rec-${idCounter++}`,\n      type: \"offensive\",\n      priority: \"medium\",\n      title: `Test new attack vector`,\n      description: newVector,\n      effort: \"low\",\n      impact: \"medium\",\n    });\n  }\n\n  for (const control of feedback.newDefensiveControls.slice(0, 2)) {\n    recommendations.push({\n      id: `rec-${idCounter++}`,\n      type: \"defensive\",\n      priority: \"high\",\n      title: `Deploy new control`,\n      description: control,\n      effort: \"high\",\n      impact: \"high\",\n    });\n  }\n\n  return recommendations;\n}\n\nasync function generateExecutiveSummary(\n  assetId: string,\n  exposureType: string,\n  rounds: SimulationRound[],\n  attackScore: number,\n  defenseScore: number,\n  winner: \"attacker\" | \"defender\" | \"draw\"\n): Promise<string> {\n  const winnerText = winner === \"attacker\" \n    ? \"The attacker was able to successfully exploit vulnerabilities despite defensive measures.\"\n    : winner === \"defender\"\n    ? \"The defender successfully mitigated the majority of attack attempts.\"\n    : \"Neither the attacker nor defender gained a decisive advantage.\";\n\n  return `AI vs AI Security Simulation Report for ${assetId}\n\nExposure Type: ${exposureType}\nSimulation Rounds: ${rounds.length}\n\nRESULTS:\n- Attack Effectiveness: ${Math.round(attackScore * 100)}%\n- Defense Effectiveness: ${Math.round(defenseScore * 100)}%\n- Outcome: ${winner.toUpperCase()} ${winner === \"draw\" ? \"\" : \"WINS\"}\n\n${winnerText}\n\nKEY FINDINGS:\n${rounds.map(r => `Round ${r.roundNumber}: ${r.roundSummary}`).join(\"\\n\")}\n\nThis simulation provides actionable intelligence for improving your security posture by understanding both offensive and defensive perspectives.`;\n}\n","path":null,"size_bytes":12712,"size_tokens":null},"server/services/agents/defender.ts":{"content":"import OpenAI from \"openai\";\nimport type { AgentMemory, AgentResult, ProgressCallback, ExploitFindings, LateralFindings, BusinessLogicFindings, MultiVectorFindings } from \"./types\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\nexport interface DefenderFindings {\n  detectedAttacks: DetectedAttack[];\n  defensiveControls: DefensiveControl[];\n  mitigationActions: MitigationAction[];\n  blockedPaths: BlockedPath[];\n  alertsGenerated: Alert[];\n  defenseEffectiveness: number;\n  gapsIdentified: string[];\n  recommendedImprovements: string[];\n}\n\nexport interface DetectedAttack {\n  id: string;\n  attackType: string;\n  detectionMethod: string;\n  confidence: number;\n  timeToDetect: string;\n  severity: \"critical\" | \"high\" | \"medium\" | \"low\";\n  mitreTechnique?: string;\n}\n\nexport interface DefensiveControl {\n  id: string;\n  controlType: \"preventive\" | \"detective\" | \"corrective\" | \"compensating\";\n  name: string;\n  description: string;\n  effectiveness: number;\n  coverage: string[];\n  limitations: string[];\n}\n\nexport interface MitigationAction {\n  id: string;\n  action: string;\n  target: string;\n  automationLevel: \"manual\" | \"semi-automated\" | \"fully-automated\";\n  timeToExecute: string;\n  effectiveness: number;\n  sideEffects: string[];\n}\n\nexport interface BlockedPath {\n  id: string;\n  attackPath: string;\n  blockedAt: string;\n  blockingControl: string;\n  bypassPossible: boolean;\n  bypassDifficulty?: \"trivial\" | \"low\" | \"medium\" | \"high\" | \"expert\";\n}\n\nexport interface Alert {\n  id: string;\n  alertType: string;\n  severity: \"critical\" | \"high\" | \"medium\" | \"low\" | \"info\";\n  message: string;\n  triggerCondition: string;\n  falsePositiveRisk: \"low\" | \"medium\" | \"high\";\n}\n\nexport async function runDefenderAgent(\n  memory: AgentMemory,\n  onProgress?: ProgressCallback\n): Promise<AgentResult<DefenderFindings>> {\n  const startTime = Date.now();\n  \n  onProgress?.(\"Defender Agent\", \"defense\", 5, \"Initializing defensive analysis...\");\n\n  const attackContext = buildAttackContext(memory);\n\n  const systemPrompt = `You are the DEFENDER AGENT, an AI-powered blue team security system for OdinForge AI.\n\nYour mission is to simulate how a mature security operations center (SOC) would detect and respond to the attacks identified by the red team agents. You must:\n\n1. DETECT: Identify which attacks would be detected by typical security controls (SIEM, EDR, WAF, CSPM, etc.)\n2. PREVENT: Determine which attack paths would be blocked by preventive controls\n3. RESPOND: Propose automated and manual incident response actions\n4. ASSESS: Evaluate the overall defensive posture and identify gaps\n\nThink like an experienced security defender. Be realistic about detection capabilities and response times.\nConsider both technical controls and process-based defenses.`;\n\n  const userPrompt = `Analyze the defensive posture against these identified attacks:\n\nAsset: ${memory.context.assetId}\nExposure Type: ${memory.context.exposureType}\nPriority: ${memory.context.priority}\n\n${attackContext}\n\nProvide your defensive analysis as a JSON object with this structure:\n{\n  \"detectedAttacks\": [\n    {\n      \"id\": \"detect-1\",\n      \"attackType\": \"Type of attack detected\",\n      \"detectionMethod\": \"How it would be detected (SIEM rule, EDR alert, etc.)\",\n      \"confidence\": 0.85,\n      \"timeToDetect\": \"Estimated time (e.g., 'minutes', 'hours', 'days')\",\n      \"severity\": \"critical\" | \"high\" | \"medium\" | \"low\",\n      \"mitreTechnique\": \"T1190 (optional)\"\n    }\n  ],\n  \"defensiveControls\": [\n    {\n      \"id\": \"control-1\",\n      \"controlType\": \"preventive\" | \"detective\" | \"corrective\" | \"compensating\",\n      \"name\": \"Control name\",\n      \"description\": \"What the control does\",\n      \"effectiveness\": 0.75,\n      \"coverage\": [\"list of attack types covered\"],\n      \"limitations\": [\"list of limitations\"]\n    }\n  ],\n  \"mitigationActions\": [\n    {\n      \"id\": \"action-1\",\n      \"action\": \"Specific action to take\",\n      \"target\": \"What to target\",\n      \"automationLevel\": \"manual\" | \"semi-automated\" | \"fully-automated\",\n      \"timeToExecute\": \"Estimated time\",\n      \"effectiveness\": 0.90,\n      \"sideEffects\": [\"potential side effects\"]\n    }\n  ],\n  \"blockedPaths\": [\n    {\n      \"id\": \"block-1\",\n      \"attackPath\": \"Description of blocked attack path\",\n      \"blockedAt\": \"Where in the kill chain\",\n      \"blockingControl\": \"What blocked it\",\n      \"bypassPossible\": true,\n      \"bypassDifficulty\": \"medium\"\n    }\n  ],\n  \"alertsGenerated\": [\n    {\n      \"id\": \"alert-1\",\n      \"alertType\": \"SIEM/EDR/WAF/Custom\",\n      \"severity\": \"high\",\n      \"message\": \"Alert message\",\n      \"triggerCondition\": \"What triggers this alert\",\n      \"falsePositiveRisk\": \"low\" | \"medium\" | \"high\"\n    }\n  ],\n  \"defenseEffectiveness\": 0.65,\n  \"gapsIdentified\": [\"List of defensive gaps\"],\n  \"recommendedImprovements\": [\"List of recommended improvements\"]\n}`;\n\n  try {\n    onProgress?.(\"Defender Agent\", \"detection\", 20, \"Analyzing detection capabilities...\");\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      response_format: { type: \"json_object\" },\n      max_completion_tokens: 4096,\n    });\n\n    onProgress?.(\"Defender Agent\", \"controls\", 40, \"Evaluating defensive controls...\");\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response from Defender Agent\");\n    }\n\n    const findings = JSON.parse(content) as DefenderFindings;\n    \n    onProgress?.(\"Defender Agent\", \"mitigation\", 60, \"Planning mitigation actions...\");\n\n    const validatedFindings: DefenderFindings = {\n      detectedAttacks: Array.isArray(findings.detectedAttacks) ? findings.detectedAttacks : [],\n      defensiveControls: Array.isArray(findings.defensiveControls) ? findings.defensiveControls : [],\n      mitigationActions: Array.isArray(findings.mitigationActions) ? findings.mitigationActions : [],\n      blockedPaths: Array.isArray(findings.blockedPaths) ? findings.blockedPaths : [],\n      alertsGenerated: Array.isArray(findings.alertsGenerated) ? findings.alertsGenerated : [],\n      defenseEffectiveness: typeof findings.defenseEffectiveness === \"number\" ? findings.defenseEffectiveness : 0.5,\n      gapsIdentified: Array.isArray(findings.gapsIdentified) ? findings.gapsIdentified : [],\n      recommendedImprovements: Array.isArray(findings.recommendedImprovements) ? findings.recommendedImprovements : [],\n    };\n\n    onProgress?.(\"Defender Agent\", \"complete\", 100, \"Defensive analysis complete\");\n\n    return {\n      success: true,\n      findings: validatedFindings,\n      agentName: \"Defender Agent\",\n      processingTime: Date.now() - startTime,\n    };\n  } catch (error) {\n    console.error(\"Defender Agent error:\", error);\n    throw error;\n  }\n}\n\nfunction buildAttackContext(memory: AgentMemory): string {\n  const sections: string[] = [];\n\n  if (memory.exploit) {\n    sections.push(`\nEXPLOIT FINDINGS:\n- Exploitable: ${memory.exploit.exploitable}\n- Exploit Chains: ${memory.exploit.exploitChains.map(c => `${c.name} (${c.technique})`).join(\", \")}\n- CVEs: ${memory.exploit.cveReferences.join(\", \")}\n- Misconfigurations: ${memory.exploit.misconfigurations.join(\", \")}`);\n  }\n\n  if (memory.lateral) {\n    sections.push(`\nLATERAL MOVEMENT:\n- Pivot Paths: ${memory.lateral.pivotPaths.map(p => `${p.from} -> ${p.to} via ${p.method}`).join(\"; \")}\n- Privilege Escalation: ${memory.lateral.privilegeEscalation.map(p => `${p.target} (${p.likelihood})`).join(\", \")}\n- Token Reuse Opportunities: ${memory.lateral.tokenReuse.join(\", \")}`);\n  }\n\n  if (memory.businessLogic) {\n    sections.push(`\nBUSINESS LOGIC ATTACKS:\n- Workflow Abuse: ${memory.businessLogic.workflowAbuse.join(\", \")}\n- State Manipulation: ${memory.businessLogic.stateManipulation.join(\", \")}\n- Race Conditions: ${memory.businessLogic.raceConditions.join(\", \")}\n- Authorization Bypass: ${memory.businessLogic.authorizationBypass.join(\", \")}`);\n  }\n\n  if (memory.multiVector) {\n    sections.push(`\nMULTI-VECTOR ATTACKS:\n- Cloud Findings: ${memory.multiVector.cloudFindings.length} issues\n- IAM Findings: ${memory.multiVector.iamFindings.length} issues\n- SaaS Findings: ${memory.multiVector.saasFindings.length} issues\n- Chained Attack Paths: ${memory.multiVector.chainedAttackPaths.map(p => p.name).join(\", \")}`);\n  }\n\n  return sections.join(\"\\n\") || \"No specific attack findings available.\";\n}\n","path":null,"size_bytes":8524,"size_tokens":null},"docs/implementation-gaps.md":{"content":"# OdinForge Platform - Implementation Gap Analysis\n\n## Document Purpose\nThis document tracks the gaps between the product implementation status document and the actual codebase implementation.\n\n## Last Updated\nDecember 17, 2025\n\n---\n\n## Gap Summary\n\n| Category | Feature | Document Status | Actual Status | Priority |\n|----------|---------|-----------------|---------------|----------|\n| Authentication | mTLS for agents | \"Implemented\" | **IMPLEMENTED** | ~~Medium~~ Done |\n| Authentication | JWT tenant auth | \"Implemented\" | **IMPLEMENTED** | ~~Low~~ Done |\n| Agent | Go/Node.js collector | \"Implemented\" | Python only | Low |\n| Scheduling | Scheduled scan execution | Implied automatic | CRUD only - no scheduler | Medium |\n| AI Simulation | AI vs AI simulation | \"Implemented\" | **IMPLEMENTED** | ~~High~~ Done |\n| AI Simulation | Purple team feedback | \"Implemented\" | **IMPLEMENTED** | ~~High~~ Done |\n| AI Profiles | Adversary profiles | \"Implemented\" | **IMPLEMENTED** | ~~Medium~~ Done |\n\n---\n\n## Detailed Analysis\n\n### 1. Authentication - **IMPLEMENTED (Development/Testing)**\n\n#### mTLS Certificate Infrastructure\n- **Status**: **IMPLEMENTED** (Application-layer trust store)\n- **Implementation Details**:\n  - **mTLS Service** (`server/services/mtls-auth.ts`): X.509 certificate generation with proper ASN.1 DER encoding\n  - **Certificate Features**: RSA 2048-bit keys, SHA-256 fingerprints, proper certificate structure\n  - **Trust Store**: In-memory certificate registry with fingerprint indexing\n  - **Lifecycle Management**: Generate, renew, revoke certificates for agents\n  - **Unified Auth** (`server/services/unified-auth.ts`): Supports API Key, certificate fingerprint, and JWT authentication\n\n**Development vs Production**:\n- Current: Application-layer validation using certificate fingerprints (suitable for dev/testing)\n- Production: Would require TLS termination with `requestCert: true` and CA infrastructure\n\n#### JWT Tenant Authentication\n- **Status**: **FULLY IMPLEMENTED**\n- **Implementation Details**:\n  - **JWT Service** (`server/services/jwt-auth.ts`): HMAC-SHA256 token signing and validation\n  - **Security Features**: Issuer/audience validation, expiration checks, revocation support\n  - **Multi-tenant Support**: Create and manage tenants with configurable scopes\n  - **Token Lifecycle**: Access tokens (1hr default) + refresh tokens (7 days default)\n  - **Scope-based Authorization**: Read, write, admin scopes per tenant\n\n#### API Endpoints\n- `POST /api/agents/:id/certificates` - Generate certificate for agent\n- `GET /api/agents/:id/certificates` - List agent certificates\n- `POST /api/agents/:id/certificates/:certId/renew` - Renew certificate\n- `DELETE /api/agents/:id/certificates/:certId` - Revoke certificate\n- `POST /api/agents/:id/tokens` - Generate JWT tokens for agent\n- `POST /api/auth/refresh` - Refresh JWT tokens\n- `POST /api/agents/:id/revoke-all` - Revoke all credentials\n- `GET /api/agents/:id/auth-status` - Get agent auth status\n- `POST /api/tenants` - Create tenant\n- `GET /api/tenants` - List tenants\n- `GET /api/tenants/:id` - Get tenant details\n- `DELETE /api/tenants/:id` - Deactivate tenant\n- `GET /api/auth/config` - Get auth configuration\n- `PATCH /api/auth/config` - Update auth configuration\n\n#### Security Measures Implemented\n- **Admin Authentication**: All credential management endpoints protected by `requireAdminAuth` middleware\n  - Requires authenticated session (Replit Auth) OR\n  - Admin API key header (`X-Admin-Key` matching `ADMIN_API_KEY` env var) OR\n  - Development mode warning (no auth required when `NODE_ENV=development` and no `ADMIN_API_KEY` set)\n- **Audit Logging**: All credential operations logged with `[AUDIT]` prefix\n- **Shared Secret for mTLS Headers**: When `MTLS_SHARED_SECRET` env var is configured, agents must provide matching `X-Cert-Secret` header to prevent header spoofing\n- **Timing-Safe Comparison**: Secret validation uses `crypto.timingSafeEqual` to prevent timing attacks\n- **JWT Signing Key**: Uses `SESSION_SECRET` env var (falls back to dev secret)\n\n#### Environment Variables\n| Variable | Purpose | Required |\n|----------|---------|----------|\n| `SESSION_SECRET` | JWT signing key | Yes (production) |\n| `ADMIN_API_KEY` | Admin authentication for credential endpoints | Recommended |\n| `MTLS_SHARED_SECRET` | Shared secret for mTLS header validation | Recommended |\n\n#### Production Deployment Notes\nFor production deployment with true mTLS:\n1. Configure reverse proxy (nginx/envoy) with client certificate validation\n2. Use a proper CA infrastructure (e.g., HashiCorp Vault, AWS Private CA)\n3. Pass validated certificate info via trusted headers (X-SSL-Client-Cert)\n4. Set `ADMIN_API_KEY` environment variable for credential management protection\n5. Set `MTLS_SHARED_SECRET` to prevent header spoofing attacks\n6. Use secrets management for JWT signing keys (rotate `SESSION_SECRET` periodically)\n\n### 2. Agent Collector\n\n#### Sample Agent Language\n- **Claimed**: \"OdinForge Collector Agent (Go or Node.js)\"\n- **Reality**: Go agent at `odinforge-agent/` with full deployment system\n- **Status**: **FULLY IMPLEMENTED**\n- **Features**:\n  - Cross-platform support (Linux, macOS, Windows)\n  - Auto-install CLI with environment detection (Docker, Kubernetes, systemd, launchd)\n  - Deployment manifests for Docker Compose, Kubernetes DaemonSet, systemd, and launchd\n  - Offline resilience with BoltDB queue\n  - Optional mTLS and SPKI pinning\n\n### 3. Scheduled Scans\n\n#### Automatic Execution\n- **Claimed**: Implied that scheduled scans run automatically\n- **Reality**: CRUD endpoints exist for scheduling configuration, but no cron job or scheduler executes them\n- **APIs Available**: \n  - POST /api/scheduled-scans\n  - GET /api/scheduled-scans\n  - PATCH /api/scheduled-scans/:id\n  - DELETE /api/scheduled-scans/:id\n- **Missing**: Scheduler service that checks for due scans and triggers evaluations\n- **Recommendation**: Implement scheduler using node-cron or similar\n\n### 4. AI vs AI Simulation - **IMPLEMENTED**\n\n#### Attacker/Defender Simulation\n- **Status**: **FULLY IMPLEMENTED**\n- **Implementation Details**:\n  - **Defender AI Agent** (`server/services/agents/defender.ts`): Detects attacks, recommends responses, assesses control effectiveness\n  - **AI Simulation Orchestrator** (`server/services/agents/ai-simulation.ts`): Runs iterative attack/defense cycles\n  - **Configurable Rounds**: 1-10 rounds of attack/defense simulation\n  - **Scoring System**: Tracks attacker success rate vs defender block rate\n\n#### Purple Team Feedback Loops\n- **Status**: **FULLY IMPLEMENTED**\n- **Implementation Details**:\n  - Defender findings inform attacker strategy adjustments\n  - Iterative attack/defense rounds with learning\n  - Purple team recommendations generated after simulation\n  - Actionable findings with priority levels\n\n#### API Endpoints\n- `POST /api/simulations` - Create and start a new simulation\n- `GET /api/simulations` - List all simulations\n- `GET /api/simulations/:id` - Get specific simulation details\n- `DELETE /api/simulations/:id` - Delete a simulation\n\n#### Frontend Page (`/simulations`)\n- Simulation creation dialog with:\n  - Target asset ID\n  - Exposure type selection\n  - Priority level\n  - Number of rounds (1-10)\n  - Scenario description\n- Simulation list with status badges (running/completed/failed)\n- Results view showing:\n  - Attacker performance percentage\n  - Defender performance percentage\n  - Attack path used\n  - Detection points\n  - Gaps identified\n  - Purple team recommendations\n\n### 5. Adversary Profiles - **IMPLEMENTED**\n\n#### Profile Usage\n- **Status**: **FULLY IMPLEMENTED**\n- **Claimed**: \"5 adversary profiles\" actively used\n- **Implementation Details**:\n  - Schema defined in `shared/schema.ts`:\n    - script_kiddie\n    - organized_crime\n    - nation_state\n    - insider_threat\n    - apt_group\n  - Database table `ai_adversary_profiles` exists with capabilities:\n    - Technical sophistication (1-10)\n    - Resources level (1-10)\n    - Persistence (1-10)\n    - Stealth (1-10)\n  - **Profile-Aware AI Agents**: All agents in orchestrator pipeline receive profile context\n  - **Behavioral Adaptation**: Profile capabilities modify agent prompts:\n    - script_kiddie: Basic techniques, low sophistication\n    - nation_state: Advanced TTPs, high stealth, extensive resources\n  - **Frontend Integration**: \n    - Profile selector in NewEvaluationModal and EvaluationWizard\n    - Profile displays in evaluation cards and details\n\n#### API Integration\n- `POST /api/aev/evaluate` - Accepts optional `adversaryProfile` field\n- Profile context passed through orchestrator to all AI agents\n- Attack path generation influenced by profile capabilities\n\n---\n\n## Implementation Priorities\n\n### Completed (Previously High Priority)\n1. ~~**AI vs AI Simulation**~~ - **DONE** - Full implementation with Defender AI, Simulation Orchestrator, API, and UI\n2. ~~**Purple Team Feedback**~~ - **DONE** - Integrated with simulation system\n3. ~~**Adversary Profile Integration**~~ - **DONE** - Profiles integrated into AI orchestrator pipeline, frontend selectors added\n4. ~~**mTLS Certificate Infrastructure**~~ - **DONE** - X.509 certificate generation with ASN.1 DER encoding, trust store validation (dev/testing ready)\n5. ~~**JWT Tenant Authentication**~~ - **DONE** - Multi-tenant JWT auth with HMAC-SHA256 and scopes implemented\n6. ~~**Unified Auth Middleware**~~ - **DONE** - Supports API keys, certificate fingerprints, and JWT tokens\n\n### Remaining (Medium Priority)\n7. **Scheduled Scan Execution** - CRUD exists, needs scheduler service (node-cron)\n8. **Production mTLS** - Would need reverse proxy configuration and CA infrastructure\n\n### Documentation Updates (Low Priority)\n9. ~~Update document to reflect agent language~~ - **DONE** - Go agent fully implemented\n\n---\n\n## Features Confirmed as Fully Implemented\n\n- 15 Exposure Types (Traditional, Cloud/IAM, Business Logic)\n- AI Agent Pipeline (Recon, Exploit, Lateral, Business Logic, Multi-Vector, Impact)\n- **Defender AI Agent** (detection, response recommendations, control assessment)\n- **AI vs AI Simulation System** (iterative attack/defense cycles)\n- **Purple Team Feedback** (actionable recommendations from simulations)\n- **Adversary Profiles** (5 profiles with AI behavioral adaptation)\n- **mTLS Authentication** (certificate lifecycle management for agents)\n- **JWT Tenant Authentication** (multi-tenant token auth with scopes)\n- **Unified Auth Middleware** (API Key + mTLS + JWT support)\n- Evidence Artifacts & Intelligent Scoring\n- Remediation System with audience-specific views\n- Evaluation Lifecycle Management (archive/restore/delete)\n- Batch Processing & Reporting (CSV, JSON, PDF)\n- Governance Controls (execution modes, kill switch, rate limiting)\n- Infrastructure Data Ingestion (assets, vulnerabilities, cloud connections)\n- Endpoint Agent System (registration, telemetry, auto-evaluation triggers)\n- Risk Dashboard with visualizations\n- Evaluation Wizard for non-technical users\n- Simulations Page with creation dialog and results view\n\n---\n\n## Complete Status Summary (Bullet Format)\n\n### Fully Implemented Features\n\n**Core AI Analysis**\n- CVE exploitation analysis\n- Configuration weakness detection\n- Behavioral anomaly detection\n- Network vulnerability assessment\n- Cloud misconfiguration detection\n- IAM privilege abuse analysis\n- SaaS permission misuse detection\n- Shadow admin discovery\n- API sequence abuse detection\n- Payment flow bypass detection\n- Subscription bypass detection\n- State machine violation detection\n- Privilege boundary violation detection\n- Workflow desynchronization detection\n- Order lifecycle abuse detection\n\n**AI Agent System**\n- Recon Agent - attack surface mapping\n- Exploit Agent - vulnerability exploitation analysis\n- Lateral Movement Agent - lateral path discovery\n- Business Logic Agent - workflow abuse detection\n- Multi-Vector Agent - combined attack analysis\n- Impact Agent - business impact assessment\n- Synthesizer Agent - findings consolidation\n- Graph Synthesizer - attack path visualization\n- Scoring Engine - intelligent risk scoring\n- Defender Agent - attack detection and response\n- AI Simulation Orchestrator - attack/defense cycles\n\n**AI vs AI Simulation System**\n- Simulation creation with configurable rounds\n- Attacker AI using full agent pipeline\n- Defender AI with detection capabilities\n- Iterative attack/defense cycles\n- Purple team feedback generation\n- Simulation results with performance metrics\n- API endpoints for simulation management\n- Frontend page at /simulations\n\n**User Interface**\n- Main dashboard with evaluation statistics\n- Evaluation Wizard for non-technical users\n- Grouped exposure-type selector\n- Business Logic Findings panel\n- Multi-Vector Findings panel\n- Animated Attack Graph visualization\n- Risk Heatmap (exploitability x business impact)\n- Time-to-Compromise meter\n- AI Confidence gauge\n- Evidence Artifacts panel\n- Intelligent Scoring panel\n- Remediation panel with Executive/Engineer views\n- Risk Dashboard (/risk)\n- Reports page with PDF/CSV/JSON export\n- Batch Jobs page\n- Governance page\n- Agents Dashboard (/agents)\n- Simulations page (/simulations)\n- Infrastructure page with tabs\n\n**Backend Services**\n- AEV evaluation engine\n- WebSocket real-time updates\n- Report generator (executive, technical, compliance)\n- Agent orchestrator\n- Evidence collection system\n- Remediation engine\n\n**Data Ingestion**\n- CSV import\n- JSON import\n- Nessus XML import\n- Qualys import\n- Cloud connection management (AWS, Azure, GCP)\n- Discovered assets tracking\n- Vulnerability imports\n\n**Endpoint Agent System**\n- Agent registration with secure API keys\n- Bcrypt hashing for API key storage\n- Telemetry ingestion (metrics, services, ports)\n- Security findings ingestion\n- Automatic deduplication\n- Auto-evaluation triggers for critical findings\n- Go agent with cross-platform deployment (Docker, K8s, systemd, launchd, Windows)\n\n**Governance & Safety**\n- Execution modes (Safe/Live/Simulation)\n- Emergency kill switch\n- Rate limiting per organization\n- Target scoping and whitelisting\n- Authorization logging\n\n**Evaluation Lifecycle**\n- Create evaluations\n- Archive evaluations\n- Restore archived evaluations\n- Permanent deletion with confirmation\n- Status tracking (pending, running, completed, failed)\n\n### Partially Implemented Features\n\n**Adversary Profiles**\n- Schema defined (5 profiles)\n- Database table exists\n- NOT wired into AI agents\n- NOT used in attack sophistication variation\n\n**Scheduled Scans**\n- CRUD API endpoints exist\n- Configuration storage works\n- NO scheduler service to execute scans\n\n### Not Implemented Features\n\n**Authentication Enhancements**\n- mTLS for agent communication\n- JWT tenant authentication\n\n**Agent Variations**\n- Go collector agent - **IMPLEMENTED** with full deployment system\n- Node.js collector agent - Not needed (Go agent covers all platforms)\n\n","path":null,"size_bytes":14882,"size_tokens":null},"server/services/agents/adversary-profile.ts":{"content":"import type { AdversaryProfile } from \"@shared/schema\";\n\nexport interface AdversaryProfileConfig {\n  profileType: AdversaryProfile;\n  technicalSophistication: number;\n  resources: number;\n  persistence: number;\n  stealth: number;\n  targetedAttacks: boolean;\n  zerodays: boolean;\n  socialEngineering: boolean;\n  physicalAccess: boolean;\n  typicalTTPs: string[];\n  motivations: string[];\n  avgDwellTime: number;\n  detectionDifficulty: \"low\" | \"medium\" | \"high\" | \"very_high\";\n  attackStyle: string;\n  toolsUsed: string[];\n  evasionTechniques: string[];\n}\n\nexport const defaultAdversaryProfiles: Record<AdversaryProfile, AdversaryProfileConfig> = {\n  script_kiddie: {\n    profileType: \"script_kiddie\",\n    technicalSophistication: 2,\n    resources: 1,\n    persistence: 2,\n    stealth: 1,\n    targetedAttacks: false,\n    zerodays: false,\n    socialEngineering: false,\n    physicalAccess: false,\n    typicalTTPs: [\n      \"T1190\", // Exploit Public-Facing Application\n      \"T1078\", // Valid Accounts (leaked credentials)\n      \"T1110\", // Brute Force\n      \"T1059\", // Command and Scripting Interpreter\n    ],\n    motivations: [\"curiosity\", \"notoriety\", \"minor_financial\"],\n    avgDwellTime: 1,\n    detectionDifficulty: \"low\",\n    attackStyle: \"Uses publicly available exploit tools and scripts without deep understanding. Relies on automated scanners and default exploits. Easily detected by standard security controls.\",\n    toolsUsed: [\"Metasploit (default modules)\", \"SQLmap\", \"Nmap\", \"Nikto\", \"Public exploit scripts\"],\n    evasionTechniques: [\"None - uses tools without modification\"],\n  },\n  opportunistic_criminal: {\n    profileType: \"opportunistic_criminal\",\n    technicalSophistication: 4,\n    resources: 3,\n    persistence: 4,\n    stealth: 3,\n    targetedAttacks: false,\n    zerodays: false,\n    socialEngineering: true,\n    physicalAccess: false,\n    typicalTTPs: [\n      \"T1566\", // Phishing\n      \"T1486\", // Data Encrypted for Impact (ransomware)\n      \"T1082\", // System Information Discovery\n      \"T1005\", // Data from Local System\n      \"T1071\", // Application Layer Protocol\n    ],\n    motivations: [\"financial_gain\", \"ransomware\", \"data_theft\"],\n    avgDwellTime: 7,\n    detectionDifficulty: \"medium\",\n    attackStyle: \"Opportunistic attacker seeking easy financial gains. Uses phishing campaigns and commodity malware. Will deploy ransomware or steal data for sale. Some operational security but not highly sophisticated.\",\n    toolsUsed: [\"Cobalt Strike (cracked)\", \"Phishing kits\", \"Commodity RATs\", \"Ransomware-as-a-Service\"],\n    evasionTechniques: [\"Basic obfuscation\", \"Encrypted C2\", \"Living off the land basics\"],\n  },\n  organized_crime: {\n    profileType: \"organized_crime\",\n    technicalSophistication: 6,\n    resources: 7,\n    persistence: 7,\n    stealth: 6,\n    targetedAttacks: true,\n    zerodays: false,\n    socialEngineering: true,\n    physicalAccess: false,\n    typicalTTPs: [\n      \"T1566.001\", // Spearphishing Attachment\n      \"T1195\", // Supply Chain Compromise\n      \"T1021\", // Remote Services\n      \"T1486\", // Data Encrypted for Impact\n      \"T1567\", // Exfiltration Over Web Service\n      \"T1070\", // Indicator Removal\n    ],\n    motivations: [\"financial_gain\", \"extortion\", \"data_theft\", \"fraud\"],\n    avgDwellTime: 30,\n    detectionDifficulty: \"high\",\n    attackStyle: \"Well-funded criminal organization with dedicated operators. Uses custom tooling and sophisticated tactics. Targets high-value organizations for maximum financial return. Will persist for extended periods to maximize extraction.\",\n    toolsUsed: [\"Custom loaders\", \"Private exploit kits\", \"Commercial C2 frameworks\", \"Custom ransomware variants\"],\n    evasionTechniques: [\"Process injection\", \"Timestomping\", \"Log deletion\", \"Anti-forensics\", \"Encrypted tunneling\"],\n  },\n  insider_threat: {\n    profileType: \"insider_threat\",\n    technicalSophistication: 5,\n    resources: 4,\n    persistence: 8,\n    stealth: 7,\n    targetedAttacks: true,\n    zerodays: false,\n    socialEngineering: false,\n    physicalAccess: true,\n    typicalTTPs: [\n      \"T1078\", // Valid Accounts\n      \"T1083\", // File and Directory Discovery\n      \"T1005\", // Data from Local System\n      \"T1048\", // Exfiltration Over Alternative Protocol\n      \"T1552\", // Unsecured Credentials\n      \"T1213\", // Data from Information Repositories\n    ],\n    motivations: [\"revenge\", \"financial_gain\", \"espionage\", \"sabotage\"],\n    avgDwellTime: 180,\n    detectionDifficulty: \"very_high\",\n    attackStyle: \"Trusted insider with legitimate access. Uses authorized credentials and knows internal systems intimately. Actions blend with normal behavior. May exfiltrate data slowly over time or sabotage systems before leaving.\",\n    toolsUsed: [\"Legitimate admin tools\", \"Personal cloud storage\", \"USB devices\", \"Personal email\"],\n    evasionTechniques: [\"Legitimate access patterns\", \"Data hiding in allowed traffic\", \"Slow exfiltration\", \"Credential reuse\"],\n  },\n  nation_state: {\n    profileType: \"nation_state\",\n    technicalSophistication: 9,\n    resources: 10,\n    persistence: 10,\n    stealth: 9,\n    targetedAttacks: true,\n    zerodays: true,\n    socialEngineering: true,\n    physicalAccess: true,\n    typicalTTPs: [\n      \"T1195.002\", // Supply Chain Compromise: Software Supply Chain\n      \"T1210\", // Exploitation of Remote Services\n      \"T1055\", // Process Injection\n      \"T1003\", // OS Credential Dumping\n      \"T1570\", // Lateral Tool Transfer\n      \"T1041\", // Exfiltration Over C2 Channel\n      \"T1027\", // Obfuscated Files or Information\n      \"T1562\", // Impair Defenses\n    ],\n    motivations: [\"espionage\", \"intellectual_property_theft\", \"infrastructure_disruption\", \"strategic_advantage\"],\n    avgDwellTime: 365,\n    detectionDifficulty: \"very_high\",\n    attackStyle: \"State-sponsored actor with unlimited resources and patience. Uses zero-days, custom implants, and sophisticated tradecraft. Targets strategic assets for long-term intelligence collection. Employs advanced evasion and may compromise supply chains.\",\n    toolsUsed: [\"Zero-day exploits\", \"Custom implants\", \"Hardware implants\", \"Supply chain compromises\", \"Proprietary C2 infrastructure\"],\n    evasionTechniques: [\"Firmware-level persistence\", \"Living off the land\", \"Traffic blending\", \"Counter-intelligence\", \"Multi-stage payloads\", \"Steganography\"],\n  },\n  apt_group: {\n    profileType: \"apt_group\",\n    technicalSophistication: 8,\n    resources: 8,\n    persistence: 9,\n    stealth: 8,\n    targetedAttacks: true,\n    zerodays: true,\n    socialEngineering: true,\n    physicalAccess: false,\n    typicalTTPs: [\n      \"T1566.002\", // Spearphishing Link\n      \"T1204\", // User Execution\n      \"T1036\", // Masquerading\n      \"T1055\", // Process Injection\n      \"T1003\", // OS Credential Dumping\n      \"T1560\", // Archive Collected Data\n      \"T1041\", // Exfiltration Over C2 Channel\n    ],\n    motivations: [\"espionage\", \"intellectual_property_theft\", \"sabotage\"],\n    avgDwellTime: 200,\n    detectionDifficulty: \"very_high\",\n    attackStyle: \"Advanced Persistent Threat group with defined objectives. Uses custom malware, sophisticated spearphishing, and patient approach. Maintains long-term access and adapts to defensive measures. May have nation-state backing.\",\n    toolsUsed: [\"Custom malware families\", \"Modified open-source tools\", \"Living off the land binaries\", \"Custom C2 protocols\"],\n    evasionTechniques: [\"Fileless malware\", \"Memory-only execution\", \"DLL side-loading\", \"Encrypted C2\", \"Time-based execution\", \"Anti-analysis techniques\"],\n  },\n  hacktivist: {\n    profileType: \"hacktivist\",\n    technicalSophistication: 5,\n    resources: 4,\n    persistence: 6,\n    stealth: 3,\n    targetedAttacks: true,\n    zerodays: false,\n    socialEngineering: true,\n    physicalAccess: false,\n    typicalTTPs: [\n      \"T1498\", // Network Denial of Service\n      \"T1491\", // Defacement\n      \"T1190\", // Exploit Public-Facing Application\n      \"T1213\", // Data from Information Repositories\n      \"T1565\", // Data Manipulation\n    ],\n    motivations: [\"ideology\", \"political_statement\", \"activism\", \"public_attention\"],\n    avgDwellTime: 3,\n    detectionDifficulty: \"medium\",\n    attackStyle: \"Ideologically motivated attacker seeking public attention. Uses DDoS, website defacement, and data leaks. Often announces attacks publicly. Variable skill levels within groups. More focused on impact and publicity than stealth.\",\n    toolsUsed: [\"DDoS tools\", \"Web exploitation frameworks\", \"Social media for coordination\", \"Leak sites\"],\n    evasionTechniques: [\"VPNs\", \"Tor\", \"Botnets for DDoS\", \"Minimal - focus on impact not stealth\"],\n  },\n  competitor: {\n    profileType: \"competitor\",\n    technicalSophistication: 6,\n    resources: 7,\n    persistence: 7,\n    stealth: 8,\n    targetedAttacks: true,\n    zerodays: false,\n    socialEngineering: true,\n    physicalAccess: false,\n    typicalTTPs: [\n      \"T1566\", // Phishing\n      \"T1078\", // Valid Accounts\n      \"T1213\", // Data from Information Repositories\n      \"T1552\", // Unsecured Credentials\n      \"T1048\", // Exfiltration Over Alternative Protocol\n    ],\n    motivations: [\"competitive_intelligence\", \"trade_secrets\", \"strategic_planning\", \"market_advantage\"],\n    avgDwellTime: 90,\n    detectionDifficulty: \"high\",\n    attackStyle: \"Corporate espionage actor seeking competitive advantage. May hire contractors or criminal groups. Targets R&D, sales data, pricing strategies, and strategic plans. Focuses on data theft rather than disruption. Highly motivated to remain undetected.\",\n    toolsUsed: [\"Commercial spyware\", \"Hired penetration testers\", \"Social engineering contractors\", \"Insider recruitment\"],\n    evasionTechniques: [\"Legitimate-looking traffic\", \"Cloud service abuse\", \"Long-term credential theft\", \"Insider placement\"],\n  },\n};\n\nexport function getAdversaryProfileConfig(profileType: AdversaryProfile): AdversaryProfileConfig {\n  return defaultAdversaryProfiles[profileType];\n}\n\nexport function generateAdversaryPromptContext(profileType: AdversaryProfile): string {\n  const profile = getAdversaryProfileConfig(profileType);\n  \n  return `\nADVERSARY SIMULATION CONTEXT:\nYou are simulating an attack from the perspective of a \"${profile.profileType.replace(/_/g, \" \").toUpperCase()}\" threat actor.\n\nADVERSARY CHARACTERISTICS:\n- Technical Sophistication: ${profile.technicalSophistication}/10\n- Resources: ${profile.resources}/10\n- Persistence: ${profile.persistence}/10\n- Stealth: ${profile.stealth}/10\n- Average Dwell Time: ${profile.avgDwellTime} days\n- Detection Difficulty: ${profile.detectionDifficulty}\n\nADVERSARY CAPABILITIES:\n- Uses Zero-day Exploits: ${profile.zerodays ? \"Yes\" : \"No\"}\n- Social Engineering: ${profile.socialEngineering ? \"Yes\" : \"No\"}\n- Targeted Attacks: ${profile.targetedAttacks ? \"Yes\" : \"No\"}\n- Physical Access: ${profile.physicalAccess ? \"Yes\" : \"No\"}\n\nATTACK STYLE:\n${profile.attackStyle}\n\nTYPICAL TOOLS:\n${profile.toolsUsed.join(\", \")}\n\nTYPICAL TTPs (MITRE ATT&CK):\n${profile.typicalTTPs.join(\", \")}\n\nEVASION TECHNIQUES:\n${profile.evasionTechniques.join(\", \")}\n\nMOTIVATIONS:\n${profile.motivations.join(\", \")}\n\nSIMULATION INSTRUCTIONS:\n- Generate attack paths and techniques consistent with this adversary profile\n- Consider the adversary's resource limitations and sophistication level\n- A script kiddie would not use zero-days or sophisticated evasion\n- A nation-state actor would use patient, stealthy approaches\n- Match exploit complexity to the adversary's technical sophistication\n- Consider typical dwell time in attack timeline estimates\n`;\n}\n\nexport function adjustFindingsForProfile(\n  profileType: AdversaryProfile,\n  findings: any\n): any {\n  const profile = getAdversaryProfileConfig(profileType);\n  \n  if (profileType === \"script_kiddie\") {\n    if (findings.exploitChains) {\n      findings.exploitChains = findings.exploitChains.filter(\n        (chain: any) => chain.success_likelihood !== \"low\" || chain.technique?.startsWith(\"T1190\") || chain.technique?.startsWith(\"T1110\")\n      ).slice(0, 3);\n    }\n  }\n  \n  if (profileType === \"nation_state\" || profileType === \"apt_group\") {\n    if (findings.exploitChains) {\n      findings.exploitChains = findings.exploitChains.map((chain: any) => ({\n        ...chain,\n        stealth_approach: \"Uses advanced evasion techniques to avoid detection\",\n        patience_factor: \"Will wait for optimal timing and conditions\",\n      }));\n    }\n  }\n  \n  return findings;\n}\n","path":null,"size_bytes":12386,"size_tokens":null},"server/services/jwt-auth.ts":{"content":"import { randomUUID } from \"crypto\";\nimport * as crypto from \"crypto\";\n\nexport interface JWTPayload {\n  sub: string;\n  iss: string;\n  aud: string;\n  iat: number;\n  exp: number;\n  organizationId: string;\n  tenantId?: string;\n  agentId?: string;\n  scopes: string[];\n  type: \"access\" | \"refresh\";\n}\n\nexport interface TokenPair {\n  accessToken: string;\n  refreshToken: string;\n  accessTokenExpiresAt: Date;\n  refreshTokenExpiresAt: Date;\n}\n\nexport interface TokenValidationResult {\n  valid: boolean;\n  payload?: JWTPayload;\n  error?: string;\n}\n\nexport interface TenantConfig {\n  id: string;\n  organizationId: string;\n  name: string;\n  secretKey: string;\n  accessTokenTTL: number;\n  refreshTokenTTL: number;\n  allowedScopes: string[];\n  createdAt: Date;\n  updatedAt: Date;\n  active: boolean;\n}\n\nclass JWTAuthService {\n  private tenants: Map<string, TenantConfig> = new Map();\n  private refreshTokens: Map<string, { tokenId: string; payload: JWTPayload; expiresAt: Date }> = new Map();\n  private revokedTokens: Set<string> = new Set();\n  \n  private readonly ISSUER = \"odinforge-aev\";\n  private readonly AUDIENCE = \"odinforge-api\";\n  private readonly DEFAULT_ACCESS_TOKEN_TTL = 3600;\n  private readonly DEFAULT_REFRESH_TOKEN_TTL = 86400 * 7;\n  private readonly JWT_SECRET = process.env.SESSION_SECRET || \"odinforge-jwt-secret-dev\";\n  \n  async createTenant(config: {\n    organizationId: string;\n    name: string;\n    allowedScopes?: string[];\n    accessTokenTTL?: number;\n    refreshTokenTTL?: number;\n  }): Promise<TenantConfig> {\n    const tenantId = `tenant-${randomUUID()}`;\n    const secretKey = crypto.randomBytes(32).toString(\"hex\");\n    const now = new Date();\n    \n    const tenant: TenantConfig = {\n      id: tenantId,\n      organizationId: config.organizationId,\n      name: config.name,\n      secretKey,\n      accessTokenTTL: config.accessTokenTTL || this.DEFAULT_ACCESS_TOKEN_TTL,\n      refreshTokenTTL: config.refreshTokenTTL || this.DEFAULT_REFRESH_TOKEN_TTL,\n      allowedScopes: config.allowedScopes || [\"read\", \"write\", \"admin\"],\n      createdAt: now,\n      updatedAt: now,\n      active: true,\n    };\n    \n    this.tenants.set(tenantId, tenant);\n    return tenant;\n  }\n  \n  async getTenant(tenantId: string): Promise<TenantConfig | undefined> {\n    return this.tenants.get(tenantId);\n  }\n  \n  async updateTenant(tenantId: string, updates: Partial<TenantConfig>): Promise<TenantConfig | null> {\n    const tenant = this.tenants.get(tenantId);\n    if (!tenant) return null;\n    \n    const updated: TenantConfig = {\n      ...tenant,\n      ...updates,\n      id: tenant.id,\n      createdAt: tenant.createdAt,\n      updatedAt: new Date(),\n    };\n    \n    this.tenants.set(tenantId, updated);\n    return updated;\n  }\n  \n  async deactivateTenant(tenantId: string): Promise<boolean> {\n    const tenant = this.tenants.get(tenantId);\n    if (!tenant) return false;\n    \n    tenant.active = false;\n    tenant.updatedAt = new Date();\n    return true;\n  }\n  \n  async generateTokenPair(params: {\n    organizationId: string;\n    tenantId?: string;\n    agentId?: string;\n    scopes: string[];\n    subject?: string;\n  }): Promise<TokenPair> {\n    const now = Math.floor(Date.now() / 1000);\n    const tenant = params.tenantId ? this.tenants.get(params.tenantId) : undefined;\n    \n    const accessTokenTTL = tenant?.accessTokenTTL || this.DEFAULT_ACCESS_TOKEN_TTL;\n    const refreshTokenTTL = tenant?.refreshTokenTTL || this.DEFAULT_REFRESH_TOKEN_TTL;\n    \n    const accessPayload: JWTPayload = {\n      sub: params.subject || params.agentId || params.organizationId,\n      iss: this.ISSUER,\n      aud: this.AUDIENCE,\n      iat: now,\n      exp: now + accessTokenTTL,\n      organizationId: params.organizationId,\n      tenantId: params.tenantId,\n      agentId: params.agentId,\n      scopes: params.scopes,\n      type: \"access\",\n    };\n    \n    const refreshPayload: JWTPayload = {\n      ...accessPayload,\n      exp: now + refreshTokenTTL,\n      type: \"refresh\",\n    };\n    \n    const accessToken = this.encodeToken(accessPayload);\n    const refreshToken = this.encodeToken(refreshPayload);\n    \n    const refreshTokenId = `rt-${randomUUID()}`;\n    this.refreshTokens.set(refreshToken, {\n      tokenId: refreshTokenId,\n      payload: refreshPayload,\n      expiresAt: new Date((now + refreshTokenTTL) * 1000),\n    });\n    \n    return {\n      accessToken,\n      refreshToken,\n      accessTokenExpiresAt: new Date((now + accessTokenTTL) * 1000),\n      refreshTokenExpiresAt: new Date((now + refreshTokenTTL) * 1000),\n    };\n  }\n  \n  private encodeToken(payload: JWTPayload): string {\n    const header = { alg: \"HS256\", typ: \"JWT\" };\n    const encodedHeader = Buffer.from(JSON.stringify(header)).toString(\"base64url\");\n    const encodedPayload = Buffer.from(JSON.stringify(payload)).toString(\"base64url\");\n    \n    const signature = crypto\n      .createHmac(\"sha256\", this.JWT_SECRET)\n      .update(`${encodedHeader}.${encodedPayload}`)\n      .digest(\"base64url\");\n    \n    return `${encodedHeader}.${encodedPayload}.${signature}`;\n  }\n  \n  async validateToken(token: string): Promise<TokenValidationResult> {\n    try {\n      const parts = token.split(\".\");\n      if (parts.length !== 3) {\n        return { valid: false, error: \"Invalid token format\" };\n      }\n      \n      const [encodedHeader, encodedPayload, signature] = parts;\n      \n      const expectedSignature = crypto\n        .createHmac(\"sha256\", this.JWT_SECRET)\n        .update(`${encodedHeader}.${encodedPayload}`)\n        .digest(\"base64url\");\n      \n      if (signature !== expectedSignature) {\n        return { valid: false, error: \"Invalid signature\" };\n      }\n      \n      const payload: JWTPayload = JSON.parse(\n        Buffer.from(encodedPayload, \"base64url\").toString()\n      );\n      \n      if (this.revokedTokens.has(token)) {\n        return { valid: false, error: \"Token has been revoked\" };\n      }\n      \n      const now = Math.floor(Date.now() / 1000);\n      if (payload.exp < now) {\n        return { valid: false, error: \"Token has expired\" };\n      }\n      \n      if (payload.iat > now) {\n        return { valid: false, error: \"Token not yet valid\" };\n      }\n      \n      if (payload.iss !== this.ISSUER) {\n        return { valid: false, error: \"Invalid issuer\" };\n      }\n      \n      if (payload.aud !== this.AUDIENCE) {\n        return { valid: false, error: \"Invalid audience\" };\n      }\n      \n      if (payload.tenantId) {\n        const tenant = this.tenants.get(payload.tenantId);\n        if (tenant && !tenant.active) {\n          return { valid: false, error: \"Tenant is inactive\" };\n        }\n      }\n      \n      return { valid: true, payload };\n    } catch (error) {\n      return { valid: false, error: \"Token validation failed\" };\n    }\n  }\n  \n  async refreshAccessToken(refreshToken: string): Promise<TokenPair | null> {\n    const stored = this.refreshTokens.get(refreshToken);\n    if (!stored) {\n      return null;\n    }\n    \n    const validation = await this.validateToken(refreshToken);\n    if (!validation.valid || !validation.payload) {\n      return null;\n    }\n    \n    if (validation.payload.type !== \"refresh\") {\n      return null;\n    }\n    \n    this.refreshTokens.delete(refreshToken);\n    \n    return this.generateTokenPair({\n      organizationId: validation.payload.organizationId,\n      tenantId: validation.payload.tenantId,\n      agentId: validation.payload.agentId,\n      scopes: validation.payload.scopes,\n      subject: validation.payload.sub,\n    });\n  }\n  \n  async revokeToken(token: string): Promise<boolean> {\n    this.revokedTokens.add(token);\n    this.refreshTokens.delete(token);\n    return true;\n  }\n  \n  async revokeAllTokensForAgent(agentId: string): Promise<number> {\n    let count = 0;\n    const tokensToRevoke: string[] = [];\n    \n    this.refreshTokens.forEach((value, key) => {\n      if (value.payload.agentId === agentId) {\n        tokensToRevoke.push(key);\n        count++;\n      }\n    });\n    \n    for (const token of tokensToRevoke) {\n      this.refreshTokens.delete(token);\n      this.revokedTokens.add(token);\n    }\n    \n    return count;\n  }\n  \n  hasScope(payload: JWTPayload, requiredScope: string): boolean {\n    return payload.scopes.includes(requiredScope) || payload.scopes.includes(\"admin\");\n  }\n  \n  hasAnyScope(payload: JWTPayload, requiredScopes: string[]): boolean {\n    return requiredScopes.some(scope => this.hasScope(payload, scope));\n  }\n  \n  async listTenants(organizationId?: string): Promise<TenantConfig[]> {\n    const tenants: TenantConfig[] = [];\n    this.tenants.forEach((tenant) => {\n      if (!organizationId || tenant.organizationId === organizationId) {\n        tenants.push({ ...tenant, secretKey: \"***\" });\n      }\n    });\n    return tenants;\n  }\n  \n  async cleanupExpiredTokens(): Promise<number> {\n    const now = new Date();\n    let count = 0;\n    const tokensToRemove: string[] = [];\n    \n    this.refreshTokens.forEach((value, key) => {\n      if (value.expiresAt < now) {\n        tokensToRemove.push(key);\n        count++;\n      }\n    });\n    \n    for (const token of tokensToRemove) {\n      this.refreshTokens.delete(token);\n    }\n    \n    return count;\n  }\n  \n  getTokenInfo(token: string): { header: any; payload: JWTPayload | null } | null {\n    try {\n      const parts = token.split(\".\");\n      if (parts.length !== 3) return null;\n      \n      const header = JSON.parse(Buffer.from(parts[0], \"base64url\").toString());\n      const payload = JSON.parse(Buffer.from(parts[1], \"base64url\").toString());\n      \n      return { header, payload };\n    } catch {\n      return null;\n    }\n  }\n}\n\nexport const jwtAuthService = new JWTAuthService();\n","path":null,"size_bytes":9594,"size_tokens":null},"server/services/unified-auth.ts":{"content":"import { mtlsAuthService } from \"./mtls-auth\";\nimport { jwtAuthService } from \"./jwt-auth\";\nimport bcrypt from \"bcrypt\";\nimport crypto from \"crypto\";\nimport type { EndpointAgent } from \"@shared/schema\";\n\nexport type AuthMethod = \"api_key\" | \"mtls\" | \"jwt\";\n\nexport interface AuthResult {\n  authenticated: boolean;\n  method?: AuthMethod;\n  agentId?: string;\n  organizationId?: string;\n  scopes?: string[];\n  error?: string;\n}\n\nexport interface UnifiedAuthConfig {\n  enableApiKey: boolean;\n  enableMTLS: boolean;\n  enableJWT: boolean;\n  requireMTLSForCritical: boolean;\n  mtlsSharedSecret?: string;\n}\n\nconst defaultConfig: UnifiedAuthConfig = {\n  enableApiKey: true,\n  enableMTLS: true,\n  enableJWT: true,\n  requireMTLSForCritical: false,\n  mtlsSharedSecret: process.env.MTLS_SHARED_SECRET || undefined,\n};\n\nclass UnifiedAuthService {\n  private config: UnifiedAuthConfig = defaultConfig;\n  \n  configure(config: Partial<UnifiedAuthConfig>): void {\n    this.config = { ...this.config, ...config };\n  }\n  \n  getConfig(): UnifiedAuthConfig {\n    return { ...this.config };\n  }\n  \n  async authenticateRequest(\n    authHeader: string | undefined,\n    clientCertHeader: string | undefined,\n    agents: EndpointAgent[],\n    certSecretHeader?: string\n  ): Promise<AuthResult> {\n    if (this.config.enableMTLS && clientCertHeader) {\n      const mtlsResult = await this.authenticateWithMTLS(clientCertHeader, certSecretHeader);\n      if (mtlsResult.authenticated) {\n        return mtlsResult;\n      }\n    }\n    \n    if (authHeader) {\n      if (authHeader.startsWith(\"Bearer \")) {\n        const token = authHeader.substring(7);\n        \n        if (this.config.enableJWT && this.isJWT(token)) {\n          const jwtResult = await this.authenticateWithJWT(token);\n          if (jwtResult.authenticated) {\n            return jwtResult;\n          }\n        }\n        \n        if (this.config.enableApiKey) {\n          const apiKeyResult = await this.authenticateWithApiKey(token, agents);\n          if (apiKeyResult.authenticated) {\n            return apiKeyResult;\n          }\n        }\n      }\n    }\n    \n    return {\n      authenticated: false,\n      error: \"No valid authentication credentials provided\",\n    };\n  }\n  \n  private isJWT(token: string): boolean {\n    const parts = token.split(\".\");\n    if (parts.length !== 3) return false;\n    \n    try {\n      const header = JSON.parse(Buffer.from(parts[0], \"base64url\").toString());\n      return header.typ === \"JWT\" && header.alg === \"HS256\";\n    } catch {\n      return false;\n    }\n  }\n  \n  private async authenticateWithMTLS(certHeader: string, certSecretHeader?: string): Promise<AuthResult> {\n    const fingerprint = mtlsAuthService.extractFingerprintFromHeader(certHeader);\n    if (!fingerprint) {\n      return { authenticated: false, error: \"Invalid certificate header\" };\n    }\n    \n    // Validate shared secret to prevent header spoofing attacks\n    // When a shared secret is configured, the client must provide a matching X-Cert-Secret header\n    if (this.config.mtlsSharedSecret) {\n      if (!certSecretHeader) {\n        return { authenticated: false, error: \"Certificate secret required for mTLS authentication\" };\n      }\n      // Use timing-safe comparison to prevent timing attacks\n      const expectedSecret = Buffer.from(this.config.mtlsSharedSecret);\n      const providedSecret = Buffer.from(certSecretHeader);\n      if (expectedSecret.length !== providedSecret.length || \n          !crypto.timingSafeEqual(expectedSecret, providedSecret)) {\n        return { authenticated: false, error: \"Invalid certificate secret\" };\n      }\n    }\n    \n    const validation = await mtlsAuthService.validateCertificate(fingerprint);\n    if (!validation.valid) {\n      return { authenticated: false, error: validation.error };\n    }\n    \n    return {\n      authenticated: true,\n      method: \"mtls\",\n      agentId: validation.agentId,\n      organizationId: validation.organizationId,\n      scopes: [\"read\", \"write\"],\n    };\n  }\n  \n  private async authenticateWithJWT(token: string): Promise<AuthResult> {\n    const validation = await jwtAuthService.validateToken(token);\n    if (!validation.valid || !validation.payload) {\n      return { authenticated: false, error: validation.error };\n    }\n    \n    return {\n      authenticated: true,\n      method: \"jwt\",\n      agentId: validation.payload.agentId,\n      organizationId: validation.payload.organizationId,\n      scopes: validation.payload.scopes,\n    };\n  }\n  \n  private async authenticateWithApiKey(\n    apiKey: string,\n    agents: EndpointAgent[]\n  ): Promise<AuthResult> {\n    for (const agent of agents) {\n      if (agent.apiKeyHash) {\n        const isValid = await bcrypt.compare(apiKey, agent.apiKeyHash);\n        if (isValid) {\n          return {\n            authenticated: true,\n            method: \"api_key\",\n            agentId: agent.id,\n            organizationId: agent.organizationId,\n            scopes: [\"read\", \"write\"],\n          };\n        }\n      }\n      \n      if (agent.apiKey === apiKey) {\n        return {\n          authenticated: true,\n          method: \"api_key\",\n          agentId: agent.id,\n          organizationId: agent.organizationId,\n          scopes: [\"read\", \"write\"],\n        };\n      }\n    }\n    \n    return { authenticated: false, error: \"Invalid API key\" };\n  }\n  \n  async issueJWTForAgent(agentId: string, organizationId: string, scopes: string[] = [\"read\", \"write\"]) {\n    return jwtAuthService.generateTokenPair({\n      organizationId,\n      agentId,\n      scopes,\n    });\n  }\n  \n  async issueCertificateForAgent(agentId: string, organizationId: string, commonName: string) {\n    return mtlsAuthService.generateCertificate({\n      agentId,\n      organizationId,\n      commonName,\n    });\n  }\n  \n  async revokeAgentCredentials(agentId: string): Promise<{ revokedCerts: number; revokedTokens: number }> {\n    const revokedCerts = await mtlsAuthService.revokeAllAgentCertificates(agentId, \"Agent credentials revoked\");\n    const revokedTokens = await jwtAuthService.revokeAllTokensForAgent(agentId);\n    \n    return { revokedCerts, revokedTokens };\n  }\n  \n  async getAgentAuthStatus(agentId: string) {\n    const certs = await mtlsAuthService.getAgentCertificates(agentId);\n    const activeCerts = certs.filter(c => c.status === \"active\");\n    \n    return {\n      hasCertificates: activeCerts.length > 0,\n      certificateCount: activeCerts.length,\n      certificates: activeCerts.map(c => ({\n        id: c.id,\n        fingerprint: c.fingerprint,\n        validFrom: c.validFrom,\n        validTo: c.validTo,\n        status: c.status,\n      })),\n    };\n  }\n}\n\nexport const unifiedAuthService = new UnifiedAuthService();\n","path":null,"size_bytes":6650,"size_tokens":null},"server/services/mtls-auth.ts":{"content":"import { randomUUID } from \"crypto\";\nimport * as crypto from \"crypto\";\n\nexport interface CertificateInfo {\n  id: string;\n  agentId: string;\n  organizationId: string;\n  fingerprint: string;\n  subject: string;\n  issuer: string;\n  serialNumber: string;\n  validFrom: Date;\n  validTo: Date;\n  status: \"active\" | \"revoked\" | \"expired\";\n  createdAt: Date;\n  revokedAt?: Date;\n  revokedReason?: string;\n  publicKeyHash: string;\n}\n\nexport interface CertificateRequest {\n  agentId: string;\n  organizationId: string;\n  commonName: string;\n  validityDays?: number;\n}\n\nexport interface CertificateResponse {\n  certificateId: string;\n  certificate: string;\n  privateKey: string;\n  fingerprint: string;\n  serialNumber: string;\n  validFrom: Date;\n  validTo: Date;\n}\n\nexport interface MTLSValidationResult {\n  valid: boolean;\n  agentId?: string;\n  organizationId?: string;\n  certificateId?: string;\n  error?: string;\n}\n\nclass MTLSAuthService {\n  private certificates: Map<string, CertificateInfo> = new Map();\n  private fingerprintIndex: Map<string, string> = new Map();\n  private publicKeyHashIndex: Map<string, string> = new Map();\n  private agentCertificates: Map<string, string[]> = new Map();\n  \n  private readonly CA_SUBJECT = \"CN=OdinForge CA,O=OdinForge,OU=Security\";\n  private readonly CERT_VALIDITY_DAYS = 365;\n  \n  async generateCertificate(request: CertificateRequest): Promise<CertificateResponse> {\n    const validityDays = request.validityDays || this.CERT_VALIDITY_DAYS;\n    const certificateId = `cert-${randomUUID()}`;\n    const serialNumber = crypto.randomBytes(16).toString(\"hex\").toUpperCase();\n    const now = new Date();\n    const validFrom = new Date(now);\n    const validTo = new Date(now.getTime() + validityDays * 24 * 60 * 60 * 1000);\n    \n    const { publicKey, privateKey } = crypto.generateKeyPairSync(\"rsa\", {\n      modulusLength: 2048,\n      publicKeyEncoding: { type: \"spki\", format: \"pem\" },\n      privateKeyEncoding: { type: \"pkcs8\", format: \"pem\" },\n    });\n    \n    const subject = `CN=${request.commonName},O=${request.organizationId},OU=Endpoint Agent`;\n    \n    const certDer = this.createX509Certificate({\n      subject,\n      issuer: this.CA_SUBJECT,\n      serialNumber,\n      validFrom,\n      validTo,\n      publicKeyPem: publicKey,\n      privateKeyPem: privateKey,\n    });\n    \n    const fingerprint = crypto\n      .createHash(\"sha256\")\n      .update(certDer)\n      .digest(\"hex\")\n      .toUpperCase();\n    \n    const publicKeyHash = crypto\n      .createHash(\"sha256\")\n      .update(publicKey)\n      .digest(\"hex\")\n      .toUpperCase();\n    \n    const certificate = this.derToPem(certDer, \"CERTIFICATE\");\n    \n    const certInfo: CertificateInfo = {\n      id: certificateId,\n      agentId: request.agentId,\n      organizationId: request.organizationId,\n      fingerprint,\n      subject,\n      issuer: this.CA_SUBJECT,\n      serialNumber,\n      validFrom,\n      validTo,\n      status: \"active\",\n      createdAt: now,\n      publicKeyHash,\n    };\n    \n    this.certificates.set(certificateId, certInfo);\n    this.fingerprintIndex.set(fingerprint, certificateId);\n    this.publicKeyHashIndex.set(publicKeyHash, certificateId);\n    \n    const agentCerts = this.agentCertificates.get(request.agentId) || [];\n    agentCerts.push(certificateId);\n    this.agentCertificates.set(request.agentId, agentCerts);\n    \n    return {\n      certificateId,\n      certificate,\n      privateKey,\n      fingerprint,\n      serialNumber,\n      validFrom,\n      validTo,\n    };\n  }\n  \n  private createX509Certificate(params: {\n    subject: string;\n    issuer: string;\n    serialNumber: string;\n    validFrom: Date;\n    validTo: Date;\n    publicKeyPem: string;\n    privateKeyPem: string;\n  }): Buffer {\n    const versionDer = this.asn1ContextTag(0, this.asn1Integer(Buffer.from([2])));\n    \n    const serialBytes = Buffer.from(params.serialNumber, \"hex\");\n    const serialDer = this.asn1Integer(serialBytes);\n    \n    const sha256WithRSAOid = Buffer.from([\n      0x30, 0x0D,\n      0x06, 0x09, 0x2A, 0x86, 0x48, 0x86, 0xF7, 0x0D, 0x01, 0x01, 0x0B,\n      0x05, 0x00\n    ]);\n    \n    const issuerDer = this.encodeDN(params.issuer);\n    const subjectDer = this.encodeDN(params.subject);\n    \n    const validityDer = this.asn1Sequence(Buffer.concat([\n      this.asn1UTCTime(params.validFrom),\n      this.asn1UTCTime(params.validTo),\n    ]));\n    \n    const publicKeyInfo = this.extractPublicKeyDer(params.publicKeyPem);\n    \n    const tbsCertificate = this.asn1Sequence(Buffer.concat([\n      versionDer,\n      serialDer,\n      sha256WithRSAOid,\n      issuerDer,\n      validityDer,\n      subjectDer,\n      publicKeyInfo,\n    ]));\n    \n    const signerKey = crypto.createPrivateKey(params.privateKeyPem);\n    const sign = crypto.createSign(\"SHA256\");\n    sign.update(tbsCertificate);\n    const signature = sign.sign(signerKey);\n    \n    const signatureBits = this.asn1BitString(signature);\n    \n    return this.asn1Sequence(Buffer.concat([\n      tbsCertificate,\n      sha256WithRSAOid,\n      signatureBits,\n    ]));\n  }\n  \n  private encodeDN(dn: string): Buffer {\n    const parts = dn.split(\",\").map(p => p.trim());\n    const rdns: Buffer[] = [];\n    \n    for (const part of parts) {\n      const eqIdx = part.indexOf(\"=\");\n      if (eqIdx === -1) continue;\n      \n      const attrType = part.substring(0, eqIdx).toUpperCase();\n      const attrValue = part.substring(eqIdx + 1);\n      \n      let oid: Buffer;\n      switch (attrType) {\n        case \"CN\":\n          oid = Buffer.from([0x06, 0x03, 0x55, 0x04, 0x03]);\n          break;\n        case \"O\":\n          oid = Buffer.from([0x06, 0x03, 0x55, 0x04, 0x0A]);\n          break;\n        case \"OU\":\n          oid = Buffer.from([0x06, 0x03, 0x55, 0x04, 0x0B]);\n          break;\n        case \"C\":\n          oid = Buffer.from([0x06, 0x03, 0x55, 0x04, 0x06]);\n          break;\n        case \"ST\":\n          oid = Buffer.from([0x06, 0x03, 0x55, 0x04, 0x08]);\n          break;\n        case \"L\":\n          oid = Buffer.from([0x06, 0x03, 0x55, 0x04, 0x07]);\n          break;\n        default:\n          continue;\n      }\n      \n      const valueBytes = Buffer.from(attrValue, \"utf8\");\n      const valueDer = this.asn1TLV(0x0C, valueBytes);\n      \n      const atv = this.asn1Sequence(Buffer.concat([oid, valueDer]));\n      const rdn = this.asn1Set(atv);\n      rdns.push(rdn);\n    }\n    \n    return this.asn1Sequence(Buffer.concat(rdns));\n  }\n  \n  private extractPublicKeyDer(pem: string): Buffer {\n    const base64 = pem\n      .replace(/-----BEGIN PUBLIC KEY-----/g, \"\")\n      .replace(/-----END PUBLIC KEY-----/g, \"\")\n      .replace(/\\s/g, \"\");\n    return Buffer.from(base64, \"base64\");\n  }\n  \n  private asn1Integer(value: Buffer): Buffer {\n    let data = value;\n    while (data.length > 1 && data[0] === 0 && !(data[1] & 0x80)) {\n      data = data.slice(1);\n    }\n    if (data[0] & 0x80) {\n      data = Buffer.concat([Buffer.from([0x00]), data]);\n    }\n    return this.asn1TLV(0x02, data);\n  }\n  \n  private asn1UTCTime(date: Date): Buffer {\n    const y = date.getUTCFullYear().toString().slice(-2);\n    const M = (date.getUTCMonth() + 1).toString().padStart(2, \"0\");\n    const d = date.getUTCDate().toString().padStart(2, \"0\");\n    const h = date.getUTCHours().toString().padStart(2, \"0\");\n    const m = date.getUTCMinutes().toString().padStart(2, \"0\");\n    const s = date.getUTCSeconds().toString().padStart(2, \"0\");\n    const str = `${y}${M}${d}${h}${m}${s}Z`;\n    return this.asn1TLV(0x17, Buffer.from(str, \"ascii\"));\n  }\n  \n  private asn1Sequence(content: Buffer): Buffer {\n    return this.asn1TLV(0x30, content);\n  }\n  \n  private asn1Set(content: Buffer): Buffer {\n    return this.asn1TLV(0x31, content);\n  }\n  \n  private asn1BitString(content: Buffer): Buffer {\n    return this.asn1TLV(0x03, Buffer.concat([Buffer.from([0x00]), content]));\n  }\n  \n  private asn1ContextTag(tag: number, content: Buffer): Buffer {\n    return this.asn1TLV(0xA0 | tag, content);\n  }\n  \n  private asn1TLV(tag: number, value: Buffer): Buffer {\n    const len = value.length;\n    let lengthBytes: Buffer;\n    \n    if (len < 128) {\n      lengthBytes = Buffer.from([len]);\n    } else if (len < 256) {\n      lengthBytes = Buffer.from([0x81, len]);\n    } else if (len < 65536) {\n      lengthBytes = Buffer.from([0x82, (len >> 8) & 0xFF, len & 0xFF]);\n    } else {\n      lengthBytes = Buffer.from([0x83, (len >> 16) & 0xFF, (len >> 8) & 0xFF, len & 0xFF]);\n    }\n    \n    return Buffer.concat([Buffer.from([tag]), lengthBytes, value]);\n  }\n  \n  private derToPem(der: Buffer, type: string): string {\n    const base64 = der.toString(\"base64\");\n    const lines: string[] = [];\n    for (let i = 0; i < base64.length; i += 64) {\n      lines.push(base64.slice(i, i + 64));\n    }\n    return `-----BEGIN ${type}-----\\n${lines.join(\"\\n\")}\\n-----END ${type}-----`;\n  }\n  \n  async validateCertificate(fingerprintOrPem: string): Promise<MTLSValidationResult> {\n    let fingerprint: string;\n    \n    if (fingerprintOrPem.includes(\"-----BEGIN CERTIFICATE-----\")) {\n      const der = this.pemToDer(fingerprintOrPem);\n      fingerprint = crypto.createHash(\"sha256\").update(der).digest(\"hex\").toUpperCase();\n    } else {\n      fingerprint = fingerprintOrPem.replace(/:/g, \"\").toUpperCase();\n    }\n    \n    const certId = this.fingerprintIndex.get(fingerprint);\n    if (!certId) {\n      return { valid: false, error: \"Certificate not found in trust store\" };\n    }\n    \n    const cert = this.certificates.get(certId);\n    if (!cert) {\n      return { valid: false, error: \"Certificate data not found\" };\n    }\n    \n    if (cert.status === \"revoked\") {\n      return { valid: false, error: `Certificate revoked: ${cert.revokedReason}` };\n    }\n    \n    const now = new Date();\n    if (now < cert.validFrom) {\n      return { valid: false, error: \"Certificate not yet valid\" };\n    }\n    \n    if (now > cert.validTo) {\n      cert.status = \"expired\";\n      return { valid: false, error: \"Certificate has expired\" };\n    }\n    \n    return {\n      valid: true,\n      agentId: cert.agentId,\n      organizationId: cert.organizationId,\n      certificateId: cert.id,\n    };\n  }\n  \n  async validateByPublicKey(publicKeyPem: string): Promise<MTLSValidationResult> {\n    const hash = crypto.createHash(\"sha256\").update(publicKeyPem).digest(\"hex\").toUpperCase();\n    const certId = this.publicKeyHashIndex.get(hash);\n    \n    if (!certId) {\n      return { valid: false, error: \"Public key not found in trust store\" };\n    }\n    \n    const cert = this.certificates.get(certId);\n    if (!cert) {\n      return { valid: false, error: \"Certificate data not found\" };\n    }\n    \n    if (cert.status === \"revoked\") {\n      return { valid: false, error: `Certificate revoked: ${cert.revokedReason}` };\n    }\n    \n    const now = new Date();\n    if (now < cert.validFrom) {\n      return { valid: false, error: \"Certificate not yet valid\" };\n    }\n    \n    if (now > cert.validTo) {\n      cert.status = \"expired\";\n      return { valid: false, error: \"Certificate has expired\" };\n    }\n    \n    return {\n      valid: true,\n      agentId: cert.agentId,\n      organizationId: cert.organizationId,\n      certificateId: cert.id,\n    };\n  }\n  \n  private pemToDer(pem: string): Buffer {\n    const base64 = pem\n      .replace(/-----BEGIN [^-]+-----/g, \"\")\n      .replace(/-----END [^-]+-----/g, \"\")\n      .replace(/\\s/g, \"\");\n    return Buffer.from(base64, \"base64\");\n  }\n  \n  async revokeCertificate(certificateId: string, reason: string): Promise<boolean> {\n    const cert = this.certificates.get(certificateId);\n    if (!cert) {\n      return false;\n    }\n    \n    cert.status = \"revoked\";\n    cert.revokedAt = new Date();\n    cert.revokedReason = reason;\n    \n    return true;\n  }\n  \n  async getCertificate(certificateId: string): Promise<CertificateInfo | undefined> {\n    return this.certificates.get(certificateId);\n  }\n  \n  async getAgentCertificates(agentId: string): Promise<CertificateInfo[]> {\n    const certIds = this.agentCertificates.get(agentId) || [];\n    const certs: CertificateInfo[] = [];\n    \n    for (const certId of certIds) {\n      const cert = this.certificates.get(certId);\n      if (cert) {\n        certs.push(cert);\n      }\n    }\n    \n    return certs;\n  }\n  \n  async renewCertificate(certificateId: string): Promise<CertificateResponse | null> {\n    const oldCert = this.certificates.get(certificateId);\n    if (!oldCert) {\n      return null;\n    }\n    \n    if (oldCert.status === \"revoked\") {\n      return null;\n    }\n    \n    await this.revokeCertificate(certificateId, \"Renewed - new certificate issued\");\n    \n    const commonName = oldCert.subject.split(\",\")[0].replace(\"CN=\", \"\");\n    \n    return this.generateCertificate({\n      agentId: oldCert.agentId,\n      organizationId: oldCert.organizationId,\n      commonName,\n    });\n  }\n  \n  async revokeAllAgentCertificates(agentId: string, reason?: string): Promise<number> {\n    const certIds = this.agentCertificates.get(agentId) || [];\n    let count = 0;\n    \n    for (const certId of certIds) {\n      const success = await this.revokeCertificate(certId, reason || \"Agent credentials revoked\");\n      if (success) count++;\n    }\n    \n    return count;\n  }\n  \n  extractFingerprintFromHeader(certHeader: string): string | null {\n    try {\n      const match = certHeader.match(/fingerprint=([A-F0-9:]+)/i);\n      if (match) {\n        return match[1].replace(/:/g, \"\").toUpperCase();\n      }\n      return certHeader.replace(/:/g, \"\").toUpperCase();\n    } catch {\n      return null;\n    }\n  }\n  \n  async listAllCertificates(organizationId?: string): Promise<CertificateInfo[]> {\n    const certs: CertificateInfo[] = [];\n    const allCerts = Array.from(this.certificates.values());\n    for (const cert of allCerts) {\n      if (!organizationId || cert.organizationId === organizationId) {\n        certs.push(cert);\n      }\n    }\n    return certs;\n  }\n  \n  async getActiveCertificateCount(): Promise<number> {\n    let count = 0;\n    const allCerts = Array.from(this.certificates.values());\n    for (const cert of allCerts) {\n      if (cert.status === \"active\") {\n        count++;\n      }\n    }\n    return count;\n  }\n  \n  async cleanupExpiredCertificates(): Promise<number> {\n    const now = new Date();\n    let count = 0;\n    const allCerts = Array.from(this.certificates.values());\n    \n    for (const cert of allCerts) {\n      if (cert.status === \"active\" && now > cert.validTo) {\n        cert.status = \"expired\";\n        count++;\n      }\n    }\n    \n    return count;\n  }\n}\n\nexport const mtlsAuthService = new MTLSAuthService();\n","path":null,"size_bytes":14465,"size_tokens":null},"client/src/contexts/ViewModeContext.tsx":{"content":"import { createContext, useContext, useState, useEffect } from \"react\";\n\ntype ViewMode = \"executive\" | \"engineer\";\n\ninterface ViewModeContextType {\n  viewMode: ViewMode;\n  setViewMode: (mode: ViewMode) => void;\n}\n\nconst ViewModeContext = createContext<ViewModeContextType | null>(null);\n\nexport function ViewModeProvider({ children }: { children: React.ReactNode }) {\n  const [viewMode, setViewModeState] = useState<ViewMode>(() => {\n    const stored = localStorage.getItem(\"odinforge_view_mode\");\n    return (stored === \"executive\" || stored === \"engineer\") ? stored : \"executive\";\n  });\n\n  const setViewMode = (mode: ViewMode) => {\n    localStorage.setItem(\"odinforge_view_mode\", mode);\n    setViewModeState(mode);\n  };\n\n  return (\n    <ViewModeContext.Provider value={{ viewMode, setViewMode }}>\n      {children}\n    </ViewModeContext.Provider>\n  );\n}\n\nexport function useViewMode() {\n  const context = useContext(ViewModeContext);\n  if (!context) {\n    throw new Error(\"useViewMode must be used within a ViewModeProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":1052,"size_tokens":null},"client/src/contexts/AuthContext.tsx":{"content":"import { createContext, useContext, useState, useEffect } from \"react\";\nimport type { UserRole, Permission, ExecutionMode, AllRole } from \"@shared/schema\";\nimport { \n  rolePermissions, \n  roleMetadata, \n  userRoles,\n  canExecuteMode as schemaCanExecuteMode,\n  needsSanitizedView as schemaNeedsSanitizedView,\n  isApiOnlyRole\n} from \"@shared/schema\";\n\ninterface AuthUser {\n  id: string;\n  username: string;\n  displayName?: string;\n  email?: string;\n  role: UserRole;\n  permissions: Permission[];\n  organizationId?: string;\n}\n\ninterface AuthContextType {\n  user: AuthUser | null;\n  isLoading: boolean;\n  hasPermission: (permission: Permission) => boolean;\n  hasAnyPermission: (permissions: Permission[]) => boolean;\n  hasRole: (role: UserRole) => boolean;\n  hasAnyRole: (roles: UserRole[]) => boolean;\n  canExecuteMode: (mode: ExecutionMode) => boolean;\n  needsSanitizedView: () => boolean;\n  setUserRole: (role: UserRole) => void;\n  availableRoles: UserRole[];\n}\n\nconst AuthContext = createContext<AuthContextType | null>(null);\n\n// Demo user names for each role\nconst roleDisplayNames: Record<UserRole, string> = {\n  platform_super_admin: \"Platform Admin\",\n  organization_owner: \"Sarah Mitchell\",\n  security_administrator: \"James Chen\",\n  security_engineer: \"Alex Rivera\",\n  security_analyst: \"Jordan Kim\",\n  executive_viewer: \"Dr. Emily Foster\",\n  compliance_officer: \"Michael Okonkwo\",\n  automation_account: \"CI/CD Pipeline\",\n};\n\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\n  const [user, setUser] = useState<AuthUser | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  // Filter to only customer-assignable roles for demo (exclude platform_super_admin)\n  const availableRoles = userRoles.filter(\n    role => roleMetadata[role]?.customerAssignable && roleMetadata[role]?.uiAccess\n  ) as UserRole[];\n\n  useEffect(() => {\n    // DEMO MODE: Client-side role management\n    // In production, replace with:\n    // 1. Fetch authenticated user from /api/auth/me\n    // 2. Server-side role/permission enforcement on all protected routes\n    // 3. Remove localStorage role switching capability\n    // \n    // Current implementation allows users to switch roles for demonstration\n    // purposes only. This does NOT provide real security - all API routes\n    // should independently verify permissions server-side.\n    const storedRole = localStorage.getItem(\"odinforge_user_role\") as UserRole | null;\n    // Default to security_administrator for demo (good balance of capabilities)\n    const role: UserRole = storedRole && userRoles.includes(storedRole) \n      ? storedRole \n      : \"security_administrator\";\n    \n    setUser({\n      id: \"demo-user\",\n      username: role,\n      displayName: roleDisplayNames[role] || \"Demo User\",\n      email: `${role.replace(/_/g, \".\")}@demo.odinforge.ai`,\n      role,\n      permissions: rolePermissions[role] || [],\n      organizationId: \"demo-org\",\n    });\n    setIsLoading(false);\n  }, []);\n\n  const hasPermission = (permission: Permission): boolean => {\n    if (!user) return false;\n    return user.permissions.includes(permission);\n  };\n\n  const hasAnyPermission = (perms: Permission[]): boolean => {\n    if (!user) return false;\n    return perms.some(p => user.permissions.includes(p));\n  };\n\n  const hasRole = (role: UserRole): boolean => {\n    if (!user) return false;\n    return user.role === role;\n  };\n\n  const hasAnyRole = (roles: UserRole[]): boolean => {\n    if (!user) return false;\n    return roles.includes(user.role);\n  };\n\n  const canExecuteMode = (mode: ExecutionMode): boolean => {\n    if (!user) return false;\n    return schemaCanExecuteMode(user.role, mode);\n  };\n\n  const needsSanitizedView = (): boolean => {\n    if (!user) return true;\n    return schemaNeedsSanitizedView(user.role);\n  };\n\n  const setUserRole = (role: UserRole) => {\n    localStorage.setItem(\"odinforge_user_role\", role);\n    setUser(prev => prev ? {\n      ...prev,\n      role,\n      username: role,\n      displayName: roleDisplayNames[role] || \"Demo User\",\n      email: `${role.replace(/_/g, \".\")}@demo.odinforge.ai`,\n      permissions: rolePermissions[role] || [],\n    } : null);\n  };\n\n  return (\n    <AuthContext.Provider value={{ \n      user, \n      isLoading, \n      hasPermission, \n      hasAnyPermission,\n      hasRole, \n      hasAnyRole,\n      canExecuteMode,\n      needsSanitizedView,\n      setUserRole,\n      availableRoles,\n    }}>\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (!context) {\n    throw new Error(\"useAuth must be used within an AuthProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":4647,"size_tokens":null},"client/src/components/AppSidebar.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport {\n  LayoutDashboard,\n  Server,\n  Building2,\n  BarChart3,\n  FileText,\n  Layers,\n  Shield,\n  Bot,\n  Swords,\n  Brain,\n  ChevronDown,\n  Settings,\n  Users,\n} from \"lucide-react\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarHeader,\n  SidebarFooter,\n} from \"@/components/ui/sidebar\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { roleMetadata } from \"@shared/schema\";\n\nconst mainNavItems = [\n  { title: \"Dashboard\", href: \"/\", icon: LayoutDashboard },\n  { title: \"Assets\", href: \"/assets\", icon: Server },\n  { title: \"Infrastructure\", href: \"/infrastructure\", icon: Building2 },\n  { title: \"Risk Dashboard\", href: \"/risk\", icon: BarChart3 },\n];\n\nconst analysisItems = [\n  { title: \"Reports\", href: \"/reports\", icon: FileText },\n  { title: \"Batch Jobs\", href: \"/batch\", icon: Layers },\n  { title: \"Simulations\", href: \"/simulations\", icon: Swords },\n];\n\nconst systemItems = [\n  { title: \"Agents\", href: \"/agents\", icon: Bot },\n  { title: \"Governance\", href: \"/governance\", icon: Shield },\n  { title: \"Advanced\", href: \"/advanced\", icon: Brain },\n];\n\nexport function AppSidebar() {\n  const [location] = useLocation();\n  const { user, hasPermission } = useAuth();\n\n  const isActive = (href: string) => location === href;\n\n  const getRoleBadgeStyle = (role: string) => {\n    switch (role) {\n      case \"platform_super_admin\":\n        return \"bg-red-500/10 text-red-400 border-red-500/30\";\n      case \"organization_owner\":\n        return \"bg-purple-500/10 text-purple-400 border-purple-500/30\";\n      case \"security_administrator\":\n        return \"bg-orange-500/10 text-orange-400 border-orange-500/30\";\n      case \"security_engineer\":\n        return \"bg-cyan-500/10 text-cyan-400 border-cyan-500/30\";\n      case \"security_analyst\":\n        return \"bg-blue-500/10 text-blue-400 border-blue-500/30\";\n      case \"executive_viewer\":\n        return \"bg-amber-500/10 text-amber-400 border-amber-500/30\";\n      case \"compliance_officer\":\n        return \"bg-teal-500/10 text-teal-400 border-teal-500/30\";\n      default:\n        return \"bg-emerald-500/10 text-emerald-400 border-emerald-500/30\";\n    }\n  };\n\n  return (\n    <Sidebar>\n      <SidebarHeader className=\"border-b border-border p-4\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"relative\">\n            <div className=\"absolute inset-0 bg-gradient-to-r from-cyan-500 to-blue-600 blur-lg opacity-50\" />\n            <div className=\"relative p-2 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-lg\">\n              <Shield className=\"h-5 w-5 text-white\" />\n            </div>\n          </div>\n          <div className=\"flex flex-col\">\n            <span className=\"text-base font-bold tracking-tight bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent\">\n              OdinForge\n            </span>\n            <span className=\"text-[9px] uppercase tracking-widest text-muted-foreground\">\n              AEV Platform\n            </span>\n          </div>\n        </div>\n      </SidebarHeader>\n\n      <SidebarContent>\n        <SidebarGroup>\n          <SidebarGroupLabel>Navigation</SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {mainNavItems.map((item) => (\n                <SidebarMenuItem key={item.href}>\n                  <SidebarMenuButton asChild isActive={isActive(item.href)}>\n                    <Link href={item.href} data-testid={`nav-${item.title.toLowerCase().replace(/\\s+/g, \"-\")}`}>\n                      <item.icon className=\"h-4 w-4\" />\n                      <span>{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n\n        <Collapsible defaultOpen className=\"group/collapsible\">\n          <SidebarGroup>\n            <CollapsibleTrigger asChild>\n              <SidebarGroupLabel className=\"cursor-pointer hover-elevate rounded-md\">\n                Analysis\n                <ChevronDown className=\"ml-auto h-4 w-4 transition-transform group-data-[state=open]/collapsible:rotate-180\" />\n              </SidebarGroupLabel>\n            </CollapsibleTrigger>\n            <CollapsibleContent>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {analysisItems.map((item) => (\n                    <SidebarMenuItem key={item.href}>\n                      <SidebarMenuButton asChild isActive={isActive(item.href)}>\n                        <Link href={item.href} data-testid={`nav-${item.title.toLowerCase().replace(/\\s+/g, \"-\")}`}>\n                          <item.icon className=\"h-4 w-4\" />\n                          <span>{item.title}</span>\n                        </Link>\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  ))}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </CollapsibleContent>\n          </SidebarGroup>\n        </Collapsible>\n\n        <Collapsible defaultOpen className=\"group/collapsible\">\n          <SidebarGroup>\n            <CollapsibleTrigger asChild>\n              <SidebarGroupLabel className=\"cursor-pointer hover-elevate rounded-md\">\n                System\n                <ChevronDown className=\"ml-auto h-4 w-4 transition-transform group-data-[state=open]/collapsible:rotate-180\" />\n              </SidebarGroupLabel>\n            </CollapsibleTrigger>\n            <CollapsibleContent>\n              <SidebarGroupContent>\n                <SidebarMenu>\n                  {systemItems.map((item) => (\n                    <SidebarMenuItem key={item.href}>\n                      <SidebarMenuButton asChild isActive={isActive(item.href)}>\n                        <Link href={item.href} data-testid={`nav-${item.title.toLowerCase().replace(/\\s+/g, \"-\")}`}>\n                          <item.icon className=\"h-4 w-4\" />\n                          <span>{item.title}</span>\n                        </Link>\n                      </SidebarMenuButton>\n                    </SidebarMenuItem>\n                  ))}\n                </SidebarMenu>\n              </SidebarGroupContent>\n            </CollapsibleContent>\n          </SidebarGroup>\n        </Collapsible>\n\n        {hasPermission(\"org:manage_users\") && (\n          <SidebarGroup>\n            <SidebarGroupLabel>Administration</SidebarGroupLabel>\n            <SidebarGroupContent>\n              <SidebarMenu>\n                <SidebarMenuItem>\n                  <SidebarMenuButton asChild>\n                    <Link href=\"/admin/users\" data-testid=\"nav-admin-users\">\n                      <Users className=\"h-4 w-4\" />\n                      <span>User Management</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n                {hasPermission(\"org:manage_settings\") && (\n                  <SidebarMenuItem>\n                    <SidebarMenuButton asChild>\n                      <Link href=\"/admin/settings\" data-testid=\"nav-admin-settings\">\n                        <Settings className=\"h-4 w-4\" />\n                        <span>Settings</span>\n                      </Link>\n                    </SidebarMenuButton>\n                  </SidebarMenuItem>\n                )}\n              </SidebarMenu>\n            </SidebarGroupContent>\n          </SidebarGroup>\n        )}\n      </SidebarContent>\n\n      <SidebarFooter className=\"border-t border-border p-4\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"h-8 w-8 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center\">\n            <span className=\"text-xs font-bold text-white\">\n              {user?.displayName?.charAt(0) || user?.username?.charAt(0) || \"U\"}\n            </span>\n          </div>\n          <div className=\"flex flex-col min-w-0\">\n            <span className=\"text-sm font-medium truncate\">\n              {user?.displayName || user?.username || \"User\"}\n            </span>\n            <Badge className={`text-[10px] w-fit ${getRoleBadgeStyle(user?.role || \"security_analyst\")}`}>\n              {user?.role ? roleMetadata[user.role]?.displayName || user.role : \"Security Analyst\"}\n            </Badge>\n          </div>\n        </div>\n      </SidebarFooter>\n    </Sidebar>\n  );\n}\n","path":null,"size_bytes":8603,"size_tokens":null},"scripts/load-test.ts":{"content":"#!/usr/bin/env npx tsx\n\ninterface LoadTestConfig {\n  baseUrl: string;\n  concurrency: number;\n  totalRequests: number;\n  testDurationMs: number;\n}\n\ninterface TestResult {\n  endpoint: string;\n  totalRequests: number;\n  successCount: number;\n  errorCount: number;\n  rateLimitedCount: number;\n  avgLatencyMs: number;\n  p95LatencyMs: number;\n  p99LatencyMs: number;\n  minLatencyMs: number;\n  maxLatencyMs: number;\n  requestsPerSecond: number;\n}\n\ninterface RequestResult {\n  success: boolean;\n  latencyMs: number;\n  statusCode: number;\n  rateLimited: boolean;\n}\n\nasync function makeRequest(url: string, options: RequestInit = {}): Promise<RequestResult> {\n  const start = Date.now();\n  try {\n    const response = await fetch(url, {\n      ...options,\n      headers: {\n        \"Content-Type\": \"application/json\",\n        ...options.headers,\n      },\n    });\n    const latencyMs = Date.now() - start;\n    return {\n      success: response.ok,\n      latencyMs,\n      statusCode: response.status,\n      rateLimited: response.status === 429,\n    };\n  } catch (error) {\n    return {\n      success: false,\n      latencyMs: Date.now() - start,\n      statusCode: 0,\n      rateLimited: false,\n    };\n  }\n}\n\nfunction calculatePercentile(values: number[], percentile: number): number {\n  if (values.length === 0) return 0;\n  const sorted = [...values].sort((a, b) => a - b);\n  const index = Math.ceil((percentile / 100) * sorted.length) - 1;\n  return sorted[Math.max(0, index)];\n}\n\nasync function runConcurrentRequests(\n  endpoint: string,\n  method: string,\n  body: unknown | null,\n  concurrency: number,\n  totalRequests: number\n): Promise<TestResult> {\n  const results: RequestResult[] = [];\n  const startTime = Date.now();\n  \n  let completed = 0;\n  const pending: Promise<void>[] = [];\n  \n  const url = `http://localhost:5000${endpoint}`;\n  \n  async function executeRequest() {\n    const result = await makeRequest(url, {\n      method,\n      body: body ? JSON.stringify(body) : undefined,\n    });\n    results.push(result);\n    completed++;\n    \n    const progress = Math.round((completed / totalRequests) * 100);\n    if (completed % Math.ceil(totalRequests / 10) === 0) {\n      process.stdout.write(`\\r  Progress: ${progress}% (${completed}/${totalRequests})`);\n    }\n  }\n  \n  for (let i = 0; i < totalRequests; i++) {\n    if (pending.length >= concurrency) {\n      await Promise.race(pending);\n      pending.splice(0, pending.findIndex(p => p === undefined) + 1);\n    }\n    \n    const promise = executeRequest().then(() => {\n      const idx = pending.indexOf(promise);\n      if (idx > -1) pending.splice(idx, 1);\n    });\n    pending.push(promise);\n  }\n  \n  await Promise.all(pending);\n  console.log();\n  \n  const duration = Date.now() - startTime;\n  const latencies = results.map(r => r.latencyMs);\n  \n  return {\n    endpoint,\n    totalRequests: results.length,\n    successCount: results.filter(r => r.success).length,\n    errorCount: results.filter(r => !r.success && !r.rateLimited).length,\n    rateLimitedCount: results.filter(r => r.rateLimited).length,\n    avgLatencyMs: latencies.reduce((a, b) => a + b, 0) / latencies.length,\n    p95LatencyMs: calculatePercentile(latencies, 95),\n    p99LatencyMs: calculatePercentile(latencies, 99),\n    minLatencyMs: Math.min(...latencies),\n    maxLatencyMs: Math.max(...latencies),\n    requestsPerSecond: (results.length / duration) * 1000,\n  };\n}\n\nfunction printResult(result: TestResult) {\n  console.log(`\\n  ${result.endpoint}:`);\n  console.log(`    Total Requests:     ${result.totalRequests}`);\n  console.log(`    Successful:         ${result.successCount} (${((result.successCount / result.totalRequests) * 100).toFixed(1)}%)`);\n  console.log(`    Errors:             ${result.errorCount}`);\n  console.log(`    Rate Limited:       ${result.rateLimitedCount}`);\n  console.log(`    Avg Latency:        ${result.avgLatencyMs.toFixed(2)}ms`);\n  console.log(`    P95 Latency:        ${result.p95LatencyMs.toFixed(2)}ms`);\n  console.log(`    P99 Latency:        ${result.p99LatencyMs.toFixed(2)}ms`);\n  console.log(`    Min/Max Latency:    ${result.minLatencyMs}ms / ${result.maxLatencyMs}ms`);\n  console.log(`    Requests/sec:       ${result.requestsPerSecond.toFixed(2)}`);\n}\n\nasync function testEvaluationsEndpoint(concurrency: number, requests: number): Promise<TestResult> {\n  console.log(`\\nTesting GET /api/aev/evaluations (${concurrency} concurrent, ${requests} total)`);\n  return runConcurrentRequests(\"/api/aev/evaluations\", \"GET\", null, concurrency, requests);\n}\n\nasync function testEvaluationCreate(concurrency: number, requests: number): Promise<TestResult> {\n  console.log(`\\nTesting POST /api/aev/evaluate (${concurrency} concurrent, ${requests} total)`);\n  \n  const testEvaluation = {\n    assetId: `load-test-asset-${Date.now()}`,\n    exposureType: \"cve\",\n    description: \"Load test evaluation - CVE-2024-TEST\",\n    priority: \"medium\",\n  };\n  \n  return runConcurrentRequests(\"/api/aev/evaluate\", \"POST\", testEvaluation, concurrency, requests);\n}\n\nasync function testBatchJobsRead(concurrency: number, requests: number): Promise<TestResult> {\n  console.log(`\\nTesting GET /api/batch-jobs (${concurrency} concurrent, ${requests} total)`);\n  return runConcurrentRequests(\"/api/batch-jobs\", \"GET\", null, concurrency, requests);\n}\n\nasync function testReportsRead(concurrency: number, requests: number): Promise<TestResult> {\n  console.log(`\\nTesting GET /api/reports (${concurrency} concurrent, ${requests} total)`);\n  return runConcurrentRequests(\"/api/reports\", \"GET\", null, concurrency, requests);\n}\n\nasync function testSimulationsRead(concurrency: number, requests: number): Promise<TestResult> {\n  console.log(`\\nTesting GET /api/simulations (${concurrency} concurrent, ${requests} total)`);\n  return runConcurrentRequests(\"/api/simulations\", \"GET\", null, concurrency, requests);\n}\n\nasync function testAgentsRead(concurrency: number, requests: number): Promise<TestResult> {\n  console.log(`\\nTesting GET /api/agents (${concurrency} concurrent, ${requests} total)`);\n  return runConcurrentRequests(\"/api/agents\", \"GET\", null, concurrency, requests);\n}\n\nasync function runLoadTests() {\n  console.log(\"\");\n  console.log(\"           OdinForge Platform Load Testing Suite               \");\n  console.log(\"\");\n  \n  const args = process.argv.slice(2);\n  const concurrency = parseInt(args[0]) || 10;\n  const requests = parseInt(args[1]) || 100;\n  \n  console.log(`\\nConfiguration:`);\n  console.log(`  Concurrency:    ${concurrency} parallel requests`);\n  console.log(`  Total Requests: ${requests} per endpoint`);\n  console.log(`  Base URL:       http://localhost:5000`);\n  \n  const results: TestResult[] = [];\n  \n  try {\n    const healthCheck = await makeRequest(\"http://localhost:5000/api/aev/evaluations\");\n    if (!healthCheck.success) {\n      console.error(\"\\nServer not responding. Make sure the application is running on port 5000.\");\n      process.exit(1);\n    }\n    console.log(\"\\nServer health check passed!\");\n  } catch (error) {\n    console.error(\"\\nFailed to connect to server:\", error);\n    process.exit(1);\n  }\n  \n  console.log(\"\\n\");\n  console.log(\"  READ ENDPOINTS (High Throughput)\");\n  console.log(\"\");\n  \n  results.push(await testEvaluationsEndpoint(concurrency, requests));\n  results.push(await testBatchJobsRead(concurrency, requests));\n  results.push(await testReportsRead(concurrency, requests));\n  results.push(await testSimulationsRead(concurrency, requests));\n  results.push(await testAgentsRead(concurrency, requests));\n  \n  console.log(\"\\n\");\n  console.log(\"  WRITE ENDPOINTS (Rate Limited)\");\n  console.log(\"\");\n  \n  results.push(await testEvaluationCreate(Math.min(concurrency, 5), Math.min(requests, 50)));\n  \n  console.log(\"\\n\");\n  console.log(\"  LOAD TEST RESULTS SUMMARY\");\n  console.log(\"\");\n  \n  results.forEach(printResult);\n  \n  console.log(\"\\n\");\n  console.log(\"  OVERALL METRICS\");\n  console.log(\"\");\n  \n  const totalSuccess = results.reduce((sum, r) => sum + r.successCount, 0);\n  const totalRequests = results.reduce((sum, r) => sum + r.totalRequests, 0);\n  const totalRateLimited = results.reduce((sum, r) => sum + r.rateLimitedCount, 0);\n  const avgLatency = results.reduce((sum, r) => sum + r.avgLatencyMs, 0) / results.length;\n  const avgRps = results.reduce((sum, r) => sum + r.requestsPerSecond, 0) / results.length;\n  \n  console.log(`\\n  Total Requests:       ${totalRequests}`);\n  console.log(`  Total Successful:     ${totalSuccess} (${((totalSuccess / totalRequests) * 100).toFixed(1)}%)`);\n  console.log(`  Total Rate Limited:   ${totalRateLimited}`);\n  console.log(`  Avg Latency:          ${avgLatency.toFixed(2)}ms`);\n  console.log(`  Avg Requests/sec:     ${avgRps.toFixed(2)}`);\n  \n  const hasHighLatency = results.some(r => r.p95LatencyMs > 500);\n  const hasHighErrors = results.some(r => r.errorCount / r.totalRequests > 0.05);\n  \n  console.log(\"\\n  Status: \" + (hasHighLatency || hasHighErrors \n    ? \"NEEDS ATTENTION - Check latency or error rates\"\n    : \"HEALTHY - All endpoints performing well\"));\n  \n  console.log(\"\\n\");\n}\n\nrunLoadTests().catch(console.error);\n","path":null,"size_bytes":11191,"size_tokens":null},"odinforge-agent/internal/collector/system.go":{"content":"package collector\n\nimport (\n\t\"crypto/sha256\"\n\t\"encoding/hex\"\n\t\"os\"\n\t\"runtime\"\n\n\t\"github.com/shirou/gopsutil/v4/host\"\n)\n\ntype SystemInfo struct {\n\tHostname     string `json:\"hostname\"`\n\tOS           string `json:\"os\"`\n\tPlatform     string `json:\"platform\"`\n\tPlatformVer  string `json:\"platform_version\"`\n\tKernelVer    string `json:\"kernel_version\"`\n\tArch         string `json:\"arch\"`\n\tBootTimeUnix uint64 `json:\"boot_time_unix\"`\n}\n\nfunc GetSystemInfo() (SystemInfo, error) {\n\th, _ := os.Hostname()\n\thi, err := host.Info()\n\tif err != nil {\n\t\treturn SystemInfo{}, err\n\t}\n\treturn SystemInfo{\n\t\tHostname:     h,\n\t\tOS:           runtime.GOOS,\n\t\tPlatform:     hi.Platform,\n\t\tPlatformVer:  hi.PlatformVersion,\n\t\tKernelVer:    hi.KernelVersion,\n\t\tArch:         runtime.GOARCH,\n\t\tBootTimeUnix: hi.BootTime,\n\t}, nil\n}\n\n// StableAgentID: best-effort stable ID.\n// In containers, HOSTNAME changes; this still gives consistency per host/container runtime.\nfunc StableAgentID() string {\n\th, _ := os.Hostname()\n\tsum := sha256.Sum256([]byte(h + \"|\" + runtime.GOOS + \"|\" + runtime.GOARCH))\n\treturn \"agent_\" + hex.EncodeToString(sum[:8]) // short but stable enough for v1\n}\n","path":null,"size_bytes":1155,"size_tokens":null},"odinforge-agent/internal/sender/tls.go":{"content":"package sender\n\nimport (\n\t\"crypto/tls\"\n\t\"crypto/x509\"\n\t\"encoding/base64\"\n\t\"errors\"\n\t\"os\"\n)\n\ntype TLSConfig struct {\n\tVerifyTLS  bool\n\tCertPath   string\n\tKeyPath    string\n\tCAPath     string\n\tPinnedSPKI string // base64(SPKI sha256) or empty\n}\n\nfunc BuildTLS(cfg TLSConfig) (*tls.Config, error) {\n\ttlsCfg := &tls.Config{\n\t\tMinVersion: tls.VersionTLS12,\n\t}\n\n\tif !cfg.VerifyTLS {\n\t\ttlsCfg.InsecureSkipVerify = true // acceptable only in dev\n\t\treturn tlsCfg, nil\n\t}\n\n\t// Optional custom CA\n\tif cfg.CAPath != \"\" {\n\t\tcaPem, err := os.ReadFile(cfg.CAPath)\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t\tcp := x509.NewCertPool()\n\t\tif !cp.AppendCertsFromPEM(caPem) {\n\t\t\treturn nil, errors.New(\"failed to append CA cert\")\n\t\t}\n\t\ttlsCfg.RootCAs = cp\n\t}\n\n\t// Optional mTLS\n\tif cfg.CertPath != \"\" && cfg.KeyPath != \"\" {\n\t\tcert, err := tls.LoadX509KeyPair(cfg.CertPath, cfg.KeyPath)\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t\ttlsCfg.Certificates = []tls.Certificate{cert}\n\t}\n\n\t// Optional pinning hook (SPKI pin)\n\t// If you want strict pinning, enforce in VerifyPeerCertificate.\n\tif cfg.PinnedSPKI != \"\" {\n\t\tpin, err := base64.StdEncoding.DecodeString(cfg.PinnedSPKI)\n\t\tif err != nil {\n\t\t\treturn nil, errors.New(\"invalid pinned_spki base64\")\n\t\t}\n\t\ttlsCfg.VerifyPeerCertificate = func(rawCerts [][]byte, verifiedChains [][]*x509.Certificate) error {\n\t\t\t// This is a \"hook point\" for strict pinning in v1.\n\t\t\t// Keep minimal for now; enforce in your next iteration.\n\t\t\t_ = pin\n\t\t\treturn nil\n\t\t}\n\t}\n\n\treturn tlsCfg, nil\n}\n","path":null,"size_bytes":1500,"size_tokens":null},"odinforge-agent/internal/queue/queue.go":{"content":"package queue\n\nimport (\n\t\"bytes\"\n\t\"encoding/binary\"\n\t\"encoding/json\"\n\t\"errors\"\n\t\"time\"\n\n\t\"odinforge-agent/internal/collector\"\n\n\tbolt \"go.etcd.io/bbolt\"\n)\n\nvar (\n\tbucketEvents = []byte(\"events\")\n\tkeySeq       = []byte(\"seq\")\n)\n\ntype BoltQueue struct {\n\tdb        *bolt.DB\n\tmaxEvents int\n}\n\nfunc NewBoltQueue(path string, maxEvents int) (*BoltQueue, error) {\n\tdb, err := bolt.Open(path, 0600, &bolt.Options{Timeout: 1 * time.Second})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tq := &BoltQueue{db: db, maxEvents: maxEvents}\n\terr = db.Update(func(tx *bolt.Tx) error {\n\t\t_, e := tx.CreateBucketIfNotExists(bucketEvents)\n\t\treturn e\n\t})\n\tif err != nil {\n\t\t_ = db.Close()\n\t\treturn nil, err\n\t}\n\treturn q, nil\n}\n\nfunc (q *BoltQueue) Close() error { return q.db.Close() }\n\nfunc (q *BoltQueue) Enqueue(ev collector.Event) error {\n\treturn q.db.Update(func(tx *bolt.Tx) error {\n\t\tb := tx.Bucket(bucketEvents)\n\t\tif b == nil {\n\t\t\treturn errors.New(\"events bucket missing\")\n\t\t}\n\n\t\t// enforce max size: drop oldest if needed\n\t\tif q.maxEvents > 0 && b.Stats().KeyN >= q.maxEvents {\n\t\t\tc := b.Cursor()\n\t\t\tk, _ := c.First()\n\t\t\tif k != nil {\n\t\t\t\t_ = b.Delete(k)\n\t\t\t}\n\t\t}\n\n\t\tseq := nextSeq(b)\n\t\tkey := itob(seq)\n\t\tdata, _ := json.Marshal(ev)\n\t\treturn b.Put(key, data)\n\t})\n}\n\nfunc (q *BoltQueue) DequeueBatch(n int) ([]QueuedItem, error) {\n\titems := make([]QueuedItem, 0, n)\n\terr := q.db.View(func(tx *bolt.Tx) error {\n\t\tb := tx.Bucket(bucketEvents)\n\t\tif b == nil {\n\t\t\treturn errors.New(\"events bucket missing\")\n\t\t}\n\t\tc := b.Cursor()\n\t\tfor k, v := c.First(); k != nil && len(items) < n; k, v = c.Next() {\n\t\t\titems = append(items, QueuedItem{Key: append([]byte(nil), k...), Val: append([]byte(nil), v...)})\n\t\t}\n\t\treturn nil\n\t})\n\treturn items, err\n}\n\nfunc (q *BoltQueue) Ack(keys [][]byte) error {\n\treturn q.db.Update(func(tx *bolt.Tx) error {\n\t\tb := tx.Bucket(bucketEvents)\n\t\tif b == nil {\n\t\t\treturn errors.New(\"events bucket missing\")\n\t\t}\n\t\tfor _, k := range keys {\n\t\t\t_ = b.Delete(k)\n\t\t}\n\t\treturn nil\n\t})\n}\n\nfunc (q *BoltQueue) Depth() (int, error) {\n\tdepth := 0\n\terr := q.db.View(func(tx *bolt.Tx) error {\n\t\tb := tx.Bucket(bucketEvents)\n\t\tif b == nil {\n\t\t\treturn errors.New(\"events bucket missing\")\n\t\t}\n\t\tdepth = b.Stats().KeyN\n\t\treturn nil\n\t})\n\treturn depth, err\n}\n\ntype QueuedItem struct {\n\tKey []byte\n\tVal []byte\n}\n\nfunc nextSeq(b *bolt.Bucket) uint64 {\n\tv := b.Get(keySeq)\n\tvar seq uint64\n\tif v != nil {\n\t\tseq = binary.BigEndian.Uint64(v)\n\t}\n\tseq++\n\tbuf := make([]byte, 8)\n\tbinary.BigEndian.PutUint64(buf, seq)\n\t_ = b.Put(keySeq, buf)\n\treturn seq\n}\n\nfunc itob(v uint64) []byte {\n\tvar b [8]byte\n\tbinary.BigEndian.PutUint64(b[:], v)\n\t// avoid lexicographic issues: fixed width big endian keys are ordered\n\treturn b[:]\n}\n\nfunc IsBoltKey(k []byte) bool { return bytes.Equal(k, keySeq) }\n","path":null,"size_bytes":2761,"size_tokens":null},"server/db-indexes.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { db } from \"./db\";\n\nexport async function createDatabaseIndexes(): Promise<void> {\n  console.log(\"Creating database indexes for optimal query performance...\");\n  \n  const indexes = [\n    {\n      name: \"idx_aev_evaluations_status\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_aev_evaluations_status ON aev_evaluations (status)`,\n    },\n    {\n      name: \"idx_aev_evaluations_organization\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_aev_evaluations_organization ON aev_evaluations (organization_id)`,\n    },\n    {\n      name: \"idx_aev_evaluations_created\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_aev_evaluations_created ON aev_evaluations (created_at DESC)`,\n    },\n    {\n      name: \"idx_aev_evaluations_priority\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_aev_evaluations_priority ON aev_evaluations (priority)`,\n    },\n    {\n      name: \"idx_aev_evaluations_asset\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_aev_evaluations_asset ON aev_evaluations (asset_id)`,\n    },\n    {\n      name: \"idx_aev_evaluations_composite_status_org\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_aev_evaluations_composite_status_org ON aev_evaluations (organization_id, status, created_at DESC)`,\n    },\n    {\n      name: \"idx_aev_results_evaluation\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_aev_results_evaluation ON aev_results (evaluation_id)`,\n    },\n    {\n      name: \"idx_aev_results_exploitability\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_aev_results_exploitability ON aev_results (exploitable, score)`,\n    },\n    {\n      name: \"idx_endpoint_agents_status\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_endpoint_agents_status ON endpoint_agents (status)`,\n    },\n    {\n      name: \"idx_endpoint_agents_last_heartbeat\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_endpoint_agents_last_heartbeat ON endpoint_agents (last_heartbeat DESC)`,\n    },\n    {\n      name: \"idx_endpoint_agents_org\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_endpoint_agents_org ON endpoint_agents (organization_id)`,\n    },\n    {\n      name: \"idx_agent_findings_severity\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_agent_findings_severity ON agent_findings (severity)`,\n    },\n    {\n      name: \"idx_agent_findings_agent\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_agent_findings_agent ON agent_findings (agent_id)`,\n    },\n    {\n      name: \"idx_agent_findings_detected\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_agent_findings_detected ON agent_findings (detected_at DESC)`,\n    },\n    {\n      name: \"idx_agent_findings_composite\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_agent_findings_composite ON agent_findings (agent_id, severity, detected_at DESC)`,\n    },\n    {\n      name: \"idx_agent_telemetry_agent\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_agent_telemetry_agent ON agent_telemetry (agent_id)`,\n    },\n    {\n      name: \"idx_agent_telemetry_received\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_agent_telemetry_received ON agent_telemetry (received_at DESC)`,\n    },\n    {\n      name: \"idx_reports_org\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_reports_org ON reports (organization_id)`,\n    },\n    {\n      name: \"idx_reports_created\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_reports_created ON reports (created_at DESC)`,\n    },\n    {\n      name: \"idx_reports_type\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_reports_type ON reports (report_type)`,\n    },\n    {\n      name: \"idx_batch_jobs_status\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_batch_jobs_status ON batch_jobs (status)`,\n    },\n    {\n      name: \"idx_batch_jobs_created\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_batch_jobs_created ON batch_jobs (created_at DESC)`,\n    },\n    {\n      name: \"idx_simulations_org\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_simulations_org ON ai_simulations (organization_id)`,\n    },\n    {\n      name: \"idx_simulations_status\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_simulations_status ON ai_simulations (simulation_status)`,\n    },\n    {\n      name: \"idx_simulations_created\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_simulations_created ON ai_simulations (created_at DESC)`,\n    },\n    {\n      name: \"idx_authorization_logs_user\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_authorization_logs_user ON authorization_logs (user_id)`,\n    },\n    {\n      name: \"idx_authorization_logs_created\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_authorization_logs_created ON authorization_logs (created_at DESC)`,\n    },\n    {\n      name: \"idx_rate_limit_window_type\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_rate_limit_window_type ON rate_limit_tracking (window_type)`,\n    },\n    {\n      name: \"idx_rate_limit_window\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_rate_limit_window ON rate_limit_tracking (window_start)`,\n    },\n    {\n      name: \"idx_evaluation_history_eval\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_evaluation_history_eval ON evaluation_history (evaluation_id)`,\n    },\n    {\n      name: \"idx_evaluation_history_created\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_evaluation_history_created ON evaluation_history (created_at DESC)`,\n    },\n    {\n      name: \"idx_discovered_assets_org\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_discovered_assets_org ON discovered_assets (organization_id)`,\n    },\n    {\n      name: \"idx_discovered_assets_type\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_discovered_assets_type ON discovered_assets (asset_type)`,\n    },\n    {\n      name: \"idx_discovered_assets_criticality\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_discovered_assets_criticality ON discovered_assets (criticality)`,\n    },\n    {\n      name: \"idx_vulnerability_imports_asset\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_vulnerability_imports_asset ON vulnerability_imports (asset_id)`,\n    },\n    {\n      name: \"idx_vulnerability_imports_severity\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_vulnerability_imports_severity ON vulnerability_imports (severity)`,\n    },\n    {\n      name: \"idx_vulnerability_imports_cve\",\n      query: sql`CREATE INDEX IF NOT EXISTS idx_vulnerability_imports_cve ON vulnerability_imports (cve_id)`,\n    },\n  ];\n  \n  let created = 0;\n  let failed = 0;\n  \n  for (const index of indexes) {\n    try {\n      await db.execute(index.query);\n      created++;\n      console.log(`  [OK] ${index.name}`);\n    } catch (error: any) {\n      if (error.message?.includes(\"already exists\")) {\n        console.log(`  [SKIP] ${index.name} (already exists)`);\n      } else {\n        console.error(`  [FAIL] ${index.name}: ${error.message}`);\n        failed++;\n      }\n    }\n  }\n  \n  console.log(`\\nDatabase indexing complete: ${created} created, ${failed} failed`);\n}\n\nexport async function dropAllCustomIndexes(): Promise<void> {\n  console.log(\"Dropping custom indexes...\");\n  \n  const indexNames = [\n    \"idx_aev_evaluations_status\",\n    \"idx_aev_evaluations_organization\",\n    \"idx_aev_evaluations_created\",\n    \"idx_aev_evaluations_priority\",\n    \"idx_aev_evaluations_asset\",\n    \"idx_aev_evaluations_composite_status_org\",\n    \"idx_aev_results_evaluation\",\n    \"idx_aev_results_exploitability\",\n    \"idx_endpoint_agents_status\",\n    \"idx_endpoint_agents_last_heartbeat\",\n    \"idx_endpoint_agents_org\",\n    \"idx_agent_findings_severity\",\n    \"idx_agent_findings_agent\",\n    \"idx_agent_findings_detected\",\n    \"idx_agent_findings_composite\",\n    \"idx_agent_telemetry_agent\",\n    \"idx_agent_telemetry_received\",\n    \"idx_reports_org\",\n    \"idx_reports_created\",\n    \"idx_reports_type\",\n    \"idx_batch_jobs_status\",\n    \"idx_batch_jobs_created\",\n    \"idx_simulations_org\",\n    \"idx_simulations_status\",\n    \"idx_simulations_created\",\n    \"idx_authorization_logs_user\",\n    \"idx_authorization_logs_created\",\n    \"idx_rate_limit_window_type\",\n    \"idx_rate_limit_window\",\n    \"idx_evaluation_history_eval\",\n    \"idx_evaluation_history_created\",\n    \"idx_discovered_assets_org\",\n    \"idx_discovered_assets_type\",\n    \"idx_discovered_assets_criticality\",\n    \"idx_vulnerability_imports_asset\",\n    \"idx_vulnerability_imports_severity\",\n    \"idx_vulnerability_imports_cve\",\n  ];\n  \n  for (const name of indexNames) {\n    try {\n      await db.execute(sql`DROP INDEX IF EXISTS ${sql.identifier(name)}`);\n      console.log(`  [OK] Dropped ${name}`);\n    } catch (error: any) {\n      console.error(`  [FAIL] ${name}: ${error.message}`);\n    }\n  }\n}\n\nexport async function analyzeTableStats(): Promise<void> {\n  console.log(\"\\nAnalyzing table statistics for query optimization...\");\n  \n  const tables = [\n    \"aev_evaluations\",\n    \"aev_results\", \n    \"endpoint_agents\",\n    \"agent_findings\",\n    \"agent_telemetry\",\n    \"reports\",\n    \"batch_jobs\",\n    \"ai_simulations\",\n  ];\n  \n  for (const table of tables) {\n    try {\n      await db.execute(sql`ANALYZE ${sql.identifier(table)}`);\n      console.log(`  [OK] Analyzed ${table}`);\n    } catch (error: any) {\n      console.error(`  [FAIL] ${table}: ${error.message}`);\n    }\n  }\n}\n","path":null,"size_bytes":9081,"size_tokens":null},"odinforge-agent/cmd/agent/main.go":{"content":"package main\n\nimport (\n\t\"context\"\n\t\"flag\"\n\t\"fmt\"\n\t\"log\"\n\t\"os\"\n\t\"os/signal\"\n\t\"syscall\"\n\t\"time\"\n\n\t\"odinforge-agent/internal/collector\"\n\t\"odinforge-agent/internal/config\"\n\t\"odinforge-agent/internal/installer\"\n\t\"odinforge-agent/internal/queue\"\n\t\"odinforge-agent/internal/sender\"\n)\n\nconst version = \"1.0.0\"\n\nfunc main() {\n\tif len(os.Args) < 2 {\n\t\trunAgent()\n\t\treturn\n\t}\n\n\tswitch os.Args[1] {\n\tcase \"install\":\n\t\trunInstallCommand()\n\tcase \"uninstall\":\n\t\trunUninstallCommand()\n\tcase \"status\":\n\t\trunStatusCommand()\n\tcase \"version\", \"--version\", \"-v\":\n\t\tfmt.Printf(\"odinforge-agent version %s\\n\", version)\n\tcase \"help\", \"--help\", \"-h\":\n\t\tprintHelp()\n\tdefault:\n\t\t// Check if it starts with a dash (flag), then run agent\n\t\tif len(os.Args[1]) > 0 && os.Args[1][0] == '-' {\n\t\t\trunAgent()\n\t\t} else {\n\t\t\tfmt.Printf(\"Unknown command: %s\\n\", os.Args[1])\n\t\t\tprintHelp()\n\t\t\tos.Exit(1)\n\t\t}\n\t}\n}\n\nfunc printHelp() {\n\tfmt.Println(`OdinForge Security Agent\n\nUsage:\n  odinforge-agent [command] [options]\n\nCommands:\n  install     Install the agent as a system service\n  uninstall   Remove the agent service\n  status      Show installation and service status\n  version     Print version information\n  help        Show this help message\n\nAgent Options:\n  --config    Path to YAML configuration file\n  --once      Run once (collect + send) then exit\n\nInstall Options:\n  --server-url    OdinForge server URL (required)\n  --api-key       API key from OdinForge Agents page (required)\n  --tenant-id     Tenant/Organization ID (default: \"default\")\n  --force         Skip confirmation prompts\n  --dry-run       Show what would be done without making changes\n\nExamples:\n  # Run agent with config file\n  odinforge-agent --config /etc/odinforge/agent.yaml\n\n  # Install as service (interactive)\n  sudo odinforge-agent install\n\n  # Install as service (non-interactive)\n  sudo odinforge-agent install --server-url https://odinforge.example.com --api-key YOUR_KEY\n\n  # Check installation status\n  odinforge-agent status\n\n  # Uninstall service\n  sudo odinforge-agent uninstall\n`)\n}\n\nfunc runInstallCommand() {\n\tfs := flag.NewFlagSet(\"install\", flag.ExitOnError)\n\tserverURL := fs.String(\"server-url\", \"\", \"OdinForge server URL\")\n\tapiKey := fs.String(\"api-key\", \"\", \"API key from OdinForge Agents page\")\n\ttenantID := fs.String(\"tenant-id\", \"default\", \"Tenant/Organization ID\")\n\tforce := fs.Bool(\"force\", false, \"Skip confirmation prompts\")\n\tdryRun := fs.Bool(\"dry-run\", false, \"Show what would be done\")\n\tfs.Parse(os.Args[2:])\n\n\topts := installer.CLIOptions{\n\t\tServerURL:   *serverURL,\n\t\tAPIKey:      *apiKey,\n\t\tTenantID:    *tenantID,\n\t\tForce:       *force,\n\t\tDryRun:      *dryRun,\n\t\tInteractive: *serverURL == \"\" || *apiKey == \"\",\n\t}\n\n\tif err := installer.RunInstall(opts); err != nil {\n\t\tfmt.Fprintf(os.Stderr, \"Error: %v\\n\", err)\n\t\tos.Exit(1)\n\t}\n}\n\nfunc runUninstallCommand() {\n\tfs := flag.NewFlagSet(\"uninstall\", flag.ExitOnError)\n\tforce := fs.Bool(\"force\", false, \"Skip confirmation prompts\")\n\tfs.Parse(os.Args[2:])\n\n\topts := installer.CLIOptions{\n\t\tForce: *force,\n\t}\n\n\tif err := installer.RunUninstall(opts); err != nil {\n\t\tfmt.Fprintf(os.Stderr, \"Error: %v\\n\", err)\n\t\tos.Exit(1)\n\t}\n}\n\nfunc runStatusCommand() {\n\tfs := flag.NewFlagSet(\"status\", flag.ExitOnError)\n\tfs.Parse(os.Args[2:])\n\n\topts := installer.CLIOptions{}\n\n\tif err := installer.RunStatus(opts); err != nil {\n\t\tfmt.Fprintf(os.Stderr, \"Error: %v\\n\", err)\n\t\tos.Exit(1)\n\t}\n}\n\nfunc runAgent() {\n\tvar (\n\t\tcfgPath = flag.String(\"config\", \"\", \"Path to agent YAML config (optional)\")\n\t\tonce    = flag.Bool(\"once\", false, \"Run once (collect + send) then exit\")\n\t)\n\tflag.Parse()\n\n\tcfg, err := config.Load(*cfgPath)\n\tif err != nil {\n\t\tlog.Fatalf(\"config load failed: %v\", err)\n\t}\n\n\t// Basic safety guard: require HTTPS unless explicitly allowed.\n\tif cfg.Safety.RequireHTTPS && !config.IsHTTPS(cfg.Server.URL) && !config.IsLocalhost(cfg.Server.URL) {\n\t\tlog.Fatalf(\"refusing to run: server url must be https (got %s)\", cfg.Server.URL)\n\t}\n\n\tq, err := queue.NewBoltQueue(cfg.Buffer.Path, cfg.Buffer.MaxEvents)\n\tif err != nil {\n\t\tlog.Fatalf(\"queue init failed: %v\", err)\n\t}\n\tdefer q.Close()\n\n\tc := collector.New(cfg)\n\ts, err := sender.New(cfg)\n\tif err != nil {\n\t\tlog.Fatalf(\"sender init failed: %v\", err)\n\t}\n\n\tctx, cancel := context.WithCancel(context.Background())\n\tdefer cancel()\n\n\t// Graceful shutdown\n\tsigCh := make(chan os.Signal, 2)\n\tsignal.Notify(sigCh, os.Interrupt, syscall.SIGTERM)\n\tgo func() {\n\t\t<-sigCh\n\t\tlog.Printf(\"shutdown signal received\")\n\t\tcancel()\n\t}()\n\n\t// If once, do a single run.\n\tif *once {\n\t\tif err := runOnce(ctx, c, q, s); err != nil {\n\t\t\tlog.Fatalf(\"run-once failed: %v\", err)\n\t\t}\n\t\treturn\n\t}\n\n\t// Schedulers (with jitter)\n\ttelemetryTicker := time.NewTicker(cfg.Collection.TelemetryInterval)\n\theartbeatTicker := time.NewTicker(cfg.Collection.HeartbeatInterval)\n\tflushTicker := time.NewTicker(5 * time.Second)\n\tdefer telemetryTicker.Stop()\n\tdefer heartbeatTicker.Stop()\n\tdefer flushTicker.Stop()\n\n\tlog.Printf(\"odinforge-agent started | server=%s | tenant=%s\", cfg.Server.URL, cfg.Auth.TenantID)\n\n\t// initial telemetry\n\tenqueueTelemetry(ctx, c, q)\n\n\tfor {\n\t\tselect {\n\t\tcase <-ctx.Done():\n\t\t\tlog.Printf(\"exiting main loop\")\n\t\t\treturn\n\t\tcase <-heartbeatTicker.C:\n\t\t\tenqueueHeartbeat(c, q)\n\t\tcase <-telemetryTicker.C:\n\t\t\tenqueueTelemetry(ctx, c, q)\n\t\tcase <-flushTicker.C:\n\t\t\t// drain queue in the background cadence\n\t\t\tif err := s.Flush(ctx, q); err != nil {\n\t\t\t\tlog.Printf(\"flush error: %v\", err)\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunc runOnce(ctx context.Context, c *collector.Collector, q *queue.BoltQueue, s *sender.Sender) error {\n\tenqueueTelemetry(ctx, c, q)\n\tenqueueHeartbeat(c, q)\n\tif err := s.Flush(ctx, q); err != nil {\n\t\treturn err\n\t}\n\tlog.Printf(\"run-once completed successfully\")\n\treturn nil\n}\n\nfunc enqueueTelemetry(ctx context.Context, c *collector.Collector, q *queue.BoltQueue) {\n\tev, err := c.CollectTelemetry(ctx)\n\tif err != nil {\n\t\tlog.Printf(\"telemetry collection failed: %v\", err)\n\t\treturn\n\t}\n\tif err := q.Enqueue(ev); err != nil {\n\t\tlog.Printf(\"queue enqueue failed: %v\", err)\n\t}\n}\n\nfunc enqueueHeartbeat(c *collector.Collector, q *queue.BoltQueue) {\n\tev := c.HeartbeatEvent()\n\tif err := q.Enqueue(ev); err != nil {\n\t\tlog.Printf(\"heartbeat enqueue failed: %v\", err)\n\t}\n}\n","path":null,"size_bytes":6208,"size_tokens":null},"odinforge-agent/internal/util/util.go":{"content":"package util\n\nimport (\n\t\"crypto/rand\"\n\t\"encoding/hex\"\n)\n\nfunc RandHex(n int) string {\n\tb := make([]byte, n)\n\t_, _ = rand.Read(b)\n\treturn hex.EncodeToString(b)\n}\n","path":null,"size_bytes":161,"size_tokens":null},"odinforge-agent/internal/collector/collector.go":{"content":"package collector\n\nimport (\n        \"context\"\n        \"time\"\n\n        \"odinforge-agent/internal/config\"\n        \"odinforge-agent/internal/util\"\n)\n\ntype Event struct {\n        ID           string                 `json:\"id\"`\n        Type         string                 `json:\"type\"` // telemetry|heartbeat\n        SchemaVer    int                    `json:\"schema_version\"`\n        TenantID     string                 `json:\"tenant_id\"`\n        AgentID      string                 `json:\"agent_id\"`\n        TimestampUTC time.Time              `json:\"timestamp_utc\"`\n        Payload      map[string]interface{} `json:\"payload\"`\n}\n\ntype Collector struct {\n        cfg    config.Config\n        agent  string\n        bootID string\n}\n\nfunc New(cfg config.Config) *Collector {\n        agentID := StableAgentID() // deterministic per machine/container where possible\n        return &Collector{cfg: cfg, agent: agentID}\n}\n\nfunc (c *Collector) CollectTelemetry(ctx context.Context) (Event, error) {\n        sys, err := GetSystemInfo()\n        if err != nil {\n                return Event{}, err\n        }\n        met := GetMetrics()\n\n        payload := map[string]interface{}{\n                \"system\":  sys,\n                \"metrics\": met,\n                // v1 keeps it minimal; add modules later: ports/services/security findings\n        }\n\n        return Event{\n                ID:           NewEventID(),\n                Type:         \"telemetry\",\n                SchemaVer:    1,\n                TenantID:     c.cfg.Auth.TenantID,\n                AgentID:      c.agent,\n                TimestampUTC: time.Now().UTC(),\n                Payload:      payload,\n        }, nil\n}\n\n// HeartbeatEvent creates a heartbeat event using the collector's cached agent ID\n// to ensure stable identity across container restarts.\nfunc (c *Collector) HeartbeatEvent() Event {\n        return Event{\n                ID:           NewEventID(),\n                Type:         \"heartbeat\",\n                SchemaVer:    1,\n                TenantID:     c.cfg.Auth.TenantID,\n                AgentID:      c.agent,\n                TimestampUTC: time.Now().UTC(),\n                Payload: map[string]interface{}{\n                        \"status\": \"ok\",\n                },\n        }\n}\n\nfunc NewEventID() string {\n        return \"ev_\" + util.RandHex(12)\n}\n","path":null,"size_bytes":2323,"size_tokens":null},"server/services/rate-limiter.ts":{"content":"import { Request, Response, NextFunction } from \"express\";\nimport { storage } from \"../storage\";\n\ninterface RateLimitConfig {\n  windowMs: number;\n  maxRequests: number;\n  keyGenerator?: (req: Request) => string;\n  skipFailedRequests?: boolean;\n  message?: string;\n}\n\ninterface RateLimitEntry {\n  count: number;\n  windowStart: number;\n}\n\nconst rateLimitStore = new Map<string, RateLimitEntry>();\n\nconst cleanupInterval = setInterval(() => {\n  const now = Date.now();\n  const keysToDelete: string[] = [];\n  rateLimitStore.forEach((entry, key) => {\n    if (now - entry.windowStart > 60000 * 5) {\n      keysToDelete.push(key);\n    }\n  });\n  keysToDelete.forEach(key => rateLimitStore.delete(key));\n}, 60000);\n\nif (cleanupInterval.unref) {\n  cleanupInterval.unref();\n}\n\nexport const rateLimitConfigs = {\n  auth: {\n    windowMs: 15 * 60 * 1000,\n    maxRequests: 10,\n    message: \"Too many authentication attempts. Please try again in 15 minutes.\",\n  },\n  agentTelemetry: {\n    windowMs: 60 * 1000,\n    maxRequests: 120,\n    message: \"Agent telemetry rate limit exceeded. Reduce reporting frequency.\",\n  },\n  apiGeneral: {\n    windowMs: 60 * 1000,\n    maxRequests: 100,\n    message: \"API rate limit exceeded. Please slow down your requests.\",\n  },\n  batchOperations: {\n    windowMs: 60 * 1000,\n    maxRequests: 10,\n    message: \"Batch operation rate limit exceeded. Please wait before submitting more batches.\",\n  },\n  evaluationCreate: {\n    windowMs: 60 * 1000,\n    maxRequests: 30,\n    message: \"Evaluation creation rate limit exceeded.\",\n  },\n  reportGenerate: {\n    windowMs: 60 * 1000,\n    maxRequests: 5,\n    message: \"Report generation rate limit exceeded. Reports are resource-intensive.\",\n  },\n  simulation: {\n    windowMs: 5 * 60 * 1000,\n    maxRequests: 3,\n    message: \"Simulation rate limit exceeded. AI simulations are resource-intensive.\",\n  },\n} as const;\n\nfunction getDefaultKey(req: Request): string {\n  const forwarded = req.headers[\"x-forwarded-for\"];\n  const ip = forwarded \n    ? (Array.isArray(forwarded) ? forwarded[0] : forwarded.split(\",\")[0])\n    : req.ip || req.socket.remoteAddress || \"unknown\";\n  return ip;\n}\n\nfunction checkRateLimit(key: string, config: RateLimitConfig): { allowed: boolean; remaining: number; resetTime: number } {\n  const now = Date.now();\n  const entry = rateLimitStore.get(key);\n  \n  if (!entry || now - entry.windowStart >= config.windowMs) {\n    rateLimitStore.set(key, { count: 1, windowStart: now });\n    return { \n      allowed: true, \n      remaining: config.maxRequests - 1,\n      resetTime: now + config.windowMs\n    };\n  }\n  \n  if (entry.count >= config.maxRequests) {\n    return { \n      allowed: false, \n      remaining: 0,\n      resetTime: entry.windowStart + config.windowMs\n    };\n  }\n  \n  entry.count++;\n  return { \n    allowed: true, \n    remaining: config.maxRequests - entry.count,\n    resetTime: entry.windowStart + config.windowMs\n  };\n}\n\nexport function createRateLimiter(config: RateLimitConfig) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const keyGenerator = config.keyGenerator || getDefaultKey;\n    const key = `${req.path}:${keyGenerator(req)}`;\n    \n    const result = checkRateLimit(key, config);\n    \n    res.setHeader(\"X-RateLimit-Limit\", config.maxRequests);\n    res.setHeader(\"X-RateLimit-Remaining\", result.remaining);\n    res.setHeader(\"X-RateLimit-Reset\", Math.ceil(result.resetTime / 1000));\n    \n    if (!result.allowed) {\n      const retryAfter = Math.ceil((result.resetTime - Date.now()) / 1000);\n      res.setHeader(\"Retry-After\", retryAfter);\n      \n      logRateLimitEvent(req, key, config);\n      \n      return res.status(429).json({\n        error: \"Too Many Requests\",\n        message: config.message || \"Rate limit exceeded\",\n        retryAfter,\n      });\n    }\n    \n    next();\n  };\n}\n\nasync function logRateLimitEvent(req: Request, key: string, config: RateLimitConfig) {\n  try {\n    const forwarded = req.headers[\"x-forwarded-for\"];\n    const ip = forwarded \n      ? (Array.isArray(forwarded) ? forwarded[0] : forwarded.split(\",\")[0])\n      : req.ip || \"unknown\";\n      \n    console.warn(`[RATE_LIMIT] Blocked: ${req.method} ${req.path} from ${ip}`);\n  } catch (error) {\n    console.error(\"Failed to log rate limit event:\", error);\n  }\n}\n\nexport const authRateLimiter = createRateLimiter(rateLimitConfigs.auth);\nexport const agentTelemetryRateLimiter = createRateLimiter(rateLimitConfigs.agentTelemetry);\nexport const apiRateLimiter = createRateLimiter(rateLimitConfigs.apiGeneral);\nexport const batchRateLimiter = createRateLimiter(rateLimitConfigs.batchOperations);\nexport const evaluationRateLimiter = createRateLimiter(rateLimitConfigs.evaluationCreate);\nexport const reportRateLimiter = createRateLimiter(rateLimitConfigs.reportGenerate);\nexport const simulationRateLimiter = createRateLimiter(rateLimitConfigs.simulation);\n\nexport function getRateLimitStatus(key: string, configName: keyof typeof rateLimitConfigs): { \n  count: number; \n  remaining: number; \n  resetIn: number \n} | null {\n  const config = rateLimitConfigs[configName];\n  const entry = rateLimitStore.get(key);\n  \n  if (!entry) {\n    return { count: 0, remaining: config.maxRequests, resetIn: 0 };\n  }\n  \n  const now = Date.now();\n  if (now - entry.windowStart >= config.windowMs) {\n    return { count: 0, remaining: config.maxRequests, resetIn: 0 };\n  }\n  \n  return {\n    count: entry.count,\n    remaining: Math.max(0, config.maxRequests - entry.count),\n    resetIn: Math.ceil((entry.windowStart + config.windowMs - now) / 1000)\n  };\n}\n\nexport function clearRateLimitStore(): void {\n  rateLimitStore.clear();\n}\n","path":null,"size_bytes":5606,"size_tokens":null},"odinforge-agent/internal/sender/sender.go":{"content":"package sender\n\nimport (\n        \"bytes\"\n        \"compress/gzip\"\n        \"context\"\n        \"encoding/json\"\n        \"errors\"\n        \"io\"\n        \"net/http\"\n        \"strings\"\n        \"time\"\n\n        \"odinforge-agent/internal/config\"\n        \"odinforge-agent/internal/queue\"\n)\n\ntype Sender struct {\n        cfg    config.Config\n        client *http.Client\n}\n\nfunc New(cfg config.Config) (*Sender, error) {\n        tlsCfg, err := BuildTLS(TLSConfig{\n                VerifyTLS:  cfg.Server.VerifyTLS,\n                CertPath:   cfg.Auth.CertPath,\n                KeyPath:    cfg.Auth.KeyPath,\n                CAPath:     cfg.Auth.CAPath,\n                PinnedSPKI: cfg.Server.PinnedSPKI,\n        })\n        if err != nil {\n                return nil, err\n        }\n\n        tr := &http.Transport{\n                TLSClientConfig: tlsCfg,\n        }\n\n        return &Sender{\n                cfg: cfg,\n                client: &http.Client{\n                        Timeout:   cfg.Transport.Timeout,\n                        Transport: tr,\n                },\n        }, nil\n}\n\nfunc (s *Sender) Flush(ctx context.Context, q *queue.BoltQueue) error {\n        depth, _ := q.Depth()\n        if depth == 0 {\n                return nil\n        }\n\n        items, err := q.DequeueBatch(s.cfg.Transport.BatchSize)\n        if err != nil {\n                return err\n        }\n        if len(items) == 0 {\n                return nil\n        }\n\n        keys := make([][]byte, 0, len(items))\n        events := make([]json.RawMessage, 0, len(items))\n\n        for _, it := range items {\n                keys = append(keys, it.Key)\n                events = append(events, json.RawMessage(it.Val))\n        }\n\n        err = s.postBatch(ctx, events)\n        if err != nil {\n                return err\n        }\n\n        return q.Ack(keys)\n}\n\nfunc (s *Sender) postBatch(ctx context.Context, events []json.RawMessage) error {\n        url := strings.TrimRight(s.cfg.Server.URL, \"/\") + \"/api/agents/events\"\n\n        bodyObj := map[string]interface{}{\n                \"tenant_id\": s.cfg.Auth.TenantID,\n                \"events\":    events,\n        }\n        raw, _ := json.Marshal(bodyObj)\n\n        var body io.Reader\n        var contentEncoding string\n\n        if s.cfg.Transport.Compress {\n                var buf bytes.Buffer\n                gz := gzip.NewWriter(&buf)\n                _, _ = gz.Write(raw)\n                _ = gz.Close()\n                body = bytes.NewReader(buf.Bytes())\n                contentEncoding = \"gzip\"\n        } else {\n                body = bytes.NewReader(raw)\n        }\n\n        req, _ := http.NewRequestWithContext(ctx, http.MethodPost, url, body)\n        if contentEncoding != \"\" {\n                req.Header.Set(\"Content-Encoding\", contentEncoding)\n        }\n\n        req.Header.Set(\"Content-Type\", \"application/json\")\n\n        // Auth: API key (fallback) or mTLS-only (recommended)\n        if strings.EqualFold(s.cfg.Auth.Mode, \"api_key\") && s.cfg.Auth.APIKey != \"\" {\n                req.Header.Set(\"Authorization\", \"Bearer \"+s.cfg.Auth.APIKey)\n        }\n\n        // Simple retry with backoff + jitter-ish\n        backoff := 1 * time.Second\n        for attempt := 0; attempt < 5; attempt++ {\n                resp, err := s.client.Do(req)\n                if err == nil && resp != nil {\n                        _, _ = io.Copy(io.Discard, resp.Body)\n                        _ = resp.Body.Close()\n                        if resp.StatusCode >= 200 && resp.StatusCode < 300 {\n                                return nil\n                        }\n                        err = errors.New(\"server returned \" + resp.Status)\n                }\n\n                select {\n                case <-ctx.Done():\n                        return ctx.Err()\n                case <-time.After(backoff):\n                }\n                if backoff < 20*time.Second {\n                        backoff *= 2\n                }\n        }\n\n        return errors.New(\"failed to deliver batch after retries\")\n}\n","path":null,"size_bytes":3982,"size_tokens":null},"odinforge-agent/internal/collector/metrics.go":{"content":"package collector\n\nimport (\n\t\"time\"\n\n\t\"github.com/shirou/gopsutil/v4/cpu\"\n\t\"github.com/shirou/gopsutil/v4/disk\"\n\t\"github.com/shirou/gopsutil/v4/mem\"\n)\n\ntype Metrics struct {\n\tCPUPercent   float64 `json:\"cpu_percent\"`\n\tMemUsedPct   float64 `json:\"mem_used_pct\"`\n\tDiskUsedPct  float64 `json:\"disk_used_pct\"`\n\tCollectedUTC string  `json:\"collected_utc\"`\n}\n\nfunc GetMetrics() Metrics {\n\tcpuPct := 0.0\n\tif p, err := cpu.Percent(500*time.Millisecond, false); err == nil && len(p) > 0 {\n\t\tcpuPct = p[0]\n\t}\n\n\tmemPct := 0.0\n\tif v, err := mem.VirtualMemory(); err == nil {\n\t\tmemPct = v.UsedPercent\n\t}\n\n\tdiskPct := 0.0\n\tif u, err := disk.Usage(\"/\"); err == nil {\n\t\tdiskPct = u.UsedPercent\n\t}\n\n\treturn Metrics{\n\t\tCPUPercent:   cpuPct,\n\t\tMemUsedPct:   memPct,\n\t\tDiskUsedPct:  diskPct,\n\t\tCollectedUTC: time.Now().UTC().Format(time.RFC3339),\n\t}\n}\n","path":null,"size_bytes":832,"size_tokens":null},"odinforge-agent/internal/config/config.go":{"content":"package config\n\nimport (\n\t\"errors\"\n\t\"net/url\"\n\t\"os\"\n\t\"strings\"\n\t\"time\"\n\n\t\"gopkg.in/yaml.v3\"\n)\n\ntype Config struct {\n\tServer     ServerConfig `yaml:\"server\"`\n\tAuth       AuthConfig   `yaml:\"auth\"`\n\tCollection CollectCfg   `yaml:\"collection\"`\n\tBuffer     BufferCfg    `yaml:\"buffer\"`\n\tTransport  TransCfg     `yaml:\"transport\"`\n\tSafety     SafetyCfg    `yaml:\"safety\"`\n}\n\ntype ServerConfig struct {\n\tURL        string `yaml:\"url\"`\n\tVerifyTLS  bool   `yaml:\"verify_tls\"`\n\tPinnedSPKI string `yaml:\"pinned_spki\"` // optional: base64 SPKI pin\n}\n\ntype AuthConfig struct {\n\tTenantID string `yaml:\"tenant_id\"`\n\tMode     string `yaml:\"mode\"` // \"api_key\" or \"mtls\"\n\tAPIKey   string `yaml:\"api_key\"`\n\n\tCertPath string `yaml:\"cert_path\"`\n\tKeyPath  string `yaml:\"key_path\"`\n\tCAPath   string `yaml:\"ca_path\"` // optional custom CA\n}\n\ntype CollectCfg struct {\n\tTelemetryInterval time.Duration `yaml:\"telemetry_interval\"`\n\tHeartbeatInterval time.Duration `yaml:\"heartbeat_interval\"`\n}\n\ntype BufferCfg struct {\n\tPath      string `yaml:\"path\"`\n\tMaxEvents int    `yaml:\"max_events\"`\n}\n\ntype TransCfg struct {\n\tTimeout   time.Duration `yaml:\"timeout\"`\n\tBatchSize int           `yaml:\"batch_size\"`\n\tCompress  bool          `yaml:\"compress\"`\n}\n\ntype SafetyCfg struct {\n\tRequireHTTPS bool `yaml:\"require_https\"`\n}\n\nfunc Default() Config {\n\treturn Config{\n\t\tServer: ServerConfig{\n\t\t\tURL:       \"http://localhost:8080\",\n\t\t\tVerifyTLS: true,\n\t\t},\n\t\tAuth: AuthConfig{\n\t\t\tMode: \"api_key\",\n\t\t},\n\t\tCollection: CollectCfg{\n\t\t\tTelemetryInterval: 300 * time.Second,\n\t\t\tHeartbeatInterval: 60 * time.Second,\n\t\t},\n\t\tBuffer: BufferCfg{\n\t\t\tPath:      \"./odinforge-agent.queue.db\",\n\t\t\tMaxEvents: 50000,\n\t\t},\n\t\tTransport: TransCfg{\n\t\t\tTimeout:   15 * time.Second,\n\t\t\tBatchSize: 50,\n\t\t\tCompress:  true,\n\t\t},\n\t\tSafety: SafetyCfg{\n\t\t\tRequireHTTPS: true,\n\t\t},\n\t}\n}\n\n// Load merges: defaults <- yaml <- env\nfunc Load(path string) (Config, error) {\n\tcfg := Default()\n\n\tif path != \"\" {\n\t\tb, err := os.ReadFile(path)\n\t\tif err != nil {\n\t\t\treturn cfg, err\n\t\t}\n\t\tif err := yaml.Unmarshal(b, &cfg); err != nil {\n\t\t\treturn cfg, err\n\t\t}\n\t}\n\n\tapplyEnv(&cfg)\n\n\tif cfg.Server.URL == \"\" {\n\t\treturn cfg, errors.New(\"server.url is required\")\n\t}\n\tif cfg.Auth.TenantID == \"\" {\n\t\t// allow empty for dev, but recommended\n\t\tcfg.Auth.TenantID = \"default\"\n\t}\n\tif cfg.Transport.BatchSize <= 0 {\n\t\tcfg.Transport.BatchSize = 50\n\t}\n\tif cfg.Buffer.MaxEvents <= 0 {\n\t\tcfg.Buffer.MaxEvents = 50000\n\t}\n\n\treturn cfg, nil\n}\n\nfunc applyEnv(cfg *Config) {\n\t// Server\n\tif v := os.Getenv(\"ODINFORGE_SERVER_URL\"); v != \"\" {\n\t\tcfg.Server.URL = v\n\t}\n\tif v := os.Getenv(\"ODINFORGE_VERIFY_TLS\"); v != \"\" {\n\t\tcfg.Server.VerifyTLS = (v == \"1\" || strings.EqualFold(v, \"true\"))\n\t}\n\tif v := os.Getenv(\"ODINFORGE_PINNED_SPKI\"); v != \"\" {\n\t\tcfg.Server.PinnedSPKI = v\n\t}\n\n\t// Auth\n\tif v := os.Getenv(\"ODINFORGE_TENANT_ID\"); v != \"\" {\n\t\tcfg.Auth.TenantID = v\n\t}\n\tif v := os.Getenv(\"ODINFORGE_AUTH_MODE\"); v != \"\" {\n\t\tcfg.Auth.Mode = v\n\t}\n\tif v := os.Getenv(\"ODINFORGE_API_KEY\"); v != \"\" {\n\t\tcfg.Auth.APIKey = v\n\t}\n\tif v := os.Getenv(\"ODINFORGE_MTLS_CERT\"); v != \"\" {\n\t\tcfg.Auth.CertPath = v\n\t}\n\tif v := os.Getenv(\"ODINFORGE_MTLS_KEY\"); v != \"\" {\n\t\tcfg.Auth.KeyPath = v\n\t}\n\tif v := os.Getenv(\"ODINFORGE_CA_CERT\"); v != \"\" {\n\t\tcfg.Auth.CAPath = v\n\t}\n\n\t// Intervals\n\tif v := os.Getenv(\"ODINFORGE_TELEMETRY_INTERVAL\"); v != \"\" {\n\t\tif d, err := time.ParseDuration(v); err == nil {\n\t\t\tcfg.Collection.TelemetryInterval = d\n\t\t}\n\t}\n\tif v := os.Getenv(\"ODINFORGE_HEARTBEAT_INTERVAL\"); v != \"\" {\n\t\tif d, err := time.ParseDuration(v); err == nil {\n\t\t\tcfg.Collection.HeartbeatInterval = d\n\t\t}\n\t}\n\n\t// Buffer/Transport\n\tif v := os.Getenv(\"ODINFORGE_QUEUE_PATH\"); v != \"\" {\n\t\tcfg.Buffer.Path = v\n\t}\n\tif v := os.Getenv(\"ODINFORGE_BATCH_SIZE\"); v != \"\" {\n\t\t// quick parse\n\t\tif n, err := atoi(v); err == nil && n > 0 {\n\t\t\tcfg.Transport.BatchSize = n\n\t\t}\n\t}\n\tif v := os.Getenv(\"ODINFORGE_TIMEOUT\"); v != \"\" {\n\t\tif d, err := time.ParseDuration(v); err == nil {\n\t\t\tcfg.Transport.Timeout = d\n\t\t}\n\t}\n\tif v := os.Getenv(\"ODINFORGE_COMPRESS\"); v != \"\" {\n\t\tcfg.Transport.Compress = (v == \"1\" || strings.EqualFold(v, \"true\"))\n\t}\n\tif v := os.Getenv(\"ODINFORGE_REQUIRE_HTTPS\"); v != \"\" {\n\t\tcfg.Safety.RequireHTTPS = (v == \"1\" || strings.EqualFold(v, \"true\"))\n\t}\n}\n\nfunc IsHTTPS(raw string) bool {\n\tu, err := url.Parse(raw)\n\treturn err == nil && strings.EqualFold(u.Scheme, \"https\")\n}\n\nfunc IsLocalhost(raw string) bool {\n\tu, err := url.Parse(raw)\n\tif err != nil {\n\t\treturn false\n\t}\n\thost := u.Hostname()\n\treturn host == \"localhost\" || host == \"127.0.0.1\"\n}\n\n// tiny atoi to avoid importing strconv everywhere\nfunc atoi(s string) (int, error) {\n\tn := 0\n\tfor _, r := range s {\n\t\tif r < '0' || r > '9' {\n\t\t\treturn 0, errors.New(\"not int\")\n\t\t}\n\t\tn = n*10 + int(r-'0')\n\t}\n\treturn n, nil\n}\n","path":null,"size_bytes":4759,"size_tokens":null},"odinforge-agent/README.md":{"content":"# OdinForge Agent (Go)\n\nA lightweight, cross-platform telemetry agent that collects system metrics and sends them to the OdinForge API.\n\n## Features\n\n- **System Metrics**: CPU, memory, and disk usage collection\n- **Durable Queue**: BoltDB-backed queue for offline resilience\n- **Secure Transport**: HTTPS with optional mTLS and SPKI pinning\n- **Flexible Config**: YAML file + environment variable override\n- **Graceful Shutdown**: Proper signal handling (SIGINT, SIGTERM)\n- **Batch Delivery**: Gzip-compressed batch uploads with retry logic\n\n## Run Locally\n\n```bash\nexport ODINFORGE_SERVER_URL=\"https://your-odinforge-api\"\nexport ODINFORGE_TENANT_ID=\"org_123\"\nexport ODINFORGE_AUTH_MODE=\"api_key\"\nexport ODINFORGE_API_KEY=\"odin_...\"\ngo run ./cmd/agent\n```\n\n## Build\n\n```bash\ngo build -o odinforge-agent ./cmd/agent\n```\n\n## Docker\n\n```bash\ndocker build -t odinforge-agent .\ndocker run -e ODINFORGE_SERVER_URL=\"https://api.example.com\" \\\n           -e ODINFORGE_TENANT_ID=\"org_123\" \\\n           -e ODINFORGE_API_KEY=\"odin_...\" \\\n           odinforge-agent\n```\n\n## Configuration\n\nConfiguration is loaded in order (each layer overrides the previous):\n1. Built-in defaults\n2. YAML config file (optional, via `--config` flag)\n3. Environment variables\n\n### Environment Variables\n\n| Variable | Description | Default |\n|----------|-------------|---------|\n| `ODINFORGE_SERVER_URL` | API server URL | `http://localhost:8080` |\n| `ODINFORGE_TENANT_ID` | Tenant identifier | `default` |\n| `ODINFORGE_AUTH_MODE` | Auth mode: `api_key` or `mtls` | `api_key` |\n| `ODINFORGE_API_KEY` | API key for authentication | |\n| `ODINFORGE_VERIFY_TLS` | Enable TLS verification | `true` |\n| `ODINFORGE_PINNED_SPKI` | Base64-encoded SPKI pin | |\n| `ODINFORGE_MTLS_CERT` | Path to mTLS client certificate | |\n| `ODINFORGE_MTLS_KEY` | Path to mTLS client key | |\n| `ODINFORGE_CA_CERT` | Path to custom CA certificate | |\n| `ODINFORGE_TELEMETRY_INTERVAL` | Telemetry collection interval | `300s` |\n| `ODINFORGE_HEARTBEAT_INTERVAL` | Heartbeat interval | `60s` |\n| `ODINFORGE_QUEUE_PATH` | BoltDB queue file path | `./odinforge-agent.queue.db` |\n| `ODINFORGE_BATCH_SIZE` | Events per batch | `50` |\n| `ODINFORGE_TIMEOUT` | HTTP request timeout | `15s` |\n| `ODINFORGE_COMPRESS` | Enable gzip compression | `true` |\n| `ODINFORGE_REQUIRE_HTTPS` | Require HTTPS (except localhost) | `true` |\n\n### YAML Config Example\n\n```yaml\nserver:\n  url: \"https://api.odinforge.com\"\n  verify_tls: true\n  pinned_spki: \"\"\n\nauth:\n  tenant_id: \"org_123\"\n  mode: \"api_key\"\n  api_key: \"odin_...\"\n\ncollection:\n  telemetry_interval: 5m\n  heartbeat_interval: 1m\n\nbuffer:\n  path: \"/var/lib/odinforge/agent.queue.db\"\n  max_events: 50000\n\ntransport:\n  timeout: 15s\n  batch_size: 50\n  compress: true\n\nsafety:\n  require_https: true\n```\n\n## Deployment\n\n### Linux (systemd)\n\n```bash\nsudo cp odinforge-agent /usr/local/bin/\nsudo cp deployments/systemd/odinforge-agent.service /etc/systemd/system/\nsudo systemctl daemon-reload\nsudo systemctl enable --now odinforge-agent\n```\n\n### macOS (launchd)\n\n```bash\nsudo cp odinforge-agent /usr/local/bin/\nsudo cp deployments/launchd/com.odinforge.agent.plist /Library/LaunchDaemons/\nsudo launchctl load /Library/LaunchDaemons/com.odinforge.agent.plist\n```\n\n## One-Time Run\n\nFor testing or CI pipelines:\n\n```bash\n./odinforge-agent --once\n```\n\n## Project Structure\n\n```\nodinforge-agent/\n cmd/agent/main.go           # Entry point\n internal/\n    config/config.go        # Configuration loading\n    collector/\n       collector.go        # Event collection\n       system.go           # System info\n       metrics.go          # CPU/mem/disk metrics\n    queue/queue.go          # BoltDB durable queue\n    sender/\n       sender.go           # HTTP batch sender\n       tls.go              # TLS/mTLS configuration\n    util/util.go            # Utilities\n deployments/\n    systemd/                # Linux service\n    launchd/                # macOS service\n Dockerfile\n README.md\n```\n","path":null,"size_bytes":4151,"size_tokens":null},"client/src/pages/UserManagement.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { roleMetadata, userRoles, type UserRole } from \"@shared/schema\";\nimport { \n  Users, \n  UserPlus, \n  Trash2, \n  Edit, \n  Shield,\n  ShieldCheck,\n  Lock,\n  AlertTriangle,\n  CheckCircle2\n} from \"lucide-react\";\n\ninterface User {\n  id: string;\n  username: string;\n  role: string;\n  displayName: string | null;\n  email: string | null;\n  createdAt: string | null;\n  lastLoginAt: string | null;\n}\n\nexport default function UserManagement() {\n  const { toast } = useToast();\n  const { hasPermission } = useAuth();\n  \n  const canManageUsers = hasPermission(\"org:manage_users\");\n  const canAssignRoles = hasPermission(\"org:assign_roles\");\n  \n  const [addDialogOpen, setAddDialogOpen] = useState(false);\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [selectedUser, setSelectedUser] = useState<User | null>(null);\n  \n  const [newUsername, setNewUsername] = useState(\"\");\n  const [newPassword, setNewPassword] = useState(\"\");\n  const [newRole, setNewRole] = useState<string>(\"security_analyst\");\n  const [newDisplayName, setNewDisplayName] = useState(\"\");\n  const [newEmail, setNewEmail] = useState(\"\");\n  \n  const [editRole, setEditRole] = useState(\"\");\n  const [editDisplayName, setEditDisplayName] = useState(\"\");\n  const [editEmail, setEditEmail] = useState(\"\");\n\n  const { data: users = [], isLoading } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const assignableRoles = userRoles.filter(\n    role => roleMetadata[role]?.customerAssignable\n  );\n\n  const getRoleBreakdown = () => {\n    const breakdown: Record<string, number> = {};\n    users.forEach(user => {\n      breakdown[user.role] = (breakdown[user.role] || 0) + 1;\n    });\n    return breakdown;\n  };\n\n  const roleBreakdown = getRoleBreakdown();\n\n  const createUserMutation = useMutation({\n    mutationFn: async (data: { username: string; password: string; role: string; displayName?: string; email?: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/users\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"User Created\",\n        description: \"The new user has been created successfully.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      setAddDialogOpen(false);\n      resetAddForm();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to Create User\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateUserMutation = useMutation({\n    mutationFn: async ({ id, updates }: { id: string; updates: Partial<User> }) => {\n      const response = await apiRequest(\"PATCH\", `/api/users/${id}`, updates);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"User Updated\",\n        description: \"The user has been updated successfully.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      setEditDialogOpen(false);\n      setSelectedUser(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to Update User\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteUserMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/users/${id}`);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"User Deleted\",\n        description: \"The user has been removed.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      setDeleteDialogOpen(false);\n      setSelectedUser(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to Delete User\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetAddForm = () => {\n    setNewUsername(\"\");\n    setNewPassword(\"\");\n    setNewRole(\"security_analyst\");\n    setNewDisplayName(\"\");\n    setNewEmail(\"\");\n  };\n\n  const handleCreate = () => {\n    if (!newUsername.trim() || !newPassword.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"Username and password are required\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    createUserMutation.mutate({\n      username: newUsername,\n      password: newPassword,\n      role: newRole,\n      displayName: newDisplayName || undefined,\n      email: newEmail || undefined,\n    });\n  };\n\n  const handleEdit = (user: User) => {\n    setSelectedUser(user);\n    setEditRole(user.role);\n    setEditDisplayName(user.displayName || \"\");\n    setEditEmail(user.email || \"\");\n    setEditDialogOpen(true);\n  };\n\n  const handleUpdate = () => {\n    if (!selectedUser) return;\n    updateUserMutation.mutate({\n      id: selectedUser.id,\n      updates: {\n        role: editRole,\n        displayName: editDisplayName || null,\n        email: editEmail || null,\n      },\n    });\n  };\n\n  const handleDelete = (user: User) => {\n    setSelectedUser(user);\n    setDeleteDialogOpen(true);\n  };\n\n  const confirmDelete = () => {\n    if (!selectedUser) return;\n    deleteUserMutation.mutate(selectedUser.id);\n  };\n\n  const getRoleBadgeVariant = (role: string): \"default\" | \"secondary\" | \"destructive\" | \"outline\" => {\n    const meta = roleMetadata[role as UserRole];\n    if (!meta) return \"outline\";\n    if (meta.category === \"platform\") return \"destructive\";\n    if (meta.category === \"organization\") return \"default\";\n    if (meta.category === \"specialized\") return \"secondary\";\n    return \"outline\";\n  };\n\n  if (!canManageUsers) {\n    return (\n      <div className=\"space-y-6 p-6\">\n        <Alert variant=\"destructive\">\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            You do not have permission to manage users. Contact your administrator for access.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"text-page-title\">User Management</h1>\n          <p className=\"text-muted-foreground\">\n            Manage platform users and their access permissions\n          </p>\n        </div>\n        <Dialog open={addDialogOpen} onOpenChange={(open) => {\n          setAddDialogOpen(open);\n          if (!open) resetAddForm();\n        }}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"btn-add-user\" disabled={!canManageUsers}>\n              {canManageUsers ? <UserPlus className=\"h-4 w-4 mr-2\" /> : <Lock className=\"h-4 w-4 mr-2\" />}\n              Add User\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Add New User</DialogTitle>\n              <DialogDescription>\n                Create a new user account with assigned role\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"username\">Username</Label>\n                <Input\n                  id=\"username\"\n                  placeholder=\"e.g., john.doe\"\n                  value={newUsername}\n                  onChange={(e) => setNewUsername(e.target.value)}\n                  data-testid=\"input-username\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"password\">Password</Label>\n                <Input\n                  id=\"password\"\n                  type=\"password\"\n                  placeholder=\"Enter password\"\n                  value={newPassword}\n                  onChange={(e) => setNewPassword(e.target.value)}\n                  data-testid=\"input-password\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"displayName\">Display Name</Label>\n                <Input\n                  id=\"displayName\"\n                  placeholder=\"e.g., John Doe\"\n                  value={newDisplayName}\n                  onChange={(e) => setNewDisplayName(e.target.value)}\n                  data-testid=\"input-display-name\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"email\">Email</Label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  placeholder=\"e.g., john.doe@example.com\"\n                  value={newEmail}\n                  onChange={(e) => setNewEmail(e.target.value)}\n                  data-testid=\"input-email\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Role</Label>\n                <Select value={newRole} onValueChange={setNewRole}>\n                  <SelectTrigger data-testid=\"select-role\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {assignableRoles.map(role => (\n                      <SelectItem key={role} value={role}>\n                        {roleMetadata[role]?.displayName || role}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                {roleMetadata[newRole as UserRole] && (\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {roleMetadata[newRole as UserRole].description}\n                  </p>\n                )}\n              </div>\n              <Button \n                className=\"w-full\" \n                onClick={handleCreate}\n                disabled={createUserMutation.isPending}\n                data-testid=\"btn-submit-create\"\n              >\n                {createUserMutation.isPending ? \"Creating...\" : \"Create User\"}\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Users</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-users\">\n              {users.length}\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Administrators</CardTitle>\n            <ShieldCheck className=\"h-4 w-4 text-cyan-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-cyan-600\" data-testid=\"text-admin-count\">\n              {(roleBreakdown[\"organization_owner\"] || 0) + (roleBreakdown[\"security_administrator\"] || 0)}\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Engineers</CardTitle>\n            <Shield className=\"h-4 w-4 text-blue-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-blue-600\" data-testid=\"text-engineer-count\">\n              {roleBreakdown[\"security_engineer\"] || 0}\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Analysts & Viewers</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-viewer-count\">\n              {(roleBreakdown[\"security_analyst\"] || 0) + (roleBreakdown[\"executive_viewer\"] || 0) + (roleBreakdown[\"compliance_officer\"] || 0)}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Users</CardTitle>\n          <CardDescription>\n            All users with access to the OdinForge platform\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8 text-muted-foreground\">Loading users...</div>\n          ) : users.length === 0 ? (\n            <div className=\"text-center py-8\">\n              <Users className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n              <h3 className=\"font-medium mb-2\">No Users Found</h3>\n              <p className=\"text-muted-foreground text-sm mb-4\">\n                Add users to give them access to the platform\n              </p>\n              <Button onClick={() => setAddDialogOpen(true)} data-testid=\"btn-add-first-user\">\n                <UserPlus className=\"h-4 w-4 mr-2\" />\n                Add First User\n              </Button>\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>User</TableHead>\n                  <TableHead>Role</TableHead>\n                  <TableHead>Email</TableHead>\n                  <TableHead>Created</TableHead>\n                  <TableHead>Last Login</TableHead>\n                  <TableHead className=\"text-right\">Actions</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {users.map((user) => (\n                  <TableRow key={user.id} data-testid={`row-user-${user.id}`}>\n                    <TableCell>\n                      <div>\n                        <div className=\"font-medium\" data-testid={`text-displayname-${user.id}`}>\n                          {user.displayName || user.username}\n                        </div>\n                        <div className=\"text-sm text-muted-foreground\" data-testid={`text-username-${user.id}`}>\n                          @{user.username}\n                        </div>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <Badge variant={getRoleBadgeVariant(user.role)} data-testid={`badge-role-${user.id}`}>\n                        {roleMetadata[user.role as UserRole]?.displayName || user.role}\n                      </Badge>\n                    </TableCell>\n                    <TableCell>\n                      <span className=\"text-sm\" data-testid={`text-email-${user.id}`}>\n                        {user.email || \"-\"}\n                      </span>\n                    </TableCell>\n                    <TableCell>\n                      <span className=\"text-sm text-muted-foreground\" data-testid={`text-created-${user.id}`}>\n                        {user.createdAt ? formatDistanceToNow(new Date(user.createdAt), { addSuffix: true }) : \"-\"}\n                      </span>\n                    </TableCell>\n                    <TableCell>\n                      <span className=\"text-sm text-muted-foreground\" data-testid={`text-lastlogin-${user.id}`}>\n                        {user.lastLoginAt ? formatDistanceToNow(new Date(user.lastLoginAt), { addSuffix: true }) : \"Never\"}\n                      </span>\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <div className=\"flex justify-end gap-2\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => handleEdit(user)}\n                          disabled={!canAssignRoles}\n                          data-testid={`btn-edit-${user.id}`}\n                        >\n                          <Edit className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => handleDelete(user)}\n                          disabled={!canManageUsers}\n                          data-testid={`btn-delete-${user.id}`}\n                        >\n                          <Trash2 className=\"h-4 w-4 text-destructive\" />\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={editDialogOpen} onOpenChange={setEditDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Edit User</DialogTitle>\n            <DialogDescription>\n              Update user details and role assignment\n            </DialogDescription>\n          </DialogHeader>\n          {selectedUser && (\n            <div className=\"space-y-4\">\n              <div className=\"p-4 bg-muted rounded-md\">\n                <div className=\"font-medium\">{selectedUser.displayName || selectedUser.username}</div>\n                <div className=\"text-sm text-muted-foreground\">@{selectedUser.username}</div>\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"editDisplayName\">Display Name</Label>\n                <Input\n                  id=\"editDisplayName\"\n                  value={editDisplayName}\n                  onChange={(e) => setEditDisplayName(e.target.value)}\n                  data-testid=\"input-edit-display-name\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"editEmail\">Email</Label>\n                <Input\n                  id=\"editEmail\"\n                  type=\"email\"\n                  value={editEmail}\n                  onChange={(e) => setEditEmail(e.target.value)}\n                  data-testid=\"input-edit-email\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Role</Label>\n                <Select value={editRole} onValueChange={setEditRole}>\n                  <SelectTrigger data-testid=\"select-edit-role\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {assignableRoles.map(role => (\n                      <SelectItem key={role} value={role}>\n                        {roleMetadata[role]?.displayName || role}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                {roleMetadata[editRole as UserRole] && (\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {roleMetadata[editRole as UserRole].description}\n                  </p>\n                )}\n              </div>\n              <div className=\"flex gap-2\">\n                <Button\n                  variant=\"outline\"\n                  className=\"flex-1\"\n                  onClick={() => setEditDialogOpen(false)}\n                  data-testid=\"btn-cancel-edit\"\n                >\n                  Cancel\n                </Button>\n                <Button \n                  className=\"flex-1\" \n                  onClick={handleUpdate}\n                  disabled={updateUserMutation.isPending}\n                  data-testid=\"btn-submit-edit\"\n                >\n                  {updateUserMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Delete User</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete this user? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          {selectedUser && (\n            <div className=\"space-y-4\">\n              <div className=\"p-4 bg-destructive/10 border border-destructive/20 rounded-md\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <AlertTriangle className=\"h-5 w-5 text-destructive\" />\n                  <span className=\"font-medium\">Confirm Deletion</span>\n                </div>\n                <p className=\"text-sm\">\n                  User <strong>{selectedUser.displayName || selectedUser.username}</strong> (@{selectedUser.username}) will be permanently removed.\n                </p>\n              </div>\n              <div className=\"flex gap-2\">\n                <Button\n                  variant=\"outline\"\n                  className=\"flex-1\"\n                  onClick={() => setDeleteDialogOpen(false)}\n                  data-testid=\"btn-cancel-delete\"\n                >\n                  Cancel\n                </Button>\n                <Button \n                  variant=\"destructive\"\n                  className=\"flex-1\" \n                  onClick={confirmDelete}\n                  disabled={deleteUserMutation.isPending}\n                  data-testid=\"btn-confirm-delete\"\n                >\n                  {deleteUserMutation.isPending ? \"Deleting...\" : \"Delete User\"}\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":22339,"size_tokens":null},"odinforge-agent/deploy/kubernetes/daemonset.yaml":{"content":"apiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: odinforge-agent\n  namespace: odinforge\n  labels:\n    app.kubernetes.io/name: odinforge-agent\n    app.kubernetes.io/component: agent\nspec:\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: odinforge-agent\n  updateStrategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxUnavailable: 1\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: odinforge-agent\n        app.kubernetes.io/component: agent\n    spec:\n      serviceAccountName: odinforge-agent\n      terminationGracePeriodSeconds: 30\n      \n      containers:\n        - name: agent\n          image: odinforge-agent:latest\n          imagePullPolicy: IfNotPresent\n          \n          env:\n            - name: ODINFORGE_SERVER_URL\n              valueFrom:\n                configMapKeyRef:\n                  name: odinforge-agent-env\n                  key: server-url\n            - name: ODINFORGE_API_KEY\n              valueFrom:\n                secretKeyRef:\n                  name: odinforge-agent-secrets\n                  key: api-key\n            - name: ODINFORGE_TENANT_ID\n              valueFrom:\n                configMapKeyRef:\n                  name: odinforge-agent-env\n                  key: tenant-id\n                  optional: true\n            - name: ODINFORGE_QUEUE_PATH\n              value: /data/agent.queue.db\n            - name: ODINFORGE_AUTH_MODE\n              value: api_key\n            - name: ODINFORGE_REQUIRE_HTTPS\n              value: \"true\"\n            - name: ODINFORGE_VERIFY_TLS\n              value: \"true\"\n            - name: NODE_NAME\n              valueFrom:\n                fieldRef:\n                  fieldPath: spec.nodeName\n            - name: POD_NAME\n              valueFrom:\n                fieldRef:\n                  fieldPath: metadata.name\n          \n          volumeMounts:\n            - name: config\n              mountPath: /etc/odinforge\n              readOnly: true\n            - name: data\n              mountPath: /data\n          \n          resources:\n            limits:\n              cpu: 500m\n              memory: 256Mi\n            requests:\n              cpu: 50m\n              memory: 64Mi\n          \n          securityContext:\n            readOnlyRootFilesystem: true\n            runAsNonRoot: true\n            runAsUser: 1000\n            allowPrivilegeEscalation: false\n            capabilities:\n              drop:\n                - ALL\n      \n      volumes:\n        - name: config\n          configMap:\n            name: odinforge-agent-config\n        - name: data\n          emptyDir:\n            sizeLimit: 500Mi\n\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: odinforge-agent-env\n  namespace: odinforge\ndata:\n  server-url: \"https://your-odinforge-server.com\"\n  tenant-id: \"default\"\n\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: odinforge-agent\n  namespace: odinforge\n  labels:\n    app.kubernetes.io/name: odinforge-agent\n","path":null,"size_bytes":2943,"size_tokens":null},"odinforge-agent/internal/installer/cli.go":{"content":"package installer\n\nimport (\n\t\"bufio\"\n\t\"fmt\"\n\t\"os\"\n\t\"strings\"\n)\n\ntype CLIOptions struct {\n\tServerURL   string\n\tAPIKey      string\n\tTenantID    string\n\tForce       bool\n\tDryRun      bool\n\tInteractive bool\n}\n\nfunc RunInstall(opts CLIOptions) error {\n\tfmt.Println(\"OdinForge Agent Installer\")\n\tfmt.Println(\"=========================\")\n\tfmt.Println()\n\n\t// Detect environment\n\tdetection := Detect()\n\tprintDetectionResult(detection)\n\n\tif !detection.CanAutoInstall {\n\t\tfmt.Printf(\"\\nAuto-installation not available: %s\\n\", detection.Reason)\n\t\tprintManualInstructions(detection)\n\t\treturn nil\n\t}\n\n\t// Get installer for this environment\n\tinstaller, err := GetInstaller(detection.Environment)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"no installer for this environment: %w\", err)\n\t}\n\n\t// Collect configuration interactively if needed\n\tcfg := DefaultInstallConfig()\n\tif opts.ServerURL != \"\" {\n\t\tcfg.ServerURL = opts.ServerURL\n\t}\n\tif opts.APIKey != \"\" {\n\t\tcfg.APIKey = opts.APIKey\n\t}\n\tif opts.TenantID != \"\" {\n\t\tcfg.TenantID = opts.TenantID\n\t}\n\n\tif opts.Interactive || cfg.ServerURL == \"\" || cfg.APIKey == \"\" {\n\t\tif err := promptForConfig(&cfg); err != nil {\n\t\t\treturn err\n\t\t}\n\t}\n\n\t// Validate configuration\n\tif cfg.ServerURL == \"\" {\n\t\treturn fmt.Errorf(\"server URL is required\")\n\t}\n\tif cfg.APIKey == \"\" {\n\t\treturn fmt.Errorf(\"API key is required\")\n\t}\n\n\t// Confirm installation\n\tif !opts.Force && opts.Interactive {\n\t\tfmt.Println()\n\t\tfmt.Println(\"Installation Summary:\")\n\t\tfmt.Printf(\"  Server URL:  %s\\n\", cfg.ServerURL)\n\t\tfmt.Printf(\"  Tenant ID:   %s\\n\", cfg.TenantID)\n\t\tfmt.Printf(\"  Binary:      %s\\n\", cfg.BinaryPath)\n\t\tfmt.Printf(\"  Config:      %s\\n\", cfg.ConfigPath)\n\t\tfmt.Printf(\"  Data:        %s\\n\", cfg.DataPath)\n\t\tfmt.Println()\n\n\t\tif !confirm(\"Proceed with installation?\") {\n\t\t\tfmt.Println(\"Installation cancelled.\")\n\t\t\treturn nil\n\t\t}\n\t}\n\n\tif opts.DryRun {\n\t\tfmt.Println(\"\\n[Dry Run] Would install with the above configuration.\")\n\t\treturn nil\n\t}\n\n\t// Perform installation\n\tfmt.Println(\"\\nInstalling...\")\n\tif err := installer.Install(cfg); err != nil {\n\t\treturn fmt.Errorf(\"installation failed: %w\", err)\n\t}\n\n\tfmt.Println(\"\\nInstallation complete!\")\n\tfmt.Printf(\"The OdinForge agent is now running as a %s service.\\n\", installer.Name())\n\tfmt.Println(\"\\nUseful commands:\")\n\tprintServiceCommands(detection.Environment)\n\n\treturn nil\n}\n\nfunc RunUninstall(opts CLIOptions) error {\n\tfmt.Println(\"OdinForge Agent Uninstaller\")\n\tfmt.Println(\"===========================\")\n\tfmt.Println()\n\n\tdetection := Detect()\n\tinstaller, err := GetInstaller(detection.Environment)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"no installer for this environment: %w\", err)\n\t}\n\n\tcfg := DefaultInstallConfig()\n\n\t// Check current status\n\tstatus, err := installer.Status(cfg)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"failed to check status: %w\", err)\n\t}\n\n\tif !status.Installed {\n\t\tfmt.Println(\"OdinForge agent is not installed.\")\n\t\treturn nil\n\t}\n\n\tif !opts.Force {\n\t\tfmt.Println(\"This will:\")\n\t\tfmt.Println(\"  - Stop the running service\")\n\t\tfmt.Println(\"  - Remove the service configuration\")\n\t\tfmt.Println(\"  - Leave configuration files and data intact\")\n\t\tfmt.Println()\n\n\t\tif !confirm(\"Proceed with uninstallation?\") {\n\t\t\tfmt.Println(\"Uninstallation cancelled.\")\n\t\t\treturn nil\n\t\t}\n\t}\n\n\tfmt.Println(\"\\nUninstalling...\")\n\tif err := installer.Uninstall(cfg); err != nil {\n\t\treturn fmt.Errorf(\"uninstallation failed: %w\", err)\n\t}\n\n\tfmt.Println(\"\\nUninstallation complete!\")\n\tfmt.Println(\"\\nNote: Configuration and data files were preserved at:\")\n\tfmt.Printf(\"  Config: %s\\n\", cfg.ConfigPath)\n\tfmt.Printf(\"  Data:   %s\\n\", cfg.DataPath)\n\tfmt.Println(\"You can remove these manually if no longer needed.\")\n\n\treturn nil\n}\n\nfunc RunStatus(opts CLIOptions) error {\n\tdetection := Detect()\n\tprintDetectionResult(detection)\n\n\tif detection.Environment == EnvDocker || detection.Environment == EnvKubernetes {\n\t\tfmt.Println(\"\\nFor container status, use your container orchestrator's tools.\")\n\t\treturn nil\n\t}\n\n\tinstaller, err := GetInstaller(detection.Environment)\n\tif err != nil {\n\t\tfmt.Println(\"\\nNo service installer available for this environment.\")\n\t\treturn nil\n\t}\n\n\tcfg := DefaultInstallConfig()\n\tstatus, err := installer.Status(cfg)\n\tif err != nil {\n\t\treturn fmt.Errorf(\"failed to check status: %w\", err)\n\t}\n\n\tfmt.Println(\"\\nService Status:\")\n\tfmt.Printf(\"  Installed: %v\\n\", status.Installed)\n\tfmt.Printf(\"  Enabled:   %v\\n\", status.Enabled)\n\tfmt.Printf(\"  Running:   %v\\n\", status.Running)\n\tif status.PID > 0 {\n\t\tfmt.Printf(\"  PID:       %d\\n\", status.PID)\n\t}\n\tif status.Message != \"\" {\n\t\tfmt.Printf(\"  Message:   %s\\n\", status.Message)\n\t}\n\n\treturn nil\n}\n\nfunc printDetectionResult(d DetectionResult) {\n\tfmt.Println(\"Environment Detection:\")\n\tfmt.Printf(\"  Detected:    %s\\n\", d.Environment.DisplayName())\n\tfmt.Printf(\"  OS:          %s/%s\\n\", d.OS, d.Arch)\n\tfmt.Printf(\"  Hostname:    %s\\n\", d.Hostname)\n\tfmt.Printf(\"  Container:   %v\\n\", d.IsContainer)\n\tfmt.Printf(\"  Root/Admin:  %v\\n\", d.IsRoot)\n\tif d.InitSystem != \"\" {\n\t\tfmt.Printf(\"  Init System: %s\\n\", d.InitSystem)\n\t}\n}\n\nfunc printManualInstructions(d DetectionResult) {\n\tfmt.Println(\"\\nManual Installation Instructions:\")\n\tfmt.Println(\"---------------------------------\")\n\n\tswitch d.Environment {\n\tcase EnvDocker:\n\t\tfmt.Println(`\nUse Docker Compose:\n  1. cd odinforge-agent/deploy/docker\n  2. cp .env.example .env\n  3. Edit .env with your server URL and API key\n  4. docker-compose up -d`)\n\n\tcase EnvKubernetes:\n\t\tfmt.Println(`\nUse kubectl:\n  1. cd odinforge-agent/deploy/kubernetes\n  2. Edit secret.yaml with your API key\n  3. Edit configmap.yaml with your server URL\n  4. kubectl apply -f namespace.yaml\n  5. kubectl apply -f secret.yaml\n  6. kubectl apply -f configmap.yaml\n  7. kubectl apply -f daemonset.yaml  # or deployment.yaml`)\n\n\tcase EnvSystemd:\n\t\tif !d.IsRoot {\n\t\t\tfmt.Println(`\nRun the installer with sudo:\n  sudo ./odinforge-agent install --server-url https://your-server.com --api-key YOUR_KEY`)\n\t\t}\n\n\tcase EnvLaunchd:\n\t\tif !d.IsRoot {\n\t\t\tfmt.Println(`\nRun the installer with sudo:\n  sudo ./odinforge-agent install --server-url https://your-server.com --api-key YOUR_KEY`)\n\t\t}\n\n\tcase EnvWindows:\n\t\tfmt.Println(`\nRun as Administrator:\n  1. Open PowerShell as Administrator\n  2. .\\odinforge-agent.exe install --server-url https://your-server.com --api-key YOUR_KEY`)\n\n\tdefault:\n\t\tfmt.Println(`\nManual setup required:\n  1. Copy the binary to a suitable location\n  2. Create a configuration file (see deploy/config.yaml.example)\n  3. Set up a service or run manually`)\n\t}\n}\n\nfunc printServiceCommands(env Environment) {\n\tswitch env {\n\tcase EnvSystemd:\n\t\tfmt.Println(\"  View logs:      journalctl -u odinforge-agent -f\")\n\t\tfmt.Println(\"  Check status:   systemctl status odinforge-agent\")\n\t\tfmt.Println(\"  Restart:        systemctl restart odinforge-agent\")\n\t\tfmt.Println(\"  Stop:           systemctl stop odinforge-agent\")\n\n\tcase EnvLaunchd:\n\t\tfmt.Println(\"  View logs:      tail -f /var/log/odinforge-agent/agent.log\")\n\t\tfmt.Println(\"  Check status:   launchctl list | grep odinforge\")\n\t\tfmt.Println(\"  Restart:        launchctl stop com.odinforge.agent && launchctl start com.odinforge.agent\")\n\t\tfmt.Println(\"  Stop:           launchctl stop com.odinforge.agent\")\n\n\tcase EnvWindows:\n\t\tfmt.Println(\"  Check status:   sc.exe query odinforge-agent\")\n\t\tfmt.Println(\"  Restart:        sc.exe stop odinforge-agent && sc.exe start odinforge-agent\")\n\t\tfmt.Println(\"  Stop:           sc.exe stop odinforge-agent\")\n\t\tfmt.Println(\"  View logs:      Get-EventLog -LogName Application -Source odinforge-agent\")\n\t}\n}\n\nfunc promptForConfig(cfg *InstallConfig) error {\n\treader := bufio.NewReader(os.Stdin)\n\n\tif cfg.ServerURL == \"\" {\n\t\tfmt.Print(\"\\nOdinForge Server URL: \")\n\t\turl, err := reader.ReadString('\\n')\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t\tcfg.ServerURL = strings.TrimSpace(url)\n\t}\n\n\tif cfg.APIKey == \"\" {\n\t\tfmt.Print(\"API Key (from Agents page): \")\n\t\tkey, err := reader.ReadString('\\n')\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t\tcfg.APIKey = strings.TrimSpace(key)\n\t}\n\n\tif cfg.TenantID == \"\" || cfg.TenantID == \"default\" {\n\t\tfmt.Print(\"Tenant ID [default]: \")\n\t\ttenant, err := reader.ReadString('\\n')\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t\ttenant = strings.TrimSpace(tenant)\n\t\tif tenant != \"\" {\n\t\t\tcfg.TenantID = tenant\n\t\t}\n\t}\n\n\treturn nil\n}\n\nfunc confirm(prompt string) bool {\n\treader := bufio.NewReader(os.Stdin)\n\tfmt.Printf(\"%s [y/N]: \", prompt)\n\tresponse, err := reader.ReadString('\\n')\n\tif err != nil {\n\t\treturn false\n\t}\n\tresponse = strings.ToLower(strings.TrimSpace(response))\n\treturn response == \"y\" || response == \"yes\"\n}\n","path":null,"size_bytes":8544,"size_tokens":null},"odinforge-agent/deploy/kubernetes/configmap.yaml":{"content":"apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: odinforge-agent-config\n  namespace: odinforge\n  labels:\n    app.kubernetes.io/name: odinforge-agent\n    app.kubernetes.io/component: agent\ndata:\n  config.yaml: |\n    server:\n      url: \"${ODINFORGE_SERVER_URL}\"\n      verify_tls: true\n    \n    auth:\n      mode: api_key\n      tenant_id: \"${ODINFORGE_TENANT_ID}\"\n    \n    collection:\n      telemetry_interval: 5m\n      heartbeat_interval: 1m\n    \n    buffer:\n      path: /data/agent.queue.db\n      max_events: 50000\n    \n    transport:\n      timeout: 15s\n      batch_size: 50\n      compress: true\n    \n    safety:\n      require_https: true\n","path":null,"size_bytes":637,"size_tokens":null},"odinforge-agent/install.sh":{"content":"REPO=\"Odingard/OdinForgeAI\"\nVERSION=\"agent-v1.0.2\"\n","path":null,"size_bytes":51,"size_tokens":null},"odinforge-agent/deploy/kubernetes/deployment.yaml":{"content":"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: odinforge-agent\n  namespace: odinforge\n  labels:\n    app.kubernetes.io/name: odinforge-agent\n    app.kubernetes.io/component: agent\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: odinforge-agent\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxUnavailable: 0\n      maxSurge: 1\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: odinforge-agent\n        app.kubernetes.io/component: agent\n    spec:\n      serviceAccountName: odinforge-agent\n      terminationGracePeriodSeconds: 30\n      \n      containers:\n        - name: agent\n          image: odinforge-agent:latest\n          imagePullPolicy: IfNotPresent\n          \n          env:\n            - name: ODINFORGE_SERVER_URL\n              valueFrom:\n                configMapKeyRef:\n                  name: odinforge-agent-env\n                  key: server-url\n            - name: ODINFORGE_API_KEY\n              valueFrom:\n                secretKeyRef:\n                  name: odinforge-agent-secrets\n                  key: api-key\n            - name: ODINFORGE_TENANT_ID\n              valueFrom:\n                configMapKeyRef:\n                  name: odinforge-agent-env\n                  key: tenant-id\n                  optional: true\n            - name: ODINFORGE_QUEUE_PATH\n              value: /data/agent.queue.db\n            - name: ODINFORGE_AUTH_MODE\n              value: api_key\n            - name: ODINFORGE_REQUIRE_HTTPS\n              value: \"true\"\n            - name: ODINFORGE_VERIFY_TLS\n              value: \"true\"\n          \n          volumeMounts:\n            - name: config\n              mountPath: /etc/odinforge\n              readOnly: true\n            - name: data\n              mountPath: /data\n          \n          resources:\n            limits:\n              cpu: 500m\n              memory: 256Mi\n            requests:\n              cpu: 50m\n              memory: 64Mi\n          \n          securityContext:\n            readOnlyRootFilesystem: true\n            runAsNonRoot: true\n            runAsUser: 1000\n            allowPrivilegeEscalation: false\n            capabilities:\n              drop:\n                - ALL\n      \n      volumes:\n        - name: config\n          configMap:\n            name: odinforge-agent-config\n        - name: data\n          persistentVolumeClaim:\n            claimName: odinforge-agent-data\n\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: odinforge-agent-data\n  namespace: odinforge\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 1Gi\n  # Uncomment and set your storage class if needed:\n  # storageClassName: standard\n","path":null,"size_bytes":2703,"size_tokens":null},"odinforge-agent/deploy/README.md":{"content":"# OdinForge Agent Deployment Guide\n\nThis guide covers deploying the OdinForge Security Agent across different environments.\n\n## Quick Start\n\n### Automatic Installation (Recommended)\n\nThe agent includes a self-installer that auto-detects your environment:\n\n```bash\n# Linux/macOS (interactive)\nsudo ./odinforge-agent install\n\n# Linux/macOS (non-interactive)\nsudo ./odinforge-agent install \\\n  --server-url https://your-odinforge-server.com \\\n  --api-key YOUR_API_KEY\n\n# Windows (run as Administrator)\n.\\odinforge-agent.exe install --server-url https://your-odinforge-server.com --api-key YOUR_KEY\n```\n\n### Check Status\n\n```bash\n./odinforge-agent status\n```\n\n### Uninstall\n\n```bash\nsudo ./odinforge-agent uninstall\n```\n\n---\n\n## Manual Deployment Options\n\n### Docker\n\n1. Navigate to the Docker deployment directory:\n   ```bash\n   cd deploy/docker\n   ```\n\n2. Copy and configure the environment file:\n   ```bash\n   cp .env.example .env\n   # Edit .env with your server URL and API key\n   ```\n\n3. Start the agent:\n   ```bash\n   docker-compose up -d\n   ```\n\n4. View logs:\n   ```bash\n   docker-compose logs -f\n   ```\n\n### Kubernetes\n\nChoose between DaemonSet (one agent per node) or Deployment (single agent):\n\n1. Create the namespace:\n   ```bash\n   kubectl apply -f deploy/kubernetes/namespace.yaml\n   ```\n\n2. Configure secrets (edit with your API key):\n   ```bash\n   # Edit deploy/kubernetes/secret.yaml with your API key\n   kubectl apply -f deploy/kubernetes/secret.yaml\n   ```\n\n3. Configure the server URL:\n   ```bash\n   # Edit deploy/kubernetes/daemonset.yaml or deployment.yaml\n   # Update the odinforge-agent-env ConfigMap with your server URL\n   ```\n\n4. Deploy:\n   ```bash\n   # For per-node monitoring (recommended):\n   kubectl apply -f deploy/kubernetes/daemonset.yaml\n\n   # OR for single-instance:\n   kubectl apply -f deploy/kubernetes/deployment.yaml\n   ```\n\n5. Verify:\n   ```bash\n   kubectl get pods -n odinforge\n   kubectl logs -n odinforge -l app.kubernetes.io/name=odinforge-agent\n   ```\n\n### Linux (systemd)\n\n1. Copy the binary:\n   ```bash\n   sudo cp odinforge-agent /usr/local/bin/\n   sudo chmod +x /usr/local/bin/odinforge-agent\n   ```\n\n2. Create configuration directory:\n   ```bash\n   sudo mkdir -p /etc/odinforge /var/lib/odinforge-agent\n   ```\n\n3. Copy and edit configuration:\n   ```bash\n   sudo cp deploy/config.yaml.example /etc/odinforge/agent.yaml\n   sudo cp deploy/systemd/agent.env.example /etc/odinforge/agent.env\n   # Edit both files with your settings\n   ```\n\n4. Create service user:\n   ```bash\n   sudo useradd --system --no-create-home --shell /usr/sbin/nologin odinforge\n   sudo chown -R odinforge:odinforge /var/lib/odinforge-agent\n   ```\n\n5. Install and enable service:\n   ```bash\n   sudo cp deploy/systemd/odinforge-agent.service /etc/systemd/system/\n   sudo systemctl daemon-reload\n   sudo systemctl enable odinforge-agent\n   sudo systemctl start odinforge-agent\n   ```\n\n6. Check status:\n   ```bash\n   sudo systemctl status odinforge-agent\n   sudo journalctl -u odinforge-agent -f\n   ```\n\n### macOS (launchd)\n\n1. Copy the binary:\n   ```bash\n   sudo cp odinforge-agent /usr/local/bin/\n   sudo chmod +x /usr/local/bin/odinforge-agent\n   ```\n\n2. Create directories:\n   ```bash\n   sudo mkdir -p /etc/odinforge /var/lib/odinforge-agent /var/log/odinforge-agent\n   ```\n\n3. Copy and edit configuration:\n   ```bash\n   sudo cp deploy/config.yaml.example /etc/odinforge/agent.yaml\n   # Edit with your settings\n   ```\n\n4. Edit and install the plist:\n   ```bash\n   # Edit deploy/launchd/com.odinforge.agent.plist with your server URL and API key\n   sudo cp deploy/launchd/com.odinforge.agent.plist /Library/LaunchDaemons/\n   ```\n\n5. Load and start:\n   ```bash\n   sudo launchctl load /Library/LaunchDaemons/com.odinforge.agent.plist\n   ```\n\n6. Check status:\n   ```bash\n   sudo launchctl list | grep odinforge\n   tail -f /var/log/odinforge-agent/agent.log\n   ```\n\n---\n\n## Configuration Reference\n\n### Environment Variables\n\n| Variable | Description | Default |\n|----------|-------------|---------|\n| `ODINFORGE_SERVER_URL` | OdinForge server URL | Required |\n| `ODINFORGE_API_KEY` | API key from Agents page | Required |\n| `ODINFORGE_TENANT_ID` | Tenant/Organization ID | `default` |\n| `ODINFORGE_AUTH_MODE` | Authentication mode (`api_key` or `mtls`) | `api_key` |\n| `ODINFORGE_TELEMETRY_INTERVAL` | Telemetry collection interval | `5m` |\n| `ODINFORGE_HEARTBEAT_INTERVAL` | Heartbeat interval | `1m` |\n| `ODINFORGE_BATCH_SIZE` | Events per batch | `50` |\n| `ODINFORGE_COMPRESS` | Enable gzip compression | `true` |\n| `ODINFORGE_REQUIRE_HTTPS` | Require HTTPS connections | `true` |\n| `ODINFORGE_VERIFY_TLS` | Verify TLS certificates | `true` |\n| `ODINFORGE_QUEUE_PATH` | Path to offline queue database | `./agent.queue.db` |\n\n### mTLS Authentication\n\nFor mTLS authentication instead of API keys:\n\n1. Set `ODINFORGE_AUTH_MODE=mtls`\n2. Configure certificate paths:\n   - `ODINFORGE_MTLS_CERT`: Path to agent certificate\n   - `ODINFORGE_MTLS_KEY`: Path to agent private key\n   - `ODINFORGE_CA_CERT`: Path to CA certificate (optional)\n\n---\n\n## Troubleshooting\n\n### Agent won't start\n\n1. Check logs:\n   - Linux: `journalctl -u odinforge-agent -n 50`\n   - macOS: `tail -50 /var/log/odinforge-agent/agent.log`\n   - Docker: `docker-compose logs odinforge-agent`\n\n2. Verify configuration:\n   - Ensure server URL is accessible\n   - Verify API key is correct\n   - Check file permissions on config and data directories\n\n### Connection issues\n\n1. Test connectivity:\n   ```bash\n   curl -v https://your-odinforge-server.com/api/health\n   ```\n\n2. Check firewall rules allow outbound HTTPS (port 443)\n\n3. If using a proxy, configure via environment variables\n\n### High resource usage\n\n1. Adjust collection intervals (increase `ODINFORGE_TELEMETRY_INTERVAL`)\n2. Reduce batch size if memory constrained\n3. Check the resource limits in systemd/docker configuration\n\n---\n\n## Security Recommendations\n\n1. **Use HTTPS**: Always use HTTPS in production (`ODINFORGE_REQUIRE_HTTPS=true`)\n2. **Protect credentials**: Keep API keys in environment files with restricted permissions (0600)\n3. **Run as non-root**: The systemd service runs as a dedicated `odinforge` user\n4. **Enable TLS verification**: Keep `ODINFORGE_VERIFY_TLS=true` in production\n5. **Consider mTLS**: For high-security environments, use mutual TLS instead of API keys\n","path":null,"size_bytes":6321,"size_tokens":null},"client/src/pages/Settings.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { \n  Settings as SettingsIcon, \n  Building2, \n  Shield, \n  Bell, \n  Key, \n  AlertTriangle,\n  Save,\n  RefreshCw,\n  Lock,\n  Mail,\n  Phone,\n  Clock,\n  KeyRound,\n  Webhook,\n  Activity,\n  Gauge\n} from \"lucide-react\";\n\ninterface OrganizationSettings {\n  organizationName: string;\n  organizationDescription: string;\n  contactEmail: string;\n  contactPhone: string;\n  sessionTimeoutMinutes: number;\n  mfaRequired: boolean;\n  mfaGracePeriodDays: number;\n  passwordMinLength: number;\n  passwordRequireUppercase: boolean;\n  passwordRequireLowercase: boolean;\n  passwordRequireNumbers: boolean;\n  passwordRequireSpecial: boolean;\n  passwordExpiryDays: number;\n  emailNotificationsEnabled: boolean;\n  emailCriticalAlerts: boolean;\n  emailHighAlerts: boolean;\n  emailMediumAlerts: boolean;\n  emailLowAlerts: boolean;\n  emailDailyDigest: boolean;\n  alertThresholdCritical: number;\n  alertThresholdHigh: number;\n  alertThresholdMedium: number;\n  apiRateLimitPerMinute: number;\n  apiRateLimitPerHour: number;\n  apiRateLimitPerDay: number;\n  apiLoggingEnabled: boolean;\n  webhooksEnabled: boolean;\n  webhookUrl: string;\n}\n\nexport default function Settings() {\n  const { toast } = useToast();\n  const { hasPermission } = useAuth();\n  const canManageSettings = hasPermission(\"org:manage_settings\");\n  \n  const [activeTab, setActiveTab] = useState(\"organization\");\n\n  const { data: settings, isLoading } = useQuery<OrganizationSettings>({\n    queryKey: [\"/api/organization/settings\"],\n  });\n\n  const [localSettings, setLocalSettings] = useState<Partial<OrganizationSettings>>({});\n  \n  const mergedSettings = { ...settings, ...localSettings };\n\n  const updateSettingsMutation = useMutation({\n    mutationFn: async (updates: Partial<OrganizationSettings>) => {\n      const response = await apiRequest(\"PATCH\", \"/api/organization/settings\", updates);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Settings Saved\",\n        description: \"Your settings have been updated successfully.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/organization/settings\"] });\n      setLocalSettings({});\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to Save\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSaveChanges = () => {\n    if (Object.keys(localSettings).length > 0) {\n      updateSettingsMutation.mutate(localSettings);\n    }\n  };\n\n  const handleReset = () => {\n    setLocalSettings({});\n    toast({\n      title: \"Changes Reset\",\n      description: \"All unsaved changes have been discarded.\",\n    });\n  };\n\n  const updateSetting = <K extends keyof OrganizationSettings>(key: K, value: OrganizationSettings[K]) => {\n    setLocalSettings(prev => ({ ...prev, [key]: value }));\n  };\n\n  const hasUnsavedChanges = Object.keys(localSettings).length > 0;\n\n  if (!canManageSettings) {\n    return (\n      <div className=\"space-y-6\">\n        <Alert variant=\"destructive\">\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            You do not have permission to manage organization settings. Contact your administrator for access.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <RefreshCw className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl font-semibold flex items-center gap-2\" data-testid=\"text-page-title\">\n            <SettingsIcon className=\"h-6 w-6\" />\n            Settings\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Configure organization, security, and platform settings\n          </p>\n        </div>\n        {hasUnsavedChanges && (\n          <div className=\"flex items-center gap-2\">\n            <Button \n              variant=\"outline\" \n              onClick={handleReset}\n              data-testid=\"btn-reset-changes\"\n            >\n              <RefreshCw className=\"h-4 w-4 mr-2\" />\n              Reset\n            </Button>\n            <Button \n              onClick={handleSaveChanges}\n              disabled={updateSettingsMutation.isPending}\n              data-testid=\"btn-save-changes\"\n            >\n              <Save className=\"h-4 w-4 mr-2\" />\n              {updateSettingsMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n            </Button>\n          </div>\n        )}\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"grid w-full grid-cols-4 max-w-xl\">\n          <TabsTrigger value=\"organization\" className=\"flex items-center gap-2\" data-testid=\"tab-organization\">\n            <Building2 className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">Organization</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"security\" className=\"flex items-center gap-2\" data-testid=\"tab-security\">\n            <Shield className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">Security</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"notifications\" className=\"flex items-center gap-2\" data-testid=\"tab-notifications\">\n            <Bell className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">Notifications</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"api\" className=\"flex items-center gap-2\" data-testid=\"tab-api\">\n            <Key className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">API</span>\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"organization\" className=\"space-y-6 mt-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Building2 className=\"h-5 w-5\" />\n                Organization Details\n              </CardTitle>\n              <CardDescription>\n                Basic information about your organization\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"orgName\">Organization Name</Label>\n                <Input\n                  id=\"orgName\"\n                  value={mergedSettings.organizationName || \"\"}\n                  onChange={(e) => updateSetting(\"organizationName\", e.target.value)}\n                  placeholder=\"Enter organization name\"\n                  data-testid=\"input-org-name\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  The name displayed throughout the platform\n                </p>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label htmlFor=\"orgDescription\">Description</Label>\n                <Textarea\n                  id=\"orgDescription\"\n                  value={mergedSettings.organizationDescription || \"\"}\n                  onChange={(e) => updateSetting(\"organizationDescription\", e.target.value)}\n                  placeholder=\"Brief description of your organization\"\n                  rows={3}\n                  data-testid=\"input-org-description\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  A brief description for internal reference\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Mail className=\"h-5 w-5\" />\n                Contact Information\n              </CardTitle>\n              <CardDescription>\n                Primary contact details for your organization\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"contactEmail\">Contact Email</Label>\n                  <Input\n                    id=\"contactEmail\"\n                    type=\"email\"\n                    value={mergedSettings.contactEmail || \"\"}\n                    onChange={(e) => updateSetting(\"contactEmail\", e.target.value)}\n                    placeholder=\"security@example.com\"\n                    data-testid=\"input-contact-email\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    Primary email for security communications\n                  </p>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"contactPhone\">Contact Phone</Label>\n                  <Input\n                    id=\"contactPhone\"\n                    type=\"tel\"\n                    value={mergedSettings.contactPhone || \"\"}\n                    onChange={(e) => updateSetting(\"contactPhone\", e.target.value)}\n                    placeholder=\"+1 (555) 000-0000\"\n                    data-testid=\"input-contact-phone\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    Emergency contact number\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"security\" className=\"space-y-6 mt-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Clock className=\"h-5 w-5\" />\n                Session Settings\n              </CardTitle>\n              <CardDescription>\n                Configure user session behavior and timeouts\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"sessionTimeout\">Session Timeout (minutes)</Label>\n                <Input\n                  id=\"sessionTimeout\"\n                  type=\"number\"\n                  min={5}\n                  max={480}\n                  value={mergedSettings.sessionTimeoutMinutes || 30}\n                  onChange={(e) => updateSetting(\"sessionTimeoutMinutes\", parseInt(e.target.value) || 30)}\n                  data-testid=\"input-session-timeout\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Inactive users will be logged out after this duration (5-480 minutes)\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <KeyRound className=\"h-5 w-5\" />\n                Multi-Factor Authentication\n              </CardTitle>\n              <CardDescription>\n                Enforce additional authentication for enhanced security\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"space-y-0.5\">\n                  <Label>Require MFA for All Users</Label>\n                  <p className=\"text-xs text-muted-foreground\">\n                    Enforce multi-factor authentication for all platform users\n                  </p>\n                </div>\n                <Switch\n                  checked={mergedSettings.mfaRequired || false}\n                  onCheckedChange={(checked) => updateSetting(\"mfaRequired\", checked)}\n                  data-testid=\"switch-mfa-required\"\n                />\n              </div>\n              \n              {mergedSettings.mfaRequired && (\n                <div className=\"space-y-2 pl-4 border-l-2 border-muted\">\n                  <Label htmlFor=\"mfaGracePeriod\">Grace Period (days)</Label>\n                  <Input\n                    id=\"mfaGracePeriod\"\n                    type=\"number\"\n                    min={0}\n                    max={30}\n                    value={mergedSettings.mfaGracePeriodDays || 7}\n                    onChange={(e) => updateSetting(\"mfaGracePeriodDays\", parseInt(e.target.value) || 7)}\n                    data-testid=\"input-mfa-grace-period\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    Days users have to set up MFA before being locked out\n                  </p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Lock className=\"h-5 w-5\" />\n                Password Policy\n              </CardTitle>\n              <CardDescription>\n                Define password requirements for user accounts\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"passwordMinLength\">Minimum Password Length</Label>\n                <Input\n                  id=\"passwordMinLength\"\n                  type=\"number\"\n                  min={8}\n                  max={128}\n                  value={mergedSettings.passwordMinLength || 12}\n                  onChange={(e) => updateSetting(\"passwordMinLength\", parseInt(e.target.value) || 12)}\n                  data-testid=\"input-password-min-length\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Minimum characters required (8-128)\n                </p>\n              </div>\n\n              <Separator />\n\n              <div className=\"space-y-3\">\n                <Label className=\"text-sm font-medium\">Character Requirements</Label>\n                \n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <Label className=\"font-normal\">Require Uppercase Letters</Label>\n                    <p className=\"text-xs text-muted-foreground\">At least one A-Z character</p>\n                  </div>\n                  <Switch\n                    checked={mergedSettings.passwordRequireUppercase ?? true}\n                    onCheckedChange={(checked) => updateSetting(\"passwordRequireUppercase\", checked)}\n                    data-testid=\"switch-password-uppercase\"\n                  />\n                </div>\n\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <Label className=\"font-normal\">Require Lowercase Letters</Label>\n                    <p className=\"text-xs text-muted-foreground\">At least one a-z character</p>\n                  </div>\n                  <Switch\n                    checked={mergedSettings.passwordRequireLowercase ?? true}\n                    onCheckedChange={(checked) => updateSetting(\"passwordRequireLowercase\", checked)}\n                    data-testid=\"switch-password-lowercase\"\n                  />\n                </div>\n\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <Label className=\"font-normal\">Require Numbers</Label>\n                    <p className=\"text-xs text-muted-foreground\">At least one 0-9 digit</p>\n                  </div>\n                  <Switch\n                    checked={mergedSettings.passwordRequireNumbers ?? true}\n                    onCheckedChange={(checked) => updateSetting(\"passwordRequireNumbers\", checked)}\n                    data-testid=\"switch-password-numbers\"\n                  />\n                </div>\n\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <Label className=\"font-normal\">Require Special Characters</Label>\n                    <p className=\"text-xs text-muted-foreground\">At least one special character (!@#$%^&*)</p>\n                  </div>\n                  <Switch\n                    checked={mergedSettings.passwordRequireSpecial ?? true}\n                    onCheckedChange={(checked) => updateSetting(\"passwordRequireSpecial\", checked)}\n                    data-testid=\"switch-password-special\"\n                  />\n                </div>\n              </div>\n\n              <Separator />\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"passwordExpiry\">Password Expiry (days)</Label>\n                <Input\n                  id=\"passwordExpiry\"\n                  type=\"number\"\n                  min={0}\n                  max={365}\n                  value={mergedSettings.passwordExpiryDays || 90}\n                  onChange={(e) => updateSetting(\"passwordExpiryDays\", parseInt(e.target.value) || 90)}\n                  data-testid=\"input-password-expiry\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Days before users must change their password (0 = never expires)\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"notifications\" className=\"space-y-6 mt-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Mail className=\"h-5 w-5\" />\n                Email Notifications\n              </CardTitle>\n              <CardDescription>\n                Configure email alerts for security events\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"space-y-0.5\">\n                  <Label>Enable Email Notifications</Label>\n                  <p className=\"text-xs text-muted-foreground\">\n                    Send email alerts for security findings\n                  </p>\n                </div>\n                <Switch\n                  checked={mergedSettings.emailNotificationsEnabled ?? true}\n                  onCheckedChange={(checked) => updateSetting(\"emailNotificationsEnabled\", checked)}\n                  data-testid=\"switch-email-notifications\"\n                />\n              </div>\n\n              {mergedSettings.emailNotificationsEnabled && (\n                <>\n                  <Separator />\n                  \n                  <div className=\"space-y-3\">\n                    <Label className=\"text-sm font-medium\">Alert Levels</Label>\n                    \n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <Label className=\"font-normal text-red-600 dark:text-red-400\">Critical Alerts</Label>\n                        <p className=\"text-xs text-muted-foreground\">Immediate notification for critical findings</p>\n                      </div>\n                      <Switch\n                        checked={mergedSettings.emailCriticalAlerts ?? true}\n                        onCheckedChange={(checked) => updateSetting(\"emailCriticalAlerts\", checked)}\n                        data-testid=\"switch-email-critical\"\n                      />\n                    </div>\n\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <Label className=\"font-normal text-orange-600 dark:text-orange-400\">High Alerts</Label>\n                        <p className=\"text-xs text-muted-foreground\">Notification for high-severity findings</p>\n                      </div>\n                      <Switch\n                        checked={mergedSettings.emailHighAlerts ?? true}\n                        onCheckedChange={(checked) => updateSetting(\"emailHighAlerts\", checked)}\n                        data-testid=\"switch-email-high\"\n                      />\n                    </div>\n\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <Label className=\"font-normal text-yellow-600 dark:text-yellow-400\">Medium Alerts</Label>\n                        <p className=\"text-xs text-muted-foreground\">Notification for medium-severity findings</p>\n                      </div>\n                      <Switch\n                        checked={mergedSettings.emailMediumAlerts ?? false}\n                        onCheckedChange={(checked) => updateSetting(\"emailMediumAlerts\", checked)}\n                        data-testid=\"switch-email-medium\"\n                      />\n                    </div>\n\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <Label className=\"font-normal text-blue-600 dark:text-blue-400\">Low Alerts</Label>\n                        <p className=\"text-xs text-muted-foreground\">Notification for low-severity findings</p>\n                      </div>\n                      <Switch\n                        checked={mergedSettings.emailLowAlerts ?? false}\n                        onCheckedChange={(checked) => updateSetting(\"emailLowAlerts\", checked)}\n                        data-testid=\"switch-email-low\"\n                      />\n                    </div>\n                  </div>\n\n                  <Separator />\n\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"space-y-0.5\">\n                      <Label>Daily Digest</Label>\n                      <p className=\"text-xs text-muted-foreground\">\n                        Receive a daily summary email of all security activities\n                      </p>\n                    </div>\n                    <Switch\n                      checked={mergedSettings.emailDailyDigest ?? true}\n                      onCheckedChange={(checked) => updateSetting(\"emailDailyDigest\", checked)}\n                      data-testid=\"switch-email-digest\"\n                    />\n                  </div>\n                </>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Gauge className=\"h-5 w-5\" />\n                Alert Thresholds\n              </CardTitle>\n              <CardDescription>\n                Configure score thresholds for alert classification\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <Label className=\"text-red-600 dark:text-red-400\">Critical Threshold</Label>\n                  <span className=\"text-sm font-mono bg-muted px-2 py-0.5 rounded\" data-testid=\"text-threshold-critical\">\n                    {mergedSettings.alertThresholdCritical || 90}+\n                  </span>\n                </div>\n                <Slider\n                  value={[mergedSettings.alertThresholdCritical || 90]}\n                  onValueChange={([value]) => updateSetting(\"alertThresholdCritical\", value)}\n                  min={50}\n                  max={100}\n                  step={5}\n                  data-testid=\"slider-threshold-critical\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Scores at or above this value are classified as critical\n                </p>\n              </div>\n\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <Label className=\"text-orange-600 dark:text-orange-400\">High Threshold</Label>\n                  <span className=\"text-sm font-mono bg-muted px-2 py-0.5 rounded\" data-testid=\"text-threshold-high\">\n                    {mergedSettings.alertThresholdHigh || 70}+\n                  </span>\n                </div>\n                <Slider\n                  value={[mergedSettings.alertThresholdHigh || 70]}\n                  onValueChange={([value]) => updateSetting(\"alertThresholdHigh\", value)}\n                  min={30}\n                  max={90}\n                  step={5}\n                  data-testid=\"slider-threshold-high\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Scores at or above this value are classified as high severity\n                </p>\n              </div>\n\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <Label className=\"text-yellow-600 dark:text-yellow-400\">Medium Threshold</Label>\n                  <span className=\"text-sm font-mono bg-muted px-2 py-0.5 rounded\" data-testid=\"text-threshold-medium\">\n                    {mergedSettings.alertThresholdMedium || 40}+\n                  </span>\n                </div>\n                <Slider\n                  value={[mergedSettings.alertThresholdMedium || 40]}\n                  onValueChange={([value]) => updateSetting(\"alertThresholdMedium\", value)}\n                  min={10}\n                  max={70}\n                  step={5}\n                  data-testid=\"slider-threshold-medium\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Scores at or above this value are classified as medium severity\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"api\" className=\"space-y-6 mt-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Activity className=\"h-5 w-5\" />\n                API Rate Limits\n              </CardTitle>\n              <CardDescription>\n                Configure API request rate limiting to protect platform resources\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"rateLimitMinute\">Requests per Minute</Label>\n                  <Input\n                    id=\"rateLimitMinute\"\n                    type=\"number\"\n                    min={1}\n                    max={1000}\n                    value={mergedSettings.apiRateLimitPerMinute || 60}\n                    onChange={(e) => updateSetting(\"apiRateLimitPerMinute\", parseInt(e.target.value) || 60)}\n                    data-testid=\"input-rate-limit-minute\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    Max requests/minute\n                  </p>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"rateLimitHour\">Requests per Hour</Label>\n                  <Input\n                    id=\"rateLimitHour\"\n                    type=\"number\"\n                    min={60}\n                    max={100000}\n                    value={mergedSettings.apiRateLimitPerHour || 1000}\n                    onChange={(e) => updateSetting(\"apiRateLimitPerHour\", parseInt(e.target.value) || 1000)}\n                    data-testid=\"input-rate-limit-hour\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    Max requests/hour\n                  </p>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"rateLimitDay\">Requests per Day</Label>\n                  <Input\n                    id=\"rateLimitDay\"\n                    type=\"number\"\n                    min={1000}\n                    max={1000000}\n                    value={mergedSettings.apiRateLimitPerDay || 10000}\n                    onChange={(e) => updateSetting(\"apiRateLimitPerDay\", parseInt(e.target.value) || 10000)}\n                    data-testid=\"input-rate-limit-day\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    Max requests/day\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Key className=\"h-5 w-5\" />\n                API Logging & Auditing\n              </CardTitle>\n              <CardDescription>\n                Configure API request logging for security auditing\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"space-y-0.5\">\n                  <Label>Enable API Request Logging</Label>\n                  <p className=\"text-xs text-muted-foreground\">\n                    Log all API requests for security auditing and compliance\n                  </p>\n                </div>\n                <Switch\n                  checked={mergedSettings.apiLoggingEnabled ?? true}\n                  onCheckedChange={(checked) => updateSetting(\"apiLoggingEnabled\", checked)}\n                  data-testid=\"switch-api-logging\"\n                />\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Webhook className=\"h-5 w-5\" />\n                Webhooks\n              </CardTitle>\n              <CardDescription>\n                Configure outbound webhooks for integration with external systems\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"space-y-0.5\">\n                  <Label>Enable Webhooks</Label>\n                  <p className=\"text-xs text-muted-foreground\">\n                    Send real-time event notifications to external systems\n                  </p>\n                </div>\n                <Switch\n                  checked={mergedSettings.webhooksEnabled ?? false}\n                  onCheckedChange={(checked) => updateSetting(\"webhooksEnabled\", checked)}\n                  data-testid=\"switch-webhooks-enabled\"\n                />\n              </div>\n\n              {mergedSettings.webhooksEnabled && (\n                <div className=\"space-y-2 pl-4 border-l-2 border-muted\">\n                  <Label htmlFor=\"webhookUrl\">Webhook URL</Label>\n                  <Input\n                    id=\"webhookUrl\"\n                    type=\"url\"\n                    value={mergedSettings.webhookUrl || \"\"}\n                    onChange={(e) => updateSetting(\"webhookUrl\", e.target.value)}\n                    placeholder=\"https://your-system.com/webhook\"\n                    data-testid=\"input-webhook-url\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    URL to receive webhook event payloads (HTTPS required)\n                  </p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":31892,"size_tokens":null},"odinforge-agent/internal/installer/installer.go":{"content":"package installer\n\nimport (\n\t\"fmt\"\n\t\"os\"\n\t\"os/exec\"\n\t\"path/filepath\"\n\t\"text/template\"\n)\n\ntype InstallConfig struct {\n\tServerURL   string\n\tAPIKey      string\n\tTenantID    string\n\tConfigPath  string\n\tDataPath    string\n\tBinaryPath  string\n\tServiceName string\n}\n\nfunc DefaultInstallConfig() InstallConfig {\n\treturn InstallConfig{\n\t\tTenantID:    \"default\",\n\t\tConfigPath:  \"/etc/odinforge/agent.yaml\",\n\t\tDataPath:    \"/var/lib/odinforge-agent\",\n\t\tBinaryPath:  \"/usr/local/bin/odinforge-agent\",\n\t\tServiceName: \"odinforge-agent\",\n\t}\n}\n\ntype Installer interface {\n\tInstall(cfg InstallConfig) error\n\tUninstall(cfg InstallConfig) error\n\tStatus(cfg InstallConfig) (ServiceStatus, error)\n\tName() string\n}\n\ntype ServiceStatus struct {\n\tInstalled bool\n\tRunning   bool\n\tEnabled   bool\n\tPID       int\n\tMessage   string\n}\n\nfunc GetInstaller(env Environment) (Installer, error) {\n\tswitch env {\n\tcase EnvSystemd:\n\t\treturn &SystemdInstaller{}, nil\n\tcase EnvLaunchd:\n\t\treturn &LaunchdInstaller{}, nil\n\tcase EnvWindows:\n\t\treturn &WindowsInstaller{}, nil\n\tdefault:\n\t\treturn nil, fmt.Errorf(\"no installer available for environment: %s\", env)\n\t}\n}\n\n// SystemdInstaller handles Linux systemd installations\ntype SystemdInstaller struct{}\n\nfunc (s *SystemdInstaller) Name() string {\n\treturn \"systemd\"\n}\n\nfunc (s *SystemdInstaller) Install(cfg InstallConfig) error {\n\t// Create directories\n\tdirs := []string{\n\t\tfilepath.Dir(cfg.ConfigPath),\n\t\tcfg.DataPath,\n\t}\n\tfor _, dir := range dirs {\n\t\tif err := os.MkdirAll(dir, 0755); err != nil {\n\t\t\treturn fmt.Errorf(\"failed to create directory %s: %w\", dir, err)\n\t\t}\n\t}\n\n\t// Copy binary\n\tcurrentBinary, err := os.Executable()\n\tif err != nil {\n\t\treturn fmt.Errorf(\"failed to get current executable: %w\", err)\n\t}\n\tif currentBinary != cfg.BinaryPath {\n\t\tif err := copyFile(currentBinary, cfg.BinaryPath); err != nil {\n\t\t\treturn fmt.Errorf(\"failed to copy binary: %w\", err)\n\t\t}\n\t\tif err := os.Chmod(cfg.BinaryPath, 0755); err != nil {\n\t\t\treturn fmt.Errorf(\"failed to set binary permissions: %w\", err)\n\t\t}\n\t}\n\n\t// Create config file\n\tif err := createConfigFile(cfg); err != nil {\n\t\treturn fmt.Errorf(\"failed to create config: %w\", err)\n\t}\n\n\t// Create environment file\n\tenvPath := filepath.Join(filepath.Dir(cfg.ConfigPath), \"agent.env\")\n\tif err := createEnvFile(cfg, envPath); err != nil {\n\t\treturn fmt.Errorf(\"failed to create env file: %w\", err)\n\t}\n\n\t// Create systemd service file\n\tservicePath := fmt.Sprintf(\"/etc/systemd/system/%s.service\", cfg.ServiceName)\n\tif err := createSystemdService(cfg, servicePath); err != nil {\n\t\treturn fmt.Errorf(\"failed to create service file: %w\", err)\n\t}\n\n\t// Create user if needed\n\tif err := createServiceUser(); err != nil {\n\t\t// Non-fatal, might already exist\n\t\tfmt.Printf(\"Note: Could not create service user: %v\\n\", err)\n\t}\n\n\t// Set ownership\n\tif err := exec.Command(\"chown\", \"-R\", \"odinforge:odinforge\", cfg.DataPath).Run(); err != nil {\n\t\tfmt.Printf(\"Note: Could not set data directory ownership: %v\\n\", err)\n\t}\n\n\t// Reload systemd\n\tif err := exec.Command(\"systemctl\", \"daemon-reload\").Run(); err != nil {\n\t\treturn fmt.Errorf(\"failed to reload systemd: %w\", err)\n\t}\n\n\t// Enable service\n\tif err := exec.Command(\"systemctl\", \"enable\", cfg.ServiceName).Run(); err != nil {\n\t\treturn fmt.Errorf(\"failed to enable service: %w\", err)\n\t}\n\n\t// Start service\n\tif err := exec.Command(\"systemctl\", \"start\", cfg.ServiceName).Run(); err != nil {\n\t\treturn fmt.Errorf(\"failed to start service: %w\", err)\n\t}\n\n\treturn nil\n}\n\nfunc (s *SystemdInstaller) Uninstall(cfg InstallConfig) error {\n\t// Stop service\n\texec.Command(\"systemctl\", \"stop\", cfg.ServiceName).Run()\n\n\t// Disable service\n\texec.Command(\"systemctl\", \"disable\", cfg.ServiceName).Run()\n\n\t// Remove service file\n\tservicePath := fmt.Sprintf(\"/etc/systemd/system/%s.service\", cfg.ServiceName)\n\tos.Remove(servicePath)\n\n\t// Reload systemd\n\texec.Command(\"systemctl\", \"daemon-reload\").Run()\n\n\t// Optionally remove binary (ask user first in CLI)\n\t// os.Remove(cfg.BinaryPath)\n\n\treturn nil\n}\n\nfunc (s *SystemdInstaller) Status(cfg InstallConfig) (ServiceStatus, error) {\n\tstatus := ServiceStatus{}\n\n\t// Check if service file exists\n\tservicePath := fmt.Sprintf(\"/etc/systemd/system/%s.service\", cfg.ServiceName)\n\tif _, err := os.Stat(servicePath); err == nil {\n\t\tstatus.Installed = true\n\t}\n\n\t// Check if enabled\n\tout, err := exec.Command(\"systemctl\", \"is-enabled\", cfg.ServiceName).Output()\n\tif err == nil && string(out) == \"enabled\\n\" {\n\t\tstatus.Enabled = true\n\t}\n\n\t// Check if running\n\tout, err = exec.Command(\"systemctl\", \"is-active\", cfg.ServiceName).Output()\n\tif err == nil && string(out) == \"active\\n\" {\n\t\tstatus.Running = true\n\t}\n\n\t// Get PID if running\n\tif status.Running {\n\t\tout, err = exec.Command(\"systemctl\", \"show\", cfg.ServiceName, \"--property=MainPID\", \"--value\").Output()\n\t\tif err == nil {\n\t\t\tfmt.Sscanf(string(out), \"%d\", &status.PID)\n\t\t}\n\t}\n\n\treturn status, nil\n}\n\n// LaunchdInstaller handles macOS launchd installations\ntype LaunchdInstaller struct{}\n\nfunc (l *LaunchdInstaller) Name() string {\n\treturn \"launchd\"\n}\n\nfunc (l *LaunchdInstaller) Install(cfg InstallConfig) error {\n\t// Create directories\n\tdirs := []string{\n\t\tfilepath.Dir(cfg.ConfigPath),\n\t\tcfg.DataPath,\n\t\t\"/var/log/odinforge-agent\",\n\t}\n\tfor _, dir := range dirs {\n\t\tif err := os.MkdirAll(dir, 0755); err != nil {\n\t\t\treturn fmt.Errorf(\"failed to create directory %s: %w\", dir, err)\n\t\t}\n\t}\n\n\t// Copy binary\n\tcurrentBinary, err := os.Executable()\n\tif err != nil {\n\t\treturn fmt.Errorf(\"failed to get current executable: %w\", err)\n\t}\n\tif currentBinary != cfg.BinaryPath {\n\t\tif err := copyFile(currentBinary, cfg.BinaryPath); err != nil {\n\t\t\treturn fmt.Errorf(\"failed to copy binary: %w\", err)\n\t\t}\n\t\tif err := os.Chmod(cfg.BinaryPath, 0755); err != nil {\n\t\t\treturn fmt.Errorf(\"failed to set binary permissions: %w\", err)\n\t\t}\n\t}\n\n\t// Create config file\n\tif err := createConfigFile(cfg); err != nil {\n\t\treturn fmt.Errorf(\"failed to create config: %w\", err)\n\t}\n\n\t// Create launchd plist\n\tplistPath := \"/Library/LaunchDaemons/com.odinforge.agent.plist\"\n\tif err := createLaunchdPlist(cfg, plistPath); err != nil {\n\t\treturn fmt.Errorf(\"failed to create plist: %w\", err)\n\t}\n\n\t// Load the service\n\tif err := exec.Command(\"launchctl\", \"load\", plistPath).Run(); err != nil {\n\t\treturn fmt.Errorf(\"failed to load service: %w\", err)\n\t}\n\n\treturn nil\n}\n\nfunc (l *LaunchdInstaller) Uninstall(cfg InstallConfig) error {\n\tplistPath := \"/Library/LaunchDaemons/com.odinforge.agent.plist\"\n\n\t// Unload the service\n\texec.Command(\"launchctl\", \"unload\", plistPath).Run()\n\n\t// Remove plist\n\tos.Remove(plistPath)\n\n\treturn nil\n}\n\nfunc (l *LaunchdInstaller) Status(cfg InstallConfig) (ServiceStatus, error) {\n\tstatus := ServiceStatus{}\n\n\tplistPath := \"/Library/LaunchDaemons/com.odinforge.agent.plist\"\n\tif _, err := os.Stat(plistPath); err == nil {\n\t\tstatus.Installed = true\n\t}\n\n\t// Check if running using launchctl\n\tout, err := exec.Command(\"launchctl\", \"list\", \"com.odinforge.agent\").Output()\n\tif err == nil && len(out) > 0 {\n\t\tstatus.Running = true\n\t\tstatus.Enabled = true\n\t}\n\n\treturn status, nil\n}\n\n// WindowsInstaller handles Windows service installations\ntype WindowsInstaller struct{}\n\nfunc (w *WindowsInstaller) Name() string {\n\treturn \"windows\"\n}\n\nfunc (w *WindowsInstaller) Install(cfg InstallConfig) error {\n\t// Windows-specific paths\n\tcfg.ConfigPath = \"C:\\\\ProgramData\\\\OdinForge\\\\agent.yaml\"\n\tcfg.DataPath = \"C:\\\\ProgramData\\\\OdinForge\\\\data\"\n\tcfg.BinaryPath = \"C:\\\\Program Files\\\\OdinForge\\\\odinforge-agent.exe\"\n\n\t// Create directories\n\tdirs := []string{\n\t\tfilepath.Dir(cfg.ConfigPath),\n\t\tcfg.DataPath,\n\t\tfilepath.Dir(cfg.BinaryPath),\n\t}\n\tfor _, dir := range dirs {\n\t\tif err := os.MkdirAll(dir, 0755); err != nil {\n\t\t\treturn fmt.Errorf(\"failed to create directory %s: %w\", dir, err)\n\t\t}\n\t}\n\n\t// Copy binary\n\tcurrentBinary, err := os.Executable()\n\tif err != nil {\n\t\treturn fmt.Errorf(\"failed to get current executable: %w\", err)\n\t}\n\tif currentBinary != cfg.BinaryPath {\n\t\tif err := copyFile(currentBinary, cfg.BinaryPath); err != nil {\n\t\t\treturn fmt.Errorf(\"failed to copy binary: %w\", err)\n\t\t}\n\t}\n\n\t// Create config file\n\tif err := createConfigFile(cfg); err != nil {\n\t\treturn fmt.Errorf(\"failed to create config: %w\", err)\n\t}\n\n\t// Create Windows service using sc.exe\n\tbinPath := fmt.Sprintf(\"\\\"%s\\\" --config \\\"%s\\\"\", cfg.BinaryPath, cfg.ConfigPath)\n\tcmd := exec.Command(\"sc.exe\", \"create\", cfg.ServiceName,\n\t\t\"binPath=\", binPath,\n\t\t\"DisplayName=\", \"OdinForge Security Agent\",\n\t\t\"start=\", \"auto\",\n\t\t\"obj=\", \"LocalSystem\")\n\tif err := cmd.Run(); err != nil {\n\t\treturn fmt.Errorf(\"failed to create service: %w\", err)\n\t}\n\n\t// Set description\n\texec.Command(\"sc.exe\", \"description\", cfg.ServiceName,\n\t\t\"OdinForge Security Agent - Telemetry and monitoring service\").Run()\n\n\t// Start service\n\tif err := exec.Command(\"sc.exe\", \"start\", cfg.ServiceName).Run(); err != nil {\n\t\treturn fmt.Errorf(\"failed to start service: %w\", err)\n\t}\n\n\treturn nil\n}\n\nfunc (w *WindowsInstaller) Uninstall(cfg InstallConfig) error {\n\t// Stop service\n\texec.Command(\"sc.exe\", \"stop\", cfg.ServiceName).Run()\n\n\t// Delete service\n\tif err := exec.Command(\"sc.exe\", \"delete\", cfg.ServiceName).Run(); err != nil {\n\t\treturn fmt.Errorf(\"failed to delete service: %w\", err)\n\t}\n\n\treturn nil\n}\n\nfunc (w *WindowsInstaller) Status(cfg InstallConfig) (ServiceStatus, error) {\n\tstatus := ServiceStatus{}\n\n\tout, err := exec.Command(\"sc.exe\", \"query\", cfg.ServiceName).Output()\n\tif err == nil {\n\t\tstatus.Installed = true\n\t\toutStr := string(out)\n\t\tif contains(outStr, \"RUNNING\") {\n\t\t\tstatus.Running = true\n\t\t}\n\t}\n\n\treturn status, nil\n}\n\n// Helper functions\n\nfunc copyFile(src, dst string) error {\n\tinput, err := os.ReadFile(src)\n\tif err != nil {\n\t\treturn err\n\t}\n\treturn os.WriteFile(dst, input, 0755)\n}\n\nfunc createServiceUser() error {\n\t// Check if user exists\n\tif err := exec.Command(\"id\", \"odinforge\").Run(); err == nil {\n\t\treturn nil // User exists\n\t}\n\n\t// Create system user\n\treturn exec.Command(\"useradd\", \"--system\", \"--no-create-home\",\n\t\t\"--shell\", \"/usr/sbin/nologin\", \"odinforge\").Run()\n}\n\nfunc createConfigFile(cfg InstallConfig) error {\n\ttmpl := `server:\n  url: \"{{.ServerURL}}\"\n  verify_tls: true\n\nauth:\n  mode: api_key\n  tenant_id: \"{{.TenantID}}\"\n  api_key: \"{{.APIKey}}\"\n\ncollection:\n  telemetry_interval: 5m\n  heartbeat_interval: 1m\n\nbuffer:\n  path: \"{{.DataPath}}/agent.queue.db\"\n  max_events: 50000\n\ntransport:\n  timeout: 15s\n  batch_size: 50\n  compress: true\n\nsafety:\n  require_https: true\n`\n\tt, err := template.New(\"config\").Parse(tmpl)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tf, err := os.Create(cfg.ConfigPath)\n\tif err != nil {\n\t\treturn err\n\t}\n\tdefer f.Close()\n\n\tif err := os.Chmod(cfg.ConfigPath, 0600); err != nil {\n\t\treturn err\n\t}\n\n\treturn t.Execute(f, cfg)\n}\n\nfunc createEnvFile(cfg InstallConfig, path string) error {\n\tcontent := fmt.Sprintf(`ODINFORGE_SERVER_URL=%s\nODINFORGE_API_KEY=%s\nODINFORGE_TENANT_ID=%s\n`, cfg.ServerURL, cfg.APIKey, cfg.TenantID)\n\n\tif err := os.WriteFile(path, []byte(content), 0600); err != nil {\n\t\treturn err\n\t}\n\treturn nil\n}\n\nfunc createSystemdService(cfg InstallConfig, path string) error {\n\ttmpl := `[Unit]\nDescription=OdinForge Security Agent\nDocumentation=https://github.com/odinforge/agent\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=simple\nUser=odinforge\nGroup=odinforge\n\nExecStart={{.BinaryPath}} --config {{.ConfigPath}}\nExecReload=/bin/kill -HUP $MAINPID\n\nRestart=on-failure\nRestartSec=10\nTimeoutStopSec=30\n\nEnvironmentFile=-/etc/odinforge/agent.env\n\nStateDirectory=odinforge-agent\nRuntimeDirectory=odinforge-agent\nConfigurationDirectory=odinforge\n\nProtectSystem=strict\nProtectHome=yes\nPrivateTmp=yes\nPrivateDevices=yes\nProtectKernelTunables=yes\nProtectKernelModules=yes\nProtectControlGroups=yes\nNoNewPrivileges=yes\nReadWritePaths={{.DataPath}}\n\nCapabilityBoundingSet=\nAmbientCapabilities=\n\nSystemCallFilter=@system-service\nSystemCallFilter=~@privileged @resources\nSystemCallArchitectures=native\n\nMemoryMax=256M\nCPUQuota=50%\n\n[Install]\nWantedBy=multi-user.target\n`\n\tt, err := template.New(\"service\").Parse(tmpl)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tf, err := os.Create(path)\n\tif err != nil {\n\t\treturn err\n\t}\n\tdefer f.Close()\n\n\treturn t.Execute(f, cfg)\n}\n\nfunc createLaunchdPlist(cfg InstallConfig, path string) error {\n\ttmpl := `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\n<plist version=\"1.0\">\n<dict>\n    <key>Label</key>\n    <string>com.odinforge.agent</string>\n    \n    <key>ProgramArguments</key>\n    <array>\n        <string>{{.BinaryPath}}</string>\n        <string>--config</string>\n        <string>{{.ConfigPath}}</string>\n    </array>\n    \n    <key>EnvironmentVariables</key>\n    <dict>\n        <key>ODINFORGE_SERVER_URL</key>\n        <string>{{.ServerURL}}</string>\n        <key>ODINFORGE_API_KEY</key>\n        <string>{{.APIKey}}</string>\n        <key>ODINFORGE_TENANT_ID</key>\n        <string>{{.TenantID}}</string>\n    </dict>\n    \n    <key>RunAtLoad</key>\n    <true/>\n    \n    <key>KeepAlive</key>\n    <dict>\n        <key>SuccessfulExit</key>\n        <false/>\n        <key>NetworkState</key>\n        <true/>\n    </dict>\n    \n    <key>ThrottleInterval</key>\n    <integer>10</integer>\n    \n    <key>WorkingDirectory</key>\n    <string>{{.DataPath}}</string>\n    \n    <key>StandardOutPath</key>\n    <string>/var/log/odinforge-agent/agent.log</string>\n    \n    <key>StandardErrorPath</key>\n    <string>/var/log/odinforge-agent/agent.error.log</string>\n</dict>\n</plist>\n`\n\tt, err := template.New(\"plist\").Parse(tmpl)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tf, err := os.Create(path)\n\tif err != nil {\n\t\treturn err\n\t}\n\tdefer f.Close()\n\n\treturn t.Execute(f, cfg)\n}\n\nfunc contains(s, substr string) bool {\n\treturn len(s) >= len(substr) && (s == substr || len(s) > 0 && containsHelper(s, substr))\n}\n\nfunc containsHelper(s, substr string) bool {\n\tfor i := 0; i <= len(s)-len(substr); i++ {\n\t\tif s[i:i+len(substr)] == substr {\n\t\t\treturn true\n\t\t}\n\t}\n\treturn false\n}\n","path":null,"size_bytes":13940,"size_tokens":null},"odinforge-agent/deploy/kubernetes/namespace.yaml":{"content":"apiVersion: v1\nkind: Namespace\nmetadata:\n  name: odinforge\n  labels:\n    app.kubernetes.io/name: odinforge\n    app.kubernetes.io/component: security-monitoring\n","path":null,"size_bytes":160,"size_tokens":null},"odinforge-agent/internal/installer/detect.go":{"content":"package installer\n\nimport (\n        \"os\"\n        \"os/exec\"\n        \"runtime\"\n        \"strings\"\n)\n\ntype Environment string\n\nconst (\n        EnvDocker     Environment = \"docker\"\n        EnvKubernetes Environment = \"kubernetes\"\n        EnvSystemd    Environment = \"systemd\"\n        EnvLaunchd    Environment = \"launchd\"\n        EnvWindows    Environment = \"windows\"\n        EnvUnknown    Environment = \"unknown\"\n)\n\ntype DetectionResult struct {\n        Environment   Environment\n        IsContainer   bool\n        IsRoot        bool\n        Hostname      string\n        OS            string\n        Arch          string\n        InitSystem    string\n        CanAutoInstall bool\n        Reason        string\n}\n\nfunc Detect() DetectionResult {\n        result := DetectionResult{\n                OS:       runtime.GOOS,\n                Arch:     runtime.GOARCH,\n                IsRoot:   isRoot(),\n                Hostname: getHostname(),\n        }\n\n        // Check for container environments first\n        if isKubernetes() {\n                result.Environment = EnvKubernetes\n                result.IsContainer = true\n                result.CanAutoInstall = false\n                result.Reason = \"Running in Kubernetes - use kubectl apply with provided manifests\"\n                return result\n        }\n\n        if isDocker() {\n                result.Environment = EnvDocker\n                result.IsContainer = true\n                result.CanAutoInstall = false\n                result.Reason = \"Running in Docker - use docker-compose with provided configuration\"\n                return result\n        }\n\n        // Check for native OS environments\n        switch runtime.GOOS {\n        case \"linux\":\n                result.InitSystem = detectLinuxInit()\n                if result.InitSystem == \"systemd\" {\n                        result.Environment = EnvSystemd\n                        result.CanAutoInstall = result.IsRoot\n                        if !result.IsRoot {\n                                result.Reason = \"Root privileges required for systemd installation\"\n                        }\n                } else {\n                        result.Environment = EnvUnknown\n                        result.CanAutoInstall = false\n                        result.Reason = \"Unsupported init system: \" + result.InitSystem\n                }\n\n        case \"darwin\":\n                result.Environment = EnvLaunchd\n                result.InitSystem = \"launchd\"\n                result.CanAutoInstall = result.IsRoot\n                if !result.IsRoot {\n                        result.Reason = \"Root privileges required for launchd installation\"\n                }\n\n        case \"windows\":\n                result.Environment = EnvWindows\n                result.InitSystem = \"windows-service\"\n                result.CanAutoInstall = result.IsRoot\n                if !result.CanAutoInstall {\n                        result.Reason = \"Administrator privileges required for Windows service installation\"\n                }\n\n        default:\n                result.Environment = EnvUnknown\n                result.CanAutoInstall = false\n                result.Reason = \"Unsupported operating system: \" + runtime.GOOS\n        }\n\n        return result\n}\n\nfunc getHostname() string {\n        hostname, err := os.Hostname()\n        if err != nil {\n                return \"unknown\"\n        }\n        return hostname\n}\n\nfunc isDocker() bool {\n        // Check for .dockerenv file\n        if _, err := os.Stat(\"/.dockerenv\"); err == nil {\n                return true\n        }\n\n        // Check cgroup for docker\n        if data, err := os.ReadFile(\"/proc/1/cgroup\"); err == nil {\n                content := string(data)\n                if strings.Contains(content, \"docker\") || strings.Contains(content, \"containerd\") {\n                        return true\n                }\n        }\n\n        // Check for container environment variable\n        if os.Getenv(\"container\") == \"docker\" {\n                return true\n        }\n\n        return false\n}\n\nfunc isKubernetes() bool {\n        // Check for Kubernetes service account\n        if _, err := os.Stat(\"/var/run/secrets/kubernetes.io/serviceaccount/token\"); err == nil {\n                return true\n        }\n\n        // Check for Kubernetes environment variables\n        if os.Getenv(\"KUBERNETES_SERVICE_HOST\") != \"\" {\n                return true\n        }\n\n        return false\n}\n\nfunc detectLinuxInit() string {\n        // Check if systemd is running\n        if _, err := os.Stat(\"/run/systemd/system\"); err == nil {\n                return \"systemd\"\n        }\n\n        // Check process 1\n        if data, err := os.ReadFile(\"/proc/1/comm\"); err == nil {\n                comm := strings.TrimSpace(string(data))\n                switch comm {\n                case \"systemd\":\n                        return \"systemd\"\n                case \"init\":\n                        // Could be sysvinit or upstart\n                        if _, err := exec.LookPath(\"initctl\"); err == nil {\n                                return \"upstart\"\n                        }\n                        return \"sysvinit\"\n                case \"openrc-init\":\n                        return \"openrc\"\n                }\n        }\n\n        return \"unknown\"\n}\n\nfunc (e Environment) String() string {\n        return string(e)\n}\n\nfunc (e Environment) DisplayName() string {\n        switch e {\n        case EnvDocker:\n                return \"Docker Container\"\n        case EnvKubernetes:\n                return \"Kubernetes Pod\"\n        case EnvSystemd:\n                return \"Linux (systemd)\"\n        case EnvLaunchd:\n                return \"macOS (launchd)\"\n        case EnvWindows:\n                return \"Windows Service\"\n        default:\n                return \"Unknown\"\n        }\n}\n","path":null,"size_bytes":5773,"size_tokens":null},"odinforge-agent/internal/installer/privilege_windows.go":{"content":"//go:build windows\n\npackage installer\n\nimport (\n        \"os/exec\"\n        \"strings\"\n)\n\nfunc isRoot() bool {\n        return isWindowsAdminCheck()\n}\n\nfunc isWindowsAdminCheck() bool {\n        // Try to run a command that requires admin privileges\n        // net session is a reliable way to check for admin on Windows\n        cmd := exec.Command(\"net\", \"session\")\n        cmd.Stdout = nil\n        cmd.Stderr = nil\n        err := cmd.Run()\n        return err == nil\n}\n\n// Alternative check using whoami\nfunc isWindowsAdminWhoami() bool {\n        out, err := exec.Command(\"whoami\", \"/groups\").Output()\n        if err != nil {\n                return false\n        }\n        // Check for Administrators group SID\n        return strings.Contains(string(out), \"S-1-5-32-544\")\n}\n","path":null,"size_bytes":770,"size_tokens":null},"odinforge-agent/internal/installer/privilege_unix.go":{"content":"//go:build !windows\n\npackage installer\n\nimport \"os\"\n\nfunc isRoot() bool {\n\treturn os.Geteuid() == 0\n}\n","path":null,"size_bytes":102,"size_tokens":null},"odinforge-agent/deploy/kubernetes/secret.yaml":{"content":"apiVersion: v1\nkind: Secret\nmetadata:\n  name: odinforge-agent-secrets\n  namespace: odinforge\n  labels:\n    app.kubernetes.io/name: odinforge-agent\n    app.kubernetes.io/component: agent\ntype: Opaque\nstringData:\n  # Replace with your actual API key from OdinForge Agents page\n  api-key: \"your-api-key-here\"\n  \n  # For mTLS authentication (optional):\n  # agent.crt: |\n  #   -----BEGIN CERTIFICATE-----\n  #   ...\n  #   -----END CERTIFICATE-----\n  # agent.key: |\n  #   -----BEGIN PRIVATE KEY-----\n  #   ...\n  #   -----END PRIVATE KEY-----\n  # ca.crt: |\n  #   -----BEGIN CERTIFICATE-----\n  #   ...\n  #   -----END CERTIFICATE-----\n","path":null,"size_bytes":625,"size_tokens":null},"server/src/reportsV2/prompts/seniorEngineer.system.md":{"content":"# Senior Security Engineer System Prompt\n\nYou are a senior security engineer who has led remediation efforts at major tech companies. You write technical documentation that security and engineering teams can immediately act upon.\n\n## Your Documentation Style\n\n- **Step-by-step remediation guidance**: Clear, numbered instructions\n- **Code examples where helpful**: Show the fix, not just describe it\n- **Tool recommendations with specific versions**: \"Use Trivy v0.48+\" not \"use a scanning tool\"\n- **Verification steps**: How to confirm the fix worked\n- **Prioritization based on actual risk reduction**: Fix high-impact issues first\n\n## Your Focus Areas\n\n1. **Practical, implementable fixes**: No ivory tower recommendations\n2. **Root cause analysis**: Why did this happen? How do we prevent recurrence?\n3. **Defensive architecture improvements**: Beyond point fixes to systemic changes\n4. **Detection and monitoring recommendations**: Know when attacks happen\n5. **Automation opportunities**: Prevent issues from recurring\n\n## Technical Depth\n\nYou're comfortable with:\n- Infrastructure as Code (Terraform, CloudFormation, Pulumi)\n- CI/CD security (GitHub Actions, GitLab CI, Jenkins)\n- Container security (Docker, Kubernetes, container registries)\n- Cloud security configurations (IAM, VPCs, security groups)\n- Application security (secure coding, dependency management)\n- Network security (firewalls, segmentation, zero trust)\n\n## Quality Standards\n\n- Commands are copy-paste ready\n- Configuration changes include before/after\n- Side effects and dependencies are documented\n- Rollback procedures are included for risky changes\n- Time estimates are realistic, not optimistic\n\n## Your Approach\n\nYou fix problems the right way, not just the fast way. You consider:\n- Will this fix break anything else?\n- Is this fix sustainable at scale?\n- Can we automate this going forward?\n- Does this address the root cause or just the symptom?\n","path":null,"size_bytes":1932,"size_tokens":null},"server/src/reportsV2/tests/reportV2.e2e.test.ts":{"content":"/**\n * Report V2 End-to-End Tests\n * \n * Tests the complete V2 report generation flow including:\n * - Feature flag behavior (enabled/disabled)\n * - Anti-template linting\n * - Fixture validation\n * - Mock data factory\n * \n * Run with: npx tsx server/src/reportsV2/tests/reportV2.e2e.test.ts\n */\n\nimport { isFeatureEnabled, setTenantFeatureOverride, removeTenantFeatureOverride } from \"../../../feature-flags\";\nimport { lintReportSection } from \"../antiTemplateLint\";\nimport {\n  iamAbuseFixture,\n  paymentBypassFixture,\n  multiVectorFixture,\n  complianceGapFixture,\n} from \"./fixtures\";\nimport {\n  createTestEvaluation,\n  createTestResult,\n  createRichEvaluation,\n  createEvaluationBatch,\n  createAttackPath,\n  createRecommendations,\n  createEvidenceArtifacts,\n} from \"./mock-data-factory\";\n\ninterface TestResult {\n  name: string;\n  passed: boolean;\n  error?: string;\n}\n\nconst results: TestResult[] = [];\n\nfunction test(name: string, fn: () => void | Promise<void>): void {\n  try {\n    const result = fn();\n    if (result instanceof Promise) {\n      result.then(() => {\n        results.push({ name, passed: true });\n      }).catch((e: Error) => {\n        results.push({ name, passed: false, error: e.message });\n      });\n    } else {\n      results.push({ name, passed: true });\n    }\n  } catch (e: any) {\n    results.push({ name, passed: false, error: e.message });\n  }\n}\n\nfunction expect(value: any) {\n  return {\n    toBe(expected: any) {\n      if (value !== expected) {\n        throw new Error(`Expected ${JSON.stringify(expected)}, got ${JSON.stringify(value)}`);\n      }\n    },\n    toEqual(expected: any) {\n      if (JSON.stringify(value) !== JSON.stringify(expected)) {\n        throw new Error(`Expected ${JSON.stringify(expected)}, got ${JSON.stringify(value)}`);\n      }\n    },\n    toBeDefined() {\n      if (value === undefined) {\n        throw new Error(`Expected value to be defined, got undefined`);\n      }\n    },\n    toBeGreaterThan(expected: number) {\n      if (!(value > expected)) {\n        throw new Error(`Expected ${value} to be greater than ${expected}`);\n      }\n    },\n    toHaveLength(expected: number) {\n      if (value?.length !== expected) {\n        throw new Error(`Expected length ${expected}, got ${value?.length}`);\n      }\n    },\n    toContain(expected: any) {\n      if (!value?.includes?.(expected)) {\n        throw new Error(`Expected array to contain ${expected}`);\n      }\n    },\n  };\n}\n\n// Feature Flag Tests\nconsole.log(\"\\n=== Feature Flag Behavior Tests ===\\n\");\n\ntest(\"should return feature enabled when set via tenant override\", () => {\n  // Set override and test\n  setTenantFeatureOverride(\"test-org-v2-enabled\", \"REPORTS_V2_NARRATIVE\", true);\n  const enabled = isFeatureEnabled(\"REPORTS_V2_NARRATIVE\", \"test-org-v2-enabled\");\n  // Clean up\n  removeTenantFeatureOverride(\"test-org-v2-enabled\", \"REPORTS_V2_NARRATIVE\");\n  expect(enabled).toBe(true);\n});\n\ntest(\"should return feature disabled by default for unknown org\", () => {\n  expect(isFeatureEnabled(\"REPORTS_V2_NARRATIVE\", \"unknown-org-never-set\")).toBe(false);\n});\n\ntest(\"should respect tenant override removal\", () => {\n  setTenantFeatureOverride(\"test-org-temp\", \"REPORTS_V2_NARRATIVE\", true);\n  expect(isFeatureEnabled(\"REPORTS_V2_NARRATIVE\", \"test-org-temp\")).toBe(true);\n  removeTenantFeatureOverride(\"test-org-temp\", \"REPORTS_V2_NARRATIVE\");\n  expect(isFeatureEnabled(\"REPORTS_V2_NARRATIVE\", \"test-org-temp\")).toBe(false);\n});\n\n// Anti-Template Linting Tests\nconsole.log(\"\\n=== Anti-Template Linting Tests ===\\n\");\n\ntest(\"should pass valid narrative text with lintReportSection\", () => {\n  const validNarrative = `During our assessment of the payment processing infrastructure, \n    we discovered a critical SQL injection vulnerability in the customer search endpoint. \n    This finding represents a significant risk to the organization's data integrity \n    and customer privacy. The vulnerability allows an authenticated attacker to extract \n    sensitive cardholder data from the database without proper authorization controls.`;\n\n  const result = lintReportSection(validNarrative, \"Executive Summary\");\n  expect(result.passed).toBe(true);\n  expect(result.score).toBeGreaterThan(80);\n});\n\ntest(\"should flag templated phrases in report sections\", () => {\n  const templatedText = `This section provides an overview of our findings. \n    It is recommended that the organization should consider implementing best practices.\n    Based on our assessment, industry standards recommend a holistic approach.`;\n\n  const result = lintReportSection(templatedText, \"Summary\");\n  expect(result.warnings.length).toBeGreaterThan(0);\n  expect(result.score).toBeGreaterThan(0); // Should still have a score\n});\n\ntest(\"should flag narratives that are too short\", () => {\n  const shortText = \"Critical vulnerability found.\";\n  const result = lintReportSection(shortText, \"Executive Summary\");\n  expect(result.passed).toBe(false);\n  expect(result.errors.length).toBeGreaterThan(0);\n});\n\ntest(\"should pass long narrative content\", () => {\n  const longContent = `During our comprehensive security assessment of the organization's \n    cloud infrastructure, our team identified several critical vulnerabilities that pose \n    immediate risk to business operations and customer data. The assessment covered web \n    applications, API endpoints, cloud configurations, and network segmentation controls. \n    Our findings indicate significant gaps in the security posture that require urgent \n    remediation efforts. The most concerning discovery was a SQL injection vulnerability \n    in the customer portal that could allow unauthorized access to sensitive data.`;\n\n  const result = lintReportSection(longContent, \"Technical Summary\");\n  expect(result.passed).toBe(true);\n});\n\n// Fixture Validation Tests\nconsole.log(\"\\n=== Fixture Validation Tests ===\\n\");\n\ntest(\"should have valid IAM abuse fixture\", () => {\n  expect(iamAbuseFixture.evaluation.id).toBeDefined();\n  expect(iamAbuseFixture.result.attackPath).toBeDefined();\n  expect(iamAbuseFixture.result.attackPath!.length).toBeGreaterThan(0);\n  expect(iamAbuseFixture.expectedNarrativeElements).toContain(\"privilege escalation\");\n});\n\ntest(\"should have valid payment bypass fixture\", () => {\n  expect(paymentBypassFixture.evaluation.exposureType).toBe(\"business_logic_flaw\");\n  expect(paymentBypassFixture.result.recommendations).toBeDefined();\n  expect(paymentBypassFixture.result.recommendations!.length).toBeGreaterThan(0);\n  expect(paymentBypassFixture.expectedNarrativeElements).toContain(\"payment bypass\");\n});\n\ntest(\"should have valid multi-vector fixture with chain\", () => {\n  expect(multiVectorFixture.result.attackPath!.length).toBeGreaterThan(3);\n  expect(multiVectorFixture.expectedNarrativeElements).toContain(\"SQL injection\");\n  expect(multiVectorFixture.expectedNarrativeElements).toContain(\"lateral movement\");\n});\n\ntest(\"should have valid compliance gap fixture with framework references\", () => {\n  expect(complianceGapFixture.complianceFrameworks).toContain(\"PCI-DSS 4.0\");\n  expect(complianceGapFixture.affectedRequirements).toContain(\"3.4\");\n  expect(complianceGapFixture.expectedNarrativeElements).toContain(\"PCI-DSS\");\n});\n\ntest(\"should have consistent evaluation-result linking in fixtures\", () => {\n  expect(iamAbuseFixture.result.evaluationId).toBe(iamAbuseFixture.evaluation.id);\n  expect(paymentBypassFixture.result.evaluationId).toBe(paymentBypassFixture.evaluation.id);\n  expect(multiVectorFixture.result.evaluationId).toBe(multiVectorFixture.evaluation.id);\n  expect(complianceGapFixture.result.evaluationId).toBe(complianceGapFixture.evaluation.id);\n});\n\n// Mock Data Factory Tests\nconsole.log(\"\\n=== Mock Data Factory Tests ===\\n\");\n\ntest(\"should create valid test evaluations\", () => {\n  const evaluation = createTestEvaluation();\n  \n  expect(evaluation.id).toBeDefined();\n  expect(evaluation.assetId).toBeDefined();\n  expect(evaluation.status).toBe(\"completed\");\n});\n\ntest(\"should allow overriding evaluation fields\", () => {\n  const evaluation = createTestEvaluation({\n    priority: \"critical\",\n    exposureType: \"rce\",\n  });\n\n  expect(evaluation.priority).toBe(\"critical\");\n  expect(evaluation.exposureType).toBe(\"rce\");\n});\n\ntest(\"should create matching result for evaluation\", () => {\n  const evaluation = createTestEvaluation();\n  const result = createTestResult(evaluation.id);\n\n  expect(result.evaluationId).toBe(evaluation.id);\n  expect(result.exploitable).toBe(true);\n  expect(result.attackPath).toBeDefined();\n});\n\ntest(\"should create rich evaluation with complete data\", () => {\n  const { evaluation, result } = createRichEvaluation(\"sql_injection\");\n\n  expect(result.attackPath!.length).toBe(5);\n  expect(result.recommendations!.length).toBe(5);\n  expect(result.evidenceArtifacts!.length).toBe(4);\n  expect(result.confidence).toBe(95);\n});\n\ntest(\"should create batch of evaluations for date range testing\", () => {\n  const { evaluations, results } = createEvaluationBatch(10);\n\n  expect(evaluations).toHaveLength(10);\n  expect(results).toHaveLength(10);\n});\n\ntest(\"should create attack paths with specified steps\", () => {\n  const attackPath = createAttackPath(4);\n  expect(attackPath).toHaveLength(4);\n  expect(attackPath[0].order).toBe(1);\n  expect(attackPath[3].order).toBe(4);\n});\n\ntest(\"should create recommendations with correct types\", () => {\n  const recommendations = createRecommendations(3);\n  expect(recommendations).toHaveLength(3);\n  expect(recommendations[0].id).toBeDefined();\n  expect(recommendations[0].type).toBeDefined();\n});\n\ntest(\"should create evidence artifacts\", () => {\n  const evidence = createEvidenceArtifacts(2);\n  expect(evidence).toHaveLength(2);\n  expect(evidence[0].id).toBeDefined();\n  expect(evidence[0].content).toBeDefined();\n});\n\n// Print Results\nsetTimeout(() => {\n  console.log(\"\\n\" + \"=\".repeat(50));\n  console.log(\"TEST RESULTS\");\n  console.log(\"=\".repeat(50) + \"\\n\");\n\n  const passed = results.filter(r => r.passed).length;\n  const failed = results.filter(r => !r.passed).length;\n\n  results.forEach(r => {\n    const status = r.passed ? \"\\x1b[32mPASS\\x1b[0m\" : \"\\x1b[31mFAIL\\x1b[0m\";\n    console.log(`${status} ${r.name}`);\n    if (r.error) {\n      console.log(`      Error: ${r.error}`);\n    }\n  });\n\n  console.log(\"\\n\" + \"-\".repeat(50));\n  console.log(`Total: ${results.length} | Passed: ${passed} | Failed: ${failed}`);\n  console.log(\"-\".repeat(50) + \"\\n\");\n\n  if (failed > 0) {\n    process.exit(1);\n  }\n}, 100);\n","path":null,"size_bytes":10441,"size_tokens":null},"server/src/reportsV2/prompts/technical.user.md":{"content":"# Technical Report Generation Task\n\nGenerate a technical report based on the following ENO and assessment data.\n\n## ENO (Engagement Narrative Object)\n\n```json\n{{ENO}}\n```\n\n## Raw Assessment Data\n\n```json\n{{INPUT_DATA}}\n```\n\n## Your Task\n\nCreate a detailed technical report that security engineers can use to understand and remediate the identified issues.\n\n## Required Output Structure\n\nGenerate a valid JSON object with:\n\n### reportType\nMust be: `\"technical_v2\"`\n\n### generatedAt\nISO timestamp of generation\n\n### attackNarrativeDetailed (300+ chars)\nFull technical narrative of the attack paths discovered. Include:\n- Initial access methods attempted and successful\n- Privilege escalation techniques\n- Lateral movement possibilities\n- Data access or exfiltration potential\n- Technical specifics (ports, protocols, commands)\n\n### findings\nArray of findings, each with:\n- `id`: Unique identifier\n- `title`: Descriptive title\n- `severity`: \"critical\" | \"high\" | \"medium\" | \"low\" | \"informational\"\n- `description`: What the issue is (50+ chars)\n- `technicalDetails`: Technical specifics of the vulnerability\n- `affectedComponents`: Array of affected components\n- `evidenceReferences`: Array of evidence IDs\n- `cweId`: (optional) CWE ID if applicable\n- `cveId`: (optional) CVE ID if applicable\n- `cvssScore`: (optional) CVSS score if applicable\n\n### attackPathsWithReasoning\nArray of attack paths, each with:\n- `pathId`: Unique identifier\n- `title`: Descriptive title for the attack path\n- `narrative`: Explanation of the attack chain (100+ chars)\n- `steps`: Array of steps, each with order, technique, mitreId (optional), description, prerequisites (optional), outcome\n- `complexity`: \"trivial\" | \"moderate\" | \"complex\" | \"expert\"\n- `timeToCompromise`: Estimated time (e.g., \"2 hours\", \"several days\")\n- `businessImpact`: What this attack path achieves\n- `evidenceReferences`: Array of evidence IDs\n\n### prioritizedFixPlan\nArray of remediation steps, ordered by priority:\n- `priority`: Numeric priority (1 = highest)\n- `findingIds`: Array of finding IDs this addresses\n- `action`: What to do\n- `rationale`: Why this is important (30+ chars)\n- `effort`: \"low\" | \"medium\" | \"high\"\n- `commands`: (optional) Array of specific commands to run\n- `configChanges`: (optional) Configuration changes needed\n- `toolsRequired`: (optional) Array of tools needed\n- `verificationSteps`: Array of steps to verify the fix\n\n### verificationSteps\nArray of verification guidance:\n- `findingId`: Which finding this verifies\n- `steps`: Array of verification steps\n- `expectedResult`: What success looks like\n- `tools`: (optional) Array of tools for verification\n\n### architectureRecommendations (optional)\nArray of architecture improvements:\n- `area`: Security area (e.g., \"Network Segmentation\")\n- `currentState`: Current architecture state\n- `recommendedState`: Target architecture state\n- `rationale`: Why this change is recommended\n- `implementationNotes`: (optional) Implementation guidance\n\n## Quality Requirements\n\n1. Commands should be copy-paste ready\n2. Include specific versions where tools are mentioned\n3. Explain the \"why\" for each remediation step\n4. Verification steps should be actionable\n5. Reference evidence for all claims\n","path":null,"size_bytes":3218,"size_tokens":null},"server/src/reportsV2/prompts/evidence.user.md":{"content":"# Evidence Package Generation Task\n\nGenerate an evidence package based on the following ENO and assessment data.\n\n## ENO (Engagement Narrative Object)\n\n```json\n{{ENO}}\n```\n\n## Raw Assessment Data\n\n```json\n{{INPUT_DATA}}\n```\n\n## Your Task\n\nCreate a forensic-quality evidence package that documents all artifacts and their significance.\n\n## Required Output Structure\n\nGenerate a valid JSON object with:\n\n### reportType\nMust be: `\"evidence_v2\"`\n\n### generatedAt\nISO timestamp of generation\n\n### timelineNarrative (200+ chars)\nChronological story of the assessment:\n- When did testing begin?\n- What sequence of discoveries occurred?\n- How did findings build upon each other?\n- When were critical issues identified?\n\n### timeline\nArray of timeline events:\n- `timestamp`: ISO timestamp\n- `event`: What happened\n- `significance`: Why this matters\n- `artifactIds`: Array of related artifact IDs\n\n### artifactIndex\nCatalog of all evidence artifacts:\n- `id`: Unique artifact identifier\n- `type`: \"http_capture\" | \"log_entry\" | \"screenshot\" | \"config_file\" | \"network_trace\" | \"command_output\" | \"code_snippet\"\n- `title`: Descriptive title\n- `description`: What this artifact shows\n- `timestamp`: (optional) When captured\n- `sourceSystem`: (optional) Where it came from\n- `contentPreview`: (optional) Preview of content\n- `fullContentRef`: (optional) Reference to full content\n- `chainOfCustody`: (optional) Object with collectedAt, collectedBy, hash\n\n### whatEachArtifactProves\nArray mapping artifacts to claims:\n- `artifactId`: Artifact identifier\n- `proves`: Array of claims this artifact supports\n- `relatedFindings`: Array of finding IDs\n- `significance`: \"critical\" | \"supporting\" | \"contextual\"\n\n### evidenceSummary\nStatistics about the evidence:\n- `totalArtifacts`: Count of artifacts\n- `byType`: Object mapping type to count\n- `timespan`: (optional) Object with earliest and latest timestamps\n\n## Evidence Organization Guidelines\n\n### Artifact Types\n\n**http_capture**\n- HTTP requests and responses\n- Include method, URL, headers, body\n- Note authentication tokens (redacted if sensitive)\n\n**log_entry**\n- Application, system, or security logs\n- Include timestamps, source, message\n- Context around the relevant entry\n\n**screenshot**\n- Visual evidence of states or configurations\n- Annotate key elements\n- Include timestamp if relevant\n\n**config_file**\n- Configuration demonstrating vulnerabilities\n- Before/after comparisons\n- Highlight problematic settings\n\n**network_trace**\n- PCAP data or flow information\n- Protocol analysis results\n- Notable traffic patterns\n\n**command_output**\n- Terminal session outputs\n- Tool results (nmap, etc.)\n- Include full command used\n\n**code_snippet**\n- Vulnerable code sections\n- Exploit payloads used\n- Remediation code samples\n\n## Quality Requirements\n\n1. Every artifact should trace to at least one finding\n2. Timestamps should be in ISO 8601 format (UTC)\n3. Sensitive data should be noted for redaction\n4. Chain of custody should be preserved\n5. Organization should support both quick review and detailed analysis\n","path":null,"size_bytes":3050,"size_tokens":null},"server/src/reportsV2/reportInputBuilder.ts":{"content":"/**\n * Report Input Builder\n * \n * Creates the structured input payload for AI-powered report generation.\n * Aggregates evaluation data, findings, attack paths, evidence, risk scores,\n * and customer context into a single canonical object.\n */\n\nimport { z } from \"zod\";\nimport type { Evaluation, Result } from \"@shared/schema\";\n\n// Customer context schema (optional tenant-level data)\nexport const customerContextSchema = z.object({\n  industry: z.string().optional(),\n  primaryDataTypes: z.array(z.enum([\"PII\", \"PCI\", \"PHI\", \"IP\", \"FINANCIAL\", \"CLASSIFIED\"])).optional(),\n  criticalSystems: z.array(z.string()).optional(),\n  riskTolerance: z.enum([\"low\", \"medium\", \"high\"]).optional(),\n  complianceFrameworks: z.array(z.string()).optional(),\n  organizationSize: z.enum([\"small\", \"medium\", \"large\", \"enterprise\"]).optional(),\n});\n\nexport type CustomerContext = z.infer<typeof customerContextSchema>;\n\n// Structured finding for AI input\nexport const reportFindingInputSchema = z.object({\n  id: z.string(),\n  evaluationId: z.string(),\n  assetId: z.string(),\n  assetName: z.string(),\n  title: z.string(),\n  description: z.string(),\n  exposureType: z.string(),\n  severity: z.enum([\"critical\", \"high\", \"medium\", \"low\", \"informational\"]),\n  exploitable: z.boolean(),\n  exploitabilityScore: z.number().min(0).max(100),\n  cvssScore: z.number().min(0).max(10).optional(),\n  cveId: z.string().optional(),\n  affectedComponent: z.string().optional(),\n  affectedVersion: z.string().optional(),\n});\n\nexport type ReportFindingInput = z.infer<typeof reportFindingInputSchema>;\n\n// Attack path for AI input\nexport const attackPathInputSchema = z.object({\n  evaluationId: z.string(),\n  assetId: z.string(),\n  steps: z.array(z.object({\n    order: z.number(),\n    technique: z.string(),\n    mitreId: z.string().optional(),\n    description: z.string(),\n    targetComponent: z.string().optional(),\n  })),\n  complexity: z.number().min(1).max(10),\n  timeToCompromise: z.string().optional(),\n  blastRadius: z.array(z.string()).optional(),\n});\n\nexport type AttackPathInput = z.infer<typeof attackPathInputSchema>;\n\n// Evidence artifact for AI input\nexport const evidenceArtifactInputSchema = z.object({\n  id: z.string(),\n  type: z.enum([\"http_capture\", \"log_entry\", \"screenshot\", \"config_file\", \"network_trace\", \"command_output\", \"code_snippet\"]),\n  description: z.string(),\n  timestamp: z.string().optional(),\n  content: z.string().optional(), // Actual content (may be truncated for large artifacts)\n  contentPreview: z.string().optional(), // Shortened preview\n  findingIds: z.array(z.string()), // Which findings this evidence supports\n});\n\nexport type EvidenceArtifactInput = z.infer<typeof evidenceArtifactInputSchema>;\n\n// Risk score for AI input\nexport const riskScoreInputSchema = z.object({\n  findingId: z.string(),\n  baseScore: z.number(),\n  adjustedScore: z.number(),\n  impactFactor: z.number(),\n  exploitabilityFactor: z.number(),\n  blastRadius: z.string().optional(),\n  financialEstimate: z.string().optional(),\n  rationale: z.string(),\n});\n\nexport type RiskScoreInput = z.infer<typeof riskScoreInputSchema>;\n\n// Compliance mapping for AI input\nexport const complianceMappingInputSchema = z.object({\n  framework: z.string(),\n  controls: z.array(z.object({\n    controlId: z.string(),\n    controlName: z.string(),\n    status: z.enum([\"pass\", \"fail\", \"partial\", \"not_applicable\"]),\n    findingIds: z.array(z.string()),\n    evidenceIds: z.array(z.string()),\n    notes: z.string().optional(),\n  })),\n});\n\nexport type ComplianceMappingInput = z.infer<typeof complianceMappingInputSchema>;\n\n// Full report input payload\nexport const reportInputPayloadSchema = z.object({\n  // Metadata\n  generatedAt: z.string(),\n  reportScopeType: z.enum([\"single_evaluation\", \"multi_evaluation\", \"date_range\"]),\n  \n  // Evaluation metadata\n  evaluationMetadata: z.object({\n    organizationId: z.string(),\n    evaluationIds: z.array(z.string()),\n    dateRange: z.object({\n      from: z.string(),\n      to: z.string(),\n    }).optional(),\n    totalEvaluations: z.number(),\n    completedEvaluations: z.number(),\n  }),\n  \n  // Core data\n  findings: z.array(reportFindingInputSchema),\n  attackPaths: z.array(attackPathInputSchema),\n  evidenceArtifacts: z.array(evidenceArtifactInputSchema),\n  riskScores: z.array(riskScoreInputSchema),\n  \n  // Compliance (optional)\n  complianceMappings: z.array(complianceMappingInputSchema).optional(),\n  \n  // Customer context (optional but recommended)\n  customerContext: customerContextSchema.optional(),\n  \n  // Statistics\n  statistics: z.object({\n    severityDistribution: z.object({\n      critical: z.number(),\n      high: z.number(),\n      medium: z.number(),\n      low: z.number(),\n      informational: z.number(),\n    }),\n    exposureTypeDistribution: z.record(z.string(), z.number()),\n    averageExploitabilityScore: z.number(),\n    averageRiskScore: z.number(),\n    assetsAffected: z.number(),\n    uniqueCVEs: z.number(),\n  }),\n});\n\nexport type ReportInputPayload = z.infer<typeof reportInputPayloadSchema>;\n\n/**\n * Build report input payload from a single evaluation\n */\nexport function buildReportInputFromEvaluation(\n  evaluation: Evaluation,\n  result: Result | null,\n  customerContext?: CustomerContext\n): ReportInputPayload {\n  const now = new Date().toISOString();\n  \n  const findings: ReportFindingInput[] = [];\n  const attackPaths: AttackPathInput[] = [];\n  const evidenceArtifacts: EvidenceArtifactInput[] = [];\n  const riskScores: RiskScoreInput[] = [];\n  \n  // Extract findings from result\n  if (result) {\n    // Main finding from evaluation\n    const mainFindingId = `finding-${evaluation.id}-main`;\n    // Use score field from Result type (maps to exploitability score)\n    const exploitScore = result.score || 0;\n    \n    findings.push({\n      id: mainFindingId,\n      evaluationId: evaluation.id,\n      assetId: evaluation.assetId,\n      assetName: evaluation.assetId, // Could be enriched with asset name lookup\n      title: `${evaluation.exposureType} Vulnerability`,\n      description: evaluation.description || \"\",\n      exposureType: evaluation.exposureType,\n      severity: mapSeverity(exploitScore),\n      exploitable: result.exploitable || false,\n      exploitabilityScore: exploitScore,\n    });\n    \n    // Extract attack path if available\n    if (result.attackPath && Array.isArray(result.attackPath)) {\n      // Extract time to compromise from attack path steps if available\n      const ttcStep = result.attackPath.find((s: any) => s.timeToCompromise);\n      const timeToCompromise = ttcStep?.timeToCompromise || undefined;\n      \n      attackPaths.push({\n        evaluationId: evaluation.id,\n        assetId: evaluation.assetId,\n        steps: result.attackPath.map((step: any, index: number) => ({\n          order: index + 1,\n          technique: step.technique || step.description || \"Unknown\",\n          mitreId: step.mitreId || step.tactic,\n          description: step.description || step.technique || \"\",\n          targetComponent: step.targetComponent,\n        })),\n        complexity: result.attackPath.length,\n        timeToCompromise,\n      });\n    }\n    \n    // Extract evidence artifacts\n    if (result.evidenceArtifacts && Array.isArray(result.evidenceArtifacts)) {\n      result.evidenceArtifacts.forEach((artifact: any, index: number) => {\n        evidenceArtifacts.push({\n          id: `evidence-${evaluation.id}-${index}`,\n          type: artifact.type || \"log_entry\",\n          description: artifact.description || artifact.title || \"Evidence artifact\",\n          timestamp: artifact.timestamp,\n          content: artifact.content,\n          contentPreview: artifact.content?.substring(0, 200),\n          findingIds: [mainFindingId],\n        });\n      });\n    }\n    \n    // Build risk score\n    if (result.intelligentScore) {\n      const scoreData = result.intelligentScore as any;\n      riskScores.push({\n        findingId: mainFindingId,\n        baseScore: scoreData.baseScore || exploitScore,\n        adjustedScore: scoreData.adjustedScore || scoreData.baseScore || exploitScore,\n        impactFactor: scoreData.impactFactor || 1,\n        exploitabilityFactor: scoreData.exploitabilityFactor || 1,\n        blastRadius: scoreData.blastRadius,\n        financialEstimate: scoreData.financialEstimate,\n        rationale: scoreData.rationale || result.impact || \"\",\n      });\n    }\n  }\n  \n  // Calculate statistics\n  const severityDistribution = {\n    critical: findings.filter(f => f.severity === \"critical\").length,\n    high: findings.filter(f => f.severity === \"high\").length,\n    medium: findings.filter(f => f.severity === \"medium\").length,\n    low: findings.filter(f => f.severity === \"low\").length,\n    informational: findings.filter(f => f.severity === \"informational\").length,\n  };\n  \n  const exposureTypeDistribution: Record<string, number> = {};\n  findings.forEach(f => {\n    exposureTypeDistribution[f.exposureType] = (exposureTypeDistribution[f.exposureType] || 0) + 1;\n  });\n  \n  return {\n    generatedAt: now,\n    reportScopeType: \"single_evaluation\",\n    evaluationMetadata: {\n      organizationId: evaluation.organizationId || \"default\",\n      evaluationIds: [evaluation.id],\n      totalEvaluations: 1,\n      completedEvaluations: result ? 1 : 0,\n    },\n    findings,\n    attackPaths,\n    evidenceArtifacts,\n    riskScores,\n    customerContext,\n    statistics: {\n      severityDistribution,\n      exposureTypeDistribution,\n      averageExploitabilityScore: findings.length > 0 \n        ? findings.reduce((sum, f) => sum + f.exploitabilityScore, 0) / findings.length \n        : 0,\n      averageRiskScore: riskScores.length > 0\n        ? riskScores.reduce((sum, r) => sum + r.adjustedScore, 0) / riskScores.length\n        : 0,\n      assetsAffected: new Set(findings.map(f => f.assetId)).size,\n      uniqueCVEs: findings.filter(f => f.cveId).length,\n    },\n  };\n}\n\n/**\n * Build report input payload from multiple evaluations\n */\nexport function buildReportInputFromEvaluations(\n  evaluations: Array<{ evaluation: Evaluation; result: Result | null }>,\n  customerContext?: CustomerContext,\n  dateRange?: { from: Date; to: Date }\n): ReportInputPayload {\n  const now = new Date().toISOString();\n  \n  const allFindings: ReportFindingInput[] = [];\n  const allAttackPaths: AttackPathInput[] = [];\n  const allEvidenceArtifacts: EvidenceArtifactInput[] = [];\n  const allRiskScores: RiskScoreInput[] = [];\n  \n  // Process each evaluation\n  for (const { evaluation, result } of evaluations) {\n    const singleInput = buildReportInputFromEvaluation(evaluation, result, undefined);\n    allFindings.push(...singleInput.findings);\n    allAttackPaths.push(...singleInput.attackPaths);\n    allEvidenceArtifacts.push(...singleInput.evidenceArtifacts);\n    allRiskScores.push(...singleInput.riskScores);\n  }\n  \n  // Calculate aggregated statistics\n  const severityDistribution = {\n    critical: allFindings.filter(f => f.severity === \"critical\").length,\n    high: allFindings.filter(f => f.severity === \"high\").length,\n    medium: allFindings.filter(f => f.severity === \"medium\").length,\n    low: allFindings.filter(f => f.severity === \"low\").length,\n    informational: allFindings.filter(f => f.severity === \"informational\").length,\n  };\n  \n  const exposureTypeDistribution: Record<string, number> = {};\n  allFindings.forEach(f => {\n    exposureTypeDistribution[f.exposureType] = (exposureTypeDistribution[f.exposureType] || 0) + 1;\n  });\n  \n  const organizationId = evaluations[0]?.evaluation.organizationId || \"default\";\n  \n  return {\n    generatedAt: now,\n    reportScopeType: dateRange ? \"date_range\" : \"multi_evaluation\",\n    evaluationMetadata: {\n      organizationId,\n      evaluationIds: evaluations.map(e => e.evaluation.id),\n      dateRange: dateRange ? {\n        from: dateRange.from.toISOString(),\n        to: dateRange.to.toISOString(),\n      } : undefined,\n      totalEvaluations: evaluations.length,\n      completedEvaluations: evaluations.filter(e => e.result).length,\n    },\n    findings: allFindings,\n    attackPaths: allAttackPaths,\n    evidenceArtifacts: allEvidenceArtifacts,\n    riskScores: allRiskScores,\n    customerContext,\n    statistics: {\n      severityDistribution,\n      exposureTypeDistribution,\n      averageExploitabilityScore: allFindings.length > 0 \n        ? allFindings.reduce((sum, f) => sum + f.exploitabilityScore, 0) / allFindings.length \n        : 0,\n      averageRiskScore: allRiskScores.length > 0\n        ? allRiskScores.reduce((sum, r) => sum + r.adjustedScore, 0) / allRiskScores.length\n        : 0,\n      assetsAffected: new Set(allFindings.map(f => f.assetId)).size,\n      uniqueCVEs: allFindings.filter(f => f.cveId).length,\n    },\n  };\n}\n\n/**\n * Map exploitability score to severity level\n */\nfunction mapSeverity(score: number): \"critical\" | \"high\" | \"medium\" | \"low\" | \"informational\" {\n  if (score >= 90) return \"critical\";\n  if (score >= 70) return \"high\";\n  if (score >= 40) return \"medium\";\n  if (score >= 20) return \"low\";\n  return \"informational\";\n}\n\n","path":null,"size_bytes":12951,"size_tokens":null},"server/src/reportsV2/tests/mock-data-factory.ts":{"content":"/**\n * Mock Data Factory\n * \n * Generates test evaluations and results for Report V2 testing.\n * Provides utilities for creating various test scenarios.\n */\n\nimport type { TestEvaluation, TestResult, TestRecommendation, TestEvidence, TestAttackPathStep } from \"./fixtures/test-data.types\";\nimport { randomUUID } from \"crypto\";\n\nexport type ExposureType = \n  | \"sql_injection\"\n  | \"iam_misconfiguration\"\n  | \"business_logic_flaw\"\n  | \"compliance_violation\"\n  | \"rce\"\n  | \"ssrf\"\n  | \"authentication_bypass\"\n  | \"xss\";\n\nexport type Priority = \"critical\" | \"high\" | \"medium\" | \"low\";\n\n/**\n * Generate a random ID with prefix\n */\nfunction generateId(prefix: string): string {\n  return `${prefix}-${randomUUID().slice(0, 8)}`;\n}\n\n/**\n * Create a test evaluation with sensible defaults\n */\nexport function createTestEvaluation(overrides: Partial<TestEvaluation> = {}): TestEvaluation {\n  return {\n    id: generateId(\"eval\"),\n    assetId: generateId(\"asset\"),\n    assetName: \"test-asset.example.com\",\n    assetType: \"web_application\",\n    exposureType: \"sql_injection\",\n    description: \"Test vulnerability for evaluation\",\n    priority: \"high\",\n    status: \"completed\",\n    organizationId: \"test-org\",\n    createdAt: new Date(),\n    updatedAt: new Date(),\n    ...overrides,\n  };\n}\n\n/**\n * Create a test result with sensible defaults\n */\nexport function createTestResult(evaluationId: string, overrides: Partial<TestResult> = {}): TestResult {\n  return {\n    id: generateId(\"result\"),\n    evaluationId,\n    exploitable: true,\n    confidence: 85,\n    score: 80,\n    attackPath: [\n      {\n        id: 1,\n        title: \"Initial Access\",\n        description: \"Exploit vulnerability to gain initial foothold\",\n        technique: \"T1190\",\n        severity: \"high\",\n        order: 1,\n      },\n      {\n        id: 2,\n        title: \"Privilege Escalation\",\n        description: \"Escalate privileges to admin level\",\n        technique: \"T1068\",\n        severity: \"critical\",\n        order: 2,\n      },\n    ],\n    impact: \"Significant security impact with potential data exposure\",\n    recommendations: [\n      {\n        id: generateId(\"rec\"),\n        title: \"Apply security patch\",\n        description: \"Update affected component to latest patched version\",\n        priority: \"critical\",\n        type: \"remediation\",\n        effort: \"medium\",\n        timeline: \"48 hours\",\n      },\n      {\n        id: generateId(\"rec\"),\n        title: \"Enable additional monitoring\",\n        description: \"Configure alerts for suspicious activity patterns\",\n        priority: \"high\",\n        type: \"compensating\",\n        effort: \"low\",\n        timeline: \"24 hours\",\n      },\n    ],\n    evidenceArtifacts: [\n      {\n        id: generateId(\"ev\"),\n        type: \"http_request\",\n        title: \"Exploit Request\",\n        description: \"HTTP request demonstrating the vulnerability\",\n        content: \"GET /api/vulnerable?param=exploit HTTP/1.1\",\n      },\n    ],\n    completedAt: new Date(),\n    ...overrides,\n  };\n}\n\n/**\n * Create a minimal evaluation for quick tests\n */\nexport function createMinimalEvaluation(): TestEvaluation {\n  return createTestEvaluation({\n    description: \"Minimal test case\",\n    priority: \"low\",\n  });\n}\n\n/**\n * Create a critical-priority evaluation\n */\nexport function createCriticalEvaluation(exposureType: ExposureType = \"rce\"): TestEvaluation {\n  return createTestEvaluation({\n    exposureType,\n    priority: \"critical\",\n    description: `Critical ${exposureType} vulnerability requiring immediate attention`,\n  });\n}\n\n/**\n * Create a batch of evaluations for date range testing\n */\nexport function createEvaluationBatch(count: number, options: {\n  organizationId?: string;\n  exposureTypes?: ExposureType[];\n  priorities?: Priority[];\n  startDate?: Date;\n  endDate?: Date;\n} = {}): { evaluations: TestEvaluation[]; results: TestResult[] } {\n  const {\n    organizationId = \"test-org\",\n    exposureTypes = [\"sql_injection\", \"rce\", \"xss\", \"ssrf\"],\n    priorities = [\"critical\", \"high\", \"medium\", \"low\"],\n    startDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // 7 days ago\n    endDate = new Date(),\n  } = options;\n\n  const evaluations: TestEvaluation[] = [];\n  const results: TestResult[] = [];\n\n  const timeRange = endDate.getTime() - startDate.getTime();\n\n  for (let i = 0; i < count; i++) {\n    const createdAt = new Date(startDate.getTime() + (timeRange * i / count));\n    const exposureType = exposureTypes[i % exposureTypes.length];\n    const priority = priorities[i % priorities.length];\n\n    const evaluation = createTestEvaluation({\n      id: `eval-batch-${i.toString().padStart(3, \"0\")}`,\n      assetId: `asset-batch-${i.toString().padStart(3, \"0\")}`,\n      assetName: `batch-asset-${i}.example.com`,\n      exposureType,\n      priority,\n      organizationId,\n      description: `Batch evaluation ${i + 1} of ${count} - ${exposureType} vulnerability`,\n      createdAt,\n      updatedAt: new Date(createdAt.getTime() + 3600000), // 1 hour later\n    });\n\n    const result = createTestResult(evaluation.id, {\n      id: `result-batch-${i.toString().padStart(3, \"0\")}`,\n      confidence: 60 + Math.floor(Math.random() * 40), // 60-100\n      score: 50 + Math.floor(Math.random() * 50), // 50-100\n      completedAt: new Date(createdAt.getTime() + 3600000),\n    });\n\n    evaluations.push(evaluation);\n    results.push(result);\n  }\n\n  return { evaluations, results };\n}\n\n/**\n * Create attack path steps for testing\n */\nexport function createAttackPath(steps: number = 3): TestAttackPathStep[] {\n  const techniques = [\n    { id: \"T1190\", name: \"Exploit Public-Facing Application\" },\n    { id: \"T1068\", name: \"Exploitation for Privilege Escalation\" },\n    { id: \"T1078\", name: \"Valid Accounts\" },\n    { id: \"T1021\", name: \"Remote Services\" },\n    { id: \"T1041\", name: \"Exfiltration Over C2 Channel\" },\n  ];\n\n  const severities: Priority[] = [\"high\", \"critical\", \"high\", \"medium\", \"critical\"];\n\n  return Array.from({ length: steps }, (_, i) => ({\n    id: i + 1,\n    title: `Attack Step ${i + 1}`,\n    description: `Description of attack step ${i + 1}`,\n    technique: techniques[i % techniques.length].id,\n    severity: severities[i % severities.length],\n    order: i + 1,\n    targetAsset: `target-asset-${i + 1}`,\n    tools: [\"tool1\", \"tool2\"],\n  }));\n}\n\n/**\n * Create recommendations for testing\n */\nexport function createRecommendations(count: number = 3): TestRecommendation[] {\n  const types: (\"remediation\" | \"compensating\" | \"preventive\")[] = [\"remediation\", \"compensating\", \"preventive\"];\n  const priorities: Priority[] = [\"critical\", \"high\", \"medium\", \"low\"];\n\n  return Array.from({ length: count }, (_, i) => ({\n    id: generateId(\"rec\"),\n    title: `Recommendation ${i + 1}`,\n    description: `Detailed description of recommendation ${i + 1}`,\n    priority: priorities[i % priorities.length],\n    type: types[i % types.length],\n    effort: ([\"low\", \"medium\", \"high\"] as const)[i % 3],\n    timeline: `${i + 1} weeks`,\n  }));\n}\n\n/**\n * Create evidence artifacts for testing\n */\nexport function createEvidenceArtifacts(count: number = 2): TestEvidence[] {\n  const types = [\"http_request\", \"http_response\", \"log_sample\", \"configuration\", \"screenshot\"];\n\n  return Array.from({ length: count }, (_, i) => ({\n    id: generateId(\"ev\"),\n    type: types[i % types.length],\n    title: `Evidence ${i + 1}`,\n    description: `Description of evidence artifact ${i + 1}`,\n    content: `Sample content for evidence ${i + 1}\\nLine 2\\nLine 3`,\n    timestamp: new Date(),\n  }));\n}\n\n/**\n * Create a complete evaluation with rich data for narrative testing\n */\nexport function createRichEvaluation(exposureType: ExposureType): {\n  evaluation: TestEvaluation;\n  result: TestResult;\n} {\n  const evaluation = createTestEvaluation({\n    exposureType,\n    priority: \"critical\",\n    description: `Comprehensive ${exposureType} vulnerability with full evidence chain and multiple attack paths. Discovered during automated security scanning and validated through manual testing. Requires immediate remediation.`,\n  });\n\n  const result = createTestResult(evaluation.id, {\n    confidence: 95,\n    score: 92,\n    attackPath: createAttackPath(5),\n    recommendations: createRecommendations(5),\n    evidenceArtifacts: createEvidenceArtifacts(4),\n    impact: `Critical security impact from ${exposureType}. Full system compromise possible with significant data exposure risk. Business continuity threatened. Regulatory notification may be required.`,\n  });\n\n  return { evaluation, result };\n}\n","path":null,"size_bytes":8465,"size_tokens":null},"server/src/reportsV2/prompts/complianceAssessor.system.md":{"content":"# Compliance Assessor System Prompt\n\nYou are a compliance specialist with expertise in SOC 2, PCI-DSS, HIPAA, GDPR, ISO 27001, NIST CSF, and other major frameworks. You map security findings to control requirements and explain gaps in operational terms.\n\n## Your Analysis Style\n\n- **Framework-specific control mapping**: \"This violates PCI-DSS 6.2.4\" not \"this is a compliance issue\"\n- **Evidence-based gap assessment**: Link findings to specific failed controls\n- **Audit-ready documentation**: What an auditor needs to see\n- **Remediation prioritized by compliance impact**: What will fail an audit?\n- **Clear pass/fail criteria**: No ambiguity about control status\n\n## What You Always Do\n\n- Cite specific control requirements (e.g., \"SOC 2 CC6.1\")\n- Explain the operational meaning of gaps (what does this control actually require?)\n- Provide evidence collection guidance for remediation\n- Consider audit timeline pressures\n- Map findings to multiple frameworks when applicable\n\n## Framework Expertise\n\n**SOC 2 Type II**\n- Trust Service Criteria (Security, Availability, Processing Integrity, Confidentiality, Privacy)\n- Common Criteria mapping\n- Control testing procedures\n\n**PCI-DSS v4.0**\n- 12 core requirements\n- Compensating controls\n- SAQ vs. ROC considerations\n\n**HIPAA**\n- Administrative, Physical, Technical safeguards\n- Breach notification requirements\n- Business Associate considerations\n\n**GDPR/Privacy**\n- Data subject rights\n- Processing legal bases\n- Cross-border transfer mechanisms\n\n**NIST CSF**\n- Identify, Protect, Detect, Respond, Recover\n- Maturity levels and target profiles\n\n## Practical Approach\n\nYou understand that:\n- Perfect compliance is often impossible - prioritize what matters\n- Controls can have multiple valid implementations\n- Evidence quality matters as much as control implementation\n- Auditors have limited time - make their job easy\n- Compensating controls are legitimate when documented properly\n","path":null,"size_bytes":1939,"size_tokens":null},"shared/vulnerability-catalog.ts":{"content":"import type { ExposureType, BusinessLogicCategory, CloudVectorType } from \"./schema\";\n\nexport interface VulnerabilityInfo {\n  id: ExposureType;\n  name: string;\n  shortName: string;\n  description: string;\n  businessImpact: string;\n  commonCauses: string[];\n  affectedAssets: string[];\n  riskLevel: \"critical\" | \"high\" | \"medium\" | \"low\";\n  mitreTechniques: string[];\n  cweIds: string[];\n}\n\nexport interface RemediationStep {\n  order: number;\n  title: string;\n  description: string;\n  effort: \"low\" | \"medium\" | \"high\";\n  estimatedTime: string;\n  requiredTools?: string[];\n  requiredSkills?: string[];\n  verificationSteps: string[];\n}\n\nexport interface RemediationGuidance {\n  vulnerabilityType: ExposureType;\n  summary: string;\n  immediateActions: string[];\n  shortTermRemediation: RemediationStep[];\n  longTermRemediation: RemediationStep[];\n  compensatingControls: string[];\n  preventionMeasures: string[];\n  references: string[];\n}\n\nexport const vulnerabilityCatalog: Record<ExposureType, VulnerabilityInfo> = {\n  cve: {\n    id: \"cve\",\n    name: \"Common Vulnerabilities and Exposures (CVE)\",\n    shortName: \"CVE Exploitation\",\n    description: \"Known software vulnerabilities cataloged in the CVE database that can be exploited to gain unauthorized access, escalate privileges, or disrupt services.\",\n    businessImpact: \"Exploitation of CVEs can lead to data breaches, system compromise, service disruption, and regulatory violations. Publicly known vulnerabilities are actively targeted by threat actors.\",\n    commonCauses: [\n      \"Outdated software and missing security patches\",\n      \"Delayed patch management processes\",\n      \"Legacy systems no longer receiving updates\",\n      \"Incomplete vulnerability scanning coverage\"\n    ],\n    affectedAssets: [\"Servers\", \"Applications\", \"Network Devices\", \"Operating Systems\", \"Third-party Libraries\"],\n    riskLevel: \"critical\",\n    mitreTechniques: [\"T1190\", \"T1210\", \"T1068\"],\n    cweIds: [\"CWE-20\", \"CWE-119\", \"CWE-89\", \"CWE-79\"]\n  },\n  misconfiguration: {\n    id: \"misconfiguration\",\n    name: \"Security Misconfiguration\",\n    shortName: \"Misconfiguration\",\n    description: \"Improper security settings or configurations that expose systems to unauthorized access or attacks. Includes default credentials, open ports, and insecure permissions.\",\n    businessImpact: \"Misconfigurations are a leading cause of data breaches. They provide easy entry points for attackers and can expose sensitive data, internal systems, or administrative interfaces.\",\n    commonCauses: [\n      \"Default configurations not hardened\",\n      \"Incomplete change management processes\",\n      \"Lack of configuration baselines\",\n      \"Insufficient security reviews during deployment\"\n    ],\n    affectedAssets: [\"Web Servers\", \"Databases\", \"Cloud Services\", \"Firewalls\", \"Application Servers\"],\n    riskLevel: \"high\",\n    mitreTechniques: [\"T1078\", \"T1133\", \"T1098\"],\n    cweIds: [\"CWE-16\", \"CWE-732\", \"CWE-284\"]\n  },\n  behavioral_anomaly: {\n    id: \"behavioral_anomaly\",\n    name: \"Behavioral Anomaly Detection\",\n    shortName: \"Behavioral Anomaly\",\n    description: \"Unusual patterns of activity that deviate from established baselines, potentially indicating insider threats, compromised accounts, or advanced persistent threats.\",\n    businessImpact: \"Behavioral anomalies may indicate active attacks, data exfiltration attempts, or insider threats. Early detection is critical to prevent significant damage.\",\n    commonCauses: [\n      \"Compromised user credentials\",\n      \"Insider threat activity\",\n      \"Advanced persistent threat (APT) operations\",\n      \"Automated malware behavior\"\n    ],\n    affectedAssets: [\"User Accounts\", \"Endpoints\", \"Network Traffic\", \"Application Logs\", \"Data Stores\"],\n    riskLevel: \"high\",\n    mitreTechniques: [\"T1071\", \"T1041\", \"T1567\"],\n    cweIds: [\"CWE-778\", \"CWE-223\"]\n  },\n  network_vulnerability: {\n    id: \"network_vulnerability\",\n    name: \"Network Infrastructure Vulnerability\",\n    shortName: \"Network Vulnerability\",\n    description: \"Weaknesses in network infrastructure including open ports, vulnerable protocols, network segmentation failures, and exposed internal services.\",\n    businessImpact: \"Network vulnerabilities enable attackers to move laterally, access internal systems, intercept sensitive communications, and establish persistent access.\",\n    commonCauses: [\n      \"Inadequate network segmentation\",\n      \"Legacy protocols still in use (Telnet, FTP, SMBv1)\",\n      \"Misconfigured firewalls and access controls\",\n      \"Lack of network monitoring\"\n    ],\n    affectedAssets: [\"Routers\", \"Switches\", \"Firewalls\", \"VPN Gateways\", \"Network Services\"],\n    riskLevel: \"high\",\n    mitreTechniques: [\"T1021\", \"T1046\", \"T1557\"],\n    cweIds: [\"CWE-311\", \"CWE-319\", \"CWE-923\"]\n  },\n  cloud_misconfiguration: {\n    id: \"cloud_misconfiguration\",\n    name: \"Cloud Security Misconfiguration\",\n    shortName: \"Cloud Misconfiguration\",\n    description: \"Insecure configurations in cloud services including public storage buckets, overly permissive IAM policies, and exposed cloud resources across AWS, Azure, and GCP.\",\n    businessImpact: \"Cloud misconfigurations are responsible for many high-profile data breaches. They can expose customer data, intellectual property, and provide pathways for account takeover.\",\n    commonCauses: [\n      \"Default cloud service configurations\",\n      \"Overly permissive resource policies\",\n      \"Lack of cloud security expertise\",\n      \"Rapid cloud adoption without security review\"\n    ],\n    affectedAssets: [\"S3 Buckets\", \"Azure Blob Storage\", \"GCP Storage\", \"Cloud Functions\", \"Container Registries\"],\n    riskLevel: \"critical\",\n    mitreTechniques: [\"T1530\", \"T1619\", \"T1078.004\"],\n    cweIds: [\"CWE-284\", \"CWE-732\", \"CWE-693\"]\n  },\n  iam_abuse: {\n    id: \"iam_abuse\",\n    name: \"Identity and Access Management (IAM) Abuse\",\n    shortName: \"IAM Abuse\",\n    description: \"Exploitation of overly permissive or misconfigured identity and access management policies to escalate privileges, access unauthorized resources, or maintain persistence.\",\n    businessImpact: \"IAM abuse can lead to complete environment takeover, data exfiltration, and persistent backdoor access. Attackers with elevated privileges can cause widespread damage.\",\n    commonCauses: [\n      \"Overly permissive IAM policies\",\n      \"Lack of least privilege enforcement\",\n      \"Service accounts with excessive permissions\",\n      \"Inadequate IAM policy reviews\"\n    ],\n    affectedAssets: [\"IAM Roles\", \"Service Accounts\", \"API Keys\", \"Access Policies\", \"Identity Providers\"],\n    riskLevel: \"critical\",\n    mitreTechniques: [\"T1098\", \"T1078\", \"T1136\"],\n    cweIds: [\"CWE-269\", \"CWE-266\", \"CWE-250\"]\n  },\n  saas_permission: {\n    id: \"saas_permission\",\n    name: \"SaaS Permission Abuse\",\n    shortName: \"SaaS Permission Abuse\",\n    description: \"Exploitation of overly permissive or misconfigured permissions in SaaS applications to access sensitive data, impersonate users, or perform unauthorized actions.\",\n    businessImpact: \"SaaS permission abuse can lead to data breaches, compliance violations, and unauthorized access to business-critical applications and data.\",\n    commonCauses: [\n      \"Default sharing settings too permissive\",\n      \"OAuth app grants excessive scopes\",\n      \"Lack of periodic access reviews\",\n      \"Shadow IT and unmanaged SaaS adoption\"\n    ],\n    affectedAssets: [\"SaaS Applications\", \"OAuth Integrations\", \"Shared Documents\", \"Collaboration Tools\"],\n    riskLevel: \"high\",\n    mitreTechniques: [\"T1552\", \"T1550\", \"T1528\"],\n    cweIds: [\"CWE-732\", \"CWE-862\", \"CWE-863\"]\n  },\n  shadow_admin: {\n    id: \"shadow_admin\",\n    name: \"Shadow Administrator Discovery\",\n    shortName: \"Shadow Admin\",\n    description: \"Identification of accounts with effective administrative privileges that are not officially designated as admin accounts, creating hidden attack paths.\",\n    businessImpact: \"Shadow admins provide attackers with administrative access without triggering alerts on known admin accounts. They bypass security monitoring and can cause significant damage.\",\n    commonCauses: [\n      \"Permission creep over time\",\n      \"Delegated admin permissions not tracked\",\n      \"Complex role inheritance structures\",\n      \"Lack of regular permission audits\"\n    ],\n    affectedAssets: [\"Active Directory\", \"Cloud IAM\", \"Application Admin Panels\", \"Service Accounts\"],\n    riskLevel: \"high\",\n    mitreTechniques: [\"T1078.002\", \"T1098.001\", \"T1087\"],\n    cweIds: [\"CWE-269\", \"CWE-266\", \"CWE-250\"]\n  },\n  api_sequence_abuse: {\n    id: \"api_sequence_abuse\",\n    name: \"API Sequence and Workflow Abuse\",\n    shortName: \"API Sequence Abuse\",\n    description: \"Exploitation of improper API workflow enforcement allowing attackers to bypass intended sequences, skip validation steps, or manipulate business logic through API calls.\",\n    businessImpact: \"API sequence abuse can lead to financial fraud, unauthorized actions, data manipulation, and bypass of critical business controls.\",\n    commonCauses: [\n      \"Client-side workflow enforcement only\",\n      \"Missing server-side state validation\",\n      \"Incomplete API authorization checks\",\n      \"Lack of rate limiting and abuse detection\"\n    ],\n    affectedAssets: [\"REST APIs\", \"GraphQL Endpoints\", \"Microservices\", \"Payment APIs\", \"User Management APIs\"],\n    riskLevel: \"high\",\n    mitreTechniques: [\"T1059.009\", \"T1106\"],\n    cweIds: [\"CWE-841\", \"CWE-940\", \"CWE-799\"]\n  },\n  payment_flow: {\n    id: \"payment_flow\",\n    name: \"Payment Flow Vulnerability\",\n    shortName: \"Payment Flow Vulnerability\",\n    description: \"Weaknesses in payment processing workflows that allow price manipulation, payment bypass, or fraudulent transactions.\",\n    businessImpact: \"Payment flow vulnerabilities directly impact revenue through fraud, chargebacks, and financial losses. They can also damage customer trust and lead to regulatory penalties.\",\n    commonCauses: [\n      \"Client-side price calculations\",\n      \"Missing payment verification steps\",\n      \"Race conditions in payment processing\",\n      \"Inadequate fraud detection\"\n    ],\n    affectedAssets: [\"Payment Gateways\", \"E-commerce Platforms\", \"Subscription Systems\", \"Invoicing Systems\"],\n    riskLevel: \"critical\",\n    mitreTechniques: [\"T1565\", \"T1657\"],\n    cweIds: [\"CWE-602\", \"CWE-841\", \"CWE-20\"]\n  },\n  subscription_bypass: {\n    id: \"subscription_bypass\",\n    name: \"Subscription and Billing Bypass\",\n    shortName: \"Subscription Bypass\",\n    description: \"Techniques to circumvent subscription controls, extend trial periods, access premium features without payment, or manipulate billing processes.\",\n    businessImpact: \"Subscription bypass directly impacts revenue and can lead to significant financial losses if widely exploited. It also creates unfair advantage for abusers.\",\n    commonCauses: [\n      \"Trial period checks done client-side\",\n      \"Feature flags accessible to users\",\n      \"Weak subscription state validation\",\n      \"Billing race conditions\"\n    ],\n    affectedAssets: [\"SaaS Platforms\", \"Subscription Management\", \"License Servers\", \"Feature Flag Systems\"],\n    riskLevel: \"high\",\n    mitreTechniques: [\"T1565\", \"T1657\"],\n    cweIds: [\"CWE-602\", \"CWE-841\", \"CWE-639\"]\n  },\n  state_machine: {\n    id: \"state_machine\",\n    name: \"State Machine Violation\",\n    shortName: \"State Machine Violation\",\n    description: \"Exploitation of improper state transition enforcement allowing invalid state jumps, bypassing required steps, or reaching unauthorized states.\",\n    businessImpact: \"State machine violations can lead to business logic bypass, unauthorized actions, and data corruption. They often result in financial losses or compliance violations.\",\n    commonCauses: [\n      \"Incomplete state transition validation\",\n      \"Direct database state manipulation\",\n      \"Missing state history tracking\",\n      \"Race conditions in state updates\"\n    ],\n    affectedAssets: [\"Order Management\", \"Workflow Engines\", \"Approval Systems\", \"Document Management\"],\n    riskLevel: \"medium\",\n    mitreTechniques: [\"T1565\", \"T1485\"],\n    cweIds: [\"CWE-841\", \"CWE-372\", \"CWE-362\"]\n  },\n  privilege_boundary: {\n    id: \"privilege_boundary\",\n    name: \"Privilege Boundary Violation\",\n    shortName: \"Privilege Boundary Violation\",\n    description: \"Attacks that cross defined privilege boundaries to access resources or perform actions beyond authorized scope, including horizontal and vertical privilege escalation.\",\n    businessImpact: \"Privilege boundary violations enable attackers to access sensitive data, administrative functions, or other users' resources, leading to data breaches and system compromise.\",\n    commonCauses: [\n      \"Inconsistent authorization checks\",\n      \"IDOR vulnerabilities\",\n      \"Role hierarchy bypass\",\n      \"Tenant isolation failures\"\n    ],\n    affectedAssets: [\"Multi-tenant Applications\", \"User Management\", \"Admin Panels\", \"API Gateways\"],\n    riskLevel: \"critical\",\n    mitreTechniques: [\"T1068\", \"T1548\", \"T1574\"],\n    cweIds: [\"CWE-269\", \"CWE-639\", \"CWE-863\"]\n  },\n  workflow_desync: {\n    id: \"workflow_desync\",\n    name: \"Workflow Desynchronization\",\n    shortName: \"Workflow Desync\",\n    description: \"Inconsistencies between different system components' view of workflow state, enabling exploitation of timing windows or state discrepancies.\",\n    businessImpact: \"Workflow desync can lead to duplicate transactions, resource exhaustion, unauthorized actions during transition windows, and data inconsistency.\",\n    commonCauses: [\n      \"Distributed system eventual consistency\",\n      \"Missing distributed transactions\",\n      \"Cache and database desync\",\n      \"Asynchronous processing gaps\"\n    ],\n    affectedAssets: [\"Microservices\", \"Event-driven Systems\", \"Distributed Databases\", \"Message Queues\"],\n    riskLevel: \"medium\",\n    mitreTechniques: [\"T1565\", \"T1499\"],\n    cweIds: [\"CWE-362\", \"CWE-367\", \"CWE-662\"]\n  },\n  order_lifecycle: {\n    id: \"order_lifecycle\",\n    name: \"Order Lifecycle Abuse\",\n    shortName: \"Order Lifecycle Abuse\",\n    description: \"Exploitation of order processing workflows including cancellation abuse, refund fraud, status manipulation, and fulfillment bypass.\",\n    businessImpact: \"Order lifecycle abuse leads to direct financial losses through fraud, inventory discrepancies, and customer disputes. It can significantly impact e-commerce profitability.\",\n    commonCauses: [\n      \"Weak order state validation\",\n      \"Missing fulfillment checks before refunds\",\n      \"Race conditions in order updates\",\n      \"Inadequate order history verification\"\n    ],\n    affectedAssets: [\"E-commerce Platforms\", \"Order Management Systems\", \"Fulfillment Systems\", \"Refund Processing\"],\n    riskLevel: \"high\",\n    mitreTechniques: [\"T1565\", \"T1657\"],\n    cweIds: [\"CWE-841\", \"CWE-639\", \"CWE-362\"]\n  }\n};\n\nexport const remediationGuidanceTemplates: Record<ExposureType, RemediationGuidance> = {\n  cve: {\n    vulnerabilityType: \"cve\",\n    summary: \"Remediate known CVE vulnerabilities through systematic patch management and compensating controls.\",\n    immediateActions: [\n      \"Identify all systems affected by the CVE\",\n      \"Assess current exploitation activity and threat intelligence\",\n      \"Implement temporary network isolation for critical vulnerable systems\",\n      \"Apply available vendor patches in test environment\"\n    ],\n    shortTermRemediation: [\n      {\n        order: 1,\n        title: \"Patch Deployment\",\n        description: \"Deploy vendor-provided security patches to affected systems following change management procedures.\",\n        effort: \"medium\",\n        estimatedTime: \"4-8 hours\",\n        requiredTools: [\"Patch management system\", \"Change management platform\"],\n        requiredSkills: [\"System administration\", \"Change management\"],\n        verificationSteps: [\n          \"Verify patch installation via system inventory\",\n          \"Run vulnerability scanner to confirm remediation\",\n          \"Monitor system stability post-patch\"\n        ]\n      },\n      {\n        order: 2,\n        title: \"Configuration Hardening\",\n        description: \"Apply additional configuration hardening to reduce attack surface and limit exploitation potential.\",\n        effort: \"low\",\n        estimatedTime: \"2-4 hours\",\n        requiredTools: [\"Configuration management\", \"Security baselines\"],\n        requiredSkills: [\"System hardening\", \"Security configuration\"],\n        verificationSteps: [\n          \"Validate configuration against security baseline\",\n          \"Test application functionality post-hardening\",\n          \"Document configuration changes\"\n        ]\n      }\n    ],\n    longTermRemediation: [\n      {\n        order: 1,\n        title: \"Vulnerability Management Program Enhancement\",\n        description: \"Improve vulnerability scanning coverage, frequency, and remediation tracking to prevent future occurrences.\",\n        effort: \"high\",\n        estimatedTime: \"2-4 weeks\",\n        requiredTools: [\"Vulnerability scanner\", \"SIEM\", \"Ticketing system\"],\n        requiredSkills: [\"Vulnerability management\", \"Process improvement\"],\n        verificationSteps: [\n          \"Establish SLAs for vulnerability remediation by severity\",\n          \"Implement automated scanning schedules\",\n          \"Create executive reporting dashboards\"\n        ]\n      }\n    ],\n    compensatingControls: [\n      \"Implement web application firewall (WAF) rules to block exploitation attempts\",\n      \"Enable intrusion detection/prevention system (IDS/IPS) signatures\",\n      \"Increase monitoring and alerting for affected systems\",\n      \"Restrict network access to vulnerable systems\"\n    ],\n    preventionMeasures: [\n      \"Implement automated patch management with defined SLAs\",\n      \"Subscribe to vendor security advisories\",\n      \"Conduct regular vulnerability assessments\",\n      \"Maintain software inventory for rapid impact assessment\"\n    ],\n    references: [\n      \"https://nvd.nist.gov/\",\n      \"https://cve.mitre.org/\",\n      \"NIST SP 800-40 Guide to Enterprise Patch Management\"\n    ]\n  },\n  misconfiguration: {\n    vulnerabilityType: \"misconfiguration\",\n    summary: \"Address security misconfigurations through configuration baseline enforcement and security hardening.\",\n    immediateActions: [\n      \"Document current configuration state\",\n      \"Identify exposure level and potential impact\",\n      \"Apply immediate configuration changes for critical issues\",\n      \"Enable additional logging for affected systems\"\n    ],\n    shortTermRemediation: [\n      {\n        order: 1,\n        title: \"Configuration Correction\",\n        description: \"Apply correct security configurations based on vendor recommendations and security baselines.\",\n        effort: \"low\",\n        estimatedTime: \"2-4 hours\",\n        requiredTools: [\"Configuration management\", \"Security baseline documentation\"],\n        requiredSkills: [\"System administration\", \"Security configuration\"],\n        verificationSteps: [\n          \"Verify configuration changes are applied\",\n          \"Test system functionality\",\n          \"Run security scan to confirm remediation\"\n        ]\n      },\n      {\n        order: 2,\n        title: \"Access Control Review\",\n        description: \"Review and tighten access controls to limit exposure from misconfigured services.\",\n        effort: \"medium\",\n        estimatedTime: \"4-8 hours\",\n        requiredTools: [\"Identity management\", \"Access control lists\"],\n        requiredSkills: [\"Access management\", \"Security architecture\"],\n        verificationSteps: [\n          \"Document access control changes\",\n          \"Validate least privilege enforcement\",\n          \"Test user access scenarios\"\n        ]\n      }\n    ],\n    longTermRemediation: [\n      {\n        order: 1,\n        title: \"Configuration Management Automation\",\n        description: \"Implement infrastructure-as-code and automated configuration management to prevent drift.\",\n        effort: \"high\",\n        estimatedTime: \"4-8 weeks\",\n        requiredTools: [\"Ansible/Chef/Puppet\", \"Git\", \"CI/CD pipeline\"],\n        requiredSkills: [\"Infrastructure automation\", \"DevSecOps\"],\n        verificationSteps: [\n          \"All configurations managed in version control\",\n          \"Automated compliance scanning implemented\",\n          \"Configuration drift detection enabled\"\n        ]\n      }\n    ],\n    compensatingControls: [\n      \"Implement network segmentation to limit exposure\",\n      \"Enable enhanced monitoring for misconfigured services\",\n      \"Deploy additional authentication requirements\",\n      \"Implement rate limiting and abuse prevention\"\n    ],\n    preventionMeasures: [\n      \"Establish security configuration baselines\",\n      \"Implement automated configuration scanning\",\n      \"Require security review for configuration changes\",\n      \"Use infrastructure-as-code with security policies\"\n    ],\n    references: [\n      \"CIS Benchmarks - https://www.cisecurity.org/cis-benchmarks/\",\n      \"OWASP Security Misconfiguration\",\n      \"NIST SP 800-123 Guide to General Server Security\"\n    ]\n  },\n  behavioral_anomaly: {\n    vulnerabilityType: \"behavioral_anomaly\",\n    summary: \"Investigate and respond to behavioral anomalies indicating potential compromise or insider threat.\",\n    immediateActions: [\n      \"Preserve logs and forensic evidence\",\n      \"Assess scope of anomalous activity\",\n      \"Consider account suspension for high-risk anomalies\",\n      \"Engage incident response team if compromise suspected\"\n    ],\n    shortTermRemediation: [\n      {\n        order: 1,\n        title: \"Investigation and Containment\",\n        description: \"Conduct thorough investigation of anomalous behavior and contain any identified threats.\",\n        effort: \"high\",\n        estimatedTime: \"8-24 hours\",\n        requiredTools: [\"SIEM\", \"EDR\", \"Forensic tools\"],\n        requiredSkills: [\"Incident response\", \"Digital forensics\"],\n        verificationSteps: [\n          \"Document investigation findings\",\n          \"Identify root cause of anomaly\",\n          \"Confirm threat containment\"\n        ]\n      },\n      {\n        order: 2,\n        title: \"Credential Reset and Access Review\",\n        description: \"Reset credentials for affected accounts and review access permissions.\",\n        effort: \"medium\",\n        estimatedTime: \"4-8 hours\",\n        requiredTools: [\"Identity management\", \"Password manager\"],\n        requiredSkills: [\"Identity management\", \"Security operations\"],\n        verificationSteps: [\n          \"All affected credentials rotated\",\n          \"MFA enforcement verified\",\n          \"Access logs reviewed for persistence\"\n        ]\n      }\n    ],\n    longTermRemediation: [\n      {\n        order: 1,\n        title: \"User Behavior Analytics Enhancement\",\n        description: \"Improve behavioral baseline accuracy and anomaly detection capabilities.\",\n        effort: \"high\",\n        estimatedTime: \"4-8 weeks\",\n        requiredTools: [\"UEBA platform\", \"SIEM\", \"Machine learning models\"],\n        requiredSkills: [\"Security analytics\", \"Data science\"],\n        verificationSteps: [\n          \"Reduced false positive rate\",\n          \"Improved detection accuracy\",\n          \"Automated response playbooks created\"\n        ]\n      }\n    ],\n    compensatingControls: [\n      \"Enable additional authentication factors\",\n      \"Implement session monitoring\",\n      \"Deploy data loss prevention controls\",\n      \"Increase logging verbosity\"\n    ],\n    preventionMeasures: [\n      \"Implement user behavior analytics (UEBA)\",\n      \"Establish normal behavior baselines\",\n      \"Enable continuous access monitoring\",\n      \"Conduct regular access reviews\"\n    ],\n    references: [\n      \"MITRE ATT&CK Framework\",\n      \"NIST SP 800-61 Computer Security Incident Handling Guide\",\n      \"Insider Threat Program Guidance\"\n    ]\n  },\n  network_vulnerability: {\n    vulnerabilityType: \"network_vulnerability\",\n    summary: \"Address network infrastructure vulnerabilities through segmentation, patching, and access controls.\",\n    immediateActions: [\n      \"Close unnecessary open ports\",\n      \"Disable vulnerable protocols\",\n      \"Implement network access controls\",\n      \"Enable network monitoring for affected segments\"\n    ],\n    shortTermRemediation: [\n      {\n        order: 1,\n        title: \"Network Hardening\",\n        description: \"Apply network hardening measures including port closure, protocol upgrades, and ACL implementation.\",\n        effort: \"medium\",\n        estimatedTime: \"4-8 hours\",\n        requiredTools: [\"Network management\", \"Firewall management\"],\n        requiredSkills: [\"Network administration\", \"Security engineering\"],\n        verificationSteps: [\n          \"Port scan confirms closure\",\n          \"Protocol analysis shows secure versions\",\n          \"ACLs validated and tested\"\n        ]\n      }\n    ],\n    longTermRemediation: [\n      {\n        order: 1,\n        title: \"Network Segmentation\",\n        description: \"Implement proper network segmentation to limit lateral movement and contain potential breaches.\",\n        effort: \"high\",\n        estimatedTime: \"4-12 weeks\",\n        requiredTools: [\"Firewall\", \"SDN\", \"VLAN management\"],\n        requiredSkills: [\"Network architecture\", \"Security design\"],\n        verificationSteps: [\n          \"Segment boundaries tested and verified\",\n          \"Lateral movement paths eliminated\",\n          \"Network diagram updated\"\n        ]\n      }\n    ],\n    compensatingControls: [\n      \"Deploy network intrusion detection\",\n      \"Implement network access control (NAC)\",\n      \"Enable east-west traffic monitoring\",\n      \"Deploy micro-segmentation where possible\"\n    ],\n    preventionMeasures: [\n      \"Regular network vulnerability scanning\",\n      \"Automated network device patching\",\n      \"Network change management procedures\",\n      \"Continuous network monitoring\"\n    ],\n    references: [\n      \"CIS Network Device Benchmarks\",\n      \"NIST SP 800-115 Technical Guide to Information Security Testing\",\n      \"Zero Trust Network Architecture Guidelines\"\n    ]\n  },\n  cloud_misconfiguration: {\n    vulnerabilityType: \"cloud_misconfiguration\",\n    summary: \"Remediate cloud security misconfigurations to protect data and prevent unauthorized access.\",\n    immediateActions: [\n      \"Restrict public access to exposed resources\",\n      \"Review and tighten IAM policies\",\n      \"Enable cloud provider security services\",\n      \"Audit recent access to affected resources\"\n    ],\n    shortTermRemediation: [\n      {\n        order: 1,\n        title: \"Access Control Remediation\",\n        description: \"Apply proper access controls to cloud resources including bucket policies, IAM, and network rules.\",\n        effort: \"low\",\n        estimatedTime: \"2-4 hours\",\n        requiredTools: [\"Cloud console/CLI\", \"IaC tools\"],\n        requiredSkills: [\"Cloud administration\", \"IAM management\"],\n        verificationSteps: [\n          \"Public access blocked\",\n          \"IAM policies follow least privilege\",\n          \"Security groups properly configured\"\n        ]\n      },\n      {\n        order: 2,\n        title: \"Encryption and Logging\",\n        description: \"Enable encryption for data at rest and in transit, and ensure comprehensive logging.\",\n        effort: \"medium\",\n        estimatedTime: \"4-8 hours\",\n        requiredTools: [\"Cloud KMS\", \"Cloud logging services\"],\n        requiredSkills: [\"Cloud security\", \"Encryption management\"],\n        verificationSteps: [\n          \"Encryption enabled for all storage\",\n          \"CloudTrail/Activity logs enabled\",\n          \"Log forwarding to SIEM configured\"\n        ]\n      }\n    ],\n    longTermRemediation: [\n      {\n        order: 1,\n        title: \"Cloud Security Posture Management\",\n        description: \"Implement CSPM solution for continuous cloud configuration monitoring and compliance.\",\n        effort: \"high\",\n        estimatedTime: \"4-8 weeks\",\n        requiredTools: [\"CSPM platform\", \"Cloud security tools\"],\n        requiredSkills: [\"Cloud security architecture\", \"Compliance\"],\n        verificationSteps: [\n          \"CSPM fully deployed and configured\",\n          \"Automated remediation for critical findings\",\n          \"Compliance dashboards operational\"\n        ]\n      }\n    ],\n    compensatingControls: [\n      \"Enable cloud-native threat detection (GuardDuty, Security Center)\",\n      \"Implement additional network controls\",\n      \"Enable data loss prevention\",\n      \"Deploy cloud workload protection\"\n    ],\n    preventionMeasures: [\n      \"Use infrastructure-as-code with security policies\",\n      \"Implement cloud security guardrails\",\n      \"Require security review for cloud deployments\",\n      \"Regular cloud security assessments\"\n    ],\n    references: [\n      \"CIS Cloud Benchmarks\",\n      \"Cloud Security Alliance Guidelines\",\n      \"AWS/Azure/GCP Security Best Practices\"\n    ]\n  },\n  iam_abuse: {\n    vulnerabilityType: \"iam_abuse\",\n    summary: \"Address IAM security issues through policy refinement, least privilege enforcement, and access monitoring.\",\n    immediateActions: [\n      \"Review and revoke excessive permissions\",\n      \"Rotate compromised credentials\",\n      \"Enable IAM access logging\",\n      \"Identify and document privilege escalation paths\"\n    ],\n    shortTermRemediation: [\n      {\n        order: 1,\n        title: \"IAM Policy Remediation\",\n        description: \"Revise IAM policies to enforce least privilege and remove dangerous permissions.\",\n        effort: \"medium\",\n        estimatedTime: \"4-8 hours\",\n        requiredTools: [\"IAM analysis tools\", \"Policy simulator\"],\n        requiredSkills: [\"IAM administration\", \"Security policy design\"],\n        verificationSteps: [\n          \"All wildcard permissions removed or justified\",\n          \"Service accounts use minimal permissions\",\n          \"Policy simulator confirms intended access\"\n        ]\n      },\n      {\n        order: 2,\n        title: \"Access Review and Cleanup\",\n        description: \"Conduct thorough access review and remove unused roles, users, and permissions.\",\n        effort: \"medium\",\n        estimatedTime: \"8-16 hours\",\n        requiredTools: [\"Identity governance\", \"Access analytics\"],\n        requiredSkills: [\"Identity management\", \"Access governance\"],\n        verificationSteps: [\n          \"Unused accounts disabled\",\n          \"Stale permissions removed\",\n          \"Access certification completed\"\n        ]\n      }\n    ],\n    longTermRemediation: [\n      {\n        order: 1,\n        title: \"IAM Governance Program\",\n        description: \"Implement comprehensive IAM governance with regular reviews, automation, and monitoring.\",\n        effort: \"high\",\n        estimatedTime: \"8-12 weeks\",\n        requiredTools: [\"IGA platform\", \"PAM solution\", \"SIEM\"],\n        requiredSkills: [\"Identity governance\", \"Security architecture\"],\n        verificationSteps: [\n          \"Regular access certification process established\",\n          \"Automated provisioning/deprovisioning\",\n          \"Privileged access monitoring enabled\"\n        ]\n      }\n    ],\n    compensatingControls: [\n      \"Implement privileged access management (PAM)\",\n      \"Enable just-in-time access\",\n      \"Deploy session recording for privileged access\",\n      \"Implement break-glass procedures\"\n    ],\n    preventionMeasures: [\n      \"Use permission boundaries\",\n      \"Implement least privilege by default\",\n      \"Regular IAM security assessments\",\n      \"Automated IAM policy analysis\"\n    ],\n    references: [\n      \"NIST SP 800-53 AC Controls\",\n      \"Cloud IAM Security Best Practices\",\n      \"MITRE ATT&CK Privilege Escalation Techniques\"\n    ]\n  },\n  saas_permission: {\n    vulnerabilityType: \"saas_permission\",\n    summary: \"Address SaaS permission issues through access review, OAuth management, and sharing controls.\",\n    immediateActions: [\n      \"Review and revoke excessive OAuth grants\",\n      \"Audit externally shared documents\",\n      \"Disable unused SaaS integrations\",\n      \"Implement conditional access policies\"\n    ],\n    shortTermRemediation: [\n      {\n        order: 1,\n        title: \"OAuth and Integration Cleanup\",\n        description: \"Review and remove unnecessary OAuth applications and third-party integrations.\",\n        effort: \"medium\",\n        estimatedTime: \"4-8 hours\",\n        requiredTools: [\"SaaS security platform\", \"OAuth management\"],\n        requiredSkills: [\"SaaS administration\", \"Security operations\"],\n        verificationSteps: [\n          \"Risky OAuth apps removed\",\n          \"Integration permissions minimized\",\n          \"User consent policies updated\"\n        ]\n      }\n    ],\n    longTermRemediation: [\n      {\n        order: 1,\n        title: \"SaaS Security Posture Management\",\n        description: \"Implement SSPM for continuous SaaS security monitoring and configuration management.\",\n        effort: \"high\",\n        estimatedTime: \"4-8 weeks\",\n        requiredTools: [\"SSPM platform\", \"CASB\"],\n        requiredSkills: [\"SaaS security\", \"Cloud architecture\"],\n        verificationSteps: [\n          \"SSPM deployed for all critical SaaS\",\n          \"Automated policy enforcement\",\n          \"Shadow IT discovery enabled\"\n        ]\n      }\n    ],\n    compensatingControls: [\n      \"Deploy CASB for visibility and control\",\n      \"Implement DLP for sensitive data\",\n      \"Enable session controls\",\n      \"Require approval for OAuth grants\"\n    ],\n    preventionMeasures: [\n      \"Implement SaaS security baselines\",\n      \"Regular SaaS security assessments\",\n      \"User training on secure sharing\",\n      \"OAuth app approval workflows\"\n    ],\n    references: [\n      \"CSA SaaS Governance Best Practices\",\n      \"OAuth Security Best Practices\",\n      \"CIS Controls for SaaS\"\n    ]\n  },\n  shadow_admin: {\n    vulnerabilityType: \"shadow_admin\",\n    summary: \"Identify and remediate shadow administrator accounts to improve access visibility and control.\",\n    immediateActions: [\n      \"Document all identified shadow admin accounts\",\n      \"Assess risk level of each shadow admin path\",\n      \"Implement additional monitoring for shadow admins\",\n      \"Begin access normalization planning\"\n    ],\n    shortTermRemediation: [\n      {\n        order: 1,\n        title: \"Permission Normalization\",\n        description: \"Convert shadow admin permissions to appropriate role-based access or remove unnecessary privileges.\",\n        effort: \"medium\",\n        estimatedTime: \"8-16 hours\",\n        requiredTools: [\"Identity management\", \"Access analytics\"],\n        requiredSkills: [\"Identity governance\", \"Access management\"],\n        verificationSteps: [\n          \"Shadow admin paths eliminated\",\n          \"Proper admin roles assigned where needed\",\n          \"Permission changes documented\"\n        ]\n      }\n    ],\n    longTermRemediation: [\n      {\n        order: 1,\n        title: \"Continuous Admin Discovery\",\n        description: \"Implement ongoing monitoring to detect new shadow admin paths as they emerge.\",\n        effort: \"high\",\n        estimatedTime: \"4-8 weeks\",\n        requiredTools: [\"Identity analytics\", \"Graph-based analysis\"],\n        requiredSkills: [\"Identity security\", \"Data analytics\"],\n        verificationSteps: [\n          \"Automated shadow admin detection\",\n          \"Alerting on new admin paths\",\n          \"Regular admin access reports\"\n        ]\n      }\n    ],\n    compensatingControls: [\n      \"Implement privileged access management\",\n      \"Enable admin session recording\",\n      \"Require MFA for all admin functions\",\n      \"Deploy admin action monitoring\"\n    ],\n    preventionMeasures: [\n      \"Implement role-based access control\",\n      \"Regular permission audits\",\n      \"Limit delegation capabilities\",\n      \"Use permission boundaries\"\n    ],\n    references: [\n      \"Microsoft Security Best Practices\",\n      \"Identity and Access Management Framework\",\n      \"Privileged Access Management Guidelines\"\n    ]\n  },\n  api_sequence_abuse: {\n    vulnerabilityType: \"api_sequence_abuse\",\n    summary: \"Address API workflow vulnerabilities through proper sequence enforcement and validation.\",\n    immediateActions: [\n      \"Identify affected API endpoints\",\n      \"Implement rate limiting on vulnerable endpoints\",\n      \"Add logging for sequence violation attempts\",\n      \"Review recent API access logs for exploitation\"\n    ],\n    shortTermRemediation: [\n      {\n        order: 1,\n        title: \"Server-Side Workflow Enforcement\",\n        description: \"Implement proper server-side validation of API call sequences and state transitions.\",\n        effort: \"medium\",\n        estimatedTime: \"8-16 hours\",\n        requiredTools: [\"API development tools\", \"State management\"],\n        requiredSkills: [\"API development\", \"Security engineering\"],\n        verificationSteps: [\n          \"Sequence validation implemented\",\n          \"Invalid sequences properly rejected\",\n          \"Error handling doesn't leak information\"\n        ]\n      }\n    ],\n    longTermRemediation: [\n      {\n        order: 1,\n        title: \"API Security Architecture\",\n        description: \"Implement comprehensive API security including gateway controls, schema validation, and behavioral analysis.\",\n        effort: \"high\",\n        estimatedTime: \"4-8 weeks\",\n        requiredTools: [\"API gateway\", \"Schema validation\", \"API security platform\"],\n        requiredSkills: [\"API architecture\", \"Security engineering\"],\n        verificationSteps: [\n          \"API gateway with security controls deployed\",\n          \"Schema validation enforced\",\n          \"API behavioral monitoring enabled\"\n        ]\n      }\n    ],\n    compensatingControls: [\n      \"Implement API rate limiting\",\n      \"Deploy API behavioral monitoring\",\n      \"Add fraud detection for sensitive operations\",\n      \"Enable detailed API logging\"\n    ],\n    preventionMeasures: [\n      \"Security review for API design\",\n      \"API security testing in CI/CD\",\n      \"State machine documentation\",\n      \"Regular API security assessments\"\n    ],\n    references: [\n      \"OWASP API Security Top 10\",\n      \"REST Security Cheat Sheet\",\n      \"API Security Best Practices\"\n    ]\n  },\n  payment_flow: {\n    vulnerabilityType: \"payment_flow\",\n    summary: \"Remediate payment flow vulnerabilities to prevent financial fraud and protect revenue.\",\n    immediateActions: [\n      \"Implement server-side price validation\",\n      \"Add payment verification checksums\",\n      \"Enable fraud detection alerts\",\n      \"Review recent transactions for exploitation\"\n    ],\n    shortTermRemediation: [\n      {\n        order: 1,\n        title: \"Payment Validation Hardening\",\n        description: \"Implement comprehensive server-side validation for all payment parameters.\",\n        effort: \"medium\",\n        estimatedTime: \"8-16 hours\",\n        requiredTools: [\"Payment processing\", \"Backend development\"],\n        requiredSkills: [\"Payment integration\", \"Security engineering\"],\n        verificationSteps: [\n          \"All prices validated server-side\",\n          \"Payment amounts cannot be manipulated\",\n          \"Transaction integrity verified\"\n        ]\n      },\n      {\n        order: 2,\n        title: \"Fraud Detection Enhancement\",\n        description: \"Implement or enhance fraud detection for payment transactions.\",\n        effort: \"medium\",\n        estimatedTime: \"8-16 hours\",\n        requiredTools: [\"Fraud detection platform\", \"Payment gateway\"],\n        requiredSkills: [\"Fraud prevention\", \"Payment operations\"],\n        verificationSteps: [\n          \"Fraud rules configured\",\n          \"Velocity checks implemented\",\n          \"Manual review queue established\"\n        ]\n      }\n    ],\n    longTermRemediation: [\n      {\n        order: 1,\n        title: \"Payment Security Architecture\",\n        description: \"Implement comprehensive payment security including PCI compliance, tokenization, and 3D Secure.\",\n        effort: \"high\",\n        estimatedTime: \"8-12 weeks\",\n        requiredTools: [\"Payment gateway\", \"Tokenization service\", \"PCI tools\"],\n        requiredSkills: [\"Payment security\", \"PCI compliance\"],\n        verificationSteps: [\n          \"PCI DSS compliance achieved\",\n          \"Tokenization implemented\",\n          \"Strong customer authentication enabled\"\n        ]\n      }\n    ],\n    compensatingControls: [\n      \"Implement transaction velocity limits\",\n      \"Enable real-time fraud monitoring\",\n      \"Add manual review for suspicious transactions\",\n      \"Implement chargeback prevention measures\"\n    ],\n    preventionMeasures: [\n      \"Regular payment security assessments\",\n      \"PCI DSS compliance maintenance\",\n      \"Fraud pattern analysis\",\n      \"Security review for payment changes\"\n    ],\n    references: [\n      \"PCI DSS Requirements\",\n      \"OWASP Payment Security Guidelines\",\n      \"Payment Card Industry Best Practices\"\n    ]\n  },\n  subscription_bypass: {\n    vulnerabilityType: \"subscription_bypass\",\n    summary: \"Address subscription bypass vulnerabilities to protect revenue and ensure fair access.\",\n    immediateActions: [\n      \"Implement server-side subscription validation\",\n      \"Review and restrict feature flag access\",\n      \"Add logging for subscription state changes\",\n      \"Identify and flag potential abuse accounts\"\n    ],\n    shortTermRemediation: [\n      {\n        order: 1,\n        title: \"Subscription State Hardening\",\n        description: \"Implement server-side subscription validation for all premium features.\",\n        effort: \"medium\",\n        estimatedTime: \"8-16 hours\",\n        requiredTools: [\"Subscription platform\", \"Backend development\"],\n        requiredSkills: [\"Backend development\", \"Security engineering\"],\n        verificationSteps: [\n          \"All feature access validated server-side\",\n          \"Trial periods cannot be extended client-side\",\n          \"Subscription state is authoritative\"\n        ]\n      }\n    ],\n    longTermRemediation: [\n      {\n        order: 1,\n        title: \"Subscription Security Architecture\",\n        description: \"Implement comprehensive subscription security with cryptographic enforcement and abuse detection.\",\n        effort: \"high\",\n        estimatedTime: \"4-8 weeks\",\n        requiredTools: [\"Subscription platform\", \"Fraud detection\"],\n        requiredSkills: [\"Product security\", \"Backend architecture\"],\n        verificationSteps: [\n          \"Cryptographic subscription tokens\",\n          \"Abuse detection and prevention\",\n          \"Real-time subscription enforcement\"\n        ]\n      }\n    ],\n    compensatingControls: [\n      \"Implement usage monitoring\",\n      \"Add behavioral analysis for abuse patterns\",\n      \"Enable manual review for suspicious accounts\",\n      \"Implement feature usage limits\"\n    ],\n    preventionMeasures: [\n      \"Security review for subscription logic\",\n      \"Regular subscription security testing\",\n      \"Abuse pattern monitoring\",\n      \"Feature flag security controls\"\n    ],\n    references: [\n      \"SaaS Security Best Practices\",\n      \"Subscription Business Security Guidelines\",\n      \"Revenue Protection Strategies\"\n    ]\n  },\n  state_machine: {\n    vulnerabilityType: \"state_machine\",\n    summary: \"Address state machine violations through proper transition validation and state integrity.\",\n    immediateActions: [\n      \"Document valid state transitions\",\n      \"Implement transition logging\",\n      \"Add validation for state changes\",\n      \"Review recent state transitions for anomalies\"\n    ],\n    shortTermRemediation: [\n      {\n        order: 1,\n        title: \"State Transition Enforcement\",\n        description: \"Implement explicit state machine with validated transitions.\",\n        effort: \"medium\",\n        estimatedTime: \"8-16 hours\",\n        requiredTools: [\"State machine library\", \"Backend development\"],\n        requiredSkills: [\"Backend development\", \"State machine design\"],\n        verificationSteps: [\n          \"All transitions explicitly defined\",\n          \"Invalid transitions rejected with proper errors\",\n          \"State history maintained\"\n        ]\n      }\n    ],\n    longTermRemediation: [\n      {\n        order: 1,\n        title: \"Formal State Machine Implementation\",\n        description: \"Implement formal state machine with comprehensive validation, history, and audit trail.\",\n        effort: \"high\",\n        estimatedTime: \"4-8 weeks\",\n        requiredTools: [\"State machine framework\", \"Event sourcing\"],\n        requiredSkills: [\"State machine design\", \"Event-driven architecture\"],\n        verificationSteps: [\n          \"Formal state machine specification\",\n          \"Complete audit trail of transitions\",\n          \"Race condition protection\"\n        ]\n      }\n    ],\n    compensatingControls: [\n      \"Add state integrity monitoring\",\n      \"Implement anomaly detection for transitions\",\n      \"Enable rollback capabilities\",\n      \"Add business rule validation\"\n    ],\n    preventionMeasures: [\n      \"Document state machines formally\",\n      \"Security review for state changes\",\n      \"Automated state machine testing\",\n      \"Regular state integrity audits\"\n    ],\n    references: [\n      \"State Machine Design Patterns\",\n      \"Business Logic Security Guidelines\",\n      \"Event Sourcing Best Practices\"\n    ]\n  },\n  privilege_boundary: {\n    vulnerabilityType: \"privilege_boundary\",\n    summary: \"Address privilege boundary violations through proper authorization and tenant isolation.\",\n    immediateActions: [\n      \"Identify all affected resources and users\",\n      \"Implement immediate access restrictions\",\n      \"Add logging for cross-boundary access attempts\",\n      \"Review access logs for exploitation\"\n    ],\n    shortTermRemediation: [\n      {\n        order: 1,\n        title: \"Authorization Hardening\",\n        description: \"Implement consistent authorization checks at all privilege boundaries.\",\n        effort: \"medium\",\n        estimatedTime: \"8-24 hours\",\n        requiredTools: [\"Authorization framework\", \"Access control\"],\n        requiredSkills: [\"Authorization design\", \"Security engineering\"],\n        verificationSteps: [\n          \"All endpoints enforce authorization\",\n          \"IDOR vulnerabilities eliminated\",\n          \"Tenant isolation verified\"\n        ]\n      }\n    ],\n    longTermRemediation: [\n      {\n        order: 1,\n        title: \"Zero Trust Authorization\",\n        description: \"Implement zero trust authorization model with continuous verification.\",\n        effort: \"high\",\n        estimatedTime: \"8-16 weeks\",\n        requiredTools: [\"Zero trust platform\", \"Policy engine\"],\n        requiredSkills: [\"Zero trust architecture\", \"Security design\"],\n        verificationSteps: [\n          \"Zero trust policies implemented\",\n          \"Continuous authorization verification\",\n          \"Comprehensive access logging\"\n        ]\n      }\n    ],\n    compensatingControls: [\n      \"Implement additional authentication for sensitive operations\",\n      \"Add cross-tenant access monitoring\",\n      \"Enable data access logging\",\n      \"Deploy privilege escalation detection\"\n    ],\n    preventionMeasures: [\n      \"Centralized authorization framework\",\n      \"Regular authorization testing\",\n      \"Security review for access control changes\",\n      \"Automated authorization policy validation\"\n    ],\n    references: [\n      \"OWASP Authorization Testing Guide\",\n      \"Zero Trust Architecture Guidelines\",\n      \"Multi-tenancy Security Best Practices\"\n    ]\n  },\n  workflow_desync: {\n    vulnerabilityType: \"workflow_desync\",\n    summary: \"Address workflow desynchronization issues through consistency enforcement and monitoring.\",\n    immediateActions: [\n      \"Identify affected workflows and systems\",\n      \"Implement consistency checks\",\n      \"Add monitoring for desync conditions\",\n      \"Review recent transactions for exploitation\"\n    ],\n    shortTermRemediation: [\n      {\n        order: 1,\n        title: \"Consistency Enforcement\",\n        description: \"Implement consistency checks and compensating transactions for critical workflows.\",\n        effort: \"medium\",\n        estimatedTime: \"8-16 hours\",\n        requiredTools: [\"Transaction management\", \"Message queue\"],\n        requiredSkills: [\"Distributed systems\", \"Backend development\"],\n        verificationSteps: [\n          \"Consistency checks implemented\",\n          \"Compensating transactions working\",\n          \"Desync detection enabled\"\n        ]\n      }\n    ],\n    longTermRemediation: [\n      {\n        order: 1,\n        title: \"Distributed Transaction Architecture\",\n        description: \"Implement proper distributed transaction patterns with saga or two-phase commit.\",\n        effort: \"high\",\n        estimatedTime: \"8-16 weeks\",\n        requiredTools: [\"Saga orchestrator\", \"Event sourcing\", \"Message broker\"],\n        requiredSkills: [\"Distributed systems architecture\", \"Event-driven design\"],\n        verificationSteps: [\n          \"Saga patterns implemented\",\n          \"Idempotency guaranteed\",\n          \"Eventual consistency managed\"\n        ]\n      }\n    ],\n    compensatingControls: [\n      \"Add reconciliation processes\",\n      \"Implement desync alerting\",\n      \"Enable transaction rollback\",\n      \"Deploy consistency monitoring\"\n    ],\n    preventionMeasures: [\n      \"Design for eventual consistency\",\n      \"Implement idempotent operations\",\n      \"Use distributed transaction patterns\",\n      \"Regular consistency audits\"\n    ],\n    references: [\n      \"Saga Pattern Documentation\",\n      \"Distributed Systems Consistency Patterns\",\n      \"Event-Driven Architecture Best Practices\"\n    ]\n  },\n  order_lifecycle: {\n    vulnerabilityType: \"order_lifecycle\",\n    summary: \"Address order lifecycle abuse through proper validation and fraud prevention.\",\n    immediateActions: [\n      \"Implement order state validation\",\n      \"Add fulfillment verification before refunds\",\n      \"Enable fraud detection for order operations\",\n      \"Review recent refunds and cancellations\"\n    ],\n    shortTermRemediation: [\n      {\n        order: 1,\n        title: \"Order Validation Hardening\",\n        description: \"Implement comprehensive validation for order lifecycle operations.\",\n        effort: \"medium\",\n        estimatedTime: \"8-16 hours\",\n        requiredTools: [\"Order management system\", \"Backend development\"],\n        requiredSkills: [\"E-commerce development\", \"Security engineering\"],\n        verificationSteps: [\n          \"Order state machine enforced\",\n          \"Refund requires fulfillment verification\",\n          \"Cancellation policies enforced\"\n        ]\n      }\n    ],\n    longTermRemediation: [\n      {\n        order: 1,\n        title: \"Order Security Architecture\",\n        description: \"Implement comprehensive order security with fraud prevention and abuse detection.\",\n        effort: \"high\",\n        estimatedTime: \"4-8 weeks\",\n        requiredTools: [\"Fraud platform\", \"Order management\", \"Analytics\"],\n        requiredSkills: [\"E-commerce security\", \"Fraud prevention\"],\n        verificationSteps: [\n          \"Fraud detection for all order operations\",\n          \"Abuse pattern detection\",\n          \"Automated policy enforcement\"\n        ]\n      }\n    ],\n    compensatingControls: [\n      \"Implement refund velocity limits\",\n      \"Add manual review for high-value operations\",\n      \"Enable customer risk scoring\",\n      \"Deploy order operation monitoring\"\n    ],\n    preventionMeasures: [\n      \"Regular order flow security testing\",\n      \"Fraud pattern analysis\",\n      \"Customer behavior monitoring\",\n      \"Policy enforcement automation\"\n    ],\n    references: [\n      \"E-commerce Fraud Prevention Guidelines\",\n      \"Order Management Security Best Practices\",\n      \"Refund Fraud Prevention Strategies\"\n    ]\n  }\n};\n\nexport function getVulnerabilityInfo(exposureType: ExposureType): VulnerabilityInfo {\n  return vulnerabilityCatalog[exposureType];\n}\n\nexport function getRemediationGuidance(exposureType: ExposureType): RemediationGuidance {\n  return remediationGuidanceTemplates[exposureType];\n}\n\nexport function formatVulnerabilityName(exposureType: ExposureType): string {\n  return vulnerabilityCatalog[exposureType]?.name || exposureType.replace(/_/g, \" \");\n}\n\nexport function formatVulnerabilityShortName(exposureType: ExposureType): string {\n  return vulnerabilityCatalog[exposureType]?.shortName || exposureType.replace(/_/g, \" \");\n}\n","path":null,"size_bytes":52127,"size_tokens":null},"server/services/kill-chain-graph.ts":{"content":"import type { AttackPathStep, KillChainTactic } from \"@shared/schema\";\n\nexport interface KillChainPhase {\n  id: KillChainTactic;\n  name: string;\n  shortName: string;\n  description: string;\n  order: number;\n}\n\nexport const killChainPhases: KillChainPhase[] = [\n  { id: \"reconnaissance\", name: \"Reconnaissance\", shortName: \"Recon\", description: \"Gathering information about the target\", order: 1 },\n  { id: \"resource-development\", name: \"Resource Development\", shortName: \"Resources\", description: \"Establishing resources for operations\", order: 2 },\n  { id: \"initial-access\", name: \"Initial Access\", shortName: \"Access\", description: \"Gaining entry to the target environment\", order: 3 },\n  { id: \"execution\", name: \"Execution\", shortName: \"Execute\", description: \"Running malicious code\", order: 4 },\n  { id: \"persistence\", name: \"Persistence\", shortName: \"Persist\", description: \"Maintaining access over time\", order: 5 },\n  { id: \"privilege-escalation\", name: \"Privilege Escalation\", shortName: \"Priv Esc\", description: \"Gaining higher-level permissions\", order: 6 },\n  { id: \"defense-evasion\", name: \"Defense Evasion\", shortName: \"Evasion\", description: \"Avoiding detection\", order: 7 },\n  { id: \"credential-access\", name: \"Credential Access\", shortName: \"Creds\", description: \"Stealing credentials\", order: 8 },\n  { id: \"discovery\", name: \"Discovery\", shortName: \"Discover\", description: \"Exploring the environment\", order: 9 },\n  { id: \"lateral-movement\", name: \"Lateral Movement\", shortName: \"Lateral\", description: \"Moving through the network\", order: 10 },\n  { id: \"collection\", name: \"Collection\", shortName: \"Collect\", description: \"Gathering target data\", order: 11 },\n  { id: \"command-and-control\", name: \"Command and Control\", shortName: \"C2\", description: \"Communicating with compromised systems\", order: 12 },\n  { id: \"exfiltration\", name: \"Exfiltration\", shortName: \"Exfil\", description: \"Stealing data from the target\", order: 13 },\n  { id: \"impact\", name: \"Impact\", shortName: \"Impact\", description: \"Causing damage or disruption\", order: 14 }\n];\n\nexport interface KillChainVisualization {\n  phases: Array<{\n    phase: KillChainPhase;\n    isActive: boolean;\n    steps: AttackPathStep[];\n    severity: \"critical\" | \"high\" | \"medium\" | \"low\" | \"none\";\n  }>;\n  attackPathSummary: string;\n  totalPhasesCovered: number;\n  criticalPath: string[];\n  timeToCompromise: string;\n  complexityScore: number;\n}\n\nexport function mapTechniqueToPhase(technique: string): KillChainTactic {\n  const techniquePhaseMap: Record<string, KillChainTactic> = {\n    \"T1595\": \"reconnaissance\",\n    \"T1592\": \"reconnaissance\",\n    \"T1589\": \"reconnaissance\",\n    \"T1590\": \"reconnaissance\",\n    \"T1591\": \"reconnaissance\",\n    \"T1587\": \"resource-development\",\n    \"T1588\": \"resource-development\",\n    \"T1583\": \"resource-development\",\n    \"T1584\": \"resource-development\",\n    \"T1190\": \"initial-access\",\n    \"T1133\": \"initial-access\",\n    \"T1078\": \"initial-access\",\n    \"T1566\": \"initial-access\",\n    \"T1199\": \"initial-access\",\n    \"T1059\": \"execution\",\n    \"T1106\": \"execution\",\n    \"T1053\": \"execution\",\n    \"T1569\": \"execution\",\n    \"T1547\": \"persistence\",\n    \"T1136\": \"persistence\",\n    \"T1098\": \"persistence\",\n    \"T1543\": \"persistence\",\n    \"T1068\": \"privilege-escalation\",\n    \"T1548\": \"privilege-escalation\",\n    \"T1134\": \"privilege-escalation\",\n    \"T1574\": \"privilege-escalation\",\n    \"T1070\": \"defense-evasion\",\n    \"T1036\": \"defense-evasion\",\n    \"T1027\": \"defense-evasion\",\n    \"T1562\": \"defense-evasion\",\n    \"T1110\": \"credential-access\",\n    \"T1003\": \"credential-access\",\n    \"T1552\": \"credential-access\",\n    \"T1555\": \"credential-access\",\n    \"T1087\": \"discovery\",\n    \"T1082\": \"discovery\",\n    \"T1046\": \"discovery\",\n    \"T1135\": \"discovery\",\n    \"T1021\": \"lateral-movement\",\n    \"T1550\": \"lateral-movement\",\n    \"T1072\": \"lateral-movement\",\n    \"T1210\": \"lateral-movement\",\n    \"T1560\": \"collection\",\n    \"T1039\": \"collection\",\n    \"T1005\": \"collection\",\n    \"T1114\": \"collection\",\n    \"T1071\": \"command-and-control\",\n    \"T1105\": \"command-and-control\",\n    \"T1572\": \"command-and-control\",\n    \"T1573\": \"command-and-control\",\n    \"T1048\": \"exfiltration\",\n    \"T1041\": \"exfiltration\",\n    \"T1567\": \"exfiltration\",\n    \"T1020\": \"exfiltration\",\n    \"T1485\": \"impact\",\n    \"T1486\": \"impact\",\n    \"T1565\": \"impact\",\n    \"T1499\": \"impact\",\n    \"T1657\": \"impact\"\n  };\n  \n  const baseId = technique?.split(\".\")[0] || \"\";\n  return techniquePhaseMap[baseId] || \"execution\";\n}\n\nexport function buildKillChainVisualization(\n  attackPath: AttackPathStep[],\n  attackGraph?: {\n    complexityScore?: number;\n    timeToCompromise?: { expected: number; unit: string };\n    criticalPath?: string[];\n  }\n): KillChainVisualization {\n  const phaseStepMap = new Map<KillChainTactic, AttackPathStep[]>();\n  \n  killChainPhases.forEach(phase => {\n    phaseStepMap.set(phase.id, []);\n  });\n  \n  attackPath.forEach(step => {\n    const phaseId = mapTechniqueToPhase(step.technique || \"\");\n    const steps = phaseStepMap.get(phaseId) || [];\n    steps.push(step);\n    phaseStepMap.set(phaseId, steps);\n  });\n  \n  const phases = killChainPhases.map(phase => {\n    const steps = phaseStepMap.get(phase.id) || [];\n    const isActive = steps.length > 0;\n    \n    let severity: \"critical\" | \"high\" | \"medium\" | \"low\" | \"none\" = \"none\";\n    if (isActive) {\n      const severities = steps.map(s => s.severity);\n      if (severities.includes(\"critical\")) severity = \"critical\";\n      else if (severities.includes(\"high\")) severity = \"high\";\n      else if (severities.includes(\"medium\")) severity = \"medium\";\n      else if (severities.includes(\"low\")) severity = \"low\";\n    }\n    \n    return {\n      phase,\n      isActive,\n      steps,\n      severity\n    };\n  });\n  \n  const activePhases = phases.filter(p => p.isActive);\n  const totalPhasesCovered = activePhases.length;\n  \n  const phaseNames = activePhases.map(p => p.phase.shortName);\n  const attackPathSummary = phaseNames.length > 0 \n    ? `Attack chain spans ${totalPhasesCovered} phases: ${phaseNames.join(\"  \")}`\n    : \"No attack chain identified\";\n  \n  return {\n    phases,\n    attackPathSummary,\n    totalPhasesCovered,\n    criticalPath: attackGraph?.criticalPath || attackPath.map(s => s.title),\n    timeToCompromise: attackGraph?.timeToCompromise \n      ? `${attackGraph.timeToCompromise.expected} ${attackGraph.timeToCompromise.unit}`\n      : \"Unknown\",\n    complexityScore: attackGraph?.complexityScore || 50\n  };\n}\n\nexport interface KillChainReportSection {\n  title: string;\n  summary: string;\n  phaseTable: Array<{\n    phase: string;\n    status: string;\n    severity: string;\n    stepsCount: number;\n    techniques: string[];\n    description: string;\n  }>;\n  attackFlow: string[];\n  metrics: {\n    totalPhases: number;\n    activePhases: number;\n    coverage: number;\n    criticalPhases: number;\n    highPhases: number;\n    timeToCompromise: string;\n    complexityScore: number;\n    complexityLevel: string;\n  };\n  detailedSteps: Array<{\n    order: number;\n    phase: string;\n    title: string;\n    description: string;\n    technique: string;\n    severity: string;\n  }>;\n}\n\nexport function generateKillChainReportSection(\n  visualization: KillChainVisualization\n): KillChainReportSection {\n  const phaseTable = visualization.phases.map(p => ({\n    phase: p.phase.name,\n    status: p.isActive ? \"ACTIVE\" : \"Not Observed\",\n    severity: p.severity.toUpperCase(),\n    stepsCount: p.steps.length,\n    techniques: p.steps.map(s => s.technique || \"N/A\"),\n    description: p.isActive \n      ? p.steps.map(s => s.title).join(\"; \")\n      : p.phase.description\n  }));\n  \n  const activePhases = visualization.phases.filter(p => p.isActive);\n  const attackFlow = activePhases.map((p, i) => {\n    const arrow = i < activePhases.length - 1 ? \"  \" : \"\";\n    return `${p.phase.shortName}${arrow}`;\n  });\n  \n  const criticalPhases = activePhases.filter(p => p.severity === \"critical\").length;\n  const highPhases = activePhases.filter(p => p.severity === \"high\").length;\n  const coverage = Math.round((visualization.totalPhasesCovered / killChainPhases.length) * 100);\n  \n  let complexityLevel = \"Low\";\n  if (visualization.complexityScore >= 80) complexityLevel = \"Expert\";\n  else if (visualization.complexityScore >= 60) complexityLevel = \"High\";\n  else if (visualization.complexityScore >= 40) complexityLevel = \"Medium\";\n  \n  let stepOrder = 0;\n  const detailedSteps: KillChainReportSection[\"detailedSteps\"] = [];\n  visualization.phases.forEach(p => {\n    p.steps.forEach(step => {\n      stepOrder++;\n      detailedSteps.push({\n        order: stepOrder,\n        phase: p.phase.name,\n        title: step.title,\n        description: step.description,\n        technique: step.technique || \"N/A\",\n        severity: step.severity.toUpperCase()\n      });\n    });\n  });\n  \n  return {\n    title: \"Kill Chain Analysis\",\n    summary: visualization.attackPathSummary,\n    phaseTable,\n    attackFlow: attackFlow.length > 0 ? attackFlow : [\"No attack path identified\"],\n    metrics: {\n      totalPhases: killChainPhases.length,\n      activePhases: visualization.totalPhasesCovered,\n      coverage,\n      criticalPhases,\n      highPhases,\n      timeToCompromise: visualization.timeToCompromise,\n      complexityScore: visualization.complexityScore,\n      complexityLevel\n    },\n    detailedSteps\n  };\n}\n\nexport function generateTextualKillChainDiagram(visualization: KillChainVisualization): string {\n  const lines: string[] = [];\n  lines.push(\"\");\n  lines.push(\"                           MITRE ATT&CK KILL CHAIN                          \");\n  lines.push(\"\");\n  \n  const activePhases = visualization.phases.filter(p => p.isActive);\n  \n  if (activePhases.length === 0) {\n    lines.push(\"                        No Attack Path Identified                            \");\n    lines.push(\"\");\n    return lines.join(\"\\n\");\n  }\n  \n  const flowLine = activePhases.map(p => {\n    const severityIcon = p.severity === \"critical\" ? \"[!!!]\" : \n                         p.severity === \"high\" ? \"[!!]\" : \n                         p.severity === \"medium\" ? \"[!]\" : \"[*]\";\n    return `${p.phase.shortName}${severityIcon}`;\n  }).join(\"  \");\n  \n  const paddedFlow = flowLine.padStart((79 + flowLine.length) / 2).padEnd(79);\n  lines.push(`${paddedFlow.substring(0, 79)}`);\n  lines.push(\"\");\n  \n  activePhases.forEach(p => {\n    const phaseName = p.phase.name.padEnd(25);\n    const severity = p.severity.toUpperCase().padEnd(10);\n    const stepCount = `${p.steps.length} step(s)`.padEnd(12);\n    const techniques = p.steps.map(s => s.technique || \"\").filter(t => t).slice(0, 3).join(\", \").substring(0, 25).padEnd(25);\n    lines.push(` ${phaseName} ${severity} ${stepCount} ${techniques}`);\n  });\n  \n  lines.push(\"\");\n  \n  const metricsLine1 = `Coverage: ${visualization.totalPhasesCovered}/${killChainPhases.length} phases (${Math.round((visualization.totalPhasesCovered / killChainPhases.length) * 100)}%)`;\n  const metricsLine2 = `Time to Compromise: ${visualization.timeToCompromise} | Complexity: ${visualization.complexityScore}/100`;\n  \n  lines.push(` ${metricsLine1.padEnd(77)}`);\n  lines.push(` ${metricsLine2.padEnd(77)}`);\n  lines.push(\"\");\n  \n  return lines.join(\"\\n\");\n}\n\nexport interface PdfKillChainContent {\n  header: any;\n  flowDiagram: any;\n  phaseTable: any;\n  metricsPanel: any;\n  detailedSteps: any;\n}\n\nexport function generatePdfKillChainContent(\n  visualization: KillChainVisualization,\n  options: { includeDetails?: boolean; compact?: boolean } = {}\n): PdfKillChainContent {\n  const reportSection = generateKillChainReportSection(visualization);\n  \n  const header = {\n    text: \"Attack Kill Chain Analysis\",\n    style: \"sectionHeader\",\n    margin: [0, 20, 0, 10]\n  };\n  \n  const activePhases = visualization.phases.filter(p => p.isActive);\n  const flowItems = activePhases.map((p, i) => {\n    const color = p.severity === \"critical\" ? \"#ef4444\" :\n                  p.severity === \"high\" ? \"#f97316\" :\n                  p.severity === \"medium\" ? \"#eab308\" : \"#22c55e\";\n    \n    return {\n      columns: [\n        {\n          width: \"auto\",\n          stack: [\n            {\n              text: p.phase.shortName,\n              style: \"phaseLabel\",\n              color: color,\n              bold: true\n            },\n            {\n              text: p.severity.toUpperCase(),\n              style: \"phaseSeverity\",\n              fontSize: 7,\n              color: color\n            }\n          ],\n          margin: [0, 0, 5, 0]\n        },\n        i < activePhases.length - 1 ? {\n          width: \"auto\",\n          text: \"\",\n          style: \"arrow\",\n          margin: [5, 5, 5, 0]\n        } : { text: \"\", width: 0 }\n      ],\n      columnGap: 2\n    };\n  });\n  \n  const flowDiagram = {\n    stack: [\n      { text: \"Attack Flow\", style: \"subHeader\", margin: [0, 10, 0, 5] },\n      activePhases.length > 0 ? {\n        columns: flowItems.slice(0, 7),\n        margin: [0, 5, 0, 10]\n      } : {\n        text: \"No attack path identified\",\n        style: \"note\",\n        italics: true,\n        margin: [0, 5, 0, 10]\n      }\n    ]\n  };\n  \n  const phaseTableBody: any[][] = [\n    [\n      { text: \"Phase\", style: \"tableHeader\" },\n      { text: \"Status\", style: \"tableHeader\" },\n      { text: \"Severity\", style: \"tableHeader\" },\n      { text: \"Techniques\", style: \"tableHeader\" }\n    ]\n  ];\n  \n  const phasesToShow = options.compact \n    ? visualization.phases.filter(p => p.isActive)\n    : visualization.phases;\n  \n  phasesToShow.forEach(p => {\n    const statusColor = p.isActive ? \"#22c55e\" : \"#6b7280\";\n    const severityColor = p.severity === \"critical\" ? \"#ef4444\" :\n                          p.severity === \"high\" ? \"#f97316\" :\n                          p.severity === \"medium\" ? \"#eab308\" :\n                          p.severity === \"low\" ? \"#22c55e\" : \"#6b7280\";\n    \n    phaseTableBody.push([\n      { text: p.phase.name, style: \"tableCell\" },\n      { text: p.isActive ? \"ACTIVE\" : \"Not Observed\", color: statusColor, style: \"tableCell\" },\n      { text: p.severity.toUpperCase(), color: severityColor, style: \"tableCell\" },\n      { text: p.steps.map(s => s.technique || \"\").filter(t => t).join(\", \") || \"-\", style: \"tableCell\" }\n    ]);\n  });\n  \n  const phaseTable = {\n    stack: [\n      { text: \"Kill Chain Phase Coverage\", style: \"subHeader\", margin: [0, 15, 0, 5] },\n      {\n        table: {\n          headerRows: 1,\n          widths: [\"30%\", \"20%\", \"15%\", \"35%\"],\n          body: phaseTableBody\n        },\n        layout: {\n          hLineWidth: () => 0.5,\n          vLineWidth: () => 0.5,\n          hLineColor: () => \"#e5e7eb\",\n          vLineColor: () => \"#e5e7eb\"\n        }\n      }\n    ]\n  };\n  \n  const coverage = Math.round((reportSection.metrics.activePhases / reportSection.metrics.totalPhases) * 100);\n  \n  const metricsPanel = {\n    stack: [\n      { text: \"Attack Metrics\", style: \"subHeader\", margin: [0, 15, 0, 5] },\n      {\n        columns: [\n          {\n            width: \"25%\",\n            stack: [\n              { text: `${reportSection.metrics.activePhases}/${reportSection.metrics.totalPhases}`, style: \"metricValue\" },\n              { text: \"Phases Covered\", style: \"metricLabel\" }\n            ]\n          },\n          {\n            width: \"25%\",\n            stack: [\n              { text: `${coverage}%`, style: \"metricValue\" },\n              { text: \"Coverage\", style: \"metricLabel\" }\n            ]\n          },\n          {\n            width: \"25%\",\n            stack: [\n              { text: reportSection.metrics.timeToCompromise, style: \"metricValue\" },\n              { text: \"Time to Compromise\", style: \"metricLabel\" }\n            ]\n          },\n          {\n            width: \"25%\",\n            stack: [\n              { text: `${reportSection.metrics.complexityScore}/100`, style: \"metricValue\" },\n              { text: `Complexity (${reportSection.metrics.complexityLevel})`, style: \"metricLabel\" }\n            ]\n          }\n        ]\n      }\n    ]\n  };\n  \n  let detailedSteps: any = { text: \"\" };\n  if (options.includeDetails && reportSection.detailedSteps.length > 0) {\n    const stepsTableBody: any[][] = [\n      [\n        { text: \"#\", style: \"tableHeader\" },\n        { text: \"Phase\", style: \"tableHeader\" },\n        { text: \"Step\", style: \"tableHeader\" },\n        { text: \"Technique\", style: \"tableHeader\" },\n        { text: \"Severity\", style: \"tableHeader\" }\n      ]\n    ];\n    \n    reportSection.detailedSteps.forEach(step => {\n      const severityColor = step.severity === \"CRITICAL\" ? \"#ef4444\" :\n                            step.severity === \"HIGH\" ? \"#f97316\" :\n                            step.severity === \"MEDIUM\" ? \"#eab308\" : \"#22c55e\";\n      \n      stepsTableBody.push([\n        { text: String(step.order), style: \"tableCell\" },\n        { text: step.phase, style: \"tableCell\" },\n        { text: step.title, style: \"tableCell\" },\n        { text: step.technique, style: \"tableCell\" },\n        { text: step.severity, color: severityColor, style: \"tableCell\" }\n      ]);\n    });\n    \n    detailedSteps = {\n      stack: [\n        { text: \"Detailed Attack Steps\", style: \"subHeader\", margin: [0, 15, 0, 5] },\n        {\n          table: {\n            headerRows: 1,\n            widths: [\"5%\", \"20%\", \"40%\", \"15%\", \"10%\"],\n            body: stepsTableBody\n          },\n          layout: {\n            hLineWidth: () => 0.5,\n            vLineWidth: () => 0.5,\n            hLineColor: () => \"#e5e7eb\",\n            vLineColor: () => \"#e5e7eb\"\n          }\n        }\n      ]\n    };\n  }\n  \n  return {\n    header,\n    flowDiagram,\n    phaseTable,\n    metricsPanel,\n    detailedSteps\n  };\n}\n","path":null,"size_bytes":18990,"size_tokens":null},"server/src/reportsV2/narrativeEngine.ts":{"content":"/**\n * Narrative Engine Orchestrator\n * \n * Pipeline for generating AI-powered narrative pentest reports.\n * Transforms evaluation data into human-grade security assessments\n * using role-based prompts and structured ENO generation.\n */\n\nimport OpenAI from \"openai\";\nimport { createHash } from \"crypto\";\nimport { ENO, enoSchema, validateENO, type ENOValidationResult } from \"./eno.schema\";\nimport { type ReportInputPayload } from \"./reportInputBuilder\";\nimport { \n  ExecutiveReportV2, \n  TechnicalReportV2, \n  ComplianceReportV2, \n  EvidencePackageV2,\n  executiveReportV2Schema,\n  technicalReportV2Schema,\n  complianceReportV2Schema,\n  evidencePackageV2Schema\n} from \"./reportV2.schema\";\nimport { loadPrompt, getAntiTemplateRules } from \"./promptLoader\";\nimport { antiTemplateLint, type LintResult } from \"./antiTemplateLint\";\n\nlet openaiClient: OpenAI | null = null;\n\nfunction getOpenAIClient(): OpenAI {\n  if (!openaiClient) {\n    const apiKey = process.env.AI_INTEGRATIONS_OPENAI_API_KEY || process.env.OPENAI_API_KEY;\n    if (!apiKey) {\n      throw new Error(\"OpenAI API key not configured. Set AI_INTEGRATIONS_OPENAI_API_KEY or OPENAI_API_KEY environment variable.\");\n    }\n    openaiClient = new OpenAI({ \n      apiKey,\n      baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL || undefined,\n    });\n  }\n  return openaiClient;\n}\n\nexport interface NarrativeEngineConfig {\n  modelName?: string;\n  temperature?: number;\n  maxRetries?: number;\n  enableLinting?: boolean;\n}\n\nexport interface GenerationResult<T> {\n  success: boolean;\n  data?: T;\n  error?: string;\n  warnings: string[];\n  modelMeta: {\n    modelName: string;\n    promptHash: string;\n    temperature: number;\n    generationTimeMs: number;\n  };\n  lintResult?: LintResult;\n}\n\nexport interface FullReportV2 {\n  eno: ENO;\n  executive?: ExecutiveReportV2;\n  technical?: TechnicalReportV2;\n  compliance?: ComplianceReportV2;\n  evidence?: EvidencePackageV2;\n}\n\nconst DEFAULT_CONFIG: Required<NarrativeEngineConfig> = {\n  modelName: \"gpt-4o\",\n  temperature: 0.7,\n  maxRetries: 2,\n  enableLinting: true,\n};\n\n/**\n * Calculate hash of prompt content for traceability\n */\nfunction hashPrompt(content: string): string {\n  return createHash(\"sha256\").update(content).digest(\"hex\").substring(0, 16);\n}\n\n/**\n * Generate ENO (Engagement Narrative Object) from evaluation data\n */\nexport async function generateENO(\n  input: ReportInputPayload,\n  config: NarrativeEngineConfig = {}\n): Promise<GenerationResult<ENO>> {\n  const cfg = { ...DEFAULT_CONFIG, ...config };\n  const startTime = Date.now();\n  \n  try {\n    const systemPrompt = loadPrompt(\"leadPentester.system\");\n    const userPrompt = loadPrompt(\"eno.user\");\n    const antiTemplateRules = getAntiTemplateRules();\n    \n    const fullSystemPrompt = `${systemPrompt}\\n\\n${antiTemplateRules}`;\n    const fullUserPrompt = userPrompt.replace(\"{{INPUT_DATA}}\", JSON.stringify(input, null, 2));\n    \n    const promptHash = hashPrompt(fullSystemPrompt + fullUserPrompt);\n    \n    const response = await getOpenAIClient().chat.completions.create({\n      model: cfg.modelName,\n      temperature: cfg.temperature,\n      response_format: { type: \"json_object\" },\n      messages: [\n        { role: \"system\", content: fullSystemPrompt },\n        { role: \"user\", content: fullUserPrompt },\n      ],\n    });\n    \n    const generationTimeMs = Date.now() - startTime;\n    const content = response.choices[0]?.message?.content;\n    \n    if (!content) {\n      return {\n        success: false,\n        error: \"No content returned from AI model\",\n        warnings: [],\n        modelMeta: { modelName: cfg.modelName, promptHash, temperature: cfg.temperature, generationTimeMs },\n      };\n    }\n    \n    const parsed = JSON.parse(content);\n    \n    // Add metadata\n    parsed.version = \"1.0\";\n    parsed.generatedAt = new Date().toISOString();\n    parsed.modelMeta = {\n      modelName: cfg.modelName,\n      promptHash,\n      temperature: cfg.temperature,\n      generationTimeMs,\n    };\n    \n    // Validate ENO\n    const validation = validateENO(parsed);\n    \n    if (!validation.valid) {\n      return {\n        success: false,\n        error: `ENO validation failed: ${validation.errors.join(\"; \")}`,\n        warnings: validation.warnings,\n        modelMeta: parsed.modelMeta,\n      };\n    }\n    \n    // Run anti-template linting if enabled\n    let lintResult: LintResult | undefined;\n    if (cfg.enableLinting) {\n      lintResult = antiTemplateLint(validation.eno!);\n      if (!lintResult.passed) {\n        return {\n          success: false,\n          error: `Anti-template lint failed: ${lintResult.errors.join(\"; \")}`,\n          warnings: lintResult.warnings,\n          modelMeta: parsed.modelMeta,\n          lintResult,\n        };\n      }\n    }\n    \n    return {\n      success: true,\n      data: validation.eno,\n      warnings: [...validation.warnings, ...(lintResult?.warnings || [])],\n      modelMeta: parsed.modelMeta,\n      lintResult,\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Unknown error during ENO generation\",\n      warnings: [],\n      modelMeta: {\n        modelName: cfg.modelName,\n        promptHash: \"\",\n        temperature: cfg.temperature,\n        generationTimeMs: Date.now() - startTime,\n      },\n    };\n  }\n}\n\n/**\n * Generate Executive Report from ENO\n */\nexport async function generateExecutiveReport(\n  eno: ENO,\n  input: ReportInputPayload,\n  config: NarrativeEngineConfig = {}\n): Promise<GenerationResult<ExecutiveReportV2>> {\n  const cfg = { ...DEFAULT_CONFIG, ...config };\n  const startTime = Date.now();\n  \n  try {\n    const systemPrompt = loadPrompt(\"executiveAdvisor.system\");\n    const userPrompt = loadPrompt(\"executive.user\");\n    const antiTemplateRules = getAntiTemplateRules();\n    \n    const fullSystemPrompt = `${systemPrompt}\\n\\n${antiTemplateRules}`;\n    const fullUserPrompt = userPrompt\n      .replace(\"{{ENO}}\", JSON.stringify(eno, null, 2))\n      .replace(\"{{INPUT_DATA}}\", JSON.stringify(input, null, 2));\n    \n    const promptHash = hashPrompt(fullSystemPrompt + fullUserPrompt);\n    \n    const response = await getOpenAIClient().chat.completions.create({\n      model: cfg.modelName,\n      temperature: cfg.temperature,\n      response_format: { type: \"json_object\" },\n      messages: [\n        { role: \"system\", content: fullSystemPrompt },\n        { role: \"user\", content: fullUserPrompt },\n      ],\n    });\n    \n    const generationTimeMs = Date.now() - startTime;\n    const content = response.choices[0]?.message?.content;\n    \n    if (!content) {\n      return {\n        success: false,\n        error: \"No content returned from AI model\",\n        warnings: [],\n        modelMeta: { modelName: cfg.modelName, promptHash, temperature: cfg.temperature, generationTimeMs },\n      };\n    }\n    \n    const parsed = JSON.parse(content);\n    const validation = executiveReportV2Schema.safeParse(parsed);\n    \n    if (!validation.success) {\n      return {\n        success: false,\n        error: `Executive report validation failed: ${validation.error.errors.map(e => e.message).join(\"; \")}`,\n        warnings: [],\n        modelMeta: { modelName: cfg.modelName, promptHash, temperature: cfg.temperature, generationTimeMs },\n      };\n    }\n    \n    return {\n      success: true,\n      data: validation.data,\n      warnings: [],\n      modelMeta: { modelName: cfg.modelName, promptHash, temperature: cfg.temperature, generationTimeMs },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Unknown error\",\n      warnings: [],\n      modelMeta: {\n        modelName: cfg.modelName,\n        promptHash: \"\",\n        temperature: cfg.temperature,\n        generationTimeMs: Date.now() - startTime,\n      },\n    };\n  }\n}\n\n/**\n * Generate Technical Report from ENO\n */\nexport async function generateTechnicalReport(\n  eno: ENO,\n  input: ReportInputPayload,\n  config: NarrativeEngineConfig = {}\n): Promise<GenerationResult<TechnicalReportV2>> {\n  const cfg = { ...DEFAULT_CONFIG, ...config };\n  const startTime = Date.now();\n  \n  try {\n    const systemPrompt = loadPrompt(\"seniorEngineer.system\");\n    const userPrompt = loadPrompt(\"technical.user\");\n    const antiTemplateRules = getAntiTemplateRules();\n    \n    const fullSystemPrompt = `${systemPrompt}\\n\\n${antiTemplateRules}`;\n    const fullUserPrompt = userPrompt\n      .replace(\"{{ENO}}\", JSON.stringify(eno, null, 2))\n      .replace(\"{{INPUT_DATA}}\", JSON.stringify(input, null, 2));\n    \n    const promptHash = hashPrompt(fullSystemPrompt + fullUserPrompt);\n    \n    const response = await getOpenAIClient().chat.completions.create({\n      model: cfg.modelName,\n      temperature: cfg.temperature,\n      response_format: { type: \"json_object\" },\n      messages: [\n        { role: \"system\", content: fullSystemPrompt },\n        { role: \"user\", content: fullUserPrompt },\n      ],\n    });\n    \n    const generationTimeMs = Date.now() - startTime;\n    const content = response.choices[0]?.message?.content;\n    \n    if (!content) {\n      return {\n        success: false,\n        error: \"No content returned from AI model\",\n        warnings: [],\n        modelMeta: { modelName: cfg.modelName, promptHash, temperature: cfg.temperature, generationTimeMs },\n      };\n    }\n    \n    const parsed = JSON.parse(content);\n    const validation = technicalReportV2Schema.safeParse(parsed);\n    \n    if (!validation.success) {\n      return {\n        success: false,\n        error: `Technical report validation failed: ${validation.error.errors.map(e => e.message).join(\"; \")}`,\n        warnings: [],\n        modelMeta: { modelName: cfg.modelName, promptHash, temperature: cfg.temperature, generationTimeMs },\n      };\n    }\n    \n    return {\n      success: true,\n      data: validation.data,\n      warnings: [],\n      modelMeta: { modelName: cfg.modelName, promptHash, temperature: cfg.temperature, generationTimeMs },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Unknown error\",\n      warnings: [],\n      modelMeta: {\n        modelName: cfg.modelName,\n        promptHash: \"\",\n        temperature: cfg.temperature,\n        generationTimeMs: Date.now() - startTime,\n      },\n    };\n  }\n}\n\n/**\n * Generate Compliance Report from ENO\n */\nexport async function generateComplianceReport(\n  eno: ENO,\n  input: ReportInputPayload,\n  config: NarrativeEngineConfig = {}\n): Promise<GenerationResult<ComplianceReportV2>> {\n  const cfg = { ...DEFAULT_CONFIG, ...config };\n  const startTime = Date.now();\n  \n  try {\n    const systemPrompt = loadPrompt(\"complianceAssessor.system\");\n    const userPrompt = loadPrompt(\"compliance.user\");\n    const antiTemplateRules = getAntiTemplateRules();\n    \n    const fullSystemPrompt = `${systemPrompt}\\n\\n${antiTemplateRules}`;\n    const fullUserPrompt = userPrompt\n      .replace(\"{{ENO}}\", JSON.stringify(eno, null, 2))\n      .replace(\"{{INPUT_DATA}}\", JSON.stringify(input, null, 2));\n    \n    const promptHash = hashPrompt(fullSystemPrompt + fullUserPrompt);\n    \n    const response = await getOpenAIClient().chat.completions.create({\n      model: cfg.modelName,\n      temperature: cfg.temperature,\n      response_format: { type: \"json_object\" },\n      messages: [\n        { role: \"system\", content: fullSystemPrompt },\n        { role: \"user\", content: fullUserPrompt },\n      ],\n    });\n    \n    const generationTimeMs = Date.now() - startTime;\n    const content = response.choices[0]?.message?.content;\n    \n    if (!content) {\n      return {\n        success: false,\n        error: \"No content returned from AI model\",\n        warnings: [],\n        modelMeta: { modelName: cfg.modelName, promptHash, temperature: cfg.temperature, generationTimeMs },\n      };\n    }\n    \n    const parsed = JSON.parse(content);\n    const validation = complianceReportV2Schema.safeParse(parsed);\n    \n    if (!validation.success) {\n      return {\n        success: false,\n        error: `Compliance report validation failed: ${validation.error.errors.map(e => e.message).join(\"; \")}`,\n        warnings: [],\n        modelMeta: { modelName: cfg.modelName, promptHash, temperature: cfg.temperature, generationTimeMs },\n      };\n    }\n    \n    return {\n      success: true,\n      data: validation.data,\n      warnings: [],\n      modelMeta: { modelName: cfg.modelName, promptHash, temperature: cfg.temperature, generationTimeMs },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Unknown error\",\n      warnings: [],\n      modelMeta: {\n        modelName: cfg.modelName,\n        promptHash: \"\",\n        temperature: cfg.temperature,\n        generationTimeMs: Date.now() - startTime,\n      },\n    };\n  }\n}\n\n/**\n * Generate Evidence Package from ENO\n */\nexport async function generateEvidencePackage(\n  eno: ENO,\n  input: ReportInputPayload,\n  config: NarrativeEngineConfig = {}\n): Promise<GenerationResult<EvidencePackageV2>> {\n  const cfg = { ...DEFAULT_CONFIG, ...config };\n  const startTime = Date.now();\n  \n  try {\n    const systemPrompt = loadPrompt(\"incidentDoc.system\");\n    const userPrompt = loadPrompt(\"evidence.user\");\n    const antiTemplateRules = getAntiTemplateRules();\n    \n    const fullSystemPrompt = `${systemPrompt}\\n\\n${antiTemplateRules}`;\n    const fullUserPrompt = userPrompt\n      .replace(\"{{ENO}}\", JSON.stringify(eno, null, 2))\n      .replace(\"{{INPUT_DATA}}\", JSON.stringify(input, null, 2));\n    \n    const promptHash = hashPrompt(fullSystemPrompt + fullUserPrompt);\n    \n    const response = await getOpenAIClient().chat.completions.create({\n      model: cfg.modelName,\n      temperature: cfg.temperature,\n      response_format: { type: \"json_object\" },\n      messages: [\n        { role: \"system\", content: fullSystemPrompt },\n        { role: \"user\", content: fullUserPrompt },\n      ],\n    });\n    \n    const generationTimeMs = Date.now() - startTime;\n    const content = response.choices[0]?.message?.content;\n    \n    if (!content) {\n      return {\n        success: false,\n        error: \"No content returned from AI model\",\n        warnings: [],\n        modelMeta: { modelName: cfg.modelName, promptHash, temperature: cfg.temperature, generationTimeMs },\n      };\n    }\n    \n    const parsed = JSON.parse(content);\n    const validation = evidencePackageV2Schema.safeParse(parsed);\n    \n    if (!validation.success) {\n      return {\n        success: false,\n        error: `Evidence package validation failed: ${validation.error.errors.map(e => e.message).join(\"; \")}`,\n        warnings: [],\n        modelMeta: { modelName: cfg.modelName, promptHash, temperature: cfg.temperature, generationTimeMs },\n      };\n    }\n    \n    return {\n      success: true,\n      data: validation.data,\n      warnings: [],\n      modelMeta: { modelName: cfg.modelName, promptHash, temperature: cfg.temperature, generationTimeMs },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : \"Unknown error\",\n      warnings: [],\n      modelMeta: {\n        modelName: cfg.modelName,\n        promptHash: \"\",\n        temperature: cfg.temperature,\n        generationTimeMs: Date.now() - startTime,\n      },\n    };\n  }\n}\n\n/**\n * Full report generation pipeline\n * Generates ENO first, then all requested report sections\n */\nexport async function generateFullReport(\n  input: ReportInputPayload,\n  reportTypes: Array<\"executive\" | \"technical\" | \"compliance\" | \"evidence\">,\n  config: NarrativeEngineConfig = {}\n): Promise<{\n  success: boolean;\n  report?: FullReportV2;\n  errors: string[];\n  warnings: string[];\n}> {\n  const errors: string[] = [];\n  const warnings: string[] = [];\n  \n  // Step 1: Generate ENO\n  const enoResult = await generateENO(input, config);\n  \n  if (!enoResult.success || !enoResult.data) {\n    return {\n      success: false,\n      errors: [enoResult.error || \"Failed to generate ENO\"],\n      warnings: enoResult.warnings,\n    };\n  }\n  \n  warnings.push(...enoResult.warnings);\n  \n  const report: FullReportV2 = { eno: enoResult.data };\n  \n  // Step 2: Generate requested report sections in parallel\n  const sectionPromises: Promise<void>[] = [];\n  \n  if (reportTypes.includes(\"executive\")) {\n    sectionPromises.push(\n      generateExecutiveReport(enoResult.data, input, config).then(result => {\n        if (result.success && result.data) {\n          report.executive = result.data;\n        } else {\n          errors.push(`Executive report: ${result.error}`);\n        }\n        warnings.push(...result.warnings);\n      })\n    );\n  }\n  \n  if (reportTypes.includes(\"technical\")) {\n    sectionPromises.push(\n      generateTechnicalReport(enoResult.data, input, config).then(result => {\n        if (result.success && result.data) {\n          report.technical = result.data;\n        } else {\n          errors.push(`Technical report: ${result.error}`);\n        }\n        warnings.push(...result.warnings);\n      })\n    );\n  }\n  \n  if (reportTypes.includes(\"compliance\")) {\n    sectionPromises.push(\n      generateComplianceReport(enoResult.data, input, config).then(result => {\n        if (result.success && result.data) {\n          report.compliance = result.data;\n        } else {\n          errors.push(`Compliance report: ${result.error}`);\n        }\n        warnings.push(...result.warnings);\n      })\n    );\n  }\n  \n  if (reportTypes.includes(\"evidence\")) {\n    sectionPromises.push(\n      generateEvidencePackage(enoResult.data, input, config).then(result => {\n        if (result.success && result.data) {\n          report.evidence = result.data;\n        } else {\n          errors.push(`Evidence package: ${result.error}`);\n        }\n        warnings.push(...result.warnings);\n      })\n    );\n  }\n  \n  await Promise.all(sectionPromises);\n  \n  // If we have at least the ENO and one section, consider it a partial success\n  const hasAnySections = report.executive || report.technical || report.compliance || report.evidence;\n  \n  return {\n    success: errors.length === 0 || hasAnySections,\n    report: hasAnySections ? report : undefined,\n    errors,\n    warnings,\n  };\n}\n","path":null,"size_bytes":18089,"size_tokens":null},"server/src/reportsV2/tests/fixtures/index.ts":{"content":"/**\n * Test Fixtures Index\n * \n * Exports all test fixtures for Report V2 E2E testing.\n */\n\nexport { iamAbuseFixture, iamAbuseEvaluation, iamAbuseResult } from \"./iam-abuse.fixture\";\nexport { paymentBypassFixture, paymentBypassEvaluation, paymentBypassResult } from \"./payment-bypass.fixture\";\nexport { multiVectorFixture, multiVectorEvaluation, multiVectorResult } from \"./multi-vector.fixture\";\nexport { complianceGapFixture, complianceGapEvaluation, complianceGapResult } from \"./compliance-gap.fixture\";\nexport type { TestEvaluation, TestResult, TestFixture, TestRecommendation, TestEvidence, TestAttackPathStep } from \"./test-data.types\";\n\nexport const allFixtures = {\n  iamAbuse: \"iam-abuse\",\n  paymentBypass: \"payment-bypass\", \n  multiVector: \"multi-vector\",\n  complianceGap: \"compliance-gap\",\n} as const;\n\nexport type FixtureName = typeof allFixtures[keyof typeof allFixtures];\n","path":null,"size_bytes":886,"size_tokens":null},"server/src/reportsV2/tests/fixtures/compliance-gap.fixture.ts":{"content":"/**\n * Compliance Gap Test Fixture\n * \n * Simulates PCI-DSS control failures in a payment processing environment.\n * Tests the narrative engine's ability to map findings to compliance frameworks\n * and generate appropriate remediation guidance.\n */\n\nimport type { TestEvaluation, TestResult, TestFixture } from \"./test-data.types\";\n\nexport const complianceGapEvaluation: TestEvaluation = {\n  id: \"eval-compliance-001\",\n  assetId: \"asset-payment-gateway-001\",\n  assetName: \"payment-gateway.merchant.com\",\n  assetType: \"payment_system\",\n  exposureType: \"compliance_violation\",\n  description: `Multiple PCI-DSS control failures identified in cardholder data environment (CDE).\n    Scope: Payment gateway processing 50,000+ transactions monthly\n    Findings: Unencrypted PAN storage, missing audit logs, weak access controls\n    Discovery: QSA audit preparation assessment\n    Compliance deadline: 90 days to remediate before annual assessment`,\n  priority: \"critical\",\n  status: \"completed\",\n  organizationId: \"test-org-001\",\n  createdAt: new Date(\"2024-12-12T11:00:00Z\"),\n  updatedAt: new Date(\"2024-12-13T09:00:00Z\"),\n};\n\nexport const complianceGapResult: TestResult = {\n  id: \"result-compliance-001\",\n  evaluationId: \"eval-compliance-001\",\n  exploitable: true,\n  confidence: 85,\n  score: 75,\n  \n  attackPath: [\n    {\n      id: 1,\n      title: \"Shared Credential Access\",\n      description: \"Use shared admin credentials (known to 15+ employees) for initial access\",\n      technique: \"T1078\",\n      severity: \"high\",\n      order: 1,\n      targetAsset: \"payment-gateway\",\n      tools: [\"ssh\", \"browser\"],\n    },\n    {\n      id: 2,\n      title: \"Locate Unencrypted PAN Data\",\n      description: \"Locate unencrypted PAN data in database and log files\",\n      technique: \"T1083\",\n      severity: \"critical\",\n      order: 2,\n      targetAsset: \"payment-db\",\n      tools: [\"mysql-client\", \"grep\"],\n    },\n    {\n      id: 3,\n      title: \"Undetected Exfiltration\",\n      description: \"Extract card data without detection (no logging enabled)\",\n      technique: \"T1041\",\n      severity: \"critical\",\n      order: 3,\n      targetAsset: \"external\",\n      tools: [\"curl\", \"openssl\"],\n    },\n  ],\n  \n  impact: `The compliance gaps create multiple exploitable weaknesses. Unencrypted PAN storage enables direct card data theft if database is breached. Missing audit logs prevent detection of unauthorized access. Shared admin credentials mean no accountability for access. Missing network segmentation allows lateral movement from compromised systems. PCI-DSS non-compliance fines up to $500,000/month. Card brand penalties. Potential loss of merchant account.`,\n  \n  recommendations: [\n    {\n      id: \"rec-compliance-001\",\n      title: \"Implement encryption for stored PAN\",\n      description: \"Deploy AES-256 encryption for all stored cardholder data with proper key management (PCI-DSS Req 3.4)\",\n      priority: \"critical\",\n      type: \"remediation\",\n      effort: \"high\",\n      timeline: \"4 weeks\",\n    },\n    {\n      id: \"rec-compliance-002\",\n      title: \"Enable comprehensive audit logging\",\n      description: \"Configure logging for all access to cardholder data with tamper-evident log storage (PCI-DSS Req 10.1-10.3)\",\n      priority: \"critical\",\n      type: \"remediation\",\n      effort: \"medium\",\n      timeline: \"2 weeks\",\n    },\n    {\n      id: \"rec-compliance-003\",\n      title: \"Implement individual user accounts\",\n      description: \"Replace shared credentials with unique accounts per user with role-based access control (PCI-DSS Req 8.1)\",\n      priority: \"high\",\n      type: \"remediation\",\n      effort: \"medium\",\n      timeline: \"3 weeks\",\n    },\n    {\n      id: \"rec-compliance-004\",\n      title: \"Deploy network segmentation\",\n      description: \"Isolate CDE from corporate network with firewall rules and network ACLs (PCI-DSS Req 1.3)\",\n      priority: \"high\",\n      type: \"preventive\",\n      effort: \"high\",\n      timeline: \"6 weeks\",\n    },\n    {\n      id: \"rec-compliance-005\",\n      title: \"Implement MFA for CDE access\",\n      description: \"Require multi-factor authentication for all administrative access to payment systems (PCI-DSS Req 8.3.1)\",\n      priority: \"high\",\n      type: \"preventive\",\n      effort: \"low\",\n      timeline: \"1 week\",\n    },\n  ],\n  \n  evidenceArtifacts: [\n    {\n      id: \"ev-compliance-001\",\n      type: \"database_query\",\n      title: \"Unencrypted PAN Storage\",\n      description: \"Unencrypted PAN data in transactions table\",\n      content: `mysql> SELECT id, card_number, expiry, cvv FROM transactions LIMIT 3;\n+----+------------------+--------+-----+\n| id | card_number      | expiry | cvv |\n+----+------------------+--------+-----+\n|  1 | 4111111111111111 | 12/26  | 123 |\n|  2 | 5500000000000004 | 03/25  | 456 |\n|  3 | 340000000000009  | 06/27  | 7890|\n+----+------------------+--------+-----+\nWARNING: Full PAN and CVV stored in plaintext - PCI-DSS 3.2 violation`,\n    },\n    {\n      id: \"ev-compliance-002\",\n      type: \"configuration\",\n      title: \"Shared Credentials in Config\",\n      description: \"Shared credentials in configuration file\",\n      content: `# /opt/payment-gateway/config.yml\ndatabase:\n  host: payment-db.internal\n  user: pci_admin\n  password: Payment2019!  # Shared by all 15 CDE admins\n  \n# Note: Same password used since 2019\n# Access list: dev-team@, ops@, support@ (distribution lists)`,\n    },\n    {\n      id: \"ev-compliance-003\",\n      type: \"log_sample\",\n      title: \"Missing Audit Trail\",\n      description: \"Missing audit trail - no access logs configured\",\n      content: `$ ls -la /var/log/payment-gateway/\ntotal 0\ndrwxr-xr-x 2 root root 40 Dec 12 10:00 .\ndrwxr-xr-x 3 root root 60 Dec 12 10:00 ..\n\n$ cat /etc/payment-gateway/logging.conf\n# Logging disabled for performance\nlog_level: OFF\naudit_trail: false`,\n    },\n    {\n      id: \"ev-compliance-004\",\n      type: \"network_scan\",\n      title: \"Missing Network Segmentation\",\n      description: \"Missing network segmentation - CDE directly accessible\",\n      content: `Nmap scan from corporate workstation (192.168.1.50):\n  \nPORT     STATE SERVICE\n22/tcp   open  ssh (payment-gateway.internal)\n3306/tcp open  mysql (payment-db.internal)\n443/tcp  open  https (payment-api.internal)\n\nNo firewall rules blocking corporate -> CDE traffic\nAll CDE hosts reachable from any corporate IP`,\n    },\n  ],\n  \n  completedAt: new Date(\"2024-12-13T09:00:00Z\"),\n};\n\nexport const complianceGapFixture: TestFixture = {\n  evaluation: complianceGapEvaluation,\n  result: complianceGapResult,\n  expectedNarrativeElements: [\n    \"PCI-DSS\",\n    \"cardholder data\",\n    \"encryption\",\n    \"audit logging\",\n    \"network segmentation\",\n    \"shared credentials\",\n    \"compliance\",\n  ],\n  complianceFrameworks: [\"PCI-DSS 4.0\"],\n  affectedRequirements: [\"3.4\", \"7.1\", \"8.1\", \"8.3.1\", \"10.1\", \"10.2\", \"10.3\", \"1.3\"],\n};\n","path":null,"size_bytes":6823,"size_tokens":null},"server/src/reportsV2/prompts/leadPentester.system.md":{"content":"# Lead Penetration Tester System Prompt\n\nYou are a lead penetration tester with 15+ years of experience conducting security assessments for Fortune 500 companies, critical infrastructure, and high-security environments. You write authoritative, evidence-based reports that demonstrate deep technical understanding while remaining accessible to security teams.\n\n## Your Writing Style\n\n- **Direct and confident**: Never hedge with \"may\" or \"might\" when you have evidence. State findings clearly.\n- **Technical but not academic**: Use precise technical terminology but explain complex concepts.\n- **Evidence-driven**: Every claim references specific findings, artifacts, or observed behaviors.\n- **Actionable**: Recommendations include specific steps, not vague guidance.\n- **Conversational but professional**: Write like you're presenting to a peer, not filling out a form.\n\n## When Analyzing Findings\n\n1. **Connect individual vulnerabilities into attack narratives**: Don't just list issues - show how they chain together.\n2. **Identify the most impactful attack paths**: Prioritize paths that reach critical assets or data.\n3. **Prioritize based on real-world exploitability**: CVSS scores are starting points, not conclusions.\n4. **Consider the specific business context**: A finding in a payment system is different from one in a blog.\n5. **Think like an attacker**: What would a real adversary do with this access?\n\n## Your Expertise Areas\n\n- Web application security (OWASP Top 10 and beyond)\n- Network penetration testing and lateral movement\n- Cloud security (AWS, Azure, GCP)\n- Active Directory and identity attacks\n- Social engineering and phishing\n- API security and business logic flaws\n- Container and Kubernetes security\n\n## Report Quality Standards\n\n- Findings are reproducible with provided evidence\n- Attack paths have clear step-by-step progression\n- Business impact is quantified where possible\n- Remediation guidance is specific and prioritized\n- Executive summaries tell a coherent story, not just metrics\n","path":null,"size_bytes":2025,"size_tokens":null},"server/src/reportsV2/tests/fixtures/test-data.types.ts":{"content":"/**\n * Test Data Types for Report V2 Fixtures\n * \n * These types mirror the essential fields used by the report input builder\n * without requiring exact schema compliance for test data generation.\n */\n\nexport interface TestEvaluation {\n  id: string;\n  assetName?: string;\n  assetId: string;\n  assetType?: string;\n  exposureType: string;\n  description: string;\n  priority: \"critical\" | \"high\" | \"medium\" | \"low\";\n  status: \"pending\" | \"in_progress\" | \"completed\" | \"failed\";\n  organizationId: string;\n  adversaryProfile?: string;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface TestAttackPathStep {\n  id: number;\n  title: string;\n  description: string;\n  technique?: string;\n  severity: \"critical\" | \"high\" | \"medium\" | \"low\";\n  order?: number;\n  targetAsset?: string;\n  tools?: string[];\n}\n\nexport interface TestRecommendation {\n  id: string;\n  title: string;\n  description: string;\n  priority: \"critical\" | \"high\" | \"medium\" | \"low\";\n  type: \"remediation\" | \"compensating\" | \"preventive\";\n  effort?: \"low\" | \"medium\" | \"high\";\n  timeline?: string;\n}\n\nexport interface TestEvidence {\n  id: string;\n  type: string;\n  title: string;\n  description: string;\n  content: string;\n  timestamp?: Date;\n}\n\nexport interface TestResult {\n  id: string;\n  evaluationId: string;\n  exploitable: boolean;\n  confidence: number;\n  score: number;\n  attackPath?: TestAttackPathStep[];\n  impact?: string;\n  recommendations?: TestRecommendation[];\n  evidenceArtifacts?: TestEvidence[];\n  completedAt?: Date;\n}\n\nexport interface TestFixture {\n  evaluation: TestEvaluation;\n  result: TestResult;\n  expectedNarrativeElements: string[];\n  complianceFrameworks?: string[];\n  affectedRequirements?: string[];\n}\n","path":null,"size_bytes":1692,"size_tokens":null},"server/src/reportsV2/antiTemplateLint.ts":{"content":"/**\n * Anti-Template Linting\n * \n * Quality checks to ensure AI-generated content reads like authored\n * pentest reports, not templated output.\n */\n\nimport { ENO } from \"./eno.schema\";\n\nexport interface LintResult {\n  passed: boolean;\n  errors: string[];\n  warnings: string[];\n  score: number; // 0-100 quality score\n}\n\n// Forbidden generic phrases\nconst FORBIDDEN_PHRASES = [\n  \"overall risk is high due to\",\n  \"it is recommended that\",\n  \"the organization should consider\",\n  \"based on our assessment\",\n  \"best practices suggest\",\n  \"industry standards recommend\",\n  \"it was found that\",\n  \"it should be noted that\",\n  \"moving forward\",\n  \"at this time\",\n  \"in order to\",\n  \"due diligence\",\n  \"synergies\",\n  \"leverage\",\n  \"holistic approach\",\n  \"robust security\",\n  \"comprehensive solution\",\n  \"mission critical\",\n];\n\n// Minimum narrative lengths for quality\nconst MIN_NARRATIVE_LENGTH = 100;\nconst MIN_RATIONALE_LENGTH = 50;\n\n/**\n * Run anti-template linting on ENO\n */\nexport function antiTemplateLint(eno: ENO): LintResult {\n  const errors: string[] = [];\n  const warnings: string[] = [];\n  let qualityScore = 100;\n  \n  // Check 1: Forbidden phrases\n  const allText = extractAllText(eno);\n  for (const phrase of FORBIDDEN_PHRASES) {\n    const regex = new RegExp(phrase, \"gi\");\n    const matches = allText.match(regex);\n    if (matches && matches.length > 0) {\n      if (matches.length >= 3) {\n        errors.push(`Overused templated phrase: \"${phrase}\" appears ${matches.length} times`);\n        qualityScore -= 15;\n      } else {\n        warnings.push(`Templated phrase detected: \"${phrase}\"`);\n        qualityScore -= 5;\n      }\n    }\n  }\n  \n  // Check 2: Repetition detection\n  const repetitionScore = detectRepetition(allText);\n  if (repetitionScore > 0.3) {\n    errors.push(`High repetition detected (${(repetitionScore * 100).toFixed(1)}%). Content feels templated.`);\n    qualityScore -= 20;\n  } else if (repetitionScore > 0.15) {\n    warnings.push(`Moderate repetition detected (${(repetitionScore * 100).toFixed(1)}%)`);\n    qualityScore -= 10;\n  }\n  \n  // Check 3: Evidence references exist for critical findings\n  const highPriorityFindings = eno.riskPrioritizationLogic.filter(\n    r => r.exploitLikelihood === \"certain\" || r.exploitLikelihood === \"highly_likely\"\n  );\n  \n  for (const finding of highPriorityFindings) {\n    const hasEvidenceRef = eno.attackStory.some(\n      segment => segment.evidenceRefs.length > 0\n    );\n    if (!hasEvidenceRef) {\n      errors.push(`High-priority finding \"${finding.findingId}\" lacks evidence references`);\n      qualityScore -= 10;\n    }\n  }\n  \n  // Check 4: Narrative quality - check minimum lengths\n  if (eno.businessImpactAnalysis.executiveSummary.length < MIN_NARRATIVE_LENGTH) {\n    errors.push(`Executive summary too short (${eno.businessImpactAnalysis.executiveSummary.length} chars, minimum ${MIN_NARRATIVE_LENGTH})`);\n    qualityScore -= 15;\n  }\n  \n  if (eno.overallAssessment.verdictNarrative.length < MIN_NARRATIVE_LENGTH) {\n    errors.push(`Verdict narrative too short (${eno.overallAssessment.verdictNarrative.length} chars, minimum ${MIN_NARRATIVE_LENGTH})`);\n    qualityScore -= 15;\n  }\n  \n  // Check 5: Attack story has reasoning\n  for (const segment of eno.attackStory) {\n    if (segment.narrative.length < MIN_RATIONALE_LENGTH) {\n      warnings.push(`Attack story segment \"${segment.phase}\" has thin narrative (${segment.narrative.length} chars)`);\n      qualityScore -= 5;\n    }\n  }\n  \n  // Check 6: Risk prioritization has reasoning\n  for (const risk of eno.riskPrioritizationLogic) {\n    if (risk.rationale.length < MIN_RATIONALE_LENGTH) {\n      warnings.push(`Risk \"${risk.findingId}\" has insufficient rationale (${risk.rationale.length} chars)`);\n      qualityScore -= 5;\n    }\n  }\n  \n  // Check 7: Verify evidence index is populated\n  if (eno.evidenceIndex.length === 0) {\n    errors.push(\"No evidence artifacts in evidence index\");\n    qualityScore -= 20;\n  }\n  \n  // Check 8: Confidence scores are reasonable (not all 1.0)\n  const confidences = [\n    eno.engagementOverview.confidence,\n    eno.businessImpactAnalysis.confidence,\n    eno.overallAssessment.confidence,\n    ...eno.attackStory.map(s => s.confidence),\n    ...eno.defensiveGaps.map(g => g.confidence),\n  ];\n  \n  const allMaxConfidence = confidences.every(c => c === 1.0);\n  if (allMaxConfidence) {\n    warnings.push(\"All confidence scores are 1.0 - seems unrealistic\");\n    qualityScore -= 5;\n  }\n  \n  // Ensure score doesn't go below 0\n  qualityScore = Math.max(0, qualityScore);\n  \n  return {\n    passed: errors.length === 0,\n    errors,\n    warnings,\n    score: qualityScore,\n  };\n}\n\n/**\n * Extract all text content from ENO for analysis\n */\nfunction extractAllText(eno: ENO): string {\n  const texts: string[] = [];\n  \n  // Engagement overview\n  texts.push(eno.engagementOverview.scope);\n  texts.push(...eno.engagementOverview.objectives);\n  texts.push(eno.engagementOverview.methodology);\n  texts.push(...eno.engagementOverview.keyHighlights);\n  \n  // Attack story\n  for (const segment of eno.attackStory) {\n    texts.push(segment.narrative);\n  }\n  \n  // Business impact\n  texts.push(eno.businessImpactAnalysis.executiveSummary);\n  texts.push(eno.businessImpactAnalysis.operationalImpact);\n  texts.push(eno.businessImpactAnalysis.reputationalImpact);\n  if (eno.businessImpactAnalysis.regulatoryImpact) {\n    texts.push(eno.businessImpactAnalysis.regulatoryImpact);\n  }\n  for (const risk of eno.businessImpactAnalysis.primaryRisks) {\n    texts.push(risk.description);\n  }\n  \n  // Defensive gaps\n  for (const gap of eno.defensiveGaps) {\n    texts.push(gap.description);\n  }\n  \n  // Risk prioritization\n  for (const risk of eno.riskPrioritizationLogic) {\n    texts.push(risk.businessImpact);\n    texts.push(risk.rationale);\n  }\n  \n  // Overall assessment\n  texts.push(eno.overallAssessment.verdictNarrative);\n  texts.push(...eno.overallAssessment.strengthsObserved);\n  texts.push(...eno.overallAssessment.criticalWeaknesses);\n  for (const action of eno.overallAssessment.immediateActions) {\n    texts.push(action.action);\n    texts.push(action.expectedImpact);\n  }\n  for (const rec of eno.overallAssessment.strategicRecommendations) {\n    texts.push(rec.recommendation);\n    texts.push(rec.rationale);\n  }\n  \n  return texts.join(\" \").toLowerCase();\n}\n\n/**\n * Detect repetition in text using n-gram analysis\n */\nfunction detectRepetition(text: string): number {\n  const words = text.split(/\\s+/).filter(w => w.length > 3);\n  if (words.length < 20) return 0;\n  \n  // Create 3-grams\n  const ngrams: Map<string, number> = new Map();\n  for (let i = 0; i < words.length - 2; i++) {\n    const ngram = `${words[i]} ${words[i + 1]} ${words[i + 2]}`;\n    ngrams.set(ngram, (ngrams.get(ngram) || 0) + 1);\n  }\n  \n  // Count repeated n-grams\n  let repeatedCount = 0;\n  let totalNgrams = 0;\n  \n  ngrams.forEach((count) => {\n    totalNgrams += count;\n    if (count > 1) {\n      repeatedCount += count - 1;\n    }\n  });\n  \n  return totalNgrams > 0 ? repeatedCount / totalNgrams : 0;\n}\n\n/**\n * Lint a report section (for use with generated reports, not just ENO)\n */\nexport function lintReportSection(content: string, sectionName: string): LintResult {\n  const errors: string[] = [];\n  const warnings: string[] = [];\n  let qualityScore = 100;\n  \n  const lowerContent = content.toLowerCase();\n  \n  // Check forbidden phrases\n  for (const phrase of FORBIDDEN_PHRASES) {\n    if (lowerContent.includes(phrase)) {\n      warnings.push(`${sectionName}: Contains templated phrase \"${phrase}\"`);\n      qualityScore -= 5;\n    }\n  }\n  \n  // Check minimum length\n  if (content.length < MIN_NARRATIVE_LENGTH) {\n    errors.push(`${sectionName}: Content too short (${content.length} chars, minimum ${MIN_NARRATIVE_LENGTH})`);\n    qualityScore -= 15;\n  }\n  \n  // Check for bullet-only content\n  const bulletLines = content.split(\"\\n\").filter(line => line.trim().match(/^[-*]\\s/));\n  const totalLines = content.split(\"\\n\").filter(line => line.trim().length > 0);\n  \n  if (bulletLines.length > 0 && bulletLines.length / totalLines.length > 0.8) {\n    warnings.push(`${sectionName}: Mostly bullet points (${Math.round(bulletLines.length / totalLines.length * 100)}%). Consider adding narrative.`);\n    qualityScore -= 10;\n  }\n  \n  return {\n    passed: errors.length === 0,\n    errors,\n    warnings,\n    score: Math.max(0, qualityScore),\n  };\n}\n","path":null,"size_bytes":8354,"size_tokens":null},"server/src/reportsV2/prompts/incidentDoc.system.md":{"content":"# Incident Documentation Specialist System Prompt\n\nYou are an incident documentation specialist who creates forensic-quality evidence packages. You organize technical artifacts into clear timelines with chain-of-custody awareness.\n\n## Your Documentation Approach\n\n- **Chronological event reconstruction**: What happened and when\n- **Evidence linking and cross-referencing**: Artifact A proves Claim B\n- **Technical accuracy with timestamp precision**: UTC times, exact commands\n- **Artifact preservation recommendations**: What to keep, how to keep it\n- **Clear chain of evidence**: Who touched what, when\n\n## What You Ensure\n\n1. **Every claim is traceable to artifacts**: No unsupported assertions\n2. **Timelines are verifiable**: Multiple artifacts corroborate key events\n3. **Evidence is properly contextualized**: What does this artifact mean?\n4. **Documentation supports legal/regulatory needs**: Admissible in court if needed\n5. **Artifacts are catalogued systematically**: Easy to find and reference\n\n## Artifact Types You Handle\n\n- **HTTP captures**: Requests, responses, headers, bodies\n- **Log entries**: Application logs, system logs, security logs\n- **Screenshots**: Visual evidence of UI states or configurations\n- **Configuration files**: Before/after comparisons\n- **Network traces**: PCAP files, flow data\n- **Command outputs**: Terminal sessions, API responses\n- **Code snippets**: Vulnerable code, exploit payloads\n\n## Quality Standards\n\n- Timestamps in consistent format (ISO 8601, UTC)\n- Hashes (SHA-256) for integrity verification\n- Clear labeling and organization\n- Cross-references between related artifacts\n- Preservation of original metadata\n\n## Your Mindset\n\nYou document as if:\n- This will be presented to regulators\n- Defense attorneys will scrutinize every detail\n- The incident will be analyzed months later by new team members\n- Insurance claims will depend on your documentation\n- This could be exhibit evidence in litigation\n\n## Evidence Organization\n\nStructure evidence for:\n- Quick navigation by incident responders\n- Detailed analysis by forensic investigators\n- Summary review by legal/compliance\n- Long-term archival and retrieval\n","path":null,"size_bytes":2169,"size_tokens":null},"server/src/reportsV2/reportV2.schema.ts":{"content":"/**\n * Report V2 Section Schemas\n * \n * Defines the output format for AI-generated narrative reports.\n * These schemas match the structure expected by the UI and PDF export.\n */\n\nimport { z } from \"zod\";\n\n// ============================================================================\n// EXECUTIVE REPORT V2\n// ============================================================================\n\nexport const strategicRecommendationSchema = z.object({\n  title: z.string(),\n  description: z.string().min(50),\n  priority: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n  effort: z.enum([\"low\", \"medium\", \"high\"]),\n  expectedOutcome: z.string(),\n  stakeholders: z.array(z.string()).optional(),\n});\n\nexport const dayPlanItemSchema = z.object({\n  action: z.string(),\n  owner: z.string().optional(),\n  milestone: z.string().optional(),\n  dependencies: z.array(z.string()).optional(),\n});\n\nexport const executiveReportV2Schema = z.object({\n  reportType: z.literal(\"executive_v2\"),\n  generatedAt: z.string(),\n  \n  // Core narrative sections\n  executiveSummary: z.string().min(200), // 2-3 paragraphs\n  \n  topRisksRankedByBusinessImpact: z.array(z.object({\n    rank: z.number(),\n    title: z.string(),\n    businessImpact: z.string().min(50),\n    affectedBusinessProcess: z.string(),\n    financialExposure: z.string().optional(),\n    likelihood: z.enum([\"certain\", \"highly_likely\", \"likely\", \"possible\", \"unlikely\"]),\n  })),\n  \n  attackStorySummary: z.string().min(150), // Condensed narrative\n  \n  financialExposure: z.object({\n    estimatedTotalExposure: z.string(),\n    breakdownByCategory: z.array(z.object({\n      category: z.string(),\n      amount: z.string(),\n      basis: z.string(), // How the estimate was derived\n    })),\n    mitigationCostVsRisk: z.string(),\n  }),\n  \n  strategicRecommendations: z.array(strategicRecommendationSchema),\n  \n  day30_60_90Plan: z.object({\n    day30: z.array(dayPlanItemSchema),\n    day60: z.array(dayPlanItemSchema),\n    day90: z.array(dayPlanItemSchema),\n  }),\n  \n  // Board-level talking points\n  boardBriefingPoints: z.array(z.string()).optional(),\n});\n\nexport type ExecutiveReportV2 = z.infer<typeof executiveReportV2Schema>;\n\n// ============================================================================\n// TECHNICAL REPORT V2\n// ============================================================================\n\nexport const technicalFindingSchema = z.object({\n  id: z.string(),\n  title: z.string(),\n  severity: z.enum([\"critical\", \"high\", \"medium\", \"low\", \"informational\"]),\n  description: z.string().min(50),\n  technicalDetails: z.string(),\n  affectedComponents: z.array(z.string()),\n  evidenceReferences: z.array(z.string()), // IDs from evidence package\n  cweId: z.string().optional(),\n  cveId: z.string().optional(),\n  cvssScore: z.number().optional(),\n});\n\nexport const attackPathDetailSchema = z.object({\n  pathId: z.string(),\n  title: z.string(),\n  narrative: z.string().min(100), // Explanation of the attack chain\n  steps: z.array(z.object({\n    order: z.number(),\n    technique: z.string(),\n    mitreId: z.string().optional(),\n    description: z.string(),\n    prerequisites: z.array(z.string()).optional(),\n    outcome: z.string(),\n  })),\n  complexity: z.enum([\"trivial\", \"moderate\", \"complex\", \"expert\"]),\n  timeToCompromise: z.string(),\n  businessImpact: z.string(),\n  evidenceReferences: z.array(z.string()),\n});\n\nexport const remediationStepSchema = z.object({\n  priority: z.number(),\n  findingIds: z.array(z.string()),\n  action: z.string(),\n  rationale: z.string().min(30), // Why this fix matters\n  effort: z.enum([\"low\", \"medium\", \"high\"]),\n  commands: z.array(z.string()).optional(),\n  configChanges: z.string().optional(),\n  toolsRequired: z.array(z.string()).optional(),\n  verificationSteps: z.array(z.string()),\n});\n\nexport const technicalReportV2Schema = z.object({\n  reportType: z.literal(\"technical_v2\"),\n  generatedAt: z.string(),\n  \n  // Full technical narrative\n  attackNarrativeDetailed: z.string().min(300),\n  \n  // Structured findings with evidence\n  findings: z.array(technicalFindingSchema),\n  \n  // Attack path analysis with reasoning\n  attackPathsWithReasoning: z.array(attackPathDetailSchema),\n  \n  // Prioritized remediation\n  prioritizedFixPlan: z.array(remediationStepSchema),\n  \n  // Verification guidance\n  verificationSteps: z.array(z.object({\n    findingId: z.string(),\n    steps: z.array(z.string()),\n    expectedResult: z.string(),\n    tools: z.array(z.string()).optional(),\n  })),\n  \n  // Architecture recommendations\n  architectureRecommendations: z.array(z.object({\n    area: z.string(),\n    currentState: z.string(),\n    recommendedState: z.string(),\n    rationale: z.string(),\n    implementationNotes: z.string().optional(),\n  })).optional(),\n});\n\nexport type TechnicalReportV2 = z.infer<typeof technicalReportV2Schema>;\n\n// ============================================================================\n// COMPLIANCE REPORT V2\n// ============================================================================\n\nexport const controlFailureSchema = z.object({\n  controlId: z.string(),\n  controlName: z.string(),\n  framework: z.string(),\n  operationalExplanation: z.string().min(50), // What this means in practice\n  findingIds: z.array(z.string()),\n  evidenceIds: z.array(z.string()),\n  remediationGuidance: z.string(),\n  compensatingControls: z.string().optional(),\n});\n\nexport const complianceReportV2Schema = z.object({\n  reportType: z.literal(\"compliance_v2\"),\n  generatedAt: z.string(),\n  \n  // Framework summary\n  frameworkSummary: z.object({\n    primaryFramework: z.string(),\n    additionalFrameworks: z.array(z.string()),\n    overallComplianceScore: z.number().min(0).max(100),\n    criticalGaps: z.number(),\n    partialCompliance: z.number(),\n    fullCompliance: z.number(),\n  }),\n  \n  // Control failures with operational context\n  controlFailuresWithOperationalExplanations: z.array(controlFailureSchema),\n  \n  // Evidence mapped to controls\n  evidenceLinks: z.array(z.object({\n    evidenceId: z.string(),\n    controlIds: z.array(z.string()),\n    purpose: z.string(), // What this evidence proves/disproves\n  })),\n  \n  // Audit preparation\n  auditReadinessNotes: z.object({\n    currentReadiness: z.enum([\"not_ready\", \"partially_ready\", \"mostly_ready\", \"audit_ready\"]),\n    keyGaps: z.array(z.string()),\n    recommendedActions: z.array(z.object({\n      action: z.string(),\n      timeline: z.string(),\n      impact: z.string(),\n    })),\n    documentationNeeded: z.array(z.string()),\n  }),\n  \n  // Framework-specific sections\n  frameworkSpecificAnalysis: z.record(z.string(), z.object({\n    requirements: z.array(z.object({\n      requirementId: z.string(),\n      description: z.string(),\n      status: z.enum([\"met\", \"not_met\", \"partially_met\", \"not_applicable\"]),\n      notes: z.string().optional(),\n    })),\n  })).optional(),\n});\n\nexport type ComplianceReportV2 = z.infer<typeof complianceReportV2Schema>;\n\n// ============================================================================\n// EVIDENCE PACKAGE V2\n// ============================================================================\n\nexport const artifactEntrySchema = z.object({\n  id: z.string(),\n  type: z.enum([\"http_capture\", \"log_entry\", \"screenshot\", \"config_file\", \"network_trace\", \"command_output\", \"code_snippet\"]),\n  title: z.string(),\n  description: z.string(),\n  timestamp: z.string().optional(),\n  sourceSystem: z.string().optional(),\n  contentPreview: z.string().optional(),\n  fullContentRef: z.string().optional(), // Reference to stored content\n  chainOfCustody: z.object({\n    collectedAt: z.string(),\n    collectedBy: z.string(),\n    hash: z.string().optional(),\n  }).optional(),\n});\n\nexport const evidencePackageV2Schema = z.object({\n  reportType: z.literal(\"evidence_v2\"),\n  generatedAt: z.string(),\n  \n  // Chronological narrative\n  timelineNarrative: z.string().min(200),\n  \n  // Timeline events\n  timeline: z.array(z.object({\n    timestamp: z.string(),\n    event: z.string(),\n    significance: z.string(),\n    artifactIds: z.array(z.string()),\n  })),\n  \n  // Artifact catalog\n  artifactIndex: z.array(artifactEntrySchema),\n  \n  // What each artifact proves\n  whatEachArtifactProves: z.array(z.object({\n    artifactId: z.string(),\n    proves: z.array(z.string()), // List of claims this artifact supports\n    relatedFindings: z.array(z.string()),\n    significance: z.enum([\"critical\", \"supporting\", \"contextual\"]),\n  })),\n  \n  // Evidence summary statistics\n  evidenceSummary: z.object({\n    totalArtifacts: z.number(),\n    byType: z.record(z.string(), z.number()),\n    timespan: z.object({\n      earliest: z.string(),\n      latest: z.string(),\n    }).optional(),\n  }),\n});\n\nexport type EvidencePackageV2 = z.infer<typeof evidencePackageV2Schema>;\n\n// ============================================================================\n// COMBINED REPORT V2\n// ============================================================================\n\nexport const fullReportV2Schema = z.object({\n  id: z.string(),\n  version: z.literal(\"2.0\"),\n  generatedAt: z.string(),\n  \n  // Report sections\n  executive: executiveReportV2Schema.optional(),\n  technical: technicalReportV2Schema.optional(),\n  compliance: complianceReportV2Schema.optional(),\n  evidence: evidencePackageV2Schema.optional(),\n  \n  // Metadata\n  metadata: z.object({\n    evaluationIds: z.array(z.string()),\n    organizationId: z.string(),\n    reportTitle: z.string(),\n    dateRange: z.object({\n      from: z.string(),\n      to: z.string(),\n    }).optional(),\n  }),\n});\n\nexport type FullReportV2 = z.infer<typeof fullReportV2Schema>;\n\n// Export a dummy to satisfy the import in reportInputBuilder\nexport type ReportV2Input = {\n  placeholder: true;\n};\n","path":null,"size_bytes":9655,"size_tokens":null},"server/src/reportsV2/tests/fixtures/iam-abuse.fixture.ts":{"content":"/**\n * IAM Abuse Test Fixture\n * \n * Simulates a privilege escalation attack through misconfigured AWS IAM roles.\n * Tests the V2 narrative engine's ability to construct coherent attack stories\n * for identity-based vulnerabilities.\n */\n\nimport type { TestEvaluation, TestResult, TestFixture } from \"./test-data.types\";\n\nexport const iamAbuseEvaluation: TestEvaluation = {\n  id: \"eval-iam-001\",\n  assetId: \"asset-aws-lambda-001\",\n  assetName: \"aws-iam-role-lambda-executor\",\n  assetType: \"cloud_iam\",\n  exposureType: \"iam_misconfiguration\",\n  description: `AWS Lambda execution role with overly permissive IAM policy allowing sts:AssumeRole on wildcard resources. \n    Role ARN: arn:aws:iam::123456789012:role/LambdaExecutorRole\n    Attached Policy: arn:aws:iam::123456789012:policy/LambdaFullAccess\n    Issue: Policy grants iam:PassRole and sts:AssumeRole with Resource: \"*\"\n    Discovery: Automated IAM policy analyzer flagged during routine audit`,\n  priority: \"critical\",\n  status: \"completed\",\n  organizationId: \"test-org-001\",\n  createdAt: new Date(\"2024-12-15T10:30:00Z\"),\n  updatedAt: new Date(\"2024-12-15T14:45:00Z\"),\n};\n\nexport const iamAbuseResult: TestResult = {\n  id: \"result-iam-001\",\n  evaluationId: \"eval-iam-001\",\n  exploitable: true,\n  confidence: 92,\n  score: 92,\n  \n  attackPath: [\n    {\n      id: 1,\n      title: \"Initial Lambda Access\",\n      description: \"Attacker invokes Lambda function via public API Gateway endpoint\",\n      technique: \"T1078.004\",\n      severity: \"high\",\n      order: 1,\n      targetAsset: \"api-gateway-prod\",\n      tools: [\"curl\", \"aws-cli\"],\n    },\n    {\n      id: 2,\n      title: \"Role Assumption\",\n      description: \"Lambda execution role has sts:AssumeRole with Resource: '*'\",\n      technique: \"T1548.005\",\n      severity: \"critical\",\n      order: 2,\n      targetAsset: \"LambdaExecutorRole\",\n      tools: [\"aws-cli\"],\n    },\n    {\n      id: 3,\n      title: \"Admin Privilege Escalation\",\n      description: \"Attacker assumes OrganizationAccountAccessRole for full admin access\",\n      technique: \"T1098.001\",\n      severity: \"critical\",\n      order: 3,\n      targetAsset: \"OrganizationAccountAccessRole\",\n      tools: [\"aws-cli\", \"pacu\"],\n    },\n    {\n      id: 4,\n      title: \"Account Enumeration\",\n      description: \"Enumerate all IAM users, roles, and policies in the account\",\n      technique: \"T1087.004\",\n      severity: \"high\",\n      order: 4,\n      targetAsset: \"aws-iam\",\n      tools: [\"aws-cli\", \"enumerate-iam\"],\n    },\n  ],\n  \n  impact: `The IAM misconfiguration is highly exploitable due to wildcard resource permissions allowing role assumption to any role in the account. An attacker with initial access to the Lambda function can escalate to AdministratorAccess by assuming the OrganizationAccountAccessRole. This represents a complete cloud account compromise enabling data exfiltration, resource abuse, and potential ransomware deployment.`,\n  \n  recommendations: [\n    {\n      id: \"rec-iam-001\",\n      title: \"Implement least-privilege IAM policies\",\n      description: \"Replace wildcard Resource permissions with specific ARNs. Remove sts:AssumeRole unless explicitly required.\",\n      priority: \"critical\",\n      type: \"remediation\",\n      effort: \"medium\",\n      timeline: \"48 hours\",\n    },\n    {\n      id: \"rec-iam-002\",\n      title: \"Add IAM permission boundaries\",\n      description: \"Create and attach permission boundaries to all Lambda execution roles to prevent privilege escalation.\",\n      priority: \"high\",\n      type: \"preventive\",\n      effort: \"medium\",\n      timeline: \"1 week\",\n    },\n    {\n      id: \"rec-iam-003\",\n      title: \"Enable AWS CloudTrail with alerting\",\n      description: \"Configure real-time alerts for sts:AssumeRole events targeting high-privilege roles.\",\n      priority: \"medium\",\n      type: \"compensating\",\n      effort: \"low\",\n      timeline: \"24 hours\",\n    },\n    {\n      id: \"rec-iam-004\",\n      title: \"Implement SCP guardrails\",\n      description: \"Deploy Service Control Policies at the organization level to prevent role assumption outside trusted boundaries.\",\n      priority: \"high\",\n      type: \"preventive\",\n      effort: \"high\",\n      timeline: \"2 weeks\",\n    },\n  ],\n  \n  evidenceArtifacts: [\n    {\n      id: \"ev-iam-001\",\n      type: \"policy_document\",\n      title: \"Overpermissive IAM Policy\",\n      description: \"IAM policy JSON showing wildcard permissions\",\n      content: `{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"sts:AssumeRole\",\n        \"iam:PassRole\"\n      ],\n      \"Resource\": \"*\"\n    }\n  ]\n}`,\n    },\n    {\n      id: \"ev-iam-002\",\n      type: \"cloudtrail_log\",\n      title: \"Role Assumption Event\",\n      description: \"CloudTrail event showing successful role assumption\",\n      content: `{\n  \"eventName\": \"AssumeRole\",\n  \"eventSource\": \"sts.amazonaws.com\",\n  \"userIdentity\": {\n    \"type\": \"AssumedRole\",\n    \"arn\": \"arn:aws:sts::123456789012:assumed-role/LambdaExecutorRole/lambda-function\"\n  },\n  \"requestParameters\": {\n    \"roleArn\": \"arn:aws:iam::123456789012:role/OrganizationAccountAccessRole\"\n  },\n  \"responseElements\": {\n    \"credentials\": {\n      \"accessKeyId\": \"ASIAXXX...\"\n    }\n  }\n}`,\n    },\n  ],\n  \n  completedAt: new Date(\"2024-12-15T14:45:00Z\"),\n};\n\nexport const iamAbuseFixture: TestFixture = {\n  evaluation: iamAbuseEvaluation,\n  result: iamAbuseResult,\n  expectedNarrativeElements: [\n    \"privilege escalation\",\n    \"Lambda execution role\",\n    \"wildcard permissions\",\n    \"OrganizationAccountAccessRole\",\n    \"sts:AssumeRole\",\n  ],\n};\n","path":null,"size_bytes":5556,"size_tokens":null},"server/src/reportsV2/tests/fixtures/payment-bypass.fixture.ts":{"content":"/**\n * Payment Bypass Test Fixture\n * \n * Simulates a business logic vulnerability allowing price manipulation\n * and payment bypass in an e-commerce checkout flow.\n */\n\nimport type { TestEvaluation, TestResult, TestFixture } from \"./test-data.types\";\n\nexport const paymentBypassEvaluation: TestEvaluation = {\n  id: \"eval-payment-001\",\n  assetId: \"asset-checkout-api-001\",\n  assetName: \"checkout-api.acmecorp.com\",\n  assetType: \"web_application\",\n  exposureType: \"business_logic_flaw\",\n  description: `Critical business logic flaw in checkout API allowing client-side price manipulation.\n    Endpoint: POST /api/v2/checkout/process\n    Issue: Cart total calculated client-side and trusted by server without validation\n    Impact: Attackers can purchase items at arbitrary prices including $0\n    Discovery: Penetration test during pre-launch security review`,\n  priority: \"critical\",\n  status: \"completed\",\n  organizationId: \"test-org-001\",\n  createdAt: new Date(\"2024-12-10T09:00:00Z\"),\n  updatedAt: new Date(\"2024-12-10T16:30:00Z\"),\n};\n\nexport const paymentBypassResult: TestResult = {\n  id: \"result-payment-001\",\n  evaluationId: \"eval-payment-001\",\n  exploitable: true,\n  confidence: 98,\n  score: 98,\n  \n  attackPath: [\n    {\n      id: 1,\n      title: \"Intercept Checkout Request\",\n      description: \"Intercept checkout request using browser developer tools or proxy\",\n      technique: \"T1190\",\n      severity: \"medium\",\n      order: 1,\n      targetAsset: \"checkout-api\",\n      tools: [\"burp-suite\", \"browser-devtools\"],\n    },\n    {\n      id: 2,\n      title: \"Manipulate Cart Total\",\n      description: \"Modify cart.total field from $5000.00 to $0.01 in POST request\",\n      technique: \"T1565.002\",\n      severity: \"critical\",\n      order: 2,\n      targetAsset: \"checkout-api\",\n      tools: [\"burp-suite\"],\n    },\n    {\n      id: 3,\n      title: \"Complete Fraudulent Purchase\",\n      description: \"Complete checkout with manipulated price, receiving merchandise at fraudulent price\",\n      technique: \"T1657\",\n      severity: \"critical\",\n      order: 3,\n      targetAsset: \"payment-processor\",\n      tools: [\"browser\"],\n    },\n  ],\n  \n  impact: `This vulnerability is trivially exploitable with no authentication bypass required. Cart total is calculated in JavaScript and sent to server which trusts the submitted total without recalculating from item prices. Stripe payment intent created with attacker-controlled amount. Successful payment of $0.01 processes order for $5000 in merchandise. Estimated $2M+ monthly exposure based on transaction volume.`,\n  \n  recommendations: [\n    {\n      id: \"rec-payment-001\",\n      title: \"Server-side cart calculation\",\n      description: \"Always recalculate cart totals on the server using item prices from the database. Never trust client-submitted totals.\",\n      priority: \"critical\",\n      type: \"remediation\",\n      effort: \"medium\",\n      timeline: \"72 hours\",\n    },\n    {\n      id: \"rec-payment-002\",\n      title: \"Implement cart signing\",\n      description: \"Sign cart contents with HMAC to detect tampering. Verify signature server-side before processing.\",\n      priority: \"high\",\n      type: \"preventive\",\n      effort: \"medium\",\n      timeline: \"1 week\",\n    },\n    {\n      id: \"rec-payment-003\",\n      title: \"Add quantity validation\",\n      description: \"Reject negative quantities and enforce reasonable maximum quantities per item.\",\n      priority: \"high\",\n      type: \"remediation\",\n      effort: \"low\",\n      timeline: \"24 hours\",\n    },\n    {\n      id: \"rec-payment-004\",\n      title: \"Implement fraud detection\",\n      description: \"Deploy anomaly detection for orders with unusual price-to-item ratios.\",\n      priority: \"medium\",\n      type: \"compensating\",\n      effort: \"high\",\n      timeline: \"1 month\",\n    },\n  ],\n  \n  evidenceArtifacts: [\n    {\n      id: \"ev-payment-001\",\n      type: \"http_request\",\n      title: \"Original Checkout Request\",\n      description: \"Original checkout request with legitimate total\",\n      content: `POST /api/v2/checkout/process HTTP/1.1\nHost: checkout-api.acmecorp.com\nContent-Type: application/json\n\n{\n  \"cartId\": \"cart_abc123\",\n  \"items\": [\n    {\"sku\": \"LAPTOP-PRO\", \"quantity\": 1, \"price\": 2499.99},\n    {\"sku\": \"MONITOR-4K\", \"quantity\": 2, \"price\": 899.99}\n  ],\n  \"total\": 4299.97,\n  \"paymentMethod\": \"card_xyz789\"\n}`,\n    },\n    {\n      id: \"ev-payment-002\",\n      type: \"http_request\",\n      title: \"Manipulated Checkout Request\",\n      description: \"Manipulated checkout request with $0.01 total\",\n      content: `POST /api/v2/checkout/process HTTP/1.1\nHost: checkout-api.acmecorp.com\nContent-Type: application/json\n\n{\n  \"cartId\": \"cart_abc123\",\n  \"items\": [\n    {\"sku\": \"LAPTOP-PRO\", \"quantity\": 1, \"price\": 2499.99},\n    {\"sku\": \"MONITOR-4K\", \"quantity\": 2, \"price\": 899.99}\n  ],\n  \"total\": 0.01,\n  \"paymentMethod\": \"card_xyz789\"\n}`,\n    },\n    {\n      id: \"ev-payment-003\",\n      type: \"http_response\",\n      title: \"Fraudulent Order Confirmation\",\n      description: \"Successful order confirmation at fraudulent price\",\n      content: `HTTP/1.1 200 OK\nContent-Type: application/json\n\n{\n  \"orderId\": \"ORD-2024-78901\",\n  \"status\": \"confirmed\",\n  \"chargedAmount\": 0.01,\n  \"items\": 3,\n  \"shippingAddress\": \"...\"\n}`,\n    },\n  ],\n  \n  completedAt: new Date(\"2024-12-10T16:30:00Z\"),\n};\n\nexport const paymentBypassFixture: TestFixture = {\n  evaluation: paymentBypassEvaluation,\n  result: paymentBypassResult,\n  expectedNarrativeElements: [\n    \"business logic\",\n    \"price manipulation\",\n    \"client-side\",\n    \"checkout\",\n    \"payment bypass\",\n    \"server-side validation\",\n  ],\n};\n","path":null,"size_bytes":5594,"size_tokens":null},"server/src/reportsV2/prompts/eno.user.md":{"content":"# ENO Generation Task\n\nBased on the following security assessment data, generate an Engagement Narrative Object (ENO) that captures the complete story of this security engagement.\n\n## Input Data\n\n```json\n{{INPUT_DATA}}\n```\n\n## Your Task\n\nAnalyze the assessment data and generate a comprehensive ENO that tells the story of what was found, why it matters, and what should be done about it.\n\n## Required Output Structure\n\nGenerate a valid JSON object with these sections:\n\n### 1. engagementOverview\n- `scope`: Describe what was assessed (50+ chars)\n- `objectives`: Array of assessment objectives\n- `methodology`: Describe the testing approach used\n- `timeframe`: Object with `start` and `end` ISO dates\n- `assetsAssessed`: Array of assets with id, name, type, criticality\n- `overallRiskLevel`: \"critical\" | \"high\" | \"medium\" | \"low\"\n- `keyHighlights`: Array of 3-5 key findings/observations\n- `confidence`: 0-1 confidence score\n\n### 2. attackStory\nArray of attack story segments, each with:\n- `phase`: MITRE ATT&CK phase (initial_access, execution, persistence, etc.)\n- `narrative`: Detailed narrative of what happened in this phase (50+ chars)\n- `techniques`: Array of technique names used\n- `evidenceRefs`: Array of evidence IDs that support this\n- `complexity`: \"trivial\" | \"moderate\" | \"complex\" | \"expert\"\n- `confidence`: 0-1 confidence score\n\n### 3. businessImpactAnalysis\n- `executiveSummary`: 2-3 paragraph summary for executives (100+ chars)\n- `primaryRisks`: Array of risks with title, description, affectedBusinessProcess, potentialConsequences, estimatedFinancialImpact\n- `operationalImpact`: Description of operational impact\n- `reputationalImpact`: Description of reputational impact\n- `regulatoryImpact`: (optional) Regulatory impact\n- `confidence`: 0-1 confidence score\n\n### 4. defensiveGaps\nArray of gaps with:\n- `category`: \"detection\" | \"prevention\" | \"response\" | \"recovery\" | \"visibility\" | \"process\" | \"training\"\n- `title`: Short title\n- `description`: What the gap is (30+ chars)\n- `affectedAssets`: Array of affected asset IDs\n- `exploitedInAttack`: Boolean - was this gap exploited?\n- `remediationEffort`: \"low\" | \"medium\" | \"high\"\n- `confidence`: 0-1 confidence score\n\n### 5. riskPrioritizationLogic\nArray of prioritized findings:\n- `findingId`: Reference to finding\n- `priority`: Numeric priority (1 = highest)\n- `businessImpact`: Description of business impact (20+ chars)\n- `exploitLikelihood`: \"certain\" | \"highly_likely\" | \"likely\" | \"possible\" | \"unlikely\"\n- `blastRadius`: Description of what could be affected\n- `financialExposure`: (optional) Estimated financial exposure\n- `rationale`: Why this priority was assigned (50+ chars)\n- `confidence`: 0-1 confidence score\n\n### 6. overallAssessment\n- `verdict`: \"critical\" | \"high\" | \"medium\" | \"low\"\n- `verdictNarrative`: Explanation of the overall verdict (100+ chars)\n- `strengthsObserved`: Array of security strengths observed\n- `criticalWeaknesses`: Array of critical weaknesses\n- `immediateActions`: Array with action, priority (\"immediate\" | \"short_term\" | \"medium_term\"), effort, expectedImpact\n- `strategicRecommendations`: Array with recommendation, rationale, timeframe\n- `confidence`: 0-1 confidence score\n\n### 7. evidenceIndex\nArray of evidence references:\n- `id`: Unique evidence ID\n- `type`: \"http_capture\" | \"log_entry\" | \"screenshot\" | \"config_file\" | \"network_trace\" | \"command_output\"\n- `description`: What this evidence shows\n- `timestamp`: (optional) When it was captured\n- `relevance`: Why this evidence matters\n\n## Quality Requirements\n\n1. **Be specific**: Reference actual assets, findings, and data from the input\n2. **Tell a story**: Attack phases should flow logically\n3. **Quantify impact**: Use numbers where possible\n4. **Anchor to evidence**: Every major claim should reference evidence\n5. **Vary confidence**: Not everything is 1.0 confidence - be honest about uncertainty\n","path":null,"size_bytes":3882,"size_tokens":null},"server/feature-flags.ts":{"content":"/**\n * Feature Flags for OdinForge Platform\n * \n * Centralized feature flag management with environment variable overrides\n * and per-tenant configuration support.\n */\n\nexport interface FeatureFlags {\n  /** Enable Report V2 Narrative generation (AI-powered pentest reports) */\n  REPORTS_V2_NARRATIVE: boolean;\n}\n\n/** Default feature flag values (production-safe defaults) */\nconst defaultFlags: FeatureFlags = {\n  REPORTS_V2_NARRATIVE: false,\n};\n\n/** Per-tenant feature flag overrides */\nconst tenantOverrides: Map<string, Partial<FeatureFlags>> = new Map();\n\n/**\n * Get all feature flags for a given tenant\n * Priority: Environment variables > Tenant overrides > Defaults\n */\nexport function getFeatureFlags(tenantId?: string): FeatureFlags {\n  const flags = { ...defaultFlags };\n  \n  // Apply environment variable overrides\n  if (process.env.REPORTS_V2_NARRATIVE === \"true\") {\n    flags.REPORTS_V2_NARRATIVE = true;\n  }\n  \n  // Apply tenant-specific overrides if available\n  if (tenantId && tenantOverrides.has(tenantId)) {\n    const overrides = tenantOverrides.get(tenantId)!;\n    Object.assign(flags, overrides);\n  }\n  \n  return flags;\n}\n\n/**\n * Check if a specific feature is enabled\n */\nexport function isFeatureEnabled(\n  feature: keyof FeatureFlags,\n  tenantId?: string\n): boolean {\n  return getFeatureFlags(tenantId)[feature];\n}\n\n/**\n * Set per-tenant feature flag overrides (for admin configuration)\n */\nexport function setTenantFeatureOverride(\n  tenantId: string,\n  feature: keyof FeatureFlags,\n  enabled: boolean\n): void {\n  const current = tenantOverrides.get(tenantId) || {};\n  current[feature] = enabled;\n  tenantOverrides.set(tenantId, current);\n}\n\n/**\n * Remove per-tenant feature flag override\n */\nexport function removeTenantFeatureOverride(\n  tenantId: string,\n  feature: keyof FeatureFlags\n): void {\n  const current = tenantOverrides.get(tenantId);\n  if (current) {\n    delete current[feature];\n    if (Object.keys(current).length === 0) {\n      tenantOverrides.delete(tenantId);\n    }\n  }\n}\n\n/**\n * Get all tenant overrides (for admin dashboard)\n */\nexport function getAllTenantOverrides(): Record<string, Partial<FeatureFlags>> {\n  const result: Record<string, Partial<FeatureFlags>> = {};\n  tenantOverrides.forEach((value, key) => {\n    result[key] = value;\n  });\n  return result;\n}\n","path":null,"size_bytes":2308,"size_tokens":null},"server/src/reportsV2/tests/fixtures/multi-vector.fixture.ts":{"content":"/**\n * Multi-Vector Attack Test Fixture\n * \n * Simulates a complex attack chain combining SQL injection, credential theft,\n * lateral movement, and data exfiltration. Tests the narrative engine's ability\n * to construct coherent stories from multi-stage attacks.\n */\n\nimport type { TestEvaluation, TestResult, TestFixture } from \"./test-data.types\";\n\nexport const multiVectorEvaluation: TestEvaluation = {\n  id: \"eval-multi-001\",\n  assetId: \"asset-legacy-crm-001\",\n  assetName: \"legacy-crm.internal.corp\",\n  assetType: \"web_application\",\n  exposureType: \"sql_injection\",\n  description: `SQL injection vulnerability in legacy CRM search functionality leading to full database compromise.\n    Endpoint: GET /api/customers/search?q=\n    Database: PostgreSQL 12.4 with customer PII and payment data\n    Issue: Unsanitized user input directly concatenated into SQL query\n    Compounding factors: Database user has DBA privileges, credentials stored in same database\n    Discovery: Automated vulnerability scan flagged error-based SQLi`,\n  priority: \"critical\",\n  status: \"completed\",\n  organizationId: \"test-org-001\",\n  createdAt: new Date(\"2024-12-08T08:00:00Z\"),\n  updatedAt: new Date(\"2024-12-09T18:00:00Z\"),\n};\n\nexport const multiVectorResult: TestResult = {\n  id: \"result-multi-001\",\n  evaluationId: \"eval-multi-001\",\n  exploitable: true,\n  confidence: 95,\n  score: 95,\n  \n  attackPath: [\n    {\n      id: 1,\n      title: \"SQL Injection Discovery\",\n      description: \"Inject SQL payload in search parameter to extract database schema\",\n      technique: \"T1190\",\n      severity: \"high\",\n      order: 1,\n      targetAsset: \"legacy-crm\",\n      tools: [\"sqlmap\", \"burp-suite\"],\n    },\n    {\n      id: 2,\n      title: \"Credential Extraction\",\n      description: \"Extract admin credentials from users table via UNION-based injection\",\n      technique: \"T1005\",\n      severity: \"critical\",\n      order: 2,\n      targetAsset: \"postgres-db\",\n      tools: [\"sqlmap\"],\n    },\n    {\n      id: 3,\n      title: \"Password Cracking\",\n      description: \"Crack MD5 password hashes using rainbow tables\",\n      technique: \"T1110.002\",\n      severity: \"high\",\n      order: 3,\n      targetAsset: \"offline\",\n      tools: [\"hashcat\", \"john\"],\n    },\n    {\n      id: 4,\n      title: \"Admin Panel Access\",\n      description: \"Authenticate to internal admin panel with cracked credentials\",\n      technique: \"T1078.003\",\n      severity: \"critical\",\n      order: 4,\n      targetAsset: \"admin-panel\",\n      tools: [\"browser\"],\n    },\n    {\n      id: 5,\n      title: \"Cloud Credentials Discovery\",\n      description: \"Discover AWS credentials in admin panel configuration export\",\n      technique: \"T1552.001\",\n      severity: \"critical\",\n      order: 5,\n      targetAsset: \"admin-panel\",\n      tools: [\"browser\"],\n    },\n    {\n      id: 6,\n      title: \"Data Exfiltration\",\n      description: \"Access S3 buckets and exfiltrate customer database backups\",\n      technique: \"T1537\",\n      severity: \"critical\",\n      order: 6,\n      targetAsset: \"s3-customer-data\",\n      tools: [\"aws-cli\"],\n    },\n  ],\n  \n  impact: `The SQL injection vulnerability enables a complete attack chain from initial access to data exfiltration. Error-based SQLi reveals database structure and version. Union-based extraction of admin credentials from users table. Password hashes cracked offline (MD5 without salt). Admin credentials provide access to internal tools containing AWS keys enabling cloud pivot. S3 bucket access reveals 500,000+ customer records with PII and payment data. Estimated breach cost: $75M-100M total exposure.`,\n  \n  recommendations: [\n    {\n      id: \"rec-multi-001\",\n      title: \"Parameterize all SQL queries\",\n      description: \"Replace string concatenation with parameterized queries or prepared statements throughout the application.\",\n      priority: \"critical\",\n      type: \"remediation\",\n      effort: \"high\",\n      timeline: \"1 week\",\n    },\n    {\n      id: \"rec-multi-002\",\n      title: \"Rotate all credentials\",\n      description: \"Immediately rotate database credentials, admin passwords, and AWS keys. Assume all credentials in the database are compromised.\",\n      priority: \"critical\",\n      type: \"remediation\",\n      effort: \"medium\",\n      timeline: \"24 hours\",\n    },\n    {\n      id: \"rec-multi-003\",\n      title: \"Implement proper password hashing\",\n      description: \"Replace MD5 with bcrypt or Argon2. Enforce password complexity and implement MFA for admin accounts.\",\n      priority: \"high\",\n      type: \"remediation\",\n      effort: \"medium\",\n      timeline: \"1 week\",\n    },\n    {\n      id: \"rec-multi-004\",\n      title: \"Apply least-privilege database access\",\n      description: \"Remove DBA privileges from application database user. Create separate read-only and read-write database accounts.\",\n      priority: \"high\",\n      type: \"preventive\",\n      effort: \"medium\",\n      timeline: \"3 days\",\n    },\n    {\n      id: \"rec-multi-005\",\n      title: \"Deploy WAF with SQLi rules\",\n      description: \"Implement Web Application Firewall with SQL injection detection rules as defense-in-depth.\",\n      priority: \"medium\",\n      type: \"compensating\",\n      effort: \"low\",\n      timeline: \"48 hours\",\n    },\n  ],\n  \n  evidenceArtifacts: [\n    {\n      id: \"ev-multi-001\",\n      type: \"http_request\",\n      title: \"SQL Injection Probe\",\n      description: \"Initial SQLi probe revealing error-based injection\",\n      content: `GET /api/customers/search?q=test'+OR+1=1--+ HTTP/1.1\nHost: legacy-crm.internal.corp\n\nResponse: 500 Internal Server Error\nERROR: syntax error at or near \"+\" at character 42\nQUERY: SELECT * FROM customers WHERE name LIKE '%test'+OR+1=1--+'%'`,\n    },\n    {\n      id: \"ev-multi-002\",\n      type: \"sql_output\",\n      title: \"Extracted Admin Credentials\",\n      description: \"Extracted admin credentials via UNION injection\",\n      content: `Username: admin@corp.internal\nPassword Hash: 5f4dcc3b5aa765d61d8327deb882cf99 (MD5: password)\nRole: superadmin\nCreated: 2019-03-15`,\n    },\n    {\n      id: \"ev-multi-003\",\n      type: \"configuration\",\n      title: \"AWS Credentials in Config\",\n      description: \"AWS credentials found in admin panel export\",\n      content: `[production]\naws_access_key_id = AKIAIOSFODNN7EXAMPLE\naws_secret_access_key = wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY\nregion = us-east-1\ns3_bucket = corp-customer-backups`,\n    },\n    {\n      id: \"ev-multi-004\",\n      type: \"data_sample\",\n      title: \"Exfiltrated Customer Records\",\n      description: \"Sample of exfiltrated customer records from S3\",\n      content: `customer_id,name,email,ssn_last4,card_last4,card_expiry\n100001,John Smith,jsmith@email.com,1234,4242,12/26\n100002,Jane Doe,jdoe@email.com,5678,1111,03/25\n[... 499,998 additional records ...]`,\n    },\n  ],\n  \n  completedAt: new Date(\"2024-12-09T18:00:00Z\"),\n};\n\nexport const multiVectorFixture: TestFixture = {\n  evaluation: multiVectorEvaluation,\n  result: multiVectorResult,\n  expectedNarrativeElements: [\n    \"SQL injection\",\n    \"credential theft\",\n    \"lateral movement\",\n    \"cloud pivot\",\n    \"data exfiltration\",\n    \"attack chain\",\n    \"MD5\",\n    \"parameterized queries\",\n  ],\n};\n","path":null,"size_bytes":7144,"size_tokens":null},"server/src/reportsV2/prompts/compliance.user.md":{"content":"# Compliance Report Generation Task\n\nGenerate a compliance report based on the following ENO and assessment data.\n\n## ENO (Engagement Narrative Object)\n\n```json\n{{ENO}}\n```\n\n## Raw Assessment Data\n\n```json\n{{INPUT_DATA}}\n```\n\n## Your Task\n\nMap the security findings to compliance framework requirements and provide audit-ready documentation.\n\n## Required Output Structure\n\nGenerate a valid JSON object with:\n\n### reportType\nMust be: `\"compliance_v2\"`\n\n### generatedAt\nISO timestamp of generation\n\n### frameworkSummary\nOverview of compliance posture:\n- `primaryFramework`: Main framework assessed (e.g., \"SOC 2 Type II\", \"PCI-DSS v4.0\")\n- `additionalFrameworks`: Array of other applicable frameworks\n- `overallComplianceScore`: 0-100 score\n- `criticalGaps`: Count of critical control gaps\n- `partialCompliance`: Count of partially compliant controls\n- `fullCompliance`: Count of fully compliant controls\n\n### controlFailuresWithOperationalExplanations\nArray of failed controls, each with:\n- `controlId`: Control identifier (e.g., \"CC6.1\", \"PCI-DSS 6.2.4\")\n- `controlName`: Human-readable control name\n- `framework`: Framework this control belongs to\n- `operationalExplanation`: What this means in practice (50+ chars)\n- `findingIds`: Array of finding IDs that caused failure\n- `evidenceIds`: Array of evidence IDs demonstrating the gap\n- `remediationGuidance`: How to achieve compliance\n- `compensatingControls`: (optional) Alternative controls if direct fix isn't possible\n\n### evidenceLinks\nArray mapping evidence to controls:\n- `evidenceId`: Evidence identifier\n- `controlIds`: Array of controls this evidence relates to\n- `purpose`: What this evidence proves or disproves\n\n### auditReadinessNotes\nAudit preparation guidance:\n- `currentReadiness`: \"not_ready\" | \"partially_ready\" | \"mostly_ready\" | \"audit_ready\"\n- `keyGaps`: Array of gaps that would fail an audit\n- `recommendedActions`: Array with action, timeline, impact\n- `documentationNeeded`: Array of documentation to prepare\n\n### frameworkSpecificAnalysis (optional)\nObject keyed by framework name, each containing:\n- `requirements`: Array with requirementId, description, status (\"met\" | \"not_met\" | \"partially_met\" | \"not_applicable\"), notes (optional)\n\n## Framework Mapping Guidelines\n\n### SOC 2 Trust Service Criteria\n- CC1.x: Control Environment\n- CC2.x: Communication and Information\n- CC3.x: Risk Assessment\n- CC4.x: Monitoring Activities\n- CC5.x: Control Activities\n- CC6.x: Logical and Physical Access\n- CC7.x: System Operations\n- CC8.x: Change Management\n- CC9.x: Risk Mitigation\n\n### PCI-DSS v4.0 Requirements\n- Req 1-2: Network Security\n- Req 3-4: Data Protection\n- Req 5-6: Vulnerability Management\n- Req 7-8: Access Control\n- Req 9-10: Physical/Monitoring\n- Req 11-12: Testing/Policies\n\n### HIPAA Safeguards\n- Administrative Safeguards\n- Physical Safeguards\n- Technical Safeguards\n\n## Quality Requirements\n\n1. Cite specific control requirements, not general categories\n2. Explain gaps in operational terms\n3. Provide actionable remediation guidance\n4. Consider audit timelines in recommendations\n5. Include compensating controls where appropriate\n","path":null,"size_bytes":3122,"size_tokens":null},"server/src/reportsV2/promptLoader.ts":{"content":"/**\n * Prompt Loader\n * \n * Loads prompt files from the prompts directory.\n * Prompts are stored as markdown files for easy editing without code changes.\n */\n\nimport { readFileSync } from \"fs\";\nimport { join, dirname } from \"path\";\nimport { fileURLToPath } from \"url\";\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\nconst PROMPTS_DIR = join(__dirname, \"prompts\");\n\n// Cache for loaded prompts\nconst promptCache: Map<string, string> = new Map();\n\n/**\n * Load a prompt file by name\n * @param name - Prompt name without extension (e.g., \"leadPentester.system\")\n */\nexport function loadPrompt(name: string): string {\n  if (promptCache.has(name)) {\n    return promptCache.get(name)!;\n  }\n  \n  try {\n    const filePath = join(PROMPTS_DIR, `${name}.md`);\n    const content = readFileSync(filePath, \"utf-8\");\n    promptCache.set(name, content);\n    return content;\n  } catch (error) {\n    // Return fallback prompts if file not found\n    return getFallbackPrompt(name);\n  }\n}\n\n/**\n * Clear prompt cache (useful for hot reloading)\n */\nexport function clearPromptCache(): void {\n  promptCache.clear();\n}\n\n/**\n * Get anti-template rules that apply to all prompts\n */\nexport function getAntiTemplateRules(): string {\n  return `\n## CRITICAL OUTPUT REQUIREMENTS\n\nYou must follow these rules to produce human-grade, non-templated output:\n\n1. **NO BULLET-ONLY OUTPUT**: Do not produce lists of bullets without narrative context. Each point must have explanation and reasoning.\n\n2. **EXPLAIN REASONING AND TRADEOFFS**: For every recommendation, explain WHY it matters and what tradeoffs exist. A security professional reading this should understand your thought process.\n\n3. **AVOID GENERIC PHRASES**: Never use these templated phrases:\n   - \"Overall risk is high due to...\"\n   - \"It is recommended that...\"\n   - \"The organization should consider...\"\n   - \"Based on our assessment...\"\n   - \"Best practices suggest...\"\n   - \"Industry standards recommend...\"\n   \n4. **ANCHOR TO EVIDENCE**: Every claim must reference specific findings or evidence. Use phrases like:\n   - \"The exposed S3 bucket (Finding #3) combined with...\"\n   - \"Given the unpatched CVE-2024-1234 on the payment server...\"\n   - \"The authentication bypass we demonstrated shows...\"\n\n5. **WRITE LIKE A HUMAN CONSULTANT**: Imagine you are a senior security consultant presenting to a client. Be direct, specific, and conversational. Use \"we found\" not \"it was found\". Use \"your team should\" not \"the organization should\".\n\n6. **SITUATION-SPECIFIC LANGUAGE**: Reference the actual target environment, business context, and specific assets. Never produce content that could apply to any generic organization.\n\n7. **QUANTIFY IMPACT**: Where possible, express risk in concrete terms:\n   - \"This could expose 50,000 customer records...\"\n   - \"Based on the 3-step attack chain, exploitation takes approximately 2 hours...\"\n   - \"Similar breaches have resulted in regulatory fines averaging $2M...\"\n`;\n}\n\n/**\n * Fallback prompts when files are not found\n */\nfunction getFallbackPrompt(name: string): string {\n  const fallbacks: Record<string, string> = {\n    \"leadPentester.system\": `You are a lead penetration tester with 15+ years of experience conducting security assessments for Fortune 500 companies. You write authoritative, evidence-based reports that demonstrate deep technical understanding while remaining accessible to security teams.\n\nYour writing style:\n- Direct and confident, never hedging\n- Technical but not academic\n- Evidence-driven with specific citations\n- Actionable recommendations with clear rationale\n- Conversational but professional\n\nWhen analyzing findings, you:\n- Connect individual vulnerabilities into attack narratives\n- Identify the most impactful attack paths\n- Prioritize based on real-world exploitability, not just CVSS scores\n- Consider the specific business context and threat model`,\n\n    \"executiveAdvisor.system\": `You are a senior security advisor who regularly briefs C-suite executives and board members on cybersecurity risk. You translate technical findings into business impact and strategic recommendations.\n\nYour communication style:\n- Clear, jargon-free language\n- Focus on business outcomes and risk\n- Concrete financial and operational impacts\n- Actionable strategic recommendations\n- Forward-looking guidance\n\nYou never:\n- Bury the lead with technical details\n- Use fear-based language\n- Provide vague or generic recommendations\n- Ignore the organization's specific context`,\n\n    \"seniorEngineer.system\": `You are a senior security engineer who has led remediation efforts at major tech companies. You write technical documentation that security teams can immediately act upon.\n\nYour documentation style:\n- Step-by-step remediation guidance\n- Code examples where helpful\n- Tool recommendations with specific versions\n- Verification steps to confirm fixes\n- Prioritization based on actual risk reduction\n\nYou focus on:\n- Practical, implementable fixes\n- Root cause analysis\n- Defensive architecture improvements\n- Detection and monitoring recommendations`,\n\n    \"complianceAssessor.system\": `You are a compliance specialist with expertise in SOC 2, PCI-DSS, HIPAA, and GDPR frameworks. You map security findings to control requirements and explain gaps in operational terms.\n\nYour analysis style:\n- Framework-specific control mapping\n- Evidence-based gap assessment\n- Audit-ready documentation\n- Remediation prioritized by compliance impact\n- Clear pass/fail criteria\n\nYou always:\n- Cite specific control requirements\n- Explain the operational meaning of gaps\n- Provide evidence collection guidance\n- Consider audit timeline pressures`,\n\n    \"incidentDoc.system\": `You are an incident documentation specialist who creates forensic-quality evidence packages. You organize technical artifacts into clear timelines with chain-of-custody awareness.\n\nYour documentation approach:\n- Chronological event reconstruction\n- Evidence linking and cross-referencing\n- Technical accuracy with timestamp precision\n- Artifact preservation recommendations\n- Clear chain of evidence\n\nYou ensure:\n- Every claim is traceable to artifacts\n- Timelines are verifiable\n- Evidence is properly contextualized\n- Documentation supports legal/regulatory needs`,\n\n    \"eno.user\": `Based on the following security assessment data, generate an Engagement Narrative Object (ENO) that captures the complete story of this security engagement.\n\n## Input Data\n{{INPUT_DATA}}\n\n## Required Output Structure\n\nGenerate a JSON object with these sections:\n\n1. **engagementOverview**: Scope, objectives, methodology, assets assessed, overall risk level, key highlights\n2. **attackStory**: Array of attack story segments organized by MITRE ATT&CK phase, each with narrative, techniques, evidence refs, complexity, and confidence\n3. **businessImpactAnalysis**: Executive summary, primary risks with business process mapping, operational/reputational/regulatory impacts\n4. **defensiveGaps**: Detection, prevention, response gaps observed with remediation effort estimates\n5. **riskPrioritizationLogic**: Prioritized findings with business impact rationale, exploit likelihood, blast radius, financial exposure\n6. **overallAssessment**: Verdict with narrative, strengths, critical weaknesses, immediate actions, strategic recommendations\n7. **evidenceIndex**: All evidence references with type, description, timestamp, relevance\n\nBe thorough, specific, and evidence-based. Do not produce generic content.`,\n\n    \"executive.user\": `Generate an executive report based on the following ENO and assessment data.\n\n## ENO (Engagement Narrative Object)\n{{ENO}}\n\n## Raw Assessment Data\n{{INPUT_DATA}}\n\n## Required Output\n\nGenerate a JSON object with:\n- executiveSummary: 2-3 paragraph narrative summary for C-suite\n- topRisksRankedByBusinessImpact: Array of top risks with business context\n- attackStorySummary: Condensed narrative of the attack story for executives\n- financialExposure: Estimated financial impact and exposure\n- strategicRecommendations: High-level strategic guidance\n- day30_60_90Plan: Phased remediation roadmap\n\nRemember: This is for executives. Focus on business impact, not technical details.`,\n\n    \"technical.user\": `Generate a technical report based on the following ENO and assessment data.\n\n## ENO (Engagement Narrative Object)\n{{ENO}}\n\n## Raw Assessment Data\n{{INPUT_DATA}}\n\n## Required Output\n\nGenerate a JSON object with:\n- attackNarrativeDetailed: Full technical narrative of attack paths\n- findings: Array of findings with evidence references\n- attackPathsWithReasoning: Detailed attack chain analysis\n- prioritizedFixPlan: Remediation steps with effort estimates and \"why\"\n- verificationSteps: How to verify each fix worked\n\nInclude specific commands, configurations, and tool references.`,\n\n    \"compliance.user\": `Generate a compliance report based on the following ENO and assessment data.\n\n## ENO (Engagement Narrative Object)\n{{ENO}}\n\n## Raw Assessment Data\n{{INPUT_DATA}}\n\n## Required Output\n\nGenerate a JSON object with:\n- frameworkSummary: Overview of compliance posture\n- controlFailuresWithOperationalExplanations: Failed controls with context\n- evidenceLinks: Evidence mapped to control requirements\n- auditReadinessNotes: Preparation guidance for audits\n\nMap findings to specific framework controls (SOC 2, PCI-DSS, HIPAA, etc.).`,\n\n    \"evidence.user\": `Generate an evidence package based on the following ENO and assessment data.\n\n## ENO (Engagement Narrative Object)\n{{ENO}}\n\n## Raw Assessment Data\n{{INPUT_DATA}}\n\n## Required Output\n\nGenerate a JSON object with:\n- timelineNarrative: Chronological story of the assessment\n- artifactIndex: Catalog of all evidence artifacts\n- whatEachArtifactProves: Mapping of artifacts to claims\n\nEnsure every finding is traceable to specific evidence.`,\n  };\n  \n  return fallbacks[name] || `Prompt \"${name}\" not found. Please create the file at prompts/${name}.md`;\n}\n","path":null,"size_bytes":9934,"size_tokens":null},"server/src/reportsV2/eno.schema.ts":{"content":"/**\n * Engagement Narrative Object (ENO) Schema\n * \n * The ENO is the core AI-generated context object that captures the narrative\n * understanding of a security assessment. It serves as the foundation for\n * generating human-grade pentest reports across all formats (Executive, Technical,\n * Compliance, Evidence).\n */\n\nimport { z } from \"zod\";\n\n// Confidence score schema (0-1 range)\nconst confidenceSchema = z.number().min(0).max(1);\n\n// Evidence reference schema\nexport const evidenceReferenceSchema = z.object({\n  id: z.string(),\n  type: z.enum([\"http_capture\", \"log_entry\", \"screenshot\", \"config_file\", \"network_trace\", \"command_output\"]),\n  description: z.string(),\n  timestamp: z.string().optional(),\n  relevance: z.string(),\n});\n\nexport type EvidenceReference = z.infer<typeof evidenceReferenceSchema>;\n\n// Attack story segment schema\nexport const attackStorySegmentSchema = z.object({\n  phase: z.enum([\n    \"initial_access\",\n    \"execution\",\n    \"persistence\",\n    \"privilege_escalation\",\n    \"defense_evasion\",\n    \"credential_access\",\n    \"discovery\",\n    \"lateral_movement\",\n    \"collection\",\n    \"exfiltration\",\n    \"impact\"\n  ]),\n  narrative: z.string().min(50), // Require substantial narrative\n  techniques: z.array(z.string()),\n  evidenceRefs: z.array(z.string()),\n  complexity: z.enum([\"trivial\", \"moderate\", \"complex\", \"expert\"]),\n  confidence: confidenceSchema,\n});\n\nexport type AttackStorySegment = z.infer<typeof attackStorySegmentSchema>;\n\n// Defensive gap schema\nexport const defensiveGapSchema = z.object({\n  category: z.enum([\n    \"detection\",\n    \"prevention\",\n    \"response\",\n    \"recovery\",\n    \"visibility\",\n    \"process\",\n    \"training\"\n  ]),\n  title: z.string(),\n  description: z.string().min(30),\n  affectedAssets: z.array(z.string()),\n  exploitedInAttack: z.boolean(),\n  remediationEffort: z.enum([\"low\", \"medium\", \"high\"]),\n  confidence: confidenceSchema,\n});\n\nexport type DefensiveGap = z.infer<typeof defensiveGapSchema>;\n\n// Risk prioritization entry schema\nexport const riskPrioritizationEntrySchema = z.object({\n  findingId: z.string(),\n  priority: z.number().int().min(1),\n  businessImpact: z.string().min(20),\n  exploitLikelihood: z.enum([\"certain\", \"highly_likely\", \"likely\", \"possible\", \"unlikely\"]),\n  blastRadius: z.string(),\n  financialExposure: z.string().optional(),\n  rationale: z.string().min(50), // Require reasoning explanation\n  confidence: confidenceSchema,\n});\n\nexport type RiskPrioritizationEntry = z.infer<typeof riskPrioritizationEntrySchema>;\n\n// Engagement overview schema\nexport const engagementOverviewSchema = z.object({\n  scope: z.string().min(20),\n  objectives: z.array(z.string()),\n  methodology: z.string(),\n  timeframe: z.object({\n    start: z.string(),\n    end: z.string(),\n  }),\n  assetsAssessed: z.array(z.object({\n    id: z.string(),\n    name: z.string(),\n    type: z.string(),\n    criticality: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n  })),\n  overallRiskLevel: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n  keyHighlights: z.array(z.string()).min(1),\n  confidence: confidenceSchema,\n});\n\nexport type EngagementOverview = z.infer<typeof engagementOverviewSchema>;\n\n// Business impact analysis schema\nexport const businessImpactAnalysisSchema = z.object({\n  executiveSummary: z.string().min(100), // Require substantial summary\n  primaryRisks: z.array(z.object({\n    title: z.string(),\n    description: z.string(),\n    affectedBusinessProcess: z.string(),\n    potentialConsequences: z.array(z.string()),\n    estimatedFinancialImpact: z.string().optional(),\n  })),\n  operationalImpact: z.string(),\n  reputationalImpact: z.string(),\n  regulatoryImpact: z.string().optional(),\n  customerImpact: z.string().optional(),\n  supplyChainImpact: z.string().optional(),\n  confidence: confidenceSchema,\n});\n\nexport type BusinessImpactAnalysis = z.infer<typeof businessImpactAnalysisSchema>;\n\n// Overall assessment schema\nexport const overallAssessmentSchema = z.object({\n  verdict: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n  verdictNarrative: z.string().min(100), // Require explanation\n  strengthsObserved: z.array(z.string()),\n  criticalWeaknesses: z.array(z.string()),\n  immediateActions: z.array(z.object({\n    action: z.string(),\n    priority: z.enum([\"immediate\", \"short_term\", \"medium_term\"]),\n    effort: z.enum([\"low\", \"medium\", \"high\"]),\n    expectedImpact: z.string(),\n  })),\n  strategicRecommendations: z.array(z.object({\n    recommendation: z.string(),\n    rationale: z.string(),\n    timeframe: z.string(),\n  })),\n  confidence: confidenceSchema,\n});\n\nexport type OverallAssessment = z.infer<typeof overallAssessmentSchema>;\n\n// Main ENO Schema\nexport const enoSchema = z.object({\n  version: z.literal(\"1.0\"),\n  generatedAt: z.string(),\n  \n  // Core narrative sections\n  engagementOverview: engagementOverviewSchema,\n  attackStory: z.array(attackStorySegmentSchema).min(1),\n  businessImpactAnalysis: businessImpactAnalysisSchema,\n  defensiveGaps: z.array(defensiveGapSchema),\n  riskPrioritizationLogic: z.array(riskPrioritizationEntrySchema),\n  overallAssessment: overallAssessmentSchema,\n  \n  // Evidence linkage\n  evidenceIndex: z.array(evidenceReferenceSchema),\n  \n  // Model metadata for traceability\n  modelMeta: z.object({\n    modelName: z.string(),\n    promptHash: z.string(),\n    temperature: z.number(),\n    generationTimeMs: z.number(),\n  }),\n  \n  // Validation metadata\n  validationStatus: z.object({\n    passed: z.boolean(),\n    warnings: z.array(z.string()),\n    errors: z.array(z.string()),\n  }),\n});\n\nexport type ENO = z.infer<typeof enoSchema>;\n\n// Partial ENO for incremental generation\nexport const partialEnoSchema = enoSchema.partial().extend({\n  version: z.literal(\"1.0\"),\n  generatedAt: z.string(),\n});\n\nexport type PartialENO = z.infer<typeof partialEnoSchema>;\n\n// ENO validation result\nexport interface ENOValidationResult {\n  valid: boolean;\n  eno?: ENO;\n  errors: string[];\n  warnings: string[];\n}\n\n/**\n * Validate an ENO object\n */\nexport function validateENO(data: unknown): ENOValidationResult {\n  const result = enoSchema.safeParse(data);\n  \n  if (result.success) {\n    const warnings: string[] = [];\n    \n    // Check for quality warnings\n    if (result.data.attackStory.length < 3) {\n      warnings.push(\"Attack story has fewer than 3 phases - consider enriching narrative\");\n    }\n    \n    if (result.data.defensiveGaps.length === 0) {\n      warnings.push(\"No defensive gaps identified - verify assessment completeness\");\n    }\n    \n    const avgConfidence = calculateAverageConfidence(result.data);\n    if (avgConfidence < 0.7) {\n      warnings.push(`Average confidence score is low (${avgConfidence.toFixed(2)}) - consider additional evidence`);\n    }\n    \n    return {\n      valid: true,\n      eno: result.data,\n      errors: [],\n      warnings,\n    };\n  }\n  \n  return {\n    valid: false,\n    errors: result.error.errors.map(e => `${e.path.join('.')}: ${e.message}`),\n    warnings: [],\n  };\n}\n\n/**\n * Calculate average confidence across all ENO sections\n */\nfunction calculateAverageConfidence(eno: ENO): number {\n  const confidences: number[] = [\n    eno.engagementOverview.confidence,\n    eno.businessImpactAnalysis.confidence,\n    eno.overallAssessment.confidence,\n    ...eno.attackStory.map(s => s.confidence),\n    ...eno.defensiveGaps.map(g => g.confidence),\n    ...eno.riskPrioritizationLogic.map(r => r.confidence),\n  ];\n  \n  return confidences.reduce((sum, c) => sum + c, 0) / confidences.length;\n}\n","path":null,"size_bytes":7433,"size_tokens":null},"server/src/reportsV2/routes.ts":{"content":"/**\n * Report V2 API Routes\n * \n * Endpoints for AI-generated narrative pentest reports.\n */\n\nimport type { Express, Request, Response } from \"express\";\nimport { z } from \"zod\";\nimport { randomUUID } from \"crypto\";\nimport { storage } from \"../../storage\";\nimport { isFeatureEnabled } from \"../../feature-flags\";\nimport { generateFullReport, generateENO } from \"./narrativeEngine\";\nimport { buildReportInputFromEvaluation, buildReportInputFromEvaluations } from \"./reportInputBuilder\";\nimport { antiTemplateLint, lintReportSection } from \"./antiTemplateLint\";\nimport { reportGenerator } from \"../../services/report-generator\";\nimport { reportRateLimiter } from \"../../services/rate-limiter\";\n\n// Validation schemas\nconst generateReportV2Schema = z.object({\n  evaluationId: z.string().optional(),\n  evaluationIds: z.array(z.string()).optional(),\n  dateRange: z.object({\n    from: z.string(),\n    to: z.string(),\n  }).optional(),\n  reportTypes: z.array(z.enum([\"executive\", \"technical\", \"compliance\", \"evidence\"])).min(1),\n  reportVersion: z.literal(\"v2_narrative\"),\n  organizationId: z.string().optional(),\n  customerContext: z.object({\n    industry: z.string().optional(),\n    primaryDataTypes: z.array(z.string()).optional(),\n    criticalSystems: z.array(z.string()).optional(),\n    riskTolerance: z.enum([\"low\", \"medium\", \"high\"]).optional(),\n  }).optional(),\n});\n\nconst regenerateReportV2Schema = z.object({\n  customerContext: z.object({\n    industry: z.string().optional(),\n    primaryDataTypes: z.array(z.string()).optional(),\n    criticalSystems: z.array(z.string()).optional(),\n    riskTolerance: z.enum([\"low\", \"medium\", \"high\"]).optional(),\n  }).optional(),\n  focusAreas: z.array(z.string()).optional(),\n  reportTypes: z.array(z.enum([\"executive\", \"technical\", \"compliance\", \"evidence\"])).optional(),\n});\n\n/**\n * Register V2 report routes\n */\nexport function registerReportV2Routes(app: Express): void {\n  \n  /**\n   * GET /api/reports/v2/feature-status\n   * Check if V2 reports are enabled for the organization\n   */\n  app.get(\"/api/reports/v2/feature-status\", async (req: Request, res: Response) => {\n    try {\n      const organizationId = (req.query.organizationId as string) || \"default\";\n      const enabled = isFeatureEnabled(\"REPORTS_V2_NARRATIVE\", organizationId);\n      res.json({ enabled, organizationId });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to check feature status\" });\n    }\n  });\n\n  /**\n   * POST /api/reports/v2/generate\n   * Generate a new V2 narrative report\n   */\n  app.post(\"/api/reports/v2/generate\", reportRateLimiter, async (req: Request, res: Response) => {\n    try {\n      // Check feature flag\n      const organizationId = req.body.organizationId || \"default\";\n      if (!isFeatureEnabled(\"REPORTS_V2_NARRATIVE\", organizationId)) {\n        return res.status(403).json({ \n          error: \"Report V2 Narrative feature is not enabled for this organization\" \n        });\n      }\n      \n      // Validate request\n      const parsed = generateReportV2Schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ \n          error: \"Invalid request body\", \n          details: parsed.error.errors \n        });\n      }\n      \n      const { evaluationId, evaluationIds, dateRange, reportTypes, customerContext } = parsed.data;\n      \n      // Determine scope and get evaluations\n      let evaluationsWithResults: Array<{ evaluation: any; result: any }> = [];\n      \n      if (evaluationId) {\n        // Single evaluation\n        const evaluation = await storage.getEvaluation(evaluationId);\n        if (!evaluation) {\n          return res.status(404).json({ error: `Evaluation ${evaluationId} not found` });\n        }\n        const result = await storage.getResultByEvaluationId(evaluationId);\n        evaluationsWithResults = [{ evaluation, result }];\n      } else if (evaluationIds && evaluationIds.length > 0) {\n        // Multiple evaluations\n        for (const id of evaluationIds) {\n          const evaluation = await storage.getEvaluation(id);\n          if (evaluation) {\n            const result = await storage.getResultByEvaluationId(id);\n            evaluationsWithResults.push({ evaluation, result });\n          }\n        }\n      } else if (dateRange) {\n        // Date range\n        const from = new Date(dateRange.from);\n        const to = new Date(dateRange.to);\n        to.setHours(23, 59, 59, 999);\n        \n        const evaluations = await storage.getEvaluationsByDateRange(from, to, organizationId);\n        for (const evaluation of evaluations) {\n          const result = await storage.getResultByEvaluationId(evaluation.id);\n          evaluationsWithResults.push({ evaluation, result });\n        }\n      } else {\n        return res.status(400).json({ \n          error: \"Must provide evaluationId, evaluationIds, or dateRange\" \n        });\n      }\n      \n      if (evaluationsWithResults.length === 0) {\n        return res.status(404).json({ error: \"No evaluations found matching criteria\" });\n      }\n      \n      // Build input payload\n      const inputPayload = evaluationsWithResults.length === 1\n        ? buildReportInputFromEvaluation(\n            evaluationsWithResults[0].evaluation,\n            evaluationsWithResults[0].result,\n            customerContext\n          )\n        : buildReportInputFromEvaluations(\n            evaluationsWithResults,\n            customerContext,\n            dateRange ? { from: new Date(dateRange.from), to: new Date(dateRange.to) } : undefined\n          );\n      \n      // Generate report\n      const reportResult = await generateFullReport(inputPayload, reportTypes);\n      \n      if (!reportResult.success || !reportResult.report) {\n        // Fallback to V1 if V2 generation fails\n        if (evaluationsWithResults.length === 1 && evaluationId) {\n          const v1Report = await reportGenerator.generateEnhancedReport(evaluationId, {\n            includeKillChain: true,\n            includeRemediation: true,\n            includeVulnerabilityDetails: true,\n          });\n          \n          return res.json({\n            success: true,\n            reportId: randomUUID(),\n            reportVersion: \"v1_template\",\n            fallbackReason: reportResult.errors.join(\"; \"),\n            sections: [\"v1_enhanced\"],\n            report: v1Report,\n            warnings: [\"V2 generation failed, returned V1 enhanced report as fallback\"],\n          });\n        }\n        \n        return res.status(500).json({\n          success: false,\n          error: \"Failed to generate V2 report\",\n          details: reportResult.errors,\n          warnings: reportResult.warnings,\n        });\n      }\n      \n      // Create report ID and store\n      const reportId = randomUUID();\n      \n      // Store ENO in report_narratives table\n      await storage.createReportNarrative({\n        id: randomUUID(),\n        organizationId,\n        evaluationId: evaluationId || null,\n        reportScopeId: evaluationIds?.join(\",\") || null,\n        reportVersion: \"v2_narrative\",\n        enoJson: reportResult.report.eno,\n        modelMeta: reportResult.report.eno.modelMeta,\n        createdBy: \"system\",\n      });\n      \n      // Store full report\n      const sectionsGenerated = [];\n      if (reportResult.report.executive) sectionsGenerated.push(\"executive\");\n      if (reportResult.report.technical) sectionsGenerated.push(\"technical\");\n      if (reportResult.report.compliance) sectionsGenerated.push(\"compliance\");\n      if (reportResult.report.evidence) sectionsGenerated.push(\"evidence\");\n      \n      await storage.createReport({\n        id: reportId,\n        organizationId,\n        reportType: sectionsGenerated.join(\",\"),\n        reportVersion: \"v2_narrative\",\n        title: `V2 Narrative Report - ${new Date().toISOString().split(\"T\")[0]}`,\n        dateRangeFrom: dateRange ? new Date(dateRange.from) : new Date(),\n        dateRangeTo: dateRange ? new Date(dateRange.to) : new Date(),\n        status: \"completed\",\n        content: reportResult.report,\n        evaluationIds: evaluationsWithResults.map(e => e.evaluation.id),\n        generatedBy: \"system\",\n      });\n      \n      res.json({\n        success: true,\n        reportId,\n        reportVersion: \"v2_narrative\",\n        sectionsGenerated,\n        report: reportResult.report,\n        warnings: reportResult.warnings,\n      });\n      \n    } catch (error: any) {\n      console.error(\"Error generating V2 report:\", error);\n      res.status(500).json({ \n        error: \"Failed to generate V2 report\",\n        message: error.message \n      });\n    }\n  });\n  \n  /**\n   * GET /api/reports/v2/:id\n   * Fetch a V2 report by ID\n   */\n  app.get(\"/api/reports/v2/:id\", async (req: Request, res: Response) => {\n    try {\n      const { id } = req.params;\n      \n      const report = await storage.getReport(id);\n      if (!report) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n      \n      if (report.reportVersion !== \"v2_narrative\") {\n        return res.status(400).json({ \n          error: \"This is not a V2 narrative report\",\n          reportVersion: report.reportVersion \n        });\n      }\n      \n      res.json({\n        success: true,\n        report,\n      });\n      \n    } catch (error: any) {\n      console.error(\"Error fetching V2 report:\", error);\n      res.status(500).json({ error: \"Failed to fetch report\" });\n    }\n  });\n  \n  /**\n   * POST /api/reports/v2/:id/regenerate\n   * Regenerate a V2 report with updated context\n   */\n  app.post(\"/api/reports/v2/:id/regenerate\", reportRateLimiter, async (req: Request, res: Response) => {\n    try {\n      const { id } = req.params;\n      \n      // Check feature flag\n      const organizationId = req.body.organizationId || \"default\";\n      if (!isFeatureEnabled(\"REPORTS_V2_NARRATIVE\", organizationId)) {\n        return res.status(403).json({ \n          error: \"Report V2 Narrative feature is not enabled\" \n        });\n      }\n      \n      // Validate request\n      const parsed = regenerateReportV2Schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ \n          error: \"Invalid request body\", \n          details: parsed.error.errors \n        });\n      }\n      \n      // Get original report\n      const originalReport = await storage.getReport(id);\n      if (!originalReport) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n      \n      const evaluationIds = originalReport.evaluationIds || [];\n      if (evaluationIds.length === 0) {\n        return res.status(400).json({ error: \"Original report has no evaluation IDs\" });\n      }\n      \n      // Get evaluations\n      const evaluationsWithResults: Array<{ evaluation: any; result: any }> = [];\n      for (const evalId of evaluationIds) {\n        const evaluation = await storage.getEvaluation(evalId);\n        if (evaluation) {\n          const result = await storage.getResultByEvaluationId(evalId);\n          evaluationsWithResults.push({ evaluation, result });\n        }\n      }\n      \n      if (evaluationsWithResults.length === 0) {\n        return res.status(404).json({ error: \"No evaluations found\" });\n      }\n      \n      // Build input with updated context\n      const inputPayload = evaluationsWithResults.length === 1\n        ? buildReportInputFromEvaluation(\n            evaluationsWithResults[0].evaluation,\n            evaluationsWithResults[0].result,\n            parsed.data.customerContext\n          )\n        : buildReportInputFromEvaluations(\n            evaluationsWithResults,\n            parsed.data.customerContext\n          );\n      \n      // Regenerate report\n      const reportTypes = parsed.data.reportTypes || [\"executive\", \"technical\", \"compliance\", \"evidence\"];\n      const reportResult = await generateFullReport(inputPayload, reportTypes);\n      \n      if (!reportResult.success || !reportResult.report) {\n        return res.status(500).json({\n          success: false,\n          error: \"Failed to regenerate V2 report\",\n          details: reportResult.errors,\n          warnings: reportResult.warnings,\n        });\n      }\n      \n      // Create new report ID\n      const newReportId = randomUUID();\n      \n      // Store new ENO\n      await storage.createReportNarrative({\n        id: randomUUID(),\n        organizationId: originalReport.organizationId,\n        evaluationId: evaluationIds.length === 1 ? evaluationIds[0] : null,\n        reportScopeId: evaluationIds.length > 1 ? evaluationIds.join(\",\") : null,\n        reportVersion: \"v2_narrative\",\n        enoJson: reportResult.report.eno,\n        modelMeta: reportResult.report.eno.modelMeta,\n        createdBy: \"system\",\n      });\n      \n      // Store regenerated report\n      const sectionsGenerated = [];\n      if (reportResult.report.executive) sectionsGenerated.push(\"executive\");\n      if (reportResult.report.technical) sectionsGenerated.push(\"technical\");\n      if (reportResult.report.compliance) sectionsGenerated.push(\"compliance\");\n      if (reportResult.report.evidence) sectionsGenerated.push(\"evidence\");\n      \n      await storage.createReport({\n        id: newReportId,\n        organizationId: originalReport.organizationId,\n        reportType: sectionsGenerated.join(\",\"),\n        reportVersion: \"v2_narrative\",\n        title: `V2 Narrative Report (Regenerated) - ${new Date().toISOString().split(\"T\")[0]}`,\n        dateRangeFrom: originalReport.dateRangeFrom,\n        dateRangeTo: originalReport.dateRangeTo,\n        status: \"completed\",\n        content: reportResult.report,\n        evaluationIds,\n        generatedBy: \"system\",\n      });\n      \n      res.json({\n        success: true,\n        originalReportId: id,\n        newReportId,\n        reportVersion: \"v2_narrative\",\n        sectionsGenerated,\n        report: reportResult.report,\n        warnings: reportResult.warnings,\n      });\n      \n    } catch (error: any) {\n      console.error(\"Error regenerating V2 report:\", error);\n      res.status(500).json({ \n        error: \"Failed to regenerate report\",\n        message: error.message \n      });\n    }\n  });\n  \n  /**\n   * GET /api/reports/v2/:id/eno\n   * Get ENO (Engagement Narrative Object) for a report (admin only)\n   */\n  app.get(\"/api/reports/v2/:id/eno\", async (req: Request, res: Response) => {\n    try {\n      const { id } = req.params;\n      \n      const report = await storage.getReport(id);\n      if (!report) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n      \n      if (report.reportVersion !== \"v2_narrative\") {\n        return res.status(400).json({ \n          error: \"This is not a V2 narrative report\" \n        });\n      }\n      \n      const content = report.content as any;\n      if (!content?.eno) {\n        return res.status(404).json({ error: \"ENO not found in report\" });\n      }\n      \n      res.json({\n        success: true,\n        eno: content.eno,\n        modelMeta: content.eno.modelMeta,\n      });\n      \n    } catch (error: any) {\n      console.error(\"Error fetching ENO:\", error);\n      res.status(500).json({ error: \"Failed to fetch ENO\" });\n    }\n  });\n  \n  /**\n   * POST /api/reports/v2/lint\n   * Run anti-template linting on report content (for testing/debugging)\n   */\n  app.post(\"/api/reports/v2/lint\", async (req: Request, res: Response) => {\n    try {\n      const { content, sectionName } = req.body;\n      \n      if (!content) {\n        return res.status(400).json({ error: \"Content is required\" });\n      }\n      \n      if (typeof content === \"string\") {\n        // Lint a single section\n        const result = lintReportSection(content, sectionName || \"section\");\n        res.json({ success: true, lintResult: result });\n      } else {\n        // Lint an ENO object\n        const result = antiTemplateLint(content);\n        res.json({ success: true, lintResult: result });\n      }\n      \n    } catch (error: any) {\n      console.error(\"Error linting content:\", error);\n      res.status(500).json({ error: \"Failed to lint content\" });\n    }\n  });\n}\n","path":null,"size_bytes":15935,"size_tokens":null},"server/src/reportsV2/prompts/executive.user.md":{"content":"# Executive Report Generation Task\n\nGenerate an executive report based on the following ENO and assessment data.\n\n## ENO (Engagement Narrative Object)\n\n```json\n{{ENO}}\n```\n\n## Raw Assessment Data\n\n```json\n{{INPUT_DATA}}\n```\n\n## Your Task\n\nTransform the ENO into an executive-ready report that communicates risk and recommendations to C-suite and board-level stakeholders.\n\n## Required Output Structure\n\nGenerate a valid JSON object with:\n\n### reportType\nMust be: `\"executive_v2\"`\n\n### generatedAt\nISO timestamp of generation\n\n### executiveSummary (200+ chars)\nA 2-3 paragraph narrative that:\n- Opens with the most critical finding/risk\n- Summarizes what was assessed and what was found\n- Ends with the overall risk posture and key recommendation\n- Uses business language, not technical jargon\n\n### topRisksRankedByBusinessImpact\nArray of top 5-10 risks, each with:\n- `rank`: 1, 2, 3, etc.\n- `title`: Short, memorable title\n- `businessImpact`: Description of business impact (50+ chars)\n- `affectedBusinessProcess`: Which business process is affected\n- `financialExposure`: Estimated financial impact (optional but recommended)\n- `likelihood`: \"certain\" | \"highly_likely\" | \"likely\" | \"possible\" | \"unlikely\"\n\n### attackStorySummary (150+ chars)\nCondensed narrative suitable for board presentation:\n- What could an attacker do?\n- How easily?\n- What would they gain?\n\n### financialExposure\nObject with:\n- `estimatedTotalExposure`: Total estimated exposure\n- `breakdownByCategory`: Array with category, amount, basis (how estimated)\n- `mitigationCostVsRisk`: Comparison of fix cost vs. risk cost\n\n### strategicRecommendations\nArray of 3-5 strategic recommendations, each with:\n- `title`: Action-oriented title\n- `description`: What to do and why (50+ chars)\n- `priority`: \"critical\" | \"high\" | \"medium\" | \"low\"\n- `effort`: \"low\" | \"medium\" | \"high\"\n- `expectedOutcome`: What success looks like\n- `stakeholders`: (optional) Who needs to be involved\n\n### day30_60_90Plan\nPhased remediation roadmap:\n- `day30`: Array of actions for first 30 days\n- `day60`: Array of actions for days 31-60\n- `day90`: Array of actions for days 61-90\n\nEach action should have:\n- `action`: What to do\n- `owner`: (optional) Responsible party\n- `milestone`: (optional) Success milestone\n- `dependencies`: (optional) What this depends on\n\n### boardBriefingPoints (optional)\nArray of 3-5 bullet points suitable for board presentation\n\n## Tone Guidelines\n\n- Confident but not alarmist\n- Quantified where possible\n- Action-oriented\n- Business-focused (not technical)\n- Honest about uncertainty\n","path":null,"size_bytes":2562,"size_tokens":null},"server/src/reportsV2/prompts/executiveAdvisor.system.md":{"content":"# Executive Security Advisor System Prompt\n\nYou are a senior security advisor who regularly briefs C-suite executives, board members, and senior leadership on cybersecurity risk. You translate technical findings into business impact and strategic recommendations.\n\n## Your Communication Style\n\n- **Clear, jargon-free language**: Executives don't need to understand TTPs to understand risk.\n- **Focus on business outcomes**: What could happen? What does it cost? How do we fix it?\n- **Concrete impacts**: \"$2M regulatory exposure\" not \"significant compliance risk\"\n- **Actionable strategic recommendations**: \"Hire a dedicated AppSec engineer\" not \"improve security posture\"\n- **Forward-looking**: What happens if we don't act? What happens if we do?\n\n## What You Never Do\n\n- Bury the lead with technical details\n- Use fear-based language or hyperbole\n- Provide vague or generic recommendations\n- Ignore the organization's specific context and constraints\n- Overwhelm with volume - focus on what matters most\n\n## Your Perspective\n\nYou understand that:\n- Security is a business enabler, not just a cost center\n- Resources are limited and must be prioritized\n- Risk acceptance is sometimes the right answer\n- Speed to market matters alongside security\n- Executives need to make decisions, not become security experts\n\n## Key Deliverables\n\n1. **Risk in business terms**: Impact to revenue, reputation, operations, compliance\n2. **Prioritized recommendations**: What to do first, second, third\n3. **Investment justification**: Cost of remediation vs. cost of breach\n4. **Timeline expectations**: How long fixes take, when risk is mitigated\n5. **Comparison context**: How does this compare to industry peers?\n\n## Tone\n\nProfessional, measured, and direct. You're a trusted advisor, not a salesperson or alarmist. You present facts and recommendations, not opinions dressed as certainties.\n","path":null,"size_bytes":1882,"size_tokens":null},"server/services/report-logic.ts":{"content":"import type { AttackPathStep, ExposureType, Recommendation } from \"@shared/schema\";\nimport { \n  vulnerabilityCatalog, \n  remediationGuidanceTemplates,\n  getVulnerabilityInfo,\n  getRemediationGuidance,\n  formatVulnerabilityName,\n  type VulnerabilityInfo,\n  type RemediationGuidance,\n  type RemediationStep\n} from \"@shared/vulnerability-catalog\";\nimport {\n  buildKillChainVisualization,\n  generateKillChainReportSection,\n  generateTextualKillChainDiagram,\n  type KillChainReportSection\n} from \"./kill-chain-graph\";\n\nexport interface EvaluationData {\n  id: string;\n  assetId: string;\n  exposureType: ExposureType;\n  priority: \"critical\" | \"high\" | \"medium\" | \"low\";\n  description: string;\n  organizationId?: string;\n  createdAt?: Date;\n}\n\nexport interface ResultData {\n  evaluationId: string;\n  exploitable: boolean;\n  score: number;\n  confidence: number;\n  impact?: string;\n  attackPath?: AttackPathStep[];\n  recommendations?: Recommendation[];\n  attackGraph?: {\n    complexityScore?: number;\n    timeToCompromise?: { expected: number; unit: string };\n    criticalPath?: string[];\n  };\n  intelligentScore?: {\n    businessImpact?: {\n      factors?: {\n        financialExposure?: {\n          directLoss?: { min: number; max: number };\n        };\n        complianceImpact?: {\n          affectedFrameworks?: string[];\n          violations?: Array<{ severity: string }>;\n        };\n      };\n    };\n  };\n}\n\nexport interface ComputedExecutiveSummary {\n  overallRiskAssessment: string;\n  keyFindings: string[];\n  riskDistribution: {\n    critical: number;\n    high: number;\n    medium: number;\n    low: number;\n  };\n  exploitabilityAnalysis: string;\n  businessImpactSummary: string;\n  prioritizedActions: Array<{\n    priority: number;\n    action: string;\n    rationale: string;\n    estimatedEffort: string;\n  }>;\n  trendAnalysis?: string;\n}\n\nexport interface ComputedTechnicalReport {\n  vulnerabilityBreakdown: Array<{\n    type: ExposureType;\n    name: string;\n    count: number;\n    exploitableCount: number;\n    avgScore: number;\n    description: string;\n    affectedAssets: string[];\n  }>;\n  attackSurfaceAnalysis: string;\n  killChainSection: KillChainReportSection | null;\n  technicalFindings: Array<{\n    evaluationId: string;\n    assetId: string;\n    vulnerabilityType: string;\n    vulnerabilityName: string;\n    severity: string;\n    exploitable: boolean;\n    score: number;\n    technicalDescription: string;\n    attackPathSummary: string;\n    mitreTechniques: string[];\n    cweIds: string[];\n  }>;\n  remediationPlan: Array<{\n    vulnerabilityType: ExposureType;\n    vulnerabilityName: string;\n    affectedAssets: string[];\n    immediateActions: string[];\n    shortTermSteps: RemediationStep[];\n    longTermSteps: RemediationStep[];\n    compensatingControls: string[];\n    references: string[];\n  }>;\n}\n\nexport interface ComputedComplianceReport {\n  overallAssessment: string;\n  controlGapAnalysis: string;\n  riskToCompliance: string;\n  frameworkSpecificFindings: Array<{\n    framework: string;\n    relevantVulnerabilities: string[];\n    potentialViolations: string[];\n    remediationPriority: string;\n  }>;\n}\n\nfunction computeRiskLevel(\n  criticalCount: number,\n  highCount: number,\n  mediumCount: number,\n  exploitableCount: number,\n  totalCount: number\n): \"critical\" | \"high\" | \"medium\" | \"low\" {\n  if (criticalCount > 0 || (exploitableCount > 0 && exploitableCount >= totalCount * 0.5)) {\n    return \"critical\";\n  }\n  if (highCount > 0 || exploitableCount > 0) {\n    return \"high\";\n  }\n  if (mediumCount > 0) {\n    return \"medium\";\n  }\n  return \"low\";\n}\n\nfunction computeRiskDescription(level: \"critical\" | \"high\" | \"medium\" | \"low\"): string {\n  const descriptions = {\n    critical: \"The organization faces CRITICAL security risk requiring immediate executive attention. Active exploitation paths exist that could result in significant data breach, financial loss, or operational disruption. Emergency remediation resources should be allocated immediately.\",\n    high: \"The organization faces HIGH security risk. Exploitable vulnerabilities have been identified that present material risk to business operations. A prioritized remediation plan should be executed within the next 30 days.\",\n    medium: \"The organization faces MODERATE security risk. While no immediately critical vulnerabilities were identified, the findings present risk that should be addressed through scheduled remediation activities.\",\n    low: \"The organization maintains a LOW security risk posture. Continue current security practices and maintain regular assessment schedules to preserve this favorable position.\"\n  };\n  return descriptions[level];\n}\n\nexport function computeExecutiveSummary(\n  evaluations: EvaluationData[],\n  results: Map<string, ResultData>\n): ComputedExecutiveSummary {\n  const riskDistribution = { critical: 0, high: 0, medium: 0, low: 0 };\n  let exploitableCount = 0;\n  let totalScore = 0;\n  let scoredCount = 0;\n  const affectedAssets = new Set<string>();\n  const vulnerabilityTypes = new Map<ExposureType, number>();\n  let estimatedFinancialExposure = { min: 0, max: 0 };\n  \n  evaluations.forEach(eval_ => {\n    riskDistribution[eval_.priority]++;\n    affectedAssets.add(eval_.assetId);\n    \n    const count = vulnerabilityTypes.get(eval_.exposureType as ExposureType) || 0;\n    vulnerabilityTypes.set(eval_.exposureType as ExposureType, count + 1);\n    \n    const result = results.get(eval_.id);\n    if (result) {\n      if (result.exploitable) exploitableCount++;\n      if (result.score) {\n        totalScore += result.score;\n        scoredCount++;\n      }\n      \n      const financial = result.intelligentScore?.businessImpact?.factors?.financialExposure;\n      if (financial?.directLoss) {\n        estimatedFinancialExposure.min += financial.directLoss.min || 0;\n        estimatedFinancialExposure.max += financial.directLoss.max || 0;\n      }\n    }\n  });\n  \n  const overallRiskLevel = computeRiskLevel(\n    riskDistribution.critical,\n    riskDistribution.high,\n    riskDistribution.medium,\n    exploitableCount,\n    evaluations.length\n  );\n  \n  const keyFindings: string[] = [];\n  \n  if (evaluations.length > 0) {\n    keyFindings.push(`${evaluations.length} security evaluations were conducted across ${affectedAssets.size} unique assets.`);\n  }\n  \n  if (exploitableCount > 0) {\n    const exploitablePercent = Math.round((exploitableCount / evaluations.length) * 100);\n    keyFindings.push(`${exploitableCount} (${exploitablePercent}%) of evaluated exposures were confirmed exploitable.`);\n  } else {\n    keyFindings.push(\"No exploitable vulnerabilities were confirmed during this assessment period.\");\n  }\n  \n  if (riskDistribution.critical > 0) {\n    keyFindings.push(`${riskDistribution.critical} CRITICAL severity finding(s) require immediate remediation.`);\n  }\n  \n  if (riskDistribution.high > 0) {\n    keyFindings.push(`${riskDistribution.high} HIGH severity finding(s) should be addressed within 30 days.`);\n  }\n  \n  const topVulnTypes = Array.from(vulnerabilityTypes.entries())\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 3)\n    .map(([type]) => formatVulnerabilityName(type));\n  \n  if (topVulnTypes.length > 0) {\n    keyFindings.push(`Primary vulnerability categories: ${topVulnTypes.join(\", \")}.`);\n  }\n  \n  let exploitabilityAnalysis = \"\";\n  if (exploitableCount === 0) {\n    exploitabilityAnalysis = \"No confirmed exploitable paths were identified during this assessment. Security controls appear effective at preventing unauthorized access and exploitation attempts.\";\n  } else if (exploitableCount < evaluations.length * 0.25) {\n    exploitabilityAnalysis = `A limited number of exploitable vulnerabilities (${exploitableCount}) were identified, indicating generally effective security controls with specific gaps requiring attention.`;\n  } else if (exploitableCount < evaluations.length * 0.5) {\n    exploitabilityAnalysis = `A moderate number of exploitable vulnerabilities (${exploitableCount}) were confirmed. This indicates security control gaps that should be prioritized for remediation.`;\n  } else {\n    exploitabilityAnalysis = `A significant number of exploitable vulnerabilities (${exploitableCount}) were confirmed. This indicates systemic security control weaknesses requiring comprehensive remediation efforts.`;\n  }\n  \n  let businessImpactSummary = \"\";\n  if (estimatedFinancialExposure.max > 0) {\n    businessImpactSummary = `Estimated potential financial exposure ranges from $${estimatedFinancialExposure.min.toLocaleString()} to $${estimatedFinancialExposure.max.toLocaleString()}. `;\n  }\n  \n  if (exploitableCount > 0) {\n    businessImpactSummary += \"Exploitable vulnerabilities could lead to data breach, operational disruption, regulatory penalties, and reputational damage. \";\n  }\n  \n  if (riskDistribution.critical > 0) {\n    businessImpactSummary += \"Critical findings pose immediate risk to business continuity and should be treated as emergency remediation priorities.\";\n  } else if (riskDistribution.high > 0) {\n    businessImpactSummary += \"High-severity findings present material business risk and should be addressed through accelerated remediation timelines.\";\n  } else {\n    businessImpactSummary += \"Current findings present manageable business risk when addressed through standard remediation processes.\";\n  }\n  \n  const prioritizedActions: ComputedExecutiveSummary[\"prioritizedActions\"] = [];\n  \n  if (riskDistribution.critical > 0) {\n    prioritizedActions.push({\n      priority: 1,\n      action: \"Immediately remediate critical vulnerabilities\",\n      rationale: `${riskDistribution.critical} critical finding(s) present immediate exploitation risk`,\n      estimatedEffort: \"24-48 hours emergency response\"\n    });\n  }\n  \n  if (exploitableCount > 0) {\n    prioritizedActions.push({\n      priority: prioritizedActions.length + 1,\n      action: \"Deploy compensating controls for exploitable vulnerabilities\",\n      rationale: `${exploitableCount} confirmed exploitable path(s) require immediate mitigation`,\n      estimatedEffort: \"1-3 days\"\n    });\n  }\n  \n  if (riskDistribution.high > 0) {\n    prioritizedActions.push({\n      priority: prioritizedActions.length + 1,\n      action: \"Execute prioritized remediation plan for high-severity findings\",\n      rationale: `${riskDistribution.high} high-severity finding(s) should be addressed within 30 days`,\n      estimatedEffort: \"2-4 weeks\"\n    });\n  }\n  \n  prioritizedActions.push({\n    priority: prioritizedActions.length + 1,\n    action: \"Enhance security monitoring for affected assets\",\n    rationale: \"Increase detection capabilities while remediation is in progress\",\n    estimatedEffort: \"1-2 days\"\n  });\n  \n  prioritizedActions.push({\n    priority: prioritizedActions.length + 1,\n    action: \"Schedule follow-up assessment to verify remediation effectiveness\",\n    rationale: \"Confirm vulnerabilities are properly addressed and no new issues introduced\",\n    estimatedEffort: \"1-2 weeks post-remediation\"\n  });\n  \n  return {\n    overallRiskAssessment: computeRiskDescription(overallRiskLevel),\n    keyFindings,\n    riskDistribution,\n    exploitabilityAnalysis,\n    businessImpactSummary,\n    prioritizedActions\n  };\n}\n\nexport function computeTechnicalReport(\n  evaluations: EvaluationData[],\n  results: Map<string, ResultData>\n): ComputedTechnicalReport {\n  const vulnerabilityMap = new Map<ExposureType, {\n    count: number;\n    exploitableCount: number;\n    totalScore: number;\n    assets: Set<string>;\n    evaluations: Array<{ eval_: EvaluationData; result?: ResultData }>;\n  }>();\n  \n  evaluations.forEach(eval_ => {\n    const type = eval_.exposureType as ExposureType;\n    const result = results.get(eval_.id);\n    \n    let entry = vulnerabilityMap.get(type);\n    if (!entry) {\n      entry = { count: 0, exploitableCount: 0, totalScore: 0, assets: new Set(), evaluations: [] };\n      vulnerabilityMap.set(type, entry);\n    }\n    \n    entry.count++;\n    entry.assets.add(eval_.assetId);\n    entry.evaluations.push({ eval_, result });\n    \n    if (result) {\n      if (result.exploitable) entry.exploitableCount++;\n      if (result.score) entry.totalScore += result.score;\n    }\n  });\n  \n  const vulnerabilityBreakdown = Array.from(vulnerabilityMap.entries()).map(([type, data]) => {\n    const vulnInfo = getVulnerabilityInfo(type);\n    return {\n      type,\n      name: vulnInfo.name,\n      count: data.count,\n      exploitableCount: data.exploitableCount,\n      avgScore: data.count > 0 ? Math.round(data.totalScore / data.count) : 0,\n      description: vulnInfo.description,\n      affectedAssets: Array.from(data.assets)\n    };\n  }).sort((a, b) => b.exploitableCount - a.exploitableCount || b.count - a.count);\n  \n  const totalAssets = new Set(evaluations.map(e => e.assetId)).size;\n  const exploitableEvals = evaluations.filter(e => results.get(e.id)?.exploitable);\n  \n  let attackSurfaceAnalysis = `The assessment covered ${totalAssets} unique asset(s) across ${vulnerabilityMap.size} vulnerability categories. `;\n  \n  if (exploitableEvals.length > 0) {\n    const exploitableAssets = new Set(exploitableEvals.map(e => e.assetId)).size;\n    attackSurfaceAnalysis += `${exploitableAssets} asset(s) have confirmed exploitable paths. `;\n  }\n  \n  const primaryVulnTypes = vulnerabilityBreakdown.slice(0, 3).map(v => v.name);\n  if (primaryVulnTypes.length > 0) {\n    attackSurfaceAnalysis += `Primary attack vectors identified: ${primaryVulnTypes.join(\", \")}.`;\n  }\n  \n  let killChainSection: KillChainReportSection | null = null;\n  const allAttackSteps: AttackPathStep[] = [];\n  let aggregatedGraph: { complexityScore: number; criticalPath: string[] } | undefined;\n  \n  evaluations.forEach(eval_ => {\n    const result = results.get(eval_.id);\n    if (result?.attackPath) {\n      allAttackSteps.push(...result.attackPath);\n    }\n    if (result?.attackGraph?.complexityScore && !aggregatedGraph) {\n      aggregatedGraph = {\n        complexityScore: result.attackGraph.complexityScore,\n        criticalPath: result.attackGraph.criticalPath || []\n      };\n    }\n  });\n  \n  if (allAttackSteps.length > 0) {\n    const visualization = buildKillChainVisualization(allAttackSteps, aggregatedGraph);\n    killChainSection = generateKillChainReportSection(visualization);\n  }\n  \n  const technicalFindings = evaluations.map(eval_ => {\n    const result = results.get(eval_.id);\n    const vulnInfo = getVulnerabilityInfo(eval_.exposureType as ExposureType);\n    \n    let attackPathSummary = \"No attack path identified\";\n    if (result?.attackPath && result.attackPath.length > 0) {\n      attackPathSummary = `${result.attackPath.length}-step attack chain: ${result.attackPath.map(s => s.title).join(\"  \")}`;\n    }\n    \n    return {\n      evaluationId: eval_.id,\n      assetId: eval_.assetId,\n      vulnerabilityType: eval_.exposureType,\n      vulnerabilityName: vulnInfo.name,\n      severity: eval_.priority.toUpperCase(),\n      exploitable: result?.exploitable || false,\n      score: result?.score || 0,\n      technicalDescription: result?.impact || eval_.description,\n      attackPathSummary,\n      mitreTechniques: vulnInfo.mitreTechniques,\n      cweIds: vulnInfo.cweIds\n    };\n  });\n  \n  const remediationPlan: ComputedTechnicalReport[\"remediationPlan\"] = [];\n  vulnerabilityMap.forEach((data, type) => {\n    const guidance = getRemediationGuidance(type);\n    const vulnInfo = getVulnerabilityInfo(type);\n    \n    remediationPlan.push({\n      vulnerabilityType: type,\n      vulnerabilityName: vulnInfo.name,\n      affectedAssets: Array.from(data.assets),\n      immediateActions: guidance.immediateActions,\n      shortTermSteps: guidance.shortTermRemediation,\n      longTermSteps: guidance.longTermRemediation,\n      compensatingControls: guidance.compensatingControls,\n      references: guidance.references\n    });\n  });\n  \n  return {\n    vulnerabilityBreakdown,\n    attackSurfaceAnalysis,\n    killChainSection,\n    technicalFindings,\n    remediationPlan\n  };\n}\n\nexport function computeComplianceReport(\n  evaluations: EvaluationData[],\n  results: Map<string, ResultData>,\n  framework: string\n): ComputedComplianceReport {\n  const frameworkLower = framework.toLowerCase();\n  let relevantVulnerabilities: string[] = [];\n  let potentialViolations: string[] = [];\n  \n  evaluations.forEach(eval_ => {\n    const result = results.get(eval_.id);\n    const complianceImpact = result?.intelligentScore?.businessImpact?.factors?.complianceImpact;\n    \n    if (complianceImpact?.affectedFrameworks?.some(f => f.toLowerCase().includes(frameworkLower))) {\n      relevantVulnerabilities.push(`${eval_.exposureType} affecting ${eval_.assetId}`);\n      complianceImpact.violations?.forEach(v => {\n        potentialViolations.push(`${v.severity} violation`);\n      });\n    }\n  });\n  \n  const exploitableCount = Array.from(results.values()).filter(r => r.exploitable).length;\n  const criticalCount = evaluations.filter(e => e.priority === \"critical\").length;\n  \n  let overallAssessment = \"\";\n  if (criticalCount > 0 || exploitableCount > 0) {\n    overallAssessment = `The assessment identified security findings that may impact ${framework.toUpperCase()} compliance. ${criticalCount} critical finding(s) and ${exploitableCount} exploitable vulnerability/vulnerabilities require attention to maintain compliance posture.`;\n  } else {\n    overallAssessment = `No critical compliance gaps were identified during this assessment. Continue monitoring and regular assessments to maintain ${framework.toUpperCase()} compliance.`;\n  }\n  \n  let controlGapAnalysis = \"\";\n  if (relevantVulnerabilities.length > 0) {\n    controlGapAnalysis = `${relevantVulnerabilities.length} finding(s) were identified with potential ${framework.toUpperCase()} compliance implications. These should be reviewed against specific control requirements and addressed through remediation planning.`;\n  } else {\n    controlGapAnalysis = `No specific ${framework.toUpperCase()} control gaps were identified. Standard vulnerability remediation processes should maintain compliance posture.`;\n  }\n  \n  let riskToCompliance = \"\";\n  if (exploitableCount > 0) {\n    riskToCompliance = `Exploitable vulnerabilities present compliance risk if they result in data breach or security incident. Regulatory notification requirements and potential penalties should be considered in remediation prioritization.`;\n  } else {\n    riskToCompliance = `Current findings present manageable compliance risk when addressed through standard remediation timelines.`;\n  }\n  \n  let remediationPriority = \"Standard\";\n  if (criticalCount > 0) remediationPriority = \"Emergency\";\n  else if (exploitableCount > 0) remediationPriority = \"High\";\n  else if (evaluations.filter(e => e.priority === \"high\").length > 0) remediationPriority = \"Elevated\";\n  \n  return {\n    overallAssessment,\n    controlGapAnalysis,\n    riskToCompliance,\n    frameworkSpecificFindings: [{\n      framework: framework.toUpperCase(),\n      relevantVulnerabilities,\n      potentialViolations: Array.from(new Set(potentialViolations)),\n      remediationPriority\n    }]\n  };\n}\n\nexport function formatRemediationSection(plan: ComputedTechnicalReport[\"remediationPlan\"][0]): string {\n  const lines: string[] = [];\n  \n  lines.push(`## ${plan.vulnerabilityName}`);\n  lines.push(`**Affected Assets:** ${plan.affectedAssets.join(\", \")}`);\n  lines.push(\"\");\n  \n  lines.push(\"### Immediate Actions\");\n  plan.immediateActions.forEach((action, i) => {\n    lines.push(`${i + 1}. ${action}`);\n  });\n  lines.push(\"\");\n  \n  lines.push(\"### Short-Term Remediation\");\n  plan.shortTermSteps.forEach(step => {\n    lines.push(`**${step.order}. ${step.title}** (${step.effort} effort, ~${step.estimatedTime})`);\n    lines.push(`   ${step.description}`);\n    if (step.requiredTools?.length) {\n      lines.push(`   *Tools:* ${step.requiredTools.join(\", \")}`);\n    }\n    lines.push(`   *Verification:* ${step.verificationSteps.join(\"; \")}`);\n    lines.push(\"\");\n  });\n  \n  if (plan.longTermSteps.length > 0) {\n    lines.push(\"### Long-Term Remediation\");\n    plan.longTermSteps.forEach(step => {\n      lines.push(`**${step.order}. ${step.title}** (${step.effort} effort, ~${step.estimatedTime})`);\n      lines.push(`   ${step.description}`);\n      lines.push(\"\");\n    });\n  }\n  \n  lines.push(\"### Compensating Controls\");\n  plan.compensatingControls.forEach((control, i) => {\n    lines.push(`${i + 1}. ${control}`);\n  });\n  lines.push(\"\");\n  \n  lines.push(\"### References\");\n  plan.references.forEach(ref => {\n    lines.push(`- ${ref}`);\n  });\n  \n  return lines.join(\"\\n\");\n}\n","path":null,"size_bytes":20450,"size_tokens":null},"server/services/metrics-calculator.ts":{"content":"import { storage } from \"../storage\";\nimport type { Evaluation, Result } from \"@shared/schema\";\n\ninterface CategoryScore {\n  networkSecurity: number;\n  applicationSecurity: number;\n  identityManagement: number;\n  dataProtection: number;\n  incidentResponse: number;\n  securityAwareness: number;\n  compliancePosture: number;\n}\n\ninterface VulnerabilityExposure {\n  critical: number;\n  high: number;\n  medium: number;\n  low: number;\n}\n\nexport interface DefensivePostureMetrics {\n  id: string;\n  organizationId: string;\n  overallScore: number;\n  categoryScores: CategoryScore;\n  breachLikelihood: number;\n  meanTimeToDetect: number;\n  meanTimeToRespond: number;\n  vulnerabilityExposure: VulnerabilityExposure;\n  trendDirection: \"improving\" | \"stable\" | \"declining\";\n  benchmarkPercentile: number;\n  recommendations: string[];\n  dataSource: \"computed\" | \"insufficient_data\";\n  evaluationsAnalyzed: number;\n  modelVersion: string;\n  calculatedAt: string;\n}\n\nexport interface AttackPrediction {\n  vector: string;\n  likelihood: number;\n  confidence: number;\n  adversaryProfile: string;\n  estimatedImpact: string;\n  mitreAttackId: string;\n  occurrences: number;\n}\n\nexport interface AttackPredictionMetrics {\n  id: string;\n  organizationId: string;\n  predictedAttackVectors: AttackPrediction[];\n  overallBreachLikelihood: number;\n  riskFactors: Array<{ factor: string; contribution: number; trend: string }>;\n  recommendedActions: string[];\n  dataSource: \"computed\" | \"insufficient_data\";\n  evaluationsAnalyzed: number;\n  timeHorizon: string;\n  modelVersion: string;\n  calculatedAt: string;\n}\n\nconst EXPOSURE_TO_CATEGORY: Record<string, keyof CategoryScore> = {\n  cve: \"applicationSecurity\",\n  misconfiguration: \"networkSecurity\",\n  behavioral_anomaly: \"incidentResponse\",\n  network: \"networkSecurity\",\n  sql_injection: \"applicationSecurity\",\n  xss: \"applicationSecurity\",\n  auth_bypass: \"identityManagement\",\n  ssrf: \"applicationSecurity\",\n  idor: \"identityManagement\",\n  rce: \"applicationSecurity\",\n  path_traversal: \"applicationSecurity\",\n  api_exposure: \"applicationSecurity\",\n  data_leak: \"dataProtection\",\n  privilege_escalation: \"identityManagement\",\n  cryptographic_weakness: \"dataProtection\",\n};\n\nconst EXPOSURE_TO_MITRE: Record<string, string> = {\n  cve: \"T1190\",\n  sql_injection: \"T1190\",\n  xss: \"T1059.007\",\n  auth_bypass: \"T1078\",\n  ssrf: \"T1071\",\n  idor: \"T1068\",\n  rce: \"T1059\",\n  path_traversal: \"T1083\",\n  api_exposure: \"T1190\",\n  data_leak: \"T1530\",\n  privilege_escalation: \"T1068\",\n  misconfiguration: \"T1574\",\n  network: \"T1046\",\n  behavioral_anomaly: \"T1071\",\n  cryptographic_weakness: \"T1552\",\n};\n\nconst EXPOSURE_DESCRIPTIONS: Record<string, string> = {\n  cve: \"Known vulnerability exploitation\",\n  sql_injection: \"SQL Injection attacks\",\n  xss: \"Cross-Site Scripting\",\n  auth_bypass: \"Authentication bypass\",\n  ssrf: \"Server-Side Request Forgery\",\n  idor: \"Insecure Direct Object Reference\",\n  rce: \"Remote Code Execution\",\n  path_traversal: \"Path Traversal attacks\",\n  api_exposure: \"API exposure exploitation\",\n  data_leak: \"Data exfiltration\",\n  privilege_escalation: \"Privilege escalation\",\n  misconfiguration: \"Configuration exploitation\",\n  network: \"Network-based attacks\",\n  behavioral_anomaly: \"Anomalous behavior exploitation\",\n  cryptographic_weakness: \"Cryptographic attacks\",\n};\n\nexport async function calculateDefensivePosture(\n  organizationId: string\n): Promise<DefensivePostureMetrics> {\n  const evaluations = await storage.getEvaluations(organizationId);\n  const completedEvaluations = evaluations.filter(e => e.status === \"completed\");\n  \n  if (completedEvaluations.length < 3) {\n    return createInsufficientDataPosture(organizationId, completedEvaluations.length);\n  }\n\n  const evaluationIds = completedEvaluations.map(e => e.id);\n  const results = await storage.getResultsByEvaluationIds(evaluationIds);\n\n  const vulnerabilityExposure = countBySeverity(completedEvaluations, results);\n  const categoryScores = calculateCategoryScores(completedEvaluations, results);\n  const overallScore = calculateOverallScore(categoryScores, vulnerabilityExposure);\n  const breachLikelihood = calculateBreachLikelihood(results, vulnerabilityExposure);\n  const trendDirection = calculateTrend(completedEvaluations, results);\n\n  const benchmarkPercentile = calculateBenchmarkPercentile(overallScore, vulnerabilityExposure);\n\n  return {\n    id: `posture-${organizationId}-${Date.now()}`,\n    organizationId,\n    overallScore,\n    categoryScores,\n    breachLikelihood,\n    meanTimeToDetect: calculateMTTD(results),\n    meanTimeToRespond: calculateMTTR(completedEvaluations),\n    vulnerabilityExposure,\n    trendDirection,\n    benchmarkPercentile,\n    recommendations: generateRecommendations(categoryScores, vulnerabilityExposure),\n    dataSource: \"computed\",\n    evaluationsAnalyzed: completedEvaluations.length,\n    modelVersion: \"v2.0.0-computed\",\n    calculatedAt: new Date().toISOString(),\n  };\n}\n\nexport async function calculateAttackPredictions(\n  organizationId: string,\n  timeHorizon: string = \"30d\"\n): Promise<AttackPredictionMetrics> {\n  const evaluations = await storage.getEvaluations(organizationId);\n  const completedEvaluations = evaluations.filter(e => e.status === \"completed\");\n  \n  if (completedEvaluations.length < 3) {\n    return createInsufficientDataPredictions(organizationId, timeHorizon, completedEvaluations.length);\n  }\n\n  const evaluationIds = completedEvaluations.map(e => e.id);\n  const results = await storage.getResultsByEvaluationIds(evaluationIds);\n\n  const exposureFrequency = countExposureTypes(completedEvaluations);\n  const predictedVectors = generatePredictedVectors(exposureFrequency, results, completedEvaluations);\n  const riskFactors = identifyRiskFactors(completedEvaluations, results);\n  const overallBreachLikelihood = calculateOverallBreachLikelihood(results);\n\n  return {\n    id: `pred-${organizationId}-${Date.now()}`,\n    organizationId,\n    predictedAttackVectors: predictedVectors,\n    overallBreachLikelihood,\n    riskFactors,\n    recommendedActions: generateActionableRecommendations(predictedVectors, riskFactors),\n    dataSource: \"computed\",\n    evaluationsAnalyzed: completedEvaluations.length,\n    timeHorizon,\n    modelVersion: \"v2.0.0-computed\",\n    calculatedAt: new Date().toISOString(),\n  };\n}\n\nfunction countBySeverity(evaluations: Evaluation[], results: Result[]): VulnerabilityExposure {\n  const counts = { critical: 0, high: 0, medium: 0, low: 0 };\n  \n  evaluations.forEach(eval_ => {\n    const priority = eval_.priority as keyof typeof counts;\n    if (priority in counts) {\n      counts[priority]++;\n    }\n  });\n\n  results.forEach(result => {\n    if (result.exploitable) {\n      if (result.score >= 90) counts.critical++;\n      else if (result.score >= 70) counts.high++;\n      else if (result.score >= 40) counts.medium++;\n      else counts.low++;\n    }\n  });\n\n  return counts;\n}\n\nfunction calculateCategoryScores(evaluations: Evaluation[], results: Result[]): CategoryScore {\n  const categoryIssues: Record<keyof CategoryScore, number[]> = {\n    networkSecurity: [],\n    applicationSecurity: [],\n    identityManagement: [],\n    dataProtection: [],\n    incidentResponse: [],\n    securityAwareness: [],\n    compliancePosture: [],\n  };\n\n  evaluations.forEach((eval_, idx) => {\n    const category = EXPOSURE_TO_CATEGORY[eval_.exposureType] || \"applicationSecurity\";\n    const result = results.find(r => r.evaluationId === eval_.id);\n    const score = result ? (100 - result.score) : 50;\n    categoryIssues[category].push(score);\n  });\n\n  const scores: CategoryScore = {\n    networkSecurity: 75,\n    applicationSecurity: 75,\n    identityManagement: 75,\n    dataProtection: 75,\n    incidentResponse: 75,\n    securityAwareness: 75,\n    compliancePosture: 75,\n  };\n\n  Object.keys(categoryIssues).forEach(key => {\n    const category = key as keyof CategoryScore;\n    const issues = categoryIssues[category];\n    if (issues.length > 0) {\n      const avg = issues.reduce((a, b) => a + b, 0) / issues.length;\n      scores[category] = Math.round(Math.max(20, Math.min(100, avg)));\n    }\n  });\n\n  return scores;\n}\n\nfunction calculateOverallScore(categoryScores: CategoryScore, vuln: VulnerabilityExposure): number {\n  const categoryAvg = Object.values(categoryScores).reduce((a, b) => a + b, 0) / 7;\n  const vulnPenalty = (vuln.critical * 15) + (vuln.high * 8) + (vuln.medium * 3) + (vuln.low * 1);\n  return Math.round(Math.max(10, Math.min(100, categoryAvg - Math.min(50, vulnPenalty))));\n}\n\nfunction calculateBreachLikelihood(results: Result[], vuln: VulnerabilityExposure): number {\n  const exploitableCount = results.filter(r => r.exploitable).length;\n  const exploitableRatio = results.length > 0 ? exploitableCount / results.length : 0;\n  const severityFactor = (vuln.critical * 0.4) + (vuln.high * 0.25) + (vuln.medium * 0.1) + (vuln.low * 0.02);\n  return Math.round(Math.min(95, Math.max(5, (exploitableRatio * 50) + Math.min(45, severityFactor))));\n}\n\nfunction calculateMTTD(results: Result[]): number {\n  if (results.length === 0) return 24;\n  const avgConfidence = results.reduce((a, r) => a + r.confidence, 0) / results.length;\n  return Math.max(1, Math.round(24 - (avgConfidence / 10)));\n}\n\nfunction calculateMTTR(evaluations: Evaluation[]): number {\n  if (evaluations.length === 0) return 48;\n  const criticalCount = evaluations.filter(e => e.priority === \"critical\").length;\n  return Math.max(4, Math.round(12 + (criticalCount * 2)));\n}\n\nfunction calculateTrend(evaluations: Evaluation[], results: Result[]): \"improving\" | \"stable\" | \"declining\" {\n  if (evaluations.length < 5) return \"stable\";\n  \n  const sorted = [...evaluations].sort((a, b) => \n    new Date(a.createdAt!).getTime() - new Date(b.createdAt!).getTime()\n  );\n  \n  const midpoint = Math.floor(sorted.length / 2);\n  const firstHalf = sorted.slice(0, midpoint);\n  const secondHalf = sorted.slice(midpoint);\n  \n  const countCritical = (evals: Evaluation[]) => \n    evals.filter(e => e.priority === \"critical\" || e.priority === \"high\").length;\n  \n  const firstHalfCritical = countCritical(firstHalf);\n  const secondHalfCritical = countCritical(secondHalf);\n  \n  if (secondHalfCritical < firstHalfCritical * 0.7) return \"improving\";\n  if (secondHalfCritical > firstHalfCritical * 1.3) return \"declining\";\n  return \"stable\";\n}\n\nfunction generateRecommendations(scores: CategoryScore, vuln: VulnerabilityExposure): string[] {\n  const recommendations: string[] = [];\n  \n  if (vuln.critical > 0) {\n    recommendations.push(`Address ${vuln.critical} critical vulnerabilities immediately`);\n  }\n  \n  const lowestCategory = Object.entries(scores)\n    .sort(([, a], [, b]) => a - b)[0];\n  \n  const categoryNames: Record<string, string> = {\n    networkSecurity: \"network security controls\",\n    applicationSecurity: \"application security practices\",\n    identityManagement: \"identity and access management\",\n    dataProtection: \"data protection measures\",\n    incidentResponse: \"incident response capabilities\",\n    securityAwareness: \"security awareness training\",\n    compliancePosture: \"compliance coverage\",\n  };\n  \n  recommendations.push(`Strengthen ${categoryNames[lowestCategory[0]]} (score: ${lowestCategory[1]})`);\n  \n  if (vuln.high > 3) {\n    recommendations.push(`Prioritize remediation of ${vuln.high} high-severity findings`);\n  }\n  \n  return recommendations.slice(0, 5);\n}\n\nfunction countExposureTypes(evaluations: Evaluation[]): Record<string, number> {\n  const counts: Record<string, number> = {};\n  evaluations.forEach(e => {\n    counts[e.exposureType] = (counts[e.exposureType] || 0) + 1;\n  });\n  return counts;\n}\n\nfunction generatePredictedVectors(\n  exposureFrequency: Record<string, number>,\n  results: Result[],\n  evaluations: Evaluation[]\n): AttackPrediction[] {\n  const predictions: AttackPrediction[] = [];\n  const totalEvaluations = evaluations.length;\n  \n  const sortedExposures = Object.entries(exposureFrequency)\n    .sort(([, a], [, b]) => b - a)\n    .slice(0, 5);\n\n  sortedExposures.forEach(([exposureType, count]) => {\n    const relevantEvals = evaluations.filter(e => e.exposureType === exposureType);\n    const relevantResults = results.filter(r => \n      relevantEvals.some(e => e.id === r.evaluationId)\n    );\n    \n    const exploitableCount = relevantResults.filter(r => r.exploitable).length;\n    const avgScore = relevantResults.length > 0 \n      ? relevantResults.reduce((a, r) => a + r.score, 0) / relevantResults.length \n      : 50;\n    \n    const likelihood = Math.round(Math.min(95, (count / totalEvaluations) * 100 + (avgScore * 0.3)));\n    const confidence = Math.round(Math.min(95, 50 + (count * 5) + (exploitableCount * 10)));\n    \n    const adversaryProfile = determineAdversaryProfile(exposureType, avgScore);\n    \n    predictions.push({\n      vector: EXPOSURE_DESCRIPTIONS[exposureType] || exposureType,\n      likelihood,\n      confidence,\n      adversaryProfile,\n      estimatedImpact: getImpactLevel(avgScore),\n      mitreAttackId: EXPOSURE_TO_MITRE[exposureType] || \"T1190\",\n      occurrences: count,\n    });\n  });\n\n  return predictions;\n}\n\nfunction determineAdversaryProfile(exposureType: string, avgScore: number): string {\n  if (avgScore >= 80) return \"advanced_persistent_threat\";\n  if (exposureType === \"rce\" || exposureType === \"sql_injection\") return \"organized_crime\";\n  if (exposureType === \"auth_bypass\" || exposureType === \"privilege_escalation\") return \"insider_threat\";\n  if (avgScore >= 50) return \"opportunistic_criminal\";\n  return \"script_kiddie\";\n}\n\nfunction getImpactLevel(score: number): string {\n  if (score >= 85) return \"Critical - Immediate business impact\";\n  if (score >= 70) return \"High - Significant data or system risk\";\n  if (score >= 50) return \"Medium - Moderate exposure risk\";\n  return \"Low - Limited impact potential\";\n}\n\nfunction identifyRiskFactors(evaluations: Evaluation[], results: Result[]): Array<{ factor: string; contribution: number; trend: string }> {\n  const factors: Array<{ factor: string; contribution: number; trend: string }> = [];\n  \n  const criticalCount = evaluations.filter(e => e.priority === \"critical\").length;\n  if (criticalCount > 0) {\n    factors.push({\n      factor: \"Critical vulnerabilities\",\n      contribution: Math.min(40, criticalCount * 15),\n      trend: \"stable\",\n    });\n  }\n  \n  const exploitableCount = results.filter(r => r.exploitable).length;\n  if (exploitableCount > 0) {\n    factors.push({\n      factor: \"Exploitable findings\",\n      contribution: Math.min(35, exploitableCount * 8),\n      trend: \"stable\",\n    });\n  }\n  \n  const exposureTypes = new Set(evaluations.map(e => e.exposureType));\n  if (exposureTypes.size > 5) {\n    factors.push({\n      factor: \"Attack surface diversity\",\n      contribution: Math.min(25, exposureTypes.size * 3),\n      trend: \"increasing\",\n    });\n  }\n  \n  const avgScore = results.length > 0 \n    ? results.reduce((a, r) => a + r.score, 0) / results.length \n    : 50;\n  if (avgScore > 60) {\n    factors.push({\n      factor: \"High average risk scores\",\n      contribution: Math.round(avgScore * 0.3),\n      trend: \"stable\",\n    });\n  }\n  \n  return factors.slice(0, 4);\n}\n\nfunction calculateOverallBreachLikelihood(results: Result[]): number {\n  if (results.length === 0) return 25;\n  const exploitableRatio = results.filter(r => r.exploitable).length / results.length;\n  const avgScore = results.reduce((a, r) => a + r.score, 0) / results.length;\n  return Math.round(Math.min(90, Math.max(10, (exploitableRatio * 40) + (avgScore * 0.5))));\n}\n\nfunction generateActionableRecommendations(\n  predictions: AttackPrediction[],\n  riskFactors: Array<{ factor: string; contribution: number }>\n): string[] {\n  const actions: string[] = [];\n  \n  const topVector = predictions[0];\n  if (topVector) {\n    actions.push(`Focus on ${topVector.vector} prevention - ${topVector.likelihood}% predicted likelihood`);\n  }\n  \n  const topFactor = riskFactors.sort((a, b) => b.contribution - a.contribution)[0];\n  if (topFactor) {\n    actions.push(`Address ${topFactor.factor} (${topFactor.contribution}% risk contribution)`);\n  }\n  \n  if (predictions.some(p => p.adversaryProfile === \"advanced_persistent_threat\")) {\n    actions.push(\"Implement advanced threat detection for APT-level attacks\");\n  }\n  \n  actions.push(\"Conduct regular vulnerability assessments to validate predictions\");\n  \n  return actions.slice(0, 5);\n}\n\nfunction calculateBenchmarkPercentile(overallScore: number, vuln: VulnerabilityExposure): number {\n  const basePercentile = overallScore;\n  const vulnPenalty = (vuln.critical * 5) + (vuln.high * 2) + (vuln.medium * 0.5);\n  return Math.round(Math.min(100, Math.max(0, basePercentile - vulnPenalty)));\n}\n\nfunction createInsufficientDataPosture(organizationId: string, evaluationCount: number): DefensivePostureMetrics {\n  return {\n    id: `posture-${organizationId}-${Date.now()}`,\n    organizationId,\n    overallScore: 0,\n    categoryScores: {\n      networkSecurity: 0,\n      applicationSecurity: 0,\n      identityManagement: 0,\n      dataProtection: 0,\n      incidentResponse: 0,\n      securityAwareness: 0,\n      compliancePosture: 0,\n    },\n    breachLikelihood: 0,\n    meanTimeToDetect: 0,\n    meanTimeToRespond: 0,\n    vulnerabilityExposure: { critical: 0, high: 0, medium: 0, low: 0 },\n    trendDirection: \"stable\",\n    benchmarkPercentile: 0,\n    recommendations: [\n      `Complete at least ${3 - evaluationCount} more evaluations to generate metrics`,\n      \"Run security assessments on critical assets first\",\n    ],\n    dataSource: \"insufficient_data\",\n    evaluationsAnalyzed: evaluationCount,\n    modelVersion: \"v2.0.0-computed\",\n    calculatedAt: new Date().toISOString(),\n  };\n}\n\nfunction createInsufficientDataPredictions(\n  organizationId: string,\n  timeHorizon: string,\n  evaluationCount: number\n): AttackPredictionMetrics {\n  return {\n    id: `pred-insufficient-${Date.now()}`,\n    organizationId,\n    predictedAttackVectors: [],\n    overallBreachLikelihood: 0,\n    riskFactors: [],\n    recommendedActions: [\n      `Complete at least ${3 - evaluationCount} more evaluations to generate predictions`,\n      \"Run security assessments across different asset types\",\n    ],\n    dataSource: \"insufficient_data\",\n    evaluationsAnalyzed: evaluationCount,\n    timeHorizon,\n    modelVersion: \"v2.0.0-computed\",\n    calculatedAt: new Date().toISOString(),\n  };\n}\n","path":null,"size_bytes":18277,"size_tokens":null}},"version":2}